
# ğŸš© Nodejs WEB

Node.js ä¼ä¸šçº§å¤§äº‹è®°

- 2014å¹´ nearform ï¼ˆ Node.Js ä¸ºä»€ä¹ˆä¼šæˆä¸ºä¼ä¸šä¸­çš„é¦–é€‰æŠ€æœ¯ï¼Ÿ ï¼‰
- 2015å¹´ IBM ï¼ˆæ”¶è´­ StrongLoopï¼Œæ‹“å±•äº‘æœåŠ¡ä¸šåŠ¡ï¼‰

Node.js åŸºé‡‘ä¼šçš„åˆ›å§‹æˆå‘˜åŒ…æ‹¬ Joyentã€IBMã€Paypalã€å¾®è½¯ã€Fidelity å’Œ Linux åŸºé‡‘ä¼šã€‚

å‰ç«¯å¼€å‘å››é˜¶æ®µ

- HTML/CSS/JSï¼ˆåŸºç¡€ï¼‰
- jQueryã€jQuery-uiï¼ŒExtjsï¼ˆæ›¾ç»æµè¡Œï¼‰
- Backbone MVC/Angularjs/Vuejs/React ç»„ä»¶åŒ–ï¼ˆæœªæ¥è¶‹åŠ¿ï¼‰
- Node.js æ¨¡å—åŒ–ã€å·¥ç¨‹åŒ–

ç»¼åˆçœ‹ç»„ä»¶åŒ–å·¥ç¨‹çš„ä¼˜ç‚¹ï¼Œåº”è¯¥æ˜¯ä¸‹ä¸€ä¸ªæµè¡Œè¶‹åŠ¿ã€‚

Hybrid è·¨å¹³å°å¼€å‘

Hybrid æ··æ­å¼€å‘æ˜¯æŒ‡ä½¿ç”¨ H5 æŠ€æœ¯å¼€å‘çš„è·¨æµè§ˆå™¨åº”ç”¨ï¼Œå¹¶æœ€ç»ˆå¯ä»¥å°† HTML5/JS/CSS ç­‰æ‰“åŒ…æˆ apk å’Œ ipa åŒ…çš„å¼€å‘æ–¹å¼ã€‚å®ƒä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°åº”ç”¨å•†åº—ï¼Œæä¾›ç»™ç§»åŠ¨è®¾å¤‡è¿›è¡Œå®‰è£…ã€‚å®ƒæœ€å¤§çš„å¥½å¤„æ˜¯é€šè¿‡ H5 å¼€å‘ä¸€æ¬¡ï¼Œå°±å¯ä»¥åœ¨å¤šä¸ªå¹³å°ä¸Šå®‰è£…ã€‚

æœªæ¥å°†ä¼šæ˜¯ JavaScript ä¸€ç»Ÿå¤©ä¸‹ï¼ˆNode.js åšåç«¯ï¼Œä¼ ç»Ÿ Web å’Œ H5 ä½¿ç”¨ JavaSctiptï¼Œæ›´æ™ºèƒ½çš„å·¥å…·å¦‚ gulpï¼Œæ›´ç®€å•çš„å†™æ³•å¦‚ coffeescript ç­‰ï¼‰ã€‚H5 å¤§è¡Œå…¶é“ï¼ˆç½‘é€Ÿå˜å¿«ï¼Œç¡¬ä»¶å†…å­˜å¢é•¿ï¼‰ã€‚

C/S æ¶æ„åˆ° B/S æ¶æ„ï¼Œç§»åŠ¨ç«¯åŠ å£³ï¼Œåœ¨æµè§ˆå™¨ä¸Šåšæ–‡ç« ï¼ŒæŠŠé¡µé¢ç”Ÿæˆå„ä¸ªç§»åŠ¨ç«¯çš„ app æ–‡ä»¶ã€‚

PC ç«¯åŠ å£³ï¼Œä¸€æ ·æ˜¯å»¶ç»­æµè§ˆå™¨åšæ–‡ç« ï¼Œä¸è¿‡è¿™æ¬¡æŠŠé¡µé¢ç”Ÿæˆå„ä¸ª PC å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

- Apache Cordova å¼€æºç§»åŠ¨å¼€å‘æ¡†æ¶ï¼Œå‰èº«æ˜¯ PhoneGapã€‚
- node-webkit (renamed NW.js)
- Electron  - Build cross platform desktop apps with web technologies

ç›®å‰æ¯”è¾ƒç«çš„ç¼–è¾‘å™¨éƒ½æ˜¯åŸºäº Electron æ‰“åŒ…ï¼š

- Atom
- VSCode

åŸºäº Node.js å¼€å¿…çš„ Monaco-editor å³ VSCode é›†æˆçš„ç¼–è¾‘å™¨ï¼Œç°åœ¨éå¸¸æµè¡Œï¼Œå„å¤§åœ¨çº¿åº”ç”¨å¹³å°éƒ½æœ‰å®ƒçš„å½±å­ã€‚

æ­¤å¤–ï¼ŒGoogle Flutterï¼ŒReact-Native éƒ½æ˜¯é”™çš„è·¨å¹³å°å¼€å‘æ¡†æ¶ã€‚


Node.js ä¸ç”Ÿä¿±æ¥çš„ 2 ä¸ªç‰¹æ€§ï¼š

event-driven
non-blocking I/O
ä»¥å‰æ€»å¼ºè°ƒçš„å¼‚æ­¥ç‰¹æ€§ï¼Œåˆ°ä»Šå¤©å¼‚æ­¥å·²ç»ä¸æ˜¯æ˜æ˜¾ä¼˜åŠ¿ã€‚å› æ­¤é™¤äº†æ€§èƒ½ï¼Œå…¶ä»–éƒ½æ˜¯ç—…ï¼ˆä¸è¶³ï¼‰ï¼Ÿ

1ã€Callback hell é—®é¢˜

ç›®å‰å·²ç»å¾ˆå¥½çš„è§£å†³äº†ã€‚promise / generator / async åé¢ä¼šè®²ã€‚

2ã€åŒ…ç®¡ç†

npm å·²ç»æ˜¯å¼€æºä¸–ç•Œé‡Œæœ€å¤§çš„åŒ…ç®¡ç†å™¨äº†ï¼Œæ¨¡å—éå¸¸ä¸°å¯Œï¼ˆ25.6ä¸‡ ï¼‰ã€‚

Node.jsâ€™ package ecosystem, npm, is the largest ecosystem of open source libraries in the world.

ä»¥å‰æˆ‘ä»¬æ€»æ˜¯å–œæ¬¢æ‹¿å¼‚æ­¥è¯´äº‹å„¿ï¼Œç°åœ¨æˆ‘ä»¬æ‹¿ Node.js çš„å¼ºå¤§çš„ç”Ÿæ€æ¥ç‚«è€€ã€‚

Node.js å¥½å¤„

- åŒæ ·ä¸ä¼˜åŒ–ï¼Œæ€§èƒ½æ¯”å¤§éƒ¨åˆ†è¯­è¨€å¥½ã€‚å³ä½¿ä¼˜åŒ–ï¼Œä¹Ÿæ¯”å…¶ä»–è¯­è¨€ç®€å•ï¼Œæ¯”å¦‚Javaã€‚
- æœ‰è¶³å¤Ÿå¤šçš„é€‰æ‹©å’Œæ¶æ„çš„å¹³è¡¡ã€‚
- å¦‚å®åœ¨ä¸å¤Ÿï¼Œé€šè¿‡ C/C++/Java æ‰©å±•æ’ä»¶è¡¥ã€‚

Node.js ç»™äº†æˆ‘ä»¬è¶³å¤Ÿçš„é€‰æ‹©å·¥å…·

- å¯ä»¥é¢å‘è¿‡ç¨‹
- å¯ä»¥é¢å‘å¯¹è±¡
- å¯ä»¥å‡½æ•°å¼

ç”šè‡³å¯ä»¥ç”¨å„ç§ç¼–è¯‘å™¨ coffeeã€typescriptã€babelï¼ˆesï¼‰ç­‰ã€‚å¯¹äºä» 0 å¼€å§‹çš„å›¢é˜Ÿæ¥è®²ï¼Œå¯ä»¥å…ˆé¢å‘è¿‡ç¨‹ã€ç„¶åéšç€å›¢é˜Ÿçš„æˆç†Ÿåº¦ï¼Œä¸€ç‚¹ä¸€ç‚¹å¢åŠ éš¾åº¦ã€‚

æä¾›å¥½çš„åŸºç¡€å’ŒåŒ…ç®¡ç†å·¥å…·

- æµ‹è¯•ç›¸å…³ tdd / bdd æµ‹è¯•è¦†ç›–ç‡
- è§„èŒƒåŒ– standardã€å„ç§ lintã€hint
- æ„å»ºç›¸å…³ gulpã€gruntã€webpackï¼Œå¤§é‡æ’ä»¶
- ç”Ÿæˆå™¨ yo ç­‰
- åŒ…ç®¡ç†å·¥å…· npm è¶³å¤Ÿç®€å•æ˜“ç”¨

ä»¥ä¸Šè¿™äº›éƒ½åšå¤§å‹è½¯ä»¶çš„åŸºç¡€ï¼ŒNode.js åœ¨è¿™æ–¹é¢åšå¾—éå¸¸å¥½ã€‚

åœ¨æ¶æ„ä¸­å„è‡ªåšå„è‡ªåˆé€‚çš„äº‹å„¿å°±å¥½ï¼Œæˆ‘ä»¬å¾ˆå¦ç„¶çš„é¢å¯¹ Node.js çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œåšå¥½æ¶æ„å¹³è¡¡ã€‚

1ã€åœ¨è¯­è¨€å±‚é¢å¯ä»¥åšï¼Œé‚£è¯­è¨€å±‚é¢åš

- å·²æœ‰å¤§é‡ npm ä¸Šçš„æ¨¡å— ( ç›®å‰åœ¨ 25.6 ä¸‡ä¸ªä»¥ä¸Š ) 
- è‡ªå·±é€ è½®å­ ( ç«™åœ¨æµ·é‡åŒ…ä¸Š ç®€å•è¯­æ³• npm = å¿«é€Ÿ )
- ä½¿ç”¨ Node.js NAN - Native Abstractions for Node.js åŒ…è£… C/C++ è½®å­
- ä»ä¸Šé¢çœ‹ï¼Œç»å¤§éƒ¨åˆ†éœ€æ±‚éƒ½å¯ä»¥æ»¡è¶³äº† 

2ã€å¦‚æœè¯­è¨€å±‚é¢æä¸å®šï¼Œé‚£å°±æ¶æ„å±‚é¢åš

- ä¸šåŠ¡è¾¹ç•Œã€æ¨¡å—æ‹†åˆ†ã€é¢å‘æœåŠ¡
- MQã€RPCã€cache
- è¿ç»´ã€ç›‘æ§ã€è‡ªåŠ¨åŒ–

æ¶æ„ä¸ Node.js æ²¡ç›´æ¥å…³ç³»ï¼Œå…¶æ¬¡ï¼Œæ¶æ„å¸ˆå¸¸ç”¨çš„ä¸œä¸œæœ‰è¶³å¤Ÿçš„ Node.js æ¨¡å—æ”¯æŒï¼Œæ¯”å¦‚ MQï¼Œåƒ Rabbitmq æœ‰æ¯”è¾ƒå¥½çš„  Node æ¨¡å—æ”¯æŒï¼ŒRPC é‡Œ Thriftã€Grpcã€Tchannel æ”¯æŒçš„éƒ½ä¸é”™ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ senecajsï¼ŒRedisï¼Œioredis ç­‰è½¯ä»¶ï¼Œåé¢åš HA éƒ½æ˜¯ä¸€æ ·çš„ã€‚

3ã€å¦‚æœæ¶æ„å±‚é¢ä¹Ÿè§£å†³ä¸äº†

åˆé€‚çš„åœºæ™¯ç”¨åˆé€‚çš„ä¸œè¥¿ã€‚æœ‰å¾ˆå¤šä¸œè¥¿æ˜¯ Node.js ä¸æ“…é•¿ï¼Œåˆä¸åœ¨æ¶æ„èŒƒç•´é‡Œçš„ï¼Œå’‹åŠï¼Ÿå¦‚å®åœ¨ä¸å¤Ÿï¼Œå…¶ä»–è¯­è¨€è¡¥ã€‚

- æ¯”å¦‚å¤æ‚ excel ç”Ÿæˆ
- æ¯”å¦‚ apns æ¨é€ï¼ˆGo åšå…¶å®ä¹Ÿå¾ˆå¥½ï¼Œä¸è¿‡é™¤äº†æˆ‘ï¼Œæ²¡äººèƒ½ç»´æŠ¤ï¼‰
- ä½†å‡¡æ˜¯ Java æˆ–å…¶ä»–è¯­è¨€é‡Œæ¯”è¾ƒæˆç†Ÿçš„åº“ï¼Œå¯ä»¥ä½œä¸ºç‹¬ç«‹æœåŠ¡ä½¿ç”¨çš„ï¼Œéƒ½å¯ä»¥åš Node.js çš„æ”¯æŒã€‚é¿å…è¿‡å¤šçš„æ—¶é—´ç”¨åœ¨é€ è½®å­ä¸Šï¼Œå½±å“å¼€å‘è¿›åº¦ã€‚

4ã€Node.js ä¼˜åŠ£åˆ†æ

- æ‰§è¡Œæ•ˆç‡ï¼ŒåŒæ ·ä¸ä¼˜åŒ–ï¼Œæ€§èƒ½æ¯”å¤§éƒ¨åˆ†è¯­è¨€å¥½ã€‚
- å¼€å‘æ•ˆç‡ï¼ŒNode.js æœ¬èº«æ¯”è¾ƒç®€å•ï¼Œå¼€å‘æ•ˆç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚å®Œå–„çš„ç”Ÿæ€ï¼Œæ¯”å¦‚æµ‹è¯•ã€å·¥å…·ã€npm å¤§é‡æ¨¡å—ã€‚
- ç¼ºå°‘ Rails ä¸€æ ·çš„å¤§æ€å™¨ï¼Œscaffold è„šæ‰‹æ¶ï¼ŒORM å¤ªå¼±ã€‚

Node.js çš„ Web å¼€å‘æ¡†æ¶ Expressã€Koa ç­‰ï¼Œç®€å•ï¼Œå°å·§ï¼Œç²¾è‡´ï¼Œç¼ºç‚¹æ˜¯é›†æˆåº¦ä¸å¤Ÿï¼Œç›®å‰å·²æœ‰çš„ MEAN æ¶æ„æˆ– yo æˆ– sails ç­‰æ€»æœ‰æŸç§æ–¹é¢çš„ä¸æ»¡æ„ã€‚

MEAN æ˜¯ç›®å‰æœ€æ½®çš„å…¨æ ˆæ¶æ„ï¼Œæ˜¯ä¸€ä¸ª JavaScript å¹³å°çš„ç°ä»£ Web å¼€å‘æ¡†æ¶æ€»ç§°ï¼Œé›†æˆ MongoDB Express AngularJS Node.js å››ä¸ªæ¡†æ¶ï¼Œå®ƒä¸ä¼ ç»Ÿ LAMP ä¸€æ ·æ˜¯ä¸€ç§å…¨å¥—å¼€å‘å·¥å…·çš„ç®€ç§°ã€‚

ç”±äº Node.js å·²ç»æä¾›ä»¥ä¸‹ç‰¹æ€§ï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ 30 åˆ†é’Ÿå®Œæˆä¸€ä¸ªè„šæ‰‹æ¶ã€‚

- cli å‘½ä»¤æ¨¡å—ï¼Œç¼–å†™éå¸¸å®¹æ˜“
- åŸºäº JavaScript çš„æ¨¡æ¿å¼•æ“ï¼ˆçŸ¥åçš„ 30 ï¼‰

ç”¨ Node.js åšä»€ä¹ˆï¼Ÿ

- API æœåŠ¡
- å‰ç«¯ï¼ˆmoa-frontendï¼‰
- SDKï¼ˆOAuth Providerï¼‰
- è¾…åŠ©å¼€å‘ cli å·¥å…·
- ...



## Installation

Node.js v8.x `setup_8.x` ~ v10.x `setup_10.x` ~ v11.x `setup_11.x` ~ v12.x `setup_12.x`:

    # Using Ubuntu
    curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
    sudo apt-get install -y nodejs
    sudo apt-get install -y npm

    # Using Debian, as root
    curl -sL https://deb.nodesource.com/setup_12.x | bash -
    apt-get install -y nodejs

with Electron

    git clone https://github.com/electron/electron-quick-start
    cd electron-quick-start
    npm install
    npm start


## NPM - Node Package Manager
- https://nodejs.dev/learn/semantic-versioning-using-npm

NPM æ˜¯æ¨¡å—åŒ…ç®¡ç†å·¥å…·

- å…è®¸ç”¨æˆ·ä»NPMæœåŠ¡å™¨ä¸‹è½½åˆ«äººç¼–å†™çš„ç¬¬ä¸‰æ–¹åŒ…åˆ°æœ¬åœ°ä½¿ç”¨ã€‚
- å…è®¸ç”¨æˆ·ä»NPMæœåŠ¡å™¨ä¸‹è½½å¹¶å®‰è£…åˆ«äººç¼–å†™çš„å‘½ä»¤è¡Œç¨‹åºåˆ°æœ¬åœ°ä½¿ç”¨ã€‚
- å…è®¸ç”¨æˆ·å°†è‡ªå·±ç¼–å†™çš„åŒ…æˆ–å‘½ä»¤è¡Œç¨‹åºä¸Šä¼ åˆ°NPMæœåŠ¡å™¨ä¾›åˆ«äººä½¿ç”¨

- æµ‹è¯•æ˜¯å¦æˆåŠŸå®‰è£… npm -v
- æŸ¥çœ‹å½“å‰ç›®å½•å·²å®‰è£…æ’ä»¶ï¼šnpm list
- æ›´æ–°å…¨éƒ¨æ’ä»¶ï¼š npm update [ --save-dev ]
- ä½¿ç”¨ npm æ›´æ–°å¯¹åº”æ’ä»¶ï¼š npm update <name> [ -g ] [ --save-dev]
- ä½¿ç”¨ npm å¸è½½æ’ä»¶ï¼š npm uninstall <name> [ -g ] [ --save-dev ]

å®‰è£…å‚æ•° -g -S -D

-g å³ --global å…¨å±€å®‰è£…ã€‚ 
    å°†ä¼šå®‰è£…åœ¨ C:\Users\Administrator\AppData\Roaming\npm å¹¶ä¸”å†™å…¥ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼›éå…¨å±€å®‰è£…ï¼šå°†ä¼šå®‰è£…åœ¨å½“å‰å®šä½ç›®å½•;å…¨å±€å®‰è£…å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä»»ä½•åœ°æ–¹è°ƒç”¨å®ƒï¼Œæœ¬åœ°å®‰è£…å°†å®‰è£…åœ¨å®šä½ç›®å½•çš„node_modulesæ–‡ä»¶å¤¹ä¸‹ï¼Œé€šè¿‡è¦æ±‚è°ƒç”¨;
-S å³ --save å†™å…¥é…ç½®
    npm install module_name --save ä¼šå°†æ¨¡å—ä¾èµ–å…³ç³»å†™å…¥ package.json çš„ dependenciesï¼Œå³è¿è¡Œä¾èµ–ï¼Œç›¸å…³æ¨¡å—æ˜¯éœ€è¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒçš„ï¼Œæ¯”å¦‚ jQueryï¼ŒReact, Vueï¼Œele-ui ç­‰ ui æ¡†æ¶è¿™äº›é¡¹ç›®è¿è¡Œæ—¶å¿…é¡»ä½¿ç”¨åˆ°çš„æ’ä»¶å°±éœ€è¦æ”¾åˆ° dependenciesã€‚
-D å³ --save-dev å†™å…¥
    npm install module_name --save-dev ä¼šå°†æ¨¡å—å†™å…¥ package.json çš„ devDependenciesï¼Œå³å¼€å‘ä¾èµ–ï¼Œç›¸å…³æ’ä»¶åªç”¨äºå¼€å‘ç¯å¢ƒï¼Œä¸ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚æ¯”å¦‚ä¸€äº›babelç¼–è¯‘åŠŸèƒ½çš„æ’ä»¶ã€webpackæ‰“åŒ…æ’ä»¶å°±æ˜¯å¼€å‘æ—¶å€™çš„éœ€è¦ï¼ŒçœŸæ­£ç¨‹åºæ‰“åŒ…è·‘èµ·æ¥å¹¶ä¸éœ€è¦çš„ä¸€äº›æ’ä»¶ã€‚
ä¸ºä»€ä¹ˆè¦ä¿å­˜åœ¨package.json å› ä¸ºnode_moduleåŒ…å®åœ¨æ˜¯å¤ªå¤§äº†ã€‚ç”¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¿å­˜ï¼Œåªæ‰“åŒ…å®‰è£…å¯¹åº”é…ç½®æ–‡ä»¶çš„æ’ä»¶ï¼ŒæŒ‰éœ€å¯¼å…¥ã€‚

nrm åŒ…å®‰è£…å‘½ä»¤ï¼š npm i nrm -g

èƒ½å¤Ÿç®¡ç†æ‰€ç”¨å¯ç”¨çš„é•œåƒæºåœ°å€ä»¥åŠå½“å‰æ‰€ä½¿ç”¨çš„é•œåƒæºåœ°å€ï¼Œä½†æ˜¯åªæ˜¯å•çº¯çš„æä¾›äº†å‡ ä¸ªurlå¹¶èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨è¿™å‡ ä¸ªåœ°å€ä¹‹é—´æ–¹ä¾¿åˆ‡æ¢
nrm ls å³ nrm listï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„é•œåƒï¼Œå¹¶å¯ä»¥åˆ‡æ¢ã€‚`*` å·è¡¨ç¤ºå½“å‰ npm ä½¿ç”¨çš„åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ nrm use taobao æˆ– nrm use npm æ¥è¿›è¡Œä¸¤è€…ä¹‹é—´çš„åˆ‡æ¢ã€‚

NPM v5.2.0 å¼•å…¥çš„ä¸€æ¡å‘½ä»¤ NPXï¼Œä½œä¸ºä¸€ä¸ª NPM åŒ…æ‰§è¡Œå™¨ï¼ŒæŒ‡åœ¨æé«˜ä» NPM æ³¨å†Œè¡¨ä½¿ç”¨è½¯ä»¶åŒ…æ—¶çš„ä½“éªŒï¼Œè§£å†³çš„ä¸»è¦é—®é¢˜å°±æ˜¯è°ƒç”¨é¡¹ç›®å†…éƒ¨å®‰è£…çš„æ¨¡å—ã€‚

NPX ä½¿å¾—ä½¿ç”¨ CLI å·¥å…·å’Œå…¶ä»–æ‰˜ç®¡åœ¨æ³¨å†Œè¡¨ï¼Œå®ƒå¤§å¤§ç®€åŒ–äº†ä¸€äº›å·¥å…·è¿è¡Œå’Œä½¿ç”¨ã€‚åœ¨ NPM çš„åŸºç¡€ä¹‹ä¸Šï¼ŒNPX è®© NPM åŒ…ä¸­çš„å‘½ä»¤è¡Œå·¥å…·å’Œå…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶åœ¨ä½¿ç”¨ä¸Šå˜å¾—æ›´åŠ ç®€å•ã€‚å®ƒæå¤§åœ°ç®€åŒ–äº†æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çº¯ç²¹çš„ NPM æ—¶æ‰€éœ€è¦çš„å¤§é‡æ­¥éª¤ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

- ä¸´æ—¶å®‰è£…å¯æ‰§è¡Œä¾èµ–åŒ…ï¼Œä¸ç”¨å…¨å±€å®‰è£…ï¼Œä¸ç”¨æ‹…å¿ƒé•¿æœŸçš„æ±¡æŸ“ã€‚
- å¯ä»¥æ‰§è¡Œä¾èµ–åŒ…ä¸­çš„å‘½ä»¤ï¼Œå®‰è£…å®Œæˆè‡ªåŠ¨è¿è¡Œã€‚
- è‡ªåŠ¨åŠ è½½ node_modules ä¸­ä¾èµ–åŒ…ï¼Œä¸ç”¨æŒ‡å®š $PATHã€‚
- å¯ä»¥æŒ‡å®š node ç‰ˆæœ¬ã€å‘½ä»¤çš„ç‰ˆæœ¬ï¼Œè§£å†³äº†ä¸åŒé¡¹ç›®ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„å‘½ä»¤çš„é—®é¢˜ã€‚

â› prefix Configuration

The `prefix` config defaults to the location where node is installed.
On most systems, this is `/usr/local`. On Windows, it's `%AppData%\npm`.
On Unix systems, it's one level up, since node is typically installed at
`{prefix}/bin/node` rather than `{prefix}/node.exe`.

When the `global` flag is set, npm installs things into this prefix.
When it is not set, it uses the root of the current package, or the
current working directory if not in a package already.

â› Node Modules

Packages are dropped into the `node_modules` folder under the `prefix`.
When installing locally, this means that you can
`require("packagename")` to load its main module, or
`require("packagename/lib/path/to/sub/module")` to load other modules.

Global installs on Unix systems go to `{prefix}/lib/node_modules`.
Global installs on Windows go to `{prefix}/node_modules` (that is, no
`lib` folder.)

Scoped packages are installed the same way, except they are grouped together
in a sub-folder of the relevant `node_modules` folder with the name of that
scope prefix by the @ symbol, e.g. `npm install @myorg/package` would place
the package in `{prefix}/node_modules/@myorg/package`. See [`scope`](/using-npm/scope) for more details.

If you wish to `require()` a package, then install it locally.

â› Executables

When in global mode, executables are linked into `{prefix}/bin` on Unix,
or directly into `{prefix}` on Windows.

When in local mode, executables are linked into
`./node_modules/.bin` so that they can be made available to scripts run
through npm.  (For example, so that a test runner will be in the path
when you run `npm test`.)



## PowerShell NVM.ps1

NPM é…ç½®è¦ç‚¹å‚è€ƒ node_modules/nmp/doc æ–‡æ¡£ï¼Œä½¿ç”¨ npm config ls -l æŸ¥çœ‹å½“å‰é…ç½®ä¿¡æ¯åˆ—è¡¨ã€‚

å¦‚ä½•åœ¨å¤š Nodejs ç‰ˆæœ¬ä¸‹å…¨å±€ç®¡ç† node_modules æ¨¡å—ï¼Ÿå› ä¸º `prefix` é…ç½®å†³å®šäº†å½“å‰ Node ä»å…¶
å­ç›®å½•åŠ è½½æ¨¡å—ï¼Œæ‰€ä»¥ä½¿ç”¨ç›®å½•ç¬¦å·è¿æ¥æ¥æ›´æ”¹ç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥é¢å¤–è®¾ç½® node_modules ç›®å½•çš„è¿æ¥æ¥å®ç°ã€‚

å…·ä½“æ“ä½œæ˜¯ï¼Œä½¿ç”¨ä¸€ä¸ªç›®å½•å®‰è£… node å„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å•ç‹¬ç”¨ä¸€ä¸ª c:\\nvm\\node_moduels å®‰è£…æ¨¡å—ï¼Œ
åˆ‡æ¢ç‰ˆæœ¬æ—¶ï¼Œå°† Node ç‰ˆæœ¬ç›®å½•æ˜ å°„åˆ°æŸä¸€ç›®å½•ï¼Œå¦‚ c:/nodejsï¼Œå†å°† node_modules æ˜ å°„ä¸ºå…¶å­ç›®å½•ï¼Œ
æœ€åå°†å„ç‰ˆæœ¬çš„ NPM ç›®å½•æ˜ å°„ä¸º node_modules å­ç›®å½•ã€‚

Nodejs 18.2.0 é™¤äº† NPM æ¨¡å—ï¼Œè¿˜å¤šäº†ä¸€ä¸ª corepck æ¨¡å—ã€‚

å¦å¤– NPM å®‰è£…æ¨¡å—æ—¶ï¼Œä¼šè‡ªåŠ¨è§£é™¤æ˜ å°„çš„ node_modulesï¼Œå¹¶ä½¿ç”¨ `prefix` ç›®å½•ä¸‹çš„æ¨¡å—ç›®å½•ã€‚

ç”¨æˆ·å¯ä»¥ä¿®æ”¹ä»¥ä¸‹å››ä¸ªç›¸å…³çš„é…ç½®æ–‡ä»¶ï¼š

    cache = "C:\\Users\\OCEAN\\AppData\\Roaming\\npm-cache"
    prefix= "c:\\nvm"

* per-project config file (/path/to/my/project/.npmrc)
* per-user config file (~/.npmrc)
* global config file ($PREFIX/etc/npmrc)
* npm builtin config file (/path/to/npm/npmrc)


```sh
PARAM([string]$version, $target="c:/nodejs")

# Use Target and LinkType in PS5.1, LinkTarget only support in newer version, such PS7.1
$PS = $PSCommandPath -replace "^.+[\\/]",""
$NVM = (Get-Item $PSCommandPath).Target
$VMD = $NVM
if ($NVM -eq $null){ 
    $NVM = $PSCommandPath
    $VMD = $PSCommandPath
}
$VMD = $VMD -replace "\\[^/\\]+$","\"
$versions = Get-Childitem -Directory "$VMD/v*"

$current = "Not set yet"
if ( (Test-Path $target) -and (Get-Item $target).Target){
    $current = (Get-Item $target).Target
}

function Print($msg, $color=$null)
{
    # Write-Host ("="*80)
    if ($color){
        Write-Host $msg -Foreground $color
    } else {
        Write-Host $msg
    }
    # Write-Host ("="*80)
} 

function PrintHelp 
{
    Print @"
    Node.js Version Manager`n
    Usage:
        $NVM $($versions[-1].Name)
        $NVM $($versions[-1].Name) c:/nodejs
    
    Candidate: 
        $($versions.Name)
    
    Current: 
        $($current)
"@
}

function PrintNoVersion 
{
    Print @"
    No such version: $version
          Candidate: $($versions.Name)
"@
}

function PrintResult($action, $result)
{
    if ($lastexitcode -eq 0){
        Print "$action [$lastexitcode] $result" Green 
    }else{
        Print "$action [$lastexitcode] $result" Yellow 
    }
}

function CanBeLinkSymblic($sym){
    $exist = Test-Path "$sym"
    if ($exist -and (Get-Item "$sym").Target -eq $null){
        return $false
    }
    return $true
}

function MakeSymblic($sym, $target, $filelink=$false)
{
    if ((CanBeLinkSymblic $sym) -eq $false){
        return Print "$sym is not symbolic and it is there"
    }
    if (Test-Path $sym){ 
        $ret = rm $sym 
    }
    if ($filelink){
        $ret = cmd.exe /c "mklink `"$sym`" `"$target`""
    }else{
        $ret = cmd.exe /c "mklink /d `"$sym`" `"$target`""
    }
    PrintResult MakeSymblic $ret
}

function SwitchVersion
{
    $versions | % {
        if ($_.Name.IndexOf($version) -ge 0){
            Print "Use $($_.Name)"
            MakeSymblic "$target"    "$_"
            MakeSymblic "$_/$PS"     "$VMD/$PS"     $true
            MakeSymblic "$_/nvm.exe" "$VMD/nvm.exe" $true
            FixedNodeModules "$_"
            break
        }
    }
}

function FixedNodeModules($ver)
{
    if (!(Test-Path "$ver/node_modules_inside")){
        ren "$ver/node_modules" "node_modules_inside"
    }
    MakeSymblic "$target/node_modules" "$VMD/node_modules"
    if(Test-Path "$ver/node_modules_inside/npm"){
        MakeSymblic "$target/node_modules/npm" "$ver/node_modules_inside/npm"
    }
    if (Test-Path "$ver/node_modules_inside/corepack"){
        MakeSymblic "$target/node_modules/corepack" "$ver/node_modules_inside/corepack"
    }
}

if ($version -eq ""){ 
    PrintHelp 
} elseif ($versions.Count -eq 0) {
    Print "No any Node.js version found"
} elseif (!(CanBeLinkSymblic $target)) {
    Print "Target is not a symbolic: $target"
} elseif ((Get-Childitem -Directory "$VMD/*$version*").Count -eq 0) {
    PrintNoVersion
} else{
    SwitchVersion($version)
}
```


## Ubuntu ä¸Šå®‰è£…ä½¿ç”¨ node.js

ä¸€ã€å®‰è£…

    $ sudo apt-get install nodejs
    $ sudo apt-get install npm

äºŒã€å‡çº§

    $ sudo npm install npm -g
    /usr/local/bin/npm -> /usr/local/lib/node_modules/npm/bin/npm-cli.js
    npm@2.14.2 /usr/local/lib/node_modules/npm

    $ npm install â€“g n
    $ npm install â€“g n latest
    $ npm install â€“g n stable
    $ npm install â€“g n v12.10

latest å‡çº§ node.js åˆ°æœ€æ–°ç‰ˆï¼Œstable å‡çº§ node.js åˆ°æœ€æ–°ç¨³å®šç‰ˆï¼Œn åé¢ä¹Ÿå¯ä»¥è·Ÿéšç‰ˆæœ¬å·ã€‚

ä¸‰ã€npm é•œåƒæ›¿æ¢ä¸ºæ·˜å®é•œåƒ

1.å¾—åˆ°åŸæœ¬çš„é•œåƒåœ°å€

    $ npm get registry 
    > https://registry.npmjs.org/

è®¾æˆæ·˜å®çš„

    $ npm config set registry http://registry.npm.taobao.org/

2.æ¢æˆåŸæ¥çš„

    $ npm config set registry https://registry.npmjs.org/
 

å››ã€é€‰è£… cnpm

å› ä¸º npm å®‰è£…æ’ä»¶æ˜¯ä»å›½å¤–æœåŠ¡å™¨ä¸‹è½½ï¼Œå—ç½‘ç»œå½±å“å¤§ï¼Œå¯èƒ½å‡ºç°å¼‚å¸¸ï¼Œcnpm æ˜¯ä¸€ä¸ªå®Œæ•´ npmjs.org é•œåƒï¼Œä½ å¯ä»¥ç”¨æ­¤ä»£æ›¿å®˜æ–¹ç‰ˆæœ¬(åªè¯»)ï¼ŒåŒæ­¥é¢‘ç‡ç›®å‰ä¸º 10 åˆ†é’Ÿ ä¸€æ¬¡ä»¥ä¿è¯å°½é‡ä¸å®˜æ–¹æœåŠ¡åŒæ­¥ã€‚

å®˜æ–¹ç½‘å€ï¼šhttp://npm.taobao.org

3.å®‰è£…ï¼šå‘½ä»¤æç¤ºç¬¦æ‰§è¡Œ

    npm install cnpm -g --registry=https://registry.npm.taobao.org

æ³¨æ„ï¼šå®‰è£…å®Œåæœ€å¥½æŸ¥çœ‹å…¶ç‰ˆæœ¬å·cnpm -væˆ–å…³é—­å‘½ä»¤æç¤ºç¬¦é‡æ–°æ‰“å¼€ï¼Œå®‰è£…å®Œç›´æ¥ä½¿ç”¨æœ‰å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼›

æ³¨ï¼šcnpm è·Ÿ npm ç”¨æ³•å®Œå…¨ä¸€è‡´ã€‚


äº”ã€å…¨å±€å®‰è£…ä¸æœ¬åœ°å®‰è£…

npm çš„åŒ…å®‰è£…åˆ†ä¸ºæœ¬åœ°å®‰è£…ï¼ˆlocalï¼‰ã€å…¨å±€å®‰è£…ï¼ˆglobalï¼‰ä¸¤ç§ï¼Œä»æ•²çš„å‘½ä»¤è¡Œæ¥çœ‹ï¼Œå·®åˆ«åªæ˜¯æœ‰æ²¡æœ‰ -g è€Œå·²ã€‚

æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ npm å‘½ä»¤å®‰è£…å¸¸ç”¨çš„ Node.js webæ¡†æ¶æ¨¡å— express:

    $ npm install express          # æœ¬åœ°å®‰è£…
    $ npm install express -g       # å…¨å±€å®‰è£…

å…­ã€å¸è½½

    sudo npm uninstall npm -g
    sudo apt-get remove nodejs


ä½¿ç”¨ nvm ç®¡ç† Node.js ç‰ˆæœ¬ã€‚

å®‰è£…

    wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh | bash

å®‰è£…æˆåŠŸåéœ€è¦å…³é—­ xshellï¼Œé‡æ–°å¯åŠ¨ã€‚nvm æ‰ä¼šç”Ÿæ•ˆã€‚

ä½¿ç”¨ command -v nvm æŸ¥çœ‹ nvm æ˜¯å¦å®‰è£…æˆåŠŸ

    root@linuxidc:~# command -v nvm

é€šè¿‡ nvm ls æŸ¥çœ‹å·²å®‰è£…çš„ç‰ˆæœ¬

    $ nvm ls
                N/A
    node -> stable (-> N/A) (default)
    iojs -> N/A (default)

é€šè¿‡ nvm ls-remote æŸ¥çœ‹å¯ä½¿ç”¨ç‰ˆæœ¬

    $ nvm ls-remote
            v0.1.14
            v0.1.15
            v0.1.16
            v0.1.17
            v0.1.18

é€šè¿‡ nvm install 7.8.0æ¥å®‰è£…ï¼Œåé¢çš„ç‰ˆæœ¬å·æˆ‘ä»¬å¯ä»¥ä»»æ„é€‰æ‹©

    root@linuxidc:~# nvm install 7.8.0
    Downloading and installing node v6.2.0...
    Downloading https://nodejs.org/dist/v7.8.0/node-v7.8.0-linux-x64.tar.xz...


å›½å†…å¦‚æœä¸èƒ½ç›´æ¥ä¸‹è½½å®‰è£…è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡å…‹éš† nvm ä»“åº“å®‰è£…å³ Git Installï¼š

    git clone https://github.com/nvm-sh/nvm.git .nvm
    git checkout v0.37.2

- å…ˆå†³æ¡ä»¶ï¼Œå®‰è£… git v1.7.10+
- clone nvm åˆ°æƒ³å®‰è£…çš„ç›®å½•
- ç­¾å‡ºæœ€æ–°çš„ç‰ˆæœ¬ git checkout v0.37.2
- sourcing nvm å¼•ç”¨æ¿€æ´» . ./nvm.sh

ä¿®æ”¹ `~/.bashrc` `~/.profile` `~/.zshrc` ä¹‹ä¸€ä¸ªï¼Œä»¥è‡ªåŠ¨æŸ¥æ‰¾ nvm å‘½ä»¤ï¼š

    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion



## CNPM æ›¿ä»£ NPM ä½¿ç”¨ taobao æ¨¡å—æœåŠ¡å™¨
http://npm.taobao.org/

ä½¿ç”¨å›½å¤–çš„æ¨¡å—æœåŠ¡ç»å¸¸å› å¢™äº‹æ•…å‡ºç°é¡¹ç›®è¿è¡Œå¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨ taobao æ¨¡å—æœåŠ¡å™¨ï¼Œä¾‹å¦‚ä½¿ç”¨é˜¿é‡Œçš„é£å†°æ¡†æ¶æ—¶é‡åˆ° ice-scripts 2.1.6 æ‰¾ä¸åˆ° node-sass æ¨¡å—é—®é¢˜ï¼š

    Cannot find module 'node-sass'

ç›´æ¥ä½¿ç”¨ npm å®‰è£…å¤±è´¥ï¼Œè§£å†³åŠæ³•æ˜¯æ¥å…¥å›½å†…æ¨¡å—ä»“åº“å¹¶å®‰è£…ç›¸åº” cnpm ç®¡ç†æ¨¡å—ï¼š

    npm config set registry https://registry.npmjs.org/
    npm config set registry https://registry.npm.taobao.org
    npm config set disturl https://npm.taobao.org/dist

    npm install -g cnpm --registry=https://registry.npm.taobao.org
    cnpm install node-sass

æ¨¡å—ä¸‹è½½æˆåŠŸåå°±å¯ä»¥æ­£å¸¸çš„è¿è¡Œé¡¹ç›®äº†ã€‚

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´ npmjs.org é•œåƒï¼Œä½ å¯ä»¥ç”¨æ­¤ä»£æ›¿å®˜æ–¹ç‰ˆæœ¬(åªè¯»)ï¼ŒåŒæ­¥é¢‘ç‡ç›®å‰ä¸º 10åˆ†é’Ÿ ä¸€æ¬¡ä»¥ä¿è¯å°½é‡ä¸å®˜æ–¹æœåŠ¡åŒæ­¥ã€‚

- å½“å‰ registry.npm.taobao.org æ˜¯ä» r.cnpmjs.org è¿›è¡Œå…¨é‡åŒæ­¥çš„.
- å½“å‰ npm.taobao.org è¿è¡Œç‰ˆæœ¬æ˜¯: cnpmjs.org@
- æœ¬ç³»ç»Ÿè¿è¡Œåœ¨ Node.js@ ä¸Š.
- å¼€æºé•œåƒ: http://npm.taobao.org/mirrors
- Node.js é•œåƒ: http://npm.taobao.org/mirrors/node
- alinode é•œåƒ: http://npm.taobao.org/mirrors/alinode
- phantomjs é•œåƒ: http://npm.taobao.org/mirrors/phantomjs
- ChromeDriver é•œåƒ: http://npm.taobao.org/mirrors/chromedriver
- OperaDriver é•œåƒ: http://npm.taobao.org/mirrors/operadriver
- Selenium é•œåƒ: http://npm.taobao.org/mirrors/selenium
- Node.js æ–‡æ¡£é•œåƒ: http://npm.taobao.org/mirrors/node/latest/docs/api/index.html
- NPM é•œåƒ: https://npm.taobao.org/mirrors/npm/
- electron é•œåƒ: https://npm.taobao.org/mirrors/electron/
- node-inspector é•œåƒ: https://npm.taobao.org/mirrors/node-inspector/

å®‰è£…æ¨¡å—

ä» registry.npm.taobao.org å®‰è£…æ‰€æœ‰æ¨¡å—. å½“å®‰è£…çš„æ—¶å€™å‘ç°å®‰è£…çš„æ¨¡å—è¿˜æ²¡æœ‰åŒæ­¥è¿‡æ¥, æ·˜å® NPM ä¼šè‡ªåŠ¨åœ¨åå°è¿›è¡ŒåŒæ­¥, å¹¶ä¸”ä¼šè®©ä½ ä»å®˜æ–¹ NPM registry.npmjs.org è¿›è¡Œå®‰è£…. ä¸‹æ¬¡ä½ å†å®‰è£…è¿™ä¸ªæ¨¡å—çš„æ—¶å€™, å°±ä¼šç›´æ¥ä» æ·˜å® NPM å®‰è£…äº†.

    $ cnpm install [name]

ç›´æ¥é€šè¿‡ sync å‘½ä»¤é©¬ä¸ŠåŒæ­¥ä¸€ä¸ªæ¨¡å—, åªæœ‰ cnpm å‘½ä»¤è¡Œæ‰æœ‰æ­¤åŠŸèƒ½:

    $ cnpm sync connect

å½“ç„¶, ä½ å¯ä»¥ç›´æ¥é€šè¿‡ web æ–¹å¼æ¥åŒæ­¥: /sync/connect

    $ open https://npm.taobao.org/sync/connect

æ”¯æŒ npm é™¤äº† publish ä¹‹å¤–çš„æ‰€æœ‰å‘½ä»¤, å¦‚:

    $ cnpm info connect



# ğŸš© Yarn vs NPM
- https://classic.yarnpkg.com/en/docs/usage
- https://classic.yarnpkg.com/en/docs/cli/
- [Yarn Install](https://yarnpkg.com/zh-Hans/docs/install#windows-stable)
- [NPM vs Yarn](https://www.jeffjade.com/2017/12/30/135-npm-vs-yarn-detial-memo/)
- [ä¸ºä»€ä¹ˆæˆ‘ä» npm åˆ° yarn å†åˆ° npm?](https://segmentfault.com/a/1190000014716713)

ç¼“å­˜ç›®å½•é…ç½®æŸ¥è¯¢ï¼Œå’Œ NPM å…±ç”¨éƒ¨åˆ†é…ç½®ï¼š

    yarn config list
    yarn config current

    C:\Users\{YOU}\AppData\Roaming\npm-cache
    C:\Users\{YOU}\AppData\Local\Yarn

Yarn å¯¹ä½ çš„ä»£ç æ¥è¯´æ˜¯ä¸€ä¸ªåŒ…ç®¡ç†å™¨ï¼Œ ä½ å¯ä»¥é€šè¿‡å®ƒä½¿ç”¨å…¨ä¸–ç•Œå¼€å‘è€…çš„ä»£ç ï¼Œæˆ–è€…åˆ†äº«è‡ªå·±çš„ä»£ç ã€‚ Yarn åšè¿™äº›å¿«æ·ã€å®‰å…¨ã€å¯é ï¼Œæ‰€ä»¥ä½ ä¸ç”¨æ‹…å¿ƒä»€ä¹ˆã€‚

é€šè¿‡ Yarn å¯ä»¥ä½¿ç”¨å…¶ä»–å¼€å‘è€…é’ˆå¯¹ä¸åŒé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä½¿è‡ªå·±çš„å¼€å‘è¿‡ç¨‹æ›´ç®€å•ã€‚ ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œä½ å¯ä»¥å°†å…¶ä¸ŠæŠ¥æˆ–è€…è´¡çŒ®è§£å†³æ–¹æ¡ˆã€‚ä¸€æ—¦é—®é¢˜è¢«ä¿®å¤ï¼ŒYarnä¼šæ›´æ–°ä¿æŒåŒæ­¥ã€‚

ä»£ç é€šè¿‡åŒ…ï¼ˆpackageï¼‰ï¼ˆæˆ–è€…ç§°ä¸ºæ¨¡å—ï¼ˆmoduleï¼‰ï¼‰çš„æ–¹å¼æ¥å…±äº«ã€‚ ä¸€ä¸ªåŒ…é‡ŒåŒ…å«æ‰€æœ‰éœ€è¦å…±äº«çš„ä»£ç ï¼Œä»¥åŠæè¿°åŒ…ä¿¡æ¯çš„æ–‡ä»¶ï¼Œç§°ä¸ºpackage.jsonã€‚

Yarn æ¯” npm æ›´å¿«å› ä¸º Yarn ä¼šç¼“å­˜æ¯ä¸€ä¸ªå®ƒä¸‹è½½çš„åŒ…ï¼Œè¿™æ ·å½“ä¸‹æ¬¡è¯·æ±‚ç›¸åŒçš„åŒ…çš„æ—¶å€™å°±ä¸è¦å†æ¬¡ä¸‹è½½äº†ã€‚
è€Œä¸” yarn ä¼šå¹¶è¡Œä¸‹è½½ä¾èµ–çš„åŒ…ï¼Œæ‰€ä»¥ yarn æ¯” npm æ›´å¿«ã€‚

æ—§ç‰ˆ npm ç¡®å®å­˜åœ¨è¿™äº›é—®é¢˜ï¼Œä¸€ä¸ªé¡¹ç›®ä¾èµ–ç»å¸¸å‡ ç™¾ MBï¼ŒæŠŠé¡¹ç›®æŒªä¸€ä¸ªä½ç½®é‡æ–° installï¼Œéƒ½è¦é‡æ–°ä¸‹è½½ï¼Œ
è€Œä¸”ä¸‹è½½é€Ÿåº¦çœŸæ˜¯å‡ºå¥‡çš„æ…¢ï¼Œæ‰€ä»¥æ‰æœ‰äº†å›½å†…ä¸“ç”¨çš„ cnpmã€‚å…¶å® cnpm ä¹Ÿä¸æ˜¯ä»€ä¹ˆå¥½ä¸œè¥¿ï¼Œä¸‹è½½åŒ…ç»å¸¸æŠ¥é”™ï¼Œ
å°¤å…¶æ˜¯è·Ÿ npm æ··ç”¨çš„æ—¶å€™ã€‚


## Yarn Usages

å¯¹äºå¦‚ä½•å®‰è£… Yarnï¼ŒYarn å®˜æ–¹ç»™å‡ºäº†å¾ˆå…¨é¢çš„è¯´æ˜ï¼Œè¯¦è§ Install Yarnï¼›æ¶µç›– MacOsï¼ŒWindowsï¼ŒLinux ç­‰å¹³å°ï¼Œå¹¶ä¸”è¿˜ç»™å‡ºä¸€äº›å¤‡ç”¨å®‰è£…æ–¹å¼ï¼Œè­¬å¦‚é€šè¿‡ npm æ¥å®‰è£…ï¼š

    npm install --global yarn

å½“ç„¶ï¼ŒYarn å®˜æ–¹åœ¨ Yarn å¤‡é€‰å®‰è£…æ–¹å¼æœ‰æ˜ç¡®è®²é“ä¸æ¨èé€šè¿‡ npm å®‰è£… Yarnï¼Œåœ¨ç”¨åŸºäº Node çš„åŒ…ç®¡ç†å™¨å®‰è£… Yarn æ—¶ï¼Œè¯¥åŒ…æœªè¢«ç­¾åï¼Œ å¹¶ä¸”åªé€šè¿‡åŸºæœ¬çš„ SHA1 æ•£åˆ—è¿›è¡Œå”¯ä¸€å®Œæ•´æ€§æ£€æŸ¥ã€‚è¿™åœ¨å®‰è£…ç³»ç»Ÿçº§åº”ç”¨æ—¶æœ‰å®‰å…¨é£é™©ã€‚å› ä¸ºè¿™äº›åŸå› ï¼Œé«˜åº¦æ¨èç”¨ä½ çš„æ“ä½œç³»ç»Ÿæœ€é€‚åˆçš„æ–¹å¼æ¥å®‰è£… Yarnã€‚

ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™å€’æ˜¯æœ€ä¸ºæ–¹ä¾¿çš„æ–¹å¼ä¹‹ä¸€ï¼Œè¿„ä»Šå€’ä¹Ÿæ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼›å½“ç„¶ï¼Œæœ€å¥½æŒ‰ç…§å®˜æ–¹æ¨èçš„æ–¹å¼ï¼›å¦‚æœä½ ä½¿ç”¨å¹¶ç†Ÿæ‚‰ Mac æ“ä½œç³»ç»Ÿï¼Œç”¨æ¨èæ–¹å¼å®‰è£… Yarn ä¹Ÿæ˜¯å¾ˆç®€å•ï¼š

    brew install yarn
    brew upgrade yarn

å¦‚æœ Yarn é€šè¿‡ Debian / Ubuntu åŒ…å®‰è£…ï¼Œåˆ™å¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤äºˆä»¥æ›´æ–°ï¼š

    sudo apt-get update && sudo apt-get install yarn

ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªä½“ yarn global å‘½ä»¤æ¥å…¨å±€æ›´æ–°è‡ªå·±ï¼š

    yarn global add yarn

    yarn global <add/bin/list/remove/upgrade> [--prefix]

    Install packages globally on your operating system.

å¸¸ç”¨å‘½ä»¤ï¼š

   1. yarn add: add a package to use in your current package.
   2. yarn bin: displays the location of the yarn bin folder.
   3. yarn list: list installed packages.
   4. yarn remove: remove a package that will no longer be used in your current package.
   5. yarn upgrade: upgrade packages to their latest version based on the specified range.
   6. yarn upgrade-interactive: similar to upgrade command, but display the outdated packages before performing any upgrade, allowing the user to select which packages to upgrade.

Usage

```sh
# version info
yarn -v
yarn --version

# Starting a new project, make a package.json
yarn init

# Adding a dependency
yarn add [package]
yarn add [package]@[version]
yarn add [package]@[tag]

# Adding a dependency to different categories of dependencies
# Add to devDependencies, peerDependencies, and optionalDependencies respectively:
yarn add [package] --dev
yarn add [package] --peer
yarn add [package] --optional

# Upgrading a dependency
yarn upgrade [package]
yarn upgrade [package]@[version]
yarn upgrade [package]@[tag]

# Removing a dependency
yarn remove [package]

# Installing all the dependencies of project
yarn
# or
yarn install
```

é…ç½®é¡¹æŸ¥è¯¢ä¸ç®¡ç†ï¼š

    yarn config list
    yarn config get <key>
    yarn config delete <key>
    yarn config set <key> <value> [-g|--global]

    # é…ç½®æºé•œåƒä¸ºæ·˜å®æº
    yarn config get registry
    yarn config set registry https://registry.npm.taobao.org/

    # ä¿®æ”¹å…¨å±€å®‰è£…ç›®å½•
    yarn config set global-folder "C:\Yarn\global"

    # æŸ¥çœ‹æˆ–è®¾ç½®å…¨å±€å®‰è£…ä½ç½®ã€å‘½ä»¤ç›®å½•å‰ç¼€ *\binï¼Œè¯·ç›¸åº”è®¾ç½®ç¯å¢ƒå˜é‡
    yarn global dir
    yarn global bin
    yarn config set prefix "C:\Yarn\global\"
    yarn config set cache-folder "D:\Yarn\cache"


ä½¿ç”¨ install å‘½ä»¤å®‰è£…ä¾èµ–åŒ…ï¼Œç”Ÿæˆ package.jsonï¼š

    yarn install
    yarn install --flat           # å®‰è£…ä¸€ä¸ªåŒ…çš„å•ä¸€ç‰ˆæœ¬
    yarn install --force          # å¼ºåˆ¶é‡æ–°ä¸‹è½½æ‰€æœ‰åŒ…
    yarn install --production     # åªå®‰è£…dependenciesé‡Œçš„åŒ…
    yarn install --no-lockfile    # ä¸è¯»å–æˆ–ç”Ÿæˆyarn.lock
    yarn install --pure-lockfile  # ä¸ç”Ÿæˆ yarn.lock

æ·»åŠ åŒ…ä¾èµ–ï¼Œæ›´æ–° package.json yarn.lockï¼š

    yarn add [package]            # é¡¹ç›®ä¸­å®‰è£…ä¾èµ–ï¼Œæ›´æ–° package.json yarn.lock
    yarn add [package]@[version]  # å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œä¸»è¦ç‰ˆæœ¬ï¼Œä½¿ç”¨ -E æŒ‡å®šå°ç‰ˆæœ¬
    yarn add [package]@[tag]      # å®‰è£…æŸä¸ª tagï¼Œæ¯”å¦‚ betaï¼Œnext æˆ–è€… latest

é»˜è®¤ä¾èµ–ç±»å‹ dependenciesï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¾èµ–ç±»å‹ï¼š

    yarn add --dev/-D             # åŠ åˆ° devDependencies
    yarn add --peer/-P            # åŠ åˆ° peerDependencies
    yarn add --optional/-O        # åŠ åˆ° optionalDependencies

é»˜è®¤å®‰è£…åŒ…çš„ä¸»è¦ç‰ˆæœ¬é‡Œçš„æœ€æ–°ç‰ˆæœ¬ï¼Œä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å¯ä»¥æŒ‡å®šç‰ˆæœ¬ï¼š

    yarn add --exact/-E           # å®‰è£…ç²¾ç¡®ç‰ˆæœ¬ã€‚
    yarn add foo@1.2.3            # ä¼šæ¥å— 1.9.1 ç‰ˆ
    yarn add foo@1.2.3 --exact    # åªå®‰è£… 1.2.3 ç‰ˆ

    yarn add --tilde/-T           # å®‰è£…åŒ…çš„æ¬¡è¦ç‰ˆæœ¬é‡Œçš„æœ€æ–°ç‰ˆã€‚
    yarn add foo@1.2.3 --tilde    # æ¥å— 1.2.9ï¼Œä½†ä¸æ¥å— 1.3.0

å‘å¸ƒåŒ…

    yarn publish

ç§»é™¤ä¸€ä¸ªåŒ…

    yarn remove <packageName>ï¼šç§»é™¤ä¸€ä¸ªåŒ…ï¼Œä¼šè‡ªåŠ¨æ›´æ–°package.jsonå’Œyarn.lock

æ›´æ–°ä¸€ä¸ªä¾èµ–

    yarn upgrade ç”¨äºæ›´æ–°åŒ…åˆ°åŸºäºè§„èŒƒèŒƒå›´çš„æœ€æ–°ç‰ˆæœ¬

è¿è¡Œè„šæœ¬

    yarn run ç”¨æ¥æ‰§è¡Œåœ¨ package.json ä¸­ scripts å±æ€§ä¸‹å®šä¹‰çš„è„šæœ¬

æ˜¾ç¤ºæŸä¸ªåŒ…çš„ä¿¡æ¯

    yarn info <packageName> å¯ä»¥ç”¨æ¥æŸ¥çœ‹æŸä¸ªæ¨¡å—çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯

ç¼“å­˜

    yarn cache
    yarn cache list     # åˆ—å‡ºå·²ç¼“å­˜çš„æ¯ä¸ªåŒ…
    yarn cache dir      # è¿”å› å…¨å±€ç¼“å­˜ä½ç½®
    yarn cache clean    # æ¸…é™¤ç¼“å­˜


ä½¿ç”¨ Yarn ä¸º React/Vue é¡¹ç›®æ·»åŠ  TypeScript 2.8 æ”¯æŒ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… TypeScript å’Œ tslibs å¸®åŠ©ç¨‹åºåº“ï¼Œä»¥ä¾¿æˆ‘ä»¬ç”Ÿå‡ºçš„ä»£ç æ›´å°

    yarn add -D typescript@next
    # tslib å°†ä»…ç”¨ä¸æ‚¨çš„ç¼–è¯‘ç›®æ ‡ä¸æ”¯æŒçš„åŠŸèƒ½
    yarn add tslib

    # åˆ›å»ºå·¥ç¨‹é»˜è®¤é…ç½® tsconfig.json 
    yarn tsc --init

ç°åœ¨æˆ‘ä»¬æ¥å®‰è£… reactã€react-dom å’Œå®ƒä»¬çš„ç±»å‹å®šä¹‰ã€‚

    yarn add react react-dom
    yarn add -D @types/{react,react-dom}

Yarn + Vue

    yarn add typescript@3.1.4             # ts è¯­è¨€æ”¯æŒ)
    yarn add ts-loader@3.5.0              # è¯†åˆ«tsçš„laoder)
    yarn add tslint@5.11.0                # tslintæ ¡éªŒåº“)
    yarn add tslint-loader@3.5.4          # tslintçš„loader)
    yarn add tslint-config-standard@8.0.1 # ç”¨äºtslinté»˜è®¤æ ¡éªŒè§„åˆ™)
    yarn add vue-class-component@7.1.0    # ç±»ç»„ä»¶æ”¯æŒ
    yarn add vue-property-decorator@7.2.0 # ç”¨äºåœ¨.vueæ–‡ä»¶ä¸­ä½¿ç”¨tsè¯­æ³•)



## Yarn 6 å¤§ä¼˜ç‚¹


Features

* **Offline Mode.** If you've installed a package before, then you can install it again without an internet connection.
* **Deterministic.** The same dependencies will be installed in the same exact way on any machine, regardless of installation order.
* **Network Performance.** Yarn efficiently queues requests and avoids request waterfalls in order to maximize network utilization.
* **Network Resilience.** A single request that fails will not cause the entire installation to fail. Requests are automatically retried upon failure.
* **Flat Mode.** Yarn resolves mismatched versions of dependencies to a single version to avoid creating duplicates.
* **More emojis.** ğŸˆ


1ã€ç¦»çº¿æ¨¡å¼

yarnä¼šæœ‰ä¸€ä¸ªç¼“å­˜ç›®å½•ï¼Œä¼šç¼“å­˜ä»¥å‰å®‰è£…è¿‡çš„è½¯ä»¶åŒ…ï¼Œå†æ¬¡å®‰è£…æ—¶å°±ä¸å¿…ä»ç½‘ç»œä¸‹è½½äº†ï¼Œå¤§å¤§åŠ é€Ÿå®‰è£…é€Ÿåº¦ã€‚

è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œnpm é¥±å—è¯Ÿç—…çš„ä¸€ç‚¹å°±æ˜¯ï¼Œæ¯æ¬¡å®‰è£…ä¾èµ–ï¼Œéƒ½éœ€è¦ä»ç½‘ç»œä¸‹è½½ä¸€å¤§å †ä¸œè¥¿ï¼Œè€Œä¸”æ˜¯å…¨éƒ¨é‡æ–°ä¸‹è½½ï¼Œå·¥ç¨‹å¤šçš„æ—¶å€™æ¯”è¾ƒçƒ¦äººã€‚

æˆ‘å¸éƒ¨ç½²nodeé¡¹ç›®ï¼Œæ˜¯éœ€è¦åœ¨å‘å¸ƒæœºä¸Šinstallæ‰€æœ‰çš„ä¾èµ–è€Œä¸”å‘å¸ƒæœºçš„ç½‘ç»œç¯å¢ƒä¸æ˜¯å¾ˆå¥½(ä¸ç»™æ­æ¢¯å­)ï¼Œå¯¼è‡´å®‰è£…æ…¢ä¸è¯´è¿˜ç»å¸¸å¤±è´¥(éƒ¨åˆ†åŒ…éœ€è¦è”ç½‘ç¼–è¯‘)ã€‚æ›´æ¢yarnååªéœ€å°†yarnçš„cacheç›®å½•ç¼“å­˜èµ·æ¥ï¼Œæ¯æ¬¡installå—·å—·çš„å¿«ï¼Œéº»éº»å†ä¹Ÿä¸ç”¨æ‹…å¿ƒå‘å¸ƒå¤±è´¥äº†ã€‚

2ã€ä¾èµ–å…³ç³»ç¡®å®šæ€§
åœ¨æ¯ä¸€å°æœºå™¨ä¸Šé’ˆå¯¹åŒä¸€ä¸ªå·¥ç¨‹å®‰è£…ä¾èµ–æ—¶ï¼Œç”Ÿæˆçš„ä¾èµ–å…³ç³»é¡ºåºå’Œç‰ˆæœ¬æ˜¯ä¸€è‡´çš„ã€‚

ä¹‹å‰ npm åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªå¤„ç†å¾—ä¸å¥½çš„åœ°æ–¹ ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘å†™çš„å·¥ç¨‹ä¾èµ– A, B, C ä¸‰ä¸ªåº“ï¼Œæˆ‘åœ¨ç¼–å†™ package.json çš„æ—¶å€™ï¼Œç»™ A, B, C éƒ½æŒ‡å®šäº†ç‰ˆæœ¬å·ã€‚ä½†æ˜¯ A åº“å¯èƒ½åˆä¾èµ– D, E, F åº“ï¼ŒD åº“åˆä¾èµ– G, H åº“ã€‚è¿™ä¹ˆå¤šå…³è”ä¾èµ–å…³ç³»ä¸­ï¼Œå¾ˆå¯èƒ½æŸä¸ªåº“åœ¨æŒ‡å®šä¾èµ–æ—¶ï¼Œæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬å·ã€‚

äºæ˜¯ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœæˆ‘åœ¨å¦ä¸€å°æœºå™¨ä¸Šå¯¹åŒæ ·çš„å·¥ç¨‹å®‰è£…ä¾èµ–ï¼Œæˆ–è€…æŠŠè¿™å°æœºå™¨å·¥ç¨‹ä¸‹çš„ node_modules ç›®å½•åˆ é™¤æ¥é‡æ–°å®‰è£…ä¾èµ–ã€‚ç”±äºå…³è”ä¾èµ–ä¸­ï¼Œæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬å·çš„åº“ï¼Œå‘ç”Ÿäº†ç‰ˆæœ¬æ›´æ–°ï¼Œå°±ä¼šå¯¼è‡´å†æ¬¡å®‰è£…çš„ä¾èµ–ï¼Œå…¶ä¸­å…·ä½“æŸäº›è½¯ä»¶åŒ…çš„ç‰ˆæœ¬æ˜¯ä¸ä¸€è‡´çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¼šå‘ç°åŸæ¥èƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„ç¨‹åºï¼Œå¿½ç„¶å˜å¾—ä¸èƒ½å·¥ä½œæˆ–ä¸€å † BUG.

npmå¯¹åŒ…å¼•å…¥é¡ºåºä¹Ÿååˆ†çš„æ•æ„Ÿï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªç©ºé¡¹ç›®é‡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

    npm init -y
    npm install globule@0.1.0 -S
    npm install babel-generator@6.19.0 -S
    npm install babel-helper-define-map@6.18.0 -S

æˆ‘ä»¬è¿™é‡Œå®‰è£…äº†3ä¸ªåŒ…éƒ½ä¾èµ–äºlodashï¼Œä¸è¿‡globuleä¾èµ–lodash@1.0.3,å¦å¤–ä¸¤ä¸ªä¾èµ–lodash@4.xã€‚

è¿™æ—¶å‡è®¾æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œä½¿ç”¨lodashï¼Œä½†æ˜¯å¿˜è®°é‡æ–°å®‰è£…lodash

    var lodash = require('lodash');
    console.log(lodash.VERSION); // v1.0.3

å¦ä¸€ä¸ªåŒäº‹è·å–é¡¹ç›®ä»£ç ï¼Œæ‰§è¡Œnpm install , è¿™æ—¶çš„ç›®å½•ä¾èµ–ç»“æ„ä¸º

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€å±‚ä¾èµ–çš„lodashå˜æˆäº†4.xç‰ˆæœ¬ï¼Œè¿™æ ·å°±é€ æˆäº†ä¾èµ–ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜ã€‚è€Œyarnåˆ™ä¼šä¿è¯æ— è®ºæ€æ ·å¼•å…¥çš„é¡ºåºï¼Œç›®å½•ä¾èµ–ç»“æ„éƒ½æ˜¯ä¸€è‡´çš„ï¼Œç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿™æ ·çš„BUGã€‚

3ã€ç½‘ç»œæ€§èƒ½ä¼˜åŒ–

ä¸‹è½½è½¯ä»¶æ—¶ä¼šä¼˜åŒ–è¯·æ±‚é¡ºåºï¼Œé¿å…è¯·æ±‚ç€‘å¸ƒå‘ç”Ÿ

4ã€ç½‘ç»œå›å¼¹

yarnåœ¨æŸä¸ªå®‰è£…åŒ…è¯·æ±‚å¤±è´¥æ—¶ä¸ä¼šå¯¼è‡´å®‰è£…å¤±è´¥ï¼Œå®ƒä¼šè‡ªåŠ¨å»å°è¯•é‡æ–°å®‰è£…ã€‚è€Œnpmåˆ™ä¼šæ¯«ä¸çŠ¹è±«çš„å¤±è´¥ï¼Œå¯¼è‡´å¾—å†æ¥ä¸€æ¬¡ï¼Œè€—è´¹æ—¶é—´

5ã€å¤šæ³¨å†Œæ¥æº

æ‰€æœ‰çš„ä¾èµ–åŒ…ï¼Œä¸ç®¡ä»–è¢«ä¸åŒçš„åº“é—´æ¥å…³è”å¼•ç”¨å¤šå°‘æ¬¡ï¼Œå®‰è£…è¿™ä¸ªåŒ…æ—¶ï¼Œåªä¼šä»ä¸€ä¸ªæ³¨å†Œæ¥æºå»è£…ï¼Œè¦ä¹ˆæ˜¯ npm è¦ä¹ˆæ˜¯ bower, é˜²æ­¢å‡ºç°æ··ä¹±ä¸ä¸€è‡´ã€‚

6ã€æ‰å¹³æ¨¡å¼

å¯¹äºå¤šä¸ªåŒ…ä¾èµ–åŒä¸€ä¸ªå­åŒ…çš„æƒ…å†µï¼Œyarnä¼šå°½é‡æå–ä¸ºåŒä¸€ä¸ªåŒ…ï¼Œé˜²æ­¢å‡ºç°å¤šå¤„å‰¯æœ¬ï¼Œæµªè´¹ç©ºé—´ã€‚æ¯”å¦‚1.2ä¸­ï¼Œ`yarn`ä¼šä¸º`babel-generator`å’Œ`babel-helper-define-map` åˆ›å»ºåŒä¸€ä¸ª`lodash`å­ä¾èµ–ï¼Œè¿™æ ·å°±èŠ‚çº¦ä¸€ä»½çš„ç©ºé—´ã€‚


## Npm & Yarn å‘½ä»¤æ¯”è¾ƒ

Npm & Yarn æœ‰å·®å¼‚çš„å‘½ä»¤

    Npm                         Yarn                        åŠŸèƒ½æè¿°
    npm install(npm i)          yarn install(yarn)          æ ¹æ® package.json å®‰è£…æ‰€æœ‰ä¾èµ–
    npm i â€“save [package]       yarn add [package]          æ·»åŠ ä¾èµ–åŒ…
    npm i â€“save-dev [package]   yarn add [package] â€“dev     æ·»åŠ ä¾èµ–åŒ…è‡³ devDependencies
    npm i -g [package]          yarn global add [package]   è¿›è¡Œå…¨å±€å®‰è£…ä¾èµ–åŒ…
    npm update â€“save            yarn upgrade [package]      å‡çº§ä¾èµ–åŒ…
    npm uninstall [package]     yarn remove [package]       ç§»é™¤ä¾èµ–åŒ…

ç›¸åŒæ“ä½œçš„å‘½ä»¤

    Npm                         Yarn                åŠŸèƒ½æè¿°
    npm init                    yarn init           äº’åŠ¨å¼åˆ›å»º/æ›´æ–° package.json é¡¹ç›®é…ç½®æ–‡ä»¶ 
    npm run                     yarn run            è¿è¡Œ package.json ä¸­é¢„å®šä¹‰çš„è„šæœ¬
    npm config list             yarn config list    æŸ¥çœ‹é…ç½®ä¿¡æ¯
    npm config set registry     yarn config set registry ä»“åº“åœ°å€   æ›´æ¢ä»“åº“åœ°å€
    npm list                    yarn list           æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å·²å®‰è£…çš„nodeåŒ…
    npm login                   yarn login          ä¿å­˜ä½ çš„ç”¨æˆ·åã€é‚®ç®±
    npm logout                  yarn logout         åˆ é™¤ä½ çš„ç”¨æˆ·åã€é‚®ç®±
    npm outdated                yarn outdated       æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–åŒ…
    npm link                    yarn link           å¼€å‘æ—¶é“¾æ¥ä¾èµ–åŒ…ï¼Œä»¥ä¾¿åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨
    npm unlink                  yarn unlink         å–æ¶ˆé“¾æ¥ä¾èµ–åŒ…
    npm publish                 yarn publish        å°†åŒ…å‘å¸ƒåˆ° npm
    npm test                    yarn test           æµ‹è¯• = yarn run test
    npm bin                     yarn bin            æ˜¾ç¤º bin æ–‡ä»¶æ‰€åœ¨çš„å®‰è£…ç›®å½•
    npm info                    yarn info           æ˜¾ç¤ºä¸€ä¸ªåŒ…çš„ä¿¡æ¯

yarnæˆ–è€…æ˜¯npmå®‰è£…æˆ–è€…å‡çº§åŒ…çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥æŒ‡å®šå¯¹åº”çš„ç‰ˆæœ¬ä¿¡æ¯

    npm install [package]@[version]
    npm install [package]@[tag]

    yarn add [package]@[version]
    yarn add [package]@[tag]

yarnå’Œnpmç‹¬æœ‰çš„å‘½ä»¤

`npm rebuild pacakgename` ç”¨äºæ›´æ”¹åŒ…å†…å®¹åè¿›è¡Œé‡å»ºï¼›æ¯”å¦‚å¸¸è§çš„`npm rebuild node-sass`ï¼›å½“ä½¿ç”¨Sassï¼ˆScssï¼‰æ¥ä½œæ ·å¼è¡¨é¢„å¤„ç†å™¨ï¼Œå†æ‰“åŒ…çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šé‡è§å¦‚ä¸‹é”™è¯¯ï¼›è€Œè§£å†³æ­¤é—®é¢˜ï¼Œæœ€ä¸ºç®€å•çš„æ–¹å¼å³ä½¿ç”¨ rebuild å‘½ä»¤ï¼Œå¯¹ node-sass è¿›è¡Œé‡å»ºå³å¯ã€‚

>Module build failed: ModuleBuildError: Module build failed: Error: Node Sass does not yet support your current environment: 
This usually happens because your environment has changed since running npm install. Run npm rebuild node-sass to build the binding for your current environment.

`yarn import` ä¾æ®åŸnpmå®‰è£…åçš„node_modulesç›®å½•ç”Ÿæˆä¸€ä»½yarn.lockæ–‡ä»¶ï¼›
`yarn licenses` åˆ—å‡ºå·²å®‰è£…åŒ…çš„è®¸å¯è¯ä¿¡æ¯
`yarn pack` åˆ›å»ºä¸€ä¸ªå‹ç¼©çš„åŒ…ä¾èµ– gzip æ¡£æ¡ˆ
`yarn why` æ˜¾ç¤ºæœ‰å…³ä¸€ä¸ªåŒ…ä¸ºä½•è¢«å®‰è£…çš„ä¿¡æ¯
`yarn autoclean` ä»åŒ…ä¾èµ–é‡Œæ¸…é™¤å¹¶ç§»é™¤ä¸éœ€è¦çš„æ–‡ä»¶

æ€»ç»“ï¼šyarnçš„å‘½ä»¤è·Ÿnpmçš„å‘½ä»¤å¤§åŒå°å¼‚ï¼Œå¯¹äºä½¿ç”¨è¿‡npmçš„äººæ¥è¯´ï¼Œä»npmè¿‡æ¸¡åˆ°yarnåªæ˜¯åŠä¸ªå°æ—¶ä»¥å†…çš„äº‹æƒ…ã€‚æ‰€ä»¥å­¦ä¹ æˆæœ¬å¾ˆä½ï¼Œå€¼å¾—å­¦ä¹ ä¸€ä¸‹ã€‚

è®¾ç½®yarnæ·˜å®é•œåƒ

    yarn config set registry http://registry.npm.taobao.org


# ğŸš© NPM RUN-SCRIPT å‘½ä»¤

[npm scripts ä½¿ç”¨æŒ‡å— - é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2016/10/npm_scripts.html)

å¦‚æœ npm è„šæœ¬é‡Œé¢éœ€è¦æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦æ˜ç¡®å®ƒä»¬çš„æ‰§è¡Œé¡ºåºã€‚

å¦‚æœæ˜¯å¹¶è¡Œæ‰§è¡Œï¼ˆå³åŒæ—¶çš„å¹³è¡Œæ‰§è¡Œï¼‰ï¼Œå¯ä»¥ä½¿ç”¨&ç¬¦å·ã€‚

    $ npm run script1.js & npm run script2.js

å¦‚æœæ˜¯ç»§å‘æ‰§è¡Œï¼ˆå³åªæœ‰å‰ä¸€ä¸ªä»»åŠ¡æˆåŠŸï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨&&ç¬¦å·ã€‚

    $ npm run script1.js && npm run script2.js

è¿™ä¸¤ä¸ªç¬¦å·æ˜¯ Bash çš„åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ node çš„ä»»åŠ¡ç®¡ç†æ¨¡å—ï¼šscript-runnerã€npm-run-allã€redrunã€‚

linux ç³»ç»Ÿè¿˜å¯ä»¥ä½¿ç”¨ `nohub` å’Œ `&` å‘½ä»¤æ¥è¿è¡Œåå°å‘½ä»¤

    nohup node app.js &

Windows ç³»ç»Ÿå¯ä»¥ä½¿ç”¨ `start /b` æ¥è¿è¡Œåå°ç¨‹åºï¼Œç›¸åº”çš„è¿›ç¨‹å¼ºåˆ¶ç»ˆæ­¢å‘½ä»¤å¦‚ä¸‹

    start /b some.exe
    taskkill /IM some.exe


npm è„šæœ¬æœ‰preå’Œpostä¸¤ä¸ªé’©å­ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œbuildè„šæœ¬å‘½ä»¤çš„é’©å­å°±æ˜¯prebuildå’Œpostbuildã€‚

    "prebuild": "echo I run before the build script",
    "build": "cross-env NODE_ENV=production webpack",
    "postbuild": "echo I run after the build script"

ç”¨æˆ·æ‰§è¡Œnpm run buildçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æŒ‰ç…§ä¸‹é¢çš„é¡ºåºæ‰§è¡Œã€‚

    npm run prebuild && npm run build && npm run postbuild

å› æ­¤ï¼Œå¯ä»¥åœ¨è¿™ä¸¤ä¸ªé’©å­é‡Œé¢ï¼Œå®Œæˆä¸€äº›å‡†å¤‡å·¥ä½œå’Œæ¸…ç†å·¥ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

    "clean": "rimraf ./dist && mkdir dist",
    "prebuild": "npm run clean",
    "build": "cross-env NODE_ENV=production webpack"

npm é»˜è®¤æä¾›ä¸‹é¢è¿™äº›é’©å­ã€‚

    prepublishï¼Œpostpublish
    preinstallï¼Œpostinstall
    preuninstallï¼Œpostuninstall
    preversionï¼Œpostversion
    pretestï¼Œposttest
    prestopï¼Œpoststop
    prestartï¼Œpoststart
    prerestartï¼Œpostrestart

è‡ªå®šä¹‰çš„è„šæœ¬å‘½ä»¤ä¹Ÿå¯ä»¥åŠ ä¸Špreå’Œposté’©å­ã€‚æ¯”å¦‚ï¼Œmyscriptè¿™ä¸ªè„šæœ¬å‘½ä»¤ï¼Œä¹Ÿæœ‰premyscriptå’Œpostmyscripté’©å­ã€‚ä¸è¿‡ï¼ŒåŒé‡çš„preå’Œpostæ— æ•ˆï¼Œæ¯”å¦‚prepretestå’Œpostposttestæ˜¯æ— æ•ˆçš„ã€‚

npm æä¾›ä¸€ä¸ªnpm_lifecycle_eventå˜é‡ï¼Œè¿”å›å½“å‰æ­£åœ¨è¿è¡Œçš„è„šæœ¬åç§°ï¼Œæ¯”å¦‚pretestã€testã€posttestç­‰ç­‰ã€‚æ‰€ä»¥ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªå˜é‡ï¼Œåœ¨åŒä¸€ä¸ªè„šæœ¬æ–‡ä»¶é‡Œé¢ï¼Œä¸ºä¸åŒçš„npm scriptså‘½ä»¤ç¼–å†™ä»£ç ã€‚è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

    const TARGET = process.env.npm_lifecycle_event;

    if (TARGET === 'test') {
      console.log(`Running the test task!`);
    }

    if (TARGET === 'pretest') {
      console.log(`Running the pretest task!`);
    }

    if (TARGET === 'posttest') {
      console.log(`Running the posttest task!`);
    }

æ³¨æ„ï¼Œprepublishè¿™ä¸ªé’©å­ä¸ä»…ä¼šåœ¨npm publishå‘½ä»¤ä¹‹å‰è¿è¡Œï¼Œè¿˜ä¼šåœ¨npm installï¼ˆä¸å¸¦ä»»ä½•å‚æ•°ï¼‰å‘½ä»¤ä¹‹å‰è¿è¡Œã€‚è¿™ç§è¡Œä¸ºå¾ˆå®¹æ˜“è®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘ï¼Œæ‰€ä»¥ npm 4 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é’©å­prepareï¼Œè¡Œä¸ºç­‰åŒäºprepublishï¼Œè€Œä» npm 5 å¼€å§‹ï¼Œprepublishå°†åªåœ¨npm publishå‘½ä»¤ä¹‹å‰è¿è¡Œã€‚

## scripts å‘½ä»¤ç®€å†™å½¢å¼

å››ä¸ªå¸¸ç”¨çš„ npm è„šæœ¬æœ‰ç®€å†™å½¢å¼ã€‚

    npm start     npm run start
    npm stop      npm run stop
    npm test      npm run test
    npm restart   npm run stop && npm run restart && npm run start


## CLI Commander äº¤äº’å·¥å…·åˆ¶ä½œ
- ã€Šåšä¸€ä¸ªåŸºäºreact-scriptsçš„è„šæ‰‹æ¶ã€‹ https://www.codercto.com/a/80522.html
- ğŸ› å¦‚ä½•å¿«é€Ÿå¼€å‘ä¸€ä¸ªè‡ªå·±çš„é¡¹ç›®è„šæ‰‹æ¶ï¼Ÿ https://www.jianshu.com/p/5d77ba59d1f6
- https://www.smashingmagazine.com/2017/03/interactive-command-line-application-node-js/
- å‘½ä»¤è¡Œäº¤äº’æ¨¡å— https://github.com/SBoudrias/Inquirer.js
- Commander.js https://www.npmjs.com/package/commander

è·å–å‘½ä»¤è¡Œå‚æ•°å¹¶ä¸å›°éš¾ï¼Œåªéœ€è¦ä½¿ç”¨ process.argvï¼Œä½†è§£æè¿™äº›å‚æ•°çš„å€¼å’Œé€‰é¡¹å¯æ˜¯ä»¶ç´¯äººçš„æ´»ã€‚å¯ä»¥ç›´æ¥ç”¨ Commander å¼€æºæ¨¡å—ï¼Œç”¨äºç¼–å†™å†™å¯äº¤äº’çš„å‘½ä»¤è¡Œå·¥å…·ã€‚

```js
var program = require('commander');

program
  .version('0.1.0')
  .option('-C, --chdir <path>', 'change the working directory')
  .option('-c, --config <path>', 'set config path. defaults to ./deploy.conf')
  .option('-T, --no-tests', 'ignore test hook');

program
  .command('setup [env]')
  .description('run setup commands for all envs')
  .option("-s, --setup_mode [mode]", "Which setup mode to use")
  .action(function(env, options){
    var mode = options.setup_mode || "normal";
    env = env || 'all';
    console.log('setup for %s env(s) with %s mode', env, mode);
  });

program
  .command('exec <cmd>')
  .alias('ex')
  .description('execute the given remote cmd')
  .option("-e, --exec_mode <mode>", "Which exec mode to use")
  .action(function(cmd, options){
    console.log('exec "%s" using %s mode', cmd, options.exec_mode);
  }).on('--help', function() {
    console.log('');
    console.log('Examples:');
    console.log('');
    console.log('  $ deploy exec sequential');
    console.log('  $ deploy exec async');
  });

program
  .command('*')
  .action(function(env){
    console.log('deploying "%s"', env);
  });

program.parse(process.argv);
```

æ¥å†™ä¸€æ®µç¨‹åºï¼Œä» CSV æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚

```js
const program = require('commander');
const csv = require('csv');
const fs = require('fs');
program
  .version('0.0.1')
  .option('-l, --list [list]', 'List of customers in CSV')
  .parse(process.argv)
let parse = csv.parse;
let stream = fs.createReadStream(program.list)
    .pipe(parse({ delimiter : ',' }));
stream
  .on('data', function (data) {
    let firstname = data[0];
    let lastname = data[1];
    let email = data[2];
    console.log(firstname, lastname, email);
  });
```

ä½¿ç”¨ inquirer æ¨¡å—å®ç°æ§åˆ¶å°äº¤äº’ç¨‹åºï¼Œè¿™æ˜¯åŠŸèƒ½éå¸¸å®Œå–„çš„æ§åˆ¶å°è¾“å…¥æ¨¡å—ï¼Œè®¸å¤šæ¡†æ¶çš„è„šæ‰‹æ¶éƒ½ç”¨åˆ°å®ƒï¼š

```js
const inquirer = require('inquirer')

var questions = [
  { type: 'input', name: 'name', message: "What's your name?" },
  { 
    type: 'rawlist', 
    name: 'years', 
    message: "When was PRC founded?", 
    choices: [ "1945", new inquirer.Separator(), "1949", new inquirer.Separator(), "1955" ]
  },
  {
    type: 'checkbox',
    name: 'favor',
    message: "What's your favor?",
    choices: [ "Azure", new inquirer.Separator(), "Blue Violet" ]
  },
]

inquirer.prompt(questions).then(answers => {
  console.log(`Hi ${answers['name']}!`, answers)
})
```

åˆ›å»ºä¸€ä¸ªåä¸º doreact çš„ Nodejs é¡¹ç›®ï¼Œä½œä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹åˆå§‹åŒ–ï¼Œä¸ä¾èµ–å…¶å®ƒæ¨¡å—ï¼Œä¸ç”¨æ‰§è¡Œ npm install å®‰è£…ä»–ä¾èµ–å·¥å…·ï¼š

    npm init

é…ç½®æ–‡ä»¶æ·»åŠ ä¸€ä¸ª bin é…ç½®ï¼š

    {
      "name": "doreact",
      "version": "1.0.0",
      "description": "",
      "main": "main.js",
      "bin": {
        "doreact": "index.js"
      },
      "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1"
      },
      "author": "",
      "license": "ISC"
    }

index.js éšæ„å†™äº†ä¸€å¥æµ‹è¯•è¯­å¥ï¼š

    #!/usr/bin/env node
    console.log("do react here...")

æ‰§è¡Œé“¾æ¥ npm linkï¼š

    npm link
    npm WARN doreact@1.0.0 No description
    npm WARN doreact@1.0.0 No repository field.

    up to date in 0.136s
    C:\Users\OCEAN\AppData\Roaming\npm\doreact -> C:\Users\OCEAN\AppData\Roaming\npm\node_modules\doreact\index.js
    C:\Users\OCEAN\AppData\Roaming\npm\node_modules\doreact -> C:\coding\md\icework\doreact

npm link å‘½ä»¤å¯ä»¥å°†ä¸€ä¸ª npm åŒ…é“¾æ¥åˆ°å…¨å±€æ‰§è¡Œç¯å¢ƒï¼Œä»è€Œåœ¨ä»»æ„ä½ç½®ä½¿ç”¨å‘½ä»¤è¡Œéƒ½å¯ä»¥ç›´æ¥è¿è¡Œã€‚ç®€è¦åœ°è®²ï¼Œè¿™ä¸ªå‘½ä»¤ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

- ä¸º npm åŒ…ç›®å½•åˆ›å»ºè½¯é“¾æ¥ï¼Œå°†å…¶é“¾åˆ° {prefix}/lib/node_modules/your_package
- ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ bin åˆ›å»ºè½¯é“¾æ¥ï¼Œå°†å…¶é“¾åˆ° {prefix}/bin/{name}

è¿™ä¸¤ä¸ªè·¯å¾„æ˜¯å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„ Linux å¹³å°ä¸Šçš„è·¯å¾„ã€‚åœ¨ Windowså¹³å°ä¸­ï¼Œè¿™ä¸¤ä¸ªè·¯å¾„ä¸ºï¼š

- ç›®å½• C:\Users\{Username}\AppData\Roaming\npm\node_modules\your_package
- æ–‡ä»¶ C:\Users\{Username}\AppData\Roaming\npm\package_name

å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºäº†æ–‡ä»¶çš„è½¯é“¾æ¥åï¼Œè¿™æ ·æ—¶å°±ä¼šåœ¨ npm ç¨‹åºç›®å½•ä¸‹æ”¾ç½®ä¸€ä¸ªè¿è¡Œè„šæœ¬ doreactï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œè¿è¡Œè¿™æœ¬ CLI ç¨‹åºï¼š

    #!/bin/sh
    basedir=$(dirname "$(echo "$0" | sed -e 's,\\,/,g')")

    case `uname` in
        *CYGWIN*|*MINGW*|*MSYS*) basedir=`cygpath -w "$basedir"`;;
    esac

    "$basedir/node_modules/doreact/index.js"   "$@"
    exit $?

åœ¨ Windows å¹³å°ä¸‹ä¼šæœ‰ä¸€ä¸ªæ§åˆ¶å°è„šæœ¬å‘½ä»¤ï¼š

    @ECHO off
    SETLOCAL
    CALL :find_dp0
    "%dp0%\node_modules\doreact\index.js"   %*
    ENDLOCAL
    EXIT /b %errorlevel%
    :find_dp0
    SET dp0=%~dp0
    EXIT /b


åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ`#!/usr/bin/env node` è¿™è¡Œä¼šè®©ç³»ç»Ÿæ‰§è¡Œ node ä¸»ç¨‹åºæ¥åŠ è½½å…¥å£ç¨‹åºã€‚æ‰§è¡Œ npm link é“¾æ¥åï¼Œå°±å¯ä»¥æŠŠå‘½ä»¤æŒ‚è½½åˆ°å…¨å±€ï¼Œæ•ˆæœå’Œ npm install -g åä¸€æ ·ï¼Œå½“åšå…¨å±€å‘½ä»¤ä½¿ç”¨ã€‚link çš„ä¸»è¦ç›®çš„æ˜¯ç»™æˆ‘å¼€å‘è°ƒè¯•ç”¨çš„ï¼Œç°åœ¨å¯ä»¥ç›´æ¥åœ¨æ§åˆ¶å°è¾“å…¥ doreact æ‰§è¡Œï¼Œä½ å°±å¯ä»¥çœ‹åˆ°æ‰“å°çš„ä¿¡æ¯äº†ã€‚

å¼€å‘å®Œæˆï¼Œå¯ä»¥è¯•è¯•å‘å¸ƒåˆ° NPM å®˜ç½‘ä¸Šï¼Œåªéœ€è¦æ³¨å†Œä¸€ä¸ªè´¦æˆ·ï¼Œé€šè¿‡é‚®ç®±éªŒè¯ï¼Œå°±å¯ä»¥æ‰§è¡Œ `npm login` ç™»å½• NPM è´¦å·ï¼Œç„¶åæ‰§è¡Œ `npm publish` å‘å¸ƒã€‚æ³¨æ„ï¼Œé¡¹ç›® package.json ä¸­çš„ name ä¹Ÿå°±æ˜¯é¡¹ç›®åç§°ä¸èƒ½å’Œçº¿ä¸Šå·²æœ‰é¡¹ç›®é‡åã€‚å‘å¸ƒå¥½å°±å¯ä»¥é€šè¿‡ `npm i <you project name> -g` æ¥å…¨å±€å®‰è£…å®ƒã€‚

æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨äº†æ·˜å®æºï¼Œéœ€è¦æš‚æ—¶åˆ‡å›å®˜æ–¹æºï¼š

    npm config set registry https://registry.npm.taobao.org
    npm config set registry http://registry.npmjs.org


## hot reload
https://webpack.js.org/configuration/dev-server/
https://zhuanlan.zhihu.com/p/58171039

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘éƒ½æ˜¯é€šè¿‡ CLI çš„æ–¹å¼çƒ­åŠ è½½é¡¹ç›®ï¼Œä½†æ˜¯æœ‰ä¸€æ¬¡é¡¹ç›®ä¸­æˆ‘éœ€è¦ debug ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å°±éœ€è¦é€šè¿‡ Nodejs è°ƒç”¨ç›¸åº”çš„APIå®ç°çƒ­åŠ è½½ã€‚

    webpack-dev-server --config webpack.config.js

æ€»ç»“äº†ä¸¤ç§æ–¹å¼ï¼šç¬¬ä¸€ç§æ˜¯ nodejs è°ƒç”¨ webpack-dev-server çš„API ï¼Œ ç¬¬äºŒç§æ˜¯ é€šè¿‡ webpack-dev-middleware + webpack-hot-middleware + express å®ç°ã€‚

supervisor åœ¨ node ç¨‹åºæ›´æ”¹æ—¶ä¼šè‡ªåŠ¨ç»ˆæ­¢ç¨‹åºç„¶åé‡å¯

    npm install -g supervisor

    supervisor app.js

å¦‚æœæ˜¯åœ¨Linuxæˆ–è€…macä¸Šå®‰è£…ä¼šå‡ºç°é”™è¯¯ï¼Œå› ä¸ºéœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½å®‰è£…ï¼Œè¯·åœ¨å‘½ä»¤å‰åŠ ä¸Šsudo



ä½¿ç”¨ fs çš„ watchï¼š

    const fs = require('fs');
    fs.watch('./a.txt', function(eventType,filename){
        console.log(eventType,filename);
    });

Windows ä¸‹ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶ä¼šè°ƒç”¨å¤šæ¬¡ Windows APIï¼Œå¯¼è‡´å¤šæ¬¡æ‰“å°ã€‚
https://github.com/nodejs/node-v0.x-archive/issues/1970#issuecomment-2599352



# ğŸš© NPM æ¨¡å—å‘å¸ƒ

åœ¨è‡ªå·±æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š

    npm init

æŒ‰ç…§æç¤ºå¡«å†™åŸºæœ¬ä¿¡æ¯ï¼Œé…ç½®é¡¹æ„ä¹‰å¦‚ä¸‹ï¼š

- name      åŒ…çš„åå­—    é»˜è®¤æ˜¯æ‰€åœ¨æ–‡ä»¶å¤¹çš„åå­—
- version   åŒ…çš„ç‰ˆæœ¬    é»˜è®¤å€¼ 1.0.0
- description   é¡¹ç›®æè¿°    
- entry point   å…¥å£æ–‡ä»¶    é»˜è®¤å€¼ index.js
- test command  æµ‹è¯•å‘½ä»¤    
- git respository   æºä»£ç gitä»“åº“åœ°å€  
- keyword   å…³é”®å­—ï¼Œä¼šæ˜¾ç¤ºåœ¨npmä¸­ï¼Œæ–¹ä¾¿åˆ«äººæœç´¢ 
- author    ä½œè€…  
- license   æ‰§ç…§

å‚ç…§ Webpack æ•™ç¨‹ï¼Œå¼€å§‹ç¼–å†™æ¨¡å—ä»£ç ã€‚

## å‘å¸ƒåˆ° NPM ä»“åº“

å…ˆåœ¨å®˜ç½‘æ³¨å†Œ npm è´¦å·ï¼Œé€šè¿‡é‚®ç®±éªŒè¯ï¼Œæ²¡æœ‰éªŒè¯çš„è¯æ˜¯ä¸èƒ½å‘å¸ƒä»£ç  https://www.npmjs.comã€‚

é¡¹ç›®æ·»åŠ  .npmignore æ–‡ä»¶ï¼Œä¾‹ï¼š

    /**/*
    !dist/gaia.demo.map.js
    !ACKNOWLEDGEMENT

è¿™æ ·ä¼šå°† build åçš„ dist æ–‡ä»¶å¤¹å†…çš„ js åŒ…æ–‡ä»¶å‘å¸ƒåˆ° npmï¼Œæ–¹ä¾¿åç»­é€šè¿‡ cdn è®¿é—®ã€‚

ç™»å½• npm è´¦å·ï¼Œæäº¤å‘å¸ƒä¸Šé¢åˆ›å»ºçš„åŒ…ï¼š

    $ npm adduser
    Username: your name
    Password: your password 
    Email: yourmail

æŒ‰ç…§ä½ æ³¨å†Œçš„è´¦å·é…ç½®å¥½ï¼Œè¿™æ—¶å€™çœ‹ä¸€ä¸‹ package.json ä¸­ author å°½é‡ä¸ npm è´¦æˆ·ä¸€è‡´ã€‚

åœ¨æ ¹ç›®å½•ä¸‹é…ç½®è´¦å·ä¿¡æ¯ï¼Œåªç”¨é…ç½®ä¸€æ¬¡å³å¯ï¼Œæˆ‘ä¸Šä¼ çš„æ—¶å€™å‘ç°æœ‰æç¤ºå¿…é¡» admin æƒé™æ‰èƒ½ä¸Šä¼ é—®é¢˜å°±æ˜¯æ²¡åœ¨æ ¹ç›®å½•ä¸‹é…ç½®ä¿¡æ¯ã€‚

æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸï¼Œå¦‚æœä¸æˆåŠŸåˆ™é‡æ–°ç™»å½•ä¸€ä¸‹ï¼Œé…ç½®æˆåŠŸä¹‹åæäº¤ä»£ç :

    npm who am i
    npm login
    npm publish

æ³¨æ„ï¼šå¦‚æœæç¤ºåŒ…ä¸èƒ½ä¸º privateï¼Œéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘å¸ƒæ–¹å¼ï¼š

    npm publish --access public

unpublish å¯ä»¥ç”¨æ¥åˆ é™¤å‘å¸ƒçš„æ¨¡å—ï¼Œè¶…è¿‡ 24 å°æ—¶å°±ä¸èƒ½åˆ é™¤äº†ï¼š

    npm --force unpublish module_name

æ¯æ¬¡æäº¤ç‰ˆæœ¬å·éƒ½è¦æ¯”ä¸Šæ¬¡çš„é«˜ï¼Œæµ‹è¯•æ˜¯å¦æäº¤æˆåŠŸï¼Œå»å®˜ç½‘ä½ çš„è´¦å·ä¸‹é¢çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰ï¼Œæˆ–è€…ç›´æ¥ npm ä¸‹è½½ä¸‹æ¥:

    npm i module_name

æˆ–è€…ç›´æ¥ä¸Šå®˜ç½‘çš„æ¨¡å—ä¸»é¡µä¸Šçœ‹ç»“æœï¼š

    https://www.npmjs.com/package/module_name


## npm çš„ç‰ˆæœ¬æ§åˆ¶

åœ¨ package.json çš„ version å­—æ®µè®°å½•äº†æ¯æ¬¡æäº¤åˆ° npm çš„ç‰ˆæœ¬å·ï¼Œæ‰‹åŠ¨ä¿®æ”¹æˆ–è€…ä½¿ç”¨ npm version å‘½ä»¤ã€‚

npm æœ‰ä¸€å¥—è‡ªå·±çš„ç‰ˆæœ¬æ§åˆ¶æ ‡å‡† Semantic versioning è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼Œå¯¹äº "version":"x.y.z" å…·ä½“ä½“ç°ä¸ºï¼š

- ä¿®å¤ bug å°æ”¹åŠ¨ï¼Œå¢åŠ z
- å¢åŠ äº†æ–°ç‰¹æ€§ï¼Œä½†ä»èƒ½å‘åå…¼å®¹ï¼Œå¢åŠ y
- æœ‰å¾ˆå¤§çš„æ”¹åŠ¨ï¼Œæ— æ³•å‘åå…¼å®¹,å¢åŠ x

ä¾‹å¦‚ï¼šåŸæœ¬çš„é¡¹ç›®æ˜¯ 1.0.0 ç‰ˆæœ¬çš„è¯ï¼Œè‹¥æ˜¯å°æ”¹åŠ¨ï¼Œç‰ˆæœ¬å·å˜ä¸º 1.0.1ï¼Œå¤§çº§åˆ«å‡çº§ç‰ˆæœ¬å·å˜ä¸º 2.0.0ã€‚

é€šè¿‡ npm version è‡ªåŠ¨æ”¹å˜ç‰ˆæœ¬ï¼Œupdate_type ä¸º patch, minor, or major å…¶ä¸­ä¹‹ä¸€ï¼Œåˆ†åˆ«è¡¨ç¤ºè¡¥ä¸ï¼Œå°æ”¹ï¼Œå¤§æ”¹ã€‚

NPM æä¾›äº†ä¸€æ¡æ‰“åŒ…å‘½ä»¤å°†æ¨¡å—çš„æ–‡ä»¶æ‰“åŒ…ä¸ºä¸€ä¸ªå‹ç¼©åŒ…ï¼Œå‹ç¼©åŒ…é‡Œé¢çš„å†…å®¹è·Ÿå…¶ä»–ç”¨æˆ·é€šè¿‡ npm install å®‰è£…ä½ çš„æ¨¡å—é‡Œçš„å†…å®¹ä¸€æ¨¡ä¸€æ ·ã€‚

    npm pack

è¿™æ ·ï¼Œä½ å°±èƒ½æ¸…æ¥šçš„çŸ¥é“ï¼Œå…¶ä»–äººå®‰è£…ä½ çš„npmåŒ…åï¼ŒåŒ…é‡Œçš„å†…å®¹åˆ°åº•æœ‰å“ªäº›ï¼Œå¯ä»¥è¯´æ˜¯ç›¸å½“æ–¹ä¾¿äº†ã€‚å‘å¸ƒä¸€ä¸ªnpmåŒ…å®é™…ä¸Šä¸æ˜¯å¾ˆéš¾ï¼Œè€Œè¦ç»´æŠ¤å„ä¸ªç‰ˆæœ¬åŠŸèƒ½å¯ç”¨ï¼Œå„ç§æ–‡æ¡£çš„ç¼–å†™ï¼Œå„ç§ç‰ˆæœ¬ç¤ºä¾‹çš„è¿­ä»£å‡çº§ç­‰ç­‰ï¼Œè¿™äº›æ‰æ˜¯æœ€æŠ˜ç£¨äººçš„äº‹æƒ…ã€‚

## ä¸€äº›å¸¸è§çš„é”™è¯¯

1. no_perms Private mode enable, only admin can publish this module

    è¿™æ˜¯å› ä¸ºé•œåƒè®¾ç½®æˆæ·˜å®é•œåƒäº†ï¼Œè®¾ç½®å›æ¥å³å¯

        npm config set registry http://registry.npmjs.org

2. npm publish failed put 500 unexpected status code 401

    ä¸€èˆ¬æ˜¯æ²¡æœ‰ç™»å½•ï¼Œé‡æ–°ç™»å½•ä¸€ä¸‹ npm login å³å¯

3. npm ERR! you do not have permission to publish â€œyour module nameâ€. Are you logged in as the correct user?

    åŒ…åè¢«å ç”¨ï¼Œæ”¹ä¸ªåŒ…åå³å¯ã€‚æœ€å¥½åœ¨å®˜ç½‘æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰åŒ…åè¢«å ç”¨ï¼Œä¹‹åå†é‡å‘½å

4. you must verify your email before publishing a new package

    é‚®ç®±æœªéªŒè¯ï¼Œå»å®˜ç½‘éªŒè¯ä¸€ä¸‹é‚®ç®±


## é€šè¿‡CDNè®¿é—®

è¿™é‡Œä½¿ç”¨çš„æ˜¯ jsdelivr

åœ°å€æ ¼å¼ä¸ºï¼š

    https://cdn.jsdelivr.net/npm/(packagename)@(version)/(file)

å¦‚ï¼š

    https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js




# ğŸš© Node æ¶æ„
- https://nodejs.org/en/docs/
- https://nodejs.org/dist/latest-v14.x/docs/api/
- https://nodejs.org/en/docs/guides/nodejs-docker-webapp/
- è§£è¯» V8 GC Logï¼ˆä¸€ï¼‰: Node.js åº”ç”¨èƒŒæ™¯ä¸ GC åŸºç¡€çŸ¥è¯† https://developer.aliyun.com/article/592878

Node æœ‰å››å‡ ä¸ªåŸºæœ¬ç‰¹æ€§ï¼š

- å¼‚æ­¥ I/O å¯ä»¥ä¿è¯åœ¨ CPU è®¡ç®—çš„åŒæ—¶ï¼Œå¼‚æ­¥çš„åŠ è½½ I/Oï¼ŒåŠ å¿«äº†åº”ç”¨çš„è®¿é—®ã€‚ä¸åƒä¼ ç»Ÿçš„æœåŠ¡å™¨æ˜¯ä½¿ç”¨é˜»å¡ I/Oã€è½®è¯¢ I/O ç­‰ç­‰ï¼Œå®ƒç›¸å½“äºåœ¨å‘é€å¤„ç†è¯·æ±‚æ—¶ï¼Œç›´æ¥ä¼ ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å¼‚æ­¥çš„ I/O ç»“æŸåï¼Œä¼šè‡ªåŠ¨çš„æ‰§è¡Œå›è°ƒã€‚

- Event Loop äº‹ä»¶é©±åŠ¨ï¼ŒLibuv å¼‚æ­¥ I/O æŠŠç¨‹åºç²’åº¦é™ä½åˆ°äº‹ä»¶çº§åˆ«ï¼Œfile system, DNS, network, child processes, pipes, signal handling, polling and streamingã€‚ä¼ ç»Ÿçš„æœåŠ¡å™¨æ˜¯ä¸€ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å°±ä¼šå¢åŠ å¤šçº¿ç¨‹é€šä¿¡çš„å¤æ‚æ€§ã€‚è€Œäº‹ä»¶é©±åŠ¨ï¼Œåˆ™ç®€åŒ–äº†äº‹ä»¶æ¨¡å‹ã€‚

- å•çº¿ç¨‹ï¼Œä¸»è¦æ˜¯å› ä¸º Node åŸºäº V8 å¼•æ“å…·æœ‰å•çº¿ç¨‹çš„ç‰¹ç‚¹ï¼Œè€Œä¸”å†…å­˜å¾ˆå°ã€‚è¿™åŒæ—¶ä¹Ÿæ˜¯ Node çš„åŠ£åŠ¿ï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸ CPU è¿›è¡Œå¤šçº¿ç¨‹é«˜ CPU å¯†åº¦çš„åº”ç”¨ã€‚å•çº¿ç¨‹åº”ç”¨å‡ºç°é—®é¢˜æ•´ä¸ªç³»ç»Ÿä¹Ÿä¼šå´©æºƒï¼Œå› æ­¤ Node æä¾›äº† child_process æ¨¡å—åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œä»¥æ­¤æ¥åˆ©ç”¨å¤šæ ¸ï¼Œä¹Ÿå¼•å…¥ cluster é›†ç¾¤ç‰¹æ€§ï¼Œå¢åŠ å¥å£®æ€§ã€‚

- è·¨å¹³å°ï¼ŒNode é™¤äº†åŸºäº JavaScript å®ç°å¼€æ”¾æ¨¡å—åŠŸèƒ½ï¼Œåº•å±‚çš„å¤§éƒ¨åˆ†çš„æ¨¡å—è¿˜æ˜¯ä½¿ç”¨ C++ å®ç°çš„ï¼Œå› æ­¤é€šè¿‡åˆ‡æ¢ç³»ç»Ÿçº§åˆ«çš„ç»„ä»¶ï¼Œå¯ä»¥ç›´æ¥åˆ‡æ¢å¹³å°ã€‚

Node ä¾èµ–çš„åº“åŠå·¥å…·ï¼š

- Libraries
    - Google V8 JavaScript engine C++ API.
    - libuv C library asynchronous I/O.
    - llhttp lightweight TypeScript and C library for HTTP parse.
    - c-ares C library for asynchronous DNS requests.
    - OpenSSL used extensively in both the tls and crypto modules.
    - zlib for fast compression and decompression.
- Tools
    - npm - package manager
    - gyp - The build system is handled by gyp, a python-based project generator copied from V8.
    - gtest - Native C++ code can be tested using gtest, which is taken from Chromium. 


## Memory å†…å­˜æœºåˆ¶
- æ·±å…¥æµ…å‡º Node.js é‡ç‚¹å†…å®¹ https://www.jianshu.com/p/6a6ce275422f

Node çš„å†…å­˜æœºåˆ¶å¾ˆåƒ JVMï¼Œå› ä¸ºå¼€å‘è®¾è®¡ Node å†…å­˜è™šæ‹Ÿæœºçš„æ­£æ˜¯å¼€å‘ Hotspot çš„äººã€‚

åœ¨ JavaScript èƒ½ä½¿ç”¨çš„å†…å­˜æ˜¯æœ‰é™åˆ¶çš„ï¼Œ64 ä½ç³»ç»Ÿä¸‹çº¦ä¸º 1.4GBï¼Œ32 ä½ç³»ç»Ÿå‡åŠã€‚

åœ¨ Node å¯åŠ¨å‰å¯ä»¥é€šè¿‡ä¼ é€’ä»¥ä¸‹å‚æ•°æ¥è°ƒæ•´æœ€å¤§å€¼ï¼Œå•ä½ä¸º MBï¼š

    node --max-old-space-size=1700 app.js
    node --max-new-space-size=1024 app.js

V8 åƒåœ¾å›æ”¶æœºåˆ¶å°†å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒé•¿æˆ–å¸¸é©»å†…å­˜çš„å¯¹è±¡ï¼Œå †çš„æ•´ä½“å¤§å°å°±æ˜¯æ–°ç”Ÿä»£æ‰€ç”¨å†…å­˜åŠ ä¸Šè€ç”Ÿä»£æ‰€æœ‰å†…å­˜ã€‚

æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸»è¦é€šè¿‡ Scavenge ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå…·ä½“å®ç°æ˜¯ Cheney ç®—æ³•ã€‚

åƒåœ¾å›æ”¶æœºåˆ¶å¯ä»¥ç®€å•çš„æè¿°ä¸ºï¼š

- æ–°ç”Ÿä»£ï¼šç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡ï¼Œä½¿ç”¨å¤åˆ¶å›æ”¶â€”â€”å³æŠŠå†…å­˜åˆ†æˆä¸¤å—ï¼Œä¸€å—é—²ç½®ï¼Œå¦ä¸€å—å·¥ä½œï¼›åƒåœ¾å›æ”¶æ—¶ï¼ŒæŠŠå·¥ä½œä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°é—²ç½®ç©ºé—´ä¸­ï¼Œå†äº¤æ¢é—²ç½®å’Œå·¥ä½œçŠ¶æ€ã€‚å…¸å‹çš„ç©ºé—´æ¢æ—¶é—´ã€‚

- è€ç”Ÿä»£ï¼šç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä½¿ç”¨æ ‡è®°æ¸…é™¤ã€æ ‡è®°æ•´ç†â€”â€”å³æ ‡è®°é‚£äº›ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œå›æ”¶çš„æ—¶å€™å›æ”¶æ‰è¿™äº›æ ‡è®°ä¸­çš„å¯¹è±¡ï¼›ç”±äºè¿™ç§æ ‡è®°æ–¹æ³•ä¼šå‡ºç°å†…å­˜ç¢ç‰‡ï¼Œå› æ­¤æ­é…æ ‡è®°æ•´ç†ï¼Œå¯ä»¥æ•´ç†å†…å­˜ã€‚

è¿™åŸºäºä¸€ä¸ªåŸºæœ¬åŸç†ï¼šé‚£ä¹ˆä¸ä¼šé•¿æ—¶é—´ç”Ÿå­˜çš„å†…å®¹ï¼Œåº”è¯¥ç»å¸¸æ¸…ç†ï¼Œè€Œé‚£ä¹ˆé•¿æ—¶é—´ç”Ÿå­˜çš„å†…å®¹åº”è¯¥è®©å®ƒå®‰é™åœ°å­˜åœ¨ä¸‹å»ä¸‹ã€‚

å‘ä¸€ï¼šä½¿ç”¨å¤§å¯¹è±¡ä½œä¸ºç¼“å­˜ï¼Œå¯¼è‡´è€ç”Ÿä»£ï¼ˆOld Spaceï¼‰çš„åƒåœ¾å›æ”¶å˜æ…¢

ä¾‹å¦‚ä½¿ç”¨ä¸€ä¸ªå˜é‡ cache ä½œä¸ºç¼“å­˜ï¼ŒåŠ é€Ÿç”¨æˆ·ä¿¡æ¯çš„æŸ¥è¯¢ï¼Œè¿›è¡Œäº†å¾ˆå¤šæ¬¡æŸ¥è¯¢åï¼Œcache å¯¹è±¡ä¼šè¿›å…¥è€ç”Ÿä»£ï¼Œå¹¶ä¸”ä¼šå˜å¾—æ— æ¯”åºå¤§ï¼Œè€Œè€ç”Ÿä»£æ˜¯ä½¿ç”¨ä¸‰è‰²æ ‡è®° + DFS çš„æ–¹å¼è¿›è¡Œ GC çš„ï¼Œä¸€ä¸ªå¤§å¯¹è±¡ä¼šç›´æ¥å¯¼è‡´ GC èŠ±è´¹çš„æ—¶é—´å¢é•¿ï¼ˆè€Œä¸”ä¹Ÿæœ‰å†…å­˜æ³„æ¼çš„é£é™©ï¼‰ã€‚

å‘äºŒï¼šæ–°ç”Ÿä»£ç©ºé—´ä¸è¶³ï¼Œå¯¼è‡´é¢‘ç¹ GCï¼Œè¿™ä¸ªå‘ä¼šæ¯”è¾ƒéšè”½ã€‚

Node.js é»˜è®¤ç»™ 64 ä½çš„æœºå™¨çš„æ–°ç”Ÿä»£åˆ†é…çš„å†…å­˜æ˜¯ 64MBï¼Œä½†å› ä¸ºæ–°ç”Ÿä»£ GC ä½¿ç”¨çš„æ˜¯ `Scavenge` ç®—æ³•ï¼Œæ‰€ä»¥å®é™…èƒ½ä½¿ç”¨çš„å†…å­˜åªæœ‰ä¸€åŠï¼Œå³ 32MBã€‚

å½“ä¸šåŠ¡ä»£ç é¢‘ç¹åœ°äº§ç”Ÿå¤§é‡çš„å°å¯¹è±¡æ—¶ï¼Œè¿™ä¸ªç©ºé—´å¾ˆå®¹æ˜“å°±ä¼šè¢«å æ»¡ï¼Œä»è€Œè§¦å‘ GCã€‚è™½ç„¶æ–°ç”Ÿä»£çš„ GC æ¯”è€ç”Ÿä»£è¦å¿«å¾—å¤šï¼Œä½†é¢‘ç¹çš„ GC ä¾ç„¶ä¼šå¾ˆå¤§åœ°å½±å“æ€§èƒ½ã€‚æç«¯çš„æƒ…å†µä¸‹ï¼ŒGC ç”šè‡³å¯ä»¥å ç”¨å…¨éƒ¨è®¡ç®—æ—¶é—´çš„ 30% å·¦å³ã€‚

è§£å†³æ–¹æ³•å°±æ˜¯ï¼Œåœ¨å¯åŠ¨ Node.js æ—¶ï¼Œä¿®æ”¹æ–°ç”Ÿä»£çš„å†…å­˜ä¸Šé™ï¼Œå‡å°‘ GC çš„æ¬¡æ•°ï¼š

    node --max-semi-space-size=128 app.js

éšç€å†…å­˜çš„å¢å¤§ï¼ŒGC çš„æ¬¡æ•°å‡å°‘ï¼Œä½†æ¯æ¬¡ GC æ‰€éœ€è¦çš„æ—¶é—´ä¹Ÿä¼šå¢åŠ ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå…·ä½“æ•°å€¼éœ€è¦å¯¹ä¸šåŠ¡è¿›è¡Œå‹æµ‹ profile æ‰èƒ½ç¡®å®šåˆ†é…å¤šå°‘æ–°ç”Ÿä»£å†…å­˜æœ€å¥½ã€‚

ä½†ä¸€èˆ¬æ ¹æ®ç»éªŒè€Œè¨€ï¼Œåˆ†é… 64MB æˆ–è€… 128MB æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚


## Event Loop
- https://nodejs.dev/learn/the-nodejs-event-emitter
- https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
- JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop http://www.ruanyifeng.com/blog/2014/10/event-loop.html
- JavaScript ä¸­çš„ Event Loop - Jake Archibald https://www.bilibili.com/video/BV1E441197g5
- https://nodejs.org/en/docs/guides/timers-in-node/
- https://nodejs.org/dist/latest-v14.x/docs/api/timers.html
- https://swtch.com/~rsc/regexp/regexp1.html
- ReDOS https://www.cnblogs.com/wwlww/p/8413313.html
- https://nodejs.org/en/docs/guides/dont-block-the-event-loop/
- https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/
- https://nodejs.dev/learn/the-nodejs-event-loop

Node.js çš„è¿è¡Œæœºåˆ¶å¦‚ä¸‹ï¼š

- V8 å¼•æ“è§£æ JavaScript è„šæœ¬ã€‚
- è§£æåçš„ä»£ç ï¼Œè°ƒç”¨ Node APIã€‚
- libuv åº“è´Ÿè´£ Node API çš„æ‰§è¡Œï¼Œå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ª Event Loopï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™ V8 å¼•æ“ã€‚
- V8 å¼•æ“å†å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

é™¤äº† setTimeout & setInterval è¿™ä¸¤ä¸ªæ–¹æ³•ï¼ŒNode.js è¿˜æä¾›äº†å¦å¤–ä¸¤ä¸ªä¸ Task Queue æœ‰å…³çš„æ–¹æ³•ï¼š

- process.nextTick() æ·»åŠ åœ¨å½“å‰"æ‰§è¡Œæ ˆ"çš„å°¾éƒ¨ï¼Œä»¥åŠä¸‹ä¸€æ¬¡ä¸»çº¿ç¨‹è¯»å– Task Queue ä¹‹å‰è§¦å‘çš„å›è°ƒå‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæŒ‡å®šçš„ä»»åŠ¡æ€»æ˜¯å‘ç”Ÿåœ¨æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ä¹‹å‰ã€‚
- setImmediate() å¾€å½“å‰ Task Queue çš„å°¾éƒ¨æ·»åŠ äº‹ä»¶ï¼Œå®ƒæŒ‡å®šçš„ä»»åŠ¡æ€»æ˜¯åœ¨ä¸‹ä¸€æ¬¡ Event Loop æ—¶æ‰§è¡Œï¼Œè¿™ä¸ setTimeout(fn, 0) å¾ˆåƒã€‚

æ³¨ï¼šç”±äº nextTick() å‘å½“å‰æ ˆæ·»åŠ ä»»åŠ¡çš„è¿™ç§ç‰¹æ€§ï¼Œåœ¨é€’å½’è°ƒç”¨æ–¹å¼ä½¿ç”¨å®ƒï¼Œå¯èƒ½å¯¼è‡´ä»»åŠ¡æ­»é”ã€‚

![Node.js System](http://www.ruanyifeng.com/blogimg/asset/2014/bg2014100803.png)

       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€>â”‚           timers          â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚     pending callbacks     â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚       idle, prepare       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
    â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”‚           check           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”¤      close callbacks      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phases Overview

- `timers`: this phase executes callbacks scheduled by setTimeout() and setInterval().
- `pending callbacks`: executes I/O callbacks deferred to the next loop iteration.
- `idle`, `prepare`: only used internally. 
- `poll`: retrieve new I/O events; execute I/O related callbacks (almost all with the exception of close callbacks, the ones scheduled by timers, and setImmediate()); node will block here when appropriate.
- `check`: setImmediate() callbacks are invoked here.
- `close` callbacks: some close callbacks, e.g. socket.on('close', ...).


ç¤ºèŒƒï¼š

```
setImmediate(function A() {
  console.log(3);
  setImmediate(function B(){console.log(4);});
  setTimeout(function timeout() {
    console.log('TIMEOUT FIRED');
  }, 0)
});

process.nextTick(function A() {
  console.log(1);
  process.nextTick(function B(){console.log(2);});
});

// 1
// 2
// 3
// TIMEOUT FIRED
// 4
```

Node.js ä½¿ç”¨ Worker Pool æ¥æ‰§è¡Œé‚£äº›èŠ±é”€å¤§çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿæ²¡æœ‰æä¾›éé˜»å¡çš„ I/Oï¼Œä¹ŸåŒ…å« CPU å¯†é›†å‹ä»»åŠ¡ã€‚

ä½¿ç”¨ Worker Pool çš„ APIï¼š

- I/O-intensive
    - DNS: dns.lookup(), dns.lookupService().
    - File System: All file system APIs except fs.FSWatcher() and those that are explicitly synchronous use libuv's threadpool.
- CPU-intensive
    - Crypto: crypto.pbkdf2(), crypto.scrypt(), crypto.randomBytes(), crypto.randomFill(), crypto.generateKeyPair().
    - Zlib: All zlib APIs except those that are explicitly synchronous use libuv's threadpool.

æŠ½è±¡åœ°è¯´ï¼ŒEvent Loop å’Œ Worker Pool åˆ†åˆ«ç»´æŠ¤æŒ‚èµ·äº‹ä»¶å’ŒæŒ‚èµ·ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚

äº‹å®ä¸Šï¼Œäº‹ä»¶å¾ªç¯å®é™…ä¸Šå¹¶ä¸ç»´æŠ¤é˜Ÿåˆ—ï¼Œå®ƒæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå®ƒè¦æ±‚æ“ä½œç³»ç»Ÿä½¿ç”¨ epollï¼ˆLinuxï¼‰ã€kqueueï¼ˆOSXï¼‰ã€event portsï¼ˆSolarisï¼‰æˆ– IOCPï¼ˆWindowsï¼‰ç­‰æœºåˆ¶æ¥ç›‘è§†è¿™äº›æè¿°ç¬¦ã€‚è¿™äº›æ–‡ä»¶æè¿°ç¬¦å¯¹åº”äºç½‘ç»œå¥—æ¥å­—ï¼Œå’Œå®ƒç›‘è§†çš„ä»»ä½•æ–‡ä»¶ã€‚å½“æ“ä½œç³»ç»Ÿè¯´è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸­çš„ä¸€ä¸ªå·²ç»å°±ç»ªæ—¶ï¼Œäº‹ä»¶å¾ªç¯å°†å…¶è½¬æ¢ä¸ºé€‚å½“çš„äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ä¸è¯¥äº‹ä»¶ç›¸å…³è”çš„å›è°ƒã€‚

ç›¸åï¼ŒWorker Pool æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œå…¶æ¡ç›®æ˜¯è¦å¤„ç†çš„ä»»åŠ¡ã€‚å·¥ä½œè¿›ç¨‹ä»æ­¤é˜Ÿåˆ—ä¸­å¼¹å‡ºä¸€ä¸ªä»»åŠ¡å¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå®Œæˆåï¼Œå·¥ä½œè¿›ç¨‹ä¸ºäº‹ä»¶å¾ªç¯å¼•å‘è‡³å°‘ä¸€ä¸ªä»»åŠ¡å·²å®Œæˆäº‹ä»¶ã€‚

ReDoS - Regular expression Denial of Service æ­£åˆ™è¡¨è¾¾å¼æ‹’ç»æœåŠ¡æ”»å‡»ã€‚å¼€å‘äººå‘˜ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼æ¥å¯¹ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œæœ‰æ•ˆæ€§æ ¡éªŒ, å½“ç¼–å†™æ ¡éªŒçš„æ­£åˆ™è¡¨è¾¾å¼å­˜åœ¨ç¼ºé™·æˆ–è€…ä¸ä¸¥è°¨æ—¶, æ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šçš„å­—ç¬¦ä¸²æ¥å¤§é‡æ¶ˆè€—æœåŠ¡å™¨çš„ç³»ç»Ÿèµ„æºï¼Œé€ æˆæœåŠ¡å™¨çš„æœåŠ¡ä¸­æ–­æˆ–åœæ­¢ã€‚

    // REDOS
    if (path.match(/(\/.+)+$/)) {
      console.log('valid path');
    }

è¿˜æœ‰ Blocking the Event Loop: JSON DOSï¼Œå°½ç®¡ JSON.parse & JSON.stringify æä¾›äº†éå¸¸ä¾¿åˆ©çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒä»¬èŠ±é”€ä¹Ÿæ˜¯ç‰¹åˆ«å¤§çš„ APIï¼Œå¤æ‚åº¦ O(n)ï¼Œå¯¹äº n ç‰¹åˆ«å¤§çš„è¾“å…¥ç»å¯¹æ˜¯æ€§èƒ½æ€æ‰‹ã€‚

å¯ä»¥ä½¿ç”¨ JSON Schema æ¥åŠ é€Ÿåºåˆ—åŒ–ï¼Œåœ¨ JSON åºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¯†åˆ«å¤§é‡çš„å­—æ®µç±»å‹ï¼Œæ¯”å¦‚å¯¹äº string ç±»å‹ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ä¸¤è¾¹åŠ ä¸Š "ï¼Œå¯¹äºæ•°ç»„ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦éå†æ•°ç»„ï¼ŒæŠŠæ¯ä¸ªå¯¹è±¡åºåˆ—åŒ–åï¼Œç”¨ , éš”å¼€ï¼Œç„¶ååœ¨ä¸¤è¾¹åŠ ä¸Š [ å’Œ ]ï¼Œè¯¸å¦‚æ­¤ç±»ç­‰ç­‰ã€‚

ä½†å¦‚æœå·²ç»æå‰é€šè¿‡ Schema çŸ¥é“æ¯ä¸ªå­—æ®µçš„ç±»å‹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦éå†ã€è¯†åˆ«å­—æ®µç±»å‹ï¼Œè€Œå¯ä»¥ç›´æ¥ç”¨åºåˆ—åŒ–å¯¹åº”çš„å­—æ®µï¼Œè¿™å°±å¤§å¤§å‡å°‘äº†è®¡ç®—å¼€é”€ï¼Œè¿™å°±æ˜¯ fast-json-stringfy çš„åŸç†ã€‚

æ ¹æ®é¡¹ç›®ä¸­çš„è·‘åˆ†ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³å¯ä»¥æ¯” JSON.stringify å¿«æ¥è¿‘ 10 å€ï¼


ä»¥ä¸‹ Node.js æ ¸å¿ƒæ¨¡å—ä¼šéœ€è¦æ‰§è¡ŒåŒæ­¥å¹¶ä¸”å¤§å¼€é”€çš„ APIï¼š

- Encryption
- Compression
- File system
- Child process

ä»¥ä¸‹ synchronous APIs ä¸åº”è¯¥åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š

- Encryption:
    - crypto.randomBytes (synchronous version)
    - crypto.randomFillSync
    - crypto.pbkdf2Sync
    - You should also be careful about providing large input to the encryption and decryption routines.
- Compression:
    - zlib.inflateSync
    - zlib.deflateSync
- File system:
    - Do not use the synchronous file system APIs.
- Child process:
    - child_process.spawnSync
    - child_process.execSync
    - child_process.execFileSync


## Task queues
- https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask
- https://github.com/zloirock/core-js/blob/v3.2.1/packages/core-js/modules/web.queue-microtask.js
- https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
- https://html.spec.whatwg.org/multipage/webappapis.html#event-loops
- [è¯‘] Deep Dive into Worker Threads in Node.js https://blog.csdn.net/u010862794/article/details/107519722
- [è¯‘] NodeJS Event Loop Part 2 - Timers, Immediates, nextTick  https://zhuanlan.zhihu.com/p/87396353
- JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop http://www.ruanyifeng.com/blog/2014/10/event-loop.html
- JavaScript Event Loop - Jake Archibald https://www.bilibili.com/video/BV1E441197g5
- https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver

Deepal Jayasekara å‘å¸ƒäº† NodeJS Event Loop ç³»åˆ—æ–‡ç« ï¼Œè¯¦ç»†è§£æäº†äº‹ä»¶å¾ªç¯ä¸ä»»åŠ¡é˜Ÿåˆ—ï¼š

- Event Loop and the Big Picture
- Timers, Immediates and Next Ticks
- Promises, Next-Ticks, and Immediates
- Handling I/O (This article)
- Event Loop Best Practices
- New changes to timers and microtasks in Node v11
- JavaScript Event Loop vs Node JS Event Loop

Web ç¨‹åºæ‰§è¡Œæ¶‰åŠåˆ°ä»¥ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š

- ä¸»çº¿çš„åŒæ­¥ä»»åŠ¡ï¼Œå½¢æˆæ‰§è¡Œæ ˆï¼ˆexecution context stackï¼‰ï¼Œæ³¨æ„ä¸æ˜¯ä¸»çº¿ç¨‹ï¼ŒJavaScript åªæœ‰å•çº¿ç¨‹ã€‚
- åœ¨ä¸»çº¿ä»»åŠ¡å¤–ï¼Œè¿˜å­˜åœ¨å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆtask queueï¼‰ï¼Œäº‹ä»¶å¾ªç¯éœ€è¦åœ¨æ¯ä¸ªå¾ªç¯å‘¨æœŸä¸­æŒ‰è°ƒåº¦è§„åˆ™å»å¤„ç†è¿™äº›ä»»åŠ¡ã€‚
- æ‰§è¡Œæ ˆä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œäºæ˜¯ç»“æŸå¼‚æ­¥ä»»åŠ¡çš„ç­‰å¾…çŠ¶æ€ï¼Œç³»ç»Ÿå¼€å§‹å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¼‚æ­¥ä»»åŠ¡ã€‚

è„šæœ¬çº¿ç¨‹è¿è¡Œçš„äº‹ä»¶å¾ªç¯ä¼šä¸æ–­é‡å¤ä¸Šé¢çš„æ­¥éª¤ã€‚

é€šè¿‡ libuv äº‹ä»¶å¾ªç¯å¤„ç†çš„æœ‰ 4 ç§ä»»åŠ¡é˜Ÿåˆ—ï¼š

- Timers queue â€”  åŒ…å« setTimeout è¶…æ—¶å›è°ƒå’Œ setInterval é—´éš”å›è°ƒ
- IO Events Queue â€” Completed IO events
- Immediates Queue â€” åŒ…å« setImmediate å›è°ƒï¼›
- Close Handlers Queueâ€” Any close event handlers.

Node åˆæ·»åŠ äº†å¦å¤–ä¸¤ç§ï¼š

- Next Ticks Queue â€” åŒ…å« process.nextTick å›è°ƒï¼›
- Microtasks Queue â€” åŒ…å«å…¶å®ƒå¾®ä»»åŠ¡ï¼Œå¦‚ Promise å›è°ƒï¼›

åœ¨ Web ä¸­æœ‰ä¸ªä¾‹å¤–çš„æ˜¯ RAF - requestAnimationFrame åŠ¨ç”»ä¸“ç”¨çš„é—´éš”ä»»åŠ¡ï¼Œå®ƒä¼šä¿è¯åœ¨å¾ªç¯å‘¨æœŸä¸­å›ºå®šåœ°æ‰§è¡Œï¼Œä¸åƒ setTimeout è¿™ç±»æ–¹æ³•ï¼Œå»¶æ—¶ä¸å›ºå®šã€‚

è¿˜æœ‰ MutationObserver æ˜¯ç›‘è§† DOM å¯¹è±¡å˜åŒ–çš„ APIï¼š

```js
new MutationObserver(function () {
  console.log('mutate');
}).observe(dom, {
  attributes: true,
});
```

æ ¹æ®æµè§ˆå™¨çš„è§„èŒƒï¼Œå¯ä»¥å°†äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå‘¨æœŸåˆ’åˆ†ä¸ºä¸åŒçš„é˜¶æ®µï¼Œä½†ä¸æ˜¯æ¯ä¸ªæµè§ˆéƒ½å®ç°åŒæ ·çš„å¤„ç†æ¨¡å‹ï¼š

- Event Input æ‰§è¡Œè¾“å…¥äº‹ä»¶å¤„ç†ï¼›
- JS Tasks æ‰§è¡Œè„šæœ¬ä»»åŠ¡å¤„ç†ï¼›
- Begin Frame æ‰§è¡Œæ¯å¸§éœ€è¦å¤„ç†çš„äº‹ä»¶ï¼Œå¦‚çª—å£è°ƒæ•´å¤§å°ï¼Œå†…å®¹æ»šåŠ¨ï¼›
- RAF æ‰§è¡ŒåŠ¨ç”»å›è°ƒï¼ŒMutationObserverï¼›
- Layout æ‰§è¡Œå¸ƒå±€å¤„ç†ï¼›
- Paint æ‰§è¡Œå†…å®¹æ›´æ–°ï¼›

ä¸åŒç±»å‹çš„ä»»åŠ¡åœ¨ Event Loop å¾ªç¯ä¸­æ‰§è¡Œçš„å·®åˆ«ï¼š

- Timeers é˜Ÿåˆ—åœ¨æ¯æ¬¡å¾ªç¯ä¸­ä¸ä¸€å®šæ‰€æœ‰ä»»åŠ¡è€…æ‰§è¡Œå®Œï¼Œå¯ä»¥è¢«æ‰“æ–­ï¼› 
- RAF é˜Ÿåˆ—åœ¨æ¯ä¸ª Event Loop å¾ªç¯ä¸­å°†å½“å‰é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œï¼Œåé¢æ·»åŠ çš„ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€è½®æ‰§è¡Œï¼› 
- Microtask é˜Ÿåˆ—åªè¦æœ‰ä»»åŠ¡ï¼ŒEvent Loop å½“ä¸‹å°±ä¼šæ‰§è¡Œå®Œå†è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œå¦‚æœæŒç»­åœ¨å¾€é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ä¼šå¯¼è‡´äº‹ä»¶ç¯å¡åœ¨å¾®ä»»åŠ¡çš„æ‰§è¡Œä¸­ï¼›

ä»¥ä¸‹ä»£ç ï¼Œæ¼”ç¤ºäº†å„ç§ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼ŒæŒ‰æ•°å­—ç¼–å·ï¼š

```js
console.log('0 script start');
let id = setInterval(() =>   console.log('3 setInterval'), 0);
setTimeout(() =>{ clearInterval(id); console.log('3 setTimeout')}, 0);
Promise.resolve().then(() => console.log('2 Promise'));
Promise.resolve().then(() => console.log('2 Promise'));
Promise.resolve().then(() => {
                             console.log('2 Promise');
    process.nextTick(() =>   console.log('9 nextTick'));
});
Promise.resolve().then(() => console.log('2 Promise'));
Promise.resolve().then(() => console.log('2 Promise'));

setImmediate(() =>             console.log('4 setImmediate'));
setImmediate(() =>             console.log('4 setImmediate'));

process.nextTick(() =>       console.log('1 nextTick'));
process.nextTick(() =>       console.log('1 nextTick'));
process.nextTick(() =>       console.log('1 nextTick'));
console.log('0 script end');
```

å³åœ¨åŒä¸€ä¸ªå¾ªç¯å‘¨æœŸä¸­ï¼Œæ‰§è¡Œé¡ºåºæ˜¯ï¼š

- 0 sync code
- 1 nextTick
- 2 Promise
- 3 setTimeout/setIntervel
- 4 setImmediate

åœ¨åŸç”Ÿçš„ Promises å›è°ƒå±äº Microtaskï¼Œä¼šåœ¨ next tick queue ä¹‹åæ‰§è¡Œã€‚

Node v11.0.0 ä¸­ Timers å’Œ Microtasks ä»»åŠ¡æ‰§è¡Œé¡ºåºæœ‰å˜åŒ–ï¼š

```js
setTimeout(() => console.log('timeout1'));
setTimeout(() => {
    Promise.resolve().then(() => console.log('promise resolve1'))
    console.log('timeout2')
    Promise.resolve().then(() => console.log('promise resolve2'))
});
setTimeout(() => console.log('timeout3'));
```

ä»¥ä¸Šä»£ç è¾“å‡ºï¼Œåœ¨ä¸åŒçš„ Node ç‰ˆæœ¬ä¸­è¾“å‡ºç»“æœä¸åŒï¼š

```sh
# ^Node 11.0
timeout1
timeout2
promise resolve1
promise resolve2
timeout3

# Node 11.0 bellow
timeout1
timeout2
timeout3
promise resolve1
promise resolve2
```

Node v11.0.0 çš„ `nextTick` å’Œ `microtasks` ä»»åŠ¡ä¼šåœ¨æ¯ä¸ª `timers` æˆ– `immediates` ä»»åŠ¡é—´ç©¿æ’ï¼Œå³ timers queue æˆ– immediates queue æ¯è¿è¡Œä¸€ä¸ªä»»åŠ¡åï¼Œå°±ä¼šæš‚åœæ‰§è¡Œï¼Œä»¥ç•™å‡º CPU æ—¶é—´ä¾›æ›´é«˜çº§ä¼˜å…ˆçº§çš„ nextTick æˆ– microtasks ä»»åŠ¡ä½¿ç”¨ï¼Œè¿™ç§è¡Œä¸ºå’Œæµè§ˆå™¨æ˜¯ä¸€è‡´çš„ã€‚

ä½†æ˜¯åœ¨ Node v11.0.0 ä»¥ä¸‹çš„ç‰ˆæœ¬ä¸­ï¼Œpromise ä»»åŠ¡å°†ä¼šè¢«è¿‡æ—¶ timers ä»»åŠ¡æŠ¢å…ˆæ‰§è¡Œã€‚



# ğŸš© Profile æ€§èƒ½åˆ†æ
- https://nodejs.org/docs/latest-v14.x/api/perf_hooks.html
- https://nodejs.org/en/docs/guides/simple-profiling/
- https://v8.dev/docs/profile
- https://benchmarking.nodejs.org/
- Node.jsæ€§èƒ½ä¼˜åŒ– https://blog.csdn.net/guyue35/article/details/87873438

ä»…ä»…æ˜¯ç®€å•çš„å‡çº§ Node.js ç‰ˆæœ¬å°±å¯ä»¥è½»æ¾åœ°è·å¾—æ€§èƒ½æå‡ï¼Œå› ä¸ºå‡ ä¹ä»»ä½•æ–°ç‰ˆæœ¬çš„ Node.js éƒ½ä¼šæ¯”è€ç‰ˆæœ¬æ€§èƒ½æ›´å¥½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

Node.js æ¯ä¸ªç‰ˆæœ¬çš„æ€§èƒ½æå‡ä¸»è¦æ¥è‡ªäºä¸¤ä¸ªæ–¹é¢ï¼š

- V8 çš„ç‰ˆæœ¬æ›´æ–°ï¼›
- Node.js å†…éƒ¨ä»£ç çš„æ›´æ–°ä¼˜åŒ–ã€‚

ä¾‹å¦‚æœ€æ–°çš„ V8 7.1 ä¸­ï¼Œå°±ä¼˜åŒ–äº†æŸäº›æƒ…å½¢ä¸‹é—­åŒ…çš„é€ƒé€¸åˆ†æï¼Œè®© Array çš„ä¸€äº›æ–¹æ³•å¾—åˆ°äº†æ€§èƒ½æå‡ã€‚

Node.js çš„å†…éƒ¨ä»£ç ï¼Œéšç€ç‰ˆæœ¬çš„å‡çº§ï¼Œä¹Ÿä¼šæœ‰æ˜æ˜¾çš„ä¼˜åŒ–ã€‚æ¯ä¸ªæäº¤åˆ° Node.js çš„ PR éƒ½ä¼šåœ¨ review çš„æ—¶å€™è€ƒè™‘ä¼šä¸ä¼šå¯¹å½“å‰æ€§èƒ½é€ æˆè¡°é€€ï¼Œæœ‰ä¸“é—¨çš„ benchmarking å›¢é˜Ÿæ¥ç›‘æ§æ€§èƒ½å˜åŒ–ã€‚

Node.js çš„ç‰ˆæœ¬ç­–ç•¥ï¼š

- Node.js çš„ç‰ˆæœ¬ä¸»è¦åˆ†ä¸º Current å’Œ LTSï¼›
- Current å°±æ˜¯å½“å‰æœ€æ–°çš„ã€ä¾ç„¶å¤„äºå¼€å‘ä¸­çš„ Node.js ç‰ˆæœ¬ï¼›
- LTS å°±æ˜¯ç¨³å®šçš„ã€ä¼šé•¿æœŸç»´æŠ¤çš„ç‰ˆæœ¬ï¼›
- Node.js æ¯å…­ä¸ªæœˆä¼šå‘å¸ƒä¸€æ¬¡å¤§ç‰ˆæœ¬å‡çº§ï¼Œå¤§ç‰ˆæœ¬ä¼šå¸¦æ¥ä¸€äº›ä¸å…¼å®¹çš„å‡çº§ï¼›
- æ¯å¹´å››æœˆå‘å¸ƒç¨³å®šç‰ˆæœ¬ï¼Œä¸ºå¶æ•°ç‰ˆæœ¬å·ï¼Œç¤¾åŒºä¼šä»å‘å¸ƒå½“å¹´çš„åæœˆå¼€å§‹ï¼Œç»§ç»­ç»´æŠ¤ 18 + 12 ä¸ªæœˆï¼ˆActive LTS + Maintenance LTSï¼‰ï¼›
- æ¯å¹´åæœˆå‘å¸ƒçš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å·ä¸ºå¥‡æ•°ï¼Œåªæœ‰ 8 ä¸ªæœˆçš„ç»´æŠ¤æœŸã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨ Node.js Current çš„ç‰ˆæœ¬æ˜¯ v15ï¼ŒLTS ç‰ˆæœ¬æ˜¯ v14ã€‚

Node.js éå¸¸é€‚åˆ IO å¯†é›†å‹çš„åº”ç”¨ï¼Œè€Œå¯¹äºè®¡ç®—å¯†é›†çš„ä¸šåŠ¡ï¼Œå¾ˆå¤šäººéƒ½ä¼šæƒ³åˆ°ç”¨ç¼–å†™ C++ Addon çš„æ–¹å¼æ¥ä¼˜åŒ–æ€§èƒ½ã€‚ä½†å®é™…ä¸Š C++ æ‰©å±•å¹¶ä¸æ˜¯çµä¸¹å¦™è¯ï¼ŒV8 çš„æ€§èƒ½ä¹Ÿæ²¡æœ‰æƒ³è±¡çš„é‚£ä¹ˆå·®ã€‚

JavaScript åœ¨ V8 ä¸Šè·‘å¾—æ¯” C++ æ‰©å±•è¿˜å¿«ï¼Œè¿™ç§æƒ…å†µå¤šåŠå‘ç”Ÿåœ¨ä¸å­—ç¬¦ä¸²ã€æ­£åˆ™è¡¨è¾¾å¼ç›¸å…³çš„åœºæ™¯ï¼Œå› ä¸º V8 å†…éƒ¨ä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼å¼•æ“æ˜¯ irregexpï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¼•æ“æ¯” boost ä¸­è‡ªå¸¦çš„å¼•æ“ï¼ˆboost::regexï¼‰è¦å¿«å¾—å¤šã€‚

è¿˜æœ‰ä¸€å¤„å€¼å¾—æ³¨æ„çš„å°±æ˜¯ï¼ŒNode.js çš„ C++ æ‰©å±•åœ¨è¿›è¡Œç±»å‹è½¬æ¢çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæ¶ˆè€—éå¸¸å¤šçš„æ€§èƒ½ï¼Œå¦‚æœä¸æ³¨æ„ C++ ä»£ç çš„ç»†èŠ‚ï¼Œæ€§èƒ½ä¼šå¾ˆå¤§åœ°ä¸‹é™ã€‚

C++ æ˜¯å¦æ¯” JavaScript æ›´åŠ é«˜æ•ˆéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼ŒæŸäº›æƒ…å†µä¸‹ï¼ŒC++ æ‰©å±•ä¸ä¸€å®šå°±ä¼šæ¯”åŸç”Ÿ JavaScript æ›´é«˜æ•ˆã€‚å¦‚æœä½ å¯¹è‡ªå·±çš„ C++ æ°´å¹³ä¸æ˜¯é‚£ä¹ˆæœ‰ä¿¡å¿ƒï¼Œå…¶å®è¿˜æ˜¯å»ºè®®ç”¨ JavaScript æ¥å®ç°ï¼Œå› ä¸º V8 çš„æ€§èƒ½æ¯”ä½ æƒ³è±¡çš„è¦å¥½å¾—å¤šã€‚


Node ä½¿ç”¨ V8 å¼•æ“å†…ç½®çš„ profile æ€§èƒ½åˆ†æå·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å®šæœŸå¯¹å †æ ˆè¿›è¡Œé‡‡æ ·ï¼Œå®ƒå°†è¿™äº›ç¤ºä¾‹çš„ç»“æœä»¥åŠé‡è¦çš„ä¼˜åŒ–äº‹ä»¶ï¼Œå¦‚ JIT ç¼–è¯‘è®°å½•ä¸ºä¸€ç³»åˆ—è®°å·ï¼š

    code-creation,LazyCompile,0,0x2d5000a337a0,396,"bp native array.js:1153:16",0x289f644df68,~
    code-creation,LazyCompile,0,0x2d5000a33940,716,"hasOwnProperty native v8natives.js:198:30",0x289f64438d0,~
    code-creation,LazyCompile,0,0x2d5000a33c20,284,"ToName native runtime.js:549:16",0x289f643bb28,~
    code-creation,Stub,2,0x2d5000a33d40,182,"DoubleToIStub"
    code-creation,Stub,2,0x2d5000a33e00,507,"NumberToStringStub"

ä» Node.js 4.4.0 åå¯ä»¥ç›´æ¥çš„ä½¿ç”¨ profile å·¥å…·ï¼Œè€Œæ— éœ€ä» v8 æºä»£ç å•ç‹¬æ„å»ºã€‚

å‡è®¾å·²ç»éƒ¨ç½²äº† Web åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·æŠ±æ€¨è¯·æ±‚çš„å»¶è¿Ÿå¾ˆé«˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½®æ¢æŸ¥å™¨è½»æ¾è¿è¡Œåº”ç”¨ç¨‹åºï¼Œå¹¶å¤„ç†æŠ¥å‘Šï¼š

    $ NODE_ENV=production node --prof --log-source-code app.js
    $ node --prof-process isolate-0x5617f50-1283-v8.log 
    $ node --prof-process --preprocess isolate-0x5617f50-1283-v8.log > v8.json

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ Apache Bench ç­‰å·¥å…·è¿›è¡Œè´Ÿè½½æµ‹è¯•ï¼š

    npm install -g loadtest
    npm i autocannon -g

    curl -X GET "http://localhost:3000"
    autocannon -c 100 -d 5 -p 2 http://localhost:3000
    loadtest -n 1000 -c 100 --rps 100 http://localhost:3000
    ab -k -c 20 -n 250 "http://localhost:3000"

è¾“å‡ºçš„å †æ ˆé‡‡æ ·æ•°æ®æ˜¯é›¶æ•£çš„è®°å½•ï¼Œéœ€è¦å¯¹ profile æ–‡ä»¶è¿›è¡Œåˆ†æå¤„ç†ï¼š

    $ node --prof-process isolate-0x5617f50-1283-v8.log 
    Statistical profiling result from isolate-0x5617f50-1283-v8.log, (182 ticks, 0 unaccounted, 0 excluded).

     [Shared libraries]:
       ticks  total  nonlib   name
        159   87.4%          /home/jeango/.nvm/versions/node/v15.9.0/bin/node
          2    1.1%          [vdso]
          2    1.1%          /usr/lib/x86_64-linux-gnu/libc-2.31.so

     [JavaScript]:
       ticks  total  nonlib   name

     [C++]:
       ticks  total  nonlib   name
         16    8.8%   84.2%  __write
          1    0.5%    5.3%  std::ostream::sentry::sentry(std::ostream&)
          1    0.5%    5.3%  __lll_lock_wait
          1    0.5%    5.3%  __GI___pthread_mutex_unlock

     [Summary]:
       ticks  total  nonlib   name
          0    0.0%    0.0%  JavaScript
         19   10.4%  100.0%  C++
          0    0.0%    0.0%  GC
        163   89.6%          Shared libraries

     [C++ entry points]:
       ticks    cpp   total   name
          5  100.0%    2.7%  TOTAL

     [Bottom up (heavy) profile]:
      Note: percentage shows a share of a particular caller in the total
      amount of its parent calls.
      Callers occupying less than 1.0% are not shown.

       ticks parent  name
        159   87.4%  /home/jeango/.nvm/versions/node/v15.9.0/bin/node
        150   94.3%    /home/jeango/.nvm/versions/node/v15.9.0/bin/node
        120   80.0%      LazyCompile: ~DiffieHellman node:internal/crypto/diffiehellman:85:23
        120  100.0%        LazyCompile: ~createDiffieHellman node:crypto:151:29
        120  100.0%          Eval: ~<anonymous> /home/jeango/arcblock/my-app/demo.js:1:1
        120  100.0%            LazyCompile: ~Module._compile node:internal/modules/cjs/loader:1045:37
         17   11.3%      LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
         15   88.2%        LazyCompile: ~nativeModuleRequire node:internal/bootstrap/loaders:303:29
          4   26.7%          Eval: ~<anonymous> node:crypto:1:1
          4  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          3   20.0%          Eval: ~<anonymous> node:internal/source_map/source_map_cache:1:1
          3  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          LazyCompile: ~initializeCJSLoader node:internal/bootstrap/pre_execution:413:29
          1  100.0%            LazyCompile: ~prepareMainThreadExecution node:internal/bootstrap/pre_execution:21:36
          1    6.7%          Eval: ~<anonymous> node:internal/modules/package_json_reader:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:internal/modules/esm/loader:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:internal/modules/esm/get_source:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:internal/crypto/hkdf:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:internal/crypto/cipher:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:fs:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          1    6.7%          Eval: ~<anonymous> node:assert:1:1
          1  100.0%            LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          2   11.8%        LazyCompile: ~compileForPublicLoader node:internal/bootstrap/loaders:219:25
          2  100.0%          LazyCompile: ~loadNativeModule node:internal/modules/cjs/helpers:35:26
          2  100.0%            LazyCompile: ~Module._load node:internal/modules/cjs/loader:747:24
          3    2.0%      LazyCompile: ~internalBinding node:internal/bootstrap/loaders:137:45
          3  100.0%        Eval: ~<anonymous> node:crypto:1:1
          3  100.0%          LazyCompile: ~compileForInternalLoader node:internal/bootstrap/loaders:270:27
          3  100.0%            LazyCompile: ~compileForPublicLoader node:internal/bootstrap/loaders:219:25

         16    8.8%  __write
          5   31.3%    /home/jeango/.nvm/versions/node/v15.9.0/bin/node
          1   20.0%      LazyCompile: ~toString node:buffer:783:46
          1  100.0%        Eval: ~<anonymous> /home/jeango/arcblock/my-app/demo.js:1:1
          1  100.0%          LazyCompile: ~Module._compile node:internal/modules/cjs/loader:1045:37
          1  100.0%            LazyCompile: ~Module._extensions..js node:internal/modules/cjs/loader:1100:37
          1   20.0%      LazyCompile: ~setupWarningHandler node:internal/bootstrap/pre_execution:138:29
          1  100.0%        LazyCompile: ~prepareMainThreadExecution node:internal/bootstrap/pre_execution:21:36
          1  100.0%          Eval: ~<anonymous> node:internal/main/run_main_module:1:1
          1   20.0%      LazyCompile: ~prepareMainThreadExecution node:internal/bootstrap/pre_execution:21:36
          1  100.0%        Eval: ~<anonymous> node:internal/main/run_main_module:1:1
          1   20.0%      LazyCompile: ~isEncoding node:buffer:530:40
          1  100.0%        LazyCompile: ~assertEncoding node:internal/fs/utils:133:24
          1  100.0%          LazyCompile: ~getOptions node:internal/fs/utils:296:20
          1  100.0%            LazyCompile: ~readFileSync node:fs:390:22
          1   20.0%      LazyCompile: ~compileFunction node:vm:311:25
          1  100.0%        LazyCompile: ~wrapSafe node:internal/modules/cjs/loader:1007:18
          1  100.0%          LazyCompile: ~Module._compile node:internal/modules/cjs/loader:1045:37
          1  100.0%            LazyCompile: ~Module._extensions..js node:internal/modules/cjs/loader:1100:37

          2    1.1%  [vdso]
          1   50.0%    /home/jeango/.nvm/versions/node/v15.9.0/bin/node
          1  100.0%      LazyCompile: ~patchProcessObject node:internal/bootstrap/pre_execution:78:28
          1  100.0%        LazyCompile: ~prepareMainThreadExecution node:internal/bootstrap/pre_execution:21:36
          1  100.0%          Eval: ~<anonymous> node:internal/main/run_main_module:1:1

          2    1.1%  /usr/lib/x86_64-linux-gnu/libc-2.31.so

ä» [Summary] å¯ä»¥çœ‹åˆ°æ€§èƒ½æŠ¥å‘Šçš„æ€»ç»“æ€§æ•°æ®ï¼Œæ ¹æ®å…·ä½“çš„ Shared librariesã€JavaScriptã€C++ æ¨¡å—å¯ä»¥çŸ¥é“æ€§èƒ½ç“¶é¢ˆå‡ºç°åœ¨å“ªã€‚

å†ä» [Bottom up (heavy) profile] åˆ—è¡¨ä¸­åˆ†æå…·ä½“çš„ API å ç”¨ CPU æ—¶é—´æ¥ç¡®å®šé—®é¢˜ç‚¹ï¼Œä¸è¿‡æœ‰äº›å¯¼è‡´æ€§èƒ½é—®é¢˜çš„ API å¯èƒ½æ²¡æœ‰è®°å½•ï¼Œè¿™ä¸ªéœ€è¦æœ‰å¤„ç†ç»éªŒã€‚

æ¯ä¸ªéƒ¨åˆ†çš„ä»£ç æ‰§è¡Œæ‰€å ç”¨çš„ CPU ticks æ—¶é’Ÿå‘¨æœŸæ•°ï¼Œç»†èŠ‚åˆ—è¡¨ [Bottom up (heavy) profile] ä¸­çš„ç™¾åˆ†æ¯”æ˜¯å çˆ¶è°ƒç”¨çš„æ¯”ä¾‹ã€‚

ä¸Šé¢é‡‡æ ·çš„è¿™äº›æ•°æ®è¡¨ç¤ºï¼Œ89.6% çš„ CPU æ—¶é—´èŠ±åœ¨ Shared libraries è¿è¡Œä¸Šï¼Œå…±äº«åº“ä¸­åˆä»¥ Node å ç”¨ CPU æ—¶é—´æœ€å¤š 87.4%ã€‚

æ¥ä¸‹æ¥æŸ¥çœ‹åˆ—è¡¨ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å“ªäº› API å ç”¨äº†æœ€å¤šçš„æ—¶é—´ï¼Œå¹¶æ‰¾å‡ºç›¸åº”çš„è§£å†³åŠæ³•ã€‚è¿™é‡Œæ˜¾ç„¶æ˜¯ crypto diffiehellmanï¼Œå³åŠ å¯†æ¨¡å—çš„ DH ç®—æ³•çš„ APIï¼Œå› ä¸ºæµ‹è¯•ç¨‹åºä½¿ç”¨çš„æ˜¯ crypto.createDiffieHellman(512) è¿›è¡Œå¯†é’¥ç”Ÿæˆã€‚

æ–‡æœ¬æŸ¥çœ‹æ–¹å¼ä¸å¤Ÿç›´è§‚ï¼Œå¯ä»¥ç”¨ Chrome V8 profiling log processorï¼Œè¿™æ˜¯ v8 ä»“åº“æä¾›çš„ UI ç•Œé¢å·¥å…·ã€‚

å¯ä»¥å…ˆ clone v8 ä»“åº“ä¸‹æ¥ï¼Œå†å°†æ—¥å¿—æ–‡ä»¶è½¬æ¢æˆ JSON æ ¼å¼ç”¨ v8/tools/profview/index.html é¡µé¢æ‰“å¼€ï¼š

    git clone https://github.com/v8/v8.git
    node --prof --log-source-code app.js
    node --prof-process --preprocess isolate-xxxxxxxxxx-v8.log > v8.json

Node æºä»£ç ä¹ŸåŒ…å« v8ï¼Œå¯ä»¥åœ¨ deps ç›®å½•ä¸‹æ‰¾åˆ°ã€‚


## Node Clinic & Flame graphs
- Bubbleprof https://clinicjs.org/documentation/bubbleprof/
- https://www.npmjs.com/package/autocannon
- å¦‚ä½•è¯»æ‡‚ç«ç„°å›¾ï¼Ÿ http://www.ruanyifeng.com/blog/2017/09/flame-graph.html
- http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html
- http://www.brendangregg.com/flamegraphs.html

node-clinic æ˜¯ NearForm å¼€æºçš„ä¸€æ¬¾ Node.js æ€§èƒ½è¯Šæ–­å·¥å…·ï¼Œå¯ä»¥éå¸¸å¿«é€Ÿåœ°å®šä½æ€§èƒ½é—®é¢˜ã€‚

å®‰è£…ä½¿ç”¨ï¼š

    npm i -g clinic
    npm i -g autocannon

    yarn global add clinic
    yarn global add autocannon

å®˜æ–¹ç¤ºèŒƒä¾‹å­æä¾› Event Loopã€I/O å’Œ GC æ–¹é¢æ€§èƒ½æµ‹è¯•ç¤ºèŒƒï¼š

    git clone git@github.com:nearform/node-clinic-doctor-examples.git
    cd node-clinic-doctor-examples
    npm install

    clinic doctor --autocannon [ / ] -- node slow-event-loop
    clinic doctor --autocannon [ -c 2500 / ] -- node slow-gc
    clinic doctor --autocannon [ / ] -- node slow-io
    clinic doctor --autocannon [ / ] -- node sync-io

    git clone git@github.com:nearform/node-clinic-flame-demo.git
    git clone git@github.com:nearform/node-clinic-bubbleprof-demo.git

    clinic flame --on-port 'autocannon localhost:$PORT' -- node 1-server-with-slow-function.js
    clinic bubbleprof --on-port 'autocannon -c 5 -a 500 localhost:$PORT' -- node 1-server-with-no-index.js


æ¨¡å—æä¾›ä¸‰å¤§åŠŸèƒ½ï¼Œè·‘åˆ†æµ‹è¯•ï¼ŒI/O é—®é¢˜åˆ†æï¼Œç«ç„°å›¾ï¼š

- Clinic.js Doctor - æ€§èƒ½é—®é¢˜è¯Šæ–­
    - Collects metrics by injecting probes
    - Assess health and heuristics
    - Creates recommendations

- Clinic.js Bubbleprof - ä»£ç åˆ†æ
    - Collects metrics using `async_hooks`
    - Tracks latency between operations
    - Creates bubble graphs

- Clinic.js Flame - ä½¿ç”¨ç«ç„°å›¾æ­ç¤ºæ€§èƒ½ç“¶é¢ˆ
    - Collects metrics by CPU sampling
    - Tracks top-of-stack frequency
    - Creates flamegraphs

åŸºæœ¬ä½¿ç”¨æµç¨‹ï¼š

    # 1. benchmark
    clinic doctor -- node server.js

    wrk http://localhost:3000
    autocannon http://localhost:3000

    # Finally shut down your server (Ctrl+C).

    # 2. debug I/O issues, use Clinic.js Bubbleprof
    clinic bubbleprof -- node server.js
    # Then benchmark your server again, just like you did with clinic doctor.

å¯æƒœè¿˜ä¸æ”¯æŒ cluster æ¨¡å—ã€‚

ä½¿ç”¨çš„æ—¶å€™ï¼Œå…ˆå¼€å¯æœåŠ¡è¿›ç¨‹ clinic doctor è¿è¡Œç¨‹åºï¼Œå†è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚

å¯ä»¥ç”¨ä»»ä½•å‹æµ‹å·¥å…·è·‘ä¸€æ¬¡å‹æµ‹ï¼Œæ¯”å¦‚ä½¿ç”¨åŒä¸€ä¸ªä½œè€…çš„ autocannonï¼Œå®ƒä»¬å¯ä»¥å¾ˆå¥½åœ°ä¸€èµ·å·¥ä½œã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ abã€curl è¿™æ ·çš„å·¥å…·æ¥è¿›è¡Œå‹æµ‹ï¼Œå‹æµ‹å®Œæ¯•å Ctrl + c å…³é—­ clinic å¼€å¯çš„è¿›ç¨‹ï¼Œå°±ä¼šè‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šã€‚

    clinic doctor --autocannon [ -m POST /api/example ] -- node server.js
    clinic doctor --autocannon [ -m POST 'http://localhost:$PORT/?\$page=1' ] -- node server.js
    clinic doctor --on-port 'autocannon localhost:$PORT' -- node slow-event-loop

    clinic flame --on-port 'autocannon localhost:$PORT' -- node slow-io
    clinic bubbleprof --on-port 'autocannon localhost:$PORT' -- node slow-io

autocannon éƒ¨åˆ†å‚æ•°ï¼š

    -c/--connections NUM æµ‹è¯•å¹¶å‘çš„è¯·æ±‚æ•°é‡ï¼Œé»˜è®¤ä¸º 10 ä¸ªï¼›
    -p/--pipelining NUM æµ‹è¯•ç”¨çš„ç®¡é“è¯·æ±‚æ•°é‡ï¼Œé»˜è®¤ 1 ä¸ªï¼›
    -d/--duration SEC æµ‹è¯•æ€»æ—¶é—´ï¼Œé»˜è®¤ 10sï¼›
    -a/--amount NUM æ€»æµ‹è¯•çš„è¯·æ±‚æ•°é‡ï¼Œå¦‚æœè®¾ç½®å°±å¿½ç•¥æ—¶é—´è®¾ç½®ï¼›
    -S/--socketPath è®¾ç½® Unix Domain Socket æˆ– Windows Named Pipe è·¯å¾„ï¼›
    -w/--workers è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°ï¼›
    --on-port åœ¨ä¾¦å¬ç«¯å£åå¼€å§‹å‘ port å‘é€è¯·æ±‚ï¼Œéœ€è¦ URL ä½†å¯ä»¥çœç•¥ä¸»æœºéƒ¨åˆ†ï¼Œé»˜è®¤ä½¿ç”¨ localhostï¼›
    -m/--method METHOD æ‰§è¡Œ HTTP çš„è¯·æ±‚æ–¹æ³•ï¼Œé»˜è®¤ GETï¼›
    -t/--timeout NUM è¶…æ—¶è®¾ç½®ï¼Œé»˜è®¤ 10s;
    -b/--body BODY è¯·æ±‚æ•°æ®ä½“ï¼Œå¯èƒ½éœ€è¦è®¾ç½®ç›¸åº”æ ‡å¤´ -H/--headersï¼›
    -i/--input FILE å‘é€æ–‡ä»¶ï¼›
    -H/--headers K=V è®¾ç½®ç›¸åº”æ ‡å¤´ï¼›


ä¾‹å¦‚ï¼ŒåŒæ­¥ I/O æ¡ˆä¾‹æµ‹è¯• autocannon æŠ¥å‘Šæ¦‚è¦ï¼š

    $ clinic doctor --autocannon [ / ] -- node sync-io
    Running 10s test @ http://localhost:3000/
    10 connections

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stat    â”‚ 2.5%  â”‚ 50%    â”‚ 97.5%  â”‚ 99%    â”‚ Avg      â”‚ Stdev    â”‚ Max    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Latency â”‚ 91 ms â”‚ 100 ms â”‚ 113 ms â”‚ 120 ms â”‚ 99.91 ms â”‚ 10.16 ms â”‚ 163 ms â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stat      â”‚ 1%    â”‚ 2.5%  â”‚ 50%   â”‚ 97.5% â”‚ Avg     â”‚ Stdev â”‚ Min     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Req/Sec   â”‚ 93    â”‚ 93    â”‚ 100   â”‚ 100   â”‚ 99.1    â”‚ 2.08  â”‚ 93      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Bytes/Sec â”‚ 14 kB â”‚ 14 kB â”‚ 15 kB â”‚ 15 kB â”‚ 14.9 kB â”‚ 312 B â”‚ 13.9 kB â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Req/Bytes counts sampled once per second.

    991 requests in 10.04s, 149 kB read
    Analysing data
    Generated HTML file ...

å…¶ä¸­ä¸»è¦æŒ‡æ ‡ Req/Sec å³å¹¶å‘æ•°é‡ï¼ŒLatency è¯·æ±‚å“åº”å»¶æ—¶ï¼Œç»Ÿè®¡å»¶æ—¶æ•°æ®è¶Šä½çš„è¯·æ±‚æ”¾åœ¨å‰é¢å¹¶æ˜¾ç¤ºç›¸åº”çš„ç™¾åˆ†æ¯”ï¼Œå°†åŒæ­¥æ–‡ä»¶ API å…³é—­å¯¹æ¯”ä¼šå‘ç°æ€§èƒ½ç»å¯¹æ˜¯ä¸¤å›äº‹ã€‚

å†æµ‹è¯• slow-event-loop å¯ä»¥å‘ç°ï¼Œæ¯” sync-io çš„å»¶æ—¶è¦æ˜æ˜¾ï¼Œå› ä¸º sleep æ—¶é—´æ›´å¤§ï¼Œè¿™ä¹Ÿæ˜¯å…¸å‹çš„åŒæ­¥è®¡ç®—é˜»å¡äº†å¼‚æ­¥é˜Ÿåˆ—å¯¼è‡´å»¶è¿Ÿæé«˜ï¼š

    $ clinic doctor --autocannon [ / ] -- node slow-event-loop
    Running 10s test @ http://localhost:3000/
    10 connections

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stat    â”‚ 2.5%   â”‚ 50%    â”‚ 97.5%  â”‚ 99%    â”‚ Avg       â”‚ Stdev    â”‚ Max    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Latency â”‚ 252 ms â”‚ 300 ms â”‚ 331 ms â”‚ 332 ms â”‚ 297.54 ms â”‚ 28.01 ms â”‚ 370 ms â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stat      â”‚ 1%      â”‚ 2.5%    â”‚ 50%     â”‚ 97.5%  â”‚ Avg     â”‚ Stdev â”‚ Min     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Req/Sec   â”‚ 31      â”‚ 31      â”‚ 33      â”‚ 34     â”‚ 33      â”‚ 0.78  â”‚ 31      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Bytes/Sec â”‚ 4.65 kB â”‚ 4.65 kB â”‚ 4.95 kB â”‚ 5.1 kB â”‚ 4.95 kB â”‚ 117 B â”‚ 4.65 kB â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Req/Bytes counts sampled once per second.

    330 requests in 10.06s, 49.5 kB read
    Analysing data
    Generated HTML file

å½“ç„¶ï¼Œè¿˜æœ‰ç›¸åº”çš„ Web æŠ¥å‘Šè§†å›¾ï¼Œå››ä¸ªæ•°æ®ä½¿ç”¨çš„ç›¸åŒçš„ x åæ ‡è¡¨ç¤ºæ—¶é—´è½´ï¼š

- CPU Usage å¤šæ ¸ä¼šå‡ºç°è¶…è¿‡ 100% çš„æ•°æ®ï¼Œå¦‚æœ I/O ä»£ç æœ‰é˜»å¡é—®é¢˜ï¼ŒCPU å ç”¨ä¼šæ›´é«˜å¹¶ä¸”æ˜¯é—´æ–­çš„æ‰§è¡Œä»»åŠ¡ï¼ŒåŸºæœ¬å¤±å»å¹¶å‘èƒ½åŠ›ã€‚
- Memory Usage
    - `RSS` - Resident Set Size: è¿›ç¨‹æ‰§è¡Œçš„ä¸€éƒ¨åˆ†åˆ†é…çš„æ‰€æœ‰å†…å­˜æœ€é«˜å€¼ï¼Œåˆ° THA çš„å·®å€¼è¡¨ç¤ºéå †å†…å­˜ï¼Œå¦‚ä»£ç æœ¬èº«çš„å­˜å‚¨ã€å †æ ˆåŒ…å«çš„å˜é‡æŒ‡é’ˆå’ŒåŸå§‹å€¼ï¼Œä»¥åŠ Buffer å†…å­˜æ± ã€‚
    - `THA` - Total Heap Allocated: å †å†…å­˜æ€»åˆ†é…é‡ï¼Œä¸ºå­˜å‚¨å…·æœ‰å¼•ç”¨çš„é¡¹é¢„ç•™çš„ç©ºé—´ï¼Œå¦‚å­—ç¬¦ä¸²ã€å¯¹è±¡å’Œé—­åŒ…ç­‰ã€‚ä¸å­˜å‚¨æŒ‡å‘è¿™äº›é¡¹çš„å¼•ç”¨æŒ‡é’ˆçš„ stack å†…å­˜ä¸åŒï¼Œå †å†…å­˜æ˜¯åˆ†é…æ˜¯é¢„å…ˆè®¾ç½®çš„ã€‚
    - `HU` Heap Used: å †å†…å­˜ä½¿ç”¨é‡ï¼Œå¯¹åº”æ—¶é—´å‘¨æœŸå†…å·²åˆ†é…ä½†æœªåƒåœ¾æ”¶é›†çš„æ‰€æœ‰å­—ç¬¦ä¸²ã€å¯¹è±¡ã€é—­åŒ…ç­‰æ€»å¤§å°ã€‚è¿™é€šå¸¸æ˜¯æœ€æœ‰è¶£çš„ä¸€è¡Œï¼ŒRSS å’Œ Total Heap åˆ†é…äº†ä¸Šä¸‹æ–‡ã€‚
- Event Loop Delay è¡¨ç¤º JavaScript åŒæ­¥ä»£ç çš„æ‰§è¡Œå»¶æ—¶ï¼Œè¶Šä½æ€§èƒ½è¶Šå¥½ã€‚æ°´å¹³çº¿è¡¨ç¤º Node.js é˜»å¡ä¸­ï¼Œå› æ­¤æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•æ•°æ®æ˜¾ç¤ºåœ¨å›¾è¡¨ä¸Šã€‚
- Active Handles æ´»è·ƒèµ„æºå¥æŸ„æ•°ï¼Œè¶Šå¤§è¡¨ç¤ºå ç”¨è¶Šå¤šèµ„æºã€‚


ç«ç„°å›¾è¦ä» perf å‘½ä»¤è®²èµ·ï¼Œå®ƒæ˜¯ performance çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Linux ç³»ç»ŸåŸç”Ÿæä¾›çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä¼šè¿”å› CPU æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°åä»¥åŠè°ƒç”¨æ ˆï¼ˆstackï¼‰ã€‚

é€šå¸¸ï¼Œå®ƒçš„æ‰§è¡Œé¢‘ç‡æ˜¯ 99Hzï¼Œå¦‚æœ 99 æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå‡½æ•°åï¼Œé‚£å°±è¯´æ˜ CPU è¿™ä¸€ç§’é’Ÿéƒ½åœ¨æ‰§è¡ŒåŒä¸€ä¸ªå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ç«ç„°å›¾æ˜¯åŸºäº perf ç»“æœäº§ç”Ÿçš„ SVG å›¾ç‰‡ï¼Œç”¨æ¥å±•ç¤º CPU çš„è°ƒç”¨æ ˆã€‚

- y è½´è¡¨ç¤ºè°ƒç”¨æ ˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è°ƒç”¨æ ˆè¶Šæ·±ï¼Œç«ç„°å°±è¶Šé«˜ï¼Œé¡¶éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸‹æ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°ã€‚
- x è½´è¡¨ç¤ºæŠ½æ ·æ•°ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åœ¨ x è½´å æ®çš„å®½åº¦è¶Šå®½ï¼Œå°±è¡¨ç¤ºå®ƒè¢«æŠ½åˆ°çš„æ¬¡æ•°å¤šï¼Œå³æ‰§è¡Œçš„æ—¶é—´é•¿ã€‚

ç«ç„°å›¾å°±æ˜¯çœ‹å“ªä¸ªé¡¶å±‚å‡½æ•°å æ®çš„å®½åº¦æœ€å¤§ï¼Œåªè¦æœ‰"å¹³é¡¶"ï¼ˆplateausï¼‰ï¼Œå°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚

ç»“åˆ sync-io æ¡ˆä¾‹å¯ä»¥çœ‹åˆ°å¹³é¡¶å‡ºç°çš„ä½ç½®ï¼š

- processTimers
- fs.closeSync()
- fs.openSync()

ä¼˜åŒ–æ˜¯æ²¡æœ‰å°½å¤´çš„ï¼Œç«ç„°å›¾ä¹Ÿæ€»æ˜¯æ˜¾ç¤ºå½“å‰åˆ†ææ•°æ®ï¼ŒæŒ‡ç¤ºä¸»è¦é—®é¢˜å¯èƒ½å‡ºç°çš„ä½ç½®ã€‚å›¾æ¡ˆé¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œç«ç„°å›¾åªæ˜¯ç”¨æš–è‰²è°ƒè¡¨ç¤º CPU çš„ç¹å¿™ç¨‹åº¦ã€‚

ä½¿ç”¨ clinic flame å¯ä»¥æŸ¥çœ‹å…·ä½“çš„ä»£ç ä¸ CPU æ—¶é—´æ¶ˆè€—ï¼Œç«ç„°å›¾ä¸­æ¯ä¸ª API æˆ–æ¨¡å—æ‰€å çš„å®½åº¦å³å¯¹åº”çš„ CPU æ—¶é—´ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å®šä½åˆ°å“ªäº›ä½ç½®å‡ºç°äº†å¯†é›†è®¡ç®—ã€‚

ä»ç«ç„°å›¾é‡Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°é¡¶éƒ¨çš„é‚£ä¸ªçƒ­åº¦è·¯å¾„ä¸­çš„ç™½æ¡éƒ¨åˆ†ï¼Œå®ƒä»£è¡¨äº† sleep å‡½æ•°ç©ºè½¬æ‰€æ¶ˆè€—çš„ CPU æ—¶é—´ã€‚æ ¹æ®è¿™æ ·çš„ç«ç„°å›¾ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾åœ°çœ‹å‡º CPU èµ„æºçš„æ¶ˆè€—æƒ…å†µï¼Œä»è€Œå®šä½ä»£ç ä¸­å“ªé‡Œæœ‰å¯†é›†çš„è®¡ç®—æˆ– I/O çš„é˜»å¡ï¼Œæ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆã€‚


ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ clinic bubbleprof æ¥æ£€æµ‹ I/O æˆ– GC æ—¶é—´æ¶ˆè€—é—®é¢˜ã€‚

æ°”æ³¡å›¾å«ä¹‰ï¼š

- ä¸€ä¸ªæ°”æ³¡è¡¨ç¤ºä¸€ç»„å¼‚æ­¥æ“ä½œã€‚
- ä¸€ç»„å¼‚æ­¥æ“ä½œä¸­èŠ±è´¹çš„æ—¶é—´è¶Šå¤šï¼Œæ°”æ³¡å°±è¶Šå¤§ã€‚
- æ°”æ³¡ä¹‹é—´çš„çº¿è¶Šé•¿ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨çš„å»¶è¿Ÿå°±è¶Šå¤šã€‚

åˆ†æçš„ä»£ç åˆ†ä¸º 3 ä¸ªåŒºåŸŸï¼š

- userland (the application being profiled),
- dependencies (3rd party modules)
- and node core.

é€šè¿‡è”çº¿é•¿åº¦æˆ–æ°”æ³¡å¤§å°å¯ä»¥å®šä»¬ CPU æ—¶é—´çš„æ¶ˆè€—ä½ç½®ï¼ŒæŸ¥çœ‹ç›¸åº”çš„ä½ç½®ï¼Œä¼šå‘ç°è°ƒç”¨æ ˆä¸­å­˜åœ¨å¤§é‡çš„ empty frameï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”±äºç½‘ç»œ I/O çš„é™åˆ¶ï¼ŒCPU å­˜åœ¨å¤§é‡çš„ç©ºè½¬ï¼š

    0 frames from this async operation
    10,020 ms in asynchronous delays, 11 ms in synchronous delays.
     Empty frames


sync-io æ¡ˆä¾‹ä»£ç ï¼š

```
'use strict'

const restify = require('restify')
const fs = require('fs')
const path = require('path')
const tmp = path.join(__dirname, 'tmp')
const server = restify.createServer()

server.get('/', function (req, res, next) {
  sleep(10) // mimic sync I/O by sleeping 10ms sync
  res.send({})
  next()
})

server.listen(3000)

process.on('SIGINT', function () {
  console.error('Caught SIGINT, shutting down.')
  try { fs.unlinkSync(tmp) } catch (e) {}
  server.close()
})

function sleep (ms) {
  var now = Date.now()
  while (Date.now() < now + ms) {
    fs.closeSync(fs.openSync(tmp, 'a'))
  }
}
```

slow-event-loop æ¡ˆä¾‹ä»£ç ï¼š

```
'use strict'

const restify = require('restify')
const server = restify.createServer()

function sleep (ms) {
  const future = Date.now() + ms
  while (Date.now() < future);
}

server.get('/', function (req, res, next) {
  sleep(30)
  res.send({})
  next()
})

server.listen(3000)

process.on('SIGINT', function () {
  console.error('Caught SIGINT, shutting down.')
  server.close()
})
```


slow-io æ¡ˆä¾‹ä»£ç ï¼š

```
'use strict'

const restify = require('restify')
const server = restify.createServer()
const async = require('async')

function awaitData (callback) {
  async.series([
    (done1) => setTimeout(done1, Math.random() * 1000),
    (done1) => async.parallel([
      (done2) => setTimeout(done2, Math.random() * 1000),
      (done2) => setTimeout(done2, Math.random() * 1000),
      (done2) => setTimeout(done2, Math.random() * 1000),
      (done2) => setTimeout(done2, Math.random() * 1000),
      (done2) => setTimeout(done2, Math.random() * 1000)
    ], done1)
  ], callback)
}

server.get('/', function (req, res, next) {
  awaitData(function () {
    res.send({})
    next()
  })
})

server.listen(3000)

process.on('SIGINT', function () {
  console.error('Caught SIGINT, shutting down.')
  server.close()
})
```

slow-gc æ¡ˆä¾‹ä»£ç ï¼š

```
'use strict'

const restify = require('restify')
const server = restify.createServer()

function createLargeLinkStructure (tail, item, repeats, callback) {
  setImmediate(function () {
    if (repeats > 0) {
      const next = JSON.parse(item)
      tail.next = next
      createLargeLinkStructure(next, item, repeats - 1, callback)
    } else {
      callback(null, tail)
    }
  })
}

function getLargeData (data, callback) {
  const item = JSON.stringify(data)
  const first = JSON.parse(item)
  createLargeLinkStructure(first, item, 512, function (err, last) {
    if (err) return callback(err)

    // make data circular
    last.next = first
    callback(null, first)
  })
}

function getVersion (bigdata, callback) {
  setTimeout(function () {
    callback(null, bigdata.version)
  }, 1000)
}

function processRequest (data, callback) {
  getLargeData(data, function (err, bigdata) {
    if (err) return callback(err)

    getVersion(bigdata, function (err, version) {
      if (err) return callback(err)

      callback(null, { version })
    })
  })
}

server.get('/', function (req, res, next) {
  processRequest(require('../package.json'), function (err, output) {
    if (err) return next(err)
    res.send(output)
    next()
  })
})

server.listen(3000)

process.on('SIGINT', function () {
  console.error('Caught SIGINT, shutting down.')
  server.close()
})
```


# ğŸš© v8 inspector æ¨¡å—
- https://nodejs.org/docs/latest-v12.x/api/inspector.html
- https://nodejs.org/docs/latest-v12.x/api/v8.html
- https://nodejs.org/docs/latest-v12.x/api/vm.html
- perf ä¸ FlameGraph ç«ç„°å›¾ https://xiaozhuanlan.com/Nodejs-Guide/9650287413
- ä½¿ç”¨ v8-profiler åˆ†æ CPU çš„ä½¿ç”¨æƒ…å†µ https://xiaozhuanlan.com/Nodejs-Guide/8209375641
- Flame Graphs https://nodejs.org/en/docs/guides/diagnostics-flamegraph/
- æœåŠ¡ç›‘æ§å®ä¾‹ï¼ŒåŸºäºGrafanaï¼ŒInfluxDBå’ŒTelegraf https://baijiahao.baidu.com/s?id=1638107903038876829
- perf Examples http://www.brendangregg.com/perf.html

the inspector module provides an API for interacting with the V8 inspector.

CPU profiler:

```
const inspector = require('inspector');
const fs = require('fs');
const session = new inspector.Session();
session.connect();

session.post('Profiler.enable', () => {
  session.post('Profiler.start', () => {
    // Invoke business logic under measurement here...

    // some time later...
    session.post('Profiler.stop', (err, { profile }) => {
      // Write profile to disk, upload, etc.
      if (!err) {
        fs.writeFileSync('./profile.cpuprofile', JSON.stringify(profile, null, '  '));
      }
    });
  });
});
```

Heap Profiler:

```
const inspector = require('inspector');
const fs = require('fs');
const session = new inspector.Session();

const fd = fs.openSync('profile.heapsnapshot', 'w');

session.connect();

session.on('HeapProfiler.addHeapSnapshotChunk', (m) => {
  fs.writeSync(fd, m.params.chunk);
});

session.post('HeapProfiler.takeHeapSnapshot', null, (err, r) => {
  console.log('HeapProfiler.takeHeapSnapshot done:', err, r);
  session.disconnect();
  fs.closeSync(fd);
});
```


```
$ node --inspect -p 'inspector.url()'
Debugger listening on ws://127.0.0.1:9229/166e272e-7a30-4d09-97ce-f1c012b43c34
For help see https://nodejs.org/en/docs/inspector
ws://127.0.0.1:9229/166e272e-7a30-4d09-97ce-f1c012b43c34

$ node --inspect=localhost:3000 -p 'inspector.url()'
Debugger listening on ws://localhost:3000/51cf8d0e-3c36-4c59-8efd-54519839e56a
For help see https://nodejs.org/en/docs/inspector
ws://localhost:3000/51cf8d0e-3c36-4c59-8efd-54519839e56a
```

Chrome Devtools è‡ªå¸¦ CPU profile æ—¥å¿—åˆ†æå·¥å…·ã€‚

æ‰“å¼€ Chrome -> è°ƒå‡ºæ§åˆ¶å° -> ç‚¹å‡»å³ä¸Šè§’ä¸‰ä¸ªç‚¹çš„æŒ‰é’® -> More tools -> Javascript Profiler -> Loadï¼ŒåŠ è½½ç”Ÿæˆçš„ .cpuprofile æ–‡ä»¶ã€‚

å·¦ä¸Šè§’å¯é€‰ä¸‰ç§æ¨¡å¼ï¼š

- Chartï¼šæ˜¾ç¤ºæŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ç«ç„°å›¾ã€‚
- Heavy (Bottom Up)ï¼šæŒ‰ç…§å‡½æ•°å¯¹æ€§èƒ½çš„å½±å“æ’åˆ—ï¼ŒåŒæ—¶ä½ ä¹Ÿå¯ä»¥æ£€æŸ¥å‡½æ•°çš„è°ƒç”¨è·¯å¾„ã€‚
- Tree (Top Down)ï¼šæ˜¾ç¤ºè°ƒç”¨ç»“æ„çš„æ€»ä½“çŠ¶å†µï¼Œä»è°ƒç”¨å †æ ˆçš„é¡¶ç«¯å¼€å§‹ã€‚

ä¾‹å¦‚ Tree (Top Down) æ¨¡å¼ï¼ŒæŒ‰ Total Time é™åºæ’åˆ—ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸‰åˆ—ï¼š

- Self Timeï¼šå‡½æ•°è°ƒç”¨æ‰€èŠ±çš„æ—¶é—´ï¼Œä»…åŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜ï¼Œä¸åŒ…å«ä»»ä½•å­å‡½æ•°
- Total Timeï¼šå‡½æ•°è°ƒç”¨æ‰€èŠ±çš„æ€»æ—¶é—´ï¼ŒåŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜åŠæ‰€æœ‰å­å‡½æ•°
- Functionï¼šå‡½æ•°ååŠè·¯å¾„ï¼Œå¯å±•å¼€æŸ¥çœ‹å­å‡½æ•°

æ—¶é—´æ•°æ®å…³ç³»ï¼š çˆ¶å‡½æ•°çš„ Total Time = çˆ¶å‡½æ•°çš„ Self Time + æ‰€æœ‰å­å‡½æ•°çš„ Total Timeã€‚


å¯ä»¥ç”¨ç«ç„°å›¾æ¥å±•ç¤º cpuprofile æ•°æ®ï¼Œå…¨å±€å®‰è£…ä½¿ç”¨ flamegraph è¿™ä¸ªæ¨¡å—ï¼š

    $ npm i flamegraph -g
    $ flamegraph -t cpuprofile -f cpuprofile-xxx.cpuprofile -o cpuprofile.svg

ç”¨ Chrome æ‰“å¼€ cpuprofile.svg

è¿˜æœ‰æ˜¯ç¤¾åŒºå¼€æºçš„ v8-profiler å’Œ heapdump ç­‰è¾“å‡ºçš„ CPU & heap-memory æ—¥å¿—çš„å·¥å…·ã€‚å¯ä»¥æä¾›ï¼š

- v8 å¼•æ“é€†ä¼˜åŒ–æˆ–è€…ä¼˜åŒ–å¤±è´¥çš„å‡½æ•°æ ‡çº¢å±•ç¤ºä»¥åŠä¼˜åŒ–å¤±è´¥åŸå› å±•ç¤º
- å‡½æ•°æ‰§è¡Œæ—¶é•¿è¶…è¿‡é¢„æœŸæ ‡çº¢å±•ç¤º
- å½“å‰é¡¹ç›®ä¸­å¯ç–‘çš„å†…å­˜æ³„æ¼ç‚¹å±•ç¤º

å…¨å±€å®‰è£…ä½¿ç”¨ v8-analyticsï¼Œä»¥ä¸‹å‘½ä»¤å°†æ‰€æœ‰å‡½æ•°çš„æ‰§è¡Œæ—¶é—´å¤§äº 200ms çš„å‡½æ•°æ ‡çº¢æ˜¾ç¤ºï¼š

    $ npm i v8-analytics -g
    $ va timeout cpuprofile-xxx.cpuprofile 200



å„æ¨¡å— API å‚è€ƒï¼š

Inspector æ¨¡å—

    - inspector.close()
    - inspector.console
    - inspector.open([port[, host[, wait]]])
    - inspector.url()
    - inspector.waitForDebugger()

    - Class: inspector.Session
    - new inspector.Session()
    - Event: 'inspectorNotification'
    - Event: <inspector-protocol-method>;
    - session.connect()
    - session.connectToMainThread()
    - session.disconnect()
    - session.post(method[, params][, callback])

V8 æ¨¡å—

    - v8.cachedDataVersionTag()
    - v8.getHeapSpaceStatistics()
    - v8.getHeapSnapshot()
    - v8.getHeapStatistics()
    - v8.getHeapCodeStatistics()
    - v8.setFlagsFromString(flags)
    - v8.writeHeapSnapshot([filename])
    - Serialization API
    - v8.serialize(value)
    - v8.deserialize(buffer)

    - Class: v8.Serializer
    - new Serializer()
    - serializer.writeHeader()
    - serializer.writeValue(value)
    - serializer.releaseBuffer()
    - serializer.transferArrayBuffer(id, arrayBuffer)
    - serializer.writeUint32(value)
    - serializer.writeUint64(hi, lo)
    - serializer.writeDouble(value)
    - serializer.writeRawBytes(buffer)
    - serializer._writeHostObject(object)
    - serializer._getDataCloneError(message)
    - serializer._getSharedArrayBufferId(sharedArrayBuffer)
    - serializer._setTreatArrayBufferViewsAsHostObjects(flag)

    - Class: v8.Deserializer
    - new Deserializer(buffer)
    - deserializer.readHeader()
    - deserializer.readValue()
    - deserializer.transferArrayBuffer(id, arrayBuffer)
    - deserializer.getWireFormatVersion()
    - deserializer.readUint32()
    - deserializer.readUint64()
    - deserializer.readDouble()
    - deserializer.readRawBytes(length)
    - deserializer._readHostObject()

    - Class: v8.DefaultSerializer

    - Class: v8.DefaultDeserializer

VM (executing JavaScript)

- Class: vm.Script
    - new vm.Script(code[, options])
    - script.createCachedData()
    - script.runInContext(contextifiedObject[, options])
    - script.runInNewContext([contextObject[, options]])
    - script.runInThisContext([options])

- Class: vm.Module
    - module.dependencySpecifiers
    - module.error
    - module.evaluate([options])
    - module.link(linker)
    - module.namespace
    - module.status
    - module.identifier

- Class: vm.SourceTextModule
    - new vm.SourceTextModule(code[, options])
    - sourceTextModule.createCachedData()

- Class: vm.SyntheticModule
    - new vm.SyntheticModule(exportNames, evaluateCallback[, options])
    - syntheticModule.setExport(name, value)
    - vm.compileFunction(code[, params[, options]])
    - vm.createContext([contextObject[, options]])
    - vm.isContext(object)
    - vm.runInContext(code, contextifiedObject[, options])
    - vm.runInNewContext(code[, contextObject[, options]])
    - vm.runInThisContext(code[, options])



# ğŸš© Debug è°ƒè¯•
- https://nodejs.org/docs/latest-v14.x/api/debugger.html
- https://nodejs.org/en/docs/guides/debugging-getting-started/
- https://nodejs.org/docs/latest-v14.x/api/tracing.html

[Node.js] å†…ç½®äº†ä¸€ä¸ªè¿›ç¨‹å¤–è°ƒè¯•å™¨ï¼Œéµå¾ª [V8 Inspector Protocol] åè®®çš„ Inspector æˆ– Node å†…ç½®çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿›è¡Œè®¿é—®ã€‚è°·å“¥å¼€å‘è€…è°ƒè¯•åè®® [V8 Inspector Protocol] æ˜¯ç›®å‰æœ€æµè¡Œæ˜“ç”¨çš„å‰ç«¯è°ƒè¯•åè®®ä¹‹ä¸€ï¼Œè¿™ä¸ªå·¥å…·åœ¨ä¸æ–­æ›´æ–°å‘å±•ä¸­ã€‚

åœ¨ [Node.js] 6.3+ ä¸­ï¼Œå¯ä»¥å†…ç½®äº†å¯¹æ—§çš„ V8 Debugger Protocol åè®®çš„æ”¯æŒï¼Œé€šè¿‡ `--debug` é€‰é¡¹è°ƒç”¨ã€‚æ–°ç‰ˆçš„ Node å·²ç»é›†æˆ [V8 Inspector Protocol] åè®®åˆ™æ”¯æŒï¼Œä½¿ç”¨ `--inspect` é€‰é¡¹å³å¯è°ƒç”¨ï¼Œå¯ä»¥æŒ‡å®šåœ°å€ç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨ `127.0.0.1:9229`ã€‚æ—§ç‰ˆæœ¬ node ä¸­æ–­æ–¹å¼è°ƒè¯• `--debug-brk` ä¹Ÿè¢«æ–°åè®®çš„ `--inspect-brk` æ›¿æ¢ã€‚åœ¨ VS Code ä¸­æ–°æ—§ä¸¤ç§åè®®åˆ†åˆ«ç§°ä½œ inspector å’Œ legacyï¼Œåœ¨çœ‹åˆ° VS Code å‡ºç°ç›¸åº”æç¤ºä¿¡æ¯æ—¶ï¼Œå¯ä»¥çŸ¥é“å®ƒä»¬çš„å¯¹åº”å…³ç³»ã€‚VS Code èª¿è©¦é…ç½®æ–‡ä»¶ä¸­ protocol é…ç½®å¯ä»¥ç”¨ä¾†æŒ‡å®šä½¿ç”¨å“ªä¸ªåè®®ï¼Œlegacyã€inspectorã€autoï¼Œé»˜è®¤æ˜¯ autoã€‚å¯¹äº Launch æ–¹å¼åŠ è¼‰å¹¶ä¸”æ²’æœ‰åœ¨é…ç½®é¡¹ runtimeExecutable æŒ‡å®š node.exe è·¯å¾„çš„ï¼ŒVS Code ä¼šæ ¹æ®ç¯å¢ƒå˜é‡ä¸­æŒ‡å®šçš„ [Node.js] ç‰ˆæœ¬ï¼Œå³ node --version ç»™å‡ºçš„ç‰ˆæœ¬ä¿¡æ¯æ¥é€‰æ‹©åè®®ï¼Œ[Node.js] 8.0 åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨æ–°åè®®ã€‚

    node --debug[=port] <file>     å¼€å¯è¿œè¿›ç¨‹è°ƒè¯•å¹¶ç»‘å®šç«¯å£ï¼Œé»˜è®¤ç«¯å£ 5858 (legacy)
    node --debug-brk[=port] <file> å¼€å¯è¿œè¿›ç¨‹è°ƒè¯•å¹¶ç»‘å®šç«¯å£ï¼Œå¯æ‰‹åŠ¨åœ¨ä»£ç æ’å…¥æ–­ç‚¹ debugger; (legacy)
    node debug <file>              å¼€å¯äº¤äº’è°ƒè¯•å‘½ä»¤è¡Œï¼Œå¯æ‰‹åŠ¨åœ¨ä»£ç æ’å…¥æ–­ç‚¹ debugger; (legacy)
    node debug <URI>               ä½œä¸ºè°ƒè¯•å®¢æˆ·ç«¯è¿æ¥åˆ° URI æŒ‡å®šçš„è¿›ç¨‹ï¼Œå¦‚ node debug localhost:5858 (legacy)
    node debug -p <pid>            ä½œä¸ºè°ƒè¯•å®¢æˆ·ç«¯è¿æ¥åˆ° PID æŒ‡å®šçš„è¿›ç¨‹ (legacy)

    node --inspect-brk[=[host:]port] å¼€å¯ inspector è¿œç¨‹è°ƒè¯•å¹¶åœ¨æ‰§è¡Œå‰ä¸­æ–­ç”¨æˆ·è„šæœ¬ï¼Œå¯æŒ‡å®šæœåŠ¡å™¨åœ°å€åŠç«¯å£
    node --inspect-port=[host:]port  æŒ‡å®š inspector æœåŠ¡å™¨åœ°å€åŠç«¯å£
    node --inspect[=[host:]port]     åœ¨æŒ‡å®šæœåŠ¡å™¨åœ°å€åŠç«¯å£å¼€å¯ inspector
    node inspect <file>              å¼€å¯äº¤äº’è°ƒè¯•å‘½ä»¤è¡Œ

å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„ Node å°±ä¸å¿…å®‰è£… node-inspectorï¼Œè¿™ä¸ªå·¥å…·æ˜¯ä¸»è¦åšåè®®è½¬æ¢ï¼Œå°† Chromium ä½¿ç”¨çš„ Inspector Protocol åè®®è½¬æ¢åˆ°æ—§ç‰ˆæœ¬ Node ä½¿ç”¨çš„ V8 Debugger Protocolï¼Œç”±äºè¿™ä¸ªæ—§åè®®å·²ç»ä¸å†æ›´æ–°äº†ï¼Œ[Node.js] 8.x å¼€å§‹ä¸å†æä¾›æ”¯æŒï¼Œæ‰€ä»¥ä¸å¿…å†ä½¿ç”¨è¿™å®ƒäº†ã€‚å¦å¤– [Node Inspect] è¿™ä¸ªæ˜¯å‘½ä»¤è¡Œè°ƒè¯•å®¢æˆ·ç«¯å·¥å…·ï¼Œå·²ç»åœ¨æ–°ç‰ˆæœ¬ Node ä¸­é›†æˆï¼Œä½¿ç”¨ `node inspect` è¿™ä¸ªå‘½ä»¤è¿›å…¥äº¤äº’è°ƒè¯•å‘½ä»¤è¡Œã€‚

åœ¨å‘½ä»¤è¡Œæ‰“å¼€ [Node Inspector] è°ƒè¯•å™¨ï¼Œå¯ä»¥æŒ‡å®šè¢«è°ƒè¯•çš„è„šæœ¬æ–‡ä»¶ï¼Œå‘½ä»¤è¡Œä¼šæ˜¾ç¤ºç»‘å®šçš„æœåŠ¡åœ°å€ï¼Œé»˜è®¤ä¸º `127.0.0.1:9229`ã€‚ç„¶åæ‰“å¼€ Chrome çš„ä¾¦æµ‹å™¨é¢æ¿ `chrome://inspect/#devices`ï¼Œé¦–æ¬¡ä½¿ç”¨éœ€è¦è¿›è¡Œé…ç½®ï¼Œç‚¹å‡»ç‡ `Configure...` æŒ‰é’®ï¼Œå°†è°ƒè¯•å™¨æŒ‡å®šçš„æœåŠ¡åœ°å€å½•å…¥åˆ° Target discovery ç›®æ ‡æ¢æµ‹åˆ—è¡¨ä¸Šï¼Œç¡®è®¤è¿”å›åˆ·æ–°ç­‰å¾…åˆ·æ–°è¿œç¨‹ç›®æ ‡åˆ—è¡¨ Remote Targetï¼Œè¿™ä¸ªåˆ—è¡¨ä¼šå°†ç›®æ ‡æŒ‰åœ°å€åˆ†ç±»ï¼Œç‚¹å‡»åŒ¹é…æ¡ç›®ä¸­çš„ `inspect` è¿›å…¥ Chrome DevTools ç•Œé¢å¼€å§‹è°ƒè¯•ã€‚DevTools ä¹Ÿå¯ä»¥ç”¨æ¥ä¿®æ”¹ä»£ç ï¼Œç‚¹å‡» DevTools é¢æ¿çš„ `Sources` => `Filesystem` => `Add folder to workspace` å°†å·¥ç¨‹ç›®å½•åŒ…å«è¿›æ¥å¹¶æˆäºè¯»å†™æƒé™å³å¯ä»¥å®ç°è¾¹è°ƒè¯•è¾¹ä¿®æ”¹ä»£ç ã€‚

VS Code è°ƒç”¨ [Node.js] è°ƒè¯•å™¨çš„æ–¹æ³•æœ‰å‡ ç§ï¼Œç›´æ¥æ‰§è¡Œçš„ `Launch Program`ï¼Œ`Launch via npm`ã€`Attach`ã€`Attach to Remote Program` ç­‰æ–¹å¼ã€‚

æ¯”ç›´æ¥æ‰§è¡Œæ–¹å¼å¤æ‚ç‚¹çš„æ˜¯ `Launch via npm`ï¼Œè¿™ç§æ–¹å¼ç»“åˆäº† [Node.js] æ¨¡å—ç®¡ç†å·¥å…· NPM æ¥è¿è¡Œè°ƒè¯•ã€‚ä½¿ç”¨ [Node.js] å¼€å‘é¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ° NPM æ¥ä¸‹è½½å®‰è£…é¡¹ç›®ä¸­çš„ä¾èµ–æ¨¡å—ã€‚é¡¹ç›®æ ¹ç›®å½•ä¸‹ä¼šæœ‰ä¸ªé…ç½®æ–‡ä»¶ `package.json` è®°å½•é¡¹ç›®ä¿¡æ¯ï¼Œå®ƒåŒ…å«äº†ä¾èµ–æ¨¡å— dependenciesã€é¡¹ç›®è„šæœ¬é…ç½® scripts ç­‰ç­‰ã€‚é‚£äº›åœ¨å¼€å‘é˜¶æ®µæ‰è¢«ç”¨åˆ°çš„æ¨¡å—åˆ™å±äºå¼€å‘ä¾èµ–æ¨¡å— devDependenciesï¼Œæ¯”å¦‚ uglifyjs è¿™ä¸ªæ¨¡å—åªæ˜¯åœ¨å‘å¸ƒå‰æ‰“åŒ…æ—¶ï¼Œç”¨æ¥æ··æ·†åŠ å¯†è„šæœ¬å¢åŠ é€†å‘å·¥ç¨‹éš¾åº¦çš„ï¼Œåœ¨é¡¹ç›®å‘å¸ƒåè¿™äº›æ¨¡å—å°±æ²¡æœ‰ä½œç”¨äº†ã€‚

    {
        "name": "vue-demo",
        "version": "1.0.0",
        "description": "A Vue.js project",
        "author": "jimboyeah <jimboyeah@gmail.com>",
        "private": true,
        "scripts": {
            "debug": "node --nolazy --inspect-brk=9229 demo.js",
            "start": "npm run dev",
            "build": "node build/build.js"
        },
        "dependencies": {
            "vue": "^2.5.2",
            "vue-router": "^3.0.1"
        },
        "devDependencies": {
            "uglifyjs-webpack-plugin": "^1.1.1",
            "vue-loader": "^13.3.0",
            "vue-style-loader": "^3.0.1",
            "vue-template-compiler": "^2.5.2",
            "webpack": "^3.6.0",
        }
    }

VS Code ä¸­çš„ `Launch via npm` è°ƒè¯•é…ç½®å°±æ˜¯é€šè¿‡ runtimeExecutable å’Œ runtimeArgs è¿™ä¸¤ä¸ªå‚æ•°å®ç°å¯¹é…ç½®æ–‡ä»¶ä¸­çš„ debug è„šæœ¬çš„è°ƒç”¨ï¼Œå¦‚æœéœ€è¦è¿è¡Œå…¶å®ƒè„šæœ¬æ¡ç›®ï¼Œåªéœ€è¦ä¿®æ”¹ runtimeArgsï¼Œç«¯å£è®¾ç½® port ä¹Ÿè¦æ ¹æ®é¡¹ç›®æä¾›çš„è°ƒè¯•å™¨ç»‘å®šçš„ç«¯å£è®¾ç½®ï¼Œæ‰§è¡Œè°ƒè¯•æ—¶ï¼Œç›¸åº”çš„è„šæœ¬å‘½ä»¤è¢«æ‰§è¡Œï¼Œ[Node.js] çš„ Inspector è°ƒè¯•å™¨å¼€å§‹æä¾›è°ƒè¯•æœåŠ¡ã€‚

    {
        "type": "node",
        "request": "launch",
        "name": "Launch via NPM",
        "runtimeExecutable": "npm",
        "runtimeArgs": [ "run-script", "debug"],
        "port": 9229
    }

è¿™ä¸ªé…ç½®åœ¨æ‰§è¡Œæ—¶çš„ç­‰æ•ˆå‘½ä»¤å°±æ˜¯:

    npm run-script debug

`Attach` æˆ– `Attach by Process ID` æ–¹å¼é€šè¿‡è¿æ¥æœ¬åœ° [Node.js] Inspector è°ƒè¯•æœåŠ¡å™¨è¿›è¡Œè°ƒè¯•ï¼Œéœ€è¦å…ˆæ‰§è¡Œ [Node.js] è°ƒè¯•å™¨ï¼Œå‚è€ƒå‰é¢ä»‹ç»çš„ä½¿ç”¨æ–¹æ³•è®¾ç½®å¥½è°ƒè¯•æœåŠ¡å™¨ç«¯å£ã€‚VS Code ä¸å‘½ä»¤è¡Œç»ˆç«¯ç»“åˆè¶Šæ¥è¶Šå¥½ï¼Œç›´æ¥åœ¨ VS Code å°±å¯ä»¥å®Œæˆå„ç§å‘½ä»¤çš„æ‰§è¡Œï¼Œæ‰€ä»¥ä¸å¿…å¦å¼€å‘½ä»¤è¡Œå»è°ƒç”¨ [Node.js] è°ƒè¯•æœåŠ¡å™¨ã€‚å¦‚æœéœ€è¦è¿›è¡Œè¿œè¿›ç¨‹è°ƒè¯•ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†è°ƒè¯•æœåŠ¡å™¨ç»‘å®šæŒ‡å®šç«¯å£ï¼Œå¹¶ä¸”åœ¨ VS Code ä¸­ä½¿ç”¨`Attach to Remote Program` æ–¹å¼è¿›è¡Œè°ƒè¯•ï¼Œæ³¨æ„é…ç½®å¥½åœ°å€å’Œç«¯å£ï¼š

    node --debug-brk[=port] <file> - å¼€å¯è°ƒè¯•å¹¶ç»‘å®šç«¯å£ï¼Œå¯æ‰‹åŠ¨åœ¨ä»£ç æ’å…¥æ–­ç‚¹ debugger; (legacy)
    node debug <file>              - å¼€å¯äº¤äº’è°ƒè¯•å‘½ä»¤è¡Œï¼Œå¯æ‰‹åŠ¨åœ¨ä»£ç æ’å…¥æ–­ç‚¹ debugger; (legacy)

åœ¨ VS Code é…ç½® `Attach` çš„å†…å®¹è¾ƒå°‘ï¼Œrequest è®¾ç½®ä¸º æ³¨æ„ç«¯å£é…ç½®å·ä¿æŒä¸€è‡´å°±å¯ä»¥äº†ï¼Œè¿œç¨‹è°ƒè¯•é™¤äº† IP åœ°å€å’Œç«¯å£å¤–ï¼Œè¿˜éœ€è¦è®¾ç½®æœ¬åœ°ç›®å½• localRoot å’Œè¿œç¨‹ç›®å½• remoteRootï¼Œä¸¤è€…çš„ä»£ç æ–‡ä»¶æ˜¯æ˜ å°„å…³ç³»ï¼Œè°ƒè¯•æ—¶ VS Code ç”¨ä¾†å®šä½å¯¹åº”çš„ä»£ç æ–‡ä»¶ã€‚æ³¨æ„ï¼Œ[Node.js] 8.x å¼€å§‹å·²ç»ä¸æ”¯æŒæ—§çš„ V8 Debugger Protocol åè®®ï¼Œè€Œ VS Code ä¸­çš„ `Attach to Remote` éœ€è¦è¿™ä¸ªæ—§çš„åè®®ï¼Œå¦‚æœæç¤º legacy æ—¶ï¼Œè¯´æ˜å½“å‰è¿è¡Œçš„ [Node.js] ç‰ˆæœ¬å¤ªæ–°äº†ï¼Œè¯·ä½¿ç”¨ [Node.js] 8.x ä»¥ä¸‹ç‰ˆæœ¬ã€‚æ³¨æ„ `Attach by Process ID` æŒ‡å®šçš„è¿›ç¨‹ ID çš„æ–¹å¼ï¼Œ`${command.PickProcess}` è¿™ä¸ªç‚¹ä½ç¬¦å·ä¼šè‡ªåŠ¨æ›¿æ¢æˆç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œè°ƒè¯•æœåŠ¡çš„ [Node.js] è¿›ç¨‹çš„ PIDã€‚

    {
        "type": "node",
        "request": "attach",
        "name": "Attach",
        // "protocol": "inspector",
        "port": 5858
    }, {
        "type": "node",
        "request": "attach",
        "name": "Attach by Process ID",
        "processId": "${command.PickProcess}"
    }, {
        "type": "node",
        "request": "attach",
        "name": "Attach to Remote - Node",
        // "address": "localhost",
        "port": 5858,
        "localRoot": "${workspaceFolder}",
        "remoteRoot": "/absolute/path/to/remote/directory"
    }


# ğŸš© Errors é”™è¯¯å¤„ç†
- https://nodejs.org/docs/latest-v14.x/api/domain.html
- https://nodejs.org/docs/latest-v14.x/api/errors.html
- Domain Module Postmortem https://nodejs.org/en/docs/guides/domain-postmortem/

åœ¨ Node.js ç¯å¢ƒè¿è¡Œçš„ç¨‹åºä¼šäº§ç”Ÿå››ç§é”™è¯¯å¯¹è±¡ï¼š

- Standard JavaScript errors: `EvalError`, `SyntaxError`, `RangeError`, `ReferenceError`, `TypeError`, `URIError`.
- System errors.
- User-specified errors triggered by application code.
- `AssertionErrors` é€šå¸¸ç”± assert æ¨¡å—æ£€æµ‹åˆ°é€»è¾‘é”™è¯¯æ—¶è§¦å‘ã€‚

æ‰€æœ‰ JavaScript åŠ system errors ç”± Node.js ç»§æ‰¿æ ‡å‡†çš„ JavaScript `Error` äº§ç”Ÿï¼Œå¹¶ä¿è¯è‡³å°‘æä¾›è¯¥åŸºç±»ä¸Šå¯ç”¨çš„å±æ€§ã€‚

é”™è¯¯å¤„ç†å‡½æ•°çº¦å®š error-first å›è°ƒæ ¼å¼ï¼Œå›è°ƒå‡½æ•°æœ‰ä¸¤æ¡å®šä¹‰è§„åˆ™ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°ä¿ç•™ç»™ä¸€ä¸ªé”™è¯¯ error å¯¹è±¡ï¼Œå¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œé”™è¯¯å°†é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•° err è¿”å›ã€‚
- ç¬¬äºŒä¸ªå‚æ•°ä¸ºæˆåŠŸå“åº”çš„æ•°æ®ä¿ç•™ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œerr å°†è¢«è®¾ç½®ä¸º null, æˆåŠŸçš„æ•°æ®å°†ä»ç¬¬äºŒä¸ªå‚æ•°è¿”å›ã€‚

é”™è¯¯ä¼ é€’æŒ‰ tryâ€¦catch è¯­å¥å—è¿›è¡Œï¼Œå†åˆ°å¯¹è±¡çš„ on('error') äº‹ä»¶ï¼Œç›´åˆ° process.on('uncaughtException') äº‹ä»¶ã€‚

    process.on('uncaughtException', function(err){}) // ç›‘å¬æœªæ•è·çš„å¼‚å¸¸
    process.on('unhandledRejection', function(err, promise){}) // ç›‘å¬ Promise æ²¡æœ‰è¢«æ•è·çš„å¤±è´¥å‡½æ•°

Domain æ¨¡å—ä¸åŸŸåæ— å…³ï¼Œå®ƒåªæ˜¯ç”¨æ¥ç®€åŒ–å¼‚æ­¥ä»£ç çš„å¼‚å¸¸å¤„ç†ï¼Œå¯ä»¥æ•æ‰å¤„ç† try catch æ— æ³•æ•æ‰çš„å¼‚å¸¸ï¼Œæ–°ç‰ˆæœ¬ä¸­æ˜¯è¿‡æ—¶ APIã€‚

domain æ¨¡å—æŠŠå¤„ç†å¤šä¸ªä¸åŒçš„ I/O çš„æ“ä½œç¼–ä¸ºä¸€ä¸ªç»„ï¼Œæ³¨å†Œäº‹ä»¶å’Œå›è°ƒåˆ° domainï¼Œå½“å‘ç”Ÿä¸€ä¸ªé”™è¯¯äº‹ä»¶æˆ–æŠ›å‡ºä¸€ä¸ªé”™è¯¯æ—¶ï¼Œdomain å¯¹è±¡ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œä¸ä¼šä¸¢å¤±ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿä¸å¯¼è‡´ç¨‹åºé”™è¯¯ç«‹å³é€€å‡ºï¼Œä¸ process.on('uncaughtException') ä¸åŒã€‚

æœ‰ä¸ªæœ€å¤§çš„é—®é¢˜ï¼Œå®ƒä¸èƒ½æ•è·æ‰€æœ‰çš„å¼‚æ­¥å¼‚å¸¸ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ç”¨äº† domainï¼Œç¨‹åºä¾ç„¶æœ‰å› ä¸º uncaughtException crash çš„å¯èƒ½ã€‚

Domain æ¨¡å—å¯åˆ†ä¸ºéšå¼ç»‘å®šå’Œæ˜¾å¼ç»‘å®šï¼š

- éšå¼ç»‘å®š: ç»‘å®š domain ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„å˜é‡ï¼›
- æ˜¾å¼ç»‘å®š: æ˜¾å¼ç»‘å®šä¸åœ¨ domain ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„å˜é‡ï¼›

```
var eventEmitter = require("events").EventEmitter;
var domain = require("domain");
var eeA = new eventEmitter();

var domain1 = domain.create();
domain1.on("error", function(err){
  console.log("domain1ï¼š"+err.message);
})

// æ˜¾å¼ç»‘å®š
domain1.add(eeA);
eeA.on("error", function(err){
  console.log("eeAï¼š"+err.message);
})
eeA.emit("error", new Error("ç”± eeA å¤„ç†çš„é”™è¯¯"));
eeA.removeAllListeners("error");
eeA.emit("error", new Error("ç”± domain1 å¤„ç†çš„é”™è¯¯"));

var domain2 = domain.create();
domain2.on("error", function(err){
  console.log("domain2ï¼š"+err.message);
})

//éšå¼ç»‘å®š
domain2.run(function(){
  var eeB = new eventEmitter();
  eeB.emit("error", new Error("ç”± domain2 å¤„ç†çš„é”™è¯¯"));
})

domain1.remove(eeA);
eeA.emit("error", new Error("System Crash!"));
```

Node å¼‚å¸¸çš„é»˜è®¤å¤„ç†çš„é¡ºåºæ˜¯å…ˆè§¦å‘ uncaughtException äº‹ä»¶ï¼Œè‹¥äº‹ä»¶æ²¡æœ‰è¢«ç›‘å¬ï¼Œåˆ™æ‰“å°å †æ ˆçš„é”™è¯¯ä¿¡æ¯ï¼Œæœ€åè°ƒç”¨è¿›ç¨‹çš„é€€å‡ºäº‹ä»¶ã€‚

process uncaughtException äº‹ä»¶å‘ç”Ÿçš„æ¡ä»¶ï¼š

- å½“ç¨‹åºå‘ç”Ÿäº†å¼‚å¸¸
- ä¸”å¼‚å¸¸æœªè¢« try...catch æ•è·

ç¼ºç‚¹ä¸é—®é¢˜

- æ— æ³•è·å–å¼‚å¸¸çš„ä¸Šä¸‹æ–‡ã€‚
- æ— æ³•ç»™å‡ºå‹å¥½çš„å¼‚å¸¸å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå½“æ¥å£å‘ç”Ÿ uncaughtException æ—¶ï¼Œæ— æ³•è·å–åˆ°ä¸Šä¸‹æ–‡ä¸­çš„ response å¯¹è±¡å‘ŠçŸ¥è°ƒç”¨æ–¹ã€‚
- ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚uncaughtException äº‹ä»¶å‘ç”Ÿåï¼Œä¼šä¸¢å¤±å½“å‰ç¯å¢ƒçš„å †æ ˆï¼Œå¯èƒ½å¯¼è‡´ Node ä¸èƒ½æ­£å¸¸è¿›è¡Œå†…å­˜å›æ”¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚


```
process.on('uncaughtException', (error) => {
  console.log('call uncaughtException handle');
});

// æ‰§è¡Œä¸€ä¸ªä¸å­˜åœ¨çš„å¼‚å¸¸
nonexistentFunc();
```

å¯ä»¥ä½¿ç”¨ Cluster æ¨¡å—ï¼Œå¼€å¯å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚å½“é‡åˆ°æ— æ³•æ•è·çš„å¼‚å¸¸ï¼Œæˆ–åœ¨ uncaughtException æ•è·åˆ°æ—¶ï¼Œä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œå¯ä»¥ç»“æŸå½“å‰è¿›ç¨‹ã€‚


ä¸€èˆ¬é”™è¯¯ä¿¡æ¯ï¼š

- `EACCES` æ²¡æœ‰æƒé™ï¼šè¯•å›¾åœ¨ä¸€ä¸ªæ–‡ä»¶æƒé™ä¸å…è®¸çš„æ–‡ä»¶å¤¹ä¸­è®¿é—®ä¸€ä¸ªæ–‡ä»¶ã€‚
- `EADDRINUSE` åœ°å€å·²è¢«ä½¿ç”¨ï¼šè¯•å›¾å°†ä¸€ä¸ªæœåŠ¡å™¨ç»‘å®šä¸€ä¸ªå·²ç”±å…¶å®ƒæœåŠ¡å ç”¨çš„æœ¬åœ°åœ°å€ã€‚
- `ECONNREFUSED` è¿æ¥è¢«æ‹’ç»ï¼šç›®æ ‡æœºå™¨ç§¯ææ‹’ç»å¯¼è‡´çš„æ— æ³•è¿æ¥ï¼Œè¿™é€šå¸¸æ˜¯è¯•å›¾è¿æ¥åˆ°éæ´»åŠ¨ä¸»æœºçš„ç»“æœã€‚
- `ECONNRESET` è¿æ¥è¢«å¯¹æ–¹é‡ç½®ï¼šä¸€ä¸ªè¿æ¥è¢«å¯¹æ–¹å¼ºè¡Œå…³é—­ã€‚è¿™é€šå¸¸æ˜¯å› è¶…æ—¶æˆ–è‡ªåŠ¨é‡å¯å¯¼è‡´çš„è¿œç¨‹å¥—æ¥å­—ï¼ˆsocketï¼‰ä¸¢å¤±çš„ç»“æœã€‚
- `EEXIST` æ–‡ä»¶å·²å­˜åœ¨ï¼šä¸€ä¸ªè¦æ±‚ç›®æ ‡ä¸å­˜åœ¨çš„æ–‡ä»¶æ“ä½œçš„ç›®æ ‡æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶ã€‚
- `EISDIR` æ˜¯ä¸€ä¸ªç›®å½•ï¼šä¸€ä¸ªå¯¹æ–‡ä»¶çš„æ“ä½œï¼Œä½†ç»™å®šçš„è·¯å¾„æ˜¯ä¸€ä¸ªç›®å½•ã€‚
- `EMFILE` åœ¨ç³»ç»Ÿä¸­æ‰“å¼€äº†è¿‡å¤šçš„æ–‡ä»¶ï¼šæ‰“å¼€å¤šä¸ªæ–‡ä»¶æ—¶å·²è¾¾åˆ°ç³»ç»Ÿä¸­æ–‡ä»¶æè¿°ç¬¦å…è®¸çš„æœ€å¤§æ•°é‡ï¼Œè®¾ç½®æ•°é‡é™åˆ¶ï¼Œæ‰§è¡ŒåŒä¸€è¿›ç¨‹ shell å‘½ä»¤ ulimit -n 2048ã€‚
- `ENOENT` æ— æ­¤æ–‡ä»¶æˆ–ç›®å½•ï¼šé€šå¸¸æ˜¯ç”±æ–‡ä»¶æ“ä½œå¼•èµ·çš„ï¼Œè¿™è¡¨æ˜æŒ‡å®šçš„è·¯å¾„ç»„åˆä¸å­˜åœ¨â€”â€”åœ¨ç»™å®šçš„è·¯å¾„ä¸Šæ— æ³•æ‰¾åˆ°ä»»ä½•å®ä½“ï¼ˆæ–‡ä»¶æˆ–ç›®å½•ï¼‰ã€‚
- `ENOTDIR` ä¸æ˜¯ä¸€ä¸ªç›®å½•ï¼šç»™å®šçš„è·¯å¾„ç»„åˆå­˜åœ¨ï¼Œä½†ä¸æ˜¯æ‰€æœŸæœ›çš„ç›®å½•ã€‚é€šå¸¸æ˜¯ç”± fs.readdir å¼•èµ·çš„ã€‚
- `ENOTEMPTY` ç›®å½•éç©ºï¼šä¸€ä¸ªéœ€è¦ç©ºç›®å½•æ“ä½œçš„ç›®æ ‡ç›®å½•æ˜¯ä¸€ä¸ªå®ä½“ã€‚é€šå¸¸æ˜¯ç”± fs.unlink å¼•èµ·çš„ã€‚
- `EPERM` æ“ä½œä¸è¢«å…è®¸ï¼šè¯•å›¾æ‰§è¡Œéœ€è¦æå‡æƒé™çš„æ“ä½œã€‚
- `EPIPE` ç®¡é“æŸåï¼šæ²¡æœ‰è¿›ç¨‹è¯»å–æ•°æ®æ—¶å†™å…¥ pipeã€socket æˆ– FIFOï¼Œè¡¨æ˜åœ¨è¿œç«¯çš„æµï¼ˆstreamï¼‰å‡†å¤‡å†™å…¥å‰è¢«å…³é—­ã€‚
- `ETIMEDOUT` æ“ä½œè¶…æ—¶ï¼šç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åå¹¶æ²¡æœ‰åšå‡ºåˆé€‚çš„å“åº”å¯¼è‡´çš„è¿æ¥æˆ–å‘é€çš„è¯·æ±‚å¤±è´¥ã€‚


Errors æ¨¡å—éƒ¨åˆ† API 

- Class: Error
    - new Error(message)
    - Error.captureStackTrace(targetObject[, constructorOpt])
    - Error.stackTraceLimit
    - error.code
    - error.message
    - error.stack

- Class: AssertionError

- Class: RangeError

- Class: ReferenceError

- Class: SyntaxError

- Class: SystemError
    - error.address
    - error.code
    - error.dest
    - error.errno
    - error.info
    - error.message
    - error.path
    - error.port
    - error.syscall

- Class: TypeError
    - error.opensslErrorStack
    - error.function
    - error.library
    - error.reason


# ğŸš© Addons æ’ä»¶å¼€å‘
- https://github.com/nodejs/node
- https://nodejs.org/api/n-api.html
- https://nodejs.org/docs/latest-v12.x/api/embedding.html
- https://v8.dev/docs/embed
- https://v8docs.nodesource.com
- https://github.com/nodejs/nan
- https://github.com/nodejs/node-addon-api#api-documentation
- https://github.com/nodejs/node-gyp
- https://www.npmjs.com/package/node-gyp
- Node.js C/C++æ’ä»¶ https://itbilu.com/nodejs/core/4y4-Nrd5G.html
- Node.js Addon Examples https://github.com/nodejs/node-addon-examples
- Node.js Sqlite3 Addon https://github.com/mapbox/node-sqlite3
- NAN - Native Abstractions for Node.js https://nodei.co/npm/nan/
- node-gyp - Node.js native addon build tool https://www.npmjs.com/package/node-gyp
- [Node Add-on Documentation](https://nodejs.org/api/addons.html)
- Node Add-on Documentation [CN] http://nodejs.cn/api/addons.html
- Node Addion Example https://github.com/nodejs/node-addon-examples

Node.js æ˜¯è·¨å¹³å°å¼€æºè½¯ä»¶ï¼ŒåŸºäº Google v8 JavaScript å¼•æ“åŠ¨åŠ›ï¼Œå°†è„šæœ¬ä»£ç è„±ç¦»æµè§ˆå™¨ç¯å¢ƒè¿è¡Œï¼Œä½¿ç”¨ NPM æ¨¡å—ä¾èµ–ç®¡ç†å¤§å¤§æ–¹ä¾¿äº†å¼€å‘ï¼Œä½¿å¾— Node.js å¹¿æ³›æµè¡Œäºå‰åç«¯åº”ç”¨å¼€å‘ã€‚

Node.js ä½¿ç”¨å¼€æ”¾æ¨¡å—ç®¡ç†ï¼Œç”± OpenJS Foundation é¡¹ç›®æä¾›æ”¯æŒã€‚

å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡ C++ Addons å¯¹å…¶ç¼ºå¤±çš„åŠŸèƒ½è¿›è¡Œæ‰©å±•å¼€å‘ï¼ŒNode.js æä¾›ä¸‰ç§æ’ä»¶æ¨¡å—å¼€å‘æ–¹å¼ï¼š

- NAN - Native Abstractions for Node.js æ˜¯ä¸€å¥—æ–¹ä¾¿ç”¨äºå¼€å‘æ’ä»¶çš„å·¥å…·ï¼ŒåŒ…å«ä¸€å¥— APIï¼Œå’Œç›¸å…³çš„å¤´æ–‡ä»¶ï¼Œå®å®šä¹‰ç­‰ç­‰ã€‚
- N-API - ç”¨äºåŸç”Ÿæ’ä»¶å¼€å‘ï¼Œä¸ v8 JavaScript å¼•æ“è¿è¡Œæ—¶æ— å…³ï¼Œæä¾›æœ€å¥½çš„å…¼å®¹æ€§ï¼ŒAPI åœ¨å¤šä¸ªç‰ˆæœ¬ä¸­é€šè¿‡ã€‚
- C++ API - ç›´æ¥ä½¿ç”¨å†…éƒ¨çš„ V8, libuv å„ Node.js åº“æ–‡ä»¶å®ç°ï¼Œè¿™æ˜¯ç›¸å¯¹éš¾çš„æ–¹å¼ï¼Œéœ€è¦ç†è§£å¤šä¸ª C++ æ¨¡å—ï¼Œå¯ä»¥è®¿é—®æœªåœ¨ N-API æš´éœ²çš„åŠŸèƒ½ã€‚


åº”ç”¨äºŒè¿›åˆ¶æ¥å£ ABI - Application Binary Interface çš„å­˜åœ¨ï¼Œæ—¨åœ¨å°†æ’ä»¶ä¸åº•å±‚ JavaScript å¼•æ“éš”ç¦»å¼€æ¥ï¼Œå¹¶å…è®¸ä¸ºä¸€ä¸ª Node.js ä¸»ç‰ˆæœ¬å·ç¼–è¯‘çš„å—æä¾›å…¼å®¹è¿è¡Œç¯å¢ƒï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘æ’ä»¶ã€‚

æ’ä»¶ Addons æ˜¯ä¸€å¥— C++ å®ç°çš„åŠ¨æ€é“¾æ¥åº“ï¼Œå¯ä»¥é€šè¿‡ `require()` å‡½æ•°å°†æ’ä»¶å½“ä½œä¸€èˆ¬çš„ Node.js è„šæœ¬æ¨¡å—ä¸€æ ·åŠ è½½ã€‚æ’ä»¶æœºåˆ¶æä¾›äº†ä¸€å¥— JavaScript ä¸ C/C++ åº“äº¤äº’çš„ç¨‹åºæ¥å£ã€‚

å¦‚æœä¸ä½¿ç”¨ N-API å¼€å‘æ’ä»¶ï¼Œé‚£å°±éœ€è¦ç†Ÿæ‚‰å„ä¸ªåŸºç¡€ç±»åº“ï¼š

- V8: Google æä¾›çš„ C++ libraryï¼ŒNode.js ç”¨æ¥æä¾› JavaScript è¿è¡Œç¯å¢ƒï¼ŒV8 æä¾›äº†åˆ›å»ºå¯¹è±¡çš„æœºåˆ¶ã€å‡½æ•°è°ƒç”¨ç­‰ç­‰ã€‚åœ¨ Node.js æºä»£ç ä¸­å¯ä»¥æ‰¾åˆ° v8.h å¤´æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†å¤§å¤šæ•°å®šä¹‰ã€‚

- libuv: é‡‡ç”¨ C è¯­è¨€å®ç°çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº“ï¼Œç”¨æ¥å®ç° Node.js event loopã€‚ä½œä¸ºä¸€ä¸ªè·¨å¹³å°çš„æŠ½è±¡åº“ï¼Œå…è®¸è·¨æ‰€æœ‰ä¸»è¦æ“ä½œç³»ç»Ÿè½»æ¾åœ°è®¿é—®å¸¸è§çš„ POSIX ç³»ç»Ÿä»»åŠ¡ï¼Œå¦‚ä¸æ–‡ä»¶ç³»ç»Ÿã€å¥—æ¥å­—ã€è®¡æ—¶å™¨å’Œç³»ç»Ÿäº‹ä»¶è¿›è¡Œäº¤äº’ã€‚è¿˜ä¸ºéœ€è¦è¶…è¶Šæ ‡å‡†äº‹ä»¶å¾ªç¯çš„æ›´å¤æ‚çš„å¼‚æ­¥æ’ä»¶æä¾›äº†ç±»ä¼¼äº POSIX çº¿ç¨‹çš„çº¿ç¨‹æŠ½è±¡ã€‚æ’ä»¶ä½œè€…åº”è¯¥é¿å…ä½¿ç”¨ I/O æˆ–å…¶ä»–æ—¶é—´å¯†é›†å‹ä»»åŠ¡é˜»å¡äº‹ä»¶å¾ªç¯ï¼Œåº”è¯¥é€šè¿‡ libuv å°†å·¥ä½œå¸è½½åˆ°éé˜»å¡ç³»ç»Ÿæ“ä½œã€å·¥ä½œçº¿ç¨‹æˆ–è‡ªå®šä¹‰ä½¿ç”¨ libuv çº¿ç¨‹ã€‚

- å†…éƒ¨åº“ï¼ŒNode.js å¯¼å‡ºçš„ C++ APIs ä¾›æ’ä»¶ä½¿ç”¨ï¼Œå…¶ä¸­æœ€ç´§è¦çš„ç±»å¯¹è±¡æ˜¯ node::ObjectWrapã€‚

- Node.js è¿˜åŒ…å«å…¶å®ƒé™æ€é“¾æ¥åº“ï¼Œå¦‚ OpenSSLï¼Œå¯ä»¥åœ¨ `deps/` ç›®å½•æ‰¾åˆ°ã€‚åªæœ‰ libuv, OpenSSL, V8 å’Œ zlib ç¬¦å·æ‰å¯¼å‡ºä¾›æ’ä»¶ä½¿ç”¨ã€‚


ä½¿ç”¨ N-API å¼€å‘æ’ä»¶ä¸ä½¿ç”¨ C++ Addons ç›¸åŒçš„å¼€å‘æ‰“åŒ…æµç¨‹ï¼Œä½¿ç”¨ç›¸åŒçš„å·¥å…·ï¼Œå·®åˆ«æ˜¯ä½¿ç”¨ N-API å‡½æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ V8 æˆ–è€… NAN APIã€‚

N-API æš´éœ²çš„å‡½æ•°ä¸€èˆ¬ç”¨äºåˆ›å»ºå’Œç®¡ç† JavaScript å¯¹è±¡ï¼Œæ¦‚å¿µé€šå¸¸ä¸ ECMA-262 è¯­è¨€è§„èŒƒä¿æŒä¸€è‡´ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- æ‰€æœ‰ N-API è°ƒç”¨è¿”å›çŠ¶æ€ç  napi_status æŒ‡æ˜è°ƒç”¨æ˜¯å¦æˆåŠŸï¼Œé¢å¤–ä¿¡æ¯é€šè¿‡ `napi_get_last_error_info` è·å–ï¼›
- API è¿”å›å€¼é€šè¿‡ä¸€ä¸ª out parameter ä¼ é€’ï¼›
- æ‰€æœ‰ JavaScript å€¼æŠ½è±¡ä¸º napi_valueï¼›

N-API æ˜¯ä¸€å¥— C APIï¼Œå®ƒç¡®ä¿ ABI æ¥å£åœ¨å„ä¸ª Node.js ç‰ˆæœ¬ä¸­ä¸åŒçš„ç¼–è¯‘çº§åˆ«çš„ç¨³å®šï¼ŒC++ API å¾ˆå®¹æ˜“ä½¿ç”¨è¿™å¥—å‡½æ•°ã€‚ä¸ºäº†æ”¯æŒ C++ï¼Œé¡¹ç›®æä¾›äº† C++ åŒ…è£…æ¨¡å— `node-addon-api`ï¼Œæä¾›å¯é“¾æ¥çš„ C++ APIã€‚åŸºäºå®ƒå¼€å‘çš„æ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–äº Node.js å¯¼å‡ºçš„ N-APIï¼Œå®ƒæ˜¯æ›´æœ‰æ•ˆç‡çš„æ’ä»¶å¼€å‘æ–¹æ³•ã€‚

å°½ç®¡ N-API æä¾› ABI ç¨³å®šæ€§ä¿è¯ï¼Œä½†æ˜¯å…¶å®ƒçš„éƒ¨åˆ†ï¼Œå¦‚ Node.jsï¼Œä¾›æ’ä»¶è°ƒç”¨çš„å¤–éƒ¨åº“ä¸ä¼šã€‚

ç‰¹åˆ«æ˜¯ä»¥ä¸‹çš„ API éƒ½ä¸èƒ½åœ¨å„å¤§ç‰ˆæœ¬ä¸­ä¿æŒç¨³å®šï¼š

- Node.js C++ APIs

```cpp
#include <node.h>
#include <node_buffer.h>
#include <node_version.h>
#include <node_object_wrap.h>
```

- libuv APIs

```cpp
#include <uv.h>
```

- V8 API

```cpp
#include <v8.h>
```

å› æ­¤ï¼Œå¯¹äºä¸€ä¸ªæ’ä»¶æ¥è¯´ï¼Œè¦åœ¨ Node.js ä¸»è¦ç‰ˆæœ¬ä¸­ä¿æŒç¨³å®šï¼Œå°±å¿…é¡»é€šè¿‡ N-API é™åˆ¶è‡ªå·±ä½¿ç”¨ä¸ç¨³å®šçš„ APIã€‚

```cpp
#define NAPI_VERSION 6
#include <node_api.h>
```


## Hello Addon

ç¤ºèŒƒ C++ ç¼–å†™ Hello world æ’ä»¶å®ç°ä»¥ä¸‹è„šæœ¬åŠŸèƒ½ï¼š

    module.exports.hello = () => 'world';

é¦–å…ˆåˆ›å»º CPP æºä»£ç ï¼š

```
// hello.cc
#include <node.h>

namespace demo {

using v8::FunctionCallbackInfo;
using v8::Isolate;
using v8::Local;
using v8::Object;
using v8::String;
using v8::Value;

void Method(const FunctionCallbackInfo<Value>& args) {
  Isolate* isolate = args.GetIsolate();
  args.GetReturnValue().Set(String::NewFromUtf8(
      isolate, "world").ToLocalChecked());
}

void Initialize(Local<Object> exports) {
  NODE_SET_METHOD(exports, "hello", Method);
}

NODE_MODULE(NODE_GYP_MODULE_NAME, Initialize)

}  // namespace demo
```

æ‰€æœ‰ Node.js æ’ä»¶å¿…é¡»æŒ‰ä»¥ä¸‹æ ¼å¼å¯¼å‡ºåˆå§‹åŒ–å‡½æ•°ï¼š

    void Initialize(Local<Object> exports);
    NODE_MODULE(NODE_GYP_MODULE_NAME, Initialize)

æ³¨æ„ NODE_MODULE æ²¡æœ‰åˆ†å·ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå‡½æ•°è€Œæ˜¯ä¸€ä¸ªå®å®šä¹‰ã€‚`module_name` æ’ä»¶åé¡»è¦å’Œæœ€ç»ˆç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åŒ¹é…ï¼Œä¸å« `.node` æ‰©å±•åã€‚

æ’ä»¶åŠ è½½æ—¶ï¼Œç”± `node-gyp` è¿›è¡Œç»‘å®šï¼Œä½¿ç”¨ `NODE_GYP_MODULE_NAME` ä½œä¸º `NODE_MODULE()` ç¬¬ä¸€ä¸ªå‚æ•°ä»¥ç¡®ä¿æœ€ç»ˆç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ­£ç¡®ä¼ å…¥ã€‚

æ’ä»¶çš„æ„å»ºæ˜¯é€šè¿‡ `node-gyp` å·¥å…·è¿›è¡Œçš„ï¼ŒNode.js native addon build toolï¼Œè¿™æ˜¯ä¸€ä¸ªè·¨å¹³å°ä¸“ç”¨äºæ’ä»¶çš„æ„å»ºçš„å·¥å…·ï¼Œç”¨å®ƒæ¥æ„å»ºæ’ä»¶èƒ½å¾ˆå¥½è§£å†³æ’ä»¶è·¨å¹³å°é—®é¢˜ã€‚å®ƒç”±æ„å»º Chromium çš„å·¥å…· `gyp-next` å¤åˆ»è€Œæ¥ï¼Œå¹¶ä½œäº†æ‰©å±•ä»¥æ”¯æŒ Node.js åŸç”Ÿæ’ä»¶ï¼ŒGYP å³ Generate Your Projectsã€‚æ ¹æ®ä¸åŒç³»ç»Ÿï¼Œéœ€è¦ä¸ºå®ƒå®‰è£…å¥½ç›¸åº”çš„ç¼–è¯‘å·¥å…·ï¼Œå¦‚ GCC ç¼–è¯‘å™¨ã€Pythond è„šæœ¬è§£æå™¨ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨ node-pre-gyp è¿™ç±»å·¥å…·ï¼Œå®ƒå¯ä»¥ä¸Šä¼ é¢„ç¼–è¯‘å¥½çš„æ’ä»¶æ¨¡å—æ–‡ä»¶ã€‚

    npm install -g node-gyp
    npm install --global --production windows-build-tools
    md my_node_addon && cd my_node_addon
    node-gyp configure
    node-gyp configure --msvs_version=2015
    node-gyp build

node-gyp å‘½ä»¤å‚è€ƒï¼š

- **help**  Shows the help dialog
- **build** Invokes make/msbuild.exe and builds the native addon
- **clean** Removes the build directory if it exists
- **configure** Generates project build files for the current platform
- **rebuild**   Runs clean, configure and build all in a row
- **install**   Installs Node.js header files for the given version
- **list**  Lists the currently installed Node.js header versions
- **remove**    Removes the Node.js header files for the given version

é€‰é¡¹å‚è€ƒï¼š

- **-j n, --jobs n**    Run make in parallel. The value max will use all available CPU cores
- **--target=v6.2.1**   Node.js version to build for (default is process.version)
- **--silly, --loglevel=silly** Log all progress to console
- **--verbose, --loglevel=verbose** Log most progress to console
- **--silent, --loglevel=silent**   Don't log anything to console
- **debug, --debug**    Make Debug build (default is Release)
- **--release, --no-debug** Make Release build
- **-C $dir, --directory=$dir** Run command in different directory
- **--make=$make**  Override make command (e.g. gmake)
- **--thin=yes**    Enable thin static libraries
- **--arch=$arch**  Set target architecture (e.g. ia32)
- **--tarball=$path**   Get headers from a local tarball
- **--devdir=$path**    SDK download directory (default is OS cache directory)
- **--ensure**  Don't reinstall headers if already present
- **--dist-url=$url**   Download header tarball from custom URL
- **--proxy=$url**  Set HTTP(S) proxy for downloading header tarball
- **--noproxy=$urls**   Set urls to ignore proxies when downloading header tarball
- **--cafile=$cafile**  Override default CA chain (to download tarball)
- **--nodedir=$path**   Set the path to the node source code
- **--python=$path**    Set path to the Python binary
- **--msvs_version=$version**   Set Visual Studio version (Windows only)
- **--solution=$solution**  Set Visual Studio Solution version (Windows only)


é…ç½®æ–‡ä»¶ `binding.gyp` æè¿°äº†æ’ä»¶æ¨¡å—ï¼Œé€šå¸¸ä¸ package.json åŒç›®å½•ï¼Œå†…å®¹ç±»ä¼¼å¦‚ä¸‹ï¼š

```on
{
  "targets": [
    {
      "target_name": "binding",
      "sources": [ "src/binding.cc" ]
    }
  ]
}
```

ä½¿ç”¨ `node-gyp` æ„å»ºæˆåŠŸåï¼Œå¯ä»¥é€šè¿‡ Node.js çš„ `require()` å‡½æ•°åƒä¸€èˆ¬è„šæœ¬æ¨¡å—ä¸€æ ·åŠ è½½è¿è¡Œã€‚

å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª hello.jsï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
// hello.js
// Cannot use import statement outside a module
// import addon, {hello} from "../my_node_addon/build/Release/addon";
const addon = require("../my_node_addon/build/Release/addon");

console.log(addon, addon.hello);
addon.hello();
```

ç¼–è¯‘å¾—åˆ°çš„äºŒè¿›åˆ¶æ’ä»¶æ–‡ä»¶æ‰©å±•åæ˜¯ `.node`ï¼Œå¯ä»¥çœ‹ä½œ .dll æˆ– .soã€‚`require()` å‡½æ•°ä¼šå¯»æ‰¾ .node æ‰©å±•åçš„æ’ä»¶æ–‡ä»¶ï¼ŒæŒ‰åŠ¨æ€é“¾æ¥åº“åŠ è½½ã€‚

å½“åŠ è½½ç›®å½•å†…æœ‰ç›¸åŒåŸºç¡€æ–‡ä»¶åæ—¶ï¼Œå¦‚ addon.js å’Œ addon.node å…±å­˜ï¼Œä¼šå‘å‡ºä¸€ä¸ªè­¦å‘Šï¼Œå¹¶ä¸”ä¼˜å…ˆå°è¯•åŠ è½½ addon.js æ–‡ä»¶ã€‚

å¯ä»¥åœ¨ç”Ÿæˆçš„å·¥ç¨‹æ–‡ä»¶ä¸­æŸ¥çœ‹ node-gyp ä½¿ç”¨çš„å¤´æ–‡ä»¶ç‰ˆæœ¬ Node.js 12.13.0ï¼Œå¯ä»¥æ¢ä¸€ç‰ˆæœ¬å†ç¼–è¯‘ï¼š

    node-gyp install --target=v6.2.1
    node-gyp build

å¦‚æœä½¿ç”¨å¤´æ–‡ä»¶ç‰ˆæœ¬å¤§ä½ï¼ŒåŠ è½½æ’ä»¶å‡ºé”™æç¤ºæ­£åœ¨ä½¿ç”¨çš„æ˜¯ä½ç‰ˆæœ¬å· NODE_MODULE_VERSIONï¼Œè€Œå½“å‰éœ€è¦çš„æ˜¯ `#define NAPI_VERSION 6`ï¼ŒNODE_MODULE_VERSION 72ï¼Œå³å¯¹åº”è¿è¡Œçš„ Node.js v12.13.0ï¼š

    node-pre-gyp info This Node instance does not support builds for N-API version 6
    Error: The module '\\?\C:\coding\md-code\sqlitorm\my_node_addon\build\Release\addon.node'
    was compiled against a different Node.js version using
    NODE_MODULE_VERSION 48. This version of Node.js requires
    NODE_MODULE_VERSION 72. Please try re-compiling or re-installing

å‚è€ƒ N-API  ç‰ˆæœ¬çŸ©é˜µï¼š

    |    1    |      2       |      3       |              |
    |---------|--------------|--------------|--------------|
    | v6.x    |              |              | v6.14.2*     |
    | v8.x    | v8.6.0**     | v8.10.0*     | v8.11.2      |
    | v9.x    | v9.0.0*      | v9.3.0*      | v9.11.0*     |
    | â‰¥ v10.x | all releases | all releases | all releases |

    |   4   |    5     |    6     |    7     |          |
    |-------|----------|----------|----------|----------|
    | v10.x | v10.16.0 | v10.17.0 | v10.20.0 |          |
    | v11.x | v11.8.0  |          |          |          |
    | v12.x | v12.0.0  | v12.11.0 | v12.17.0 | v12.19.0 |
    | v13.x | v13.0.0  | v13.0.0  |          |          |
    | v14.x | v14.0.0  | v14.0.0  | v14.0.0  | v14.12.0 |


# ğŸš© Modules æ¨¡å—è§„èŒƒ
- https://nodejs.org/docs/latest-v12.x/api/modules.html
- https://nodejs.org/docs/latest-v12.x/api/globals.html
- JSæ¨¡å—è§„èŒƒï¼šAMDã€UMDã€CMDã€commonJSã€ES6 module https://segmentfault.com/a/1190000012419990
- https://www.typescriptlang.org/docs/handbook/2/modules.html
- ã€Šæ·±å…¥æµ…å‡ºç†è§£NodeJSã€‹

JavaScript çš„ç”Ÿæ€ç³»ç»Ÿä¸€ç›´åœ¨ç¨³æ­¥å¢é•¿ï¼Œå½“å„ç§ç»„ä»¶æ··åˆä½¿ç”¨æ—¶ï¼Œå°±å¯èƒ½ä¼šå‘ç°ä¸æ˜¯æ‰€æœ‰çš„ç»„ä»¶éƒ½èƒ½å’Œå¹³å…±å¤„ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå„ç§æ¨¡å—è§„èŒƒå°±å‡ºæ¥äº†ã€‚æ¨¡å—åŒ–å¼€å‘æå¤§ä¿ƒè¿›äº† JavaScript å¼€å‘çš„è§„æ¨¡ã€é€Ÿåº¦å’Œä»£ç è´¨é‡ï¼Œé€šè¿‡ Node å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ç»“åˆ NPM æ¨¡å—ç®¡ç†å·¥å…·å°†ä¼ ç»Ÿé›¶æ•£çš„è„šæœ¬è¿ç§»åˆ°æ¨¡å—åŒ–å¼€å‘æ¨¡å¼ï¼Œç„¶åé€šè¿‡æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œå¦‚ Webpack ç”Ÿäº§æµè§ˆå™¨è¿è¡Œçš„è„šæœ¬ç¨‹åºï¼Œè¿™ç§å·¥ç¨‹åŒ–çš„æ–¹æ³•ä½¿å¾— JavaScript ä¹Ÿå¯ä»¥å¼€å‘é«˜è´¨é‡çš„å¤§å‹è½¯ä»¶å·¥ç¨‹ã€‚

Node ä½œä¸ºä¸€é—¨æœåŠ¡ç«¯çš„ javascriptï¼Œå®ƒå€Ÿé‰´äº† CommonJS çš„è§„èŒƒï¼Œå½¢æˆäº†ä¸€å¥—æ˜“ç”¨çš„æ¨¡å—è§„èŒƒã€‚

`Node version 13.2.0 is required to support ES Modules: ${(process.versions.node)}`
Use mjs extension or type:"module" in package.json, to use import/export.
CommonJS is Node default setting, use cjs extension or type:"commonjs" to use require/module.exports.

1. Modules: Packages https://nodejs.org/api/packages.html
2. Modules: node:module API https://nodejs.org/api/module.html
3. Modules: CommonJS modules https://nodejs.org/api/modules.html
4. Modules: ECMAScript modules https://nodejs.org/api/esm.html


æ³¨æ„ä»¥ä¸‹æµ‹è¯• CJS æ¨¡å—ä»£ç é€šè¿‡ exports å¯¼å‡ºç¬¦å·çš„æ“ä½œï¼š

```js
// m.js
module.exports = {m: "this is m.js [module.exports]"} // OK
exports.m  = "this is m.js [exports.m]" // OK
exports = {m: "this is m.js [exports]"}  // Error,Unlink

// n.js
let m = require("./m.js"); // CommonJS
console.log( {m} );
```

åœ¨è„šæœ¬æ¨¡å—ä¸­ï¼Œexports å°±æ˜¯å¼•ç”¨ module.exportsï¼Œå¦‚æœç›´æ¥å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ exportsï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´åŸå¼•ç”¨çš„å…³ç³»è¢«æ›¿æ¢ä¸ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯ module.exports è¿™ä¸ªå¯¹è±¡ï¼Œå› æ­¤å¯¼å‡ºå¤±è´¥ï¼Œè¿™ç§æ–¹å¼ä¸èƒ½ä½¿ç”¨ã€‚


ä»¥ä¸‹æµ‹è¯• ESM æ¨¡å—ä»£ç é€šè¿‡ export å…³é”®å­—å¯¼å‡ºç¬¦å·ï¼Œæ³¨æ„ ESM æ¨¡å—ä¸­å¯¼å…¥ Node å†…å»ºæ¨¡å—æ—¶ï¼Œéœ€è¦åœ¨æ¨¡å—åå‰ç¼€ `node:`ï¼š

```js
// m.js
export {m: "this is m.js [exports]"} // OK
export default {m: "this is m.js [default]"}  // OK

// n.js
import m from "./m.js"; // ESM
import cp from "node:child_process"; // Builtin modules
console.log( {m, cp} );
```

```js
import https from "node:https";
import zlib from "node:zlib";
import { StringDecoder } from "node:string_decoder";

const url = "https://cdn-g2.ltfc.net/wuyue/assets/hdputils-fc5d45e9.js"
https.get(url, { headers: {"Accept-Encoding":""} }, res =>{
    const decoder = new StringDecoder('utf8');
    // res.on('data', data => console.log((data)));
    var buffer = [];
    res.on('data', data => {
        buffer.push(data);
    });
    res.on('end', res =>{
        zlib.gunzip(Buffer.concat(buffer), (err, buf) => console.log(buf.toString()));
    });
    console.log({statusCode: res.statusCode});
}).on('error', e => console.error(e))
```
https://nodejs.org/en/docs/guides/anatomy-of-an-http-transaction

æ¨¡å—è§„èŒƒéƒ¨åˆ†å¯ä»¥åˆ†æˆä¸‰éƒ¨åˆ†ï¼š

- require æ¨¡å—å¼•ç”¨ => è¿™æ˜¯æ•´ä¸ªæ¨¡å—ç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œèƒ½å¤Ÿå¼•å…¥å…¶ä»–æ¨¡å—ï¼Œå……åˆ†çš„è¿ç”¨ã€‚
- exports æ¨¡å—å®šä¹‰ => å¦ä¸€ä¸ªå‡ºå½©çš„åœ°æ–¹ï¼Œå¯ä»¥å°†è‡ªèº«æ¨¡å—ä¸­çš„å†…å®¹å¯¼å‡ºï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ã€‚
- æ ‡è¯†(æ¨¡å—æ ‡è¯†) => ä¾›åˆ«äººè®¤æ¸…æ¥šæ¨¡å—çš„ä¸œè¥¿ã€‚

Node æœ‰ä¸¤ä¸ªå…¨å±€æ¨¡å—å¯¹æ‰€æœ‰è„šæœ¬æ¨¡å—å¯ç”¨ï¼Œ`require` å’Œ `module`ï¼Œä¸ç”¨å†ä½¿ç”¨ require è¯·æ±‚è‡ªèº«ã€‚
æ­¤å¤–ï¼Œè¿˜æœ‰å…¨å±€åå¥ç©ºé—´çš„å¯¹è±¡æˆ–å˜é‡ï¼Œå¦‚ process æä¾›äº†å½“å‰è¿›ç¨‹çš„ä¿¡æ¯ã€‚ 

æ¯ä¸ªè„šæœ¬æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ï¼ŒNode åŠ è½½æ—¶ä¼šä½¿ç”¨ module.wrapper åŒ…è£…å®ƒã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªæ¨¡å—æ–‡ä»¶ä¸­éƒ½å¯ä½¿ç”¨
require, exports, module è¿™äº›æ¨¡å—æˆ–æ¨¡å—å˜é‡ï¼Œå®ƒä»¬ç”±æ¨¡å—çš„å°è£…å‡½æ•°æä¾›ï¼Œå¯ä»¥æŸ¥è¯¢ arguments å˜é‡ã€‚

æ¨¡å—å°è£…å‡½æ•° wrapper å°±æ˜¯ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒNode å¯¹è·å–åˆ°çš„è„šæœ¬æ–‡ä»¶ä»£ç è¿›è¡Œä¸Šä¸‹æ–‡éš”ç¦»åŒ…è£…ï¼Œå½¢æˆä¸€ä¸ª
é—­åŒ…ç©ºé—´é˜²æ­¢å…¶æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸï¼š

    (function(exports, require, module, __filename, __dirname){
        // æ­¤å¤„å¡«å……æ¨¡å—æ–‡ä»¶ä»£ç ï¼Œå³ js è„šæœ¬æ–‡ä»¶å†…å®¹
    });

```sh
> node
Welcome to Node.js v14.0.0.
> require('module').wrapper
Proxy [
  [
    '(function (exports, require, module, __filename, __dirname) { ',
    '\n});'
  ],
  { set: [Function: set], defineProperty: [Function: defineProperty] }
]
```

é€šå¸¸åœ¨è„šæœ¬ä¸­ï¼Œrequire å¯¼å…¥çš„æ˜¯é¡¹ç›®ä¸­çš„ node_modules ä¸‹å®‰è£…çš„æ¨¡å—ï¼Œå¦‚æœè¦å¯¼å…¥ global æ¨¡å—ï¼Œ
å°±éœ€è¦æŒ‡å®šå…¨å±€æ¨¡å—çš„è·¯å¾„ï¼š

```js
const { execSync } = require("child_process");
// get root folder of global node modules
const root = execSync("npm root -g")
  .toString()
  .trim();
// then we require global node modules as
const axios = require(`${root}/axios`);
const uuidv4 = require(`${root}/uuid/v4`);
```

æ¨¡å—å¼•å…¥çš„æ­¥éª¤ï¼š

- è·¯å¾„åˆ†æ => å¯¹æ¨¡å—çš„è·¯å¾„è¿›è¡Œåˆ†æï¼Œ'./circle' å°±æ˜¯è·¯å¾„ã€‚(./æ­¤ç±»çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå½“ç„¶è¿˜æœ‰ç»å¯¹è·¯å¾„)
- æ–‡ä»¶å®šä½ => é€šè¿‡åˆ†æå‡ºæ¥çš„ä½ç½®ï¼Œå»è¿›è¡Œæ–‡ä»¶çš„è·å–ã€‚
- ç¼–è¯‘æ‰§è¡Œ => åªæœ‰é€šè¿‡ç¼–è¯‘è¿‡çš„æ–‡ä»¶ï¼Œæ‰èƒ½å¤Ÿæ”¾å…¥å…¶ä»–æ¨¡å—ä¸­è¿›è¡Œä½¿ç”¨ (ä¹‹åä¹Ÿä¼šåˆ†æå¦‚ä½•è¿›è¡Œç¼–è¯‘çš„)ã€‚

åœ¨æ¨¡å—ä½œç”¨åŸŸä¸­æš´éœ²ä»¥ä¸‹å†…å®¹ï¼š

- `__dirname`
- `__filename`
- `exports`
- `module`
    - module.children
    - module.exports
        - exports shortcut
    - module.filename
    - module.id
    - module.loaded
    - module.parent [deprecated]
    - module.path
    - module.paths
    - module.require(id)
- `require(id)`
    - require.cache
    - require.extensions
    - require.main
    - require.resolve(request[, options])
    - require.resolve.paths(request)

é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæ¯ä¸ªæ¨¡å—æ–‡ä»¶ä¹‹é—´éƒ½è¿›è¡Œäº†ä½œç”¨åŸŸéš”ç¦»ã€‚æ¥ä¸‹æ¥ï¼ŒåŒ…è£…ä¹‹åçš„ä»£ç ä¼šé€šè¿‡ VM åŸç”Ÿæ¨¡å—çš„ runInThisContext() æ–¹æ³•æ‰§è¡Œï¼Œè¯¥æ–¹æ³•ç±»ä¼¼ eval()ï¼Œåªæ˜¯å…·æœ‰æ˜ç¡®çš„ä¸Šä¸‹æ–‡ï¼Œæ— æ±¡æŸ“å…¨å±€ã€‚

è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå…·ä½“çš„ function å¯¹è±¡ã€‚æœ€åï¼Œå°†è¯¥å½“å‰æ¨¡å—å¯¹è±¡çš„ exports å±æ€§ï¼Œrequire() æ–¹æ³•ï¼Œmodule å³æ¨¡å—å¯¹è±¡è‡ªèº«ä»¥åŠæ–‡ä»¶å®šä½ä¸­å¾—åˆ°çš„å®Œæ•´çš„æ–‡ä»¶è·¯å¾„å’Œç›®å½•ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸ªå°è£…å‡½æ•°æ‰§è¡Œã€‚

æ‰§è¡Œä¹‹åï¼Œæ¨¡å—çš„ exports å±æ€§è¢«è¿”å›ç»™äº†è°ƒç”¨æ–¹ï¼Œå› æ­¤ exports å±æ€§ä¸Šçš„ä»»ä½•æ–¹æ³•å’Œå±æ€§éƒ½å¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨åˆ°ï¼Œä½†æ˜¯æ¨¡å—ä¸­çš„å…¶ä»–å±æ€§æˆ–æ–¹æ³•åˆ™å°é—­åœ¨é—­åŒ…å†…ä¸å¯ç›´æ¥è°ƒç”¨ã€‚

å°½ç®¡å‚æ•°ä¸­çš„ exports ä¹Ÿæ˜¯ç›´æ¥è¢«è¿”å›çš„å±æ€§ï¼Œç›´æ¥ç”¨ exports é€šå¸¸ä¼šå¾—åˆ°å¤±è´¥çš„ç»“æœï¼Œå®ƒåªæ˜¯ module.exports çš„ä¸€ä¸ªå¼•ç”¨ã€‚å¦‚æœ Module.exports å·²ç»å…·å¤‡ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆexportsæ”¶é›†æ¥çš„ä¿¡æ¯å°†è¢«å¿½ç•¥ã€‚

ç›´æ¥é€šè¿‡ module.exports æ¥æ·»åŠ å±æ€§æˆ–æ–¹æ³•ï¼Œå¿½ç•¥ exports å°±å¯ä»¥äº†ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ˜ï¼šignore exports and only use module.exports

ä¸€èˆ¬æ¥è¯´ï¼Œå¼•ç”¨æ—¶æŒ‡å®šçš„æ˜¯ä¸€ä¸ªæ¨¡å—æ–‡ä»¶ï¼Œä½†æ˜¯ç›®å½•ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªæ¨¡å—çš„æ¦‚å¿µå­˜åœ¨ï¼Œåªè¦ç›®å½•å­˜åœ¨ä»¥ä¸‹ä»»ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–æ˜¯æ¨¡å—æˆ–æ˜¯æ’ä»¶ï¼š

- ./some-library/index.js
- ./some-library/index.node

å¦å¤–ï¼Œ`require()` ä¼ å…¥çš„ä¸æ˜¯ä¸€ä¸ªç›¸å¯¹ç›®å½• '/', '../', './'ï¼Œé‚£ä¹ˆ Node.js å°±ä¼šä»å½“å‰æ¨¡å—çš„æ ¹ç›®å½•ä¸­åŠ è½½å¼•å…¥çš„æ¨¡å—ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨ä» `/node_modules` ç›®å½•ä¸­æ‰¾åˆ°ç›¸åº”çš„æ¨¡å—ã€‚

å¦‚æœè¦ä»å…¨å±€ç›®å½•åŠ è½½æ¨¡å—ï¼Œå¯ä»¥è®¾ç½® `NODE_PATH` ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤åŠ è½½ä»¥ä¸‹å…¨å±€ç›®å½•ï¼š

- $HOME/.node_modules
- $HOME/.node_libraries
- $PREFIX/lib/node

å¦‚æœæ¨¡å—å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œ`require()` è°ƒç”¨æ¨¡å—è¿”å›æ—¶å¯èƒ½å°šæœªå®Œæˆæ‰§è¡Œï¼Œè¦ç­‰å¾…è¢«å¼•ç”¨çš„æ¨¡å—åŠ è½½åæ‰å®Œæˆå¾ªç¯å¼•ç”¨çš„éƒ¨åˆ†ã€‚


## AMD å¼‚æ­¥æ¨¡å—

AMD - Asynchromous Module Definition æ˜¯ RequireJS åœ¨æ¨å¹¿è¿‡ç¨‹ä¸­å¯¹æ¨¡å—å®šä¹‰çš„è§„èŒƒåŒ–äº§å‡ºï¼ŒAMDæ˜¯å¼‚æ­¥åŠ è½½æ¨¡å—ï¼Œæ¨å´‡ä¾èµ–å‰ç½®ï¼Œç®¡ç†æ¨¡å—ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œä¾¿äºä»£ç çš„ç¼–å†™å’Œç»´æŠ¤ã€‚

    // An example AMD module
    define("my_module", ["dependency_1", "dependency_2"], function (dep1, dep2) {
      return {
        name: "My Awesome Module",
        greet: () => {
          alert("Hello, world!");
        },
      };
    });

requireJS çš„åº”ç”¨æ˜¯å‚ç…§ AMD è§„èŒƒå®ç°çš„ï¼Œé€‚ç”¨äºæµè§ˆå™¨ç¯å¢ƒï¼Œè¯­æ³•ï¼š

- å¯¼å…¥ require(['module'], function (ref){ ... });
- å¯¼å‡º define(function (){return 'å€¼');

    define('module1', ['jquery'], ($) => {
      //do something...
    });

ä»£ç ä¸­ä¾èµ–è¢«å‰ç½®ï¼Œå½“å®šä¹‰æ¨¡å— `module1` æ—¶ï¼Œå°±ä¼šåŠ è½½ä¾èµ– `jquery`

    demo
    // a.js
    define(function (){
    ã€€ã€€return {
    ã€€ã€€ã€€a:'hello world'
    ã€€ã€€}
    });

    // b.js
    require(['./a.js'], function (moduleA){
        console.log(moduleA.a); // hello world
    });


## CMD å…¬å…±æ¨¡å—å®šä¹‰

CMD - Common Module Definition æ˜¯åœ¨ AMD åŸºç¡€ä¸Šæ”¹è¿›çš„ä¸€ç§è§„èŒƒï¼Œå’Œ AMD ä¸åŒåœ¨äºå¯¹ä¾èµ–æ¨¡å—çš„æ‰§è¡Œæ—¶æœºå¤„ç†ä¸åŒï¼ŒCMD æ˜¯å°±è¿‘ä¾èµ–ï¼Œè€Œ AMD æ˜¯å‰ç½®ä¾èµ–ã€‚

CMD æ˜¯ SeaJS åœ¨æ¨å¹¿è¿‡ç¨‹ä¸­å¯¹æ¨¡å—å®šä¹‰çš„è§„èŒƒåŒ–äº§å‡ºï¼Œå®ƒå¯¹äºæ¨¡å—çš„ä¾èµ–æ˜¯å»¶è¿Ÿæ‰§è¡Œï¼Œæ¨å´‡ä¾èµ–å°±è¿‘ã€‚åŒæ—¶ CMD ä¹Ÿæ˜¯å»¶è‡ª CommonJS Modules/2.0 è§„èŒƒ

- ç¯å¢ƒï¼šæµè§ˆå™¨ç¯å¢ƒ
- åº”ç”¨ï¼šseajsæ˜¯å‚ç…§UMDè§„èŒƒå®ç°çš„ï¼ŒrequireJSçš„æœ€æ–°çš„å‡ ä¸ªç‰ˆæœ¬ä¹Ÿæ˜¯éƒ¨åˆ†å‚ç…§äº†UMDè§„èŒƒçš„å®ç°
- è¯­æ³•ï¼š
    - å¯¼å…¥ï¼šdefine(function(require, exports, module) {});
    - å¯¼å‡ºï¼šdefine(function (){return 'å€¼');

Demo

    // a.js
    define(function (require, exports, module){
    ã€€ã€€exports.a = 'hello world';
    });

    // b.js
    define(function (require, exports, module){
        var moduleA = require('./a.js');
        console.log(moduleA.a); // æ‰“å°å‡ºï¼šhello world
    });


å¦‚ä¸Šä»£ç  b.js åªæœ‰å½“çœŸæ­£æ‰§è¡Œç”¨åˆ° `moduleA.a` æ—¶æ‰ä¼šæ‰§è¡Œä¾èµ–è¯·æ±‚ã€‚



## CommonJS

CommonJS æ˜¯æœåŠ¡ç«¯æ¨¡å—çš„è§„èŒƒï¼Œç”±äº Node.js è¢«å¹¿æ³›è®¤çŸ¥ã€‚

æ ¹æ® CommonJS è§„èŒƒï¼Œä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚åŠ è½½æ¨¡å—ä½¿ç”¨ `require` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¯»å–ä¸€ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œï¼Œæœ€åè¿”å›æ–‡ä»¶å†…éƒ¨çš„ `module.exports` å¯¹è±¡ã€‚

    //file1.js
    moudle.exports = {
      a: 1
    };
     
    //file2.js
    var f1 = require('./file1');
    var v = f1.a + 2;
    module.exports ={
      v: v
    };

CommonJS åŠ è½½æ¨¡å—æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥åªæœ‰åŠ è½½å®Œæˆæ‰èƒ½æ‰§è¡Œåé¢çš„æ“ä½œã€‚åƒ Node.js ä¸»è¦ç”¨äºæœåŠ¡å™¨çš„ç¼–ç¨‹ï¼ŒåŠ è½½çš„æ¨¡å—æ–‡ä»¶ä¸€èˆ¬éƒ½å·²ç»å­˜åœ¨æœ¬åœ°ç¡¬ç›˜ï¼Œæ‰€ä»¥åŠ è½½èµ·æ¥æ¯”è¾ƒå¿«ï¼Œä¸ç”¨è€ƒè™‘å¼‚æ­¥åŠ è½½çš„æ–¹å¼ï¼Œæ‰€ä»¥ CommonJS è§„èŒƒæ¯”è¾ƒé€‚ç”¨ã€‚ä½†å¦‚æœæ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œè¦ä»æœåŠ¡å™¨åŠ è½½æ¨¡å—ï¼Œè¿™æ˜¯å°±å¿…é¡»é‡‡ç”¨å¼‚æ­¥æ¨¡å¼ã€‚æ‰€ä»¥å°±æœ‰äº† AMD CMD è§£å†³æ–¹æ¡ˆã€‚

## UMD é€šç”¨æ¨¡å—å®šä¹‰

UMD - Universal Module Definition å…¼å®¹ AMD å’Œ commonJS è§„èŒƒçš„åŒæ—¶ï¼Œè¿˜å…¼å®¹å…¨å±€å¼•ç”¨çš„æ–¹å¼ï¼Œæ˜¯ AMD å’Œ CommonJS çš„ä¸€ä¸ªç³…åˆã€‚AMD æ˜¯æµè§ˆå™¨ä¼˜å…ˆï¼Œå¼‚æ­¥åŠ è½½ï¼›CommonJS æ˜¯æœåŠ¡å™¨ä¼˜å…ˆï¼ŒåŒæ­¥åŠ è½½ã€‚


- ç¯å¢ƒï¼š æµè§ˆå™¨æˆ–æœåŠ¡å™¨ç¯å¢ƒ
- åº”ç”¨ï¼š æ— 
- è¯­æ³•ï¼š æ— å¯¼å…¥å¯¼å‡ºè§„èŒƒï¼Œåªæœ‰å¦‚ä¸‹çš„ä¸€ä¸ªå¸¸è§„å†™æ³•ï¼š

        (function (root, factory) {
            if (typeof define === 'function' && define.amd) {
                // AMD. Register as an anonymous module.
                define(['b'], factory);
            } else if (typeof module === 'object' && module.exports) {
                // Node. Does not work with strict CommonJS, but
                // only CommonJS-like environments that support module.exports,
                // like Node.
                module.exports = factory(require('b'));
            } else {
                // Browser globals (root is window)
                root.returnExports = factory(root.b);
            }
        }(this, function (b) {
            //use b in some fashion.

            // Just return a value to define the module export.
            // This example returns an object, but the module
            // can return a function as the exported value.
            // æš´éœ²å…¬å…±æ–¹æ³• è¿™é‡Œæ˜¯çœŸæ­£çš„å‡½æ•°ä½“
            return {}; 
        }));

æ—¢ç„¶è¦é€šç”¨ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿé‚£å°±å…ˆåˆ¤æ–­æ˜¯å¦æ”¯æŒ Node.js çš„æ¨¡å—ï¼Œå­˜åœ¨å°±ä½¿ç”¨ Node.jsï¼›å†åˆ¤æ–­æ˜¯å¦æ”¯æŒ AMD çš„ define æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä½¿ç”¨ AMD çš„æ–¹å¼åŠ è½½ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ UMDã€‚

ä¾‹å¦‚å¼€å‘ä¸€ä¸ªåŸºäº React çš„ç»„ä»¶å·¥å…·ï¼Œå¯ä»¥ç¼–è¯‘æ‰“åŒ…çš„æ—¶ç”ŸæˆåŒ…å« React ä»£ç çš„å®Œå…¨å¯è¿è¡Œç¨‹åºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Webpack æ‰“åŒ… UMD æ¨¡å—ï¼Œå•ç‹¬ç¼–è¯‘æˆ UMD æ¨¡å—ï¼Œå†åœ¨é¡µé¢ä¸­å…ˆåŠ è½½ React çš„å‘å¸ƒçš„ UMDæ¨¡å—ï¼ŒååŠ è½½ç»„ä»¶çš„ UMD æ¨¡å—ä¹Ÿä¸€æ ·å¯ä»¥æ­£å¸¸è¿è¡Œã€‚æµè§ˆå™¨åŠ è½½è„šæœ¬çš„æµç¨‹æ—¶åŒæ­¥åŠ è½½çš„ï¼Œé¡µé¢ä¸­å…ˆå‡ºç°çš„è„šæœ¬å…ˆæ‰§è¡Œï¼Œå…ˆå¼•ç”¨çš„è„šæœ¬æ–‡ä»¶å…ˆåŠ è½½ã€‚


## ES6 module

ES6 module ç‰¹ç‚¹ï¼š

- æŒ‰éœ€åŠ è½½ï¼ˆç¼–è¯‘æ—¶åŠ è½½ï¼‰
- import å’Œ export å‘½ä»¤åªèƒ½åœ¨æ¨¡å—çš„é¡¶å±‚ï¼Œä¸èƒ½åœ¨ä»£ç å—ä¹‹ä¸­å¦‚ if è¯­å¥ï¼Œimport() è¯­å¥å¯ä»¥åœ¨ä»£ç å—ä¸­å®ç°å¼‚æ­¥åŠ¨æ€æŒ‰éœ€åŠ¨æ€åŠ è½½

- ç¯å¢ƒï¼š æµè§ˆå™¨æˆ–æœåŠ¡å™¨ç¯å¢ƒï¼ˆä»¥åå¯èƒ½æ”¯æŒï¼‰
- åº”ç”¨ï¼š ES6çš„æœ€æ–°è¯­æ³•æ”¯æŒè§„èŒƒ
- è¯­æ³•ï¼š 
    - å¯¼å…¥ï¼š import {æ¨¡å—åAï¼Œæ¨¡å—åB...} from 'æ¨¡å—è·¯å¾„'
    - å¯¼å‡ºï¼š exportå’Œexport default
    - import('æ¨¡å—è·¯å¾„').then()æ–¹æ³•

æ³¨æ„ï¼š export åªæ”¯æŒå¯¹è±¡å½¢å¼å¯¼å‡ºï¼Œä¸æ”¯æŒå€¼çš„å¯¼å‡ºï¼Œexport default å‘½ä»¤ç”¨äºæŒ‡å®šæ¨¡å—çš„é»˜è®¤è¾“å‡ºï¼Œåªæ”¯æŒå€¼å¯¼å‡ºï¼Œä½†æ˜¯åªèƒ½æŒ‡å®šä¸€ä¸ªï¼Œæœ¬è´¨ä¸Šå®ƒå°±æ˜¯è¾“å‡ºä¸€ä¸ªå«åš default çš„å˜é‡æˆ–æ–¹æ³•ã€‚

é”™è¯¯çš„å†™æ³•ï¼š

    // å†™æ³•ä¸€
    export 1;

    // å†™æ³•äºŒ
    var m = 1;
    export m;

    // å†™æ³•ä¸‰
    if (x === 2) {
      import MyModual from './myModual';
    }


æ­£ç¡®çš„ä¸‰ç§å†™æ³•

    // å†™æ³•ä¸€
    export var m = 1;

    // å†™æ³•äºŒ
    var m = 1;
    export {m};

    // å†™æ³•ä¸‰
    var n = 1;
    export {n as m};

    // å†™æ³•å››
    var n = 1;
    export default n;

    // å†™æ³•äº”
    if (true) {
        import('./myModule.js')
        .then(({export1, export2}) => {
          // ...Â·
        });
    }

    // å†™æ³•å…­
    Promise.all([
      import('./module1.js'),
      import('./module2.js'),
      import('./module3.js'),
    ])
    .then(([module1, module2, module3]) => {
       Â·Â·Â·
    });


## Import è·¯å¾„åˆ«å

æ‰“åŒ…å·¥å…·å¸¸ç”¨çš„æ˜¯ Webpackï¼Œè¯´ä¸€ä¸‹ publicPath è¿™ä¸ªé…ç½®å‚æ•°ï¼Œå¦‚æœè¦åš CDN å¼•å…¥è‚¯å®šæ˜¯è¦é…ç½®è¿™ä¸ªå‚æ•°çš„ã€‚

    import Vue form 'vue'

å†™å…¨çš„è¯æ˜¯å°±æ˜¯

    import Vue from '.../nodemouls/vue/list/vue.js';

æ­¤æ—¶åœ¨ webpack.base.conf.js ä¸­è¿›è¡Œäº†å®šä¹‰ï¼Œå†…ç½®äº†ä¸€äº›æ‰©å±•åé€‰é¡¹ï¼Œæ„æ€æ˜¯çœç•¥åé¢çš„åç¼€ï¼Œç”± Webpack æ¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬åŠ ä¸Šã€‚

    extenions:['.js','.vue','.json'], 

å¦‚æœåå­—æ¯”è¾ƒé•¿ï¼Œè¿˜å¯ä»¥èµ·ä¸ªåˆ«åã€‚

    alias:{ '@':resolve('src')},

å®ƒçš„æ„æ€æ˜¯åœ¨é¡¹ç›®ä¸­ï¼Œå¼•å…¥è·¯å¾„çš„æ—¶å€™ä½¿ç”¨ @ ä»£è¡¨ src æ–‡ä»¶å¤¹ï¼Œçœå»äº†ç›¸å¯¹ç›®å½•çš„æ“ä½œï¼Œè¿™æ ·å†™æ¯”è¾ƒååˆ†æ–¹ä¾¿ã€‚ å½“æˆ‘ä»¬åœ¨æ¨¡æ¿ä¸­å†™ img çš„æ—¶å€™æœ‰æ—¶ä¹Ÿéœ€è¦ç¿»ç€æ‰¾ï¼Œé‚£ä¹ˆç”¨ @ ä»£æ›¿æ˜¯ä¾¿åˆ©çš„ï¼Œæ¯”å¦‚åœ¨ assets æ–‡ä»¶å¤¹ä¸­æœ‰ logo.png å›¾ç‰‡ï¼Œä»¥å¾€å†™æ³•å’Œåˆ«åå†™æ³•å¯¹æ¯”ï¼š

    <img src="../../src/assets/logo.png">
    <img src="@/assets/logo.png">



# ğŸš© Webpack & UMD æ¨¡å—æ‰“åŒ…æµ‹è¯•
- å¦‚ä½•ç”¨ Webpack æ‰“åŒ… UMD æ¨¡å—å¹¶æµ‹è¯•æ‰“åŒ…ç»“æœ https://segmentfault.com/a/1190000018243783
- UMD æ¨¡å—ä¸ Webpack æ‰“åŒ… Vue åçš„æ„å»ºäº§ç‰©åˆ†æ http://www.ptbird.cn/umd-module-webpack-build-vue.html

å¯¹äº JavaScript çš„æ¨¡å—è€Œè¨€, Webpack å¯ä»¥ç”¨æ¥ build åŸºäºæµè§ˆå™¨æˆ–æœåŠ¡ç«¯çš„æ¨¡å—åŒ…ï¼Œä¸‹é¢è®©æˆ‘ä»¬å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Webpack ç”Ÿæˆ UMDã€‚

é¦–å…ˆéœ€è¦å…¨å±€å®‰è£… Webpackï¼š

    npm install -g webpack

è®©æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªç”¨æ¥è¿”å›ä¸¤æ•°ä¹‹å’Œçš„åŠ æ³•æ¨¡å—ï¼š

    // add.js
    module.exports = function add(a, b) {
      return a + b;
    };

æ¥ä¸‹æ¥é…ç½® Webpackï¼Œé…ç½®é¡¹ libraryTarget æŒ‡å®š umd æ¨¡å—ï¼š

    // webpack.config.js
    module.exports = {
      entry: './add.js',
      output: {
        filename: './dist/add.js',
        // export to AMD, CommonJS, or window
        libraryTarget: 'umd',
        // the name exported to window
        library: 'add'
      }
    };

libraryTarget å¯¹åº” Webpack å‚æ•° --output-library-targetï¼Œå®ƒå¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§å–å€¼ï¼š

- `var` é»˜è®¤å€¼ï¼Œè¡¨ç¤ºå¯¹ä¸€ä¸ªå˜é‡èµ‹å€¼ var Library = xxx
- `this` è®¾ç½® this çš„ Library å±æ€§ var Library = xxx
- `commonjs` è®¾ç½® exports["Library"] = xxx
- `commonjs2` è®¾ç½® module.exports = xxx
- `amd` å¯¼å‡ºä¸º AMD æ¨¡å—
- `umd` å¯¼å‡ºä¸º AMDï¼ŒCommonJS2ï¼Œä»¥åŠå…¨å±€å¯¹è±¡çš„ä¸€ä¸ªå±æ€§

è€Œ library å¯¹åº” Webpack çš„å‘½ä»¤è¡Œå‚æ•° --output-library ã€‚æ¥ä¸‹æ¥ä½¿ç”¨ Webpack å‘½ä»¤æ ¹æ®é…ç½®æ–‡ä»¶æ¥ build æ¨¡å—ï¼š

    $ webpack
    Hash: 87657f97293582af3ac3
    Version: webpack 4.29.3
    Time: 435ms
    Built at: 02/22/2019 9:01:57 AM
       Asset      Size  Chunks             Chunk Names
    ./add.js  1.17 KiB       0  [emitted]  main
    Entrypoint main = ./add.js
    [0] ./add.js 83 bytes {0} [built

ä¹Ÿå¯ä»¥ä¼ å…¥æ‰“åŒ…å‚æ•°æ¥è¿è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚ä½¿ç”¨ Webpack 4.x ä»¥ main.js ä½œä¸ºå…¥å£ï¼Œbuild.js ä½œä¸ºå‡ºå£è¿›è¡Œå¼€å‘æ¨¡å¼æ‰“åŒ…è¾“å‡ºï¼š 

    webpack main.js -o build.js // æ³¨æ„æ˜¯ 4.x ç‰ˆæœ¬

å¦‚æœä¸éœ€è¦åˆ†æäº§ç‰©ï¼Œå¯ä»¥é€‰æ‹©å‘è¡Œæ‰“åŒ… production æ¨¡å¼ï¼š

    webpack main.js -o build.js --mode development

æˆ–ä¸ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œé€šè¿‡å‚æ•°è¿›è¡Œé…ç½®ï¼š

    webpack .\add.js -o .\dist\add.js --mode development --output-library-target umd --output-library add

æ‰“åŒ…åçš„äº§ç‰©å°±åŒ…å« webpackBootstrap è¿™ä¸ªæ¨¡å—ä¾èµ–ç®¡ç†è„šæœ¬ï¼Œæ¥è¿‘ 100 è¡Œä»£ç ï¼Œè¿™ä¸ªæ¨¡å—åŠ è½½å™¨çš„å¤§æ¦‚ç»“æ„å¦‚ä¸‹ï¼Œeval() æ‰§è¡Œçš„æ‰æ˜¯æ¨¡å—çš„ä»£ç ï¼Œï¼š

    (function(modules) { // webpackBootstrap
        // ...
    })({
        // exports ...
        "./app.js": (function(module, __webpack_exports__, __webpack_require__) {
            eval("...");
        }),
        "./main.js": (function(module, __webpack_exports__, __webpack_require__) {
            eval("...");
        }),
    })

è¿™äº›å¯¼å‡ºæ¨¡å— exports åœ¨æ‰§è¡Œè¯·æ±‚åŠ è½½æ—¶ï¼Œä¼šè¢«è°ƒç”¨ï¼Œç„¶åè¿”å›æ¨¡å—è®¾ç½®å¥½çš„å¯¼å‡ºå¯¹è±¡ã€‚

ç°åœ¨ä½ å¯ä»¥æ¥ä½¿ç”¨ CommonJS, AMD, script tag è¿™ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥æµ‹è¯• UMD åŒ…æ˜¯å¦æ­£ç¡®äº†ã€‚

åœ¨æµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦ç¡®å®šæ˜¯å¦å®‰è£…æˆåŠŸ Nodejs ç¯å¢ƒï¼Œå½“ä½ ä½¿ç”¨ Webpack æ‰“åŒ…çš„ç¨‹åºä¸­åŒ…å«äº†è°ƒç”¨ window çš„å†…å®¹æ—¶ï¼Œæ¯”å¦‚æ“ä½œ DOM å•¥çš„ï¼Œéœ€è¦å°† commonJS è½¬æ¢æˆæµè§ˆå™¨å¯è¯†åˆ«çš„ä»£ç ã€‚è¿™ä¸€æ­¥æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¨èä½¿ç”¨ browserifyï¼Œå®ƒçš„ logo è´¼å¥½çœ‹ï¼Œè®©æˆ‘æœ‰ç§åœ¨å†™å’’è¯­çš„æ„Ÿè§‰ã€‚è€Œä¸”ä¹Ÿå¾ˆå¥½ç”¨ï¼Œä½ åªè¦åœ¨ terminal ä¸‹è¾“å…¥ browserify æƒ³è¦è½¬æ¢çš„æ–‡ä»¶ > ç”Ÿæˆæ–‡ä»¶ï¼Œå°±å¯ä»¥ç”Ÿæˆå¯ä»¥åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹ä½¿ç”¨çš„ js å•¦ã€‚

å¦‚æœä¸æƒ³è¯¦ç»†æµ‹è¯•ï¼Œä¹Ÿä¸æƒ³è£… browserifyï¼Œè¿˜æœ‰ä¸€ç§å·æ‡’çš„åŠæ³•å¯ä»¥ä¸å®Œæ•´çš„æµ‹è¯•ä½ çš„ä»£ç , åœ¨ nodejs ç¯å¢ƒä¸‹å®šä¹‰ `global.window = {};` ä»£ç åº”è¯¥ä¹Ÿå¯ä»¥è¿è¡Œã€‚

    $ node

    > var add = require('./dist/add');
    > add(1, 2);

AMD æ¨¡å—éœ€è¦ä¸€ä¸ª requirejs æ¨¡å—ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯åœ¨ CDN ä¸Šå¼•ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠå®ƒä¸‹è½½ä¸‹æ¥ï¼Œè‡ªå·±å¼•å…¥è¯•ä¸€ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè‡ªå·±å¼•ç”¨çš„è¯ï¼Œéœ€è¦æ³¨æ„æ–‡ä»¶è·¯å¾„ã€‚

ä¸‹è½½é“¾æ¥åœ¨è¿™é‡Œ https://requirejs.org/docs/download.html
AMD (ä¸­æ–‡ç‰ˆ) https://github.com/amdjs/amdjs-api/wiki/AMD-(%E4%B8%AD%E6%96%87%E7%89%88

    <!-- amd.html -->
    <html>
    <body>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.2/require.min.js"></script>
      <script>
        window.requirejs(['dist/add'], function(add) {
          console.log(add(1, 2));
        });
      </script>
    </body>
    </html>

è¿™ä¸ªå°±æ˜¯æœ€ç®€å•çš„å…¨å±€æš´éœ²ï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚

    <!-- script-tag.html -->
    <html>
    <body>
      <script src="./dist/add.js"></script>
      <script>
        console.log(window.add(1, 2));
      </script>
    </body>
    </html>


æ¨¡å— entry è„šæœ¬ï¼š

    function Ukulele(){
        //balabala
    }
    export {Ukulele}

é…ç½® webpack-config.js å¦‚ä¸‹ï¼š

    var webpack = require('webpack');
    var path = require('path');

    var config = {
        entry: __dirname + '/src/ukulele/core/Ukulele.js',
        devtool: 'source-map',
        output: {
            path: __dirname + '/dist',
            filename: 'ukulele.js',
            library: "Ukulele",
            libraryTarget: 'umd',
            umdNamedDefine: true
        },
        module: {
            loaders: [
                {
                    test: /\.js$/,
                    loader: 'babel',
                    exclude: /(node_modules|bower_components|test)/,
                    query: {
                        presets: ['es2015']
                    }
                 },
            ]
        },
        resolve: {
            root: path.resolve('./src'),
            extensions: ['', '.js']
        }
    }
    module.exports = config;

åœ¨è¿™ä¸ªå®ä¾‹ä¸­ï¼Œæ³¨æ„å¯¼å‡ºçš„æ˜¯å¯¹è±¡ `export {Ukulele}` é‚£ä¹ˆè°ƒç”¨æ¨¡å—æ–¹æ³•æ˜¯å°±è¦ä½¿ç”¨ library æŒ‡å®šçš„æ¨¡å—åæ¥å¼•ç”¨è¿™ä¸ªå¯¼å‡ºçš„å¯¹è±¡ã€‚

    <script src="ukulele.js"></script>
    <script>
        Ukulele.Ukulele()
    </script>

åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨æ—¶ï¼Œå¯¼å‡ºçš„å¯¹è±¡ä¼šè¢«æŒ‚è½½åˆ°å…¨å±€ç©ºé—´ï¼Œæ‰€ä»¥ Ukulele æ‰€å¼•ç”¨çš„å¯¹è±¡å°±èƒ½åœ¨å…¨å±€ç©ºé—´ä¸Šå¯»æ‰¾åˆ°ã€‚


## Webpack Externals é…ç½®
Webpack externals æ·±å…¥ç†è§£ https://segmentfault.com/a/1190000012113011
Webpack Externals https://www.webpackjs.com/configuration/externals/
Webpack Externals https://webpack.js.org/configuration/externals/

ä¸ºäº†å¯¼å‡º UMD æ¨¡å—ï¼Œéœ€è¦é…ç½® Webpack çš„ externals å‚æ•°ã€‚æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è§£é‡Šï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¼•ç”¨ä¸€ä¸ªåº“ï¼Œä½†æ˜¯åˆä¸æƒ³è®© webpack æ‰“åŒ…ï¼Œå¹¶ä¸”åˆä¸å½±å“æˆ‘ä»¬åœ¨ç¨‹åºä¸­ä»¥ CMDã€AMD æˆ–è€… window/global å…¨å±€ç­‰æ–¹å¼è¿›è¡Œä½¿ç”¨ï¼Œé‚£å°±å¯ä»¥é€šè¿‡é…ç½® externalsã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯ç”¨åœ¨åˆ›å»ºä¸€ä¸ªåº“çš„æ—¶å€™ç”¨çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥åœ¨æˆ‘ä»¬é¡¹ç›®å¼€å‘ä¸­å……åˆ†ä½¿ç”¨ã€‚externals çš„é…ç½®æœ‰ä»¥ä¸‹å‡ ç§ï¼šArrayã€ Objectã€ RegExpã€ Functionã€ Stringï¼Œä½¿ç”¨ Array åˆå¯ä»¥åŒ…å« Object ç­‰é…ç½®ï¼Œå³å®˜æ–¹æ–‡æ¡£è¯´æ˜çš„ Combining syntaxesï¼Œä¾‹å¦‚ä»¥ä¸‹å°±é€šè¿‡ Array æ–¹å¼æ•´åˆäº† Objectã€ Function ç­‰é…ç½®æ–¹å¼ï¼š

    externals: [
        {
            "react": "React",
            "react-dom": "ReactDOM",
            "@alifd/next": "Next"
        },
        function(context, request, callback) {
            // Every module prefixed with "global-" becomes external
            // "global-abc" -> abc
            if(/^global-/.test(request)){
                console.log( request, callback, request.substr(7))
                return callback(null, "var " + request.substr(7));
            }
            callback();
        },
    ],


å‡è®¾ï¼šæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªè‡ªå·±çš„åº“ï¼Œé‡Œé¢å¼•ç”¨äº†lodashè¿™ä¸ªåŒ…ï¼Œç»è¿‡webpackæ‰“åŒ…çš„æ—¶å€™ï¼Œå‘ç°å¦‚æœæŠŠè¿™ä¸ªlodashåŒ…æ‰“å…¥è¿›å»ï¼Œæ‰“åŒ…æ–‡ä»¶å°±ä¼šéå¸¸å¤§ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥externalsçš„æ–¹å¼å¼•å…¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡ªå·±çš„åº“æœ¬èº«ä¸æ‰“åŒ…è¿™ä¸ª lodashï¼Œéœ€è¦ç”¨æˆ·ç¯å¢ƒæä¾›ã€‚

ä½¿ç”¨lodash

    import _ from 'lodash';

é…ç½®externals

    externals: {
      "lodash": {
            commonjs: "lodash",//å¦‚æœæˆ‘ä»¬çš„åº“è¿è¡Œåœ¨Node.jsç¯å¢ƒä¸­ï¼Œimport _ from 'lodash'ç­‰ä»·äºconst _ = require('lodash')
            commonjs2: "lodash",//åŒä¸Š
            amd: "lodash",//å¦‚æœæˆ‘ä»¬çš„åº“ä½¿ç”¨require.jsç­‰åŠ è½½,ç­‰ä»·äº define(["lodash"], factory);
            root: "_"//å¦‚æœæˆ‘ä»¬çš„åº“åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œéœ€è¦æä¾›ä¸€ä¸ªå…¨å±€çš„å˜é‡â€˜_â€™ï¼Œç­‰ä»·äº var _ = (window._) or (_);
      }
    }

æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡å¦‚ lodash ä¸­åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä¸æä¾› `_` çš„å…¨å±€å˜é‡ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰åŠæ³•ä½¿ç”¨ã€‚è¿™ä¸ª `_` æ˜¯ä¸èƒ½éšä¾¿ä¹±å†™çš„ã€‚å¦‚æœå¤–éƒ¨åº“ lodash æä¾›çš„æ˜¯å…¨å±€å˜é‡ lodash é‚£å°±å¾—ä½¿ç”¨ lodashã€‚

Array æ•°ç»„å†…çš„æ¯ä¸€ä¸ªå…ƒç´ åˆå¯ä»¥æ˜¯å¤šç§å½¢å¼ï¼ŒåŒ…æ‹¬ object, reg, function, string é…ç½®å½¢å¼ã€‚ Object å½¢å¼ä¸€å®šæ˜¯key: value çš„ç»“æ„ï¼Œæ‰€ä»¥åƒ string å½¢å¼å°±ä¸å¯èƒ½å‡ºç°åœ¨ object å½¢å¼ä¸­ï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„æœ€å¤šã€‚ reg å°±ä¸ä»‹ç»äº†ï¼Œä¹Ÿå°±æ˜¯æ­£åˆ™åŒ¹é…çš„å½¢å¼ã€‚

    externals: [
        // â‘  objectå½¢å¼
        { 
            jquery: 'jQuery',
            a: false,                 // ä¸æ˜¯externalï¼Œé…ç½®é”™è¯¯
            b: true,                  // `module.exports = b`ï¼Œé€‚ç”¨äºä½ æ‰€å¼•ç”¨çš„åº“æš´éœ²å‡ºçš„å˜é‡å’Œä½ æ‰€ä½¿ç”¨çš„åº“çš„åç§°ä¸€è‡´çš„æƒ…å†µï¼Œæ¯”å¦‚moment
            "./c": "c",               // `module.exports = c`
            "./d": "var d",           // `module.exports = ./d` è¯­æ³•é”™è¯¯
            "./f": "commonjs2 ./a/b", // `module.exports = require("./a/b")`
            "./f": "commonjs ./a/b",  // ...å’Œ commonjs2ä¸€æ ·
            "./f": "this ./a/b",      // (function() { module.exports = this["./a/b"]; }())`
        },
        // abc -> require("abc")

        // â‘¡ regå½¢å¼
        /^[a-z\-0-9]+$/,

        // â‘¢ functionå½¢å¼
        function(context, request, callback) {
            // Every module prefixed with "global-" becomes external
            // "global-abc" -> abc
            if(/^global-/.test(request))
                return callback(null, "var " + request.substr(7));
            callback();
        },
        // â‘£ stringå½¢å¼
        "./e" // external ( require("./e") )
    ]


externals æ”¯æŒä»¥ä¸‹æ¨¡å—ä¸Šä¸‹æ–‡(module context)

- global - å¤–éƒ¨ library èƒ½å¤Ÿä½œä¸ºå…¨å±€å˜é‡ä½¿ç”¨ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡åœ¨ script æ ‡ç­¾ä¸­å¼•å…¥æ¥å®ç°ã€‚è¿™æ˜¯ externals çš„é»˜è®¤è®¾ç½®ã€‚
- commonjs - ç”¨æˆ·(consumer)åº”ç”¨ç¨‹åºå¯èƒ½ä½¿ç”¨ CommonJS æ¨¡å—ç³»ç»Ÿï¼Œå› æ­¤å¤–éƒ¨ library åº”è¯¥ä½¿ç”¨ CommonJS æ¨¡å—ç³»ç»Ÿï¼Œå¹¶ä¸”åº”è¯¥æ˜¯ä¸€ä¸ª CommonJS æ¨¡å—ã€‚
- commonjs2 - ç±»ä¼¼ä¸Šé¢å‡ è¡Œï¼Œä½†å¯¼å‡ºçš„æ˜¯ module.exports.defaultã€‚
- amd - ç±»ä¼¼ä¸Šé¢å‡ è¡Œï¼Œä½†ä½¿ç”¨ AMD æ¨¡å—ç³»ç»Ÿã€‚

### ä¸åŒç¯å¢ƒè®¾ç½® externals æ–¹å¼

å¦‚æœä½ çš„ä»£ç æƒ³è¿è¡Œåœ¨Nodeç¯å¢ƒä¸­ï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨ external ä¸­æ·»åŠ å‰ç¼€ commonjs2 æˆ–è€… commonjs

    externals:{
      react:'commonjs2 react',
      jquery:'commonjs2 jquery'
    }

å¦‚æœéœ€è¦requirejsç­‰ç¬¦åˆAMDè§„èŒƒçš„ç¯å¢ƒä¸­åŠ è½½ï¼Œé‚£å°±è¦æ·»åŠ  amd

    externals:{
      react:'amd React',
      jquery:'amd jQuery'
    }

å¦‚æœè¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œé‚£ä¹ˆä¸ç”¨æ·»åŠ ä»€ä¹ˆå‰ç¼€ï¼Œé»˜è®¤è®¾ç½®å°±æ˜¯ globalã€‚

    externals:{
      react:'React',
      jquery:'jQuery'
    }

ä¹Ÿå¯ä»¥è¿™æ ·

    externals:["React","jQuery"]

è¿™ç§æ–¹å¼é…ç½®ä¸‹ï¼Œå°±æ˜¯é…ç½®ä½ æ‰€å¼•ç”¨ä½ çš„åº“æš´éœ²å‡ºçš„å…¨å±€å˜é‡ã€‚ä¸Šé¢ä¸¤ç§æ¨¡å¼ä¸‹æˆ–è€…è¯´ï¼Œå¦‚æœä½ æƒ³è¿è¡Œä»£ç åœ¨æµè§ˆå™¨ä¸­ï¼Œä½ æ‰€å¼•ç”¨çš„åŒ…ï¼Œå¿…é¡»æš´éœ²å‡ºä¸€ä¸ªå…¨å±€å˜é‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¿™ç§æ–¹å¼ä¸é€‚åˆåœ¨æµè§ˆå™¨ä¸‹ä½¿ç”¨ï¼Œå¯ä»¥å°è¯• dll çš„æ–¹å¼ã€‚

è¿™é‡Œä½ å¯ä»¥çœ‹å‡ºï¼Œä¸åŒæ¨¡å¼ä¸‹ï¼Œvalueæ˜¯ä¸ä¸€æ ·çš„ã€‚2ï¼Œ3æ¨¡å¼ä¸‹ï¼Œæ˜¯è¦å¼•å…¥å»å…¨å±€å˜é‡ï¼Œ1æ¨¡å¼æ˜¯è¦åŠ è½½åŒ…åã€‚é‚£å¦‚æœè¿™ä¸ªåŒ…çš„åŒ…åå’Œåœ¨æµè§ˆå™¨ä¸‹å¼•å…¥çš„å…¨å±€å˜é‡ä¸€è‡´ï¼Œä¸Šé¢å°±å¯ä»¥å†™æˆä¸€æ ·äº†ï¼Œæ¯”å¦‚ momentã€‚

### externals å’Œ libraryTarget çš„å…³ç³»

- libraryTarget é…ç½®å¦‚ä½•æš´éœ² libraryã€‚å¦‚æœä¸è®¾ç½® library è¡¨ç¤ºä¸æš´éœ²ï¼Œæ¨¡å—å°±ç›¸å½“äºä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°
- externals æ˜¯å†³å®šçš„æ˜¯ä»¥å“ªç§æ¨¡å¼å»åŠ è½½æ‰€å¼•å…¥çš„é¢å¤–çš„åŒ…
- libraryTarget å†³å®šäº† library è¿è¡Œåœ¨å“ªä¸ªç¯å¢ƒï¼Œå“ªä¸ªç¯å¢ƒä¹Ÿå°±å†³å®šäº†ä½ å“ªç§æ¨¡å¼å»åŠ è½½æ‰€å¼•å…¥çš„é¢å¤–çš„åŒ…ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œexternals åº”è¯¥å’Œ libraryTarget ä¿æŒä¸€è‡´ã€‚library è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„ï¼Œä½ è®¾ç½® externals çš„æ¨¡å¼ä¸º commonjsï¼Œé‚£ä»£ç è‚¯å®šå°±è¿è¡Œä¸äº†äº†ã€‚å¦‚æœæ˜¯åº”ç”¨ç¨‹åºå¼€å‘ï¼Œä¸€èˆ¬æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒ libraryTarget å¯ä»¥ä¸è®¾ç½®ï¼Œexternals é»˜è®¤çš„æ¨¡å¼æ˜¯ globalï¼Œä¹Ÿå°±æ˜¯ä»¥å…¨å±€å˜é‡çš„æ¨¡å¼åŠ è½½æ‰€å¼•å…¥å¤–éƒ¨çš„åº“ã€‚







# ğŸš© OS ç³»ç»Ÿæ¨¡å—
- https://nodejs.org/docs/latest-v12.x/api/os.html
- https://nodejs.org/docs/latest-v14.x/api/os.html

æ­¤æ¨¡å—æä¾›å½“å‰ç¨‹åºè¿è¡Œç³»ç»Ÿçš„ä¿¡æ¯ï¼Œä»¥åŠå„ç§ä¿¡å·ã€é”™è¯¯çš„å¸¸é‡å®šä¹‰ã€‚

å½“å‰ç³»ç»Ÿå¹³å°ç±»å‹ 'aix', 'darwin', 'freebsd', 'linux', 'openbsd', 'sunos', 'win32'ï¼Œå¯ä»¥ä» platform() æ–¹æ³•è·å–ã€‚

os.cpus() è¿”å›ç³»ç»Ÿçš„ CPU åŠå„ä¸ªå†…æ ¸ä¿¡æ¯ï¼Œæ•°ç»„å¯¹è±¡ï¼ŒåŒ…å«çš„æˆå‘˜ï¼š

    model <string>
    speed <number> (in MHz)
    times <Object>
    user <number> The number of milliseconds the CPU has spent in user mode.
    nice <number> The number of milliseconds the CPU has spent in nice mode.
    sys <number> The number of milliseconds the CPU has spent in sys mode.
    idle <number> The number of milliseconds the CPU has spent in idle mode.
    irq <number> The number of milliseconds the CPU has spent in irq mode.

ä½¿ç”¨ top å‘½ä»¤å¯ä»¥çœ‹åˆ° CPU ç»Ÿè®¡ä¿¡æ¯ï¼š

    top - 02:22:40 up  9:48,  0 users,  load average: 0.52, 0.58, 0.59
    Tasks:  14 total,   1 running,  13 sleeping,   0 stopped,   0 zombie
    %Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.5 id,  0.0 wa,  0.1 hi,  0.0 si,  0.0 st
    MiB Mem :  16305.4 total,   6723.3 free,   9358.1 used,    224.0 buff/cache
    MiB Swap:  49152.0 total,  49005.2 free,    146.8 used.   6816.7 avail Mem 

      PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
        1 root      20   0    8936    268    224 S   0.0   0.0   0:00.17 init
      689 root      20   0    8952    228    180 S   0.0   0.0   0:00.01 init
      690 jeango    20   0   10656    632    604 S   0.0   0.0   0:00.01 sh
      691 jeango    20   0   10656    692    660 S   0.0   0.0   0:00.01 sh
      695 jeango    20   0   10656    664    632 S   0.0   0.0   0:00.01 sh
      697 jeango    20   0  986036  45468  19888 S   0.0   0.3   0:05.96 node
      721 jeango    20   0  898420  34248  13304 S   0.0   0.2   0:04.57 node
     1022 jeango    20   0 1168924  83996  44120 S   0.0   0.5   0:10.59 node
     1035 jeango    20   0   20572   6124   6024 S   0.0   0.0   0:00.33 bash
     1181 jeango    20   0  656720  99744  15716 S   0.0   0.6   0:04.34 node

å„ä¸ªå€¼çš„æ„æ€æ˜¯ï¼š

| ç¼©å†™ |        å«ä¹‰        |                          è¯´æ˜                         |
|------|--------------------|-------------------------------------------------------|
| `us` | user cpu time      | CPU time spent in user space                          |
| `sy` | system cpu time    | CPU time spent in kernel space                        |
| `ni` | user nice cpu time | CPU time spent on low priority processes              |
| `id` | idle cpu time      | CPU time spent idle                                   |
| `wa` | io wait cpu time   | CPU time spent in wait (on disk)                      |
| `hi` | hardware irq       | CPU time spent servicing/handling hardware interrupts |
| `si` | software irq       | CPU time spent servicing/handling software interrupts |
| `st` | steal time         | å³ CPU å·å–æ—¶é—´                                       |


CPU æ—¶é—´ç‰‡ï¼Œæ¯”å¦‚ä¸€ç§’å†…æœ‰ 100 ä¸ª CPU æ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡å°±æ˜¯ CPU å·¥ä½œçš„æœ€å°å•ä½ã€‚æ—¶é—´ç‰‡åœ¨ä¸åŒçš„åŒºåŸŸå’Œç›®çš„è¿›è¡Œæ“ä½œä½¿ç”¨ï¼Œå°±ä»£è¡¨è¿™ä¸ªåŒºåŸŸæ‰€å ç”¨çš„ CPU æ—¶é—´æ¯”ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå¾—å‡ºçš„ CPU æ—¶é—´ç™¾åˆ†æ¯”ã€‚

CPU å·å–æ—¶é—´ï¼Œæ˜¯ä¸“é—¨å¯¹è™šæ‹Ÿæœºæ¥è¯´çš„ï¼Œä¸€å°ç‰©ç†æ˜¯å¯ä»¥è™šæ‹ŸåŒ–å‡ºå‡ å°è™šæ‹Ÿæœºçš„ã€‚åœ¨å…¶ä¸­ä¸€å°è™šæ‹Ÿæœºä¸Šç”¨ top æŸ¥çœ‹å‘ç° st ä¸ä¸º 0ï¼Œå°±è¯´æ˜æœ¬æ¥æœ‰è¿™ä¹ˆå¤šä¸ª CPU æ—¶é—´æ˜¯å®‰æ’ç»™æˆ‘è¿™ä¸ªè™šæ‹Ÿæœºçš„ï¼Œä½†æ˜¯ç”±äºæŸç§è™šæ‹ŸæŠ€æœ¯ï¼ŒæŠŠè¿™ä¸ª CPU æ—¶é—´åˆ†é…ç»™å…¶ä»–çš„è™šæ‹Ÿæœºï¼Œè¿™å°±å«åšå·å–ã€‚

Steal time is the percentage of time a virtual CPU waits for a real CPU while the hypervisor is servicing another virtual processor.

å¦‚æœç¨‹åºéƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œé‚£ä¹ˆæ˜¯æ²¡æœ‰ hi å’Œ si æ—¶é—´çš„ï¼Œä½†æ˜¯å®é™…ä¸Šæœ‰ä¸ªç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­çš„æ¦‚å¿µã€‚æ¯”å¦‚ç¡¬ä¸­æ–­ï¼Œ CPU åœ¨æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œçªç„¶å¤–è®¾ç¡¬ä»¶ï¼ˆæ¯”å¦‚ç¡¬ç›˜å‡ºç°é—®é¢˜äº†ï¼‰æœºå™¨éœ€è¦ç«‹åˆ»é€šçŸ¥ CPU è¿›è¡Œç°åœºä¿å­˜å·¥ä½œã€‚è¿™ä¸ªæ—¶å€™ä¼š CPU ä¼šå‡ºç°ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±æ˜¯ CPU ä¼šæœ‰ä¸€éƒ¨åˆ†æ—¶é—´ä¼šè¢«ç¡¬ä¸­æ–­å ç”¨äº†ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯ hiã€‚ç›¸ç±»ä¼¼ï¼Œsi æ˜¯è½¯ä¸­æ–­çš„ CPU å ç”¨æ—¶é—´ï¼Œè½¯ä¸­æ–­æ˜¯ç”±è½¯ä»¶çš„æŒ‡ä»¤æ–¹å¼è§¦å‘çš„ã€‚

nice æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ¯ä¸ª Linux è¿›ç¨‹éƒ½æœ‰ä¸ªä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹æœ‰ä¼˜å…ˆæ‰§è¡Œçš„æƒåˆ©ï¼Œè¿™ä¸ªå«åš PRã€‚è¿›ç¨‹é™¤äº†ä¼˜å…ˆçº§å¤–ï¼Œè¿˜æœ‰ä¸ªä¼˜å…ˆçº§çš„ä¿®æ­£å€¼ã€‚å³æ¯”å¦‚ä½ åŸå…ˆçš„ä¼˜å…ˆçº§æ˜¯ 20ï¼Œç„¶åä¿®æ­£å€¼ä¸º -2ï¼Œè¿™ä¸ªä¿®æ­£å€¼å¯¹åº”çš„æ—¶é—´å°±å«åšè¿›ç¨‹çš„ nice cpu timeã€‚


OS API å‚è€ƒï¼š

- os.EOL
- os.arch()
- os.constants
- os.cpus()
- os.endianness()
- os.freemem()
- os.getPriority([pid])
- os.homedir()
- os.hostname()
- os.loadavg()
- os.networkInterfaces()
- os.platform()
- os.release()
- os.setPriority([pid, ]priority)
- os.tmpdir()
- os.totalmem()
- os.type()
- os.uptime()
- os.userInfo([options])
- os.version()


ä¿¡å·å¸¸é‡ os.constants.signals æœ‰è¿›ç¨‹å¯¹åº”çš„äº‹ä»¶å¤„ç†ï¼Œå¦‚ï¼š

    process.on('SIGINT', handle);
    process.on('SIGTERM', handle);

Windows ä¸æ”¯æŒéƒ¨åˆ†ä¿¡å·ï¼Œå¦‚ kill('SIGHUP') ç»“æŸè¿›ç¨‹å¯èƒ½å¯¼è‡´ ENOSYS é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ kill('SIGTERM')ã€‚


|     Constant    |                               Description                               |
|-----------------|-------------------------------------------------------------------------|
| SIGHUP          | è¡¨ç¤ºæ§åˆ¶ç»ˆç«¯å·²ç»å…³é—­ï¼Œæˆ–çˆ¶è¿›ç¨‹é€€å‡º                                      |
| SIGINT          | è¡¨ç¤ºç”¨æˆ·æœŸæœ›é€šè¿‡ Ctrl+C ç»“æŸè¿›ç¨‹                                        |
| SIGQUIT         | è¡¨ç¤ºç”¨æˆ·æœŸæœ›ç»“æŸè¿›ç¨‹ï¼Œå¹¶ä¸”æ‰§è¡Œ core dump.                               |
| SIGILL          | é€šçŸ¥è¿›ç¨‹å°è¯•åœ¨æ‰§è¡Œé”™è¯¯ã€æœªçŸ¥ã€æ¶æ„ã€ç‰¹æƒæŒ‡ä»¤ malformed, privileged      |
| SIGTRAP         | Sent to a process when an exception has occurred.                       |
| SIGABRT         | Sent to a process to request that it abort.                             |
| SIGIOT          | Synonym for SIGABRT                                                     |
| SIGBUS          | Sent to a process to notify that it has caused a bus error.             |
| SIGFPE          | è¡¨ç¤ºè¿›ç¨‹åœ¨æ‰§è¡Œé”™è¯¯çš„ç®—æœ¯è¿ç®—                                            |
| SIGKILL         | Sent to a process to terminate it immediately.                          |
| SIGUSR1 SIGUSR2 | Sent to a process to identify user-defined conditions.                  |
| SIGSEGV         | Sent to a process to notify of a segmentation fault.                    |
| SIGPIPE         | è¡¨ç¤ºè¿›ç¨‹å°è¯•å†™ä¸€ä¸ªæ–­å¼€çš„ç®¡é“                                            |
| SIGALRM         | Sent to a process when a system timer elapses.                          |
| SIGTERM         | Sent to a process to request termination.                               |
| SIGCHLD         | Sent to a process when a child process terminates.                      |
| SIGSTKFLT       | Sent to a process to indicate a stack fault on a coprocessor.           |
| SIGCONT         | Sent to instruct the operating system to continue a paused process.     |
| SIGSTOP         | Sent to instruct the operating system to halt a process.                |
| SIGTSTP         | Sent to a process to request it to stop.                                |
| SIGBREAK        | Sent to indicate when a user wishes to interrupt a process.             |
| SIGTTIN         | Sent to a process when it reads from the TTY while in the background.   |
| SIGTTOU         | Sent to a process when it writes to the TTY while in the background.    |
| SIGURG          | Sent to a process when a socket has urgent data to read.                |
| SIGXCPU         | Sent to a process when it has exceeded its limit on CPU usage.          |
| SIGXFSZ         | Sent to a process when it grows a file larger than the maximum allowed. |
| SIGVTALRM       | Sent to a process when a virtual timer has elapsed.                     |
| SIGPROF         | Sent to a process when a system timer has elapsed.                      |
| SIGWINCH        | Sent to a process when the controlling terminal has changed its size.   |
| SIGIO           | Sent to a process when I/O is available.                                |
| SIGPOLL         | Synonym for SIGIO                                                       |
| SIGLOST         | Sent to a process when a file lock has been lost.                       |
| SIGPWR          | Sent to a process to notify of a power failure.                         |
| SIGINFO         | Synonym for SIGPWR                                                      |
| SIGSYS          | Sent to a process to notify of a bad argument.                          |
| SIGUNUSED       | Synonym for SIGSYS                                                      |

Error å¸¸é‡ç”± os.constants.errno å¯¼å‡ºï¼ŒPOSIX å’Œ Windows å¹³å°ä¸‹çš„é”™è¯¯å¸¸é‡å‚è€ƒæ–‡æ¡£ã€‚

POSIX error constants

|     Constant    |                        Description                        |
|-----------------|-----------------------------------------------------------|
| E2BIG           | å‚æ•°åˆ—è¡¨è¶…å‡ºæœŸæœ›é•¿åº¦                                      |
| EACCES          | æ“ä½œæƒé™ä¸è¶³                                              |
| EADDRINUSE      | ç½‘ç»œåœ°å€å·²ç»è¢«ä½¿ç”¨                                        |
| EADDRNOTAVAIL   | ç½‘ç»œåœ°å€å½“å‰ä½¿ç”¨æ— æ•ˆ                                      |
| EAFNOSUPPORT    | ä¸æ”¯æŒçš„ network address family                           |
| EAGAIN          | å½“å‰æ²¡æœ‰æ•°æ®ï¼Œè¯·ç¨åå†è¯•                                  |
| EALREADY        | socket å·²ç»æœ‰æŒ‚èµ·çš„è¿æ¥                                   |
| EBADF           | Indicates that a file descriptor is not valid.            |
| EBADMSG         | Indicates an invalid data message.                        |
| EBUSY           | Indicates that a device or resource is busy.              |
| ECANCELED       | Indicates that an operation was canceled.                 |
| ECHILD          | Indicates that there are no child processes.              |
| ECONNABORTED    | Indicates that the network connection has been aborted.   |
| ECONNREFUSED    | Indicates that the network connection has been refused.   |
| ECONNRESET      | Indicates that the network connection has been reset.     |
| EDEADLK         | Indicates that a resource deadlock has been avoided.      |
| EDESTADDRREQ    | Indicates that a destination address is required.         |
| EDOM            | å‚æ•°è¶…å‡ºå‡½æ•°åŸŸ                                            |
| EDQUOT          | Indicates that the disk quota has been exceeded.          |
| EEXIST          | Indicates that the file already exists.                   |
| EFAULT          | Indicates an invalid pointer address.                     |
| EFBIG           | Indicates that the file is too large.                     |
| EHOSTUNREACH    | Indicates that the host is unreachable.                   |
| EIDRM           | Indicates that the identifier has been removed.           |
| EILSEQ          | Indicates an illegal byte sequence.                       |
| EINPROGRESS     | Indicates that an operation is already in progress.       |
| EINTR           | Indicates that a function call was interrupted.           |
| EINVAL          | Indicates that an invalid argument was provided.          |
| EIO             | Indicates an otherwise unspecified I/O error.             |
| EISCONN         | Indicates that the socket is connected.                   |
| EISDIR          | Indicates that the path is a directory.                   |
| ELOOP           | Indicates too many levels of symbolic links in a path.    |
| EMFILE          | Indicates that there are too many open files.             |
| EMLINK          | Indicates that there are too many hard links to a file.   |
| EMSGSIZE        | Indicates that the provided message is too long.          |
| EMULTIHOP       | Indicates that a multihop was attempted.                  |
| ENAMETOOLONG    | Indicates that the filename is too long.                  |
| ENETDOWN        | Indicates that the network is down.                       |
| ENETRESET       | ç½‘ç»œè¿æ¥å·²ç»ç»ˆæ­¢                                          |
| ENETUNREACH     | Indicates that the network is unreachable.                |
| ENFILE          | Indicates too many open files in the system.              |
| ENOBUFS         | Indicates that no buffer space is available.              |
| ENODATA         | stream è¯»å–é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯                                 |
| ENODEV          | Indicates that there is no such device.                   |
| ENOENT          | Indicates that there is no such file or directory.        |
| ENOEXEC         | Indicates an exec format error.                           |
| ENOLCK          | Indicates that there are no locks available.              |
| ENOLINK         | Indications that a link has been severed.                 |
| ENOMEM          | Indicates that there is not enough space.                 |
| ENOMSG          | Indicates that there is no message of the desired type.   |
| ENOPROTOOPT     | Indicates that a given protocol is not available.         |
| ENOSPC          | Indicates that there is no space available on the device. |
| ENOSR           | Indicates that there are no stream resources available.   |
| ENOSTR          | Indicates that a given resource is not a stream.          |
| ENOSYS          | Indicates that a function has not been implemented.       |
| ENOTCONN        | Indicates that the socket is not connected.               |
| ENOTDIR         | Indicates that the path is not a directory.               |
| ENOTEMPTY       | Indicates that the directory is not empty.                |
| ENOTSOCK        | Indicates that the given item is not a socket.            |
| ENOTSUP         | Indicates that a given operation is not supported.        |
| ENOTTY          | Indicates an inappropriate I/O control operation.         |
| ENXIO           | Indicates no such device or address.                      |
| EOPNOTSUPP      | socket ä¸æ”¯æŒçš„æ“ä½œï¼ŒLinux å¹³å°ä¸­å’Œ ENOTSUP ç›¸åŒ          |
| EOVERFLOW       | æº¢å‡ºï¼Œå­˜å‚¨çš„å€¼è¶…è¿‡æ•°æ®ç±»å‹æœ€å¤§å€¼                          |
| EPERM           | Indicates that the operation is not permitted.            |
| EPIPE           | Indicates a broken pipe.                                  |
| EPROTO          | Indicates a protocol error.                               |
| EPROTONOSUPPORT | Indicates that a protocol is not supported.               |
| EPROTOTYPE      | Indicates the wrong type of protocol for a socket.        |
| ERANGE          | Indicates that the results are too large.                 |
| EROFS           | Indicates that the file system is read only.              |
| ESPIPE          | Indicates an invalid seek operation.                      |
| ESRCH           | Indicates that there is no such process.                  |
| ESTALE          | Indicates that the file handle is stale.                  |
| ETIME           | Indicates an expired timer.                               |
| ETIMEDOUT       | Indicates that the connection timed out.                  |
| ETXTBSY         | Indicates that a text file is busy.                       |
| EWOULDBLOCK     | Indicates that the operation would block.                 |
| EXDEV           | Indicates an improper link.                               |

Windows-specific error constants#

|        Constant        |                        Description                        |
|------------------------|-----------------------------------------------------------|
| WSAEINTR               | Indicates an interrupted function call.                   |
| WSAEBADF               | Indicates an invalid file handle.                         |
| WSAEACCES              | æƒé™ä¸è¶³ï¼Œæ“ä½œå¤±è´¥                                        |
| WSAEFAULT              | Indicates an invalid pointer address.                     |
| WSAEINVAL              | Indicates that an invalid argument was passed.            |
| WSAEMFILE              | Indicates that there are too many open files.             |
| WSAEWOULDBLOCK         | Indicates that a resource is temporarily unavailable.     |
| WSAEINPROGRESS         | Indicates that an operation is currently in progress.     |
| WSAEALREADY            | Indicates that an operation is already in progress.       |
| WSAENOTSOCK            | Indicates that the resource is not a socket.              |
| WSAEDESTADDRREQ        | Indicates that a destination address is required.         |
| WSAEMSGSIZE            | Indicates that the message size is too long.              |
| WSAEPROTOTYPE          | Indicates the wrong protocol type for the socket.         |
| WSAENOPROTOOPT         | Indicates a bad protocol option.                          |
| WSAEPROTONOSUPPORT     | Indicates that the protocol is not supported.             |
| WSAESOCKTNOSUPPORT     | Indicates that the socket type is not supported.          |
| WSAEOPNOTSUPP          | Indicates that the operation is not supported.            |
| WSAEPFNOSUPPORT        | Indicates that the protocol family is not supported.      |
| WSAEAFNOSUPPORT        | Indicates that the address family is not supported.       |
| WSAEADDRINUSE          | Indicates that the network address is already in use.     |
| WSAEADDRNOTAVAIL       | Indicates that the network address is not available.      |
| WSAENETDOWN            | Indicates that the network is down.                       |
| WSAENETUNREACH         | Indicates that the network is unreachable.                |
| WSAENETRESET           | Indicates that the network connection has been reset.     |
| WSAECONNABORTED        | Indicates that the connection has been aborted.           |
| WSAECONNRESET          | Indicates that the connection has been reset by the peer. |
| WSAENOBUFS             | Indicates that there is no buffer space available.        |
| WSAEISCONN             | Indicates that the socket is already connected.           |
| WSAENOTCONN            | Indicates that the socket is not connected.               |
| WSAESHUTDOWN           | socket å·²ç»å…³é—­ä¸èƒ½å‘é€æ•°æ®ã€‚                             |
| WSAETOOMANYREFS        | Indicates that there are too many references.             |
| WSAETIMEDOUT           | Indicates that the connection has timed out.              |
| WSAECONNREFUSED        | Indicates that the connection has been refused.           |
| WSAELOOP               | Indicates that a name cannot be translated.               |
| WSAENAMETOOLONG        | Indicates that a name was too long.                       |
| WSAEHOSTDOWN           | Indicates that a network host is down.                    |
| WSAEHOSTUNREACH        | Indicates that there is no route to a network host.       |
| WSAENOTEMPTY           | Indicates that the directory is not empty.                |
| WSAEPROCLIM            | Indicates that there are too many processes.              |
| WSAEUSERS              | Indicates that the user quota has been exceeded.          |
| WSAEDQUOT              | Indicates that the disk quota has been exceeded.          |
| WSAESTALE              | Indicates a stale file handle reference.                  |
| WSAEREMOTE             | Indicates that the item is remote.                        |
| WSASYSNOTREADY         | Indicates that the network subsystem is not ready.        |
| WSAVERNOTSUPPORTED     | Indicates that the winsock.dll version is out of range.   |
| WSANOTINITIALISED      | WSAStartup æ‰§è¡Œå¤±è´¥                                       |
| WSAEDISCON             | Indicates that a graceful shutdown is in progress.        |
| WSAENOMORE             | Indicates that there are no more results.                 |
| WSAECANCELLED          | Indicates that an operation has been canceled.            |
| WSAEINVALIDPROCTABLE   | Indicates that the procedure call table is invalid.       |
| WSAEINVALIDPROVIDER    | Indicates an invalid service provider.                    |
| WSAEPROVIDERFAILEDINIT | æœåŠ¡ä¾›åº”è€…åˆå§‹åŒ–å¤±è´¥                                      |
| WSASYSCALLFAILURE      | Indicates a system call failure.                          |
| WSASERVICE_NOT_FOUND   | Indicates that a service was not found.                   |
| WSATYPE_NOT_FOUND      | Indicates that a class type was not found.                |
| WSA_E_NO_MORE          | Indicates that there are no more results.                 |
| WSA_E_CANCELLED        | Indicates that the call was canceled.                     |
| WSAEREFUSED            | Indicates that a database query was refused.              |

dlopen constants

|    Constant   |                              Description                               |
|---------------|------------------------------------------------------------------------|
| RTLD_LAZY     | Perform lazy binding. Node.js sets this flag by default.               |
| RTLD_NOW      | Resolve all undefined symbols in the library before dlopen(3) returns. |
| RTLD_GLOBAL   | ç¬¦å·å…¨å±€åŒ–ï¼Œç”±åº“å®šä¹‰çš„ç¬¦å·å¯ç”¨äºéšååŠ è½½çš„åº“çš„ç¬¦å·è§£æã€‚               |
| RTLD_LOCAL    | ç¬¦å·æœ¬åœ°åŒ–ï¼Œé»˜è®¤çš„ï¼ŒåŠ¨æ€åº“ä¸­å®šä¹‰çš„ç¬¦å·ä¸èƒ½è¢«å…¶åæ‰“å¼€çš„å…¶ä»–åº“é‡å®šä½ã€‚   |
| RTLD_DEEPBIND | è®©è‡ªåŒ…å«çš„åº“ä½¿ç”¨è‡ªå·±çš„ç¬¦å·å®šä¹‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å‰é¢åŠ è½½çš„åº“ã€‚               |

RTLD can be Run-time Load definition.

Priority constants

|        Constant       |                           Description                           |
|-----------------------|-----------------------------------------------------------------|
| PRIORITY_LOW          | å€¼ 19ï¼Œæœ€ä½ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows IDLE_PRIORITY_CLASS             |
| PRIORITY_BELOW_NORMAL | å€¼ 10ï¼Œæ­£å¸¸ç¨ä½ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows BELOW_NORMAL_PRIORITY_CLASS |
| PRIORITY_NORMAL       | å€¼  0ï¼Œæ­£å¸¸ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows NORMAL_PRIORITY_CLASS           |
| PRIORITY_ABOVE_NORMAL | å€¼ -7ï¼Œæ­£å¸¸ç¨é«˜ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows ABOVE_NORMAL_PRIORITY_CLASS |
| PRIORITY_HIGH         | å€¼ -14ï¼Œé«˜ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows HIGH_PRIORITY_CLASS              |
| PRIORITY_HIGHEST      | å€¼ -20ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¯¹åº” Windows REALTIME_PRIORITY_CLASS        |

libuv constants

- UV_UDP_REUSEADDR



# ğŸš© Worker Threads å·¥ä½œçº¿ç¨‹
- https://nodejs.org/docs/latest-v12.x/api/worker_threads.html
- https://github.com/microsoft/napajs
- https://v8docs.nodesource.com/node-0.8/d5/dda/classv8_1_1_isolate.html
- JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop http://www.ruanyifeng.com/blog/2014/10/event-loop.html
- [è¯‘]Deep Dive into Worker Threads in Node.js https://blog.csdn.net/u010862794/article/details/107519722
- JavaScript ä¸­çš„ Event Loop - Jake Archibald https://www.bilibili.com/video/BV1E441197g5

é¦–å…ˆæ˜ç¡® JavaScript å¹¶æ²¡æœ‰å¤šçº¿ç¨‹çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ Node.js çš„ Worker Threads å’Œå…¶ä»–æ”¯æŒå¤šçº¿ç¨‹çš„é«˜çº§è¯­è¨€åœ¨å¤„ç†ä¸Šæ˜¯ä¸ä¸€æ ·çš„ã€‚

Node.js é‡‡ç”¨äº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥ç¼–ç¨‹ï¼Œä¸ºç½‘ç»œæœåŠ¡è€Œè®¾è®¡ï¼Œé›†æˆäº†å„ç§å¸¸ç”¨çš„åŸºç¡€æ¨¡å—ï¼Œå¦‚é€šè¿‡ OpenSSL å®ç°çš„ Crypto å®‰å…¨æ¨¡å—ã€‚

å•çº¿ç¨‹ä¸‹çš„ Node.js ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼š

- ä¸€ä¸ªè¿›ç¨‹
- ä¸€ä¸ªçº¿ç¨‹
- ä¸€ä¸ªäº‹ä»¶å¾ªç¯
- ä¸€ä¸ª JavaScript å¼•æ“å®ä¾‹
- ä¸€ä¸ª Node.js å®ä¾‹

å¤šå·¥ç¨‹çº¿ç¨‹ä¸‹ Node.js ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼š

- ä¸€ä¸ªè¿›ç¨‹
- å¤šä¸ªå·¥ä½œçº¿ç¨‹
- æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯
- æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ª JavaScript å¼•æ“å®ä¾‹
- æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ª Node.js å®ä¾‹

ç†è§£ Node çš„åº•å±‚å¯¹äºç†è§£ Workers æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

![Node.js System](http://www.ruanyifeng.com/blogimg/asset/2014/bg2014100803.png)

æ¯ä¸ª Node.js ç¨‹åºå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Node.js ç¯å¢ƒã€‚

æ¯ä¸ªç¨‹åºè‡³å°‘åŒ…å«ä¸€ä¸ªè¿›ç¨‹ `Proces`ï¼Œè¿™æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œå¦‚å†…å­˜ã€æ–‡ä»¶èµ„æº/ç½‘ç»œå¥æŸ„ï¼Œè¿›ç¨‹ä¹Ÿæ˜¯ç¨‹åºè¿è¡Œçš„åŸºæœ¬ç»“æ„ã€‚æ¯ä¸ªè¿è¡Œçš„ç¨‹åºè‡³å°‘åŒ…å«ä¸€ä¸ªçº¿ç¨‹ `Thread`ï¼Œè¿™æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å•çº¿ç¨‹ç¨‹åºæ„å‘³ç€åœ¨å½“å‰è¿›ç¨‹ä¸­åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæŒ‡ä»¤åœ¨æ‰§è¡Œã€‚

`äº‹ä»¶å¾ªç¯` Event Loop æ˜¯ Node.js æ ¸å¿ƒæ¨¡å—ï¼Œå› ä¸ºæ•´ä¸ª Node.js åŸºäºäº‹ä»¶é©±åŠ¨ã€‚å°½ç®¡ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†é€šè¿‡ä½¿ç”¨å›è°ƒï¼Œpromises, async/await ç­‰è¯­æ³•ï¼ŒåŸºäºäº‹ä»¶å¾ªç¯å°†å¯¹æ“ä½œç³»ç»Ÿçš„æ“ä½œå¼‚æ­¥åŒ–ï¼Œä½¿å¾— Node æ‹¥æœ‰å¼‚æ­¥éé˜»å¡ IO çš„ç‰¹æ€§ã€‚

Node.js é›†æˆ Google v8 å¼•æ“è¿è¡Œ JavaScript è„šæœ¬ï¼Œä¸€ä¸ªå¼•æ“å®ä¾‹å³å¯ä»¥è¿è¡Œä¸€ä¸ª JavaScript ç¨‹åºã€‚

æ¢è¨€ä¹‹ï¼ŒNode è¿è¡Œåœ¨å•çº¿ç¨‹ä¸Šï¼Œå¹¶ä¸”åœ¨äº‹ä»¶å¾ªç¯ä¸­åŒæ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„ä»»åŠ¡ï¼ŒåŒä¸€æ—¶åˆ»åªä¼šæ‰§è¡Œä¸€æ®µä»£ç ã€‚è¿™æ˜¯éå¸¸æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™æ ·çš„æœºåˆ¶è¶³å¤Ÿç®€å•ï¼Œè®©ä½ åœ¨ä½¿ç”¨ JavaScript çš„æ—¶å€™æ— éœ€æ‹…å¿ƒå¹¶å‘ç¼–ç¨‹çš„é—®é¢˜ã€‚

ç”±äºå¤©ç”Ÿçš„å•çº¿ç¨‹ï¼ŒNode.js å‘æ¥éƒ½ä¸æ˜¯å®ç°é«˜ CPU å¯†é›†å‹åº”ç”¨çš„æœ€ä½³é€‰æ‹©ï¼Œå¯¹æ­¤é—®é¢˜ï¼Œå¤šæ–¹éƒ½æœ‰å°è¯•æä¾›è§£å†³æ–¹æ¡ˆï¼š

- ä½¿ç”¨ `child_process` æ¨¡å—åœ¨ä¸€ä¸ªå­è¿›ç¨‹ä¸­è¿è¡Œ CPU å¯†é›†å‹ä»£ç ï¼›
- ä½¿ç”¨ `cluster` æ¨¡å—åœ¨å¤šä¸ªè¿›ç¨‹ä¸­è¿è¡Œå¤šä¸ª CPU å¯†é›†å‹æ“ä½œï¼›
- ä½¿ç”¨ Microsoft Napa.js è¿™æ ·çš„åŸºäº Node.js Addon å®ç°çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼›
- Node.js v10.5.0 é€šè¿‡ `worker_threads` æ¨¡å—å¼•å…¥äº†å®éªŒæ€§çš„å·¥ä½œçº¿ç¨‹ Worker æ¦‚å¿µï¼Œå¹¶ä» Node.js v12 LTS èµ·æˆä¸ºä¸€ä¸ªç¨³å®šåŠŸèƒ½ã€‚

åœ¨ Worker å·¥ä½œçº¿ç¨‹æ–¹æ¡ˆä¹‹å‰ï¼ŒNode.js ä¸­æœ‰å¤šç§æ–¹å¼æ‰§è¡Œ CPU å¯†é›†å‹åº”ç”¨çš„æ–¹å¼éƒ½æ²¡æœ‰è¢«å¹¿æ³›æ¥æ”¶ã€‚å¯èƒ½æ˜¯å—é™äºæ€§èƒ½ã€é¢å¤–å¼•å…¥çš„å¤æ‚æ€§ã€å æœ‰ç‡ä½ã€è–„å¼±çš„æ–‡æ¡£åŒ–ç­‰ç­‰ã€‚

å°½ç®¡ worker_threads å¯¹äº JavaScript çš„å¹¶å‘é—®é¢˜æ¥è¯´æ˜¯ä¸€ä¸ªä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ JavaScript å¼•æ“æœ¬èº«å¹¶æ²¡æœ‰å¼•è¿›å¤šçº¿ç¨‹è¯­è¨€ç‰¹æ€§ã€‚å®é™…ä¸Šï¼Œworker_threads æ˜¯é€šè¿‡è¿è¡Œå¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œçˆ¶å­ workers é€šè¿‡ Node.js æ¥é€šä¿¡ã€‚æ¯ä¸ª worker æœ‰ä»–è‡ªå·±çš„ V8 å®ä¾‹å’Œ Event Loopï¼Œå’Œå­è¿›ç¨‹ä¸åŒï¼Œworkers å¯ä»¥å…±äº«å†…å­˜ã€‚

```
const {Worker, isMainThread, parentPort, workerData} = require('worker_threads');
if (isMainThread) {
  const worker = new Worker(__filename, {"workerData": {num: 5}});
  worker.once('message', (result) => {
    console.log('square of 5 is :', result);
  })
} else {
  parentPort.postMessage(workerData.num * workerData.num)
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡ `workerData` å‘å·¥ä½œçº¿ç¨‹ä¼ é€’ä¸€ä¸ªæ•°å­—ï¼Œè®©å…¶æ¥è®¡ç®—å…¶å¹³æ–¹å€¼ã€‚åœ¨å®Œæˆè®¡ç®—åï¼Œå°†ç»“æœå‘é€ç»™ MainThreadã€‚

æ¯ä¸€ä¸ª worker éƒ½é€šè¿‡ä¸€ä¸ª MessageChannel æ¥å’Œå¦å¤–ä¸€æ–¹é€šä¿¡ï¼Œ`postMessage()` å°†ä¿¡æ¯å†™å…¥ä¿¡é“çš„ä¸€ç«¯ï¼Œç„¶åä¼ é€’åˆ°é€šé“çš„å¦ä¸€ç«¯å£ã€‚ä¸€ä¸ªä¿¡é“æœ‰ä¸¤ä¸ª portsï¼Œä¿¡é“çš„ä¸¤ç«¯å°±ç®€å•çš„å«åš port1 å’Œ port2ï¼Œå¾€å…¶ä¸­ä¸€ç«¯å†™å…¥ä¿¡æ¯ï¼Œåœ¨å¦ä¸€ç«¯å°±æœ‰ä¿¡æ¯äº‹ä»¶æ¥æ¥æ”¶ä¿¡æ¯ã€‚

```
const {MessageChannel} = require("worker_threads")
const {port1, port2} = new MessageChannel
port1.on("message", console.log)
port1.postMessage("Hi form 1");
port2.on("message", console.log)
port2.postMessage("Hi form 2");
```

JavaScript æœ¬èº«å¹¶ä¸æ”¯æŒå¹¶è¡Œï¼Œé‚£ä¹ˆä¸¤ä¸ª workers æ˜¯å¦‚ä½•å¹¶è¡Œæ‰§è¡Œçš„å‘¢ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ V8 Isolates ç±»å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Chrome V8 è¿è¡Œå®ä¾‹ï¼Œå…¶æœ‰ç‹¬ç«‹çš„ Heap å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™ä¸ºæ¯ä¸€ä¸ª worker ç‹¬ç«‹è¿è¡Œæä¾›äº†ä¿éšœã€‚å…¶ç¼ºé™·å°±æ˜¯ï¼Œworkers ä¹‹é—´æ²¡æ³•ç›´æ¥è®¿é—®å¯¹æ–¹çš„å †ï¼Œç”±äºè¿™ä¸ªåŸå› ï¼Œæ¯ä¸ª worker éƒ½æœ‰å…¶è‡ªå·±çš„ Event Loopã€‚

Worker çš„å®ç°é€šè¿‡ worker_threads æ¨¡å—æš´éœ²åœ¨äº† JavaScript çš„ç”¨æˆ·ç©ºé—´ï¼Œåˆ†æˆä¸¤éƒ¨åˆ†å†…å®¹ï¼š

- Worker åˆå§‹åŒ–è„šæœ¬ - è®¾ç½® workers ä¹‹é—´çš„ä¿¡é“è®¾ç½®ï¼Œä½¿å¾— parent worker å¯ä»¥å°† metadata ä¼ é€’ç»™ child workerã€‚
- Worker æ‰§è¡Œè„šæœ¬ - è´Ÿè´£ä½¿ç”¨ç”¨æˆ·æä¾›çš„ workerData å’Œ parent worker æä¾›çš„ metadata æ¥æ‰§è¡Œç”¨æˆ·çš„è„šæœ¬ã€‚


Worker Threads æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

- ArrayBuffers å¯ä»¥å°†å†…å­˜ä¸­çš„å˜é‡ä»ä¸€ä¸ªçº¿ç¨‹è½¬åˆ°å¦å¤–ä¸€ä¸ªã€‚
- SharedArrayBuffer å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«å†…å­˜ä¸­çš„å˜é‡ï¼Œä½†æ˜¯é™åˆ¶ä¸ºäºŒè¿›åˆ¶æ ¼å¼çš„æ•°æ®ã€‚
- å¯ç”¨çš„åŸå­æ“ä½œï¼Œå¯ä»¥è®©ä½ æ›´æœ‰æ•ˆç‡åœ°åŒæ—¶æ‰§è¡ŒæŸäº›æ“ä½œå¹¶ä¸”å®ç°ç«æ€å˜é‡
- æ¶ˆæ¯ç«¯å£ï¼Œç”¨äºå¤šä¸ªçº¿ç¨‹é—´é€šä¿¡ã€‚å¯ä»¥ç”¨äºå¤šä¸ªçº¿ç¨‹é—´ä¼ è¾“ç»“æ„åŒ–çš„æ•°æ®ï¼Œå†…å­˜ç©ºé—´
- æ¶ˆæ¯é€šé“å°±åƒå¤šçº¿ç¨‹é—´çš„ä¸€ä¸ªå¼‚æ­¥çš„åŒå‘é€šä¿¡é€šé“ã€‚
- WorkerData æ˜¯ç”¨äºä¼ è¾“å¯åŠ¨æ•°æ®ã€‚åœ¨å¤šä¸ªçº¿ç¨‹é—´ä½¿ç”¨ postMessgae è¿›è¡Œä¼ è¾“çš„æ—¶å€™ï¼Œæ•°æ®ä¼šè¢«å…‹éš†ï¼Œå¹¶å°†å…‹éš†çš„æ•°æ®ä¼ è¾“åˆ°çº¿ç¨‹çš„ contructor ä¸­ã€‚

API å‚è€ƒï¼š

- worker.isMainThread
- worker.markAsUntransferable(object)
- worker.moveMessagePortToContext(port, contextifiedSandbox)
- worker.parentPort
- worker.receiveMessageOnPort(port)
- worker.resourceLimits
- worker.SHARE_ENV
- worker.threadId
- worker.workerData
- Class: MessageChannel
- Class: MessagePort extends <EventEmitter>
    - Event: close()
    - Event: message( value:any )
    - Event: messageerror( err )
    - port.close()
    - port.postMessage(value[, transferList])
    - port.ref()
    - port.start()
    - port.unref()
- Class: Worker extends <EventEmitter>
    - new Worker(filename[, options])
    - Event: error( err )
    - Event: exit( exitCode  )
    - Event: message( value:any )
    - Event: messageerror(err )
    - Event: online( )
    - worker.getHeapSnapshot()
    - worker.postMessage(value[, transferList])
    - worker.ref()
    - worker.resourceLimits
    - worker.stderr
    - worker.stdin
    - worker.stdout
    - worker.terminate()
    - worker.threadId
    - worker.unref()



# ğŸš© Atomics åŸå­æ“ä½œ
- https://tc39.es/ecma262/#sec-atomics-object
- https://nodejs.org/docs/latest-v12.x/api/worker_threads.html
- JavaScript å¤šçº¿ç¨‹ç¼–ç¨‹ https://zhuanlan.zhihu.com/p/148492451
- libuv æ¼«è°ˆä¹‹çº¿ç¨‹ https://zhuanlan.zhihu.com/p/25973650
- Nodejs cluster æ¨¡å—æ·±å…¥æ¢ç©¶ https://segmentfault.com/a/1190000010260600
- https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
- https://github.com/lars-t-hansen/js-lock-and-condition/blob/master/lock.js
- https://github.com/lars-t-hansen/js-lock-and-condition/blob/master/async-lock.js
- https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics
- https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask
- https://github.com/zloirock/core-js/blob/v3.2.1/packages/core-js/modules/web.queue-microtask.js
- Futexes Are Tricky - Ulrich Drepper https://akkadia.org/drepper/futex.pdf
- https://docs.microsoft.com/en-us/windows/win32/sync/synchronization-objects
- https://es6.ruanyifeng.com/#docs/arraybuffer#Atomics-%E5%AF%B9%E8%B1%A1
- Operating Systems Internals an Priciples 9th - CH5 Concurrency: Mutual Exclusion and Synchronization
- Thinking in Java 4th - Concurrency

å®ç° sleep åŠŸèƒ½å¯ä»¥é€šè¿‡ setTimeout() requestAnimationFrame() æˆ–è€…ä½¿ç”¨ queueMicrotask() Promise å¾®ä»»åŠ¡æ–¹å¼å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¾ªç¯ç©ºè½¬æ¥è§£å†³ã€‚æœ¬è´¨ä¸Šæ‰§è¡Œçš„çº¿ç¨‹å¹¶æ²¡æœ‰çœŸæ­£çš„ sleepï¼Œäº‹ä»¶å¾ªç¯ä»¥åŠ v8 ä»åœ¨è¿è¡Œï¼Œè€Œç©ºè½¬çš„å®ç°åˆ™æ— ç–‘å®åœ¨æµªè´¹ CPU æ€§èƒ½ï¼Œæœ‰ç‚¹ç±»ä¼¼è‡ªæ—‹é”ï¼Œä¸ç¬¦åˆå¤§å¤šæ•°åœºæ™¯ã€‚

å‚è€ƒä»¥ä¸‹ä»£ç ï¼š

```
setTimeout(() => {
    console.log('setTimeout');
}, 0);

Promise.resolve().then(() => {
    console.log('PromiseTask');
}); 

queueMicrotask(() => {
    console.log('queueMicrotask');
}); 

// queueMicrotask
// PromiseTask
// setTimeout
```

æ— è®ºé¡ºåºå¦‚ä½•ï¼ŒsetTimeout ä»»åŠ¡æ€»æ˜¯åœ¨å¾®ä»»åŠ¡åé¢æ‰§è¡Œã€‚è€Œ Promise å’Œ queueMicrotask ä¸¤è€…åˆ™æ˜¯è°åœ¨å‰é¢è°å…ˆæ‰§è¡Œï¼Œå’Œ process.nextTick æ˜¯ç±»ä¼¼çš„ã€‚

ä¸åŒç±»å‹çš„ä»»åŠ¡åœ¨ Event Loop å¾ªç¯ä¸­æ‰§è¡Œçš„å·®åˆ«ï¼š

- Tasks æ¶ˆæ¯é˜Ÿåˆ—åœ¨æ¯ä¸ª Event Loop å¾ªç¯ä¸­åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä¸‹ä¸€ä¸ªæ¢ä¸‹ä¸€è½®æ‰§è¡Œï¼› 
- Animation Callbacks RAF é˜Ÿåˆ—åœ¨æ¯ä¸ª Event Loop å¾ªç¯ä¸­å°†å½“å‰é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œï¼Œåé¢æ·»åŠ çš„ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€è½®æ‰§è¡Œï¼› 
- Microtask é˜Ÿåˆ—åªè¦æœ‰ä»»åŠ¡ï¼ŒEvent Loop å½“ä¸‹å°±ä¼šæ‰§è¡Œå®Œå†è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œå¦‚æœæŒç»­åœ¨å¾€é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ä¼šå¯¼è‡´äº‹ä»¶ç¯å¡åœ¨å¾®ä»»åŠ¡çš„æ‰§è¡Œä¸­ï¼›

æš´éœ² queueMicrotask API çš„ç›®çš„ï¼š

- æä¾›åº•å±‚ API åŠŸèƒ½æ”¯æŒï¼›
- æ›´æœ‰æ•ˆç‡çš„è¿è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿè¿è¡Œï¼Œé¿å…èµ„æºæµªè´¹ï¼Œæ¯”å¦‚ Promise ä¼šè¿”å›ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè€Œç›´æ¥ queueMicrotask åˆ™ä¸ä¼šï¼›
- æ›´å¥½çš„è¯­ä¹‰æ€§ï¼ŒåŒæ—¶å¸®åŠ©å¼€å‘è€…ç†è§£è¿™äº›ä¸åŒå¼‚æ­¥ä»»åŠ¡ä¹‹é—´çš„åŒºåˆ«ï¼›

æ³¨æ„ï¼Œå¯èƒ½ä¼šæ„å¤–æ— é™åˆ¶åœ°æŒ‡æ´¾å¾®ä»»åŠ¡ï¼Œä»¥è‡´æ­»å¾ªç¯ã€‚å¦‚æœæµè§ˆå™¨çš„å¾®ä»»åŠ¡é˜Ÿåˆ—å§‹ç»ˆå¤„äºéç©ºçŠ¶æ€ï¼Œè¿™å°†å¯¼è‡´æ§åˆ¶æƒå§‹ç»ˆæ— æ³•äº¤è¿˜ç»™æµè§ˆå™¨è¿›è¡Œä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œç„¶åå®ƒå°±å¡æ­»äº†ã€‚

å¦‚ä¸‹é¢çš„ä»£ç ï¼š

    function deadloop(fn) {
        queueMicrotask(() => deadloop(fn))
    }

    deadloop(()=>{})

åœ¨ ECMA-262 å‡ºç°ä¹‹åå¼€å§‹æœ‰äº†è½¬æœºï¼Œå®ƒå¼•å…¥ Atomics å¯¹è±¡ï¼Œæä¾› wait() è®©è„šæœ¬å¼•æ“é™·å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶è¿›å…¥çœŸæ­£çš„ sleepï¼Œç›´åˆ° notify() æˆ–è€…è¶…æ—¶ï¼Œè¯¥è§„èŒƒç‰¹æ€§åœ¨ Node 8.10.0+ å®ç°ã€‚

Atomics å¯¹è±¡ä¿è¯æ‰€æœ‰å…±äº«å†…å­˜çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼ŒåŸå­æ€§æ“ä½œåœ¨ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­è¡¨ç¤ºå•æ¡æŒ‡ä»¤çš„æ“ä½œï¼Œè¿™èƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

äº‹å®ä¸Šï¼ŒAtomics çš„å‡ºç°ä¸»è¦è§£å†³ worker ä¹‹é—´æ•°æ®åŒæ­¥çš„é—®é¢˜ï¼Œweb-worker åœ¨ Node 12 æ­£å¼çº³å…¥åˆ° worker-threads æ¨¡å—ï¼Œè¿™äº›éƒ½æ˜¯ ECMAScript å¤šçº¿ç¨‹æ¨¡å‹çš„å…·ä½“å®ç°ã€‚å¤šçº¿ç¨‹å¿…ç„¶éœ€è¦åŒæ­¥æœºåˆ¶ï¼Œè€Œ Atomics.wait() å’Œ notify() å°±æ˜¯è§£å†³æ–¹æ¡ˆã€‚

åˆ©ç”¨ Atomics.wait() çš„ç­‰å¾…è¶…æ—¶æœºåˆ¶å®ç° sleep æ–¹æ³•ï¼š

```
let sab = new SharedArrayBuffer(4);
let i32a = new Int32Array(sab);

let sleep = function(seconds){
  // setTimeout(() => {
  //   Atomics.notify(i32a, 0)
  // }, seconds * 1000);
  Atomics.wait(i32a, 0, 0, seconds * 1000);
}

console.log("Sleep 1 seconds.");
sleep(1);
console.log("Done.");
```

æ³¨æ„ï¼Œwait() æ˜¯åŒæ­¥æ–¹æ³•ï¼Œä¼šé˜»å¡æ‰§è¡Œçº¿ç¨‹ï¼Œå› æ­¤å¯ä»¥æµ‹è¯•åˆ° setTimeout ä»»åŠ¡å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œé™¤éç”¨å…¶å®ƒçº¿æ‰§è¡Œ notify()ã€‚

ç¤ºèŒƒå¤šçº¿ç¨‹ä¸­ä½¿ç”¨åŸå­æ“ä½œï¼š

```
const { exit } = require('process');
let { Worker, isMainThread, parentPort, workerData } = require('worker_threads');
var sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT);
var int32 = new Int32Array(sab);

let newWorker = ()=>{
  const  worker  =  new Worker(__filename, { workerData: sab });
  worker.on('error', console.error);
  worker.on('message', (data) => {
    console.log('Roger that:', data, int32);
  });
  worker.on('exit', (code) => {
    if (code !==  0)
      console.error(new  Error(`worker exit ${code}`));
  });
}

if (isMainThread) {
  let threads = [1, 2, 3, 4, 5];
  threads.map(newWorker);
  threads.map((val)=>{
    let out = Atomics.wait(int32, 0, val-1);
    console.log("Master", val, int32[0], out); // Not a atomics reading
  });
  console.log("Master done", int32[0]);
} else {
  let buf = workerData;
  let int32 = new Int32Array(buf);
  Atomics.add(int32, 0, 1);
  let value = Atomics.load(int32, 0);
  parentPort.postMessage({msg:"+1", value});
  Atomics.notify(int32, 0, 1);
}
```

worker_threads å·¥ä½œçº¿ç¨‹çš„åˆ›å»ºä¸åŒäº C/Javaï¼Œå®ƒä½¿ç”¨ libuv `uv_thread_create()` åˆ›å»ºçº¿ç¨‹ï¼Œä¹‹å‰éœ€è¦è¿›è¡Œ MessagePortã€v8 å®ä¾‹è®¾ç½®ç­‰ï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ“ä½œï¼Œéœ€è¦ç»“åˆåœºæ™¯é…Œæƒ…ä½¿ç”¨ã€‚

å¤šçº¿ç¨‹ç¨‹åºé€šå¸¸æ¶‰åŠ thread safty é—®é¢˜ï¼Œå³å¹¶å‘çš„å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªæ•°æ®å¯¹è±¡æ—¶ï¼Œä¸è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹çš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„åè°ƒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£è¿™ä¸ªå¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

æ¯”å¦‚ï¼Œåœ¨å¤šçº¿ç¨‹è¿è¡ŒçŠ¶æ€ä¸‹çš„é“¶è¡Œè´¦æˆ·å°±éœ€è¦çº¿ç¨‹å®‰å…¨ç‰¹æ€§ï¼Œå¦åˆ™å°±ä¼šå¯¹ä¸ä¸Šè´¦ç›®ã€‚

å¦‚ A çº¿ç¨‹è¦å‘è´¦æˆ·è½¬å…¥ 100ï¼Œè€Œ B çº¿ç¨‹è¦ä»è´¦æˆ·åˆ’èµ° 100ï¼Œåœ¨çº¿ç¨‹ä¸å®‰å…¨çš„æ¡ä»¶ä¸‹ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

- A çº¿ç¨‹å…ˆè¯»å–äº†è´¦æˆ·ä½™é¢ xï¼Œè€Œ B ä¹Ÿéšåè¯»å–ä½™é¢ï¼›
- A çº¿ç¨‹æ‰§è¡Œ x + 100 å†™å…¥è´¦æˆ·ï¼›
- B çº¿ç¨‹æ‰§è¡Œ x - 100 å†™å…¥è´¦æˆ·ï¼›
- æœ€åï¼Œè´¦æˆ·åªæœ‰ x - 100ï¼Œå·®äº† 100 å…¥è´¦ï¼›

è€Œçº¿ç¨‹å®‰å…¨éœ€è¦ç¡®ä¿è¯»å†™é€»è¾‘åœ¨æ—¶é—´ä¸Šæ­£ç¡®ï¼Œå³éœ€è¦çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œæ ¹æ®è¯»å†™åœºæ™¯çš„ä¸åŒï¼Œå¯ä»¥æœ‰å¤šç§æœºåˆ¶å®ç°ã€‚

Windows å¹³å°ä¸‹çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼š

- ä¸´ç•ŒåŒºï¼ˆCritical Sectionï¼‰
- äº’æ–¥é‡ï¼ˆMutexï¼‰
- ä¿¡å·é‡ï¼ˆSemaphoreï¼‰
- äº‹ä»¶ï¼ˆEventï¼‰

ä¸´ç•ŒåŒºé€šè¿‡å¯¹å¤šçº¿ç¨‹ä¸²è¡ŒåŒ–æ¥è®¿é—®å…¬å…±èµ„æºæˆ–ä¸€æ®µä»£ç ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆæ§åˆ¶æ•°æ®è®¿é—®ã€‚åœ¨ä»»æ„æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®å…¬å…±èµ„æºï¼Œé‚£ä¹ˆåœ¨æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åï¼Œå…¶ä»–è¯•å›¾è®¿é—®å…¬å…±èµ„æºçš„çº¿ç¨‹å°†è¢«æŒ‚èµ·ï¼Œå¹¶ä¸€ç›´ç­‰åˆ°è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ç¦»å¼€ï¼Œä¸´ç•ŒåŒºåœ¨è¢«é‡Šæ”¾åï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥æŠ¢å ã€‚

äº’æ–¥é‡é‡‡ç”¨äº’æ–¥å¯¹è±¡æœºåˆ¶ï¼Œæ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰æœ‰è®¿é—®å…¬å…±èµ„æºçš„æƒé™ï¼Œä¿è¯å…¬å…±èµ„æºä¸ä¼šåŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ã€‚äº’æ–¥ä¸ä»…èƒ½å®ç°åŒä¸€åº”ç”¨ç¨‹åºçš„å…¬å…±èµ„æºå®‰å…¨å…±äº«ï¼Œè¿˜èƒ½å®ç°ä¸åŒåº”ç”¨ç¨‹åºçš„å…¬å…±èµ„æºå®‰å…¨å…±äº«ã€‚

ä¿¡å·é‡å…è®¸å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»è®¿é—®åŒä¸€èµ„æºï¼Œä½†æ˜¯éœ€è¦é™åˆ¶åœ¨åŒä¸€æ—¶åˆ»è®¿é—®æ­¤èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°ç›®ã€‚

äº‹ä»¶æœºåˆ¶é€šè¿‡é€šçŸ¥æ“ä½œçš„æ–¹å¼æ¥ä¿æŒçº¿ç¨‹çš„åŒæ­¥ï¼Œè¿˜å¯ä»¥æ–¹ä¾¿å®ç°å¯¹å¤šä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§æ¯”è¾ƒçš„æ“ä½œã€‚

äº’æ–¥é‡çš„å®ç°é€šå¸¸ç§°ä¸º Look å¯¹è±¡ï¼Œè€Œé”çš„å®ç°éœ€è¦ä¾èµ–äºå…¨å±€å˜é‡ï¼Œä½¿ç”¨ SharedArrayBuffer å°±å¯ä»¥åœ¨ workers ä¹‹é—´å…±äº«æ•°æ®ã€‚æœ‰äº†å…±äº«çš„å†…å­˜ï¼Œè¿˜éœ€è¦è§£å†³åœ¨ Workers ä¹‹é—´å®‰å…¨å…±äº«é—®é¢˜ï¼Œrace onditionsï¼Œä¹Ÿå°±æ˜¯èµ„æºç«äº‰çš„é—®é¢˜ã€‚

å½“ç„¶ä½¿ç”¨ Atomics è¿›è¡Œçº¿ç¨‹å®‰å…¨æ“ä½œï¼Œä½†æ˜¯æ›´åˆç†çš„ç›®æ ‡æ˜¯çš„ç»„åˆ Atomics å¼€å‘å‡ºåƒ Golang Synchronization Primitives ä¸€æ ·çš„ APIã€‚å‚è€ƒ Mozzila å·¥ç¨‹å¸ˆ Lars T Hansen æä¾›çš„ Mutex å’Œ Cond å®ç°ã€‚

Mutex ä¸€èˆ¬æä¾›é”å®šå’Œè§£é”åŠŸèƒ½ï¼Œå¯ä»¥ä¿è¯ lock() å’Œ unlock() ä¹‹é—´çš„ä»£ç ä»£ç ä¸ä¼šè¢«æ‰“æ–­ï¼Œå®ƒå¯ä»¥çœ‹ä½œæœ‰ä¸‰ä¸ªçŠ¶æ€çš„çŠ¶æ€æœºï¼š

- `UNLOCK`: æœªé”å®šï¼Œæ‰§è¡Œ unlock() å¹¶ä¸”æ²¡æœ‰çº¿ç¨‹ç­‰å¾…æ—¶è½¬æ¢ä¸ºæœªé”å®šçŠ¶æ€ï¼›
- `LOCKED`: è¢«é”å®šï¼Œä½¿ç”¨ lock() è½¬å˜ä¸ºé”å®šçŠ¶æ€ï¼Œå¹¶ä¸”ç­‰å¾…çº¿ç¨‹æ•°é‡è®°å½•åŠ  1ï¼›
- `WAITED`: è¢«é”å®šï¼Œä¸”å¤§äºç­‰äº 1 ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…è¯¥é”ï¼›

Cond åŸºäº Mutex å®ç°çš„ï¼Œå®ƒçš„å¤§è‡´åŠŸèƒ½æ˜¯æŒæœ‰é”çš„æƒ…å†µä¸‹å¯è¿›è¡Œä¸¤ç§æ“ä½œï¼š

- wait(): æœ¬çº¿ç¨‹è¿›åº¦è¿›å…¥ç­‰å¾…æ€ï¼Œå¹¶ä¸”è¢«å”¤é†’çš„æ—¶å€™é‡æ–°æŒæœ‰é”ã€‚
- notifyOne(): å”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰å¾…æ€çš„çº¿ç¨‹ã€‚

Cond çŠ¶æ€è½¬æ¢ï¼š

- `NORMAL`: éç­‰å¾…æ€ï¼Œè°ƒç”¨ wait() è½¬åŒ–ä¸º WAITED çŠ¶æ€ã€‚
- `WAITED`: ç­‰å¾…æ€ï¼Œè°ƒç”¨ notifyOne() å”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…æ€çš„çº¿ç¨‹è½¬æ¢ä¸º NORMAL çŠ¶æ€ï¼Œå¹¶ä¸”é‡æ–°æŒæœ‰é”ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚


å®ç°ä¸€ä¸ªå…¬å¹³ã€æ’å®ƒã€ä¸å¯é‡å…¥é”ï¼Œéœ€è¦ä½¿ç”¨ Atomics.wait/notify/compareExchange æ¥å®ç°çº¿ç¨‹åŒæ­¥ã€‚

```
function Lock(sab, loc) {
    // _checkParameters(sab, loc, Lock, "Lock constructor");
    this._iab = new Int32Array(sab); // View the whole thing so we can share with Cond
    this._ibase = loc >>> 2;
}

Lock.prototype.lock = function () {
    const iab = this._iab;
    const stateIdx = this._ibase;
    let c;
    if ((c = Atomics.compareExchange(iab, stateIdx, 0, 1)) != 0) {
        do {
            if (c == 2 || Atomics.compareExchange(iab, stateIdx, 1, 2) != 0)
                Atomics.wait(iab, stateIdx, 2);
        } while ((c = Atomics.compareExchange(iab, stateIdx, 0, 2)) != 0);
    }
}

Lock.prototype.tryLock = function () {
    const iab = this._iab;
    const stateIdx = this._ibase;
    return Atomics.compareExchange(iab, stateIdx, 0, 1) == 0;
}

Lock.prototype.unlock = function () {
    const iab = this._iab;
    const stateIdx = this._ibase;
    let v0 = Atomics.sub(iab, stateIdx, 1);
    // Wake up a waiter if there are any
    if (v0 != 1) {
        Atomics.store(iab, stateIdx, 0);
        Atomics.notify(iab, stateIdx, 1);
    }
}
```

compareExchange() è¿™ä¸ªåŸå­æ“ä½œæ–¹æ³•ä¿è¯åœ¨ä¿®æ”¹åçš„å€¼è¢«å†™å›ä¹‹å‰ä¸ä¼šå‘ç”Ÿå…¶ä»–å†™æ“ä½œï¼ŒåŒæ—¶å®ŒæˆæŒ‡å®šä½ç½®å€¼çš„æ¯”è¾ƒï¼Œåªæœ‰åœ¨æŒ‡å®šä½ç½®çš„å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰çš„æ—¶å€™æ‰å†™å…¥æ–°å€¼ã€‚

åœ¨ lock() æ–¹æ³•ä¸­ï¼Œé€šè¿‡è¿”å›å€¼æ˜¯åˆ¤æ–­åŠ é”çŠ¶æ€ï¼š

- 0 æœªåŠ é”ï¼Œå½“å‰è¿›ç¨‹å¯ä»¥è·å¾—é”ï¼Œè®¾ç½®çŠ¶æ€ä½ä¸º 1 è¡¨ç¤ºåŠ é”ï¼›
- 1 å·²åŠ é”ï¼Œä½†æ²¡æœ‰ç­‰å¾…çš„è¿›ç¨‹ï¼Œè®¾ç½®çŠ¶æ€ä½ä¸º 2 è¡¨ç¤ºæœ‰ç­‰å¾…è¿›ç¨‹ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›
- 2 æœ‰ç­‰å¾…è¿›ç¨‹ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›

åœ¨ unlock() æ–¹æ³•ä¸­ï¼Œå¯¹çŠ¶æ€ä½å€¼é€’å‡ï¼Œå†³æ–­çŠ¶æ€ä½åŸå€¼ä¸ä¸º 1 è¡¨ç¤ºæœ‰ç­‰å¾…è¿›ç¨‹ï¼Œæ‰§è¡Œé€šçŸ¥å”¤é†’ã€‚æ³¨æ„ï¼Œåªæœ‰è·å–é”çš„è¿›è¡Œä¸èƒ½æ‰§è¡Œ unlock()ï¼Œå› ä¸ºæœªè·å¾—é”çš„è¿›ç¨‹ä¼šè¿›å…¥ç­‰å¾…å”¤é†’çŠ¶æ€ã€‚

ä»¥ä¸‹ä»£ç ç²¾ç®€å®ç°ä¸€ä¸ªåªæœ‰åŒæ€çš„é”ï¼Œå¹¶æ¨¡æ‹Ÿæµ‹è¯•å¤šçº¿ç¨‹å®‰å…¨æ“ä½œï¼š

```
const { exit } = require('process');
let { Worker, isMainThread, parentPort, workerData, threadId } = require('worker_threads');
var sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT * 3);
var int32 = new Int32Array(sab);

let newWorker = (id)=>{
  const  worker  =  new Worker(__filename, { workerData: sab });
  worker.on('error', console.error);
  worker.on('message', (data) => {
    console.log(`#${id} Roger that:`, data);
  });
  worker.on('exit', (code) => {
    if (code !==  0)
      console.error(new  Error(`#${id} exit ${code}`));
  });
}

let lock = function (iab, stateIdx) {
  while (Atomics.compareExchange(iab, stateIdx, 0, 1) != 0){
    Atomics.wait(iab, stateIdx, 1);
  }
}

let unlock = function (iab, stateIdx) {
  Atomics.store(iab, stateIdx, 0);
  Atomics.notify(iab, stateIdx, 1);
}

let intLock = 1;
let intDelay = 2;
if (isMainThread) {
  let threads = [
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
  ];
  threads.map(newWorker);
  console.log("Master done!")
} else {
  let buf = workerData;
    let int32 = new Int32Array(buf);
  lock(int32, intLock)
  let val = int32[0];
  // do somethin to waste time
  Atomics.wait(int32, intDelay, 0, Math.random()*1000)
  int32[0] = val + 1;
    let value = int32[0];
  parentPort.postMessage({msg:"+1", value, threadId});
  unlock(int32, intLock)
}
```

åŒæ­¥é”åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨ï¼Œè¶…æ—¶å°±ä¼šå¼•èµ·æµè§ˆå™¨æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥è®¾è®¡æ‰€è°“çš„`å¼‚æ­¥é”`ï¼Œå°±æ˜¯å°†åŒæ­¥é”é‡Œé¢çš„ Atomics.wait() æ“ä½œäº¤ç»™ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å’Œè¿™ä¸ªçº¿ç¨‹é€šè¿‡äº‹ä»¶é€šä¿¡æ¥å¼‚æ­¥åŒ–è¿™é‡Œçš„æ“ä½œã€‚


Atomics API å‚è€ƒï¼š

- Atomics.add( typedArray, index, value ) å¾€æŒ‡å®šçš„ index ä½ç½®åŠ ä¸€ä¸ªå€¼ï¼›
- Atomics.sub( typedArray, index, value ) å¾€æŒ‡å®šçš„ index ä½ç½®å‡ä¸€ä¸ªå€¼ï¼›
- Atomics.store( typedArray, index, value ) ä¿å­˜ value è¿”å›æ–°å€¼ï¼›
- Atomics.load( typedArray, index ) è¯»å– index æŒ‡å®šä½ç½®çš„å€¼ï¼›
- Atomics.compareExchange( typedArray, index, expectedValue, replacementValue )
- Atomics.exchange( typedArray, index, value) ä¿å­˜ value è¿”å›æ—§å€¼ï¼›

- Atomics.and( typedArray, index, value ) å¯¹æŒ‡å®šçš„ index ä½ç½®è¿›è¡Œ and è¿ç®—å¹¶ä¿å­˜
- Atomics.or( typedArray, index, value ) å¯¹æŒ‡å®šçš„ index ä½ç½®è¿›è¡Œ or è¿ç®—å¹¶ä¿å­˜
- Atomics.xor( typedArray, index, value ) å¯¹æŒ‡å®šçš„ index ä½ç½®è¿›è¡Œ xor è¿ç®—å¹¶ä¿å­˜

- Atomics.isLockFree( size )
- Atomics.notify( typedArray, index[, count] )
- Atomics.wait( typedArray, index, value[, timeout] )

é™æ€æ–¹æ³• Atomics.isLockFree() å¯ç”¨äºæ ¡éªŒæŒ‡å®šé•¿åº¦çš„ TypedArray æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨åŸå­æ“ä½œï¼Œ4 æˆ– 8 å­—èŠ‚çš„ TypedArray éƒ½å¯ä»¥ã€‚ä¸åŒç±»å‹çš„ TypedArray æ ‡å‡†å­—èŠ‚é•¿åº¦å‚è§å…¶ BYTES_PER_ELEMENT å±æ€§ã€‚

é™æ€æ–¹æ³• Atomics.wait() ç­‰å¾…ä»€ä¹ˆå€¼å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å®ƒä¼šè®©çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚æ³¨æ„ï¼Œå®ƒä¼šéªŒè¯ index ä½ç½®çš„å€¼æ˜¯å¦å’Œç­‰äºç»™å®šå€¼ï¼Œå¦‚æœæ˜¯åˆ™ä¼‘çœ ï¼Œç­‰å¾…å”¤é†’æˆ–è¶…æ—¶ã€‚

è¯¥æ–¹æ³•è¿”å›å­—ç¬¦ä¸²ï¼š

- ç­‰å¾…å€¼ä¸åŸå€¼ç›¸åŒè¿”å› "ok"ï¼›
- ç­‰å¾…å€¼ä¸åŸå€¼ä¸åŒè¿”å› "not-equal"ï¼›
- å¦‚æœè¶…æ—¶é€€å‡ºç­‰å¾…è¿”å› "timed-out"ï¼›

Atomics.wait() ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯æ”¯æŒåŸå­æ“ä½œçš„æ•°æ®ç±»å‹ï¼Œå¦‚ Int32Array å¯¹è±¡ï¼Œç”¨æ­¤å¯¹è±¡åŒ…è£… SharedArrayBuffer ç¼“å†²åŒºã€‚å½“çº¿ç¨‹é˜»å¡åœ¨ Atomics.wait()ï¼Œå¯é€šè¿‡å…¶å®ƒçº¿ç¨‹è°ƒç”¨ Atomics.notify() è¿›è¡Œå”¤é†’ï¼Œä»è€Œæ¢å¤çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚

è¯´æ˜ä¸€ä¸‹ compareExchange() å®ƒè¿”å› index ä½ç½®çš„æ—§å€¼ï¼Œåªæœ‰åœ¨æŒ‡å®šä½ç½®çš„å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œæ‰å°† replacementValue æ›¿æ¢æ‰æ•°ç»„ä¸Šçš„å€¼ã€‚è¿™ä¸ªåŸå­æ“ä½œæ–¹æ³•ä¿è¯åœ¨ä¿®æ”¹åçš„å€¼è¢«å†™å›ä¹‹å‰ä¸ä¼šå‘ç”Ÿå…¶ä»–å†™æ“ä½œã€‚



# ğŸš© cluster å­è¿›ç¨‹æ¨¡å—
- https://nodejs.org/docs/latest-v14.x/api/cluster.html
- https://nodejs.org/docs/latest-v12.x/api/cluster.html
- IOCP https://zhuanlan.zhihu.com/p/40096515
- I/O Completion Ports https://docs.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports
- https://www.codeproject.com/Articles/10280/Managed-I-O-Completion-Ports-IOCP
- P(rocess) M(anager) 2 https://pm2.keymetrics.io/docs/usage/quick-start/
- Nodejs cluster æ¨¡å—æ·±å…¥æ¢ç©¶ https://segmentfault.com/a/1190000010260600
- åˆ†å¸ƒå¼ç³»ç»Ÿï¼šæ¦‚å¿µä¸è®¾è®¡ åŸä¹¦ç¬¬5ç‰ˆ

åŸºäº v8 ä¹‹ä¸Šï¼Œæ¯ä¸ª Node.js ç¨‹åºéƒ½æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œè¦æœ€å¤§åŒ–åˆ©ç”¨å¤šæ ¸å¿ƒ CPU ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹é›†ç¾¤ cluster æ¨¡å—æ¥å¤„ç†è´Ÿè½½ã€‚

åˆ©ç”¨ cluster æ¨¡å—ï¼ŒåŸºäº Net æ¨¡å—å°è£…å¥½çš„ IPC é€šä¿¡å’Œè°ƒåº¦æœºï¼Œå¯ä»¥éå¸¸ç®€å•çš„åˆ›å»ºä¸€ä¸ª master + worker æ¨¡å¼çš„ HTTP æœåŠ¡å™¨é›†ç¾¤ï¼Œå­è¿›ç¨‹æ˜¯åŸºäº  `child_process.fork()` äº§ç”Ÿçš„ã€‚

å­è¿›ç¨‹çš„ schedulingPolicy æ–¹å¼å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ `NODE_CLUSTER_SCHED_POLICY` è®¾ç½®ï¼Œ'rr' or 'none' å¯¹åº”ï¼š

- `cluster.SCHED_RR` é»˜è®¤çš„ Round-Robin æ–¹å¼ï¼Œæ¯ä¸ªå­è¿›ç¨‹çš„è·å–çš„äº‹ä»¶çš„æœºä¼šæ˜¯å‡ç­‰çš„ï¼Œé™¤ Windows å¤–ã€‚
- `cluster.SCHED_NONE` éšæ“ä½œç³»ç»Ÿï¼›

è°ƒåº¦ç­–ç•¥æ˜¯ä¸€ä¸ªå…¨å±€è®¾ç½®ï¼Œå½“ç¬¬ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ spawned æˆ–è€… cluster.setupMaster() è®¾ç½®ååœ¨ç¬¬ä¸€æ—¶é—´ç”Ÿæ•ˆã€‚åªè¦ libuv å¯ä»¥æœ‰æ•ˆåœ°åˆ†å‘ IOCPï¼Œè€Œä¸ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½å†²å‡»çš„è¯ï¼ŒWindows ç³»ç»Ÿä¹Ÿä¼šæ›´æ”¹ä¸º SCHED_RRã€‚

é«˜æ€§èƒ½å¤§å¹¶å‘ç½‘ç»œæœåŠ¡å™¨å¿…é¡»é‡‡ç”¨éé˜»å¡æ¨¡å¼ï¼ŒIOCP - Input/Output Completion Port æ˜¯ Windows å¹³å°éé˜»å¡æ¨¡å¼ä¸­æ€§èƒ½æœ€å¥½çš„ä¸€ç§ã€‚

I/O å®Œæˆç«¯å£ä¸ºå¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå¤„ç†å¤šä¸ªå¼‚æ­¥ I/O è¯·æ±‚æä¾›äº†æœ‰æ•ˆçš„çº¿ç¨‹æ¨¡å‹ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ª I/O å®Œæˆç«¯å£æ—¶ï¼Œç³»ç»Ÿä¸ºè¯·æ±‚åˆ›å»ºä¸€ä¸ªç›¸å…³è”çš„é˜Ÿåˆ—å¯¹è±¡ä¸ºè¿™äº›è¯·æ±‚æä¾›æœåŠ¡ã€‚å¤„ç†è®¸å¤šå¹¶å‘å¼‚æ­¥ I/O è¯·æ±‚çš„è¿›ç¨‹å¯ä»¥é€šè¿‡å°† I/O å®Œæˆç«¯å£ä¸é¢„å…ˆåˆ†é…çš„çº¿ç¨‹æ± ç»“åˆä½¿ç”¨ï¼Œè€Œä¸æ˜¯åœ¨æ¥æ”¶ I/O è¯·æ±‚æ—¶åˆ›å»ºçº¿ç¨‹ï¼Œæ›´å¿«ã€æ›´é«˜æ•ˆåœ°å®Œæˆæ­¤æ“ä½œã€‚


ä»¥ä¸Šä¸¤ç§è°ƒåº¦æ–¹å¼ä¹Ÿå†³å®šäº†é›†ç¾¤å¯ä»¥æä¾›ä¸¤ç§è¿æ¥åˆ†å‘æ–¹å¼ï¼š

- ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å¾ªç¯æ–¹æ³•ï¼Œå…¶ä¸­ä¸»è¿›ç¨‹ä¾¦å¬ç«¯å£ï¼Œæ¥å—æ–°è¿æ¥ï¼Œå¹¶ä»¥ round-robin ç®—æ³•å¾ªç¯åœ°å°†å®ƒä»¬åˆ†å‘ç»™å·¥ä½œè¿›ç¨‹ï¼ŒåŒæ—¶ä½¿ç”¨ä¸€äº›å†…ç½®çš„æ™ºèƒ½æ¥é¿å…å·¥ä½œè¿›ç¨‹è¿‡è½½ã€‚
- ç¬¬äºŒç§æ–¹æ³•æ˜¯ä¸»è¿›ç¨‹åˆ›å»ºä¾¦å¬å¥—æ¥å­—å¹¶å°†å…¶å‘é€ç»™æ„Ÿå…´è¶£çš„ Worker è¿›è¡Œå¤„ç†ã€‚

ç†è®ºä¸Šï¼Œç¬¬äºŒç§æ–¹æ³•åº”è¯¥æä¾›æœ€ä½³æ€§èƒ½ï¼Œç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œç”±äºæ“ä½œç³»ç»Ÿè°ƒåº¦å™¨çš„å˜å¹»è«æµ‹ï¼Œåˆ†å¸ƒå¾€å¾€éå¸¸ä¸å¹³è¡¡ã€‚æ®è§‚å¯Ÿï¼Œè¶…è¿‡ 70% çš„è¿æ¥ä»…åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­ç»“æŸï¼Œæ€»å…±æœ‰å…«ä¸ªã€‚

ä¸åƒ Worker å¯ä»¥åœ¨å®ä¾‹åŒ–æ—¶é€šè¿‡ `workerData` å‘å·¥ä½œçº¿ç¨‹ä¼ é€’ä¸€ä¸ªå…±äº«æ•°æ®ï¼Œé›†ç¾¤ä¸­æ¯ä¸€ä¸ªå·¥ä½œè¿›ç¨‹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”äº’ç›¸ä¹‹é—´é™¤äº†èƒ½å¤Ÿè¿›è¡Œé€šä¿¡å¤–ï¼Œæ²¡æœ‰åŠæ³•å…±äº«å†…å­˜ã€‚

ä½†çˆ¶å­è¿›ç¨‹é—´å¯ä»¥è¿›è¡Œ IPC é€šä¿¡ï¼Œåœ¨ `spawn()` `fork()` å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ª stdio å‚æ•°ï¼Œé€šè¿‡ cluster.settings.stdio é…ç½®ã€‚å¦‚æœä½¿ç”¨æ•°ç»„å˜é‡ï¼Œåˆ™å®ƒå¿…é¡»åŒ…å«ä¸€ä¸ªå€¼ä¸º ipc çš„é¡¹ï¼Œå¦åˆ™å°†å¼•å‘é”™è¯¯ï¼Œä¾‹å¦‚ [0ï¼Œ1ï¼Œ2ï¼Œ'ipc']ã€‚

IPC - Inter-process communication å¸¸ç”¨æ‰‹æ®µæœ‰ä»¥ä¸‹æ–¹å¼ï¼š

- Pipe
- Nameed Pipe (FIFO)
- æ¶ˆæ¯é˜Ÿåˆ— MessageQueue
- å…±äº«å­˜å‚¨
- ä¿¡å·é‡ Semaphore
- ä¿¡å· Signal
- å¥—æ¥å­— Socket

åœ¨é›†ç¾¤ä¸­ master å’Œ worker é€šä¿¡åŸºäº UNIX Domain Socket IPCï¼Œæ‰€ä»¥å¯ä»¥åœ¨ Workers ä¸­ä½¿ç”¨ä¸€ä¸ª listern() æ–¹æ³•å¹¶ä¸”å¯ä»¥å…±äº«ã€‚

http.server ç»§æ‰¿äº† net.serverï¼Œå…¶ Server.prototype.listen() æ–¹æ³•å¤„ç†äº† IPC çš„é€šä¿¡åŠŸèƒ½ï¼Œåœ¨ cluster æ¨¡å¼ä¸­æ ¹æ®è¿›ç¨‹ç±»å‹è¡¨ç°ä¸åŒçš„åŠŸèƒ½ã€‚

ä¸»è¦æ˜¯ listenInCluster() æ–¹æ³•ï¼Œå¯¹äºä¸»è¿›ç¨‹ï¼Œå®ƒç›´æ¥åˆ›å»º socket ç›‘å¬æœåŠ¡ã€‚å¯¹äºå­è¿›ç¨‹ï¼Œåˆ™æ‰§è¡Œ child worker getserver() å‡½æ•°ï¼Œå¹¶å‘ä¸»è¿›ç¨‹å‘é€ serverQuery æŒ‡ä»¤ï¼Œä¸»è¿›ç¨‹æ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œä¼šå®ä¾‹åŒ– RoundRobinHandleã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹æœåŠ¡è¢«åˆ›å»ºï¼Œç«¯å£è¢«ç›‘å¬ï¼Œå­è¿›ç¨‹è¢«åŠ å…¥åˆ°è°ƒåº¦åº¦åˆ—ä¸­ã€‚

ä¸»è¿›ç¨‹è´Ÿè´£æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶åˆ†å‘å®¢æˆ·ç«¯è¯·æ±‚ç»™æŸä¸ªå­è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚å…·ä½“åˆ†é…ç»™å“ªä¸ªå­è¿›ç¨‹å¤„ç†ï¼Œæ˜¯ç”± round-robbine è¿›ç¨‹é«˜åº¦ç­–ç•¥æ¥å†³å®šã€‚å­è¿›ç¨‹åœ¨ server ä¸­è®¾ç½® socket çš„å¼•ç”¨ï¼Œæ¥æ”¶åˆ°ä»»åŠ¡åï¼Œè§¦å‘ connection äº‹ä»¶å¼€å§‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚

å› ä¸ºæ¶‰åŠåº•å±‚ libuvï¼Œéœ€è¦ç»“åˆ C++ ä»£ç ä¸€èµ·ç†è§£ã€‚

ä»¥ä¸‹æ–¹æ³•éƒ½å¯ä»¥æ¥æ”¶ path å‚æ•°ä¸šåˆ›å»º IPC endpointsï¼š

- net.connect()
- net.createConnection()
- server.listen() 
- socket.connect() 

ä¸»è¿›ç¨‹å¤„ç† server.listen() å¤§éƒ¨åˆ†å·¥ä½œï¼Œä¸æ­£å¸¸çš„ Node ç¨‹åºç›¸æ¯”ï¼Œcluster worker æœ‰ 3 ä¸ªå·®å¼‚ï¼š

- `server.listen({fd: 7})` è¿™é‡Œæ˜¯ master åœ¨ä¾¦å¬ file descriptor 7ï¼Œç„¶åå°†è¯·æ±‚äº¤ç»™ workerï¼Œè€Œä¸æ˜¯å·¥ä½œè¿›ç¨‹è‡ªå·±ä¾¦å¬ã€‚
- `server.listen(handle)` é€šè¿‡ worker æä¾›çš„ handle è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸ç”¨ä¸ master è¿›ç¨‹è”ç³»ã€‚
- `server.listen(0)` æ­£å¸¸æ¥è¯´ï¼Œè¿™ä¼šä¾¦å¬ä¸€ä¸ªéšæœºç«¯å£ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œé›†ç¾¤ä¸­çš„ worker éƒ½ä¼šå…±äº«è¿™ä¸ªéšæœºç«¯å£ã€‚å½“ç„¶ï¼Œå¯ä»¥ä¸ºæ¯ä¸ª worker åˆ†é…ä¸€å•ç‹¬çš„ç«¯å£ã€‚

Node.js æ²¡æœ‰è·¯ç”±é€»è¾‘ï¼Œworker ä¹‹é—´æ²¡æœ‰å…±äº«çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œç¨‹åºè¦è®¾è®¡å¾—ç®€å•ä¸€äº›ï¼Œæ¯”å¦‚åŸºäºå†…å­˜çš„ sessionã€‚

å› ä¸º workers éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œæ ¹æ®ç¨‹åºçš„éœ€è¦ï¼Œå®ƒä»¬å¯ä»¥è¢«ç‹¬ç«‹åˆ é™¤æˆ–è€…é‡å¯ï¼Œworker å¹¶ä¸ç›¸äº’å½±å“ã€‚åªè¦è¿˜æœ‰ workers å­˜æ´»ï¼Œåˆ™ master å°†ç»§ç»­æ¥å—è¿æ¥ã€‚Node ä¸ä¼šè‡ªåŠ¨ç»´æŠ¤ workers çš„æ•°ç›®ï¼Œéœ€è¦æ ¹æ®éœ€è¦ç®¡ç†è¿™äº›è¿›ç¨‹æ± ã€‚

æ³¨æ„ï¼Œä¸ä»…éœ€è¦è°ƒç”¨ server.close() æ¥å…³é—­è¿æ¥ï¼ŒåŒæ—¶è¿˜éœ€è¦è°ƒç”¨ cluster.worker.disconnect() ç»“æŸå¹¶ä¸”é€šçŸ¥ master è¿›ç¨‹å·²åœæ­¢æœåŠ¡ï¼Œæˆ–è€…è°ƒç”¨ cluster.disconnect([callback]) æ–­å¼€æ‰€æœ‰ workers çš„è¿æ¥ã€‚

cluster æºä»£ç å…¥å£åªæœ‰ä¸‰è¡Œï¼Œå®ƒæ ¹æ®æ­¢å¢ƒå˜é‡é€‰æ‹©åŠ è½½ master or childï¼š

```
'use strict';

const childOrMaster = 'NODE_UNIQUE_ID' in process.env ? 'child' : 'master';
module.exports = require(`internal/cluster/${childOrMaster}`);
```

ç„¶åå„ä¸ªå­æ¨¡å—è¿›è¡Œç›¸åº”çš„è®¾ç½®ï¼Œå¦‚ masterï¼š

```
cluster.isWorker = false;
cluster.isMaster = true;
cluster.Worker = Worker;
cluster.workers = {};
cluster.settings = {};
cluster.SCHED_NONE = SCHED_NONE;  // Leave it to the operating system.
cluster.SCHED_RR = SCHED_RR;      // Master distributes connections.
```

åˆ›å»ºè¿›ç¨‹çš„æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ id æ˜¯ cluster æ¨¡å—å†…éƒ¨ç”Ÿæˆçš„ï¼Œç¯å¢ƒå˜é‡ä¼šä¼ é€’ç»™ `child_process.fork()`ï¼š

```
function createWorkerProcess(id, env) {
  const workerEnv = { ...process.env, ...env, NODE_UNIQUE_ID: `${id}` };
  const execArgv = [...cluster.settings.execArgv];
  const debugArgRegex = /--inspect(?:-brk|-port)?|--debug-port/;
  const nodeOptions = process.env.NODE_OPTIONS || '';

  if (execArgv.some((arg) => arg.match(debugArgRegex)) ||
      nodeOptions.match(debugArgRegex)) {
    let inspectPort;
    if ('inspectPort' in cluster.settings) {
      if (typeof cluster.settings.inspectPort === 'function')
        inspectPort = cluster.settings.inspectPort();
      else
        inspectPort = cluster.settings.inspectPort;

      validatePort(inspectPort);
    } else {
      inspectPort = process.debugPort + debugPortOffset;
      if (inspectPort > maxPort)
        inspectPort = inspectPort - maxPort + minPort - 1;
      debugPortOffset++;
    }

    execArgv.push(`--inspect-port=${inspectPort}`);
  }

  return fork(cluster.settings.exec, cluster.settings.args, {
    cwd: cluster.settings.cwd,
    env: workerEnv,
    serialization: cluster.settings.serialization,
    silent: cluster.settings.silent,
    windowsHide: cluster.settings.windowsHide,
    execArgv: execArgv,
    stdio: cluster.settings.stdio,
    gid: cluster.settings.gid,
    uid: cluster.settings.uid
  });
}
```

å‚è€ƒæ¨¡å—é»˜è®¤çš„ RoundRobin è°ƒåº¦ç­–ç•¥å®ç° `RoundRobinHandle` çš„ä¸»è¦æ–¹æ³•ï¼š

```
const net = require('net');

function RoundRobinHandle(key, address, { port, fd, flags }) {
  this.key = key;
  this.all = new Map();
  this.free = new Map();
  this.handles = [];
  this.handle = null;
  this.server = net.createServer(assert.fail);

  if (fd >= 0)
    this.server.listen({ fd });
  else if (port >= 0) {
    this.server.listen({
      port,
      host: address,
      // Currently, net module only supports `ipv6Only` option in `flags`.
      ipv6Only: Boolean(flags & constants.UV_TCP_IPV6ONLY),
    });
  } else
    this.server.listen(address);  // UNIX socket path.

  this.server.once('listening', () => {
    this.handle = this.server._handle;
    this.handle.onconnection = (err, handle) => this.distribute(err, handle);
    this.server._handle = null;
    this.server = null;
  });
}

RoundRobinHandle.prototype.distribute = function(err, handle) {
  this.handles.push(handle);
  const [ workerEntry ] = this.free;

  if (ArrayIsArray(workerEntry)) {
    const [ workerId, worker ] = workerEntry;
    this.free.delete(workerId);
    this.handoff(worker);
  }
};

RoundRobinHandle.prototype.handoff = function(worker) {
  if (!this.all.has(worker.id)) {
    return;  // Worker is closing (or has closed) the server.
  }

  const handle = this.handles.shift();

  if (handle === undefined) {
    this.free.set(worker.id, worker);  // Add to ready queue again.
    return;
  }

  const message = { act: 'newconn', key: this.key };

  sendHelper(worker.process, message, handle, (reply) => {
    if (reply.accepted)
      handle.close();
    else
      this.distribute(0, handle);  // Worker is shutting down. Send to another.

    this.handoff(worker);
  });
};

// utils.js
function sendHelper(proc, message, handle, cb) {
  if (!proc.connected)
    return false;

  // Mark message as internal. See INTERNAL_PREFIX in lib/child_process.js
  message = { cmd: 'NODE_CLUSTER', ...message, seq };

  if (typeof cb === 'function')
    callbacks.set(seq, cb);

  seq += 1;
  return proc.send(message, handle);
}
```

æ´¾å‘å‡½æ•° `distribute()` è´Ÿè´£ç­›é€‰å‡ºå¤„ç†è¯·æ±‚çš„å­è¿›ç¨‹å¹¶æ´¾å‘å¤„ç†ä»»åŠ¡ï¼Œthis.free æ•°ç»„å­˜å‚¨ç©ºé—²çš„å­è¿›ç¨‹ï¼Œthis.handles å­˜æ”¾å¾…å¤„ç†çš„ç”¨æˆ·è¯·æ±‚ã€‚

ä»»åŠ¡äº¤æ¥å‡½æ•° `handoff()` è·å–æ’é˜Ÿä¸­çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶é€šè¿‡ IPC å‘é€å¥æŸ„ handle å’Œ newconn åŠ¨ä½œæ¶ˆæ¯ï¼Œç­‰å¾…å­è¿›ç¨‹è¿”å›ã€‚å½“å­è¿›ç¨‹è¿”å›æ­£åœ¨å¤„ç†è¯·æ±‚æ¶ˆæ¯æ—¶ï¼Œåœ¨æ­¤æ‰§è¡Œ handoff å‡½æ•°ï¼Œç»§ç»­åˆ†é…è¯·æ±‚ç»™è¯¥å­è¿›ç¨‹ï¼Œä¸ç®¡è¯¥å­è¿›ç¨‹ä¸Šæ¬¡è¯·æ±‚æ˜¯å¦å¤„ç†å®Œæˆï¼ˆNode çš„å¼‚æ­¥ç‰¹æ€§å’Œäº‹ä»¶å¾ªç¯å¯ä»¥è®©å•è¿›ç¨‹å¤„ç†å¤šè¯·æ±‚ï¼‰ã€‚æŒ‰ç…§è¿™æ ·çš„ç­–ç•¥ï¼Œä¸»è¿›ç¨‹æ¯ fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œéƒ½ä¼šè°ƒç”¨ handoff å‡½æ•°ï¼Œè¿›å…¥è¯¥å­è¿›ç¨‹çš„å¤„ç†å¾ªç¯ä¸­ã€‚ä¸€æ—¦ä¸»è¿›ç¨‹æ²¡æœ‰ç¼“å­˜çš„å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ˆthis.handles ä¸ºç©ºï¼‰ï¼Œä¾¿ä¼šå°†å½“å‰å­è¿›ç¨‹åŠ å…¥ free ç©ºé—²é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸»è¿›ç¨‹çš„ä¸‹ä¸€æ­¥è°ƒåº¦ã€‚è¿™å°±æ˜¯ cluster æ¨¡å¼çš„ RoundRobin è°ƒåº¦ç­–ç•¥ï¼Œæ¯ä¸ªå­è¿›ç¨‹çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€ä¸ªé—­ç¯ï¼Œç›´åˆ°ä¸»è¿›ç¨‹ç¼“å­˜çš„å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†å®Œæ¯•æ—¶ï¼Œè¯¥å­è¿›ç¨‹çš„å¤„ç†é—­ç¯æ‰è¢«æ‰“å¼€ã€‚

è¿™ä¹ˆç®€å•çš„å®ç°å¸¦æ¥çš„æ•ˆæœå´æ˜¯ä¸å°ï¼Œç»è¿‡å…¨ä¸–ç•Œè¿™ä¹ˆå¤šä½¿ç”¨è€…çš„å°è¯•ï¼Œä¸»è¿›ç¨‹åˆ†å‘è¯·æ±‚è¿˜æ˜¯å¾ˆå¹³å‡çš„ï¼Œå¦‚æœ RoundRobin çš„è°ƒåº¦éœ€æ±‚ä¸æ»¡è¶³ä½ ä¸šåŠ¡ä¸­çš„è¦æ±‚ï¼Œä½ å¯ä»¥å°è¯•ä»¿ç…§ RoundRobin æ¨¡å—å†™ä¸€ä¸ªå¦ç±»çš„è°ƒåº¦ç®—æ³•ã€‚

åœ¨ Windows ç³»ç»Ÿä¸­é‡‡ç”¨çš„ shared socket ç­–ç•¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé‡‡ç”¨ SS ç­–ç•¥è°ƒåº¦ç®—æ³•ï¼Œå­è¿›ç¨‹çš„æœåŠ¡å™¨å·¥ä½œé€»è¾‘å®Œå…¨ä¸åŒäºä¸Šæ–‡ä¸­æ‰€è®²çš„é‚£æ ·ï¼Œå­è¿›ç¨‹åˆ›å»ºçš„ TCP æœåŠ¡å™¨ä¼šåœ¨åº•å±‚ä¾¦å¬ç«¯å£å¹¶å¤„ç†å“åº”ï¼Œè¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼ŸSS ç­–ç•¥çš„æ ¸å¿ƒåœ¨äº IPC ä¼ è¾“å¥æŸ„çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”åœ¨ C++ å±‚è®¾ç½®ç«¯å£çš„ SO_REUSEADDR é€‰é¡¹ï¼Œæœ€åæ ¹æ®ä¼ è¾“çš„æ–‡ä»¶æè¿°ç¬¦è¿˜åŸå‡º handle(net.TCP)ï¼Œå¤„ç†è¯·æ±‚ã€‚è¿™æ­£æ˜¯ shared socket åç§°ç”±æ¥ï¼Œå…±äº«æ–‡ä»¶æè¿°ç¬¦ã€‚

éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œåœ¨å­è¿›ç¨‹ä¸­æ ¹æ®æ–‡ä»¶æè¿°ç¬¦è¿˜åŸå‡ºçš„ handleï¼Œä¸èƒ½å†è¿›è¡Œ bind(ip,port) å’Œ listen(backlog)æ“ä½œï¼Œåªæœ‰ä¸»è¿›ç¨‹åˆ›å»ºçš„ handle å¯ä»¥è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œå­è¿›ç¨‹ä¸­åªèƒ½é€‰æ‹© acceptã€readã€write æ“ä½œã€‚

æ—¢ç„¶ SS ç­–ç•¥ä¼ é€’çš„æ˜¯ master ç®¡ç†çš„ socket æ–‡ä»¶æè¿°ç¬¦ï¼Œå­è¿›ç¨‹ä¾¦å¬è¯¥æè¿°ç¬¦ï¼Œé‚£ä¹ˆç”±è°æ¥è°ƒåº¦å“ªä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚å‘¢ï¼Ÿè¿™å°±æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ¥è¿›è¡Œè°ƒåº¦ã€‚å¯æ˜¯å†…æ ¸è°ƒåº¦å¾€å¾€å‡ºç°æ„æƒ³ä¸åˆ°çš„æ•ˆæœï¼Œåœ¨ Linux ä¸‹å¯¼è‡´è¯·æ±‚å¾€å¾€é›†ä¸­åœ¨æŸå‡ ä¸ªå­è¿›ç¨‹ä¸­å¤„ç†ã€‚è¿™ä»å†…æ ¸çš„è°ƒåº¦ç­–ç•¥ä¹Ÿå¯ä»¥æ¨ç®—ä¸€äºŒï¼Œå†…æ ¸çš„è¿›ç¨‹è°ƒåº¦ç¦»ä¸å¼€ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ä»·å¾ˆé«˜ï¼Œä¸ä»…éœ€è¦ä¿å­˜å½“å‰è¿›ç¨‹çš„ä»£ç ã€æ•°æ®å’Œå †æ ˆç­‰ç”¨æˆ·ç©ºé—´æ•°æ®ï¼Œè¿˜éœ€è¦ä¿å­˜å„ç§å¯„å­˜å™¨ï¼Œå¦‚ PCï¼ŒESPï¼Œæœ€åè¿˜éœ€è¦æ¢å¤è¢«è°ƒåº¦è¿›ç¨‹çš„ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œä»ç„¶åŒ…æ‹¬ä»£ç ã€æ•°æ®å’Œå„ç§å¯„å­˜å™¨ï¼Œå› æ­¤ä»£ä»·éå¸¸å¤§ã€‚è€Œ Linux å†…æ ¸åœ¨è°ƒåº¦è¿™äº›å­è¿›ç¨‹æ—¶å¾€å¾€å€¾å‘äºå”¤é†’æœ€è¿‘è¢«é˜»å¡çš„å­è¿›ç¨‹ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ä»·ç›¸å¯¹è¾ƒå°ã€‚è€Œä¸”å†…æ ¸çš„è°ƒåº¦ç­–ç•¥å¾€å¾€å—åˆ°å½“å‰ç³»ç»Ÿçš„è¿è¡Œä»»åŠ¡æ•°é‡å’Œèµ„æºä½¿ç”¨æƒ…å†µï¼Œå¯¹ä¸“æ³¨äºä¸šåŠ¡å¼€å‘çš„ HTTP æœåŠ¡å™¨å½±å“è¾ƒå¤§ï¼Œå› æ­¤ä¼šé€ æˆæŸäº›å­è¿›ç¨‹çš„è´Ÿè½½ä¸¥é‡ä¸å‡è¡¡çš„çŠ¶å†µã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆ cluster æ¨¡å—é»˜è®¤ä¼šåœ¨ Windows æœºå™¨ä¸­é‡‡ç”¨ SS ç­–ç•¥è°ƒåº¦å­è¿›ç¨‹å‘¢ï¼ŸåŸå› æ˜¯ Node åœ¨ Windows å¹³å°é‡‡ç”¨çš„ IOCP æ¥æœ€å¤§åŒ–æ€§èƒ½ï¼Œå®ƒä½¿å¾—ä¼ é€’è¿æ¥çš„å¥æŸ„åˆ°å…¶ä»–è¿›ç¨‹çš„æˆæœ¬å¾ˆé«˜ï¼Œå› æ­¤é‡‡ç”¨é»˜è®¤çš„ä¾é æ“ä½œç³»ç»Ÿè°ƒåº¦çš„ SS ç­–ç•¥ã€‚

SS è°ƒåº¦ç­–ç•¥éå¸¸ç®€å•ï¼Œä¸»è¿›ç¨‹ç›´æ¥é€šè¿‡IPCé€šé“å‘é€handleç»™å­è¿›ç¨‹å³å¯


é›†ç¾¤ä½¿ç”¨ç¤ºèŒƒï¼š

```
const cluster = require('cluster');
const http = require('http');
const cores = require('os').cpus();

if (cluster.isMaster) {
  console.log(`Master ${process.pid} is running`);

  // Fork workers.
  cores.map(cpu => {
    let worker = cluster.fork(); // fork self
  });
  cluster.on('exit', (worker, code, signal) => {
    let pid = worker.process.pid;
    console.log({worker: worker.id, pid, exitCode: code});
    void function killAll(){
      for(let id in cluster.workers) {
        cluster.workers[id].disconnect();
        // cluster.workers[id].kill('SIGTERM');
      }
    }();
  });
} else {
  // Workers can share any TCP connection with Master bye IPC server.
  let port = 8000; // cluster.worker.id;
  const svr = http.createServer((req, res) => {
    res.writeHead(200);
    res.end(`hello world Worker ${process.pid}\n`);
    svr.close((err)=>{
      if(err) console.error(err);
      process.exit();
    });
  }).listen(port, "localhost");
  console.log(`Worker ${process.pid} started`, port);
}
```

é…ç½® Masterï¼š

```
const cluster = require('cluster');
cluster.setupMaster({
  exec: 'worker.js',
  args: ['--use', 'https'],
  silent: true
});
cluster.fork(); // https worker

cluster.setupMaster({
  exec: 'worker.js',
  args: ['--use', 'http']
});
cluster.fork(); // http worker
```

Cluster æ¨¡å—çš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œè€Œ PM2 å°†å®ƒçš„ä½¿ç”¨å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

é€šè¿‡ PM2 å¯ä»¥å®æ—¶æ‰©å±•é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å¯¹é›†ç¾¤è¿›è¡Œæ‰©å±•ï¼Œå‚æ•° n æŒ‡å®šå·¥ä½œçº¿ç¨‹çš„æ•°é‡ï¼Œè¢«ç”¨æ¥å¢åŠ æˆ–å‡å°‘é›†ç¾¤è¿›ç¨‹æ•°ã€‚

    pm2 scale <app name> <n>
    pm2 scale app +3

    pm2 start app.js --name app
    pm2 start app.js -i 8
    pm2 list
    pm2 monit
    
    pm2 stop all
    pm2 start all
    pm2 restart all
    pm2 reload all
    pm2 delete all


- Class: Worker
    - Event: disconnect( )
    - Event: error( )
    - Event: exit( code, signal )
    - Event: listening( address )
    - Event: message( message, handle )
    - Event: online( )

    - worker.disconnect()
    - worker.exitedAfterDisconnect
    - worker.id
    - worker.isConnected()
    - worker.isDead()
    - worker.kill([signal])
    - worker.process
    - worker.send(message[, sendHandle[, options]][, callback])

- cluster æ¨¡å—
    - Event: disconnect( worker )
    - Event: exit( worker, code, signal )
    - Event: fork( worker )
    - Event: listening( worker, address )
    - Event: message( worker, message, handle )
    - Event: online( worker )
    - Event: setup( settings )
    - cluster.disconnect([callback])
    - cluster.fork([env])
    - cluster.isMaster
    - cluster.isWorker
    - cluster.schedulingPolicy
    - cluster.settings
    - cluster.setupMaster([settings])
    - cluster.worker
    - cluster.workers


# ğŸš© events äº‹ä»¶æ¨¡å—
- https://nodejs.org/docs/latest-v12.x/api/events.html

å¤§éƒ¨åˆ† Node æ ¸å¿ƒ API æ˜¯å›´ç»•ä¸€ä¸ªæƒ¯ç”¨çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ä½“ç³»ç»“æ„æ‰“é€ çš„ï¼Œåœ¨è¿™ä¸ªä½“ç³»ç»“æ„ä¸­ï¼ŒæŸäº›ç§°ä¸º emitters çš„å¯¹è±¡ä¼šå‘å‡ºå‘½åäº‹ä»¶ï¼Œä»è€Œå¯¼è‡´é‚£äº›ç§°ä¸º listeners çš„å‡½æ•°å¯¹è±¡è¢«æ‰§è¡Œã€‚

ç¤ºèŒƒäº‹ä»¶å‘å°„å¯¹è±¡çš„ä½¿ç”¨ï¼š

```
const EventEmitter = require('events');

class MyEmitter extends EventEmitter {}

const myEmitter = new MyEmitter();
myEmitter.on('event', () => {
  console.log('an event occurred!');
  setImmediate(() => {
    console.log('this happens asynchronously');
  });
});
myEmitter.emit('event');
myEmitter.emit('event', 'a', 'b');
```

è¦ç‚¹ï¼š

- emitter.on() æ³¨å†Œç›‘å¬å‡½æ•°ï¼›
- emitter.emit() å‘å°„äº‹ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼è¡¨ç¤ºäº‹ä»¶å‘å°„æ˜¯å¦æˆåŠŸï¼›
- emitter.once() æ³¨å†Œæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å‡½æ•°ï¼› 
- å‘å°„äº‹ä»¶æ—¶ï¼Œå¯ä»¥ç»™ç›‘å¬å‡½æ•°ä¼ é€’ä»»æ„æ•°é‡çš„å‚æ•°ï¼›
- ç»“åˆ setImmediate() å®ç°å¼‚æ­¥æ‰§è¡Œï¼›

ä½¿ç”¨å¼‚æ­¥å‡½æ•°å¤„ç†äº‹ä»¶æ—¶ï¼Œéœ€è¦è€ƒè™‘ rejected çŠ¶æ€ï¼Œå¯ä»¥ç›‘å¬ error äº‹ä»¶ï¼Œæˆ–è€… `Symbol.for('nodejs.rejection')` æ–¹æ³•ï¼š

```
const EventEmitter = require('events');
// EventEmitter.captureRejections = true;
const ee1 = new EventEmitter({ captureRejections: true });
ee1.on('something', async (value) => {
  throw new Error('kaboom');
});

ee1.on('error', (err) => console.log("on error:", err.message));
ee1[Symbol.for('nodejs.rejection')] = console.log;

ee1.emit("something");
```

ä¸å»ºè®®ä½¿ç”¨å¼‚æ­¥å‡½æ•°ç”¨ä½œ error äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¹¶ä¸”ï¼Œä¸èƒ½åœ¨ error ä¸­ä½¿ç”¨ catch å¤„ç†ç¨‹åºï¼Œä»¥é¿å…æ— é™çš„é”™è¯¯å¾ªç¯ã€‚


- Static Properties
    - events.once(emitter, name)
    - events.captureRejections
    - events.captureRejectionSymbol
    - events.on(emitter, eventName)

- Class: EventEmitter
    - Event: 'newListener'
    - Event: 'removeListener'
    - EventEmitter.listenerCount(emitter, eventName)
    - EventEmitter.defaultMaxListeners
    - EventEmitter.errorMonitor
    - emitter.addListener(eventName, listener)
    - emitter.emit(eventName[, ...args])
    - emitter.eventNames()
    - emitter.getMaxListeners()
    - emitter.listenerCount(eventName)
    - emitter.listeners(eventName)
    - emitter.off(eventName, listener)
    - emitter.on(eventName, listener)
    - emitter.once(eventName, listener)
    - emitter.prependListener(eventName, listener)
    - emitter.prependOnceListener(eventName, listener)
    - emitter.removeAllListeners([eventName])
    - emitter.removeListener(eventName, listener)
    - emitter.setMaxListeners(n)
    - emitter.rawListeners(eventName)
    - emitter[Symbol.for('nodejs.rejection')](err, eventName[, ...args])


# ğŸš© process è¿›ç¨‹æ¨¡å—
- https://nodejs.org/docs/latest-v14.x/api/process.html
- https://nodejs.dev/learn/how-to-exit-from-a-nodejs-program

ç³»ç»Ÿæ¯ä¸ªä¿¡æ¯éƒ½æ˜¯ä¸€ä¸ªå¯¹åº”çš„äº‹ä»¶ Signal eventsï¼Œå‚è€ƒ OS æ¨¡å—ï¼Œéƒ¨åˆ†ä¿¡å·å¦‚ä¸‹ï¼š

- `'SIGUSR1'` è¢« Node.js ä¿ç•™ç”¨äºå¯åŠ¨è°ƒè¯•å™¨ã€‚
- `'SIGPIPE'` é»˜è®¤ä¼šè¢«å¿½ç•¥ï¼Œå¯ä»¥ç»™å…¶ç»‘å®šç›‘å¬å™¨ã€‚
- `'SIGHUP'` å½“æ§åˆ¶å°çª—å£è¢«å…³é—­æ—¶ä¼šè§¦å‘ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ç»ˆæ­¢ç¨‹åºï¼Œä½†ç»‘å®šç›‘å¬å™¨åˆ™ä¼šé˜»æ­¢é»˜è®¤è¡Œä¸ºã€‚Windows ä¸Šä¼šåœ¨è§¦å‘å 10 ç§’åæ— æ¡ä»¶åœ°ç»ˆæ­¢ã€‚
- `'SIGTERM'` ç»‘å®šäº†ç›‘å¬å™¨ï¼Œåˆ™å…¶é»˜è®¤çš„è¡Œä¸ºä¼šè¢«ç§»é™¤ï¼Œå³ä¸å†ä¼šé€€å‡ºç¨‹åºï¼Œä½†åœ¨ Windows ä¸Šä¸æ”¯æŒã€‚
- `'SIGINT'` ä»ç»ˆç«¯è¿è¡Œæ—¶ï¼Œæ‰€æœ‰å¹³å°ä¸Šéƒ½æ”¯æŒï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ Ctrl+C è§¦å‘ã€‚
- `'SIGBREAK'` åœ¨ Windows ä¸Šï¼Œå½“æŒ‰ä¸‹ Ctrl+Break æ—¶åˆ™ä¼šè§¦å‘ã€‚ åœ¨é Windows å¹³å°ä¸Šï¼Œå¯ä»¥ä¸ºå…¶ç»‘å®šç›‘å¬å™¨ï¼Œä½†æ˜¯æ— æ³•å‘é€æˆ–è§¦å‘æ­¤äº‹ä»¶ã€‚
- `'SIGWINCH'` å½“æ§åˆ¶å°è¢«è°ƒæ•´å¤§å°æ—¶åˆ™ä¼šè§¦å‘ã€‚ åœ¨ Windows ä¸Šï¼Œåªæœ‰å½“å†™å…¥æ§åˆ¶å°æ—¶ç§»åŠ¨å…‰æ ‡ã€æˆ–è€…åœ¨åŸå§‹æ¨¡å¼ä¸­ä½¿ç”¨å¯è¯»çš„ tty æ—¶ï¼Œæ‰ä¼šè§¦å‘ã€‚
- `'SIGKILL'` ä¸èƒ½ç»‘å®šç›‘å¬å™¨ï¼Œåœ¨æ‰€æœ‰å¹³å°ä¸Šï¼Œéƒ½ä¼šæ— æ¡ä»¶åœ°ç»ˆæ­¢ Node.jsã€‚
- `'SIGSTOP'` ä¸èƒ½ç»‘å®šç›‘å¬å™¨ã€‚
- `'SIGBUS'` 'SIGFPE' 'SIGSEGV' 'SIGILL', ä½¿ç”¨ kill(2) äº§ç”Ÿï¼Œå¦åˆ™ä¼šä½¿è¿›ç¨‹åœç•™åœ¨æŸç§çŠ¶æ€ï¼Œæ­¤çŠ¶æ€ä¸‹è°ƒç”¨ JS ç›‘å¬å™¨å¯èƒ½å¯¼è‡´è¿›ç¨‹åœæ­¢å“åº”ã€‚
-  0 ä¿¡å·ç”¨æ¥æµ‹è¯•è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä¸å¹³å°æ— å…³çš„æ–¹å¼æ¥æµ‹è¯•è¿›ç¨‹çš„å­˜åœ¨æ€§ã€‚

Windows ä¸æ”¯æŒä¿¡å·ï¼Œä¸èƒ½é€šè¿‡ä¿¡å·ç»ˆæ­¢è¿›ç¨‹ï¼Œä½†æ˜¯ Node.js æä¾›äº† process.kill() å’Œ subprocess.kill() æ¥æ¨¡æ‹Ÿï¼Œä»¥ä¸‹ä¸‰ä¸ªè¿›ç¨‹é€€å‡ºæ–¹å¼ç­‰æ•ˆï¼š

    process.exit(1)
    process.exitCode = 1
    process.kill(process.pid, 'SIGTERM')

å‘é€ SIGINTã€ SIGTERM å’Œ SIGKILL ä¼šä½¿ç›®æ ‡è¿›ç¨‹è¢«æ— æ¡ä»¶åœ°ç»ˆæ­¢ï¼Œç„¶åå­è¿›ç¨‹ä¼šæŠ¥å‘Šè¯¥è¿›ç¨‹å·²è¢«ä¿¡å·ç»ˆæ­¢ã€‚

```ts
// Begin reading from stdin so the process does not exit.
process.stdin.resume();
process.on('SIGINT', () => {
  console.log('Received SIGINT. Press Control-D to exit.');
});

// Using a single function to handle multiple signals
function handle(signal) {
  console.log(`Received ${signal}`);
}
process.on('SIGINT', handle);
process.on('SIGTERM', handle);
```

Exit codes

- 0 æ­£å¸¸é€€å‡ºï¼›
- 1 Uncaught Fatal Exception
- 2 Unused (reserved by Bash for builtin misuse)
- 3 Internal JavaScript Parse Error
- 4 Internal JavaScript Evaluation Failure
- 5 Fatal Error: There was a fatal unrecoverable error in V8.
- 6 Non-function Internal Exception Handler
- 7 Internal Exception Handler Run-Time Failure:
- 8: Unused
- 9 Invalid Argument
- 10 Internal JavaScript Run-Time Failure
- 12 Invalid Debug Argument
- 13 Unfinished Top-Level Await
- >128 Signal Exits:  SIGKILL or SIGHUP, then its exit code will be 128 plus the value of the signal code. 

- Process events
    - Event: beforeExit( code )
    - Event: disconnect(  )
    - Event: exit( code )
    - Event: message( message, sendHandle )
    - Event: multipleResolves( type, promise, value )
    - Event: rejectionHandled( promise )
    - Event: uncaughtException( err, origin )
    - Event: uncaughtExceptionMonitor( err, origin )
    - Event: unhandledRejection( reason, promise )
    - Event: warning( warning )

- å±æ€§å‚è€ƒï¼š
    - process.allowedNodeEnvironmentFlags
    - process.arch
    - process.argv
    - process.argv0
    - process.channel
    - process.config
    - process.connected
    - process.debugPort
    - process.env è·å–ç¯å¢ƒå˜é‡
    - process.execArgv
    - process.execPath
    - process.exitCode
    - process.mainModule `deprecated`
    - process.noDeprecation
    - process.pid
    - process.platform
    - process.ppid
    - process.release
    - process.report
    - process.report.compact
    - process.report.directory
    - process.report.filename
    - process.report.reportOnFatalError
    - process.report.reportOnSignal
    - process.report.reportOnUncaughtException
    - process.report.signal
    - process.stderr
    - process.stderr.fd
    - process.stdin
    - process.stdin.fd
    - process.stdout
    - process.stdout.fd
    - process.throwDeprecation
    - process.title
    - process.traceDeprecation
    - process.version
    - process.versions

- API å‚è€ƒï¼š
    - process.abort()
    - process.channel.ref()
    - process.channel.unref()
    - process.chdir(directory)
    - process.cpuUsage([previousValue])
    - process.cwd()
    - process.disconnect()
    - process.dlopen(module, filename[, flags])
    - process.emitWarning(warning[, options])
    - process.emitWarning(warning[, type[, code]][, ctor])
    - process.exit([code])
    - process.getegid()
    - process.geteuid()
    - process.getgid()
    - process.getgroups()
    - process.getuid()
    - process.hasUncaughtExceptionCaptureCallback()
    - process.hrtime([time])
    - process.hrtime.bigint()
    - process.initgroups(user, extraGroup)
    - process.kill(pid[, signal])
    - process.memoryUsage()
    - process.memoryUsage.rss()
    - process.nextTick(callback[, ...args])
    - process.report.getReport([err])
    - process.report.writeReport([filename][, err])
    - process.resourceUsage()
    - process.send(message[, sendHandle[, options]][, callback])
    - process.setegid(id)
    - process.seteuid(id)
    - process.setgid(id)
    - process.setgroups(groups)
    - process.setuid(id)
    - process.setUncaughtExceptionCaptureCallback(fn)
    - process.umask()  `deprecated`
    - process.umask(mask)
    - process.uptime()



# ğŸš© child_process å­è¿›ç¨‹æ¨¡å—
- https://nodejs.org/api/child_process.html
- https://nodejs.org/api/process.html

Node å­è¿›ç¨‹æ¨¡å—æä¾›ä¸ç³»ç»Ÿäº¤äº’çš„é‡è¦æ¥å£ï¼Œå…¶ä¸»è¦ API æœ‰ï¼š 

- æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºåŠæ ‡å‡†é”™è¯¯è¾“å‡ºçš„æ¥å£ stdioï¼š
    - `child.stdin` è·å–æ ‡å‡†è¾“å…¥ã€‚
    - `child.stdout` è·å–æ ‡å‡†è¾“å‡ºã€‚
    - `child.stderr` è·å–æ ‡å‡†é”™è¯¯è¾“ã€‚ 
- `child.pid` å­è¿›ç¨‹ PIDã€‚
- `child_process.exec(cmd, [options], callback)` æ‰§è¡Œ Shell å‘½ä»¤ã€‚
- `child_process.execFile(file[, args][, options][, callback])` æ‰§è¡Œè„šæœ¬æ–‡ä»¶æˆ–ç¨‹åºã€‚
- `child_process.fork(modulePath[, args][, options])` å¤åˆ»åˆ›å»º Node å­è¿›ç¨‹ï¼Œç›¸å½“ spawn å¢å¼ºç‰ˆã€‚
- `child_process.spawn(cmd, args=[], [options])` å­µåŒ–åˆ›å»ºå­è¿›ç¨‹ï¼Œå¸¦æœ‰ stdout stderr æµå¯¹è±¡è·å–è¾“å‡ºã€‚
- `child.kill(signal='SIGTERM')` æ€æ­»å­è¿›ç¨‹ã€‚

ä»¥ä¸Šæ–¹æ³•ä¸­è¿˜æœ‰ä¸‰ä¸ªåŒæ­¥æ‰§è¡Œç‰ˆæœ¬ï¼š

- child_process.execFileSync(file[, args][, options])
- child_process.execSync(command[, options])
- child_process.spawnSync(command[, args][, options])

`fork()` æ˜¯ `spawn()` çš„ç‰¹æ®Šå½¢å¼ï¼Œç”¨äºåœ¨å­è¿›ç¨‹ä¸­è¿è¡Œçš„æ¨¡å—ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´ï¼Œå»ºç«‹ä¸€ä¸ªé€šä¿¡ç®¡é“ç”¨äºè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å¦‚ `fork('./sub.js')` ç›¸å½“äº `spawn('node', ['./sub.js'])`ã€‚

åœ¨ä¸åŒçš„å¹³å°ä¸Š `exec()` & `execFile()` è¡¨ç°å·®å¼‚å¾ˆå¤§ï¼š

- Unix, Linux, macOS å¹³å°ä¸Š `execFile()` æ›´æœ‰æ•ˆç‡ï¼Œå› ä¸ºé»˜è®¤ä¸é€šè¿‡ spawn æ¥å­µåŒ–è¿è¡Œ shell è¿›ç¨‹ï¼›
- Windows å¹³å°ä¸Š .bat .cmd éœ€è¦é€šè¿‡ç»ˆç«¯ç¨‹åºè¿è¡Œï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ `execFile()`ï¼Œè€Œæ˜¯é‡‡ç”¨ `spawn()` `exec()`ï¼›

åƒ exec å¯ä»¥ç›´æ¥æ‰§è¡Œå¨èƒæ€§çš„ shell å‘½ä»¤ï¼Œå¦‚ï¼š

    exec('echo hello world;rm -rf');

é€šè¿‡ exec æ‰§è¡Œåå°±ä¼šå¯¼è‡´åˆ é™¤å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè€Œ execFile åˆ™å¯ä»¥é¿å…ï¼š

    execFile('echo', ['hello world;rm -rf']);

å¯¹äºæ–‡ä»¶æœ‰ç©ºæ ¼æ—¶ï¼Œè¿˜éœ€è¦ä½¿ç”¨åŒå¼•å·åŒ…æ‹¬ã€‚

```
const { exec, spawn } = require('child_process');

exec('my.bat', (err, stdout, stderr) => {
  if (err) {
    console.error(err);
    return;
  }
  console.log(stdout);
});

// Script with spaces in the filename:
const bat = spawn('"my script.cmd"', ['a', 'b'], { shell: true });
// or:
exec('"my script.cmd" a b', (err, stdout, stderr) => {
  // ...
});
```

åœ¨ `spawn()` `fork()` å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ª stdio å‚æ•°ï¼Œå¦‚æœä½¿ç”¨æ•°ç»„å˜é‡ï¼Œåˆ™å®ƒå¿…é¡»åŒ…å«ä¸€ä¸ªå€¼ä¸º ipc çš„é¡¹ï¼Œå¦åˆ™å°†å¼•å‘é”™è¯¯ï¼Œä¾‹å¦‚[0ï¼Œ1ï¼Œ2ï¼Œ'ipc']ã€‚

è¿™ä¸ªé€‰é¡¹ç”¨äºé…ç½®çˆ¶å­è¿›ç¨‹ä¹‹é—´å»ºç«‹é€šä¿¡çš„ç®¡é“ï¼Œé»˜è®¤æƒ…å†µä¸‹é€‰é¡¹ stdio ç­‰äº ['pipe'ï¼Œ'pipe'ï¼Œ'pipe']ï¼Œå­è¿›ç¨‹çš„ stdio é‡å®šå‘åˆ° ChildProcess å¯¹è±¡ä¸Šç›¸åº”çš„æµï¼Œå¦‚ä¸‹ï¼š

- stdin --> subprocess.stdin
- stdout --> subprocess.stdout
- stderr  --> subprocess.stderr 

çº¦å®šï¼Œoptions.stdio å¯ä»¥ä¼ å…¥ä»¥ä¸‹è®¾ç½®ï¼š

- `'pipe'`: ç­‰ä»·äºé»˜è®¤çš„ ['pipe', 'pipe', 'pipe']
- `'ignore'`: ç­‰ä»·äº ['ignore', 'ignore', 'ignore']
- `'inherit'`: ç­‰ä»·äº ['inherit', 'inherit', 'inherit'] æˆ–è€… [0, 1, 2]

å¦‚æœä¼ å…¥æ•°ç»„ï¼Œåˆ™å…¶ä¸­æ¯ä¸ªç´¢å¼•å¯¹åº”äºå­è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ fdï¼Œå€¼ 0ã€1ã€2 åˆ†åˆ«å¯¹åº” stdinã€stdoutã€stderrã€‚

å¯ä»¥æŒ‡å®šå…¶ä»– FD ä»¥åœ¨çˆ¶çº§å’Œå­çº§ä¹‹é—´åˆ›å»ºå…¶ä»–ç®¡é“ï¼Œå€¼å¦‚ä¸‹ï¼š

- `'pipe'`: ä¸ºçˆ¶å­è¿›ç¨‹åˆ›å»ºç®¡é“é€šä¿¡ï¼Œçˆ¶è¿›ç¨‹ç«¯çš„ pipe é€šè¿‡ subprocess.stdio[fd] æš´éœ²ï¼Œfds 0, 1, 2 å¯¹åº” subprocess.stdin, subprocess.stdout, subprocess.stderrã€‚

- `'ipc'`: ä¸ºçˆ¶å­è¿›ç¨‹åˆ›å»º IPC é€šé“ï¼Œé€šè¿‡æ¶ˆæ¯æˆ–æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ subprocess.send() ä¼ é€’æ¶ˆæ¯ï¼Œå¯¹äº Node.js å­è¿›ç¨‹ï¼ŒIPC é€šé“çš„ process.send() & process.disconnect() æ–¹æ³•éƒ½æœ‰æ•ˆï¼Œè¿˜æœ‰ 'disconnect' and 'message' äº‹ä»¶ã€‚

- `'ignore'`: å‘Šè¯‰ Node.js åœ¨å­è¿›ç¨‹ä¸­å¿½ç•¥è¿™ä¸ª fdï¼ŒNode.js æ€»ä¼šä¸ºå­è¿›ç¨‹æ‰“å¼€ 0, 1, 2 è¿™å‡ ä¸ª fdï¼Œè®¾ç½® 'ignore' å°±æ˜¯è®© Node.js æ‰“å¼€ /dev/null å¹¶é™„åŠ åˆ°å­è¿›ç¨‹çš„ fdã€‚

- `'inherit'`: ç»§æ‰¿çˆ¶è¿›ç¨‹ stdio streamï¼Œåœ¨ä¼ å…¥æ•°ç»„å‰ 3 ä¸ªä½ç½®å¯¹åº” process.stdin, process.stdout, process.stderrï¼Œå…¶å®ƒä½ç½®ç­‰ä»· 'ignore'ã€‚

- `Stream` å¯¹è±¡: ä¸å¤šä¸ªå­è¿›ç¨‹å…±äº«ä¸€ä¸ªå¼•ç”¨ tty/file/socket/pipe çš„ readable æˆ– writable æµå¯¹è±¡ã€‚

- æ­£æ•´æ•°: æ•°å€¼ä»£è¡¨å½“å‰çˆ¶è¿›ç¨‹æ‰“å¼€çš„ fdï¼Œç”±å­è¿›ç¨‹å…±äº«ï¼Œç±»ä¼¼ `Stream` å¯¹è±¡çš„å…±äº«æ–¹å¼ï¼Œåœ¨ Windows å¹³å°ä¸‹å¯ä»¥ä¼ å…¥ socketsã€‚

- `null` `undefined`: ä½¿ç”¨é»˜è®¤å€¼ï¼Œstdio fds 0, 1, 2 é»˜è®¤å€¼å¯¹åº” stdin, stdout, stderr ç®¡é“ï¼Œè€Œ fd 3 æˆ–æ›´å¤§çš„å€¼å…¶é»˜è®¤å€¼ä¸º 'ignore'ã€‚

```
const { spawn } = require('child_process');

// Child will use parent's stdios.
spawn('prg', [], { stdio: 'inherit' });

// Spawn child sharing only stderr.
spawn('prg', [], { stdio: ['pipe', 'pipe', process.stderr] });

// Open an extra fd=4, to interact with programs presenting a
// startd-style interface.
spawn('prg', [], { stdio: ['pipe', null, null, null, 'pipe'] });
```

ä¾‹å¦‚ï¼Œå°† stdio é‡å®šå‘åˆ°æ–‡ä»¶ï¼š

```
var child_process = require('child_process');
var fs = require('fs');

var out = fs.openSync('./out.log', 'a');
var err = fs.openSync('./err.log', 'a');

var child = child_process.spawn('node', ['child.js'], {
    detached: true,
    stdio: ['ignore', out, err]
});

child.unref();
```



ä¼ å…¥ shell å‚æ•°ï¼Œboolean or stringï¼Œè¡¨ç¤ºæ‰§è¡Œ shell å‘½ä»¤ï¼Œåœ¨ Unix ç³»ç»Ÿä¸Šé»˜è®¤ä½¿ç”¨ `/bin/sh`ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šé»˜è®¤ä½¿ç”¨ process.env.ComSpec æˆ– `%COMSPEC%` æŒ‡å®šçš„ `cmd.exe` æ‰§è¡Œå‘½ä»¤ï¼Œå…¶å®ƒ shell ç¨‹åºå¯ä»¥ä¼ å…¥å­—ç¬¦ä¸²æŒ‡å®šã€‚

ä¸€ä¸ª shell ç¨‹åºåº”è¯¥å¯ä»¥ä½¿ç”¨ -c å¼€å…³æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå¯¹äº Windows çš„ 'cmd.exe'ï¼Œè¿™åº”è¯¥å¯ä»¥ä½¿ç”¨ /d /s /c ç­‰å¼€å…³ï¼Œæ‰§è¡Œå‘½ä»¤æ ¼å¼åº”è¯¥å…¼å®¹ã€‚

é€‰é¡¹è®¾ç½®ï¼Œè¿˜æœ‰ `detached` å¯ä»¥è®©å­è¿›ç¨‹ä¸å—ä¸»è¿›ç¨‹çš„é€€å‡ºå½±å“è€Œç»§ç»­æ‰§è¡Œï¼š

```
const fs = require('fs');
const { spawn } = require('child_process');
const out = fs.openSync('./out.log', 'a');
const err = fs.openSync('./out.log', 'a');

const subprocess = spawn('prg', [], {
  detached: true,
  stdio: [ 'ignore', out, err ]
});

subprocess.unref();
```

å­è¿›ç¨‹ ChildProcess çš„äº‹ä»¶å‚è€ƒï¼Œåœ¨ Windows å¹³å°ä¸‹æ‰§è¡Œå‘½ä»¤è·å–çš„å­—ç¬¦ä¸²æ˜¯ GBK ç¼–ç ï¼Œå¯ä»¥ä½¿ç”¨ TextDecoder  iconv æ¨¡å—è¿›è¡Œè½¬ç ï¼š

```
const { spawn, exec, execFile } = require('child_process');
const {decode, encode} = require('iconv-lite')

let isWin32 = process.platform==='win32';
const ls = isWin32? execFile('cmd', ['/c dir .'], {encoding: "binary"})
// const ls = isWin32? exec('cmd /c dir .', {encoding: "binary"})
// const ls = isWin32? spawn('cmd', ['/c', 'dir .'])
  : spawn('ls', ['-lh', '/usr']);

ls.stdout.on('data', (data) => {
  const buffer = Buffer.from(data, "binary");
  const utf8 = decode(buffer, "gbk");
  console.log(`stdout: ${utf8}`);
});

ls.on('close', (code) => {
  console.log(`child process close all stdio with code ${code}`);
});

ls.on('exit', (code) => {
  console.log(`child process exited with code ${code}`);
});
```

é»˜è®¤ï¼Œä¸»è¿›ç¨‹ä¼šç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œå¯ä»¥ä½¿ç”¨ `subprocess.unref()` æ–¹æ³•ä¸»åŠ¨å°†å­è¿›ç¨‹ä»çˆ¶è¿›ç¨‹çš„äº‹ä»¶å¾ªç¯ä¸­å‰”é™¤ï¼Œç›¸å½“äºä½¿ç”¨ `detached` é€‰é¡¹æ¥å­µåŒ–å­è¿›ç¨‹ï¼Œé™¤éä½¿ç”¨äº† IPC é€šä¿¡é€šé“ã€‚

åœ¨å­è¿›ç¨‹çš„ IPC é€šä¿¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ v8 æ¨¡å—çš„ä¸²è¡ŒåŒ– API æ¥ä¼ é€’æ•°æ®ï¼Œä½†æ˜¯è¦ JSON æ”¯æŒæ›´å¤šçš„æ•°æ®ç±»å‹ï¼Œå¦‚ BigInt, Map & Set, ArrayBuffer & TypedArray, Buffer, Error, RegExp ç­‰ç­‰ï¼Œå¯ä»¥åœ¨ child_process.spawn() or child_process.fork() æ‰§è¡Œæ—¶ä¼ å…¥ serialization é€‰é¡¹ä¸º 'advanced'ã€‚

API å‚è€ƒï¼š

- Event: close(code, signal) 
- Event: disconnect() 
- Event: error(err) 
- Event: exit(code, signal) 
- Event: message(message, sendHandle) ä¸ fork å­è¿›ç¨‹é€šä¿¡ã€‚
- Event: spawn() 

- subprocess.channel
- subprocess.channel.ref()
- subprocess.channel.unref()
- subprocess.connected
- subprocess.disconnect()
- subprocess.exitCode
- subprocess.kill([signal])
- subprocess.killed
- subprocess.pid
- subprocess.ref()
- subprocess.send(message[, sendHandle[, options]][, callback])
- subprocess.signalCode
- subprocess.spawnargs
- subprocess.spawnfile
- subprocess.stderr
- subprocess.stdin
- subprocess.stdio
- subprocess.stdout
- subprocess.unref()


## onmessage é€šä¿¡äº‹ä»¶ç¤ºèŒƒ

æ ¹æ®å­è¿›ç¨‹çš„ send() æ–¹æ³•ï¼Œå¯ä»¥ç»™å­è¿›ç¨‹å‘é€å„ç§ç”¨äº IPC é€šä¿¡çš„å¯¹è±¡ã€‚

- subprocess.send(message[, sendHandle[, options]][, callback])

å­è¿›ç¨‹é€šä¿¡ä½¿ç”¨ message äº‹ä»¶æ¥æ”¶ä¿¡æ¯ï¼Œæ¶ˆæ¯åœ¨å‘é€æ–¹è°ƒç”¨ `send()` æ–¹æ³•å‘é€ï¼š

    const cp = require('child_process');
    const n = cp.fork(`${__dirname}/sub.js`);

    n.on('message', (m) => {
      console.log('PARENT got message:', m);
    });

    // Causes the child to print: CHILD got message: { hello: 'world' }
    n.send({ hello: 'world' });

å­è¿›ç¨‹è„šæœ¬ sub.jsï¼š

    process.on('message', (m) => {
      console.log('CHILD got message:', m);
    });

    // process.send(message[, sendHandle[, options]][, callback])
    process.send({ foo: 'bar', baz: NaN });


ä½¿ç”¨ server å¯¹è±¡é€šä¿¡ï¼š

    const subprocess = require('child_process').fork('subprocess.js');

    // Open up the server object and send the handle.
    const server = require('net').createServer();
    server.on('connection', (socket) => {
      socket.end('handled by parent');
    });
    server.listen(1337, () => {
      subprocess.send('server', server);
    });

åœ¨å­è¿›ç¨‹ä¸­æ¥æ”¶ serverï¼š

    process.on('message', (m, server) => {
      if (m === 'server') {
        server.on('connection', (socket) => {
          socket.end('handled by child');
        });
      }
    });

ä½¿ç”¨ socket å¯¹è±¡é€šä¿¡ï¼Œä½¿ç”¨ "normal" or "special" ä¸¤ä¸ªå­è¿›ç¨‹ä¼˜å…ˆçº§ï¼š

    const { fork } = require('child_process');
    const normal = fork('subprocess.js', ['normal']);
    const special = fork('subprocess.js', ['special']);

    // Open up the server and send sockets to child. Use pauseOnConnect to prevent
    // the sockets from being read before they are sent to the child process.
    const server = require('net').createServer({ pauseOnConnect: true });
    server.on('connection', (socket) => {

      // If this is special priority...
      if (socket.remoteAddress === '74.125.127.100') {
        special.send('socket', socket);
        return;
      }
      // This is normal priority.
      normal.send('socket', socket);
    });
    server.listen(1337);

å­è¿›ç¨‹æ¥æ”¶ socketï¼š

    process.on('message', (m, socket) => {
      if (m === 'socket') {
        if (socket) {
          // Check that the client socket exists.
          // It is possible for the socket to be closed between the time it is
          // sent and the time it is received in the child process.
          socket.end(`Request handled with ${process.argv[2]} priority`);
        }
      }
    });





# ğŸš© Global å…¨å±€å¯¹è±¡
- https://nodejs.org/docs/latest-v12.x/api/globals.html
- https://nodejs.org/docs/latest-v12.x/api/buffer.html
- https://developer.mozilla.org/en-US/docs/WebAssembly

åœ¨æ¨¡å—éƒ¨åˆ†è§£æè¿‡æš´éœ²çš„å‡ ä¸ªå…¨å±€å±æ€§æˆ–æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯ JavaScript built-in å¯¹è±¡ï¼Œå¯ä»¥å…¨å±€è®¿é—®ï¼š

- __dirname
- __filename
- exports
- module
- require()


Global objects

- Class: Buffer
- __dirname
- __filename
- clearImmediate(immediateObject)
- clearInterval(intervalObject)
- clearTimeout(timeoutObject)
- console
- exports
- global
- module
- process
- queueMicrotask(callback)
- require()
- setImmediate(callback[, ...args])
- setInterval(callback, delay[, ...args])
- setTimeout(callback, delay[, ...args])
- TextDecoder
- TextEncoder
- URL
- URLSearchParams
- WebAssembly


# ğŸš© Buffer äºŒè¿›åˆ¶æ•°æ®å¤„ç†
http://nodejs.cn/api/buffer.html

åœ¨å¼•å…¥ TypedArray ä¹‹å‰ï¼ŒJavaScript è¯­è¨€æ²¡æœ‰ç”¨äºè¯»å–æˆ–æ“ä½œäºŒè¿›åˆ¶æ•°æ®æµçš„æœºåˆ¶ã€‚ Buffer ç±»æ˜¯ä½œä¸º Node.js API çš„ä¸€éƒ¨åˆ†å¼•å…¥çš„ï¼Œç”¨äºåœ¨ TCP æµã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ä»¥åŠå…¶ä»–ä¸Šä¸‹æ–‡ä¸­ä¸å…«ä½å­—èŠ‚æµè¿›è¡Œäº¤äº’ã€‚

ç°åœ¨å¯ä»¥ä½¿ç”¨ TypedArrayï¼Œ Buffer ç±»ä»¥æ›´ä¼˜åŒ–å’Œæ›´é€‚åˆ Node.js çš„æ–¹å¼å®ç°äº† Uint8Array APIã€‚

Buffer ç±»çš„å®ä¾‹ç±»ä¼¼äºä» 0 åˆ° 255 ä¹‹é—´çš„æ•´æ•°æ•°ç»„ï¼ˆå…¶ä»–æ•´æ•°ä¼šé€šè¿‡ ï¼† 255 æ“ä½œå¼ºåˆ¶è½¬æ¢åˆ°æ­¤èŒƒå›´ï¼‰ï¼Œä½†å¯¹åº”äº V8 å †å¤–éƒ¨çš„å›ºå®šå¤§å°çš„åŸå§‹å†…å­˜åˆ†é…ã€‚ Buffer çš„å¤§å°åœ¨åˆ›å»ºæ—¶ç¡®å®šï¼Œä¸”æ— æ³•æ›´æ”¹ã€‚

Buffer ç±»åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ï¼Œå› æ­¤æ— éœ€ä½¿ç”¨ require('buffer').Bufferã€‚

    // åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”ç”¨é›¶å¡«å……çš„ Bufferã€‚
    const buf1 = Buffer.alloc(10);

    // åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”ç”¨ 0x1 å¡«å……çš„ Bufferã€‚ 
    const buf2 = Buffer.alloc(10, 1);

    // åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10ã€ä¸”æœªåˆå§‹åŒ–çš„ Bufferã€‚
    // è¿™ä¸ªæ–¹æ³•æ¯”è°ƒç”¨ Buffer.alloc() æ›´å¿«ï¼Œ
    // ä½†è¿”å›çš„ Buffer å®ä¾‹å¯èƒ½åŒ…å«æ—§æ•°æ®ï¼Œ
    // å› æ­¤éœ€è¦ä½¿ç”¨ fill() æˆ– write() é‡å†™ã€‚
    const buf3 = Buffer.allocUnsafe(10);

    // åˆ›å»ºä¸€ä¸ªåŒ…å« [0x1, 0x2, 0x3] çš„ Bufferã€‚
    const buf4 = Buffer.from([1, 2, 3]);

    // åˆ›å»ºä¸€ä¸ªåŒ…å« UTF-8 å­—èŠ‚ [0x74, 0xc3, 0xa9, 0x73, 0x74] çš„ Bufferã€‚
    const buf5 = Buffer.from('tÃ©st');

    // åˆ›å»ºä¸€ä¸ªåŒ…å« Latin-1 å­—èŠ‚ [0x74, 0xe9, 0x73, 0x74] çš„ Bufferã€‚
    const buf6 = Buffer.from('tÃ©st', 'latin1');

## Buffer ä¸å­—ç¬¦ç¼–ç 

å½“å­—ç¬¦ä¸²æ•°æ®è¢«å­˜å‚¨å…¥ Buffer å®ä¾‹æˆ–ä» Buffer å®ä¾‹ä¸­è¢«æå–æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªå­—ç¬¦ç¼–ç ã€‚

    const buf = Buffer.from('hello world', 'ascii');

    console.log(buf.toString('hex'));
    // æ‰“å°: 68656c6c6f20776f726c64
    console.log(buf.toString('base64'));
    // æ‰“å°: aGVsbG8gd29ybGQ=

    console.log(Buffer.from('fhqwhgads', 'ascii'));
    // æ‰“å°: <Buffer 66 68 71 77 68 67 61 64 73>
    console.log(Buffer.from('fhqwhgads', 'utf16le'));
    // æ‰“å°: <Buffer 66 00 68 00 71 00 77 00 68 00 67 00 61 00 64 00 73 00>

Node.js å½“å‰æ”¯æŒçš„å­—ç¬¦ç¼–ç æœ‰ï¼š

    'ascii': ä»…é€‚ç”¨äº 7 ä½ ASCII æ•°æ®ã€‚æ­¤ç¼–ç é€Ÿåº¦å¾ˆå¿«ï¼Œå¦‚æœè®¾ç½®åˆ™ä¼šå‰¥ç¦»é«˜ä½ã€‚
    'utf8': å¤šå­—èŠ‚ç¼–ç çš„ Unicode å­—ç¬¦ã€‚è®¸å¤šç½‘é¡µå’Œå…¶ä»–æ–‡æ¡£æ ¼å¼éƒ½ä½¿ç”¨ UTF-8ã€‚
    'utf16le': 2 æˆ– 4 ä¸ªå­—èŠ‚ï¼Œå°ç«¯åºç¼–ç çš„ Unicode å­—ç¬¦ã€‚æ”¯æŒä»£ç†å¯¹ï¼ˆU+10000 è‡³ U+10FFFFï¼‰ã€‚
    'ucs2': 'utf16le' çš„åˆ«åã€‚
    'base64': Base64 ç¼–ç ã€‚å½“ä»å­—ç¬¦ä¸²åˆ›å»º Buffer æ—¶ï¼Œæ­¤ç¼–ç ä¹Ÿä¼šæ­£ç¡®åœ°æ¥å— RFC 4648 ç¬¬ 5 èŠ‚ä¸­æŒ‡å®šçš„ â€œURL å’Œæ–‡ä»¶åå®‰å…¨å­—æ¯â€ã€‚
    'latin1': ä¸€ç§å°† Buffer ç¼–ç æˆå•å­—èŠ‚ç¼–ç å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼ˆç”± RFC 1345 ä¸­çš„ IANA å®šä¹‰ï¼Œç¬¬ 63 é¡µï¼Œä½œä¸º Latin-1 çš„è¡¥å……å—å’Œ C0/C1 æ§åˆ¶ç ï¼‰ã€‚
    'binary': 'latin1' çš„åˆ«åã€‚
    'hex': å°†æ¯ä¸ªå­—èŠ‚ç¼–ç æˆä¸¤ä¸ªåå…­è¿›åˆ¶çš„å­—ç¬¦ã€‚

ç°ä»£çš„ Web æµè§ˆå™¨éµå¾ª WHATWG ç¼–ç æ ‡å‡†ï¼Œå°† 'latin1' å’Œ 'ISO-8859-1' åˆ«åä¸º 'win-1252'ã€‚ è¿™æ„å‘³ç€å½“æ‰§è¡Œ http.get() ä¹‹ç±»çš„æ“ä½œæ—¶ï¼Œå¦‚æœè¿”å›çš„å­—ç¬¦é›†æ˜¯ WHATWG è§„èŒƒä¸­åˆ—å‡ºçš„å­—ç¬¦é›†ä¹‹ä¸€ï¼Œåˆ™æœåŠ¡å™¨å¯èƒ½å®é™…è¿”å› 'win-1252' ç¼–ç çš„æ•°æ®ï¼Œè€Œä½¿ç”¨ 'latin1' ç¼–ç å¯èƒ½é”™è¯¯åœ°è§£ç å­—ç¬¦ã€‚

## Buffer ä¸ TypedArray

Buffer å®ä¾‹ä¹Ÿæ˜¯ Uint8Array å®ä¾‹ï¼Œä½†æ˜¯ä¸ TypedArray æœ‰å¾®å°çš„ä¸åŒã€‚ ä¾‹å¦‚ï¼ŒArrayBuffer#slice() ä¼šåˆ›å»ºåˆ‡ç‰‡çš„æ‹·è´ï¼Œè€Œ Buffer#slice() æ˜¯åœ¨ç°æœ‰çš„ Buffer ä¸Šåˆ›å»ºè€Œä¸æ‹·è´ï¼Œè¿™ä½¿å¾— Buffer#slice() æ•ˆç‡æ›´é«˜ã€‚

ä¹Ÿå¯ä»¥ä»ä¸€ä¸ª Buffer åˆ›å»ºæ–°çš„ TypedArray å®ä¾‹ï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š

Buffer å¯¹è±¡çš„å†…å­˜æ˜¯è¢«æ‹·è´åˆ° TypedArrayï¼Œè€Œä¸æ˜¯å…±äº«ã€‚

Buffer å¯¹è±¡çš„å†…å­˜æ˜¯è¢«è§£é‡Šä¸ºä¸åŒå…ƒç´ çš„æ•°ç»„ï¼Œè€Œä¸æ˜¯ç›®æ ‡ç±»å‹çš„å­—èŠ‚æ•°ç»„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ new Uint32Array(Buffer.from([1, 2, 3, 4])) ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ 4 ä¸ªå…ƒç´  [1, 2, 3, 4] çš„ Uint32Arrayï¼Œè€Œä¸æ˜¯å¸¦æœ‰å•ä¸ªå…ƒç´  [0x1020304] æˆ– [0x4030201] çš„ Uint32Arrayã€‚

é€šè¿‡ä½¿ç”¨ TypedArray å¯¹è±¡çš„ .buffer å±æ€§ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸ TypedArray å®ä¾‹å…±äº«ç›¸åŒå†…å­˜çš„æ–° Bufferã€‚

    const arr = new Uint16Array(2);

    arr[0] = 5000;
    arr[1] = 4000;

    // æ‹·è´ `arr` çš„å†…å®¹ã€‚
    const buf1 = Buffer.from(arr);
    // ä¸ `arr` å…±äº«å†…å­˜ã€‚
    const buf2 = Buffer.from(arr.buffer);

    console.log(buf1);
    // æ‰“å°: <Buffer 88 a0>
    console.log(buf2);
    // æ‰“å°: <Buffer 88 13 a0 0f>

    arr[1] = 6000;

    console.log(buf1);
    // æ‰“å°: <Buffer 88 a0>
    console.log(buf2);
    // æ‰“å°: <Buffer 88 13 70 17>

å½“ä½¿ç”¨ TypedArray çš„ .buffer åˆ›å»º Buffer æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ å…¥ byteOffset å’Œ length å‚æ•°åªä½¿ç”¨ TypedArray çš„ä¸€éƒ¨åˆ†ã€‚

    const arr = new Uint16Array(20);
    const buf = Buffer.from(arr.buffer, 0, 16);

    console.log(buf.length);
    // æ‰“å°: 16

Buffer.from() ä¸ TypedArray.from() æœ‰ç€ä¸åŒçš„å®ç°ã€‚ å…·ä½“æ¥è¯´ï¼ŒTypedArray å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºæ˜ å°„å‡½æ•°ï¼Œåœ¨ç±»å‹æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä¸Šè°ƒç”¨ï¼š

    TypedArray.from(source[, mapFn[, thisArg]])

Buffer.from() åˆ™ä¸æ”¯æŒæ˜ å°„å‡½æ•°çš„ä½¿ç”¨ï¼š

    Buffer.from(array)
    Buffer.from(buffer)
    Buffer.from(arrayBuffer[, byteOffset[, length]])
    Buffer.from(string[, encoding])


## Buffer API

Buffer ç±»

    new Buffer(array)
    new Buffer(arrayBuffer[, byteOffset[, length]])
    new Buffer(buffer)
    new Buffer(size)
    new Buffer(string[, encoding])
    Buffer.alloc(size[, fill[, encoding]])
    Buffer.allocUnsafe(size)
    Buffer.allocUnsafeSlow(size)
    Buffer.byteLength(string[, encoding])
    Buffer.compare(buf1, buf2)
    Buffer.concat(list[, totalLength])
    Buffer.from(array)
    Buffer.from(arrayBuffer[, byteOffset[, length]])
    Buffer.from(buffer)
    Buffer.from(object[, offsetOrEncoding[, length]])
    Buffer.from(string[, encoding])
    Buffer.isBuffer(obj)
    Buffer.isEncoding(encoding)
    Buffer.poolSize
    buf[index]
    buf.buffer
    buf.byteOffset
    buf.compare(target[, targetStart[, targetEnd[, sourceStart[, sourceEnd]]]])
    buf.copy(target[, targetStart[, sourceStart[, sourceEnd]]])
    buf.entries()
    buf.equals(otherBuffer)
    buf.fill(value[, offset[, end]][, encoding])
    buf.includes(value[, byteOffset][, encoding])
    buf.indexOf(value[, byteOffset][, encoding])
    buf.keys()
    buf.lastIndexOf(value[, byteOffset][, encoding])
    buf.length
    buf.parent
    buf.readBigInt64BE([offset])
    buf.readBigInt64LE([offset])
    buf.readBigUInt64BE([offset])
    buf.readBigUInt64LE([offset])
    buf.readDoubleBE([offset])
    buf.readDoubleLE([offset])
    buf.readFloatBE([offset])
    buf.readFloatLE([offset])
    buf.readInt8([offset])
    buf.readInt16BE([offset])
    buf.readInt16LE([offset])
    buf.readInt32BE([offset])
    buf.readInt32LE([offset])
    buf.readIntBE(offset, byteLength)
    buf.readIntLE(offset, byteLength)
    buf.readUInt8([offset])
    buf.readUInt16BE([offset])
    buf.readUInt16LE([offset])
    buf.readUInt32BE([offset])
    buf.readUInt32LE([offset])
    buf.readUIntBE(offset, byteLength)
    buf.readUIntLE(offset, byteLength)
    buf.subarray([start[, end]])
    buf.slice([start[, end]])
    buf.swap16()
    buf.swap32()
    buf.swap64()
    buf.toJSON()
    buf.toString([encoding[, start[, end]]])
    buf.values()
    buf.write(string[, offset[, length]][, encoding])
    buf.writeBigInt64BE(value[, offset])
    buf.writeBigInt64LE(value[, offset])
    buf.writeBigUInt64BE(value[, offset])
    buf.writeBigUInt64LE(value[, offset])
    buf.writeDoubleBE(value[, offset])
    buf.writeDoubleLE(value[, offset])
    buf.writeFloatBE(value[, offset])
    buf.writeFloatLE(value[, offset])
    buf.writeInt8(value[, offset])
    buf.writeInt16BE(value[, offset])
    buf.writeInt16LE(value[, offset])
    buf.writeInt32BE(value[, offset])
    buf.writeInt32LE(value[, offset])
    buf.writeIntBE(value, offset, byteLength)
    buf.writeIntLE(value, offset, byteLength)
    buf.writeUInt8(value[, offset])
    buf.writeUInt16BE(value[, offset])
    buf.writeUInt16LE(value[, offset])
    buf.writeUInt32BE(value[, offset])
    buf.writeUInt32LE(value[, offset])
    buf.writeUIntBE(value, offset, byteLength)
    buf.writeUIntLE(value, offset, byteLength)

buffer.INSPECT_MAX_BYTES
buffer.kMaxLength
buffer.transcode(source, fromEnc, toEnc)

SlowBuffer ç±»

    new SlowBuffer(size)

Buffer å¸¸é‡

    buffer.constants.MAX_LENGTH
    buffer.constants.MAX_STRING_LENGTH


# ğŸš© assert æ–­è¨€
- https://nodejs.org/docs/latest-v12.x/api/assert.html

ä¸¤ç§æ¨¡å¼ï¼š

- Strict assertion mode: require('assert').strict;
- Legacy assertion mode: require('assert');

```
// const assert = require('assert');
const assert = require('assert').strict;

let a = [[[1, 2, 3]], 4, 5], b = [[[1, 2, 3]], 4, 5];
assert.deepEqual(a, a);
assert.deepEqual(a, b);
assert.deepStrictEqual(a, b);
```


API å‚è€ƒï¼š

- Assert
    - assert.deepEqual(actual, expected[, message])
    - assert.deepStrictEqual(actual, expected[, message])
    - assert.doesNotMatch(string, regexp[, message])
    - assert.doesNotReject(asyncFn[, error][, message])
    - assert.doesNotThrow(fn[, error][, message])
    - assert.equal(actual, expected[, message])
    - assert.fail([message])
    - assert.fail(actual, expected[, message[, operator[, stackStartFn]]]) â›”
    - assert.ifError(value)
    - assert.match(string, regexp[, message])
    - assert.notDeepEqual(actual, expected[, message])
    - assert.notDeepStrictEqual(actual, expected[, message])
    - assert.notEqual(actual, expected[, message])
    - assert.notStrictEqual(actual, expected[, message])
    - assert.ok(value[, message])
    - assert.rejects(asyncFn[, error][, message])
    - assert.strictEqual(actual, expected[, message])
    - assert.throws(fn[, error][, message])

- Class: assert.AssertionError
    - new assert.AssertionError(options)

- Class: assert.CallTracker
    - tracker.calls([fn][, exact])
    - tracker.report()
    - tracker.verify()
    - assert(value[, message])


# ğŸš© async_hooks å¼‚æ­¥å‹¾å­
- https://nodejs.org/docs/latest-v12.x/api/async_hooks.html

async_hooks ç”¨äº asynchronous resources è¿½è¸ªï¼Œèµ„æºåŠ¨ä½œä¼šè§¦å‘ç›¸åº”çš„ async_hooks å›è°ƒå‡½æ•°ã€‚

å¼‚æ­¥èµ„æºè¡¨ç¤ºå…·ä¸ hooks å›è°ƒå…³è”çš„å¯¹è±¡ï¼Œæ­¤å›è°ƒå¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼Œä¾‹å¦‚ï¼Œnet.createServer() ä¸­çš„ connection äº‹ä»¶ï¼Œæˆ–è€…åªæ˜¯ä¸€æ¬¡ fs.open()ï¼Œä¹Ÿå¯ä»¥åœ¨è°ƒç”¨ hooks å›è°ƒä¹‹å‰å…³é—­èµ„æºã€‚asynch_hook æ²¡æœ‰æ˜¾å¼åŒºåˆ†è¿™äº›ä¸åŒçš„æƒ…å†µï¼Œè€Œæ˜¯å°†å®ƒä»¬è¡¨ç¤ºä¸ºä½œä¸ºèµ„æºçš„æŠ½è±¡æ¦‚å¿µã€‚

å¦‚æœä½¿ç”¨ workerï¼Œåˆ™æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ async_hooks æ¥å£ï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹éƒ½å°†ä½¿ç”¨ä¸€ç»„æ–°çš„ async IDã€‚

hook callbak å¯ä»¥æ˜¯ï¼š

- init(asyncId, type, triggerAsyncId, resource)
- before()
- after()
- destroy()

 init é’©å­å‚æ•°åˆ—è¡¨ï¼š

 - asyncId å¼‚æ­¥èµ„æº IDï¼›
 - type å¼‚æ­¥èµ„æºç±»å‹ï¼›
 - triggerAsyncId å¼‚æ­¥èµ„æºåˆ›å»ºä¸Šä¸‹æ–‡çš„ IDï¼›
 - resource å¼‚æ­¥èµ„æºï¼›

 è§¦å‘ beforeã€afterã€destroy æ—¶ä¼šæ¥æ”¶åˆ° asyncIdï¼Œæ­¤ asyncId ä¸ fn å‡½æ•°å†…é€šè¿‡ executionAsyncId å–åˆ°çš„å€¼ç›¸åŒã€‚

```
const { createServer } = require('http');
const { executionAsyncId, executionAsyncResource, createHook } = require('async_hooks');

const sym = Symbol('state'); // Private symbol to avoid pollution
let data = [];

let hook = {
  init(asyncId, type, triggerAsyncId, resource) {
        const cr = executionAsyncResource();
        if(cr){
            resource[sym] = cr[sym];
        }
    const eid = executionAsyncId();
    data.push({init: asyncId, type, eid, triggerAsyncId/* , resource */})
  },
  before: (asyncId) => data.push({before: asyncId}),
  after: (asyncId) => data.push({after: asyncId}),
  destroy: (asyncId) => data.push({destroy: asyncId}),
}

createHook(hook).enable();

createServer((req, res) => {
  executionAsyncResource()[sym] = { state: req.url, data };
  setTimeout(function() {
    res.end(JSON.stringify(data, null, '  '));
  }, 100);
}).listen(3000);
```

è¾“å‡ºç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼š

```on
[
  { "init": 6, "type": "TCPSERVERWRAP", "eid": 1, "triggerAsyncId": 1 },
  { "init": 7, "type": "TickObject", "eid": 1, "triggerAsyncId": 6 },
  { "before": 7 },
  { "after": 7 },
  { "destroy": 7 },
  { "init": 8, "type": "TCPWRAP", "eid": 0, "triggerAsyncId": 6 },
  { "before": 6 },
  { "init": 9, "type": "HTTPINCOMINGMESSAGE", "eid": 6, "triggerAsyncId": 8 },
  { "init": 10, "type": "TickObject", "eid": 6, "triggerAsyncId": 8 },
  { "after": 6 },
  { "before": 10 },
  { "after": 10 },
  { "destroy": 10 },
  { "before": 9 },
  { "after": 9 },
  { "before": 9 },
  { "init": 11, "type": "Timeout", "eid": 9, "triggerAsyncId": 9 },
  { "after": 9 },
  { "before": 9 },
  { "after": 9 },
  { "before": 9 },
  { "after": 9 },
  { "before": 11 },
  { "before": 24 },
  { "init": 25, "type": "PIPEWRAP", "eid": 24, "triggerAsyncId": 24 },
  { "after": 24 },
  { "destroy": 17 },
  { "destroy": 24 },
  { "before": 8 },
  { "after": 8 },
  { "destroy": 9 },
  { "destroy": 8 },
]
```


Public API

    - async_hooks.createHook(callbacks)
    - async_hooks.executionAsyncResource()
    - async_hooks.executionAsyncId()
    - async_hooks.triggerAsyncId()

- Class: AsyncHook
    - asyncHook.enable()
    - asyncHook.disable()

- Hook callbacks
    - init(asyncId, type, triggerAsyncId, resource)
    - before(asyncId)
    - after(asyncId)
    - destroy(asyncId)
    - promiseResolve(asyncId)

- Class: AsyncResource
    - new AsyncResource(type[, options])
    - Static method: AsyncResource.bind(fn[, type])
    - asyncResource.bind(fn)
    - asyncResource.runInAsyncScope(fn[, thisArg, ...args])
    - asyncResource.emitDestroy()
    - asyncResource.asyncId()
    - asyncResource.triggerAsyncId()

- Class: AsyncLocalStorage
    - new AsyncLocalStorage()
    - asyncLocalStorage.disable()
    - asyncLocalStorage.getStore()
    - asyncLocalStorage.enterWith(store)
    - asyncLocalStorage.run(store, callback[, ...args])
    - asyncLocalStorage.exit(callback[, ...args])


# ğŸš© console æ§åˆ¶å°
- http://nodejs.cn/api/console.html
- https://nodejs.dev/learn/output-to-the-command-line-using-nodejs

console æ¨¡å—æä¾›äº†ä¸€ä¸ªç®€å•çš„è°ƒè¯•æ§åˆ¶å°ï¼Œç±»ä¼¼äº Web æµè§ˆå™¨æä¾›çš„ JavaScript æ§åˆ¶å°ã€‚

è¯¥æ¨¡å—å¯¼å‡ºä¸¤ä¸ªç‰¹å®šç»„ä»¶ï¼š

Console ç±»ï¼ŒåŒ…å« console.log()ã€ console.error() å’Œ console.warn() ç­‰æ–¹æ³•ï¼Œå¯ç”¨äºå†™å…¥ä»»ä½• Node.js æµã€‚
å…¨å±€çš„ console å®ä¾‹ï¼Œé…ç½®ä¸ºå†™å…¥ process.stdout å’Œ process.stderrã€‚ ä½¿ç”¨æ—¶æ— éœ€è°ƒç”¨ require('console')ã€‚
æ³¨æ„ï¼šå…¨å±€çš„ console å¯¹è±¡çš„æ–¹æ³•æ—¢ä¸åƒæµè§ˆå™¨ä¸­çš„ API é‚£æ ·æ€»æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿä¸åƒå…¶ä»– Node.js æµé‚£æ ·æ€»æ˜¯å¼‚æ­¥çš„ã€‚ è¯¦è§è¿›ç¨‹ I/Oã€‚

ä½¿ç”¨å…¨å±€ console çš„ç¤ºä¾‹ï¼š

    console.log('ä½ å¥½ä¸–ç•Œ');                // æ‰“å°åˆ° stdout: ä½ å¥½ä¸–ç•Œ
    console.log('ä½ å¥½%s', 'ä¸–ç•Œ');      // æ‰“å°åˆ° stdout: ä½ å¥½ä¸–ç•Œ
    console.error(new Error('é”™è¯¯ä¿¡æ¯'));// æ‰“å°åˆ° stderr: [Error: é”™è¯¯ä¿¡æ¯]

    const name = 'æè¿°';
    console.warn(`è­¦å‘Š${name}`);          // æ‰“å°åˆ° stderr: è­¦å‘Šæè¿°

æ‰“å°åˆ° stdoutï¼Œå¹¶åŠ ä¸Šæ¢è¡Œç¬¦ã€‚ å¯ä»¥ä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºä¸»è¦ä¿¡æ¯ï¼Œå…¶ä»–å‚æ•°ä½œä¸ºç±»ä¼¼äº printf(3) ä¸­çš„ä»£æ›¿å€¼ï¼ˆå‚æ•°éƒ½ä¼šä¼ ç»™ util.format()ï¼‰ã€‚

    const count = 5;
    console.log('è®¡æ•°: %d', count);
    // æ‰“å°åˆ° stdout: è®¡æ•°: 5 
    console.log('è®¡æ•°:', count);
    // æ‰“å°åˆ° stdout: è®¡æ•°: 5 
    æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ util.format()ã€‚


ä½¿ç”¨ Console ç±»çš„ç¤ºä¾‹ï¼š

    const out = getStreamSomehow();
    const err = getStreamSomehow();
    const myConsole = new console.Console(out, err);

    myConsole.log('ä½ å¥½ä¸–ç•Œ');              // æ‰“å°åˆ° out: ä½ å¥½ä¸–ç•Œ
    myConsole.log('ä½ å¥½%s', 'ä¸–ç•Œ');            // æ‰“å°åˆ° out: ä½ å¥½ä¸–ç•Œ
    myConsole.error(new Error('é”™è¯¯ä¿¡æ¯')); // æ‰“å°åˆ° err: [Error: é”™è¯¯ä¿¡æ¯]

    const name = 'æè¿°';
    myConsole.warn(`è­¦å‘Š${name}`);            // æ‰“å°åˆ° err: è­¦å‘Šæè¿°

    console.log('My %s has %d years', 'cat', 2)
    %s format a variable as a string
    %d format a variable as a number
    %i format a variable as its integer part only
    %o format a variable as an object

ä½¿ç”¨è¡¨æ ¼ç”Ÿæˆï¼š

    console.table(location)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          (index)           â”‚ Value â”‚                            length                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ancestorOrigins            â”‚     0 â”‚                                                             â”‚
    â”‚ href                       â”‚       â”‚ "https://deno.land/manual@v1.8.1/contributing/architecture" â”‚
    â”‚ origin                     â”‚       â”‚ "https://deno.land"                                         â”‚
    â”‚ protocol                   â”‚       â”‚ "https:"                                                    â”‚
    â”‚ host                       â”‚       â”‚ "deno.land"                                                 â”‚
    â”‚ hostname                   â”‚       â”‚ "deno.land"                                                 â”‚
    â”‚ pathname                   â”‚       â”‚ "/manual@v1.8.1/contributing/architecture"                  â”‚
    â”‚ Symbol(Symbol.toPrimitive) â”‚       â”‚ undefined                                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- Console API
    - new Console(stdout[, stderr][, ignoreErrors])
    - new Console(options)
    - console.assert(value[, ...message])
    - console.clear()
    - console.count([label])
    - console.countReset([label])
    - console.debug(data[, ...args])
    - console.dir(obj[, options])
    - console.dirxml(...data)
    - console.error([data][, ...args])
    - console.group([...label])
    - console.groupCollapsed()
    - console.groupEnd()
    - console.info([data][, ...args])
    - console.log([data][, ...args])
    - console.table(tabularData[, properties])
    - console.time([label])
    - console.timeEnd([label])
    - console.timeLog([label][, ...data])
    - console.trace([message][, ...args])
    - console.warn([data][, ...args])

- ä»…ç”¨äºè°ƒè¯•çš„æ–¹æ³•

    - console.markTimeline([label])
    - console.profile([label])
    - console.profileEnd([label])
    - console.timeStamp([label])
    - console.timeline([label])
    - console.timelineEnd([label])




# ğŸš© i18n å›½é™…åŒ–æ”¯æŒ
- https://nodejs.org/docs/latest-v12.x/api/intl.html
- ICU - International Components for Unicode http://site.icu-project.org
- https://github.com/nodejs/node/blob/master/BUILDING.md

Internationalization å•å­—æœ‰ 18 ä¸ªå­—æ¯ï¼Œç®€ç§° i18nã€‚

Node.js ä½¿ç”¨ C/C++ å®ç°ä»¥ä¸‹ ICU å›½é™…åŒ–åŠŸèƒ½æ”¯æŒï¼š

- ECMAScript Language Specification æ”¯æŒçš„æœ¬åœ°åŒ– Unicode å‡½æ•°:
    - String.prototype.normalize()
    - String.prototype.toLowerCase()
    - String.prototype.toUpperCase()
- æ”¯æŒæ‰€æœ‰ ECMAScript Internationalization API Specification (aka ECMA-402):
    - Intl object
    - Locale-sensitive methods like String.prototype.localeCompare() and Date.prototype.toLocaleString()
- WHATWG URL å¯è§£æçš„ IDNs - internationalized domain names
- require('buffer').transcode()
- More accurate REPL line editing
- require('util').TextDecoder
- RegExp Unicode Property Escapes

ç¼–è¯‘ Node.js æºä»£ç æ—¶å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é…ç½®é¡¹ï¼š

- --with-intl=none/--without-intl
- --with-intl=system-icu
- --with-intl=small-icu (default)
- --with-intl=full-icu



# ğŸš© Utilities Functions å®ç”¨å·¥å…·
- https://nodejs.org/docs/latest-v14.x/api/util.html#util_class_util_textdecoder
- http://nodejs.cn/api/util.html#util_util_format_format_args
- Encoding Living Standard https://encoding.spec.whatwg.org/

- Customizing util.inspect colors
- Modifiers
- Foreground colors
- Background colors
- Custom inspection functions on objects
    - Custom promisified functions

    - WHATWG supported encodings
    - Encodings Supported Without ICU
    - Encodings Supported by Default (With ICU)
    - Encodings requiring full ICU data

TextDecoder å’Œ TextEncoder æŒ‰ WHATWG è§„èŒƒå®ç°ç¼–ç è§£ç ï¼š

```
const decoder = new TextDecoder('shift_jis');
let string = '';
let buffer;
while (buffer = getNextChunkSomehow()) {
  string += decoder.decode(buffer, { stream: true });
}
string += decoder.decode(); // end-of-stream

const encoder = new TextEncoder();
const src = 'this is some data';
const dest = new Uint8Array(10);
const { read, written } = encoder.encodeInto(src, dest);
```

æ³¨æ„ï¼Œå¦‚æœ Node æ„å»ºæ—¶é…ç½®äº†å®Œå…¨çš„ Full ICU æŠ€æœ¯æ‰èƒ½ä½¿ç”¨ GBK è¿™æ ·çš„ç¼–ç ï¼ŒSmall-ICU æ”¯æŒ utf-8 utf-16le utf-16beï¼Œå¦‚æœç¦ç”¨åˆ™æ”¯æŒ utf-8 utf-16le ä¸¤ç§ã€‚

- Static
    - util.callbackify(original)
    - util.debuglog(section[, callback])
    - util.deprecate(fn, msg[, code])
    - util.format(format[, ...args])
    - util.formatWithOptions(inspectOptions, format[, ...args])
    - util.getSystemErrorName(err)
    - util.inherits(constructor, superConstructor)
    - util.inspect(object[, options])
    - util.inspect(object[, showHidden[, depth[, colors]]])
    - util.inspect.custom
    - util.inspect.defaultOptions
    - util.isDeepStrictEqual(val1, val2)
    - util.promisify(original)
    - util.promisify.custom

- Class: util.TextDecoder
    - new TextDecoder([encoding[, options]])
    - textDecoder.decode([input[, options]])
    - textDecoder.encoding
    - textDecoder.fatal
    - textDecoder.ignoreBOM

- Class: util.TextEncoder
    - textEncoder.encode([input])
    - textEncoder.encodeInto(src, dest)
    - textEncoder.encoding

- util.types
    - util.types.isAnyArrayBuffer(value)
    - util.types.isArrayBufferView(value)
    - util.types.isArgumentsObject(value)
    - util.types.isArrayBuffer(value)
    - util.types.isAsyncFunction(value)
    - util.types.isBigInt64Array(value)
    - util.types.isBigUint64Array(value)
    - util.types.isBooleanObject(value)
    - util.types.isBoxedPrimitive(value)
    - util.types.isDataView(value)
    - util.types.isDate(value)
    - util.types.isExternal(value)
    - util.types.isFloat32Array(value)
    - util.types.isFloat64Array(value)
    - util.types.isGeneratorFunction(value)
    - util.types.isGeneratorObject(value)
    - util.types.isInt8Array(value)
    - util.types.isInt16Array(value)
    - util.types.isInt32Array(value)
    - util.types.isMap(value)
    - util.types.isMapIterator(value)
    - util.types.isModuleNamespaceObject(value)
    - util.types.isNativeError(value)
    - util.types.isNumberObject(value)
    - util.types.isPromise(value)
    - util.types.isProxy(value)
    - util.types.isRegExp(value)
    - util.types.isSet(value)
    - util.types.isSetIterator(value)
    - util.types.isSharedArrayBuffer(value)
    - util.types.isStringObject(value)
    - util.types.isSymbolObject(value)
    - util.types.isTypedArray(value)
    - util.types.isUint8Array(value)
    - util.types.isUint8ClampedArray(value)
    - util.types.isUint16Array(value)
    - util.types.isUint32Array(value)
    - util.types.isWeakMap(value)
    - util.types.isWeakSet(value)
    - util.types.isWebAssemblyCompiledModule(value)

## util.promisify(original)

å°è£…å‡½æ•° util.promisify(original) å¯ä»¥å°†é‚£äº›ä¾èµ–å›è°ƒçš„å¼‚æ­¥å‡½æ•°ï¼Œå°è£…æˆ Promise å½¢å¼ï¼Œå°† callback å˜æˆ catch è¯­æ³•ã€‚

è¢«å°è£…çš„å‡½æ•°è¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼Œå³æœ€åä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•° `(err, value) => ...`ã€‚

```
const util = require('util');
const fs = require('fs');

const stat = util.promisify(fs.stat);
stat('.').then((stats) => {
  // Do something with `stats`
}).catch((error) => {
  // Handle the error.
});

//Or, equivalently using async functions:

const util = require('util');
const fs = require('fs');

const stat = util.promisify(fs.stat);

async function callStat() {
  const stats = await stat('.');
  console.log(`This directory is owned by ${stats.uid}`);
}
```

å¦‚æœå‡½æ•°ä¸ç¬¦åˆè¿™ä¸ªæ ¼å¼ï¼Œéœ€è¦ç»™å‡½æ•°å¢åŠ ä¸€ä¸ª util.promisify.custom å±æ€§ï¼ŒæŒ‡å®šä¸€ä¸ªå‡½æ•°ä½œä¸º Promise åŒ–å¤„ç†å‡½æ•°ï¼Œå³å¯ã€‚

```
const util = require('util');

function doSomething(foo, callback) {
  // ...
}

doSomething[util.promisify.custom] = (foo) => {
  return getPromiseSomehow();
};

const promisified = util.promisify(doSomething);
console.log(promisified === doSomething[util.promisify.custom]);
// prints 'true'
```


## util.format(format[, ...args])

    format <string> ä¸€ä¸ªç±»ä¼¼ printf çš„æ ¼å¼å­—ç¬¦ä¸²ã€‚

util.format() æ–¹æ³•è¿”å›ä¸€ä¸ªæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºä¸€ä¸ªç±»ä¼¼ printf çš„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²å¯ä»¥åŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªæ ¼å¼å ä½ç¬¦ã€‚ æ¯ä¸ªå ä½ç¬¦ä¼šè¢«å¯¹åº”å‚æ•°è½¬æ¢åçš„å€¼æ‰€æ›¿æ¢ã€‚ æ”¯æŒçš„å ä½ç¬¦æœ‰ï¼š

    %s - String å°†ç”¨äºè½¬æ¢é™¤ BigIntã€ Object å’Œ -0 å¤–çš„æ‰€æœ‰å€¼ã€‚BigInt å€¼å°†ç”¨ n è¡¨ç¤ºï¼Œè€Œæ²¡æœ‰ç”¨æˆ·å®šä¹‰ toString å‡½æ•°çš„å¯¹è±¡ä½¿ç”¨å¸¦æœ‰é€‰é¡¹ { depth: 0, colors: false, compact: 3 } çš„ util.inspect() è¿›è¡Œæ£€æŸ¥ã€‚
    %d - Number å°†ç”¨äºè½¬æ¢é™¤ BigInt å’Œ Symbol ä¹‹å¤–çš„æ‰€æœ‰å€¼ã€‚
    %i - parseInt(value, 10) ç”¨äºé™¤ BigInt å’Œ Symbol ä¹‹å¤–çš„æ‰€æœ‰å€¼ã€‚
    %f - parseFloat(value) ç”¨äºé™¤ BigInt å’Œ Symbol ä¹‹å¤–çš„æ‰€æœ‰å€¼ã€‚
    %j - JSONã€‚å¦‚æœå‚æ•°åŒ…å«å¾ªç¯å¼•ç”¨ï¼Œåˆ™æ›¿æ¢ä¸ºå­—ç¬¦ä¸² '[Circular]'ã€‚
    %o - Objectã€‚å…·æœ‰é€šç”¨ JavaScript å¯¹è±¡æ ¼å¼çš„å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ ç±»ä¼¼äºå¸¦æœ‰é€‰é¡¹ { showHidden: true, showProxy: true } çš„ util.inspect()ã€‚ è¿™å°†æ˜¾ç¤ºå®Œæ•´å¯¹è±¡ï¼ŒåŒ…æ‹¬éå¯æšä¸¾å±æ€§å’Œä»£ç†ã€‚
    %O - Objectã€‚å…·æœ‰é€šç”¨ JavaScript å¯¹è±¡æ ¼å¼çš„å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ ç±»ä¼¼äº util.inspect() ä½†æ²¡æœ‰é€‰é¡¹ã€‚ è¿™å°†æ˜¾ç¤ºå®Œæ•´å¯¹è±¡ï¼Œä¸åŒ…æ‹¬éå¯æšä¸¾å±æ€§å’Œä»£ç†ã€‚
    %c - CSSã€‚è¯¥è¯´æ˜ç¬¦å½“å‰ä¼šè¢«å¿½ç•¥ï¼Œå°†ä¼šè·³è¿‡ä»»ä½•ä¼ å…¥çš„ CSSã€‚
    %% - å•ä¸ªç™¾åˆ†å·ï¼ˆ'%'ï¼‰ã€‚è¿™ä¸ä¼šæ¶ˆè€—å‚æ•°ã€‚
    è¿”å›: <string> æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ã€‚

å¦‚æœå ä½ç¬¦æ²¡æœ‰å¯¹åº”çš„å‚æ•°ï¼Œåˆ™å ä½ç¬¦ä¸è¢«æ›¿æ¢ã€‚

    util.format('%s:%s', 'foo');
    // è¿”å›: 'foo:%s'

å¦‚æœç±»å‹ä¸æ˜¯ stringï¼Œåˆ™ä½¿ç”¨ util.inspect() æ ¼å¼åŒ–ä¸å±äºæ ¼å¼å­—ç¬¦ä¸²çš„å€¼ã€‚

å¦‚æœä¼ å…¥ util.format() æ–¹æ³•çš„å‚æ•°æ¯”å ä½ç¬¦çš„æ•°é‡å¤šï¼Œåˆ™å¤šå‡ºçš„å‚æ•°ä¼šè¢«å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åæ‹¼æ¥åˆ°è¿”å›çš„å­—ç¬¦ä¸²ï¼Œå‚æ•°ä¹‹é—´ç”¨ä¸€ä¸ªç©ºæ ¼åˆ†éš”ã€‚

    util.format('%s:%s', 'foo', 'bar', 'baz');
    // è¿”å›: 'foo:bar baz'

å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ™ util.format() è¿”å›ä¸€ä¸ªæ‰€æœ‰å‚æ•°ç”¨ç©ºæ ¼åˆ†éš”å¹¶è¿åœ¨ä¸€èµ·çš„å­—ç¬¦ä¸²ã€‚

    util.format(1, 2, 3);
    // è¿”å›: '1 2 3'

å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ä¼ ç»™ util.format()ï¼Œå®ƒå°†æŒ‰åŸæ ·è¿”å›ï¼Œä¸å¸¦ä»»ä½•æ ¼å¼ï¼š

    util.format('%% %s');
    // è¿”å›: '%% %s'

util.format() æ˜¯ä¸€ç§ç”¨ä½œè°ƒè¯•å·¥å…·çš„åŒæ­¥æ–¹æ³•ã€‚ æŸäº›è¾“å…¥å€¼å¯èƒ½ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½å¼€é”€ï¼Œä»è€Œé˜»æ­¢äº‹ä»¶å¾ªç¯ã€‚ è¯·è°¨æ…ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œåˆ‡å‹¿åœ¨çƒ­ä»£ç è·¯å¾„ä¸­ä½¿ç”¨ã€‚



# ğŸš© Crypto åŠ å¯†æ¨¡å—
- https://nodejs.org/docs/latest-v12.x/api/crypto.html
- https://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/
- https://stackoverflow.com/questions/1220751/how-to-choose-an-aes-encryption-mode-cbc-ecb-ctr-ocb-cfb
- æ¤­åœ†æ›²çº¿ç®—æ³•ï¼šå…¥é—¨ https://www.jianshu.com/p/2e6031ac3d50?from=groupmessage
- https://andrea.corbellini.name/2015/05/30/elliptic-curve-cryptography-ecdh-and-ecdsa/
- https://github.com/openssl/openssl/blob/81fc390/crypto/ec/ec_curve.c#L766
- AES, Advanced Encryption Standard https://github.com/matt-wu/AES
- Cryptography Theory and Practice 4th å¯†ç å­¦åŸç†ä¸å®è·µ
- [ASN.1 key structures in DER and PEM](https://tls.mbed.org/kb/cryptography/asn1-key-structures-in-der-and-pem)
- [ASN.1 JavaScript decoder](https://lapo.it/asn1js/)
- [RFC 6025 - ASN.1 Translation](https://www.rfc-editor.org/rfc/rfc6025.html)
- [RFC 1421 - Privacy Enhance Mail Part I: Message Encryption and Authentication Procedures](https://www.rfc-editor.org/rfc/rfc1421.html)
- [RFC 2315 - Privacy Enhance Mail](https://www.rfc-editor.org/rfc/rfc2315.html)
- [RFC 2986 - Certificate Signing Request](https://www.rfc-editor.org/info/rfc2986)
- [RSAç®—æ³•åŸç†ï¼ˆä¸€ï¼‰é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html)
- [RSAç®—æ³•åŸç†ï¼ˆäºŒï¼‰é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html)
- [æ•°å­—ç­¾åæ˜¯ä»€ä¹ˆï¼Ÿ](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)
- [What is a Digital Signature? An introduction to Digital Signatures, by David Youd](http://www.youdzone.com/signature.html)
- ä¿¡æ¯å®‰å…¨æŠ€æœ¯ SM2 æ¤­åœ†æ›²çº¿å…¬é’¥å¯†ç ç®—æ³• http://www.gb688.cn/bzgk/gb/std_list?p.p1=0&p.p90=circulation_date&p.p91=desc&p.p2=32918
- SMç³»åˆ—å›½å¯†ç®—æ³• https://www.cnblogs.com/lyh523329053/p/10238260.html

æä¾›å¯†ç å­¦å‡½æ•°ï¼Œcryptographic functionalityï¼ŒåŒ…å« OpenSSL's hash, HMAC, cipher, decipher, sign, and verify functions.


## å¯¹ç§°åŠ å¯†ç®—æ³•

é€šè¿‡ crypto.getCiphers() è·å–å®Œæ•´çš„å¯¹ç§°åŠ å¯†ç®—æ³•åˆ—è¡¨ï¼š

    | aes-128-cbc             | aria-128-cbc  | bf                | des                      | rc2          |
    | aes-128-cbc-hmac-sha1   | aria-128-ccm  | bf-cbc            | des-cbc                  | rc2-128      |
    | aes-128-cbc-hmac-sha256 | aria-128-cfb  | bf-cfb            | des-cfb                  | rc2-40       |
    | aes-128-ccm             | aria-128-cfb1 | bf-ecb            | des-cfb1                 | rc2-40-cbc   |
    | aes-128-cfb             | aria-128-cfb8 | bf-ofb            | des-cfb8                 | rc2-64       |
    | aes-128-cfb1            | aria-128-ctr  | blowfish          | des-ecb                  | rc2-64-cbc   |
    | aes-128-cfb8            | aria-128-ecb  | camellia-128-cbc  | des-ede                  | rc2-cbc      |
    | aes-128-ctr             | aria-128-gcm  | camellia-128-cfb  | des-ede-cbc              | rc2-cfb      |
    | aes-128-ecb             | aria-128-ofb  | camellia-128-cfb1 | des-ede-cfb              | rc2-ecb      |
    | aes-128-gcm             | aria-192-cbc  | camellia-128-cfb8 | des-ede-ecb              | rc2-ofb      |
    | aes-128-ocb             | aria-192-ccm  | camellia-128-ctr  | des-ede-ofb              | rc4          |
    | aes-128-ofb             | aria-192-cfb  | camellia-128-ecb  | des-ede3                 | rc4-40       |
    | aes-128-xts             | aria-192-cfb1 | camellia-128-ofb  | des-ede3-cbc             | rc4-hmac-md5 |
    | aes-192-cbc             | aria-192-cfb8 | camellia-192-cbc  | des-ede3-cfb             | seed         |
    | aes-192-ccm             | aria-192-ctr  | camellia-192-cfb  | des-ede3-cfb1            | seed-cbc     |
    | aes-192-cfb             | aria-192-ecb  | camellia-192-cfb1 | des-ede3-cfb8            | seed-cfb     |
    | aes-192-cfb1            | aria-192-gcm  | camellia-192-cfb8 | des-ede3-ecb             | seed-ecb     |
    | aes-192-cfb8            | aria-192-ofb  | camellia-192-ctr  | des-ede3-ofb             | seed-ofb     |
    | aes-192-ctr             | aria-256-cbc  | camellia-192-ecb  | des-ofb                  | sm4          |
    | aes-192-ecb             | aria-256-ccm  | camellia-192-ofb  | des3                     | sm4-cbc      |
    | aes-192-gcm             | aria-256-cfb  | camellia-256-cbc  | des3-wrap                | sm4-cfb      |
    | aes-192-ocb             | aria-256-cfb1 | camellia-256-cfb  | desx                     | sm4-ctr      |
    | aes-192-ofb             | aria-256-cfb8 | camellia-256-cfb1 | desx-cbc                 | sm4-ecb      |
    | aes-256-cbc             | aria-256-ctr  | camellia-256-cfb8 | id-aes128-CCM            | sm4-ofb      |
    | aes-256-cbc-hmac-sha1   | aria-256-ecb  | camellia-256-ctr  | id-aes128-GCM            |              |
    | aes-256-cbc-hmac-sha256 | aria-256-gcm  | camellia-256-ecb  | id-aes128-wrap           |              |
    | aes-256-ccm             | aria-256-ofb  | camellia-256-ofb  | id-aes128-wrap-pad       |              |
    | aes-256-cfb             | aria128       | camellia128       | id-aes192-CCM            |              |
    | aes-256-cfb1            | aria192       | camellia192       | id-aes192-GCM            |              |
    | aes-256-cfb8            | aria256       | camellia256       | id-aes192-wrap           |              |
    | aes-256-ctr             |               | cast              | id-aes192-wrap-pad       |              |
    | aes-256-ecb             |               | cast-cbc          | id-aes256-CCM            |              |
    | aes-256-gcm             |               | cast5-cbc         | id-aes256-GCM            |              |
    | aes-256-ocb             |               | cast5-cfb         | id-aes256-wrap           |              |
    | aes-256-ofb             |               | cast5-ecb         | id-aes256-wrap-pad       |              |
    | aes-256-xts             |               | cast5-ofb         | id-smime-alg-CMS3DESwrap |              |
    | aes128                  |               | chacha20          | idea                     |              |
    | aes128-wrap             |               | chacha20-poly1305 | idea-cbc                 |              |
    | aes192                  |               |                   | idea-cfb                 |              |
    | aes192-wrap             |               |                   | idea-ecb                 |              |
    | aes256                  |               |                   | idea-ofb                 |              |
    | aes256-wrap             |               |                   |                          |              |


ç®—æ³•çš„æ¨¡å¼å¦‚ä¸‹ï¼š

- ä»…é™åŠ å¯†ï¼š
    - éœ€è¦å¡«å……çš„æ¨¡å¼ï¼šä¸ç¤ºä¾‹ä¸­ä¸€æ ·ï¼Œå¡«å……é€šå¸¸å¾ˆå±é™©ï¼Œå› ä¸ºå®ƒå¯ä»¥å¡«å…… oracle æ”»å‡»ã€‚
        - cbc - Cipher Block Chaining å¯†ç åˆ†ç»„é“¾æ¥æ¨¡å¼ï¼Œå…ˆå°†æ˜æ–‡åˆ‡åˆ†æˆè‹¥å¹²å°æ®µï¼Œç„¶åä¸åˆå§‹å—æˆ–è€…ä¸Šä¸€æ®µçš„å¯†æ–‡æ®µè¿›è¡Œå¼‚æˆ–è¿ç®—åï¼Œå†è¿›è¡ŒåŠ å¯†ã€‚
        - ecb - Electronic Codebook Book ç”µç æœ¬æ¨¡å¼ï¼Œå°†æ•´ä¸ªæ˜æ–‡åˆ†æˆè‹¥å¹²æ®µç›¸åŒçš„å°æ®µï¼Œç„¶åå¯¹æ¯ä¸€å°æ®µè¿›è¡ŒåŠ å¯†ã€‚
    - æµå¯†ç æ¨¡å¼ï¼šè¿™äº›æ¨¡å¼ç”Ÿæˆå¯èƒ½æˆ–å¯èƒ½ä¸ä¾èµ–äºæ˜æ–‡çš„ä¼ªéšæœºæ•°æ®æµã€‚
        - cfb - Cipher FeedBack å¯†ç åé¦ˆæ¨¡å¼ï¼Œè¿™ç§ç®—æ³•æ¨¡å¼è¾ƒå¤æ‚ã€‚
        - ctr - Counter è®¡æ•°å™¨æ¨¡å¼ï¼Œæœ‰è‡ªå¢çš„ç®—å­ï¼Œç®—å­åŠ å¯†ä¹‹åçš„è¾“å‡ºå’Œæ˜æ–‡å¼‚æˆ–çš„ç»“æœå¾—åˆ°å¯†æ–‡ï¼Œç›¸å½“äºä¸€æ¬¡ä¸€å¯†ã€‚è¿™ç§åŠ å¯†æ–¹å¼ç®€å•å¿«é€Ÿï¼Œå®‰å…¨å¯é ï¼Œå¯ä»¥å¹¶è¡ŒåŠ å¯†ã€‚
        - ofb - Output FeedBack è¾“å‡ºåé¦ˆæ¨¡å¼ï¼ŒåŒä¸Šã€‚
    - ç£ç›˜åŠ å¯†æ¨¡å¼ï¼šè¿™äº›æ¨¡å¼ä¸“é—¨ç”¨äºåŠ å¯†æ–‡ä»¶ç³»ç»ŸæŠ½è±¡ä¸‹çš„æ•°æ®ï¼Œä¸€äº›æˆå‘˜ï¼šxexï¼Œxtsï¼Œlrwã€‚
- è®¤è¯åŠ å¯†

    ä¸ºäº†é˜²æ­¢å¡«å…… oracle æ”»å‡»å’Œå¯†æ–‡æ›´æ”¹ï¼Œå¯ä»¥åœ¨å¯†æ–‡ä¸Šè®¡ç®—æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰ï¼Œåªæœ‰åœ¨æ²¡æœ‰è¢«ç¯¡æ”¹çš„æƒ…å†µä¸‹æ‰è§£å¯†ã€‚è¿™ç§°ä¸º encrypt-then-macï¼Œåº”è¯¥ä¼˜å…ˆäºä»»ä½•å…¶ä»–é¡ºåºã€‚é™¤æå°‘æ•°ç”¨ä¾‹å¤–ï¼ŒçœŸå®æ€§ä¸æœºå¯†æ€§ä¸€æ ·é‡è¦ï¼ˆåè€…æ˜¯åŠ å¯†çš„ç›®çš„ï¼‰ã€‚ç»è¿‡èº«ä»½éªŒè¯çš„åŠ å¯†æ–¹æ¡ˆï¼ˆå¸¦æœ‰å…³è”æ•°æ®ï¼ˆAEADï¼‰ï¼‰å°†åŠ å¯†å’Œèº«ä»½éªŒè¯çš„ä¸¤ä¸ªéƒ¨åˆ†è¿‡ç¨‹ç»„åˆæˆä¸€ä¸ªå—å¯†ç æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¹Ÿä¼šåœ¨è¿‡ç¨‹ä¸­ç”Ÿæˆèº«ä»½éªŒè¯æ ‡è®°ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¼šæé«˜é€Ÿåº¦ã€‚

    - CCM æ˜¯ CTR æ¨¡å¼å’Œ CBC-MAC çš„ç®€å•ç»„åˆï¼Œæ¯ä¸ªå—ä½¿ç”¨ä¸¤ä¸ªåˆ†ç»„å¯†ç åŠ å¯†éå¸¸æ…¢ã€‚
    - OCB æ›´å¿«ä½†å—ä¸“åˆ©é™åˆ¶ï¼Œä½†æ˜¯ï¼Œå¯¹äºå…è´¹æˆ–éå†›äº‹è½¯ä»¶ï¼Œä¸“åˆ©æŒæœ‰äººå·²ç»æˆäºˆäº†å…è´¹è®¸å¯ã€‚
    - GCM æ˜¯ä¸€ç§éå¸¸å¿«é€Ÿä½†å¯ä»¥è¯´æ˜¯å¤æ‚çš„ CTR æ¨¡å¼å’Œ GHASH çš„ç»„åˆï¼Œæ˜¯ Galois å­—æ®µä¸Šçš„ MACï¼Œå…·æœ‰ 2^128 ä¸ªå…ƒç´ ã€‚

å¯¹ç§°åŠ å¯†ç®—æ³•æœ‰ä¸¤ä¸ªè¿‡ç¨‹ï¼ŒCipher å’Œ Decipherï¼Œä»¥ AES-256-GCM ç®—æ³•ä¸ºä¾‹æ¼”ç¤ºå¯¹ç§°åŠ å¯†ä¸è§£å¯†ï¼š

```
const crypto = require('crypto');

const text = 'Testing AES GCM mode';

const key = Buffer.from("yourpassword".repeat(32).substr(0, 32));
const iv = crypto.randomBytes(16);
const algorithm = 'aes-256-gcm';

const cipher = crypto.createCipheriv(algorithm, key, iv);
let encrypted = cipher.update(text, 'utf8', 'hex');
encrypted += cipher.final('hex');
const tag = cipher.getAuthTag();

const decipher = crypto.createDecipheriv(algorithm, key, iv);
decipher.setAuthTag(tag);
let decrypted = decipher.update(encrypted, 'hex', 'utf8');
decrypted += decipher.final('utf8');

console.log({text, algorithm, encrypted, tag, key, iv, decrypted});
```


## HASH æ‘˜è¦ç®—æ³•

é€šè¿‡ crypto.getHashes() è·å–å®Œæ•´çš„å“ˆå¸Œå‡½æ•°åˆ—è¡¨ï¼š

    | RSA-MD4        | blake2b512                         | sha1                        | sha512WithRSAEncryption |
    | RSA-MD5        | blake2s256                         | sha1WithRSAEncryption       | shake128                |
    | RSA-MDC2       | id-rsassa-pkcs1-v1_5-with-sha3-224 | sha224                      | shake256                |
    | RSA-RIPEMD160  | id-rsassa-pkcs1-v1_5-with-sha3-256 | sha224WithRSAEncryption     | sm3                     |
    | RSA-SHA1       | id-rsassa-pkcs1-v1_5-with-sha3-384 | sha256                      | sm3WithRSAEncryption    |
    | RSA-SHA1-2     | id-rsassa-pkcs1-v1_5-with-sha3-512 | sha256WithRSAEncryption     | ssl3-md5                |
    | RSA-SHA224     | md4                                | sha3-224                    | ssl3-sha1               |
    | RSA-SHA256     | md4WithRSAEncryption               | sha3-256                    | whirlpool               |
    | RSA-SHA3-224   | md5                                | sha3-384                    |                         |
    | RSA-SHA3-256   | md5-sha1                           | sha3-512                    |                         |
    | RSA-SHA3-384   | md5WithRSAEncryption               | sha384                      |                         |
    | RSA-SHA3-512   | mdc2                               | sha384WithRSAEncryption     |                         |
    | RSA-SHA384     | mdc2WithRSA                        | sha512                      |                         |
    | RSA-SHA512     | ripemd                             | sha512-224                  |                         |
    | RSA-SHA512/224 | ripemd160                          | sha512-224WithRSAEncryption |                         |
    | RSA-SHA512/256 | ripemd160WithRSA                   | sha512-256                  |                         |
    | RSA-SM3        | rmd160                             | sha512-256WithRSAEncryption |                         |

SHA-256 Hash å‡½æ•°ä½¿ç”¨ç¤ºèŒƒï¼ŒæŒ‰æµå¼ä½¿ç”¨æˆ–ç›´æ¥è°ƒç”¨æ‘˜è¦æ–¹æ³•ï¼Œæ¯ä¸ª Hash åœ¨æ‰§è¡Œ copy() æ–¹æ³•å¯ä»¥æ‹·è´ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™æ ·å¤šæ¬¡æ‰§è¡Œæ‘˜è¦ï¼š

```
const crypto = require('crypto');
const hash = crypto.createHash('sha256');

// Example: Using Hash objects as streams
hash.on('readable', () => {
  // Only one element is going to be produced by the
  // hash stream.
  const data = hash.read();
  if (data) {
    console.log(data.toString('hex'));
  }
});

hash.write('some data to hash');
hash.end();

// Using the hash.update() and hash.digest() methods
hash.update('one');
console.log(hash.copy().digest('hex'));

hash.update('two');
console.log(hash.copy().digest('hex'));
```

PBKDF2 - Password-Based Key Derivation Function åº”ç”¨ä¸€ä¸ªä¼ªéšæœºå‡½æ•°ä»¥å¯¼å‡ºå¯†é’¥ï¼Œå¯¼å‡ºå¯†é’¥çš„é•¿åº¦æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯ï¼Œå¯¼å‡ºå¯†é’¥çš„æœ€å¤§æœ‰æ•ˆæœç´¢ç©ºé—´å—é™äºåŸºæœ¬ä¼ªéšæœºå‡½æ•°çš„ç»“æ„ã€‚

ç”±äºå“ˆå¸Œç®—æ³•æ˜¯å•å‘çš„ï¼Œèƒ½å¤Ÿå°†ä¸è®ºä»€ä¹ˆå¤§å°çš„æ•°æ®è½¬åŒ–ä¸ºå®šé•¿çš„â€œæŒ‡çº¹â€ï¼Œå¹¶ä¸”æ— æ³•è¢«åå‘è®¡ç®—ï¼Œéå¸¸é€‚åˆé‚£äº›ä¸èƒ½ä»¥æ˜æ–‡æ–¹å¼ä¿å­˜å¯†é’¥çš„åœºæ™¯ã€‚

PBKDF2 ç®€å•è€Œè¨€å°±æ˜¯å¤šæ¬¡è®¡ç®— salted hashï¼Œè¿™ä¸ªæ¬¡æ•°æ˜¯å¯é€‰æ‹©çš„ã€‚å¦‚æœè®¡ç®—ä¸€æ¬¡æ‰€éœ€è¦çš„æ—¶é—´æ˜¯ 1 å¾®ç§’ï¼Œé‚£ä¹ˆè®¡ç®— 1 ç™¾ä¸‡æ¬¡å°±éœ€è¦ 1 ç§’é’Ÿã€‚å‡å¦‚æ”»å‡»ä¸€ä¸ªå¯†ç æ‰€éœ€çš„ rainbow table æœ‰ 1 åƒä¸‡æ¡ï¼Œå»ºç«‹å¯¹åº”çš„ rainbow table å°±éœ€è¦è¶…è¿‡ 115 å¤©æ—¶é—´ã€‚

ç¾å›½æ”¿åºœæœºæ„å·²ç»å°†è¿™ä¸ªæ–¹æ³•æ ‡å‡†åŒ–ï¼Œå¹¶ä¸”ç”¨äºä¸€äº›æ”¿åºœå’Œå†›æ–¹çš„ç³»ç»Ÿã€‚ è¿™ä¸ªæ–¹æ¡ˆæœ€å¤§çš„ä¼˜ç‚¹æ˜¯æ ‡å‡†åŒ–ï¼Œå®ç°å®¹æ˜“åŒæ—¶é‡‡ç”¨äº†ä¹…ç»è€ƒéªŒçš„ SHA ç®—æ³•ã€‚

```
const crypto = require('crypto');

crypto.randomBytes(32, (err, salt) => {
  if (err) throw err;
    let iterations = 4096, keylen = 512, digest = 'sha256';
  crypto.pbkdf2("password", salt, iterations, keylen, digest, (err, key) => {
        if (err) throw err;
        console.log({secret: key.toString('hex'), salt: salt.toString('hex')});
  });
});
```

HMAC - Hash-based Message Authentication Code æ˜¯å¯†é’¥ç›¸å…³çš„å“ˆå¸Œè¿ç®—æ¶ˆæ¯è®¤è¯ç ï¼Œç”± H.Krawezykï¼ŒM.Bellareï¼ŒR.Canetti äº 1996 å¹´æå‡ºçš„ä¸€ç§åŸºäº Hash å‡½æ•°å’Œå¯†é’¥è¿›è¡Œæ¶ˆæ¯è®¤è¯çš„æ–¹æ³•ï¼Œå¹¶äº 1997 å¹´ä½œä¸º RFC2104 å…¬å¸ƒï¼Œåœ¨ IPSec å’Œå…¶ä»–ç½‘ç»œåè®®ï¼Œå¦‚ SSL ä¸­å¾—ä»¥å¹¿æ³›åº”ç”¨ï¼Œç°åœ¨å·²ç»æˆä¸ºäº‹å®ä¸Šçš„ Internet å®‰å…¨æ ‡å‡†ï¼Œå¯ä»¥ä¸ä»»ä½•è¿­ä»£æ•£åˆ—å‡½æ•°æ†ç»‘ä½¿ç”¨ã€‚

HMAC å…¸å‹åº”ç”¨åœ¨ Challenge/Response èº«ä»½è®¤è¯ä¸­ï¼Œè®¤è¯æµç¨‹å¦‚ä¸‹ï¼š

- å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªéªŒè¯è¯·æ±‚ã€‚
- æœåŠ¡å™¨æ¥åˆ°æ­¤è¯·æ±‚åç»™å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ª challenge éšæœºæ•°ã€‚
- å®¢æˆ·ç«¯å°†æ”¶åˆ°çš„éšæœºæ•°äº¤ç”± ePass ä¸å­˜å‚¨çš„å¯†é’¥è¿›è¡Œ HMAC-MD5 è¿ç®—ï¼Œå¹¶å°†ç»“æœä½œä¸ºè®¤è¯è¯æ® Response ä¼ ç»™æœåŠ¡å™¨ã€‚
- æœåŠ¡å™¨ä¹Ÿå°† challenge éšæœºæ•°ä¸æ•°æ®åº“ä¸­çš„å®¢æˆ·å¯†é’¥è¿›è¡Œ HMAC-MD5 è¿ç®—ï¼Œå†ä¸å®¢æˆ·ç«¯ä¼ å›çš„å“åº”æ¯”è¾ƒï¼Œç»“æœç›¸åŒåˆ™è®¤ä¸ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªåˆæ³•ç”¨æˆ·ã€‚

USB Key æˆ– USB Token ä¸»è¦æ˜¯ç”¨ä½œåŸºäºå…¬é’¥ä½“ç³»ï¼ˆPKIï¼‰çš„æ•°å­—è¯ä¹¦å’Œç§é’¥çš„å®‰å…¨è½½ä½“ï¼Œå½¢çŠ¶ç±»ä¼¼ U ç›˜ã€‚

RSA å¯†é’¥å¯¹æ˜¯åœ¨ USB Key å†…ç”Ÿæˆçš„ï¼Œç§é’¥æ°¸è¿œä¸èƒ½å¯¼å‡ºï¼Œç¡®ä¿è¯ä¹¦æŒæœ‰äººçš„ä¿¡æ¯å®‰å…¨ã€‚åŒæ—¶é‡‡ç”¨ Key+PIN çš„åŒå› å­è®¤è¯ï¼Œä¿è¯æ•°å­—è¯ä¹¦å’Œç§é’¥çš„åˆæ³•ä½¿ç”¨ã€‚æ‰€è°“ Key+PIN åŒå› å­è®¤è¯æ˜¯æŒ‡ï¼šå¿…é¡»æœ‰ USB Key æ’å…¥è®¡ç®—æœºï¼Œå¹¶ä¸”åŒæ—¶éªŒè¯ PIN ç åæ‰èƒ½ä½¿ç”¨ Key é‡Œçš„ç§é’¥è¿›è¡Œç­¾åã€‚

OTP Token åŠ¨æ€ä»¤ç‰Œæ˜¯ä¸€ç§ä¾¿æºçš„æ‰‹æŒå¼åŠ¨æ€å¯†ç è®¡ç®—å’Œäº§ç”Ÿçš„ç”µå­äº§å“ã€‚è„±æœºä½¿ç”¨ï¼Œæˆ–ä¸è®¡ç®—æœºç›¸è¿ã€‚å…é™¤é™æ€å¯†ç è¢«æˆªå–ã€çŒœæµ‹ã€æ”»å‡»å’Œç ´è§£çš„éšæ‚£ã€‚å¯æ ¹æ®æ—¶é—´ï¼ˆTimeï¼‰ï¼Œäº‹ä»¶ï¼ˆEventï¼‰ï¼ŒæŒ‘æˆ˜/åº”ç­”ï¼ˆChallenge/Responseï¼‰ç­‰å› ç´ äº§ç”ŸåŠ¨æ€å¯†ç ã€‚

PIN - Personal Identification Number ä¸ªäººè¯†åˆ«å¯†ç ã€‚

ç¤ºèŒƒä½¿ç”¨ HMAC + SHA-256 è¿›è¡Œå“ˆå¸Œæ‘˜è¦ï¼š

```
const crypto = require('crypto');

const secret = 'abcdefg';
const hash = crypto.createHmac('sha256', secret)
               .update('I love cupcakes')
               .digest('hex');
console.log(hash);
```


## PKI å…¬é’¥ä½“ç³»

åœ¨ PKI - Public Key Infrastructure å¯†ç å­¦åº”ç”¨ä¸­ï¼ŒåŸºäº RSA åŠ å¯†ç®—æ³•æ˜¯æœ€æµè¡Œçš„ï¼ŒåŸç†ä¸Š RSA éœ€è¦ç”¨åˆ°ç´ æ•°ã€äº’è´¨æ•°ã€æ¨¡è¿ç®—ã€æŒ‡æ•°è¿ç®—ç­‰æ•°å­¦çŸ¥è¯†ã€‚

ç´ æ•°ä¹Ÿå°±æ˜¯è´¨æ•°ï¼Œä»»æ„ä¸€ä¸ªæ­£æ•´æ•°éƒ½å¯ä»¥å†™æˆä¸€ç³»åˆ—è´¨æ•°çš„ç§¯ï¼Œæ‰€ä»¥ï¼Œé€‰å–ä»»æ„ä¸¤ä¸ªå¤§çš„ç´ æ•°è®¡æ±‚ç§¯å¾ˆå®¹æ˜“ï¼Œä½†è¦åˆ†è§£è¿™ä¸ªç§¯æå…¶å›°éš¾ï¼Œè¿™æ˜¯ RSA ç®—æ³•çš„åŸºæœ¬æ•°å­¦åŸç†ã€‚

ä»¥ä¸‹ç¤ºèŒƒ RSA ç®—æ³•çš„éå¯¹ç§°åŠ å¯†ã€è§£å¯†ï¼Œç­¾åä¸éªŒè¯ç¤ºèŒƒï¼š 

```
const crypto = require('crypto');
const { generateKeyPairSync, publicEncrypt, privateDecrypt, createSign, createVerify } = crypto;

const options = {
  modulusLength: 4096,
  publicKeyEncoding: {
    type: 'spki', // pkcs1 spki
    format: 'pem'
  },
  privateKeyEncoding: {
    type: 'pkcs8', // pkcs1 pkcs8 sec1
    format: 'pem',
    cipher: 'aes-256-cbc',
    passphrase: 'top secret'
  }
};

// generateKeyPair('rsa', options, (err, publicKey, privateKey) => {
//   // Handle errors and use the generated key pair.
// });

let {privateKey, publicKey} = generateKeyPairSync('rsa', options);
let msg = "Hello RSA";
let keyset = {key: privateKey, passphrase: 'top secret'};
let pubset = {key: publicKey, passphrase: 'top secret'};
console.log({privateKey, publicKey})

const encryptData = publicEncrypt(pubset, Buffer.from(msg)).toString('base64');
console.log('publicEncrypt', {msg, encryptData});

const decryptData = privateDecrypt(keyset, Buffer.from(encryptData, 'base64'));
console.log('privateDecrypt', {msg, decryptData.toString()});

const signer = createSign('RSA-SHA256');
signer.update(msg);
signer.end();
const signature = signer.sign(keyset);

const verifier = createVerify('RSA-SHA256');
verifier.update(msg);
verifier.end();
const result = verifier.verify(publicKey, signature)

console.log({verify: result, signature: signature.toString("hex")});
```

ä»¥ä¸Šä½¿ç”¨å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ï¼Œè€Œç­¾åå’ŒéªŒè¯å°±æ˜¯ç”¨ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ã€‚

åœ¨åŠ å¯†çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œè‚¯å®šæ˜¯ä¸å¸Œæœ›åˆ«äººçŸ¥é“å¾…åŠ å¯†çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”åªæœ‰ç§é’¥æŒæœ‰è€…æ‰èƒ½è§£å¯†ã€‚åŒç†ï¼Œå¯¹äºç­¾åä¸éªŒè¯ï¼Œé‚£è‚¯å®šæ˜¯ä¸å¸Œæœ›æœ‰äººå†’å……æˆ‘å‘æ¶ˆæ¯ï¼Œåªæœ‰ç§é’¥æŒæœ‰è€…æ‰èƒ½å‘å¸ƒè¿™ä¸ªç­¾åï¼Œç„¶åæ‰€æœ‰äººéƒ½å¯ä»¥ç”¨å…¬é’¥å¯¹ç­¾åè¿›è¡ŒéªŒè¯ã€‚

KPI ä½“ç³»è®¾è®¡ä¸­ï¼Œç§é’¥å’Œå…¬é’¥å¼ºåº¦æ˜¯ä¸åŒçš„ï¼Œç§é’¥å€¼æ›´å¤§ï¼Œå…¬é’¥å€¼æ›´å°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå°†ç§é’¥å…¬å¼€ï¼Œè€Œå…¬é’¥ä¿å¯†ï¼Œå› ä¸ºå…¬é’¥æ›´çŸ­æ‰€ä»¥æ›´å®¹æ˜“è¢«ç ´è§£ã€‚ä»æŠ€æœ¯ä¸Šè®²æ˜¯å¯ä»¥çš„ï¼Œä½†è¿™ä¸æ˜¯å®‰å…¨çš„æ–¹æ¡ˆã€‚


DH - Diffie-Hellman æ˜¯åŸºäº PKI ä½“ç³»çš„å¯†é’¥äº¤æ¢å®‰å…¨åè®®ï¼Œå®ƒå¯ä»¥è®©åŒæ–¹åœ¨ä¸å®‰å…¨çš„ä¿¡é“ä¸Šåˆ›å»ºä¸€ä¸ªå¯†é’¥ã€‚åŒæ–¹äº’ç›¸å‘é€çš„æ•°æ®å°±ç®—è¢«ç¬¬ä¸‰æ–¹çŸ¥æ™“ï¼Œä¹Ÿæ— æ³•çŸ¥é“åŠ å¯†ä¿¡æ¯çš„å¯†é’¥ã€‚

å¯†é’¥äº¤æ¢æµç¨‹ï¼š

1. Alice ä¸ Bob åå®šä½¿ç”¨ p=23 ä»¥åŠ g=5ï¼Œå®é™…åº”ç”¨ä¸­ p æ˜¯ä¸€ä¸ªå¤§è´¨æ•°ã€‚
2. Alice é€‰æ‹©ä¸€ä¸ªç§˜å¯†æ•´æ•° a=6, è®¡ç®— A = g^a mod p = 5^6 mod 23 = 8 å¹¶å‘é€ç»™ Bobã€‚  
3. Bob ä¹Ÿé€‰æ‹©ä¸€ä¸ªç§˜å¯†æ•´æ•° b=15, è®¡ç®— B = g^b mod p = 5^15 mod 23 = 19 å¹¶å‘é€ç»™ Alice ã€‚  
4. Alice è®¡ç®— s = B^a mod p = 19^6 mod 23 = 2ã€‚
5. Bob è®¡ç®— s = A^b mod p  = 8^15 mod 23 = 2ã€‚

Diffie-Hellman åŸç†è¦ç‚¹ï¼š

- äº¤æ¢è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰å‚ä¸è€…å®šä¹‰ä¸€ä¸ªç»„ï¼Œåœ¨è¿™ä¸ªç»„ä¸­å®šä¹‰ä¸€ä¸ªå¤§è´¨æ•° pï¼Œåº•æ•° gã€‚
- å¯†é’¥äº¤æ¢æ˜¯ä¸€ä¸ªä¸¤éƒ¨åˆ†çš„è¿‡ç¨‹ï¼Œé¦–å…ˆ Alice å’Œ Bob éƒ½éœ€è¦ä¸€ä¸ªç§æœ‰çš„æ•°å­— aï¼Œbã€‚
- å…¶æ¬¡ï¼ŒåŒæ–¹è¦äº’ç›¸ä¼ é€’ä¸€ä¸ªå…¬å¼€çš„ primeï¼Œæ”»å‡»è€…å³ä½¿è¢«ç›‘å¬åˆ°ä¹Ÿæ²¡æœ‰ç”¨ï¼Œå› ä¸ºå¯¹äºå¤§è´¨æ•°ï¼Œåå‘æ±‚è§£åŒæ–¹çš„ç§˜å¯†æ•°å­— a æˆ– b æ˜¯éš¾é¢˜ã€‚

å…¬å…±å¯†é’¥ (g^b)^a=(g^a)^bï¼Œå› ä¸ºç¾¤æ˜¯ä¹˜æ³•äº¤æ¢çš„ï¼Œæ¶‰åŠåˆ°æ•°è®ºåŠä»£æ•°çš„å†…å®¹ã€‚æ­£ç¡®äº¤æ¢çš„å‰ææ˜¯ï¼ŒAlice å¿…é¡»ç¡®ä¿å¯¹æ–¹æ˜¯ Bobï¼Œæ— æ³•æŠµå¾¡ä¸­é—´äººæ”»å‡»ã€‚DH è¿™ç§ç¥å¥‡çš„ç®—æ³•å¯ä»¥è®©ä½ æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨ä¸ä¼ è¾“è¯¥å¯¹ç§°å¯†é’¥çš„æƒ…å†µä¸‹å°±å¯ä»¥é€šè¿‡å¿ƒæœ‰çµçŠ€åœ°æ–¹å¼å„è‡ªè®¡ç®—å‡ºä¸€ä¸ªå¯¹ç§°å¯†é’¥ï¼ŒåŒæ–¹è®¡ç®—ç»“æœä¸€æ ·ï¼Œé¿å…äº†è¯¥å¯†é’¥åœ¨ç½‘ç»œä¸Šæ˜æ–‡ä¼ è¾“ã€‚


```
const crypto = require('crypto');
const assert = require('assert');

// Generate Alice's keys...
const alice = crypto.createDiffieHellman(512);
const aliceKey = alice.generateKeys();
let prime = alice.getPrime(), gen = alice.getGenerator()

// Generate Bob's keys...
const bob = crypto.createDiffieHellman(prime, gen);
const bobKey = bob.generateKeys();

// Exchange and generate the secret...
const aliceSecret = alice.computeSecret(bobKey);
const bobSecret = bob.computeSecret(aliceKey);

assert.strictEqual(aliceSecret.toString('hex'), bobSecret.toString('hex'));
```


æ¤­åœ†æ›²çº¿å¯†ç å­¦ ECC - Elliptic curve cryptography æ˜¯ä¸€ç§å»ºç«‹å…¬å¼€å¯†é’¥åŠ å¯†çš„ç®—æ³•ï¼ŒåŸºäºæ¤­åœ†æ›²çº¿æ•°å­¦ï¼Œä½¿ç”¨æ¯” RSA åŠ å¯†ç®—æ³•æ›´å°çš„å¯†é’¥å°±å¯ä»¥æä¾›ç›¸å½“çš„æˆ–æ›´é«˜ç­‰çº§çš„å®‰å…¨ï¼Œå› æ­¤åŒæ ·å®‰å…¨ç­‰çº§ ECC æ¯” RSA çš„æ€§èƒ½æ›´é«˜ã€‚ç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯å±€å’Œ ANSI X9 è®¾å®šçš„æœ€å°å¯†é’¥é•¿åº¦çš„è¦æ±‚ä¸­ï¼ŒRSAã€DSA 1024bitï¼ŒECC 160bitã€‚

ECC å»ºç«‹åœ¨åŸºäºæ¤­åœ†æ›²çº¿çš„ç¦»æ•£å¯¹æ•°é—®é¢˜ä¸Šçš„å¯†ç ä½“åˆ¶ï¼Œç»™å®šæ¤­åœ†æ›²çº¿ä¸Šçš„ä¸€ä¸ªç‚¹ Pï¼Œä¸€ä¸ªæ•´æ•° kï¼Œæ±‚è§£ Q=kP å¾ˆå®¹æ˜“ï¼›ç»™å®šä¸€ä¸ªç‚¹ Pã€Qï¼ŒçŸ¥é“ Q=kPï¼Œæ±‚æ•´æ•° k æ˜¯ä¸€ä¸ªéš¾é¢˜ã€‚

æ¤­åœ†æ›²çº¿ä¹˜æ³•æ˜¯ä¸€ç§å¯†ç å­¦å®¶ç§°ä¹‹ä¸º`é™·é˜±é—¨`çš„å‡½æ•°ï¼šåœ¨ä¸€ä¸ªæ–¹å‘ï¼ˆä¹˜æ³•ï¼‰å¾ˆå®¹æ˜“è®¡ç®—ï¼Œè€Œåœ¨ç›¸åçš„æ–¹å‘ï¼ˆé™¤æ³•ï¼‰æ˜¯ä¸å¯èƒ½è®¡ç®—å‡ºæ¥çš„ã€‚ç§é’¥çš„æ‰€æœ‰è€…å¯ä»¥å®¹æ˜“åœ°åˆ›å»ºå…¬é’¥ï¼Œç„¶åä¸ä¸–ç•Œå…±äº«ï¼Œä½†æ²¡æœ‰äººå¯ä»¥ä»å…¬é’¥åå‘è®¡ç®—å‡ºç§é’¥ã€‚ è¿™ä¸ªæ•°å­¦æŠ€å·§æˆä¸ºè¯æ˜æ¯”ç‰¹å¸èµ„é‡‘æ‰€æœ‰æƒä¸å¯ä¼ªé€ å’Œå®‰å…¨çš„æ•°å­—ç­¾åçš„åŸºç¡€ã€‚

å…¶ä¸­ ECC åº”ç”¨äºæ•°å­—ç­¾åï¼Œå³`æ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³•` ECDSA - Elliptic Curve Digital Signature Algorithm æ˜¯ä¸€ç§æ— æ³•ä¼ªé€ çš„æ•°å­—ç­¾åç®—æ³•ã€‚æ•°å­—ç­¾åæ˜¯ä¸€ç§æ•°å­¦æ–¹æ¡ˆ mathematical schemeï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼šç¬¬ä¸€éƒ¨åˆ†æ˜¯ä½¿ç”¨ç§é’¥ï¼ˆç­¾åå¯†é’¥ï¼‰ä»æ¶ˆæ¯ï¼ˆäº¤æ˜“ï¼‰åˆ›å»ºç­¾åï¼›ç¬¬äºŒéƒ¨åˆ†æ˜¯å…è®¸ä»»ä½•äººä¾æ®ç»™å®šçš„æ¶ˆæ¯å’Œå…¬é’¥éªŒè¯ç­¾åã€‚

ç›®å‰ OpenSSL å®ç°çš„ ECC ç®—æ³•çš„å¥—ä»¶æ”¯æŒ ECDSA/ECDHï¼Œç›®å‰çœ‹èµ·æ¥ ECC æ˜¯ä¸€ä¸ªè¶‹åŠ¿ï¼Œä½†è¿˜æ²¡æœ‰å½¢æˆä¸€ä¸ªç»Ÿä¸€çš„å…¨çƒæ ‡å‡†ï¼Œå› å…¶è®¾è®¡å›°éš¾ï¼Œå®ç°å¤æ‚ã€‚

é€šè¿‡ crypto.getCurves() è·å–å®Œæ•´çš„æ¤­åœ†æ›²çº¿ç®—æ³•åˆ—è¡¨ï¼š

    | Oakley-EC2N-3   | c2pnb163v1 | secp112r1 | wap-wsg-idm-ecid-wtls1  |
    | Oakley-EC2N-4   | c2pnb163v2 | secp112r2 | wap-wsg-idm-ecid-wtls10 |
    | SM2             | c2pnb163v3 | secp128r1 | wap-wsg-idm-ecid-wtls11 |
    | brainpoolP160r1 | c2pnb176v1 | secp128r2 | wap-wsg-idm-ecid-wtls12 |
    | brainpoolP160t1 | c2pnb208w1 | secp160k1 | wap-wsg-idm-ecid-wtls3  |
    | brainpoolP192r1 | c2pnb272w1 | secp160r1 | wap-wsg-idm-ecid-wtls4  |
    | brainpoolP192t1 | c2pnb304w1 | secp160r2 | wap-wsg-idm-ecid-wtls5  |
    | brainpoolP224r1 | c2pnb368w1 | secp192k1 | wap-wsg-idm-ecid-wtls6  |
    | brainpoolP224t1 | c2tnb191v1 | secp224k1 | wap-wsg-idm-ecid-wtls7  |
    | brainpoolP256r1 | c2tnb191v2 | secp224r1 | wap-wsg-idm-ecid-wtls8  |
    | brainpoolP256t1 | c2tnb191v3 | secp256k1 | wap-wsg-idm-ecid-wtls9  |
    | brainpoolP320r1 | c2tnb239v1 | secp384r1 |                         |
    | brainpoolP320t1 | c2tnb239v2 | secp521r1 |                         |
    | brainpoolP384r1 | c2tnb239v3 | sect113r1 |                         |
    | brainpoolP384t1 | c2tnb359v1 | sect113r2 |                         |
    | brainpoolP512r1 | c2tnb431r1 | sect131r1 |                         |
    | brainpoolP512t1 | prime192v1 | sect131r2 |                         |
    |                 | prime192v2 | sect163k1 |                         |
    |                 | prime192v3 | sect163r1 |                         |
    |                 | prime239v1 | sect163r2 |                         |
    |                 | prime239v2 | sect193r1 |                         |
    |                 | prime239v3 | sect193r2 |                         |
    |                 | prime256v1 | sect233k1 |                         |
    |                 |            | sect233r1 |                         |
    |                 |            | sect239k1 |                         |
    |                 |            | sect283k1 |                         |
    |                 |            | sect283r1 |                         |
    |                 |            | sect409k1 |                         |
    |                 |            | sect409r1 |                         |
    |                 |            | sect571k1 |                         |
    |                 |            | sect571r1 |                         |


ECDH - Elliptic Curve Diffie-Hellman åˆ™æ˜¯ç»“åˆäº† ECC çš„å¯†é’¥äº¤æ¢åè®®ï¼Œäº¤æ¢åŒæ–¹å¯ä»¥åœ¨ä¸å…±äº«ä»»ä½•ç§˜å¯†çš„æƒ…å†µä¸‹åå•†å‡ºä¸€ä¸ªå¯†é’¥ã€‚

å¯†é’¥ç£‹å•†è¿‡ç¨‹å¦‚ä¸‹ï¼Œå‡è®¾å¯†é’¥äº¤æ¢åŒæ–¹ä¸º Aliceã€Bobï¼Œå…±äº«ä¸‰ä¸ªæ›²çº¿å‚æ•°ï¼Œæ¤­åœ†æ›²çº¿ Eã€é˜¶ Nã€åŸºç‚¹ Gï¼š

- Alice ç”Ÿæˆéšæœºæ•´æ•° aï¼Œè®¡ç®— `A=(a*G)`ï¼Œç”Ÿæˆ Alice å…¬é’¥ï¼›
- Bob ç”Ÿæˆéšæœºæ•´æ•° bï¼Œè®¡ç®— `B=(b*G)`ï¼Œç”Ÿæˆ Bob å…¬é’¥ï¼›
- Alice å’Œ Bob äº’æ¢ A å’Œ Bï¼Œä¼ é€’å¯ä»¥å…¬å¼€ï¼Œç”±äºæ¤­åœ†æ›²çº¿çš„ç¦»æ•£å¯¹æ•°é—®é¢˜éš¾é¢˜ï¼Œæ‰€ä»¥æ”»å‡»è€…ä¸èƒ½é€šè¿‡ G è®¡ç®—å‡ºå„è‡ªçš„éšæœºæ•°ã€‚
- Bob æ”¶åˆ° Alice ä¼ é€’çš„ Aï¼Œè®¡ç®— `Q=(b*A)`ï¼ŒBob é€šè¿‡è‡ªå·±çš„ç§é’¥å’Œ Alice çš„å…¬é’¥å¾—åˆ°å¯¹ç§°å¯†é’¥ Qã€‚
- Alice æ”¶åˆ° Bob ä¼ é€’çš„ Bï¼Œè®¡ç®— `Q=(a*B)`ï¼ŒAlice é€šè¿‡è‡ªå·±çš„ç§é’¥å’Œ Bob çš„å…¬é’¥å¾—åˆ°å¯¹ç§°å¯†é’¥ Qã€‚

Aliceã€Bob åŒæ–¹å³å¾— Q = bÃ—A = bÃ—(aÃ—G) = (bÃ—a)Ã—G = (aÃ—b)Ã—G = aÃ—(bÃ—G) = aÃ—B = Q' (äº¤æ¢å¾‹å’Œç»“åˆå¾‹)ï¼Œå³åŒæ–¹å¾—åˆ°ä¸€è‡´çš„å¯†é’¥Qã€‚

```
const crypto = require('crypto');
const assert = require('assert');

// Generate Alice's keys...
const alice = crypto.createECDH('secp521r1');
const aliceKey = alice.generateKeys();

// Generate Bob's keys...
const bob = crypto.createECDH('secp521r1');
const bobKey = bob.generateKeys();

// Exchange and generate the secret...
const aliceSecret = alice.computeSecret(bobKey);
const bobSecret = bob.computeSecret(aliceKey);

assert.strictEqual(aliceSecret.toString('hex'), bobSecret.toString('hex'));
```

å›½å¯†ç®—æ³•æ˜¯å›½å®¶å¯†ç ç®¡ç†å±€åˆ¶å®šçš„è‡ªä¸»å¯æ§çš„å›½äº§ç®—æ³•ï¼ŒåŒ…æ‹¬ SM1ã€SM2ã€SM3 ã€SM4ã€SM7ã€SM9ã€ç¥–å†²ä¹‹å¯†ç ç®—æ³•ï¼ˆZUC)ç­‰ã€‚åœ¨é‡‘èé¢†åŸŸç›®å‰ä¸»è¦ä½¿ç”¨å…¬å¼€çš„ SM2ã€SM3ã€SM4 ä¸‰ç§å•†ç”¨å¯†ç ç®—æ³•ï¼Œåˆ†åˆ«ä¸ºéå¯¹ç§°åŠ å¯†ç®—æ³•ã€å“ˆå¸Œç®—æ³•å’Œå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚

SM2 ç®—æ³•å’Œ RSA ç®—æ³•éƒ½æ˜¯å…¬é’¥å¯†ç ç®—æ³•ï¼Œä½†æ˜¯ï¼ŒåŸºäºæ¤­åœ†æ›²çº¿ç¦»æ•£å¯¹æ•°é—®é¢˜ç†è®ºçš„ SM2 ç®—æ³•æ›´å…ˆè¿›å®‰å…¨ï¼Œå¯†ç å¤æ‚åº¦é«˜ã€å¤„ç†é€Ÿåº¦å¿«ã€æœºå™¨æ€§èƒ½æ¶ˆè€—æ›´å°ï¼Œåœ¨æˆ‘ä»¬å›½å®¶å•†ç”¨å¯†ç ä½“ç³»ä¸­è¢«ç”¨æ¥æ›¿æ¢ RSA ç®—æ³•ã€‚å› ä¸ºï¼Œéšç€å¯†ç æŠ€æœ¯å’Œè®¡ç®—æœºæŠ€æœ¯çš„å‘å±•ï¼Œç›®å‰å¸¸ç”¨çš„ 1024bit RSA ç®—æ³•é¢ä¸´ä¸¥é‡çš„å®‰å…¨å¨èƒã€‚ä»ç®—æ³•ä¸Šè¯´ï¼ŒSM2 å°±æ˜¯è®¾è®¡äº†ä¸€æ ¹æ–°çš„æ¤­åœ†æ›²çº¿ã€‚

å›½å¯†ä¸­å€¼å¾—æˆ‘ä»¬å…³æ³¨çš„ä¸»è¦é™¤äº† SM1 ä»¥å¤–çš„å…¬å¼€ç®—æ³•ï¼š

- SM1 ä¸ºå¯¹ç§°åŠ å¯†ï¼Œåˆ†ç»„å¯†ç ç®—æ³•ï¼Œåˆ†ç»„é•¿åº¦ã€å¯†é’¥é•¿åº¦éƒ½ä¸º 128 æ¯”ç‰¹ã€‚åŠ å¯†å¼ºåº¦ä¸ AES ç›¸å½“ï¼Œè¯¥ç®—æ³•ä¸å…¬å¼€ï¼Œä»…ä»¥ IP æ ¸çš„å½¢å¼å­˜åœ¨äºèŠ¯ç‰‡ä¸­ã€‚
- SM2 åŸºäºæ¤­åœ†æ›²çº¿å¯†ç ï¼ˆECCï¼‰çš„å…¬é’¥å¯†ç ç®—æ³•æ ‡å‡†ï¼Œæä¾›æ•°å­—ç­¾åï¼Œå¯†é’¥äº¤æ¢ï¼Œå…¬é’¥åŠ å¯†ï¼Œç”¨äºæ›¿æ¢ RSA/ECDSA/ECDH ç­‰å›½é™…ç®—æ³•ã€‚
- SM3 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼Œå“ˆå¸Œç»“æœä¸º256 bitsï¼Œç”¨äºæ›¿æ¢MD5/SHA1/SHA256ç­‰å›½é™…ç®—æ³•ã€‚
- SM4 å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦å’Œåˆ†ç»„é•¿åº¦å‡ä¸º128 bitsï¼Œä¸»è¦ç”¨äºæ— çº¿å±€åŸŸç½‘æ ‡å‡†ï¼Œç”¨äºæ›¿æ¢ DES/AES ç­‰ç®—æ³•ã€‚
- å›½å¯†è¯ä¹¦ï¼šè¿™é‡Œçš„å›½å¯†è¯ä¹¦æŒ‡çš„æ˜¯ä½¿ç”¨å›½å¯†ç®—æ³•ï¼ˆSM2-with-SM3ï¼‰çš„æ ‡å‡†X509æ ¼å¼è¯ä¹¦ï¼Œè¯ä¹¦ä½¿ç”¨SM3ä½œä¸ºå“ˆå¸Œç®—æ³•ï¼Œä½¿ç”¨SM2ä½œä¸ºæ•°å­—ç­¾åç®—æ³•ã€‚
- å›½å¯† SSLï¼šé‡‡ç”¨å›½å¯†ç®—æ³•ï¼Œç¬¦åˆå›½å¯†æ ‡å‡†çš„å®‰å…¨ä¼ è¾“åè®®ï¼Œä¹Ÿå°±æ˜¯ SSL/TLS åè®®çš„å›½å¯†ç‰ˆæœ¬ã€‚

ä»¥ä¸‹ç¤ºèŒƒ Node ç¯å¢ƒä¸‹é€šè¿‡ ECDH å¯†é’¥äº¤æ¢åè®®æ¥ä½¿ç”¨ SM2 ç®—æ³•ï¼š

```
const crypto = require('crypto');

const alice = crypto.createECDH('SM2');
const bob = crypto.createECDH('SM2');

// This is a shortcut way of specifying one of Alice's previous private
// keys. It would be unwise to use such a predictable private key in a real
// application.
alice.setPrivateKey(
  crypto.createHash('sha256').update('secret', 'utf8').digest()
);
// bob.setPrivateKey(
//   crypto.createHash('sha256').update('secret2', 'utf8').digest()
// );

// Bob uses a newly generated cryptographically strong pseudorandom key pair
bob.generateKeys();
// alice.generateKeys();

const aliceSecret = alice.computeSecret(bob.getPublicKey(), null, 'base64');
const bobSecret = bob.computeSecret(alice.getPublicKey(), null, 'base64');

// aliceSecret and bobSecret should be the same shared secret value
console.log({
  alice_secret: aliceSecret, 
  bob_secret: bobSecret, 
  bob_pub: bob.getPublicKey("base64", "compressed"), 
  bob_key: bob.getPrivateKey("base64"),
  alice_pub: alice.getPublicKey("base64", "compressed"), 
  alice_key: alice.getPrivateKey("base64"),
});
```

## MITM ä¸­é—´äººæ”»å‡»
- HTTP Strict Transport Security (HSTS) https://tools.ietf.org/html/rfc6797

MITM - Man-in-the-middle-attacks ä¸­é—´äººæ”»å‡», æ˜¯ä¸€ç§ç”µè„‘é»‘å®¢çš„æ”»å‡»æ¨¡å¼ã€‚

ä¾‹å¦‚åœ¨ client å‘å‡ºçš„è¯·æ±‚ã€Web server è¿”å›æ•°æ®ä¹‹é—´ï¼Œå¸ƒç½®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ proxy server è¿›è¡Œè½¬å‘, è¿™ä¸ª proxy server å°±èµ·åˆ°äº†ä¸€ä¸ª middle man çš„ä½œç”¨ã€‚å¦‚ Fiddler æˆ– Charles è¿™ç±»è½¯ä»¶å°±å¯ä»¥å……å½“è¿™ä¸ªä¸­é—´äººï¼Œé€šè¿‡ä»£ç†è®¾ç½®ï¼Œåœ¨èœå• Tools --> Fiddler Options --> Connections å°±å¯ä»¥æ‰“å¼€ Fiddler çš„æŠ“åŒ…åŠŸèƒ½ã€‚Fiddler ä¼šè‡ªåŠ¨è®¾ç½® WinINETï¼Œå°†ç½‘ç»œè¯·æ±‚æµé‡è·¯ç”±åˆ° Fiddler çš„ä»£ç†æœåŠ¡å™¨ä¸Šæ¥ã€‚

é€šè¿‡ä¸­é—´äººä»£ç†ï¼Œå¯ä»¥æ•è· HTTPS è¿™æ ·çš„åŸºäº PKI ä½“ç³»çš„åŠ å¯†ç³»ç»Ÿçš„æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å…ˆç»è¿‡ä¸­é—´äººï¼Œå†ç”±ä¸­é—´äººå’ŒæœåŠ¡å™¨å¯¹æ¥ï¼Œè¿™ç§æ¨¡å¼ç§°ä¸º`åœ¨çº¿ä¸­é—´äººæ”»å‡»`ã€‚

`ç¦»çº¿ä¸­é—´äººæ”»å‡»`æ¨¡å¼ï¼Œä¾‹å¦‚ï¼šæŸä¸­é—´äººæˆåŠŸæˆªè·äº†æ¶ˆæ¯ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå°†æ–°çš„å†…å®¹å‘å›ç»™å‘ä»¶äººæˆ–æ”¶ä»¶äººï¼Œè€Œå½“æ­¤äººåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å›å¤æ—¶ï¼Œè¯¥ä¸­é—´äººä¾¿å¯ç»§ç»­æˆªè·å¹¶é˜…è¯»åŸæœ¬é€šä¿¡åŒæ–¹äº’å‘çš„ä¿¡æ¯ã€‚ç”±äºåŒæ–¹å¹¶éé¢å¯¹é¢é€šä¿¡ï¼Œå› æ­¤ä¿¡æ¯å³ä½¿è¢«æˆªè·å’Œçªƒå–ï¼Œä»–ä»¬éƒ½ä¸å¾—è€ŒçŸ¥ã€‚

æ€»çš„è¯´æ¥ï¼Œä¸­é—´äººæ”»å‡»æ‰‹æ®µå¯ä»¥æœ‰ä½†ä¸ä»…é™ä»¥ä¸‹è¿™äº›ï¼š

- Wi-Fi æ¬ºéª—ï¼šæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸æœ¬åœ°å…è´¹ Wi-Fi åŒåçš„è™šå‡ Wi-Fi æ¥å…¥ç‚¹(AP)ã€‚
- HTTPS æ¬ºéª—ï¼šæ”»å‡»è€…é€šè¿‡æ¬ºéª—æ‚¨çš„æµè§ˆå™¨ï¼Œä½¿æ‚¨è®¤ä¸ºè‡ªå·±è®¿é—®çš„æ˜¯å¯ä¿¡ä»»ç«™ç‚¹ã€‚
- SSL åŠ«æŒï¼šæµè§ˆå™¨è®¿é—®ç«™ç‚¹ï¼Œå¯èƒ½ä¼šä» HTTP é‡å®šå‘åˆ° HTTPSï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥è¢«æ”»å‡»è€…åŠ«æŒï¼Œå¹¶ä¸”è·³è½¬åˆ°é’“é±¼ç«™ç‚¹ï¼Œè¿›è€Œçªƒå–æ‚¨çš„æ•æ„Ÿæ•°æ®ã€ä»¥åŠè¾“å…¥çš„æ‰€æœ‰ä¿¡ä»»å‡­æ®ã€‚
- DNS æ¬ºéª—ï¼šé€šå¸¸è®¿é—®æœåŠ¡å™¨é€šè¿‡åŸŸåç³»ç»Ÿè€Œä¸æ˜¯ IP åœ°å€ï¼Œç„¶è€Œï¼Œæä¾›åŸŸåè½¬ IP æœåŠ¡çš„ DNS å¯èƒ½è¢«æ”»å‡»ï¼Œä»è€Œå¯¼è‡´å®¢æˆ·ç«¯è®¿é—®çš„æ˜¯ä¼ªé€ çš„åœ°å€ã€‚
- ç”µå­é‚®ä»¶åŠ«æŒï¼šå¦‚æœæ”»å‡»è€…è·å¾—äº†å—ä¿¡ä»»æœºæ„(ä¾‹å¦‚é“¶è¡Œ)çš„é‚®ç®±ã€ç”šè‡³æ˜¯é‚®ä»¶æœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œé‚£ä¹ˆä»–ä»¬å°±èƒ½å¤Ÿæ‹¦æˆªåŒ…å«æ•æ„Ÿä¿¡æ¯çš„å®¢æˆ·ç”µå­é‚®ä»¶ï¼Œç”šè‡³ä»¥è¯¥æœºæ„çš„èº«ä»½å‘é€å„ç§ç”µå­é‚®ä»¶ã€‚


ç®€å•æ¥è®²å°±æ˜¯ï¼Œæµè§ˆå™¨å‘ç½‘ç«™å‘èµ·ä¸€æ¬¡HTTPè¯·æ±‚ï¼Œåœ¨å¾—åˆ°ä¸€ä¸ªé‡å®šå‘å“åº”åï¼Œå‘èµ·ä¸€æ¬¡HTTPSè¯·æ±‚å¹¶å¾—åˆ°æœ€ç»ˆçš„å“åº”å†…å®¹ã€‚æ‰€æœ‰çš„è¿™ä¸€åˆ‡å¯¹ç”¨æˆ·è€Œè¨€æ˜¯å®Œå…¨é€æ˜çš„ï¼Œæ‰€ä»¥åœ¨ç”¨æˆ·çœ¼é‡Œçœ‹æ¥ï¼Œåœ¨æµè§ˆå™¨é‡Œç›´æ¥è¾“å…¥åŸŸåå´ä¾ç„¶å¯ä»¥ç”¨HTTPSåè®®å’Œç½‘ç«™è¿›è¡Œå®‰å…¨çš„é€šä¿¡ï¼Œæ˜¯ä¸ªä¸é”™çš„ç”¨æˆ·ä½“éªŒã€‚

HTTPS èƒ½å¤Ÿé˜²æ­¢åŸºæœ¬çš„ä¸­é—´äººæ”»å‡»ï¼Œä½†æ˜¯é¢å¯¹ SSLStrip ç±»å‹çš„ä¸­é—´äººæ”»å‡»ï¼Œæµè§ˆå™¨ä¼šè¢«é™çº§åœ¨ HTTP æ¨¡å¼ã€‚

ä¸ºäº†åº”å¯¹ SSLStrip åè®®é™çº§æ”»å‡»ï¼Œå¯ä»¥é‡‡ç”¨ HSTS - HTTP Strict Transport Securityï¼Œå®ƒèƒ½å¤Ÿå¼ºåˆ¶è¦æ±‚ Web æœåŠ¡å™¨ä¸æ‰€æœ‰ç”¨æˆ·ä»…ä»…ä½¿ç”¨ HTTPS è¿›è¡Œäº¤äº’ã€‚

å½“ç„¶ï¼ŒHSTS å¹¶éèƒ½å¤Ÿä¸€ç›´å¥æ•ˆï¼Œç”¨æˆ·é¦–æ¬¡è®¿é—®æ—¶è¿˜å¤„äº HTTP æ¨¡å¼ï¼Œç„¶åæ‰å¯ä»¥è¿›è¡Œ HSTS é…ç½®ã€‚å› æ­¤ï¼Œè¿™ç§çŸ­æš‚çš„è¿‡ç¨‹ä»ç„¶ä¼šç»™ SSLStrip æ”»å‡»ç•™ä¸‹è¾ƒçŸ­çš„æ—¶é—´çª—å£ï¼š

- ç¬¬1æ­¥ï¼šæµè§ˆå™¨å‘èµ·ä¸€æ¬¡ HTTP æ˜æ–‡è¯·æ±‚ï¼Œä½†å®é™…ä¸Šä¼šè¢«æ”»å‡»è€…æ‹¦æˆªä¸‹æ¥ï¼›
- ç¬¬2æ­¥ï¼šæ”»å‡»è€…ä½œä¸ºä»£ç†ï¼ŒæŠŠå½“å‰è¯·æ±‚è½¬å‘ç»™é’“é±¼ç½‘ç«™ï¼›
- ç¬¬3æ­¥ï¼šé’“é±¼ç½‘ç«™è¿”å›å‡å†’çš„ç½‘é¡µå†…å®¹ï¼›
- ç¬¬4æ­¥ï¼šæ”»å‡»è€…æŠŠå‡å†’çš„ç½‘é¡µå†…å®¹è¿”å›ç»™æµè§ˆå™¨ï¼›

HSTS æœ€ä¸ºæ ¸å¿ƒçš„æ˜¯ä¸€ä¸ª HTTP Response Headerï¼š

    Strict-Transport-Security: <max-age=>[; includeSubDomains][; preload]

- `max-age` æ˜¯å¿…é€‰å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªä»¥ç§’ä¸ºå•ä½çš„æ•°å€¼ï¼Œå®ƒä»£è¡¨ç€ HSTS Header çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚è®¾ç½®ä¸º 1 å¹´å³ 31536000 ç§’ã€‚
- `includeSubDomains` å¦‚æœåŒ…å«å®ƒï¼Œåˆ™æ„å‘³ç€å½“å‰åŸŸååŠå…¶å­åŸŸåå‡å¼€å¯ HSTS ä¿æŠ¤ã€‚
- `preload` ä½¿ç”¨æµè§ˆå™¨å†…ç½®çš„åŸŸååˆ—è¡¨ã€‚

æ­£æ˜¯å®ƒå¯ä»¥è®©æµè§ˆå™¨å¾—çŸ¥ï¼Œåœ¨æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´å†…ï¼Œå½“å‰åŸŸååªèƒ½é€šè¿‡ HTTPS è¿›è¡Œè®¿é—®ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨å‘ç°å½“å‰è¿æ¥ä¸å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œå¼ºåˆ¶æ‹’ç»ç”¨æˆ·çš„åç»­è®¿é—®è¦æ±‚ã€‚

è™½ç„¶ HSTS å¯ä»¥å¾ˆå¥½çš„è§£å†³ HTTPS é™çº§æ”»å‡»ï¼Œä½†æ˜¯å¯¹äº HSTS ç”Ÿæ•ˆå‰çš„é¦–æ¬¡ HTTP è¯·æ±‚ï¼Œä¾ç„¶æ— æ³•é¿å…è¢«åŠ«æŒã€‚

æµè§ˆå™¨å‚å•†ä»¬ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæå‡ºäº† HSTS Preload List æ–¹æ¡ˆï¼šå†…ç½®ä¸€ä»½å¯ä»¥å®šæœŸæ›´æ–°çš„åˆ—è¡¨ï¼Œå¯¹äºåˆ—è¡¨ä¸­çš„åŸŸåï¼Œå³ä½¿ç”¨æˆ·ä¹‹å‰æ²¡æœ‰è®¿é—®è¿‡ï¼Œä¹Ÿä¼šä½¿ç”¨ HTTPS åè®®ã€‚

ç›®å‰è¿™ä¸ª Preload List ç”± Google Chrome ç»´æŠ¤ï¼ŒChromeã€Firefoxã€Safariã€IE 11 å’Œ Microsoft Edge éƒ½åœ¨ä½¿ç”¨ã€‚

å¦‚æœè¦æƒ³æŠŠè‡ªå·±çš„åŸŸååŠ è¿›è¿™ä¸ªåˆ—è¡¨ï¼Œé¦–å…ˆéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

- æ‹¥æœ‰åˆæ³•çš„è¯ä¹¦ï¼Œå¦‚æœä½¿ç”¨ SHA-1 è¯ä¹¦ï¼Œè¿‡æœŸæ—¶é—´å¿…é¡»æ—©äº 2016 å¹´ï¼›
- å°†æ‰€æœ‰ HTTP æµé‡é‡å®šå‘åˆ° HTTPSï¼›
- ç¡®ä¿æ‰€æœ‰å­åŸŸåéƒ½å¯ç”¨äº† HTTPSï¼›
- è¾“å‡º HSTS å“åº”å¤´ï¼š
- max-age ä¸èƒ½ä½äº 18 å‘¨(10886400ç§’)ï¼›
- å¿…é¡»æŒ‡å®š includeSubdomains å‚æ•°ï¼›
- å¿…é¡»æŒ‡å®š preload å‚æ•°ï¼›

å³ä¾¿æ»¡è¶³äº†ä¸Šè¿°æ‰€æœ‰æ¡ä»¶ï¼Œä¹Ÿä¸ä¸€å®šèƒ½è¿›å…¥ HSTS Preload Listï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ï¼šhttps://hstspreload.org/ã€‚

é€šè¿‡ chrome://net-internals/#hsts å¯ä»¥æŸ¥è¯¢æŸä¸ªç½‘ç«™æ˜¯å¦åœ¨åˆ—è¡¨ä¹‹ä¸­ï¼Œè¿˜å¯ä»¥æ‰‹åŠ¨æŠŠæŸä¸ªåŸŸååŠ åˆ°æœ¬æœº Preload Listã€‚

è™½ç„¶ Preload List å¯ä»¥è®©é˜²å¾¡æ›´æ·±ä¸€å±‚ï¼Œä½†å®ƒä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ã€‚



## Crypto API å‚è€ƒ

- Static
    - crypto.constants
    - crypto.DEFAULT_ENCODING
    - crypto.fips
    - crypto.createCipher(algorithm, password[, options])
    - crypto.createCipheriv(algorithm, key, iv[, options])
    - crypto.createDecipher(algorithm, password[, options])
    - crypto.createDecipheriv(algorithm, key, iv[, options])
    - crypto.createDiffieHellman(prime[, primeEncoding][, generator][, generatorEncoding])
    - crypto.createDiffieHellman(primeLength[, generator])
    - crypto.createDiffieHellmanGroup(name)
    - crypto.createECDH(curveName)
    - crypto.createHash(algorithm[, options])
    - crypto.createHmac(algorithm, key[, options])
    - crypto.createPrivateKey(key)
    - crypto.createPublicKey(key)
    - crypto.createSecretKey(key)
    - crypto.createSign(algorithm[, options])
    - crypto.createVerify(algorithm[, options])
    - crypto.diffieHellman(options)
    - crypto.generateKeyPair(type, options, callback)
    - crypto.generateKeyPairSync(type, options)
    - crypto.getCiphers()
    - crypto.getCurves()
    - crypto.getDiffieHellman(groupName)
    - crypto.getFips()
    - crypto.getHashes()
    - crypto.pbkdf2(password, salt, iterations, keylen, digest, callback)
    - crypto.pbkdf2Sync(password, salt, iterations, keylen, digest)
    - crypto.privateDecrypt(privateKey, buffer)
    - crypto.privateEncrypt(privateKey, buffer)
    - crypto.publicDecrypt(key, buffer)
    - crypto.publicEncrypt(key, buffer)
    - crypto.randomBytes(size[, callback])
    - crypto.randomFillSync(buffer[, offset][, size])
    - crypto.randomFill(buffer[, offset][, size], callback)
    - crypto.randomInt([min, ]max[, callback])
    - crypto.scrypt(password, salt, keylen[, options], callback)
    - crypto.scryptSync(password, salt, keylen[, options])
    - crypto.setEngine(engine[, flags])
    - crypto.setFips(bool)
    - crypto.sign(algorithm, data, key)
    - crypto.timingSafeEqual(a, b)
    - crypto.verify(algorithm, data, key, signature)

- Class: Certificate
    - Certificate.exportChallenge(spkac)
    - Certificate.exportPublicKey(spkac[, encoding])
    - Certificate.verifySpkac(spkac)
    - Legacy API
        - new crypto.Certificate()
        - certificate.exportChallenge(spkac)
        - certificate.exportPublicKey(spkac)
        - certificate.verifySpkac(spkac)

- Class: Cipher
    - cipher.final([outputEncoding])
    - cipher.setAAD(buffer[, options])
    - cipher.getAuthTag()
    - cipher.setAutoPadding([autoPadding])
    - cipher.update(data[, inputEncoding][, outputEncoding])

- Class: Decipher
    - decipher.final([outputEncoding])
    - decipher.setAAD(buffer[, options])
    - decipher.setAuthTag(buffer)
    - decipher.setAutoPadding([autoPadding])
    - decipher.update(data[, inputEncoding][, outputEncoding])

- Class: DiffieHellman
    - diffieHellman.computeSecret(otherPublicKey[, inputEncoding][, outputEncoding])
    - diffieHellman.generateKeys([encoding])
    - diffieHellman.getGenerator([encoding])
    - diffieHellman.getPrime([encoding])
    - diffieHellman.getPrivateKey([encoding])
    - diffieHellman.getPublicKey([encoding])
    - diffieHellman.setPrivateKey(privateKey[, encoding])
    - diffieHellman.setPublicKey(publicKey[, encoding])
    - diffieHellman.verifyError

- Class: DiffieHellmanGroup
- Class: ECDH
    - Static method: ECDH.convertKey(key, curve[, inputEncoding[, outputEncoding[, format]]])
    - ecdh.computeSecret(otherPublicKey[, inputEncoding][, outputEncoding])
    - ecdh.generateKeys([encoding[, format]])
    - ecdh.getPrivateKey([encoding])
    - ecdh.getPublicKey([encoding][, format])
    - ecdh.setPrivateKey(privateKey[, encoding])
    - ecdh.setPublicKey(publicKey[, encoding])

- Class: Hash
    - hash.copy([options])
    - hash.digest([encoding])
    - hash.update(data[, inputEncoding])

- Class: Hmac
    - hmac.digest([encoding])
    - hmac.update(data[, inputEncoding])

- Class: KeyObject
    - keyObject.asymmetricKeyType
    - keyObject.export([options])
    - keyObject.symmetricKeySize
    - keyObject.type

- Class: Sign
    - sign.sign(privateKey[, outputEncoding])
    - sign.update(data[, inputEncoding])

- Class: Verify
    - verify.update(data[, inputEncoding])
    - verify.verify(object, signature[, signatureEncoding])


# ğŸš© TLS/SSL å®‰å…¨ä¼ è¾“å±‚
- https://nodejs.org/docs/latest-v14.x/api/tls.html

TLS - Transport Layer Security å’Œ SSL - Secure Socket Layer æ˜¯åŸºäº PKI ä½“ç³»çš„å®‰å…¨åè®®ï¼Œæ˜¯ HTTPS çš„åŸºç¡€ï¼ŒåŸºäº OpenSSL å¼€æºæ¡†æ¶ä¹‹ä¸Šå®ç°ã€‚

åœ¨å¼€å§‹æµ‹è¯•ä¸­ï¼Œé€šå¸¸éœ€è¦ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ä¾›ç«™ç‚¹ä½¿ç”¨ï¼Œä»¥ä¸‹ä½¿ç”¨ OpenSSL å‘½ä»¤è¡Œç”Ÿæˆå¯†é’¥å¯¹ã€è‡ªç­¾è¯ä¹¦ï¼š

    # 1. generate a 2048-bit RSA private key:
    openssl genrsa -out ryans-key.pem 2048

    # 2. create a Certificate Signing Request (CSR) file.
    openssl req -new -sha256 -key ryans-key.pem -out ryans-csr.pem

    # 3. a Certificate Authority for signing or used to generate a self-signed certificate.
    openssl x509 -req -in ryans-csr.pem -signkey ryans-key.pem -out ryans-cert.pem

    # 4. generate a .pfx or .p12 file:
    openssl pkcs12 -export -in ryans-cert.pem -inkey ryans-key.pem -certfile ca-cert.pem -out ryans.pfx

å‘½ä»¤è¡Œä¸­çš„å‚æ•°è§£æï¼š

- `in`: è¾“å…¥å·²ç­¾åçš„è¯ä¹¦ï¼›
- `inkey`: å…³è”çš„ç§é’¥ï¼›
- `certfile`: ä¸²è¿æ‰€æœ‰ CA - Certificate Authority é¢å‘çš„è¯ä¹¦åˆ°ä¸€ä¸ªè¯ä¹¦æ–‡ä»¶ï¼Œå¦‚ cat ca1-cert.pem ca2-cert.pem > ca-cert.pem

    - TLS/SSL concepts
    - Perfect forward secrecy
    - ALPN and SNI
    - Pre-shared keys
    - Client-initiated renegotiation attack mitigation
    - Session resumption
    - Session identifiers
    - Session tickets
    - Modifying the default TLS cipher suite

ç¤ºèŒƒ TLS Serverï¼š

```
const tls = require('tls');
const fs = require('fs');

const options = {
  key: fs.readFileSync('server-key.pem'),
  cert: fs.readFileSync('server-cert.pem'),

  // This is necessary only if using client certificate authentication.
  requestCert: true,

  // This is necessary only if the client uses a self-signed certificate.
  ca: [ fs.readFileSync('client-cert.pem') ]
};

const server = tls.createServer(options, (socket) => {
  console.log('server connected',
              socket.authorized ? 'authorized' : 'unauthorized');
  socket.write('welcome!\n');
  socket.setEncoding('utf8');
  socket.pipe(socket);
});
server.listen(8000, () => {
  console.log('server bound');
});
```

ç¤ºèŒƒ TLS Clientï¼š

```
// Assumes an echo server that is listening on port 8000.
const tls = require('tls');
const fs = require('fs');

const options = {
  // Necessary only if the server requires client certificate authentication.
  key: fs.readFileSync('client-key.pem'),
  cert: fs.readFileSync('client-cert.pem'),

  // Necessary only if the server uses a self-signed certificate.
  ca: [ fs.readFileSync('server-cert.pem') ],

  // Necessary only if the server's cert isn't for "localhost".
  checkServerIdentity: () => { return null; },
};

const socket = tls.connect(8000, options, () => {
  console.log('client connected',
              socket.authorized ? 'authorized' : 'unauthorized');
  process.stdin.pipe(socket);
  process.stdin.resume();
});
socket.setEncoding('utf8');
socket.on('data', (data) => {
  console.log(data);
});
socket.on('end', () => {
  console.log('server ends connection');
});
```


TLS (SSL) API å‚è€ƒ

- Class: tls.CryptoStream â›”

- Class: tls.SecurePair â›”

- Class: tls.Server
    - Event: 'connection'
    - Event: 'keylog'
    - Event: 'newSession'
    - Event: 'OCSPRequest'
    - Event: 'resumeSession'
    - Event: 'secureConnection'
    - Event: 'tlsClientError'
    - server.addContext(hostname, context)
    - server.address()
    - server.close([callback])
    - server.connections
    - server.getTicketKeys()
    - server.listen()
    - server.setSecureContext(options)
    - server.setTicketKeys(keys)

- Class: tls.TLSSocket
    - new tls.TLSSocket(socket[, options])
    - Event: 'keylog'
    - Event: 'OCSPResponse'
    - Event: 'secureConnect'
    - Event: 'session'
    - tlsSocket.address()
    - tlsSocket.authorizationError
    - tlsSocket.authorized
    - tlsSocket.disableRenegotiation()
    - tlsSocket.enableTrace()
    - tlsSocket.encrypted
    - tlsSocket.getCertificate()
    - tlsSocket.getCipher()
    - tlsSocket.getEphemeralKeyInfo()
    - tlsSocket.getFinished()
    - tlsSocket.getPeerCertificate([detailed])
    - tlsSocket.getPeerFinished()
    - tlsSocket.getProtocol()
    - tlsSocket.getSession()
    - tlsSocket.getSharedSigalgs()
    - tlsSocket.exportKeyingMaterial(length, label[, context])
    - tlsSocket.getTLSTicket()
    - tlsSocket.isSessionReused()
    - tlsSocket.localAddress
    - tlsSocket.localPort
    - tlsSocket.remoteAddress
    - tlsSocket.remoteFamily
    - tlsSocket.remotePort
    - tlsSocket.renegotiate(options, callback)
    - tlsSocket.setMaxSendFragment(size)
    - tls.checkServerIdentity(hostname, cert)

- Static
    - tls.connect(options[, callback])
    - tls.connect(path[, options][, callback])
    - tls.connect(port[, host][, options][, callback])
    - tls.createSecureContext([options])
    - tls.createSecurePair([context][, isServer][, requestCert][, rejectUnauthorized][, options])
    - tls.createServer([options][, secureConnectionListener])
    - tls.getCiphers()
    - tls.rootCertificates
    - tls.DEFAULT_ECDH_CURVE
    - tls.DEFAULT_MAX_VERSION
    - tls.DEFAULT_MIN_VERSION


# ğŸš© TTY ç»ˆç«¯æ–‡ä»¶
- https://nodejs.org/docs/latest-v14.x/api/tty.html
- https://docs.microsoft.com/en-us/windows/console/setconsoletextattribute

å½“ Node.js æ£€æµ‹åˆ°å®ƒè¢«è¿è¡Œæ—¶é™„åŠ äº†ä¸€ä¸ªæ–‡æœ¬ç»ˆç«¯ï¼ˆTTYï¼‰ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹ï¼Œprocess.stdin ä¼šè¢«åˆå§‹åŒ–ä¸º tty.ReadStream çš„å®ä¾‹ï¼Œprocess.stdout å’Œ process.stderr ä¼šè¢«åˆå§‹åŒ–ä¸º tty.WriteStream çš„å®ä¾‹ã€‚

åˆ¤æ–­ Node.js æ˜¯å¦è¢«è¿è¡Œåœ¨ä¸€ä¸ª TTY ä¸Šä¸‹æ–‡ä¸­çš„é¦–é€‰æ–¹æ³•æ˜¯æ£€æŸ¥ process.stdout.isTTY å±æ€§çš„å€¼æ˜¯å¦ä¸º trueï¼š

    $ node -p -e "Boolean(process.stdout.isTTY)"
    true
    $ node -p -e "Boolean(process.stdout.isTTY)" | cat
    false

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºå‡ ä¹æ²¡æœ‰ç†ç”±æ‰‹åŠ¨åœ°åˆ›å»º tty.ReadStream å’Œ tty.WriteStream ç±»çš„å®ä¾‹ã€‚

tty ç†è§£ä¸ºç»ˆç«¯ï¼Œtty æ¨¡å—æä¾›ç»ˆç«¯ç›¸å…³çš„æ¥å£ï¼Œç”¨æ¥è·å–ç»ˆç«¯çš„è¡Œæ•°åˆ—æ•°ç­‰ã€‚

æ—©æœŸï¼Œç”µè„‘æ˜¯å¤§å‹ä¸»æœºï¼Œä¸åƒç°ä»£ç”µè„‘ä¸€æ ·æ–¹ä¾¿æ“ä½œã€‚é€šå¸¸éœ€è¦é€šè¿‡ç»ˆç«¯è®¾å¤‡è¿›è¡Œè¿œç¨‹æ“ä½œï¼Œè€Œ`ç»ˆç«¯æ§åˆ¶ç¬¦`çš„å‡ºç°æ˜¯å› ä¸ºï¼Œæ—©æœŸè®¡ç®—æœºè®¾å¤‡ç”¨æˆ·éƒ½ä¼šé€šè¿‡ç½‘ç»œè®¿é—®ä¸€å°å…¬ç”¨ä¸»æœºï¼Œè€Œç”¨æˆ·æ‰‹ä¸­åªæœ‰ä¸€å°æ˜¾ç¤ºå™¨å’Œè¾“å…¥è®¾å¤‡ã€‚ä½†ä¸åŒçš„æ˜¾ç¤ºå™¨ä¸é”®ç›˜ç¡¬ä»¶ä¸Šäº’ä¸å…¼å®¹ï¼Œè¿™å°±å¯¼è‡´æ˜¾ç¤ºçš„å†…å®¹å¯èƒ½ä¼šä¸ä¸€è‡´ã€‚æ­¤æ—¶å°±ä¼šå¯¼è‡´éå¸¸å¤šçš„é—®é¢˜ï¼Œæ‰€ä»¥å½“æ—¶å‡ºç°äº†ç»ˆç«¯æ§åˆ¶ç¬¦è¿™ç§åè®®ã€‚äº‹å®ä¸Šåè®®éå¸¸å¤šï¼Œä½†æ˜¯åæ¥ç”¨çš„æœ€å¤šçš„æ˜¯ vt100ã€‚

æ§åˆ¶é€‰é¡¹è¯´æ˜ 
 
    \33[0m å…³é—­æ‰€æœ‰å±æ€§ 
    \33[1m è®¾ç½®é«˜äº®åº¦ 
    \33[4m ä¸‹åˆ’çº¿ 
    \33[5m é—ªçƒ 
    \33[7m åæ˜¾ 
    \33[8m æ¶ˆéš 
    \33[30m â€” \33[37m è®¾ç½®å‰æ™¯è‰² 
    \33[40m â€” \33[47m è®¾ç½®èƒŒæ™¯è‰² 
    \33[nA å…‰æ ‡ä¸Šç§»nè¡Œ 
    \33[nB å…‰æ ‡ä¸‹ç§»nè¡Œ 
    \33[nC å…‰æ ‡å³ç§»nè¡Œ 
    \33[nD å…‰æ ‡å·¦ç§»nè¡Œ 
    \33[y;xH è®¾ç½®å…‰æ ‡ä½ç½® 
    \33[2J æ¸…å± 
    \33[K æ¸…é™¤ä»å…‰æ ‡åˆ°è¡Œå°¾çš„å†…å®¹ 
    \33[s ä¿å­˜å…‰æ ‡ä½ç½® 
    \33[u æ¢å¤å…‰æ ‡ä½ç½® 
    \33[?25l éšè—å…‰æ ‡ 

åˆ°åæ¥ï¼Œæ“ä½œç³»ç»Ÿä¸­å¯¹ç»ˆç«¯è¿›è¡Œæ¨¡æ‹Ÿï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç°åœ¨æ‰€è¯´çš„æ¨¡æ‹Ÿç»ˆç«¯ï¼Œæ¨¡æ‹Ÿç»ˆç«¯ä¸­ä¾ç„¶æ”¯æŒè¿™äº›ç»ˆç«¯æ§åˆ¶ç¬¦ã€‚

å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ clear æ¸…å±å‘½ä»¤ï¼Œäº‹å®ä¸Šå°±æ˜¯è¢«è½¬æ¢ä¸ºä¸€ç»„å†…å®¹ä¸º `\33[2J` çš„æ§åˆ¶ç¬¦ï¼Œä¸æ­¤åŒæ—¶æ›´å¤šçš„æ§åˆ¶ç¬¦å¯ä»¥æ‰§è¡Œé¢œè‰²è®¾ç½®ï¼Œç®€å•ç»˜å›¾ç­‰å¤šç§å‘½ä»¤ã€‚

åœ¨ Node ç¨‹åºä¸­ï¼Œæ¸…å±åªéœ€æ‰§è¡Œå¦‚ä¸‹ä»£ç å³å¯ï¼š

    console.log("\33[2J");

Linux ç»ˆç«¯ä¸­çš„é¢œè‰²æ˜¯ç”¨è½¬ä¹‰åºåˆ—æ§åˆ¶çš„ï¼Œè½¬ä¹‰åºåˆ—ä»¥ ESC å¼€å¤´ï¼Œå¯ä»¥ç”¨å…«è¿›åˆ¶ \033 æˆ–åè¿›åˆ¶ 27ï¼Œåå…­è¿›è¡Œåˆ¶ 0x1b è¡¨ç¤º ESC çš„ ASCII ç ï¼Œå…¶æ ¼å¼ä¸ºï¼š

    \033[æ˜¾ç¤ºæ–¹å¼;å‰æ™¯è‰²;èƒŒæ™¯è‰²m æ˜¾ç¤ºå†…å®¹ \033[0m

æ˜¾ç¤ºæ–¹å¼ã€å‰æ™¯è‰²ã€èƒŒæ™¯è‰²è‡³å°‘ä¸€ä¸ªå­˜åœ¨å³å¯ï¼Œä½ç½®å¯éšæ„ã€‚Linux ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨ printf å‘½ä»¤ï¼š

    printf "\033[1;45;33m HELLO_WORLD \033[0m\n"

    printf ("\033[1;45;33m HELLO_WORLD \033[0m\n");

    å‰æ™¯è‰²            èƒŒæ™¯è‰²             é¢œè‰²
     ---------------------------------------
     30                40               é»‘è‰²
     31                41               çº¢è‰²
     32                42               ç»¿è‰²
     33                43               é»ƒè‰²
     34                44               è“è‰²
     35                45               ç´«çº¢è‰²
     36                46               é’è“è‰²
     37                47               ç™½è‰²
    æ˜¾ç¤ºæ–¹å¼            æ„ä¹‰
     -------------------------
     0                ç»ˆç«¯é»˜è®¤è®¾ç½®
     1                é«˜äº®æ˜¾ç¤º
     4                ä½¿ç”¨ä¸‹åˆ’çº¿
     5                é—ªçƒ
     7                åç™½æ˜¾ç¤º
     8                ä¸å¯è§
    nA   å…‰æ ‡ä¸Šç§»nè¡Œ
    nB   å…‰æ ‡ä¸‹ç§»nè¡Œ
    nC   å…‰æ ‡å³ç§»nè¡Œ
    nD   å…‰æ ‡å·¦ç§»nè¡Œ

ç¤ºèŒƒï¼Œç»ˆç«¯å­—ç¬¦åŠ¨ç”»ï¼š

```
var process = require('process');
var tty = require('tty');

if(!process.stdout.isTTY) {
  return console.log('No TTY available', process.stdout.isTTY);
}

var ws = new tty.WriteStream(process.stdout.fd);
var width = ws.columns;

var head = "|";
var foot = "%";
var progress = "";
var num = 0;

function spin()
{
    foot = num + "%";
    var len = width - head.length - foot.length - 1;
    var p = Math.ceil( num / 100 * len );
  progress = "";
    for(var i=0; i<len; i++)
    {
    progress += ( i<=p )? "=":" ";
    }
    process.stdout.write(head+progress+foot+"\33[K\r");
    num+=5;
    if( num>100 )
    {
        process.stdout.write("\33[K\r");
        process.exit(0);
    }
}

setInterval(spin,500);
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ç°æˆçš„ progress æ¨¡å—ï¼š

```
const ProgressBar = require('progress')

const bar = new ProgressBar(':bar', { total: 10 })
const timer = setInterval(() => {
  bar.tick()
  if (bar.complete) {
    clearInterval(timer)
  }
}, 100)
```



TTY API

- Class: tty.ReadStream
    - readStream.isRaw
    - readStream.isTTY
    - readStream.setRawMode(mode)

- Class: tty.WriteStream
    - Event: 'resize'
    - writeStream.clearLine(dir[, callback])
    - writeStream.clearScreenDown([callback])
    - writeStream.columns
    - writeStream.cursorTo(x[, y][, callback])
    - writeStream.getColorDepth([env])
    - writeStream.getWindowSize()
    - writeStream.hasColors([count][, env])
    - writeStream.isTTY
    - writeStream.moveCursor(dx, dy[, callback])
    - writeStream.rows
    - tty.isatty(fd)


# ğŸš© Readline è¯»å–è¡Œ
- https://nodejs.org/api/readline.html
- https://nodejs.dev/learn/accept-input-from-the-command-line-in-nodejs
- å‘½ä»¤è¡Œäº¤äº’æ¨¡å— https://github.com/SBoudrias/Inquirer.js

è¯»å…¥æ•°æ®ï¼š

```
const readline = require('readline').createInterface({
  input: process.stdin,
  output: process.stdout
})

readline.question(`What's your name?`, name => {
  console.log(`Hi ${name}!`)
  readline.close()
})
```

æˆ–è€…ä½¿ç”¨ inquirer æ¨¡å—ï¼Œè¿™æ˜¯åŠŸèƒ½éå¸¸å®Œå–„çš„æ§åˆ¶å°è¾“å…¥æ¨¡å—ï¼Œè®¸å¤šæ¡†æ¶çš„è„šæ‰‹æ¶éƒ½ç”¨åˆ°å®ƒï¼š

```
const inquirer = require('inquirer')

var questions = [
  { type: 'input', name: 'name', message: "What's your name?" },
  { 
    type: 'rawlist', 
    name: 'years', 
    message: "When was PRC founded?", 
    choices: [ "1945", new inquirer.Separator(), "1949", new inquirer.Separator(), "1955" ]
  },
  {
    type: 'checkbox',
    name: 'favor',
    message: "What's your favor?",
    choices: [ "Azure", new inquirer.Separator(), "Blue Violet" ]
  },
]

inquirer.prompt(questions).then(answers => {
  console.log(`Hi ${answers['name']}!`, answers)
})
```

é€è¡Œè¯»å–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ line äº‹ä»¶ï¼š

```
const fs = require('fs');
const readline = require('readline');

async function processLineByLine() {
  const fileStream = fs.createReadStream('input.txt');

  const rl = readline.createInterface({
    input: fileStream,
    crlfDelay: Infinity
  });
  // Note: we use the crlfDelay option to recognize all instances of CR LF
  // ('\r\n') in input.txt as a single line break.

  for await (const line of rl) {
    // Each line in input.txt will be successively available here as `line`.
    console.log(`Line from file: ${line}`);
  }
}

processLineByLine();
```

Readline API

- Class: Interface
    - Event: 'close'
    - Event: 'line'
    - Event: 'history'
    - Event: 'pause'
    - Event: 'resume'
    - Event: 'SIGCONT'
    - Event: 'SIGINT'
    - Event: 'SIGTSTP'
    - rl.close()
    - rl.pause()
    - rl.prompt([preserveCursor])
    - rl.question(query[, options], callback)
    - rl.resume()
    - rl.setPrompt(prompt)
    - rl.getPrompt()
    - rl.write(data[, key])
    - rl[Symbol.asyncIterator]()
    - rl.line
    - rl.cursor
    - rl.getCursorPos()
    - readline.clearLine(stream, dir[, callback])
    - readline.clearScreenDown(stream[, callback])
    - readline.createInterface(options)
    - Use of the completer function
    - readline.cursorTo(stream, x[, y][, callback])
    - readline.emitKeypressEvents(stream[, interface])
    - readline.moveCursor(stream, dx, dy[, callback])



# ğŸš© Stream æµå¯¹è±¡
- https://nodejs.org/docs/latest-v12.x/api/stream.html
- https://nodejs.org/docs/latest-v14.x/api/stream.html
- https://nodejs.org/en/docs/guides/backpressuring-in-streams/

æµæ¨¡å—æ˜¯ Node éå¸¸æ ¸å¿ƒåˆåº•å±‚çš„æ¨¡å—ï¼Œåˆ°å¤„éƒ½æœ‰æµå¯¹è±¡çš„åº”ç”¨ã€‚

æœ‰å››ç§ stream ç±»å‹ï¼š

- Readable ç”¨æ¥è¯»å–æ•°æ®ï¼Œæ•°æ®è¯»å–å°±åƒä½ ç”¨å¸ç®¡å–å¯ä¹çš„è¿‡ç¨‹ï¼Œå¯ä¹æ˜¯æ•°æ®ï¼Œä½ å°±æ˜¯æ•°æ®æ¶ˆè´¹è€…ã€‚
- Writable ç”¨æ¥å†™æ•°æ®ï¼Œæ•°æ®å†™å…¥å°±åƒç”¨ä¸€ä¸ªæ°´æ¡¶æ¥æ°´é¾™å¤´çš„æ°´çš„è¿‡ç¨‹ï¼Œæ°´æµè¿›æ°´æ¡¶å°±æ˜¯å†™å…¥æ•°æ®ã€‚
- Duplex å¯è¯»å†™æµï¼Œæ¯”å¦‚ net.Socket()ã€‚
- Transform åœ¨è¯»å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚æ•°æ®å‹ç¼©/è§£å‹ zlib.createDeflate()ã€‚

å¸¸è§çš„ Readable ï¼š

- HTTP responses, on the client
- HTTP requests, on the server
- http.IncomingRequest
- fs read streams
- child process stdout and stderr
- process.stdin

å¸¸è§çš„ Writableï¼š

- HTTP requests, on the client
- HTTP responses, on the server
- fs write streams
- child process stdin
- process.stdout, process.stderr

Duplex streams include:

- TCP sockets
- zlib streams - Transform stream
- crypto streams - Transform stream

æ¯”å¦‚ä»æ–‡ä»¶åˆ›å»ºæµ fs.createReadStream() fs.createWriteStream()ã€‚

æœ€å¸¸è§çš„ Duplex stream åº”è¯¥å°±æ˜¯ net.Socket å®ä¾‹ï¼Œå¯ä»¥å‚è€ƒç›¸å…³æ¨¡å—æ–‡æ¡£ã€‚

Transform stream æ˜¯ Duplex stream çš„ç‰¹ä¾‹ï¼Œå®ƒä»¬éƒ½å®ç°äº† Readable & Writable æ¥å£ï¼ŒåŒæ—¶å¯è¯»å¯å†™ï¼ŒåŒºåˆ«åœ¨äº Transform stream çš„è¾“å‡ºä¸è¾“å…¥æ˜¯å­˜åœ¨ç›¸å…³æ€§çš„ã€‚

ä¾‹å¦‚ä½¿ç”¨ gzip å‹ç¼©æ–‡ä»¶ï¼š

```
var fs = require('fs');
var zlib = require('zlib');

var gzip = zlib.createGzip();

var inFile = fs.createReadStream('./extra/test.txt');
var out = fs.createWriteStream('./extra/test.txt.gz');

inFile.pipe(gzip).pipe(out);
```

æµçš„æ ¸å¿ƒæ–¹æ³•ï¼š

    |                    Use-case                   |   Class   |          Method(s) to implement          |
    |-----------------------------------------------|-----------|------------------------------------------|
    | Reading only                                  | Readable  | _read()                                  |
    | Writing only                                  | Writable  | _write(), _writev(), _final()            |
    | Reading and writing                           | Duplex    | _read(),  _write(),  _writev(), _final() |
    | Operate on written data, then read the result | Transform | _transform(), _flush(), _final()         |

Node åˆ›å»ºçš„æ‰€æœ‰æµéƒ½åªå¯¹å­—ç¬¦ä¸²å’Œ `Buffer` æˆ– `Uint8Array` å¯¹è±¡è¿›è¡Œæ“ä½œã€‚å¦‚æœä¸å…¶ä»– JavaScript ç±»å‹çš„å€¼ä¸€èµ·å·¥ä½œï¼Œæœ‰ç‰¹æ®Šç”¨é€”çš„ null é™¤å¤–ï¼Œè¿™æ ·çš„æµè¢«è®¤ä¸ºæ˜¯åœ¨ Object mode ä¸‹æ“ä½œã€‚åˆ›å»ºæµæ—¶ï¼Œä½¿ç”¨ `objectMode` é€‰é¡¹è®¾ç½®æµå®ä¾‹ä¸ºå¯¹è±¡æ¨¡å¼ï¼Œå°è¯•å°†ç°æœ‰æµåˆ‡æ¢åˆ°å¯¹è±¡æ¨¡å¼æ˜¯ä¸å®‰å…¨çš„ã€‚

å¤„äº object mode çš„æµï¼Œå¯ä»¥æ“ä½œå…¶å®ƒ JavaScript å€¼ï¼š

- Readable stream è°ƒç”¨ stream.read(size) æ€»ä¼šè¿”å›å•ä¸ªé¡¹ç›®ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆå‚æ•°ï¼Œè€Œä¸æ˜¯ Buffer å…ƒç´ æ•°é‡ã€‚
- Writable stream å¯ä»¥å†™ä»»æ„æ•°æ®ï¼Œæ€»ä¼šå¿½ç•¥ä¼ ç»™ stream.write(data, encoding) çš„ encoding å‚æ•°ã€‚


`Readable` å¯¹è±¡ä¸»è¦äº‹ä»¶ï¼š

- `data` äº‹ä»¶ä¼šåœ¨æµå°†æ•°æ®ä¼ é€’ç»™æ¶ˆè´¹è€…æ—¶è§¦å‘ï¼›
- `end` äº‹ä»¶å°†åœ¨æµä¸­å†æ²¡æœ‰æ•°æ®å¯ä¾›æ¶ˆè´¹æ—¶è§¦å‘ï¼›
- `readable` è¡¨æ˜æµæœ‰äº†æ–°çš„åŠ¨æ€ï¼Œè¦ä¹ˆæ˜¯æœ‰äº†æ–°çš„æ•°æ®ï¼Œè¦ä¹ˆæ˜¯åˆ°äº†æµçš„å°¾éƒ¨ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸º readable äº‹ä»¶é™„åŠ ä¸€ä¸ªä¾¦å¬å™¨ä¼šå¯¼è‡´ä¸€äº›æ•°æ®è¢«è¯»å…¥å†…éƒ¨ç¼“å†²åŒºï¼Œå¯èƒ½ä¼šåœ¨å¼€å§‹æ—¶è¯»å–åˆ° nullã€‚

`Writable` å¯¹è±¡ä¸»è¦äº‹ä»¶ï¼š

- `drain` æ•°æ®æ’ç©ºäº‹ä»¶ï¼Œè¡¨ç¤ºå¯ä»¥ç¼“å†²åŒºå†æ¬¡æ¥æ”¶æ•°æ®å†™å…¥ã€‚
- `pipe` è¡¨ç¤º `Readable` æ‰§è¡Œäº† pipe() æ–¹æ³•å†™å…¥æ•°æ®ã€‚


`Readable` æœ‰ä¸¤ç§æ¨¡å¼ï¼š

- `flowing` æ¨¡å¼ä¸‹ `Readable` å¯è‡ªåŠ¨ä»èµ„æºè¯»å–æ•°æ®ï¼›
- `pause` æ¨¡å¼ä¸‹éœ€è¦æ˜¾å¼è°ƒç”¨ stream.read() æ–¹æ³•æ¥è¯»å–æ•°æ®ï¼›

`pause` æ¨¡å¼ä¸‹å¯è¯»æµæœ‰ä¸‰ç§çŠ¶æ€ï¼Œæ ¹æ® `readable._readableState.flowing` å±æ€§åˆ¤æ–­ï¼š

- flowing = null ç›®å‰æ²¡æœ‰æ•°æ®æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥ä¸ä¼šä»èµ„æºåº“ä¸­è¯»å–æ•°æ®ï¼›
- flowing = false æš‚åœä»èµ„æºåº“è¯»å–æ•°æ®ï¼Œreadable.pause()ï¼Œ readable.unpipe()ï¼Œæˆ–è€…æ¥æ”¶ back pressure å¯è½¬æ¢åˆ°æ­¤çŠ¶æ€ï¼›
- flowing = true æ­£åœ¨ä»èµ„æºåº“ä¸­è¯»å–æ•°æ®ï¼Œç›‘å¬ 'data' äº‹ä»¶ï¼Œè°ƒç”¨ readable.pipe() æˆ–è€… readable.resume() æ–¹æ³•å¯è½¬æ¢åˆ°æ­¤çŠ¶æ€ï¼›

`Readable` æ•°æ®æµå¹¶ä¸æ˜¯ç›´æ¥æµå‘æ¶ˆè´¹è€…ï¼Œè€Œæ˜¯å…ˆ push åˆ°ç¼“å­˜æ± ï¼Œç¼“å­˜æ± å°±åƒä¸€ä¸ªç©ºçš„æ°´æ¡¶ï¼Œæ¶ˆè´¹è€…é€šè¿‡ç®¡å£æ¥æ°´ã€‚åŒæ—¶ï¼Œèµ„æºæ± å°±åƒæœ‰ä¸€ä¸ªæ°´æ³µï¼Œä¸æ–­åœ°å¾€æ°´æ¡¶ä¸­æ³µæ°´ï¼Œè€Œ `highWaterMark` æ˜¯æ°´æ¡¶çš„æµ®æ ‡ï¼Œè¾¾åˆ°é˜ˆå€¼å°±åœæ­¢è“„æ°´ï¼Œå† push çš„æ—¶å€™ä¼šè¿”å› falseï¼Œä»è€Œæ§åˆ¶è¯»å–æ•°æ®æµçš„é€Ÿåº¦ã€‚å¦‚åŒæ°´ç®¡ä¸Šçš„é˜€é—¨ï¼Œå½“æ°´ç®¡é¢è£…æ»¡äº†æ°´ï¼Œå°±æš‚æ—¶å…³ä¸Šé˜€é—¨ï¼Œä¸å†ä»èµ„æºé‡ŒæŠ½æ°´å‡ºæ¥ã€‚

ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ

- æ¶ˆè´¹è€…ä¸»åŠ¨æ‰§è¡Œäº† .pause()ï¼›
- æ¶ˆè´¹é€Ÿåº¦æ¯”æ•°æ® push() æ•°æ®é€Ÿåº¦æ…¢ï¼›

setEncoding è®¾ç½®è¯»å–æ—¶çš„è§£ç ç¼–ç ï¼Œè€Œä¸æ˜¯ Buffer å¯¹è±¡æ•°æ®çš„ç¼–ç ã€‚

æ•°æ®æ¶ˆè´¹è€…å¯ä»¥ä¸»åŠ¨è°ƒç”¨ read([size]) æ–¹æ³•ä»ç¼“å­˜æ± å–å‡ºæ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥å¸¦ä¸Š size å‚æ•°ï¼Œç”¨å¤šå°‘å°±å–å¤šå°‘ï¼Œä½†æ˜¯æ•°æ®éœ€è¦åœ¨ readable äº‹ä»¶è§¦å‘åæ‰å¯è¯»å–ã€‚

æœ‰äº›æƒ…å†µä¸‹ï¼Œéœ€è¦è§¦å‘åº•å±‚å¯è¯»æµæœºåˆ¶çš„åˆ·æ–°ï¼Œè€Œä¸å®é™…æ¶ˆè€—ä»»ä½•æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‰§è¡Œ `read(0)`ï¼Œå®ƒå°†å§‹ç»ˆè¿”å› nullã€‚

å°†é›¶å­—èŠ‚å­—ç¬¦ä¸²ã€Buffer æˆ– Uint8Array æ¨é€åˆ°éå¯¹è±¡æ¨¡å¼çš„æµä¸­æœ‰ä¸€ä¸ªæœ‰è¶£çš„å‰¯ä½œç”¨ï¼Œå› ä¸º `push('')` å°†ç»“æŸè¯»å–è¿‡ç¨‹ã€‚ä½†æ˜¯ï¼Œç”±äºå‚æ•°æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå› æ­¤ä¸ä¼šå°†ä»»ä½•æ•°æ®æ·»åŠ åˆ°å¯è¯»ç¼“å†²åŒºä¸­ï¼Œå› æ­¤ç”¨æˆ·æ— éœ€æ¶ˆè´¹ä»»ä½•æ•°æ®ã€‚

ä½¿ç”¨ `pipe()` æ–¹æ³•å¯ä»¥ç›´æ¥å°†æ•°æ®æµç›´æ¥å¯¼å…¥ `Writable`ï¼Œå°±åƒæ˜¯è”é€šå™¨ï¼Œç›´æ¥è¯»å– `Readable` æ•°æ®å¹¶å†™å…¥ `Writable`ï¼Œå¹¶ä¸”ä¼šè§¦å‘å…¶ pipe äº‹ä»¶ã€‚

å‚è€ƒ `pipe()` æ–¹æ³•æºä»£ç ï¼š

    Readable.prototype.pipe = function(writable, options) {
      this.on('data', (chunk) => {
        let ok = writable.write(chunk);
        if(!ok) this.pause();
      });
      writable.on('drain', () => {
        this.resume();
      });
      writable.emit('pipe', this);
      return writable;
    };

å®ƒæ ¹æ® `Writable` æ˜¯ä¸å¤„äºæ’ç©ºçŠ¶æ€æ¥å†™å…¥æ•°æ®ï¼Œå¦‚æœå†™å…¥è¿‡å¿«å°±æ‰§è¡Œ `pause()` æš‚åœå†™å…¥ï¼ŒåŒæ—¶åœæ­¢ data äº‹ä»¶ï¼Œç­‰å¾… writable çš„æ’ç©ºäº‹ä»¶å†æ¢å¤å†™å…¥ã€‚

æ‰§è¡Œ Writable stream.write(chunk) è¿”å› false ç¼“å†²åŒºå·²æ»¡ï¼Œéœ€è¦ç­‰å¾… drain äº‹ä»¶è§¦å‘ï¼Œè¿™ä¸ªäº‹ä»¶è¡¨ç¤ºæ•°æ®å·²ç»æŠ½å¹²ï¼Œå¯ä»¥å†å†™å…¥æ•°æ®ã€‚

æ•´ä¸ª pipe() æµç¨‹å°±æ˜¯ backpressuring in streams æœºåˆ¶ï¼Œå¦‚æœæ²¡æœ‰å›å‹æœºåˆ¶ï¼Œç³»ç»Ÿå°†ä¼šå‡ºç°å¦‚ä¸‹çš„é—®é¢˜ï¼š

- å†…å­˜æº¢å‡ºï¼›
- å…¶ä»–è¿›ç¨‹å˜å¾—ç¼“æ…¢ï¼›
- åƒåœ¾æ”¶é›†å™¨å°†è¶…è´Ÿè·è¿ä½œï¼›


ä»¥ä¸‹ç»¼åˆæ¼”ç¤ºè¿™äº› API çš„ä½¿ç”¨ï¼š

```
const { Readable, Writable } = require('stream');
const { createWriteStream } = require('fs');

class Alphabet extends Readable{
    constructor(dataSource, options){
        super(options)
        this.dataSource = dataSource
    }
    // override super method
    _read(){
        const data = this.dataSource.makeData()
        this.push(data)
    }
}

const dataSource = {
    data: 'abcdefghijklmnopqrstuvwxyz'.split(/(?=\w)/g),
    makeData: function(){
      return (!this.data.length)? null : this.data.shift()
    }
}

const alphabet = new Alphabet(dataSource);
alphabet.setEncoding('utf8');

process.stdout.on("pipe", (src)=>{
  console.log('on pipe: src is Alphabet? ', src instanceof Alphabet);
  alphabet.unpipe(process.stdout);
});
alphabet.pipe(process.stdout);
alphabet.pipe(createWriteStream('alphabet.txt'));

alphabet.once('readable', ()=>{
  alphabet.read(0); // read out null
  console.log('read abc:', alphabet.read(3));
  alphabet.removeListener
});

alphabet.on('data', (chunk) => {
  console.log(' <on data>:', chunk);
});
```

éƒ½çŸ¥é“ Node API éƒ½æ˜¯æŒ‰å¼‚æ­¥ I/O æ¡†æ¶å®ç°çš„ï¼Œå¯¹æ¯”ä¸€ä¸‹ä»¥ä¸‹ä¸¤ç§ Server å®ç°æ–¹å¼ï¼š

```
var http = require('http');
var fs = require('fs');

var server = http.createServer(function(req, res){
  // fs.readFile() read all data then put it into response.
  fs.readFile(__dirname + '/alphabet.txt',function(err, data){
    res.end(data);
  });

  // use Readable to stream out data flow.
  var stream = fs.createReadStream(__filename);
  stream.pipe(res);
}).listen(3000);
```

é€šè¿‡æµ‹è¯•å¯ä»¥å‘ç°ï¼Œstream æ–¹å¼çš„å†…å®¹ä¼šæ›´ä¼˜å…ˆè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯å› ä¸ºæµè¡Œæ›´æœ‰æ•ˆç‡ï¼Œç»“åˆ zlib æ¨¡å—è¿˜å¯ä»¥ç»™å®¢æˆ·ç«¯è¿”å› gzip æ•°æ®ï¼ŒèŠ‚çœå¸¦å®½ã€‚`pipe()` æ–¹æ³•ä¼šè‡ªåŠ¨ç›‘å¬ data å’Œ end äº‹ä»¶ã€‚ä¸Šé¢çš„ä»£ç ä¼šå°†æ–‡ä»¶æ¯ä¸€ä¸ªå°æ®µæ•°æ®éƒ½æºæºä¸æ–­çš„å‘é€åˆ°å®¢æˆ·ç«¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæµå¼æ•°æ®å¤„ç†è¿˜å¯ä»¥é™ä½åå°å‹åŠ›ï¼Œå®¢æˆ·ç«¯è¿æ¥ç¼“æ…¢çš„æ—¶å€™ Node å¯ä»¥ç›¸åº”å‡å°‘ç¼“å­˜æ•°æ®çš„å¤„ç†ã€‚

å¦‚æœä½¿ç”¨æ–‡ä»¶æ–¹å¼ï¼Œåœ¨æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œéƒ½ä¼šå…ˆè¯»å–æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç‰¹åˆ«æ˜¯å¯¹äºå¤§å°ºå¯¸æ–‡ä»¶ï¼Œæ¶ˆè€—å†…å­˜ä¼šæ›´æ˜æ˜¾ï¼ŒåŒæ—¶ç­‰å¾…æ–‡ä»¶è¯»å…¥å†…å­˜è¿™ä¸ªè¿‡ç¨‹çš„ç”¨æˆ·ä½“éªŒä¸å¥½ã€‚

è€Œæµå¼å¤„ç†åˆ™å®Œå…¨æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œå®ƒæ˜¯ä¸€ç§éšè¯»éšç”¨çš„æ•°æ®å¤„ç†æ–¹å¼ã€‚æ‰“ä¸ªéå¸¸æ°å½“çš„æ¯”æ–¹ï¼Œæµå¼æ•°æ®å°±åƒæ°´ç®¡é‡Œçš„æ°´ï¼Œæƒ³å–å°±æ‹§å¼€ã€‚è€Œæ–‡ä»¶ API è¯»å–åˆ™ç›¸å½“æä¸ªç€æ°´æ¡¶å»æ°´äº•æ‰“æ°´å–ã€‚


å¯ä»¥ä¸å¼‚æ­¥ç”Ÿæˆå™¨ç»“åˆï¼š

```
const { Readable } = require('stream');

async function * generate() {
  yield 'a';
  yield 'b';
  yield 'c';
}

const readable = Readable.from(generate());

readable.on('data', (chunk) => {
  console.log(chunk);
});
```

Piping to writable streams from async iterators

```
const { pipeline } = require('stream');
const util = require('util');
const fs = require('fs');

const writable = fs.createWriteStream('./file');

// Callback Pattern
pipeline(iterator, writable, (err, value) => {
  if (err) {
    console.error(err);
  } else {
    console.log(value, 'value returned');
  }
});

// Promise Pattern
const pipelinePromise = util.promisify(pipeline);
pipelinePromise(iterator, writable)
  .then((value) => {
    console.log(value, 'value returned');
  })
  .catch(console.error);
```

åœ¨è¿‡å»çš„ Node.js ä¸­ï¼Œå¤„ç† stream æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

    source.pipe(a).pipe(b).pipe(c).pipe(dest)

ä¸€æ—¦å…¶ä¸­ sourceã€aã€bã€cã€dest ä¸­ï¼Œæœ‰ä»»ä½•ä¸€ä¸ª stream å‡ºé”™æˆ–è€…å…³é—­ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç®¡é“åœæ­¢ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ‰‹å·¥é”€æ¯æ‰€æœ‰çš„ streamï¼Œåœ¨ä»£ç å±‚é¢è¿™æ˜¯éå¸¸éº»çƒ¦çš„ã€‚

æ‰€ä»¥ç¤¾åŒºå‡ºç°äº† pump è¿™æ ·çš„åº“æ¥è‡ªåŠ¨æ§åˆ¶ stream çš„é”€æ¯ã€‚è€Œ Node.js v10.0 åŠ å…¥äº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼šstream.pipeline()ï¼Œå¯ä»¥æ›¿ä»£ pump å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç®¡ç† streamã€‚

é™æ€æ–¹æ³• pipeline() é€šå¸¸å’Œ zlib é…åˆä½¿ç”¨ï¼Œå°†ä¸€ä¸ª Readable ä¸å¤šä¸ªæµè¿›è¡Œæ··åˆå¤„ç†ã€‚é€šè¿‡ç®¡çº¿æœºåˆ¶ï¼Œç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†è¯¥æµçš„è¾“å‡ºä¼ é€’åˆ°å¦å¤–çš„æµï¼Œç®€å•åœ°è¯´ï¼Œç®¡çº¿æ–¹æ³•ç”¨äºåˆ†æ­¥éª¤å¤„ç†æµæ•°æ®ã€‚


Stream API

- Class: stream.Writable
    - Event: close( )
    - Event: drain( )
    - Event: error( )
    - Event: finish( )
    - Event: pipe( src )
    - Event: unpipe( )
    - writable.cork()
    - writable.destroy([error])
    - writable.destroyed
    - writable.end([chunk[, encoding]][, callback])
    - writable.setDefaultEncoding(encoding)
    - writable.uncork()
    - writable.writable
    - writable.writableEnded
    - writable.writableCorked
    - writable.writableFinished
    - writable.writableHighWaterMark
    - writable.writableLength
    - writable.writableObjectMode
    - writable.write(chunk[, encoding][, callback])

- Class: stream.Readable
    - Event: close( )
    - Event: data( chunk )
    - Event: end( )
    - Event: error( )
    - Event: pause( )
    - Event: readable( )
    - Event: resume( )
    - readable.destroy([error])
    - readable.destroyed
    - readable.isPaused()
    - readable.pause()
    - readable.pipe(destination[, options])
    - readable.read([size])
    - readable.readable
    - readable.readableEncoding
    - readable.readableEnded
    - readable.readableFlowing
    - readable.readableHighWaterMark
    - readable.readableLength
    - readable.readableObjectMode
    - readable.resume()
    - readable.setEncoding(encoding)
    - readable.unpipe([destination])
    - readable.unshift(chunk[, encoding])
    - readable.wrap(stream)
    - readable[Symbol.asyncIterator]()

- Class: stream.Duplex
- Class: stream.Transform
    - transform.destroy([error])
    - stream.finished(stream[, options], callback)
    - stream.pipeline(source[, ...transforms], destination, callback)
    - stream.pipeline(streams, callback)
    - stream.Readable.from(iterable, [options])

- Implementing a writable stream
    - new stream.Writable([options])
    - writable._write(chunk, encoding, callback)
    - writable._writev(chunks, callback)
    - writable._destroy(err, callback)
    - writable._final(callback)

- Implementing a readable stream
    - new stream.Readable([options])
    - readable._read(size)
    - readable._destroy(err, callback)
    - readable.push(chunk[, encoding])

- Implementing a duplex stream
    - new stream.Duplex(options)
    - An example duplex stream
    - Object mode duplex streams

- Implementing a transform stream
    - new stream.Transform([options])
    - Event: 'end'
    - Event: 'finish'
    - transform._flush(callback)
    - transform._transform(chunk, encoding, callback)
    - Class: stream.PassThrough


# ğŸš© Zlib å‹ç¼©åº“
- https://nodejs.org/docs/latest-v14.x/api/zlib.html
- https://hacks.mozilla.org/2015/11/better-than-gzip-compression-with-brotli/
- Accept-Encoding https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3
- Brotli Compressed Data Format https://tools.ietf.org/html/rfc7932
- DEFLATE Compressed Data Format Specification v1.3 https://tools.ietf.org/html/rfc1951
- GZIP file format specification v4.3 https://tools.ietf.org/html/rfc1952
- HTTP/1.1: Message Syntax and Routing - Gzip Coding https://tools.ietf.org/html/rfc7230#section-4.2.3
- https://cran.r-project.org/web/packages/brotli/vignettes/benchmarks.html
- zlib 1.2.11 Manual https://www.zlib.net/manual.html
- ZIP File Format Specification https://pkware.cachefly.net/webdocs/APPNOTE/APPNOTE-6.2.0.txt
- zlib port to javascript, very fast! https://www.npmjs.com/package/pako
- Premier Press - Data Structures For Game Programmers CH21 Data Compression
- Springer - David Salomon - Data Compression 4th Edition
- A painless guide to crc error detection algorithms http://www.zlib.net/crc_v3.txt
- æ–‡ä»¶å‹ç¼©åŒ… https://www.npmjs.com/package/archiver
- å‹ç¼©ç®—æ³• Brotli https://github.com/google/brotli

Node çš„å‹ç¼©æ¨¡å—åŸºäº zlib å·¥ä¸šåº“ï¼Œç®—æ³•æœ‰ Gzip, Deflate/Inflate, Brotliï¼Œæ•°æ®å¤„ç†åŸºäº Streams APIï¼Œä¸»è¦æ˜¯ zlib Transform ç±»å‹ã€‚

Deflate æ˜¯ä¸€ä¸ªæ— ä¸“åˆ©çš„å‹ç¼©ç®—æ³•ï¼Œå®ƒå¯ä»¥å®ç°æ— æŸæ•°æ®å‹ç¼©ï¼Œæœ‰ä¼—å¤šå¼€æºçš„å®ç°ç®—æ³•ã€‚

Gzip åŸºäº Deflate ç®—æ³•ï¼Œå®ƒæ˜¯ LZ77 ä¸éœå¤«æ›¼ç¼–ç çš„ç»„åˆï¼Œæœ€æ—©ç”¨äº UNIX ç³»ç»Ÿçš„æ–‡ä»¶å‹ç¼©ã€‚

Brotli å‹ç¼©ç®—æ³•æ˜¯ Google åœ¨ 2015 å¹´ 9 æœˆæ¨å‡ºçš„æ— æŸå‹ç¼©ç®—æ³•ï¼Œé€šè¿‡å˜ç§çš„ LZ77 ç®—æ³•ã€Huffman ç¼–ç ä»¥åŠäºŒé˜¶æ–‡æœ¬å»ºæ¨¡ç­‰æ–¹å¼è¿›è¡Œæ•°æ®å‹ç¼©ï¼Œä¸å…¶ä»–å‹ç¼©ç®—æ³•ç›¸æ¯”ï¼Œå®ƒæœ‰ç€æ›´é«˜çš„å‹ç¼©æ•ˆç‡ã€‚

Brotli å‹ç¼©ç®—æ³•å…·æœ‰å¤šä¸ªç‰¹ç‚¹ï¼š

- é’ˆå¯¹å¸¸è§çš„ Web èµ„æºå†…å®¹ï¼ŒBrotli çš„æ€§èƒ½ç›¸æ¯” Gzip æé«˜äº† 17-25%ï¼›
- å½“ Brotli å‹ç¼©çº§åˆ«ä¸º 1 æ—¶ï¼Œå‹ç¼©ç‡æ¯” Gzip æœ€é«˜å‹ç¼©ç­‰çº§ 9 è¿˜è¦é«˜ï¼›
- åœ¨å¤„ç†ä¸åŒ HTML æ–‡æ¡£æ—¶ï¼ŒBrotli ä¾ç„¶èƒ½å¤Ÿæä¾›éå¸¸é«˜çš„å‹ç¼©ç‡ã€‚
- åœ¨å‹ç¼©é€Ÿåº¦ä¸Šè·Ÿ Deflate å·®ä¸å¤šï¼Œä½†æ˜¯æä¾›äº†æ›´å¯†é›†çš„å‹ç¼©ã€‚

ä»¥ä¸‹ä¸€ä»½æµ‹è¯•æ¥è‡ª 2013 Apple MacBook Pro OSX 10.10.5 16GB 1600 MHz DDR3 2.7 GHz Core i7 4-Core with HyperThreading.

    |  å‹ç¼©ç®—æ³• | Requests/s | é€Ÿåº¦ (MB/s) | Max RSS (MB) | Avg. Latency (ms) |
    |-----------|------------|-------------|--------------|-------------------|
    | br-stream |        203 |        0.25 |      3485.54 |            462.57 |
    | lzma      |        233 |        0.37 |       330.29 |            407.71 |
    | gzip      |       2276 |        3.44 |       204.29 |             41.86 |
    | none      |       4061 |       14.06 |        125.1 |             23.45 |
    | br-static |       4087 |        5.85 |       105.58 |              23.3 |

RSS - Resident Set Size è¡¨ç¤ºè¯¥è¿›ç¨‹æ‰€å ç‰©ç†å†…å­˜çš„å¤§å°ã€‚


ç¤ºèŒƒè¿”å›å‹ç¼©æ•°æ®ç»™å®¢æˆ·ç«¯ï¼š

```
var http = require('http');
var fs = require('fs');
var zlib = require("zlib");

http.createServer(function(req, res){
  let ae = req.headers['accept-encoding'];
  let isZip = ae && ae.indexOf('gzip')>=0;
  var stream = fs.createReadStream(__filename);
  if(isZip || true){
    res.writeHead(200, {
            'Content-Length': '406',
            'Content-Encoding': 'gzip',
      'Content-Type': 'text/html', // application/x-gzip
        });
    var gzip = zlib.createGzip();
    stream.pipe(gzip).pipe(res, true);
    // res.end(zlib.gzipSync(fs.readFileSync(__filename)));
    // var gz = fs.createWriteStream(__filename+'.gz');
    // stream.pipe(gzip).pipe(gz, true);
  }else{
    stream.pipe(res, true);
  }
})
.on('error', err => console.log)
.listen(3000);
```

é…åˆ pipeline ç®¡é“åŒ–å¤„ç†æ–‡ä»¶çš„å‹ç¼©æµç¨‹ï¼š

```
const { createGzip } = require('zlib');
const { pipeline } = require('stream');
const { createReadStream, createWriteStream } = require('fs');

const gzip = createGzip();
const source = createReadStream(__filename);
const destination = createWriteStream(__filename+'.gz');

pipeline(source, gzip, destination, (err) => {
  if (err) {
    console.error('An error occurred:', err);
    process.exitCode = 1;
  }
});

// Or, Promisified

const { promisify } = require('util');
const pipe = promisify(pipeline);

async function do_gzip(input, output) {
  const gzip = createGzip();
  const source = createReadStream(input);
  const destination = createWriteStream(output);
  await pipe(source, gzip, destination);
}

do_gzip(__filename, __filename+'.gz')
  .catch((err) => {
    console.error('An error occurred:', err);
    process.exitCode = 1;
  });
```

æ‰€æœ‰ zlib API éƒ½ç”¨åœ¨å†…éƒ¨çš„çº¿ç¨‹æ± ä¸­ï¼Œé™¤äº†æ˜¾å¼åŒæ­¥çš„ï¼Œä½¿ç”¨ä¸å½“å¯èƒ½å¯¼è‡´ä¸¥é‡æ€§èƒ½é—®é¢˜ã€‚

å¦‚ä¸‹ï¼ŒåŒæ­¥åœ°å®ä¾‹åŒ–å¤šä¸ª zlib å°†å¯¼è‡´å¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼š

```
const zlib = require('zlib');

const payload = Buffer.from('This is some data');

// WARNING: DO NOT DO THIS!
for (let i = 0; i < 30000; ++i) {
  zlib.deflate(payload, (err, buffer) => {});
}
```

å¼ºçƒˆå»ºè®®ç¼“å­˜å‹ç¼©æ“ä½œçš„ç»“æœï¼Œä»¥é¿å…é‡å¤å·¥ä½œã€‚

éœ€è¦ zip å‹ç¼©åŒ…å¤„ç†åŠŸèƒ½ï¼Œå¯ä»¥å€ŸåŠ©ç°æˆçš„ archiver æ¨¡å—è¿›è¡Œæ‰“åŒ…æˆ–è§£åŒ…ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œæ ¹æ® zip æ–‡ä»¶æ ¼å¼è§„èŒƒå®ç°ã€‚

```
const fs = require('fs');
const archiver = require('archiver');

const output = fs.createWriteStream(__dirname + '/../example.zip');
const archive = archiver('zip', {
  zlib: { level: 9 } // Sets the compression level.
});

output.on('close', function() {
  console.log(archive.pointer() + ' total bytes');
  console.log('archiver has been finalized and the output file descriptor has closed.');
});

// @see: https://nodejs.org/api/stream.html#stream_event_end
output.on('end', function() {
  console.log('Data has been drained');
});

// good practice to catch warnings (ie stat failures and other non-blocking errors)
archive.on('warning', function(err) {
  if (err.code === 'ENOENT') {
    // log warning
  } else {
    // throw error
    throw err;
  }
});

// good practice to catch this error explicitly
archive.on('error', function(err) {
  throw err;
});

// pipe archive data to the file
archive.pipe(output);

// append a file from stream
const file1 = __dirname + '/demo.js';
archive.append(fs.createReadStream(file1), { name: 'demo.md' });

archive.append('append a file from string!', { name: 'string.txt' });

const buffer3 = Buffer.from('append a file from buffer!');
archive.append(buffer3, { name: 'buffer.txt' });

archive.file(__filename, { name: "src/archive.js" });

// append files from a sub-directory and naming it `subdir` within the archive
archive.directory('node/', 'subdir');

// append files from a sub-directory, putting its contents at the root of archive
archive.directory("src/", false);

// append files from a glob pattern
archive.glob('*.js', {cwd: __dirname});

// finalize the archive (ie we are done appending files but streams have to finish yet)
// 'close', 'end' or 'finish' may be fired right after calling 
// this method so register to them beforehand
archive.finalize();
```



Zlib å¸¸é‡å‚è€ƒ

- Allowed flush values.

    - zlib.constants.Z_NO_FLUSH
    - zlib.constants.Z_PARTIAL_FLUSH
    - zlib.constants.Z_SYNC_FLUSH
    - zlib.constants.Z_FULL_FLUSH
    - zlib.constants.Z_FINISH
    - zlib.constants.Z_BLOCK
    - zlib.constants.Z_TREES

- Return codes, negative values are errors.

    - zlib.constants.Z_OK
    - zlib.constants.Z_STREAM_END
    - zlib.constants.Z_NEED_DICT
    - zlib.constants.Z_ERRNO
    - zlib.constants.Z_STREAM_ERROR
    - zlib.constants.Z_DATA_ERROR
    - zlib.constants.Z_MEM_ERROR
    - zlib.constants.Z_BUF_ERROR
    - zlib.constants.Z_VERSION_ERROR

- Compression levels.

    - zlib.constants.Z_NO_COMPRESSION
    - zlib.constants.Z_BEST_SPEED
    - zlib.constants.Z_BEST_COMPRESSION
    - zlib.constants.Z_DEFAULT_COMPRESSION

- Compression strategy.

    - zlib.constants.Z_FILTERED
    - zlib.constants.Z_HUFFMAN_ONLY
    - zlib.constants.Z_RLE
    - zlib.constants.Z_FIXED
    - zlib.constants.Z_DEFAULT_STRATEGY

Brotli constants

- Flush operations 

    - zlib.constants.BROTLI_OPERATION_PROCESS (default for all operations)
    - zlib.constants.BROTLI_OPERATION_FLUSH (default when calling .flush())
    - zlib.constants.BROTLI_OPERATION_FINISH (default for the last chunk)
    - zlib.constants.BROTLI_OPERATION_EMIT_METADATA

- Compressor options

    - `BROTLI_PARAM_MODE`
        - `BROTLI_MODE_GENERIC` (default)
        - `BROTLI_MODE_TEXT`, adjusted for UTF-8 text
        - `BROTLI_MODE_FONT`, adjusted for WOFF 2.0 fonts
    - `BROTLI_PARAM_QUALITY` Ranges from `BROTLI_MIN_QUALITY` to `BROTLI_MAX_QUALITY`, with a default of `BROTLI_DEFAULT_QUALITY`.
    - `BROTLI_PARAM_SIZE_HINT` æœŸå¾…è¾“å…¥å¤§å°ï¼ŒæœªçŸ¥è¾“å…¥é»˜è®¤å€¼ä¸º 0ã€‚

- Advanced compression options:

    - `BROTLI_PARAM_LGWIN` è®¾ç½® Large Window Brotli å¤§å° é»˜è®¤å€¼ `BROTLI_DEFAULT_WINDOW`ã€‚
        - `BROTLI_MIN_WINDOW_BITS` æœ€å°å€¼ï¼›
        - `BROTLI_MAX_WINDOW_BITS` æœ€å¤§å€¼ï¼›
        - `BROTLI_LARGE_MAX_WINDOW_BITS` æå¤§å€¼ï¼Œåœ¨å¯ç”¨ `BROTLI_PARAM_LARGE_WINDOW` æ ‡å¿—æ—¶ä½¿ç”¨ã€‚
    - `BROTLI_PARAM_LGBLOCK` Ranges from `BROTLI_MIN_INPUT_BLOCK_BITS` to `BROTLI_MAX_INPUT_BLOCK_BITS`.
    - `BROTLI_PARAM_DISABLE_LITERAL_CONTEXT_MODELING` æ˜¯å¦é™ä½å‹ç¼©æ¯”ä»¥æé«˜è§£å‹ç¼©é€Ÿåº¦ã€‚
    - `BROTLI_PARAM_LARGE_WINDOW` æ˜¯å¦å¯ç”¨ Large Window Brotliï¼Œä¸ RFC 7932 æ ‡å‡†æ ¼å¼ä¸å…¼å®¹ã€‚
    - `BROTLI_PARAM_NPOSTFIX` Ranges from 0 to `BROTLI_MAX_NPOSTFIX`.
    - `BROTLI_PARAM_NDIRECT` Ranges from 0 to `15 << NPOSTFIX` in steps of `1 << NPOSTFIX`.

- Decompressor options

    - `BROTLI_DECODER_PARAM_DISABLE_RING_BUFFER_REALLOCATION` å½±å“å†…éƒ¨å†…å­˜åˆ†é…æ¨¡å¼çš„å¸ƒå°”æ ‡å¿—ã€‚
    - `BROTLI_DECODER_PARAM_LARGE_WINDOW` æ˜¯å¦å¯ç”¨ Large Window Brotliï¼Œä¸ RFC 7932 æ ‡å‡†æ ¼å¼ä¸å…¼å®¹ã€‚


Zlib API å‚è€ƒ

- Class: Options
- Class: BrotliOptions
- Class: zlib.BrotliCompress
- Class: zlib.BrotliDecompress
- Class: zlib.Deflate
- Class: zlib.DeflateRaw
- Class: zlib.Gunzip
- Class: zlib.Gzip
- Class: zlib.Inflate
- Class: zlib.InflateRaw
- Class: zlib.Unzip
- Class: zlib.ZlibBase
- Static
    - zlib.bytesRead
    - zlib.bytesWritten
    - zlib.close([callback])
    - zlib.flush([kind, ]callback)
    - zlib.params(level, strategy, callback)
    - zlib.reset()
    - zlib.constants
    - zlib.createBrotliCompress([options])
    - zlib.createBrotliDecompress([options])
    - zlib.createDeflate([options])
    - zlib.createDeflateRaw([options])
    - zlib.createGunzip([options])
    - zlib.createGzip([options])
    - zlib.createInflate([options])
    - zlib.createInflateRaw([options])
    - zlib.createUnzip([options])
    - zlib.brotliCompress(buffer[, options], callback)
    - zlib.brotliCompressSync(buffer[, options])
    - zlib.brotliDecompress(buffer[, options], callback)
    - zlib.brotliDecompressSync(buffer[, options])
    - zlib.deflate(buffer[, options], callback)
    - zlib.deflateSync(buffer[, options])
    - zlib.deflateRaw(buffer[, options], callback)
    - zlib.deflateRawSync(buffer[, options])
    - zlib.gunzip(buffer[, options], callback)
    - zlib.gunzipSync(buffer[, options])
    - zlib.gzip(buffer[, options], callback)
    - zlib.gzipSync(buffer[, options])
    - zlib.inflate(buffer[, options], callback)
    - zlib.inflateSync(buffer[, options])
    - zlib.inflateRaw(buffer[, options], callback)
    - zlib.inflateRawSync(buffer[, options])
    - zlib.unzip(buffer[, options], callback)
    - zlib.unzipSync(buffer[, options])


# ğŸš© File System æ–‡ä»¶ç³»ç»Ÿ
[File System](https://nodejs.org/docs/latest-v9.x/api/fs.html)
- https://nodejs.org/docs/latest-v12.x/api/cli.html#cli_uv_threadpool_size_size
- https://nodejs.org/en/docs/guides/working-with-different-filesystems/

æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿ API å¯èƒ½äº§ç”Ÿè´Ÿé¢æ€§èƒ½å½±å“ï¼Œé™¤äº† fs.FSWatcher() å’Œé‚£äº›æ˜¾å¼åŒæ­¥çš„ä½¿ç”¨ libuv çº¿ç¨‹æ± ã€‚

æ–‡ä»¶è·¯å¾„å¯ä»¥ç›´æ¥ä½¿ç”¨å­—ç¬¦è¡¨ç¤ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ URL å¯¹è±¡ï¼š

    const fs = require('fs');
    const fileUrl = new URL('file:///tmp/hello');

    fs.readFileSync(fileUrl);

Promise example

    const fs = require('fs').promises;

    (async function(path) {
      try {
        await fs.unlink(path);
        console.log(`successfully deleted ${path}`);
      } catch (error) {
        console.error('there was an error:', error.message);
      }
    })('/tmp/hello');



ç›®å½•æ‹·è´ç¤ºèŒƒï¼š

    var fs = require('fs');
    var path = require('path');

    function copyFileSync( source, target ) {

        var targetFile = target;

        // If target is a directory, a new file with the same name will be created
        if ( fs.existsSync( target ) ) {
            if ( fs.lstatSync( target ).isDirectory() ) {
                targetFile = path.join( target, path.basename( source ) );
            }
        }

        fs.writeFileSync(targetFile, fs.readFileSync(source));
    }

    function copyFolderRecursiveSync( source, target ) {
        var files = [];

        // Check if folder needs to be created or integrated
        var targetFolder = path.join( target, path.basename( source ) );
        if ( !fs.existsSync( targetFolder ) ) {
            fs.mkdirSync( targetFolder );
        }

        // Copy
        if ( fs.lstatSync( source ).isDirectory() ) {
            files = fs.readdirSync( source );
            files.forEach( function ( file ) {
                var curSource = path.join( source, file );
                if ( fs.lstatSync( curSource ).isDirectory() ) {
                    copyFolderRecursiveSync( curSource, targetFolder );
                } else {
                    copyFileSync( curSource, targetFolder );
                }
            } );
        }
    }

æ–‡ä»¶è¯»å†™

    var path = require('path');
    var fs = require('fs');

    var _path = path.join(__dirname, '\\', 'record.txt');
    var path1 = "e:\\coding\\electron\\record.txt";
    // console.log( ["PATH:",_path, path1]);

    fs.readFile(_path, 'utf8', function (err, data) {
        if (err) return console.log(err);
    });

    fs.writeFile(_path, "electron + Javascript "+(new Date()), function (err) {
        if (!err) console.log("file write done!")
    })


## File Descriptors

æ–‡ä»¶æè¿°ç¬¦åŒ…å«æ–‡ä»¶ç›¸å…³ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ä½¿ç”¨ stat å‘½ä»¤è·å–ï¼Œå¦‚ï¼š

    stats: {
      "dev": 2,
      "mode": 16877,
      "nlink": 1,  æŒ‡ inode è¢«å¼•ç”¨æ¬¡æ•°
      "uid": 1000,
      "gid": 1000,
      "rdev": 0,
      "blksize": 4096,
      "ino": 562949959402140,
      "size": 4096,
      "blocks": 0,
      "atimeMs": 1614539247544.6877,
      "mtimeMs": 1614539247623.6729,
      "ctimeMs": 1614539247623.6729,
      "birthtimeMs": 1614539247623.6729,
      "atime": "2021-02-28T19:07:27.545Z",
      "mtime": "2021-02-28T19:07:27.624Z",
      "ctime": "2021-02-28T19:07:27.624Z",
      "birthtime": "2021-02-28T19:07:27.624Z"
    }

æ–‡ä»¶æ—¶é—´ç›¸å…³çš„å±æ€§æœ‰å››ä¸ªï¼ŒåŠ  Ms åç¼€çš„è¡¨ç¤ºä½¿ç”¨æ¯«ç§’å•ä½ï¼š

- `atime` "Access Time" æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œæ‰§è¡Œ mknod(2), utimes(2), read(2) ç³»ç»Ÿè°ƒç”¨æ—¶ä¿®æ”¹ã€‚
- `mtime` "Modified Time" æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ï¼Œæ‰§è¡Œ mknod(2), utimes(2), write(2) ç³»ç»Ÿè°ƒç”¨æ—¶ä¿®æ”¹ã€‚
- `ctime` "Change Time" æœ€åä¸€æ¬¡å˜æ›´çš„æ—¶é—´ï¼Œinode æ•°æ®ä¿®æ”¹ï¼Œæ‰§è¡Œ chmod(2), chown(2), link(2), mknod(2), rename(2), unlink(2), utimes(2), read(2), write(2) ç³»ç»Ÿè°ƒç”¨æ—¶ä¿®æ”¹ã€‚
- `birthtime` "Birth Time" æ–‡ä»¶åˆ›å»ºæ—¶é—´ã€‚å¯¹äºä¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½ä½¿ç”¨ ctime æˆ– 1970-01-01T00:00Z (ie, Unix epoch timestamp 0)ã€‚


ç¤ºèŒƒä½¿ç”¨ä»¥ä¸‹ API è·å–æ–‡ä»¶æè¿°ç¬¦ File descriptorsï¼š

- fs.fstat( fd, callback )
- fs.fstatSync( fd )
- fs.lstat( path, callback )
- fs.lstatSync( path )
- fs.stat( path, callback )
- fs.statSync( path )

- Class: fs.Stats
    - fs.stats.isBlockDevice()
    - fs.stats.isCharacterDevice()
    - fs.stats.isDirectory()
    - fs.stats.isFIFO()
    - fs.stats.isFile()
    - fs.stats.isSocket()
    - fs.stats.isSymbolicLink()
    - fs.stats.dev
    - fs.stats.ino
    - fs.stats.mode
    - fs.stats.nlink
    - fs.stats.uid
    - fs.stats.gid
    - fs.stats.rdev
    - fs.stats.size
    - fs.stats.blksize
    - fs.stats.blocks
    - fs.stats.atimeMs
    - fs.stats.mtimeMs
    - fs.stats.ctimeMs
    - fs.stats.birthtimeMs
    - fs.stats.atime
    - fs.stats.mtime
    - fs.stats.ctime
    - fs.stats.birthtime


ç¤ºèŒƒï¼š

    const fs = require("fs");

    fs.stat('public', (err, stats) => {
      if (err) throw err;
      console.log(`stats: ${JSON.stringify(stats, null, "  ")}`);
    });

    fs.open('public', fs.constants.O_RDONLY, (err, fd) => {
      if (err) throw err;
      fs.fstat(fd, (err, stats) => {
        if (err) throw err;
        console.log(`stats: ${JSON.stringify(stats, null, "  ")}`);
      });
      // always close the file descriptor!
      fs.close(fd, (err) => {
        if (err) throw err;
      });
    });

ä½œä¸ºç®€åŒ–è¡¨è¾¾ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ 'r' æ›¿ä»£ fs.constants.O_RDONLYã€‚

    const fs = require("fs");

    fs.rename('/tmp/hello', '/tmp/world', (err) => {
      if (err) throw err;
      fs.stat('/tmp/world', (err, stats) => {
        if (err) throw err;
        console.log(`stats: ${JSON.stringify(stats)}`);
      });
    });

    thumb = 'C:/pictures/thumb';
    fs.open(thumb, 'r', (err, fd) => {
      if (err) throw err;
      fs.fstat(fd, (err, stat) => {
        if (err) throw err;
        // use stat
        if(stat.isDirectory()) {
            fs.readdir(thumb, "", (err, list) => {
                console.log(`stats: ${JSON.stringify(list, null, "    ")}`);
                pre = 1;
                for (var i = list.length - 1; i >= 0; i--) {
                    cur = parseInt(list[list.length-i]);
                    if(cur>pre+1){
                        for(var j = pre + 1; j<cur; j++){
                            console.log("curl -O ", j);
                        }
                    }
                    pre = cur;
                }
            });
        }

        // always close the file descriptor!
        fs.close(fd, (err) => {
          if (err) throw err;
        });
      });
    });

See https://nodejs.org/api/fs.html#fs_fs_copyfilesync_src_dest_flags)


## Class: fs.Dir & fs.Dirent

ç›®å½•æµå¯¹è±¡ï¼Œä½¿ç”¨ Promise.opendir() è¿”å›çš„æ˜¯å¯ä»¥æšä¸¾çš„é’±åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ Direntï¼Œå³ Directory Entryï¼Œä½¿ç”¨ä»¥ä¸‹ API åˆ›å»ºï¼š

- fs.opendir()
- fs.opendirSync()
- fsPromises.opendir()

ç¤ºèŒƒï¼š

    const fs = require('fs');

    async function print(path) {
      const dir = await fs.promises.opendir(path);
      for await (const dirent of dir) {
        console.log(dirent.name);
      }
    }
    print('./').catch(console.error);

åŒæ­¥ API æ–¹å¼ï¼š

    const fs = require('fs');

    const dir = fs.opendirSync('public')
    while( ent = dir.readSync() ) console.log(ent.name)
    dir.close()

API å‚è€ƒï¼š

- Class: fs.Dirent

    - dir.close()
    - dir.close(callback)
    - dir.closeSync()
    - dir.path
    - dir.read()
    - dir.read(callback)
    - dir.readSync()
    - dir[Symbol.asyncIterator]()

- Class: fs.Dirent

    - dirent.isBlockDevice()
    - dirent.isCharacterDevice()
    - dirent.isDirectory()
    - dirent.isFIFO()
    - dirent.isFile()
    - dirent.isSocket()
    - dirent.isSymbolicLink()
    - dirent.name

## Class: fs.ReadStream & fs.WriteStream
- https://nodejs.org/docs/latest-v12.x/api/stream.html#stream_class_stream_writable
- https://nodejs.org/docs/latest-v12.x/api/fs.html#fs_class_fs_writestream

ReadStream å’Œ WriteStream åˆ†åˆ«æ˜¯ stream.Readableï¼Œstream.Writable å­ç±»ã€‚

ç®¡é“ pipe å®ç°å¤§é‡æ•°æ®çš„æµè¯»å†™

    /**
     * destination å¿…é¡»ä¸€ä¸ªå¯å†™å…¥æµæ•°æ®å¯¹è±¡
     * [opations] end é»˜è®¤ä¸ºtrueï¼Œè¡¨ç¤ºè¯»å–å®Œæˆç«‹å³å…³é—­æ–‡ä»¶ï¼›
     */

    var rs = fs.createReadStream(__dirname + '/test/Until You.mp3');
    var ws = fs.createWriteStream(__dirname + '/test/untiyou.mp3');
    rs.pipe(ws);
    rs.on('data', function (data) {
      console.log('æ•°æ®å¯è¯»')
    });
    rs.on('end', function () {
      console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
      //ws.end('å†è§')
    });

API å‚è€ƒï¼š

- Class: fs.ReadStream
    - Event: close()
    - Event: open( fd )
    - readStream.bytesRead
    - readStream.path

- Class: fs.WriteStream
    - Event: close()
    - Event: open( fd )
    - writeStream.bytesWritten
    - writeStream.path

ç›¸å…³ APIï¼š

- fs.createReadStream( path[, options] )
- fs.createWriteStream( path[, options] )


## fs API

- fs.constants åŒ…å«å„ç§å¸¸é‡

- fs.access( path[, mode], callback )
- fs.accessSync( path[, mode] )
- fs.appendFile( file, data[, options], callback )
- fs.appendFileSync( file, data[, options] )
- fs.chmod( path, mode, callback )
- fs.chmodSync( path, mode )
- fs.chown( path, uid, gid, callback )
- fs.chownSync( path, uid, gid )
- fs.close( fd, callback )
- fs.closeSync( fd )
- fs.copyFile( src, dest[, flags], callback )
- fs.copyFileSync( src, dest[, flags] )
- fs.createReadStream( path[, options] )
- fs.createWriteStream( path[, options] )
- fs.exists( path, callback )
- fs.existsSync( path )
- fs.fchmod( fd, mode, callback )
- fs.fchmodSync( fd, mode )
- fs.fchown( fd, uid, gid, callback )
- fs.fchownSync( fd, uid, gid )
- fs.fdatasync( fd, callback )
- fs.fdatasyncSync( fd )
- fs.fstat( fd, callback )
- fs.fstatSync( fd )
- fs.fsync( fd, callback )
- fs.fsyncSync( fd )
- fs.ftruncate( fd[, len], callback )
- fs.ftruncateSync( fd[, len] )
- fs.futimes( fd, atime, mtime, callback )
- fs.futimesSync( fd, atime, mtime )
- fs.lchmod( path, mode, callback )
- fs.lchmodSync( path, mode )
- fs.lchown( path, uid, gid, callback )
- fs.lchownSync( path, uid, gid )
- fs.link( existingPath, newPath, callback )
- fs.linkSync( existingPath, newPath )
- fs.lstat( path, callback )
- fs.lstatSync( path )
- fs.mkdir( path[, mode], callback )
- fs.mkdirSync( path[, mode] )
- fs.mkdtemp( prefix[, options], callback )
- fs.mkdtempSync( prefix[, options] )
- fs.open( path, flags[, mode], callback )
- fs.openSync( path, flags[, mode] )
- fs.read( fd, buffer, offset, length, position, callback )
- fs.readdir( path[, options], callback )
- fs.readdirSync( path[, options] )
- fs.readFile( path[, options], callback )
- fs.readFileSync( path[, options] )
- fs.readlink( path[, options], callback )
- fs.readlinkSync( path[, options] )
- fs.readSync( fd, buffer, offset, length, position )
- fs.realpath( path[, options], callback )
- fs.realpath. native(path[, options], callback )
- fs.realpathSync( path[, options] )
- fs.realpathSync. native(path[, options] )
- fs.rename( oldPath, newPath, callback )
- fs.renameSync( oldPath, newPath )
- fs.rmdir( path, callback )
- fs.rmdirSync( path )
- fs.stat( path, callback )
- fs.statSync( path )
- fs.symlink( target, path[, type], callback )
- fs.symlinkSync( target, path[, type] )
- fs.truncate( path[, len], callback )
- fs.truncateSync( path[, len] )
- fs.unlink( path, callback )
- fs.unlinkSync( path )
- fs.unwatchFile( filename[, listener] )
- fs.utimes( path, atime, mtime, callback )
- fs.utimesSync( path, atime, mtime )
- fs.watch( filename[, options][, listener] )
- fs.watchFile( filename[, options], listener )
- fs.write( fd, buffer[, offset[, length[, position]]], callback )
- fs.write( fd, string[, position[, encoding]], callback )
- fs.writeFile( file, data[, options], callback )
- fs.writeFileSync( file, data[, options] )
- fs.writeSync( fd, buffer[, offset[, length[, position]]] )
- fs.writeSync( fd, string[, position[, encoding]] )


## fs Promises API

Node v10.0.0 æ·»åŠ äº† fs.promises æä¾›ä¸€ç»„ä½¿ç”¨ Promise æ›¿ä»£å›è°ƒå‡½æ•°æ–¹å¼çš„å¼‚æ­¥æ–‡ä»¶å¤„ç† APIã€‚

    require('fs').promises

FileHandle å®ä¾‹ç”± fsPromises.open() æ–¹æ³•åˆ›å»ºï¼ŒA FileHandle object is a wrapper for a numeric file descriptor. Instances of FileHandle are distinct from numeric file descriptors in that they provide an object oriented API for working with files.ã€‚

ä¸å›è°ƒå¼ API ä¸åŒï¼Œå¦‚ fs.fstat(), fs.fchown(), fs.fchmod()ï¼Œæ–‡ä»¶æè¿°ç¬¦ FD æ˜¯ä¸éœ€è¦çš„ï¼Œæ›¿ä»£ä½¿ç”¨çš„æ˜¯ FileHandle å¯¹è±¡ï¼Œå®ƒåŒ…è£…äº† FDï¼Œåœ¨ Promise å¤„äº resolved æˆ– rejected çŠ¶æ€æ—¶å®ç°è‡ªåŠ¨å…³é—­ FDï¼Œä»¥å…æ„å¤–çš„æœªå…³é—­ FD å¯¼è‡´èµ„æºæ³„éœ²ã€‚

ä¸è¦ä¾èµ–æ­¤è¡Œä¸ºï¼Œå› ä¸ºå®ƒä¸å¯é ï¼Œå¹¶ä¸”æ–‡ä»¶å¯èƒ½æœªå…³é—­ã€‚ç›¸åï¼Œæ˜¾å¼å…³é—­æ–‡ä»¶å¥æŸ„æ˜¯å¯é çš„ã€‚

ç¤ºèŒƒä½¿ç”¨ `access(path)` æµ‹è¯•æ–‡ä»¶çš„å¯è®¿é—®æ€§ï¼š

    const fs = require('fs');
    const fsPromises = fs.promises;

    fsPromises.access('/etc/passwd', fs.constants.R_OK | fs.constants.W_OK)
      .then(() => console.log('can access'))
      .catch(() => console.error('cannot access'));

Class: FileHandle API å‚è€ƒï¼š

- filehandle.fd

- filehandle.appendFile(data, options)
- filehandle.chmod(mode)
- filehandle.chown(uid, gid)
- filehandle.close()
- filehandle.datasync()
- filehandle.read(buffer, offset, length, position)
- filehandle.read(options)
- filehandle.readFile(options)
- filehandle.readv(buffers[, position])
- filehandle.stat([options])
- filehandle.sync()
- filehandle.truncate(len)
- filehandle.utimes(atime, mtime)
- filehandle.write(buffer[, offset[, length[, position]]])
- filehandle.write(string[, position[, encoding]])
- filehandle.writeFile(data, options)
- filehandle.writev(buffers[, position])

fs.promises API å‚è€ƒï¼š

- fsPromises.access(path[, mode])
- fsPromises.appendFile(path, data[, options])
- fsPromises.chmod(path, mode)
- fsPromises.chown(path, uid, gid)
- fsPromises.copyFile(src, dest[, flags])
- fsPromises.lchmod(path, mode)
- fsPromises.lchown(path, uid, gid)
- fsPromises.lutimes(path, atime, mtime)
- fsPromises.link(existingPath, newPath)
- fsPromises.lstat(path[, options])
- fsPromises.mkdir(path[, options])
- fsPromises.mkdtemp(prefix[, options])
- fsPromises.open(path, flags[, mode])
- fsPromises.opendir(path[, options])
- fsPromises.readdir(path[, options])
- fsPromises.readFile(path[, options])
- fsPromises.readlink(path[, options])
- fsPromises.realpath(path[, options])
- fsPromises.rename(oldPath, newPath)
- fsPromises.rmdir(path[, options])
- fsPromises.stat(path[, options])
- fsPromises.symlink(target, path[, type])
- fsPromises.truncate(path[, len])
- fsPromises.unlink(path)
- fsPromises.utimes(path, atime, mtime)
- fsPromises.writeFile(file, data[, options])


## Watch File æ–‡ä»¶ç›‘å¬

æ–‡ä»¶ç›‘å¬ç›¸å…³ APIï¼š

- fs.unwatchFile(filename[, listener])
- fs.watch(filename[, options][, listener]): FSWatcher
- fs.watchFile(filename[, options], listener): StatWatcher

- Class: fs.FSWatcher
    - Event: change( eventType, filename )
    - Event: error( error )
    - Event: close()
    - watcher.close()
    - watcher.ref(): FSWatcher
    - watcher.unref(): FSWatcher

- Class: fs.StatWatcher
    - watcher.ref(): StatWatcher
    - watcher.unref(): StatWatcher

æ³¨æ„ fs.watch API å¹¶ä¸æ˜¯ 100% å·¥ä½œäºæ‰€æœ‰å¹³å°ã€‚

å…¶ä¸­ recursive é€‰é¡¹åªå¯¹ macOS å’Œ Windows æœ‰æ•ˆã€‚

æ ¹æ®ä¸åŒç³»ç»Ÿçš„ filesystem å˜æ›´äº‹ä»¶ï¼Œå¦‚ä»€ä¹ˆå¯¼è‡´åŠŸèƒ½å¤±æ•ˆç›‘å¬å°±ä¼šå¤±è´¥ï¼š

- Linux ç³»ç»Ÿä½¿ç”¨ inotify
- BSD ç³»ç»Ÿä½¿ç”¨ kqueue
- macOS åˆ†åˆ«ä½¿ç”¨ kqueue å’Œ FSEventsfor å¯¹åº”ç›‘å¬æ–‡ä»¶å’Œç›®å½•
- SunOS ç³»ç»ŸåŒ…æ‹¬ Solaris SmartOS ä½¿ç”¨ event ports
- Windows ç³»ç»Ÿä½¿ç”¨ ReadDirectoryChangesW API
- Aix ç³»ç»Ÿä¾èµ– AHAFS åŠŸèƒ½

æ¯”å¦‚ç›‘å¬ç½‘çº¿æ–‡ä»¶ç³»ç»Ÿ NFS, SMB ç­‰ï¼Œæˆ–è€… Vagrant, Docker ç­‰è™šæ‹ŸåŒ–çš„ä¸»æœºç³»ç»Ÿæ–‡ä»¶éƒ½æ˜¯ä¸å¯é çš„ã€‚

ä»ç„¶å¯ä»¥ä½¿ç”¨ fs.watchFile() æ¥è½®è¯¢æ–‡ä»¶çš„ stat ä¿¡æ¯ï¼Œä½†æ•ˆç‡ä¸é«˜ï¼Œä¹Ÿä¸å¤ªå¯é ã€‚

åœ¨ Linux å’Œ macOS ç³»ç»Ÿï¼Œfs.watch() è§£æ inode è·¯å¾„å¹¶ç›‘è§† inodeã€‚å¦‚æœå·²è§‚å¯Ÿåˆ°çš„è·¯å¾„è¢«åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼Œåˆ™ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°çš„ inodeã€‚è¯¥ç›‘è§†å°†ä¸ºåˆ é™¤å‘å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œä½†å°†ç»§ç»­ç›‘è§†åŸå§‹ inodeï¼Œè¿™å°†ä¸ä¼šå‘å‡ºæ–° inode çš„äº‹ä»¶ï¼Œè¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºã€‚

AIX ç³»ç»Ÿçš„æ–‡ä»¶åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ä¿ç•™ç›¸åŒçš„ inodeï¼Œä¿å­˜å’Œå…³é—­æ–‡ä»¶æ—¶ï¼Œå°†ç›‘å¬åˆ°ä¸¤ä¸ªé€šçŸ¥ï¼Œä¸€ä¸ªæ·»åŠ æ–°å†…å®¹ï¼Œå¦ä¸€ä¸ªç”¨äºæˆªæ–­ï¼Œadding & truncationã€‚

åªæœ‰ Linuxã€macOSã€Windows å’Œ AIX ç³»ç»Ÿæ”¯æŒåœ¨å›è°ƒä¸­æä¾›æ–‡ä»¶åå‚æ•°ï¼Œå³ä½¿åœ¨å—æ”¯æŒçš„å¹³å°ä¸Šï¼Œä¹Ÿä¸èƒ½ä¿è¯æ€»æ˜¯æä¾›æ–‡ä»¶åã€‚å› æ­¤ï¼Œä¸è¦å‡è®¾ filename å‚æ•°æ€»æ˜¯åœ¨å›è°ƒä¸­æä¾›çš„ï¼Œå¦‚æœå®ƒä¸º nullï¼Œåˆ™ä½¿ç”¨ä¸€äº›å›é€€é€»è¾‘ã€‚

Filename Argument ç¤ºèŒƒ

    fs.watch('somedir', (eventType, filename) => {
      console.log(`event type is: ${eventType}`);
      if (filename) {
        console.log(`filename provided: ${filename}`);
      } else {
        console.log('filename not provided');
      }
    });

## Inode æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹

ç†è§£ inodeï¼Œä¸ä»…æœ‰åŠ©äºæé«˜ç³»ç»Ÿæ“ä½œæ°´å¹³ï¼Œè¿˜æœ‰åŠ©äºä½“ä¼š Unix è®¾è®¡å“²å­¦ï¼Œå³å¦‚ä½•æŠŠåº•å±‚çš„å¤æ‚æ€§æŠ½è±¡æˆä¸€ä¸ªç®€å•æ¦‚å¿µï¼Œä»è€Œå¤§å¤§ç®€åŒ–ç”¨æˆ·æ¥å£ã€‚

ä»æ–‡ä»¶å‚¨å­˜æ¥ç†è§£ inodeï¼Œç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•ä½å«åšæ‰‡åŒº Sectorï¼Œèƒ½å‚¨å­˜ 512 å­—èŠ‚ã€‚

æ“ä½œç³»ç»Ÿè¯»å–ç¡¬ç›˜çš„æ—¶å€™ï¼Œä¸ä¼šä¸€ä¸ªä¸ªæ‰‡åŒºçš„è¯»å–ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§è¿ç»­è¯»å–å¤šä¸ªæ‰‡åŒºï¼Œå³ä¸€æ¬¡æ€§è¯»å–ä¸€ä¸ªå— blockï¼Œå—æ˜¯æ–‡ä»¶å­˜å–çš„æœ€å°å•ä½ã€‚æœ€å¸¸è§çš„å—çš„å¤§å°è®¾ç½®æ˜¯ 4KBï¼Œå³è¿ç»­çš„ 8 sectors ç»„æˆä¸€ä¸ª blockã€‚

è€Œä¸ºäº†ç®¡ç†æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶çš„åˆ›å»ºè€…ã€æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸã€æ–‡ä»¶çš„å¤§å°ç­‰ç­‰ï¼Œå¼•å…¥äº† Inode å³ç´¢å¼•èŠ‚ç‚¹ã€‚

æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ Inodeï¼Œä½¿ç”¨ stat å‘½ä»¤å¯ä»¥æŸ¥çœ‹ï¼š

    $ stat m4demo.m4 
      File: m4demo.m4
      Size: 244             Blocks: 0          IO Block: 4096   regular file
    Device: 2h/2d   Inode: 4785074605758679  Links: 1
    Access: (0666/-rw-rw-rw-)  Uid: ( 1000/  jeango)   Gid: ( 1000/  jeango)
    Access: 2020-08-03 02:14:04.412914100 +0800
    Modify: 2020-08-03 02:14:04.412914100 +0800
    Change: 2020-08-03 02:14:04.419913100 +0800
     Birth: -

inode ä¹Ÿä¼šæ¶ˆè€—ç¡¬ç›˜ç©ºé—´ï¼Œæ‰€ä»¥ç¡¬ç›˜æ ¼å¼åŒ–çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿè‡ªåŠ¨å°†ç¡¬ç›˜åˆ†æˆä¸¤ä¸ªåŒºåŸŸã€‚ä¸€ä¸ªæ˜¯å­˜æ”¾æ–‡ä»¶æ•°æ®åŒºåŸŸï¼Œå¦ä¸€ä¸ªæ˜¯ inode tableã€‚

æ¯ä¸ª inode èŠ‚ç‚¹çš„å¤§å°ä¸€èˆ¬æ˜¯ 128KB æˆ– 256KBï¼ŒèŠ‚ç‚¹çš„æ€»æ•°åœ¨æ ¼å¼åŒ–æ—¶å°±å›ºå®šï¼Œä¸€èˆ¬æ˜¯æ¯ 1KB æˆ–æ¯ 2KB å°±è®¾ç½®ä¸€ä¸ª inodeã€‚ä¸€å— 1GB çš„ç¡¬ç›˜ï¼Œå¦‚æœæ¯ä¸ª inode èŠ‚ç‚¹çš„å¤§å°ä¸º 128KBï¼Œæ¯ 1KB å°±è®¾ç½®ä¸€ä¸ª inodeï¼Œé‚£ä¹ˆ inode table çš„å¤§å°å°±ä¼šå  1/8 åˆ° 128MBã€‚å› æ­¤ï¼Œå¦‚æœä¿å­˜å¤§é‡å°æ–‡ä»¶ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿ inode å·²ç»ç”¨å…‰ï¼Œä½†æ˜¯ç¡¬ç›˜è¿˜æœªå­˜æ»¡çš„æƒ…å†µï¼Œè¿™æ—¶ï¼Œå°±æ— æ³•åœ¨ç¡¬ç›˜ä¸Šåˆ›å»ºæ–°æ–‡ä»¶ã€‚

æŸ¥çœ‹æ¯ä¸ªç¡¬ç›˜åˆ†åŒºçš„ inode æ€»æ•°å’Œå·²ç»ä½¿ç”¨çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨ df -i å‘½ä»¤ï¼ŒæŸ¥çœ‹ inode å·ç ä½¿ç”¨ ls -iã€‚

æŸ¥çœ‹æ¯ä¸ª inode èŠ‚ç‚¹çš„å¤§å°ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

    sudo dumpe2fs -h /dev/hda | grep "Inode size"

Unix/Linux ç³»ç»Ÿå†…éƒ¨ä¸ä½¿ç”¨æ–‡ä»¶åï¼Œè€Œä½¿ç”¨ inode å·ç æ¥è¯†åˆ«æ–‡ä»¶ã€‚å¯¹äºç³»ç»Ÿæ¥è¯´ï¼Œæ–‡ä»¶ååªæ˜¯ inode å·ç ä¾¿äºè¯†åˆ«çš„åˆ«ç§°æˆ–è€…ç»°å·ã€‚

å®é™…ä¸Šï¼Œç³»ç»Ÿå†…éƒ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶è¿™ä¸ªè¿‡ç¨‹åˆ†æˆä¸‰æ­¥ï¼š

- é¦–å…ˆï¼Œç³»ç»Ÿæ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶åå¯¹åº”çš„ inode å·ç ï¼›
- å…¶æ¬¡ï¼Œé€šè¿‡ inode å·ç ï¼Œè·å– inode ä¿¡æ¯ï¼›
- æœ€åï¼Œæ ¹æ® inode ä¿¡æ¯ï¼Œæ‰¾åˆ°æ–‡ä»¶æ•°æ®æ‰€åœ¨çš„ blockï¼Œè¯»å‡ºæ•°æ®ã€‚

ç”±äº inode å·ç ä¸æ–‡ä»¶ååˆ†ç¦»ï¼Œè¿™ç§æœºåˆ¶å¯¼è‡´äº†ä¸€äº› Unix/Linux ç³»ç»Ÿç‰¹æœ‰çš„ç°è±¡ã€‚

- æœ‰æ—¶ï¼Œæ–‡ä»¶ååŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œæ— æ³•æ­£å¸¸åˆ é™¤ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ inode èŠ‚ç‚¹èµ·åˆ°åˆ é™¤æ–‡ä»¶çš„ä½œç”¨ã€‚
- ç§»åŠ¨æ–‡ä»¶æˆ–é‡å‘½åæ–‡ä»¶ï¼Œåªæ˜¯æ”¹å˜æ–‡ä»¶åï¼Œä¸å½±å“ inode å·ç ã€‚
- æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ä»¥åï¼Œç³»ç»Ÿå°±ä»¥ inode å·ç æ¥è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ï¼Œä¸å†è€ƒè™‘æ–‡ä»¶åã€‚
- å¯ä»¥ä¸ºæ–‡ä»¶åˆ›å»ºç¡¬é“¾æ¥æˆ–è½¯é“¾æ¥ã€‚

è¿™ä½¿å¾—è½¯ä»¶æ›´æ–°å˜å¾—ç®€å•ï¼Œå¯ä»¥åœ¨ä¸å…³é—­è½¯ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œæ›´æ–°ï¼Œä¸éœ€è¦é‡å¯ã€‚å› ä¸ºç³»ç»Ÿé€šè¿‡ inode å·ç è¯†åˆ«è¿è¡Œä¸­çš„æ–‡ä»¶ï¼Œæ›´æ–°çš„æ—¶å€™ï¼Œæ–°ç‰ˆæ–‡ä»¶ä»¥åŒæ ·çš„æ–‡ä»¶åï¼Œä½†æ˜¯å…³è”çš„ inode æ˜¯æ–°åˆ›å»ºçš„ã€‚ç­‰åˆ°ä¸‹ä¸€æ¬¡è¿è¡Œè¿™ä¸ªè½¯ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶åå°±è‡ªåŠ¨æŒ‡å‘æ–°ç‰ˆæ–‡ä»¶ï¼Œæ—§ç‰ˆæ–‡ä»¶çš„ inode åˆ™è¢«å›æ”¶ã€‚

Unix/Linux ç³»ç»Ÿå…è®¸é“¾æ¥æ–‡ä»¶ï¼Œå¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ä¸ª inode å·ç ã€‚

inode è®°å½•äº†æ–‡ä»¶çš„é“¾æ¥æ•°ï¼Œé€šè¿‡ stat å‘½ä»¤å¯ä»¥çœ‹åˆ° Links æŒ‡ç¤ºçš„æ•°é‡ï¼Œæ¯åˆ›å»ºä¸€ä¸ªé“¾æ¥æ–‡ä»¶ï¼Œæ€»æ•°å¢åŠ  1ã€‚åè¿‡æ¥ï¼Œåˆ é™¤ä¸€ä¸ªé“¾æ¥æ–‡ä»¶ï¼Œå°±å‡ 1ã€‚å½“è¿™ä¸ªå€¼å‡åˆ° 0ï¼Œè¡¨æ˜æ²¡æœ‰æ–‡ä»¶åæŒ‡å‘è¿™ä¸ª inodeï¼Œç³»ç»Ÿå°±ä¼šå›æ”¶è¿™ä¸ª inode å ç”¨çš„ç©ºé—´ï¼Œä»¥åŠå…¶æ‰€å¯¹åº” block åŒºåŸŸã€‚

ç¡¬é“¾æ¥ hard link æ„å‘³ç€ï¼Œå¯ä»¥ç”¨ä¸åŒçš„æ–‡ä»¶åè®¿é—®åŒæ ·çš„å†…å®¹ï¼›å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œä¿®æ”¹ï¼Œä¼šå½±å“åˆ°æ‰€æœ‰æ–‡ä»¶åï¼›ä½†æ˜¯ï¼Œåˆ é™¤ä¸€ä¸ªæ–‡ä»¶åï¼Œä¸å½±å“å¦ä¸€ä¸ªæ–‡ä»¶åçš„è®¿é—®ã€‚è½¯ä»¶é“¾æ¥ symbolic links æœ‰äº›å·®åˆ«ï¼Œå®ƒä¼šåˆ›å»ºæ–°çš„ inodeï¼Œå› æ­¤ç›®æ ‡æ–‡ä»¶çš„é“¾æ¥æ•°ä¸å˜ï¼Œè¿™æ˜¯è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥æœ€å¤§çš„ä¸åŒã€‚

åˆ é™¤é“¾æ¥ï¼Œå¹¶ä¸å½±å“åŸæ–‡ä»¶å†…å®¹ï¼Œä½†åˆ é™¤åŸæ–‡ä»¶åè½¯é“¾æ¥æ–‡ä»¶å°±æˆä¸ºäº†æ­»é“¾ Danglink Linkã€‚è‹¥è¢«æŒ‡å‘è·¯å¾„æ–‡ä»¶è¢«é‡æ–°åˆ›å»ºï¼Œæ­»é“¾æ¥å¯æ¢å¤ä¸ºæ­£å¸¸çš„è½¯é“¾æ¥ã€‚

ä½†æ˜¯åˆ é™¤ç¡¬é“¾æ¥çš„åŸæ–‡ä»¶å°±å’Œåˆ é™¤ä¸€ä¸ªç¡¬é“¾æ¥ä¸€æ ·ï¼Œæ–‡ä»¶ç…§æ ·å­˜åœ¨ï¼Œé™¤éæ‰€æœ‰ç¡¬é“¾æ¥éƒ½åˆ é™¤ï¼ŒLinks è®°å½•æ•°é‡ä¸º 0 å¼•å‘æ–‡ä»¶å­˜å‚¨ç©ºé—´å›æ”¶ã€‚

åˆ›å»ºç›®å½•æ—¶ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸¤ä¸ªç›®å½•é¡¹ . å’Œ .. å¯¹åº”çš„æ˜¯å½“å‰ç›®å½•å’Œçˆ¶ç›®å½•çš„ inode å·ç ï¼Œç­‰åŒäºè¿™ä¸¤ä¸ªç›®å½•çš„ç¡¬é“¾æ¥ã€‚

ä½†æ˜¯ç¡¬é“¾æ¥ä¸èƒ½å¯¹ç›®å½•è¿›è¡Œåˆ›å»ºï¼Œåªå¯å¯¹æ–‡ä»¶åˆ›å»ºï¼Œè¿™æ˜¯å› ä¸ºå…è®¸ç¡¬é“¾æ¥åˆ°ç›®å½•å°†ç ´åæ–‡ä»¶ç³»ç»Ÿçš„æœ‰å‘æ— ç¯å›¾ç»“æ„ï¼Œdirected acyclic graph structureã€‚åœ¨éå†çš„æ—¶å€™ä¼šæœ‰æ— é™é€’å½’çš„æƒ…å†µï¼Œè€Œè½¯é“¾æ¥æœ‰ç‹¬ç«‹çš„ inode å·åˆ™å¯ä»¥ã€‚

åˆ›å»ºç¡¬é“¾æ¥æˆ–è½¯é“¾æ¥æ–‡ä»¶ï¼š

    ln TARGET LINK_NAME
    ln -s TARGET LINK_NAME


## FS Constants

fs.constants åŒ…å«å„ç§å¸¸é‡ã€‚

File Access Constants

    Flag    Description
    F_OK    the file be visible to the calling process.
    R_OK    the file can be read by the calling process.
    W_OK    the file can be written by the calling process.
    X_OK    the file can be executed by the calling process.

File Open Constants

    Constant    Description
    O_RDONLY    open a file for read-only access.
    O_WRONLY    open a file for write-only access.
    O_RDWR      open a file for read-write access.
    O_CREAT     create the file if it does not already exist.
    O_EXCL      opening a file should fail if the O_CREAT flag is set and the file already exists.
    O_NOCTTY    é¿å…æ‰“å¼€ä¸€ä¸ªç»ˆç«¯å¹¶æˆä¸ºè¿›ç¨‹çš„æ§åˆ¶ç»ˆç«¯ï¼Œå¦‚æœè¿›ç¨‹è¿˜æ²¡æœ‰æ§åˆ¶ç»ˆç«¯ã€‚
    O_TRUNC     open and truncated file to zero if the file exists and is a regular file.
    O_APPEND    data will be appended to the end of the file.
    O_DIRECTORY the open should fail if the path is not a directory.
    O_NOATIME   è®¿é—®æ–‡ä»¶è€Œä¸æ›´æ–°æ–‡ä»¶ atime ä¿¡æ¯ï¼Œåªå¯¹ Linux ç³»ç»Ÿæœ‰æ•ˆã€‚
    O_NOFOLLOW  the open should fail if the path is a symbolic link.
    O_SYNC      ä½¿ç”¨åŒæ­¥ I/O å¼ºåˆ¶åˆ·æ–°å†…æ ¸ç¼“å†²åŒºåˆ°è¾“å‡ºæ–‡ä»¶ï¼Œè·å¾—æ–‡ä»¶å®Œæ•´æ€§ã€‚
    O_DSYNC     ä½¿ç”¨åŒæ­¥ I/O å¼ºåˆ¶åˆ·æ–°å†…æ ¸ç¼“å†²åŒºåˆ°è¾“å‡ºæ–‡ä»¶ï¼Œè·å¾—æ•°æ®å®Œæ•´æ€§ã€‚
    O_SYMLINK   open the symbolic link itself rather than the resource it is pointing to.
    O_DIRECT    ç›´æ¥ I/O æ“ä½œï¼Œç»•è¿‡ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜ï¼Œä¼šå¯¼è‡´æœ€å°çš„æ–‡ä»¶ç¼“å­˜æ•ˆæœã€‚
    O_NONBLOCK  open the file in nonblocking mode when possible.

File Type Constants

    Flat        Description
    S_IFMT      Bit mask used to extract the file type code.
    S_IFREG     File type constant for a regular file.
    S_IFDIR     File type constant for a directory.
    S_IFCHR     File type constant for a character-oriented device file.
    S_IFBLK     File type constant for a block-oriented device file.
    S_IFIFO     File type constant for a FIFO/pipe.
    S_IFLNK     File type constant for a symbolic link.
    S_IFSOCK    File type constant for a socket.

File Mode Constants

    Constant    Description
    S_IRWXU     File mode indicating readable, writable, and executable by owner.
    S_IRUSR     File mode indicating readable by owner.
    S_IWUSR     File mode indicating writable by owner.
    S_IXUSR     File mode indicating executable by owner.
    S_IRWXG     File mode indicating readable, writable, and executable by group.
    S_IRGRP     File mode indicating readable by group.
    S_IWGRP     File mode indicating writable by group.
    S_IXGRP     File mode indicating executable by group.
    S_IRWXO     File mode indicating readable, writable, and executable by others.
    S_IROTH     File mode indicating readable by others.
    S_IWOTH     File mode indicating writable by others.
    S_IXOTH     File mode indicating executable by others.

ä»¥ä¸Šæ ‡è¯†åç¼€å«ä¹‰:

- U æˆ– USR è¡¨ç¤º Owner User
- G æˆ– GRP è¡¨ç¤º Group User
- O æˆ– OTH è¡¨ç¤º Other User


æ€»ç»“ï¼Œæ ‡å‡†çš„ stdio å‡½æ•°åº“å’Œå†…æ ¸é‡‡ç”¨çš„ç¼“å†²è¿™ä¸¤çº§ç¼“å†²ï¼š

- é¦–å…ˆï¼Œé€šè¿‡ stdio åº“å°†ç”¨æˆ·æ•°æ®ä¼ é€’åˆ° stdio ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä½äºç”¨æˆ·æ€å†…å­˜åŒºã€‚
- å½“ç¼“å†²åŒºå¡«æ»¡ï¼Œstdio åº“ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ write() å°†æ•°æ®ä¼ é€’åˆ°å†…æ ¸é«˜é€Ÿç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä½äºå†…æ ¸æ€å†…å­˜åŒºã€‚
- æœ€ç»ˆï¼Œå†…æ ¸å‘èµ·ç£ç›˜æ“ä½œã€‚

Linux å…è®¸åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œç£ç›˜ I/O æ—¶ç»•è¿‡ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜ï¼Œä»ç”¨æˆ·ç©ºé—´ç›´æ¥å°†æ•°æ®ä¼ é€’åˆ°æ–‡ä»¶æˆ–ç£ç›˜è®¾å¤‡ï¼Œæˆ–è€…è£¸ç§°ä¸º Raw I/Oã€‚åƒæ•°æ®åº“ç³»ç»Ÿï¼Œå…¶é«˜é€Ÿç¼“å­˜å’Œ I/O ä¼˜åŒ–æœºåˆ¶å‡è‡ªæˆä¸€ä½“ï¼Œæ— éœ€å†…æ ¸æ¶ˆè€— CPU æ—¶é—´å’Œå†…å­˜å»å®Œæˆç›¸åŒçš„ä»»åŠ¡ã€‚

ä½¿ç”¨ç›´æ¥ I/O å¯èƒ½ä¼šå¤§å¤§é™ä½æ€§èƒ½ï¼Œå†…æ ¸å¯¹ç¼“å†²åŒºå‘Šè¯‰ç¼“å­˜åšäº†ä¸å°‘ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ï¼šæŒ‰é¡ºåºé¢„è¯»å–ï¼Œåœ¨æˆç°‡ç£ç›˜å—ä¸Šæ‰§è¡Œ I/Oï¼Œå…è®¸è®¿é—®åŒä¸€æ–‡ä»¶çš„å¤šä¸ªè¿›ç¨‹å…±äº«é«˜é€Ÿç¼“å­˜çš„ç¼“å†²åŒºã€‚

O_NONBLOCK å’Œ O_NDELAY éƒ½æ˜¯ä½¿ I/O å˜æˆéé˜»å¡æ¨¡å¼ï¼Œåœ¨è¯»å–ä¸åˆ°æ•°æ®æˆ–æ˜¯å†™å…¥ç¼“å†²åŒºå·²æ»¡ä¼šé©¬ä¸Š returnï¼Œè€Œä¸ä¼šé˜»å¡ç­‰å¾…ã€‚

å®ƒä»¬çš„å·®åˆ«åœ¨äºï¼šåœ¨è¯»æ“ä½œæ—¶ï¼Œå¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼ŒO_NDELAY æ¨¡å¼ä¼šé©¬ä¸Šè¿”å› 0ï¼Œä½†è¿™åˆè¡ç”Ÿå‡ºä¸€ä¸ªé—®é¢˜ï¼ŒåŒºåˆ«ä¸äº†æ˜¯å¦è¯»å–åˆ°æ–‡ä»¶æœ«å°¾(EOF)æ—¶è¿”å›çš„ 0ã€‚å› æ­¤ï¼ŒO_NONBLOCK å°±äº§ç”Ÿå‡ºæ¥ï¼Œå®ƒåœ¨è¯»å–ä¸åˆ°æ•°æ®æ—¶ä¼šå›ä¼  -1ï¼Œå¹¶ä¸”è®¾ç½® errno ä¸º EAGAINã€‚




# ğŸš© Path QueryString 
- https://nodejs.org/docs/latest-v9.x/api/path.html
- https://nodejs.org/docs/latest-v12.x/api/modules.html
- https://nodejs.org/docs/latest-v14.x/api/querystring.html

ä½¿ç”¨ Path API è§£ææ¨¡å—æš´éœ²çš„è·¯å¾„ä¿¡æ¯ï¼š

```
const fs = require( 'fs');
const path = require( 'path');

console.log(path.parse(__filename))
console.log(path.parse(process.cwd()))
console.log(path.dirname(process.cwd()))
console.log(__dirname, __filename, process.cwd())
/*
{
  root: 'C:\\',
  dir: 'C:\\coding\\md-code\\coding',
  base: 'coding.mjs.js',
  ext: '.js',
  name: 'coding.mjs'
}
*/
```

Windows vs. POSIXï¼ŒåŒæ ·çš„è·¯å¾„å¯èƒ½è¿”å›ä¸åŒçš„å€¼ï¼š

    path.basename('C:\\temp\\myfile.html');

    // On POSIX:
    // Returns: 'C:\\temp\\myfile.html'

    // On Windows:
    // Returns: 'myfile.html'

ä¸¤ç§ç³»ç»Ÿä½¿ç”¨ä¸åŒçš„è·¯å¾„åˆ†éš”ç¬¦ï¼š

- path.delimiter `;` for Windows `:` for POSIX
- path.sep `\` on Windows `/` on POSIX

æ— è®ºä½¿ç”¨ Windows é£æ ¼è¿˜æ˜¯ POSIX é£æ ¼çš„è·¯å¾„ï¼Œä»¥ä¸‹æ–¹å¼éƒ½é€‚ç”¨ï¼š

    path.win32.basename('C:\\temp\\myfile.html');
    // Returns: 'myfile.html'

    path.posix.basename('/tmp/myfile.html');
    // Returns: 'myfile.html'

å› æ­¤ä½¿ç”¨ path.posix æˆ– path.win32 æä¾›çš„å¹³å°åŒ–é€‚é…æ–¹æ³•æ›´å¥½ã€‚

æ‰§è¡Œ parse() è§£æç›®å½•è·¯å¾„ï¼Œå¹³å°å·®å¼‚å¦‚ä¸‹ï¼š

    On POSIX:
    path.parse('/home/user/dir/file.txt');
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          dir        â”‚    base    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”¬              â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤
    â”‚ root â”‚              â”‚ name â”‚ ext â”‚
    "  /    home/user/dir / file  .txt "
    â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

    On Windows:
    path.parse('C:\\path\\dir\\file.txt');
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          dir        â”‚    base    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”¬              â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤
    â”‚ root â”‚              â”‚ name â”‚ ext â”‚
    " C:\      path\dir   \ file  .txt "
    â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

API å‚è€ƒï¼š

- Path
    - path.basename(path[, ext])
    - path.delimiter
    - path.dirname(path)
    - path.extname(path)
    - path.format(pathObject)
    - path.isAbsolute(path)
    - path.join([...paths])
    - path.normalize(path)
    - path.parse(path)
    - path.posix
    - path.relative(from, to)
    - path.resolve([...paths])
    - path.sep
    - path.toNamespacedPath(path)
    - path.win32

- Query string
    - querystring.decode()
    - querystring.encode()
    - querystring.escape(str)
    - querystring.parse(str[, sep[, eq[, options]]])
    - querystring.stringify(obj[, sep[, eq[, options]]])
    - querystring.unescape(str)


# ğŸš© URL Module
- https://nodejs.org/docs/latest-v12.x/api/url.html
- URL Living Standard https://url.spec.whatwg.org/
- Punycode https://tools.ietf.org/html/rfc5891#section-4.4

æŒ‰è§„èŒƒå®šä¹‰ï¼Œæ¯ä¸€ä¸ª URL å­—ç¬¦ä¸²çš„å„ä¸ªç»„æˆåˆ†è§£å¦‚ä¸‹ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                              href                                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ protocol â”‚  â”‚        auth         â”‚          host          â”‚           path            â”‚ hash  â”‚
    â”‚          â”‚  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚          â”‚  â”‚                     â”‚    hostname     â”‚ port â”‚ pathname â”‚     search     â”‚       â”‚
    â”‚          â”‚  â”‚                     â”‚                 â”‚      â”‚          â”œâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
    â”‚          â”‚  â”‚                     â”‚                 â”‚      â”‚          â”‚ â”‚    query     â”‚       â”‚
    "  https:   //    user   :   pass   @ sub.example.com : 8080   /p/a/t/h  ?  query=string   #hash "
    â”‚          â”‚  â”‚          â”‚          â”‚    hostname     â”‚ port â”‚          â”‚                â”‚       â”‚
    â”‚          â”‚  â”‚          â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¤          â”‚                â”‚       â”‚
    â”‚ protocol â”‚  â”‚ username â”‚ password â”‚          host          â”‚          â”‚                â”‚       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚                â”‚       â”‚
    â”‚                           origin                           â”‚ pathname â”‚     search     â”‚ hash  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                              href                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (All spaces in the "" line should be ignored. They are purely for formatting.)

```
const {parse, URL} = require("url")

const url = "https://user:pass@sub.example.com:8080/p/a/t/h?query=string#hash";

let test = parse(url)
console.log(JSON.stringify(test, null, "  "))

const myURL = new URL(url);
console.log(myURL.origin);
```

è¾“å‡ºï¼š

    {
      "protocol": "https:",
      "slashes": true,
      "auth": "user:pass",
      "host": "sub.example.com:8080",
      "port": "8080",
      "hostname": "sub.example.com",
      "hash": "#hash",
      "search": "?query=string",
      "query": "query=string",
      "pathname": "/p/a/t/h",
      "path": "/p/a/t/h?query=string",
      "href": "https://user:pass@sub.example.com:8080/p/a/t/h?query=string#hash"
    }
    https://sub.example.com:8080

Percent-encoding in URLs

    Legacy API: < > " ` \r \n \t { } | \ ^ '
    WHATWG API: 
    - The C0 control percent-encode set: [U+0000, U+001F], [U+007E, +]
    - The fragment percent-encode set: the C0 control percent-encode set, U+0020, U+0022, U+003C, U+003E, and U+0060.
    - The path percent-encode set: the C0 control percent-encode set, U+0020, U+0022, U+0023, U+003C, U+003E, U+003F, U+0060, U+007B, and U+007D.
    - The userinfo encode set: the path percent-encode set, U+002F, U+003A, U+003B, U+003D, U+0040, U+005B, U+005C, U+005D, U+005E, and U+007C.

ä»¥ä¸Šå‡ ä¸ªç™¾åˆ†æ¯”ç¼–ç é›†çš„ä½¿ç”¨ï¼š

- ç‰‡æ®µç™¾åˆ†æ¯”ç¼–ç é›†ç”¨äº URL ç‰‡æ®µã€‚
- è·¯å¾„ç™¾åˆ†æ¯”ç¼–ç é›†ç”¨äºå¤§å¤šæ•° URL çš„è·¯å¾„ã€‚
- ç”¨æˆ·ä¿¡æ¯ç™¾åˆ†æ¯”ç¼–ç é›†ä¸“é—¨ç”¨äº URL ä¸­ç”¨æˆ·åå’Œå¯†ç ç¼–ç ã€‚
- C0 æ§åˆ¶ç™¾åˆ†æ¯”ç¼–ç é›†ç”¨äºç‰¹å®šæ¡ä»¶ä¸‹çš„ä¸»æœºå’Œè·¯å¾„ï¼Œä»¥åŠæ‰€æœ‰å…¶ä»–æƒ…å†µã€‚

åœ¨åŸŸåå‡ºç°é ASCII ç¼–ç å­—ç¬¦æ—¶ï¼Œè¿›è¡Œ punycode è½¬æ¢ï¼Œå³å‰ç¼€ `xn--`ï¼š

```
const myURL = new URL('https://%CF%80.example.com/foo');
console.log(myURL.href);
// Prints https://xn--1xa.example.com/foo
console.log(myURL.origin);
// Prints https://xn--1xa.example.com
```

Legacy urlObject å·²ç»è¿‡æ—¶ã€‚


API å‚è€ƒï¼š

- Class: URL
    - new URL(input[, base])
    - url.hash
    - url.host
    - url.hostname
    - url.href
    - url.origin
    - url.password
    - url.pathname
    - url.port
    - url.protocol
    - url.search
    - url.searchParams
    - url.username
    - url.toString()
    - url.toJSON()
    - url.domainToASCII(domain)
    - url.domainToUnicode(domain)
    - url.fileURLToPath(url)
    - url.format(URL[, options])
    - url.pathToFileURL(path)

- Class: URLSearchParams
    - new URLSearchParams()
    - new URLSearchParams(string)
    - new URLSearchParams(obj)
    - new URLSearchParams(iterable)
    - urlSearchParams.append(name, value)
    - urlSearchParams.delete(name)
    - urlSearchParams.entries()
    - urlSearchParams.forEach(fn[, thisArg])
    - urlSearchParams.get(name)
    - urlSearchParams.getAll(name)
    - urlSearchParams.has(name)
    - urlSearchParams.keys()
    - urlSearchParams.set(name, value)
    - urlSearchParams.sort()
    - urlSearchParams.toString()
    - urlSearchParams.values()
    - urlSearchParams[Symbol.iterator]()


# ğŸš© DNS Module
- https://nodejs.org/docs/latest-v14.x/api/dns.html

è™½ç„¶æ­¤æ¨¡å—ä»¥ DNS - Domain Name System å‘½åï¼Œä½†å¹¶ä¸æ€»æ˜¯ä½¿ç”¨ DNS åè®®æŸ¥æ‰¾åŸŸåã€‚

dns.lookup() ä½¿ç”¨æ“ä½œç³»ç»Ÿå·¥å…·æ‰§è¡ŒåŸŸåè§£æï¼Œå®ƒå¯èƒ½ä¸éœ€è¦æ‰§è¡Œä»»ä½•ç½‘ç»œé€šä¿¡ï¼Œæ‰§è¡Œå®ƒå¯ä»¥åƒåŒä¸€ç³»ç»Ÿä¸Šçš„å…¶ä»–åº”ç”¨ç¨‹åºé‚£æ ·æ‰§è¡Œåç§°è§£æã€‚

```
const dns = require('dns');

dns.lookup('example.org', (err, address, family) => {
  console.log('address: %j family: IPv%s', address, family);
});
// address: "93.184.216.34" family: IPv4
```

ç¤ºèŒƒï¼Œæ­£å‘ä¸åå‘åŸŸåè§£æï¼š

```
const dns = require('dns');

dns.resolve4('archive.org', (err, addresses) => {
  if (err) throw err;

  console.log(`addresses: ${JSON.stringify(addresses)}`);

  addresses.forEach((a) => {
    dns.reverse(a, (err, hostnames) => {
      if (err) {
        throw err;
      }
      console.log(`reverse for ${a}: ${JSON.stringify(hostnames)}`);
    });
  });
});
```

å°½ç®¡ dns.lookup() ä»¥åŠå„ç§ DNS åŸŸåè§£æå‡½æ•°æˆ–åè§£å‡½æ•°ç›®æ ‡æ˜¯è½¬æ¢åŸŸåä¸ç›¸å…³è” IP åœ°å€ï¼Œä½†å®ƒä»¬çš„è¡Œä¸ºå®Œå…¨ä¸åŒï¼Œè¿™äº›å·®å¼‚ä¼šå¯¹ Node ç¨‹åºè¡Œä¸ºäº§ç”Ÿå¾®å¦™ä½†é‡è¦çš„å½±å“ã€‚

ç®€å•åœ°è¯´ï¼Œdns.lookup() å’Œå…¶å®ƒç¨‹åºä¸€æ ·ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„åŸŸåå·¥å…·ï¼Œå¦‚ /etc/hosts é…ç½®æ–‡ä»¶ï¼Œå‡ ä¹ä¹Ÿå’Œ ping å‘½ä»¤ä¸€æ ·æ‰§è¡ŒåŸŸåè§£æè¿‡ç¨‹ã€‚

åœ¨å¤§å¤šæ•° POSIX-like æ“ä½œç³»ç»Ÿä¸Šï¼Œdns.lookup() å‡½æ•°å¯ä»¥é€šè¿‡é…ç½® nsswitch.conf(5) æˆ– resolv.conf(5) æ¥æ”¹å˜è¡Œä¸ºï¼Œè¿™äº›é…ç½®åŒæ—¶ä¹Ÿä¼šå½±å“ç³»ç»Ÿçš„å…¶å®ƒç¨‹åºã€‚

å°½ç®¡è°ƒç”¨ dns.lookup() æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ JavaScript è„šæœ¬ï¼Œä½†å®ƒæ˜¯é€šè¿‡ libuv's threadpool åŒæ­¥è°ƒç”¨ getaddrinfo(3) å®ç°çš„ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»¤äººæƒŠè®¶çš„è´Ÿé¢æ€§èƒ½å½±å“ï¼Œå‚è€ƒ UV_THREADPOOL_SIZE æ–‡æ¡£ã€‚

è®¸å¤šç½‘ç»œ API éƒ½éœ€è¦ dns.lookup() æ¥è§£æåŸŸåï¼Œå¦‚æœä½¿ç”¨ dns.lookup() è¿›è¡ŒåŸŸåè§£ææœ‰é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨åœ°å€è€ŒéåŸŸåã€‚ä¸€äº›ç½‘ç»œ API å¦‚ `socket.connect()` `dgram.createSocket()` å…è®¸é»˜è®¤çš„åŸŸåè§£æå‡½æ•° dns.lookup() æ›¿æ¢ä¸ºå…¶å®ƒå®ç°ã€‚

é™¤äº† dns.lookup()ï¼Œæ¨¡å—ä¸‹çš„å…¶å®ƒå‡½æ•°ä¼šè”æ¥çœŸå® DNS æœåŠ¡å™¨æ‰§è¡ŒåŸŸåè§£æï¼Œå®ƒä»¬æ€»æ˜¯è¯·æ±‚ç½‘ç»œï¼Œå¿½ç•¥å…¶å®ƒåŸŸåå·¥å…·ï¼Œå¹¶ä¸”ä¸åƒ dns.lookup() ä½¿ç”¨ç±»ä¼¼ /etc/hosts è¿™æ ·çš„æœ¬åœ°é…ç½®æ–‡ä»¶ã€‚

å„ä¸ªæ­£å‘è§£æä¸åå‘è§£æå‡½æ•° dns.resolve() & dns.reverse() ä¸ dns.lookup() å‡½æ•°çš„å®ç°ä¸åŒï¼Œå®ƒä»¬ä¸ä½¿ç”¨ getaddrinfo(3) å‡½æ•°ï¼Œå¹¶ä¸”æ€»æ˜¯ç”± libuv's threadpool å¼‚æ­¥åœ°é€šè¿‡ç½‘ç»œè¯·æ±‚ DNS æŸ¥è¯¢ã€‚

å› æ­¤ï¼Œè¿™äº›å‡½æ•°ä¸ä¼šå¯¹ libuv çº¿ç¨‹æ± ä¸Šå…¶ä»–è¿›ç¨‹äº§ç”Ÿå’Œ dns.lookup() ç›¸åŒçš„è´Ÿé¢å½±å“ã€‚



åŸŸåè§£æå‡½æ•°å›è°ƒä¸­çš„ rrtypeï¼š

    |  rrtype |        records contains        | Result type |  Shorthand method  |
    |---------|--------------------------------|-------------|--------------------|
    | 'A'     | IPv4 addresses (default)       | <string>    | dns.resolve4()     |
    | 'AAAA'  | IPv6 addresses                 | <string>    | dns.resolve6()     |
    | 'ANY'   | any records                    | <Object>    | dns.resolveAny()   |
    | 'CNAME' | canonical name records         | <string>    | dns.resolveCname() |
    | 'MX'    | mail exchange records          | <Object>    | dns.resolveMx()    |
    | 'NAPTR' | name authority pointer records | <Object>    | dns.resolveNaptr() |
    | 'NS'    | name server records            | <string>    | dns.resolveNs()    |
    | 'PTR'   | pointer records                | <string>    | dns.resolvePtr()   |
    | 'SOA'   | start of authority records     | <Object>    | dns.resolveSoa()   |
    | 'SRV'   | service records                | <Object>    | dns.resolveSrv()   |
    | 'TXT'   | text records                   | <string[]>  | dns.resolveTxt()   |


DNS API å‚è€ƒ

- Class: dns.Resolver
    - Resolver([options])
    - resolver.cancel()
    - dns.getServers()
    - dns.lookup(hostname[, options], callback)
    - dns.lookupService(address, port, callback)
    - dns.resolve(hostname[, rrtype], callback)
    - dns.resolve4(hostname[, options], callback)
    - dns.resolve6(hostname[, options], callback)
    - dns.resolveAny(hostname, callback)
    - dns.resolveCname(hostname, callback)
    - dns.resolveMx(hostname, callback)
    - dns.resolveNaptr(hostname, callback)
    - dns.resolveNs(hostname, callback)
    - dns.resolvePtr(hostname, callback)
    - dns.resolveSoa(hostname, callback)
    - dns.resolveSrv(hostname, callback)
    - dns.resolveTxt(hostname, callback)
    - dns.reverse(ip, callback)
    - dns.setServers(servers)

- Class: dnsPromises.Resolver
    - dnsPromises.getServers()
    - dnsPromises.lookup(hostname[, options])
    - dnsPromises.lookupService(address, port)
    - dnsPromises.resolve(hostname[, rrtype])
    - dnsPromises.resolve4(hostname[, options])
    - dnsPromises.resolve6(hostname[, options])
    - dnsPromises.resolveAny(hostname)
    - dnsPromises.resolveCname(hostname)
    - dnsPromises.resolveMx(hostname)
    - dnsPromises.resolveNaptr(hostname)
    - dnsPromises.resolveNs(hostname)
    - dnsPromises.resolvePtr(hostname)
    - dnsPromises.resolveSoa(hostname)
    - dnsPromises.resolveSrv(hostname)
    - dnsPromises.resolveTxt(hostname)
    - dnsPromises.reverse(ip)
    - dnsPromises.setServers(servers)

- Error codes
    - dns.NODATA:   DNS server returned answer with no data.
    - dns.FORMERR:  DNS server claims query was misformatted.
    - dns.SERVFAIL:     DNS server returned general failure.
    - dns.NOTFOUND:     Domain name not found.
    - dns.NOTIMP:   DNS server does not implement requested operation.
    - dns.REFUSED:  DNS server refused query.
    - dns.BADQUERY:     Misformatted DNS query.
    - dns.BADNAME:  Misformatted host name.
    - dns.BADFAMILY:    Unsupported address family.
    - dns.BADRESP:  Misformatted DNS reply.
    - dns.CONNREFUSED:  Could not contact DNS servers.
    - dns.TIMEOUT:  Timeout while contacting DNS servers.
    - dns.EOF:  End of file.
    - dns.FILE:     Error reading file.
    - dns.NOMEM:    Out of memory.
    - dns.DESTRUCTION:  Channel is being destroyed.
    - dns.BADSTR:   Misformatted string.
    - dns.BADFLAGS:     Illegal flags specified.
    - dns.NONAME:   Given host name is not numeric.
    - dns.BADHINTS:     Illegal hints flags specified.
    - dns.NOTINITIALIZED:   c-ares library initialization not yet performed.
    - dns.LOADIPHLPAPI:     Error loading iphlpapi.dll.
    - dns.ADDRGETNETWORKPARAMS:     Could not find GetNetworkParams function.
    - dns.CANCELLED:    DNS query cancelled.


# ğŸš© UDP dgram Module
- https://nodejs.org/docs/latest-v14.x/api/dgram.html

    - Example: IPv6 outgoing multicast interface
    - Example: IPv4 outgoing multicast interface
    - Call results

dgram æ¨¡å—æ˜¯å¯¹ UDP socket çš„ä¸€å±‚å°è£…ï¼Œç›¸å¯¹ TCP åè®®çš„ net æ¨¡å—ç®€å•å¾ˆå¤šã€‚

IPv4/v6 æ•°æ®æŠ¥çš„æœ€å¤§å¤§å°å–å†³äº MTU - Maximum Transmission Unit å’Œ Payload é•¿åº¦å­—æ®µå¤§å°ã€‚

æœ‰æ•ˆè´Ÿè½½é•¿åº¦å­—æ®µä¸º 16 bitsï¼Œè¿™æ„å‘³ç€æ­£å¸¸æœ‰æ•ˆè´Ÿè½½ä¸èƒ½è¶…è¿‡ 64KBï¼ŒåŒ…æ‹¬ Internet æ ‡å¤´å’Œæ•°æ®ï¼š

    65507 Bytes = 65535 âˆ’ 8 Bytes UDP Header âˆ’ 20 Bytes IP Header

è¿™é€šå¸¸é€‚ç”¨äºç¯å›æ¥å£ï¼Œä½†å¯¹äºå¤§å¤šæ•°ä¸»æœºå’Œç½‘ç»œæ¥è¯´ï¼Œè¿™æ ·é•¿çš„æ•°æ®æŠ¥æ¶ˆæ¯æ˜¯ä¸åˆ‡å®é™…çš„ã€‚

MTU æ˜¯ç»™å®šé“¾è·¯å±‚æŠ€æœ¯å¯ä»¥æ”¯æŒçš„æœ€å¤§æ•°æ®æŠ¥æ¶ˆæ¯å¤§å°ï¼Œå¯¹äºä»»ä½•é“¾è·¯ï¼ŒIPv4 éƒ½è¦æ±‚æœ€å° MTU ä¸º 68 Bytesï¼Œè€Œ IPv4 æ¨è MTU 576ï¼ˆé€šå¸¸æ¨èä¸ºæ‹¨å·ç±»å‹åº”ç”¨ç¨‹åºçš„ MTUï¼‰ï¼Œæ— è®ºå®ƒä»¬æ˜¯å®Œæ•´åˆ°è¾¾ï¼Œè¿˜æ˜¯ç‰‡æ®µåˆ°è¾¾ã€‚

å¯¹äº IPv6ï¼Œæœ€å° MTU æ˜¯ 1280 ä¸ªå…«ä½å­—èŠ‚ï¼Œä½†æ˜¯ï¼Œå¼ºåˆ¶çš„æœ€å°ç‰‡æ®µé‡ç»„ç¼“å†²åŒºå¤§å°æ˜¯ 1500 ä¸ªå…«ä½å­—èŠ‚ã€‚68 ä¸ªå…«ä½å­—èŠ‚çš„å€¼éå¸¸å°ï¼Œå› ä¸ºå¤§å¤šæ•°å½“å‰çš„é“¾è·¯å±‚æŠ€æœ¯ï¼Œå¦‚ä»¥å¤ªç½‘çš„æœ€å° MTU ä¸º 1500ã€‚

ä¸å¯èƒ½é¢„å…ˆçŸ¥é“åŒ…å¯èƒ½é€šè¿‡çš„æ¯ä¸ªé“¾è·¯çš„ MTUï¼Œå‘é€å¤§äºæ¥æ”¶å™¨ MTU çš„æ•°æ®æŠ¥å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæ•°æ®åŒ…å°†è¢«æ— å£°åœ°ä¸¢å¼ƒï¼Œè€Œä¸ä¼šé€šçŸ¥æºæ•°æ®æ²¡æœ‰åˆ°è¾¾å…¶é¢„æœŸçš„æ”¶ä»¶äººã€‚

MTU å‚æ•°æ˜¯ç½‘ç»œè°ƒèŠ‚çš„é‡è¦å› ç´ ï¼Œå› ä¸ºåŒ…ä¸­çš„é¢å¤–å¼€é”€é‡ç›¸å½“é«˜ã€‚é«˜ MTU å€¼å‡å°‘äº†å¤´ä¿¡æ¯æµªè´¹çš„å­—èŠ‚æ•°ï¼Œå¯¹å¤§é‡æ•°æ®ä¼ è¾“å°¤å…¶é‡è¦ï¼Œè€Œå¯¹å°äº MTU çš„ä¼ è¾“æ²¡æœ‰å½±å“ã€‚


UDP å®¢æˆ·ç«¯ vs UDP æœåŠ¡ç«¯

```
var dgram = require('dgram');
var server = dgram.createSocket('udp4');

var opt = {
  port: 3000,
  address: '127.0.0.1',
}

server.on('listening', function () {
    var {address, port} = server.address();
    console.log('UDP Server listening on %s:%s ', address, port);
});

server.on('message', function (message, remote) {
    console.log("%s:%s - %s", remote.address, remote.port, message.toString());
});

server.bind(opt);

```


```
var dgram = require('dgram');

var {port, address} = {
  port: 3000,
  address: '127.0.0.1',
};
var message = Buffer.from('Biu! Biu! are your ok?');

var client = dgram.createSocket('udp4');

client.send(message, port, address, function(err, bytes) {
    if (err) throw err;
    console.log('UDP message sent to %s:%s', address, port);
    client.close();
});
```

é€šè¿‡ UDP å®ç°å¹¿æ’­åŠŸï¼ŒæœåŠ¡ç«¯ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼Œåªéœ€è¦ bind(port)ï¼Œæˆ–è€… IP æ”¹ä¸ºå››ä¸ª 0 å³å½“å‰ä¸»æœºåœ°å€ï¼š

```
// broadcast-server.js
var opt = {
  port: 3000,
  address: '0.0.0.0',
}
// ...
server.bind(opt);
```

åˆ›å»ºå®¢æˆ·ç«¯ï¼Œå‘å½“å‰å­ç½‘çš„å¹¿æ’­åœ°å€ 255.255.255.255:3000 æˆ–æœ¬åœ°å¹¿æ’­åœ°å€ 127.0.0.255:3000 è¿›è¡Œå¹¿æ’­ï¼š

```
var dgram = require('dgram');
var client = dgram.createSocket('udp4');

var {port, address} = {
  port: 3000,
  address: '127.0.0.255',
  address: '255.255.255.255',
};
var message = Buffer.from('Biu! Biu! are your ok?');

client.bind(function(){
  client.setBroadcast(true);
  client.send(message, port, address, function(err){
      if(err) throw err;
      console.log('UDP message sent to %s:%s', address, port);
      client.close();
  });
});
```


UDP/datagram sockets

- Class: dgram.Socket
    - Event: 'close'
    - Event: 'connect'
    - Event: 'error'
    - Event: 'listening'
    - Event: 'message'
    - socket.addMembership(multicastAddress[, multicastInterface])
    - socket.addSourceSpecificMembership(sourceAddress, groupAddress[, multicastInterface])
    - socket.address()
    - socket.bind([port][, address][, callback])
    - socket.bind(options[, callback])
    - socket.close([callback])
    - socket.connect(port[, address][, callback])
    - socket.disconnect()
    - socket.dropMembership(multicastAddress[, multicastInterface])
    - socket.dropSourceSpecificMembership(sourceAddress, groupAddress[, multicastInterface])
    - socket.getRecvBufferSize()
    - socket.getSendBufferSize()
    - socket.ref()
    - socket.remoteAddress()
    - socket.send(msg[, offset, length][, port][, address][, callback])
    - socket.setBroadcast(flag)
    - socket.setMulticastInterface(multicastInterface)
    - socket.setMulticastLoopback(flag)
    - socket.setMulticastTTL(ttl)
    - socket.setRecvBufferSize(size)
    - socket.setSendBufferSize(size)
    - socket.setTTL(ttl)
    - socket.unref()

- dgram module functions
    - dgram.createSocket(options[, callback])
    - dgram.createSocket(type[, callback])


# ğŸš© Net Module
- Linux C ç¼–ç¨‹ä¸€ç«™å¼å­¦ä¹  ch37 - UNIX Domain Socket IPC https://akaedu.github.io/book/ch37s04.html
- Advanced Programming in the UNIX Environment Third Edition - Chapter 16. Network IPC: Sockets
- Accept-Ranges https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.5

ã€ŠUNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹ï¼Œè‹±æ–‡ç¼©å†™ APUEï¼Œèµ«èµ«æœ‰åï¼Œå‡ ä¹æ²¡å‡ ä¸ªè®¡ç®—æœºä¸“ä¸šçš„æ¯•ä¸šç”Ÿæ²¡å¬è¯´è¿‡ï¼Œä½†æ˜¯å…¶å®å¹¶æ²¡æœ‰å‡ ä¸ªäººçœŸçš„çœ‹è¿‡ï¼Œçœ‹å®Œè¿‡ã€‚ä½†å‡¡æœ‰ç¨‹åºå‘˜æ¬å®¶å–ä¹¦ï¼Œå‡ ä¹éƒ½å°‘ä¸äº†è¿™ä¸€æœ¬ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šè®¡ç®—æœºè¡Œä¸šæœ‰è®¸å¤šåè‘—ï¼Œå†å²æ‚ ä¹…ï¼Œèµ«èµ«æœ‰åï¼Œäººäººéƒ½ä¹°ï¼Œä½†æ˜¯æ²¡å‡ ä¸ªäººè®¤çœŸçœ‹ã€‚

ã€ŠAPUEã€‹ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºä¸æœ½ä¹‹ä½œï¼Œå¹¶ä¸æ˜¯å› ä¸ºå®ƒæŠŠé‚£äº›ä¸œè¥¿è®²çš„ç»†ï¼Œè®²çš„ç²¾å‡†ï¼Œè€Œæ˜¯å› ä¸ºå®ƒæ˜¯ç«™åœ¨åˆ›ä½œè€…çš„è§’åº¦ï¼Œè¯¦ç»†åˆ†æUNIXç³»ç»Ÿæœ¬èº«ã€‚å®ƒçœŸæ­£è®²çš„æ˜¯UNIXæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼ŒUNIXæ˜¯å¦‚ä½•å®ç°æŸä¸ªåŠŸèƒ½çš„ï¼Œå‡ ä¸ªUNIXå˜ç§ï¼ˆLinuxï¼ŒMac OS Xï¼ŒFreeBSDï¼ŒSolarisï¼‰åˆ†åˆ«æœ‰ä»€ä¹ˆå¼‚åŒï¼Œç¨‹åºå‘˜å¯ä»¥é€šè¿‡æä¾›çš„æ¥å£åšå“ªäº›äº‹æƒ…ã€‚

ã€ŠCç¨‹åºè®¾è®¡è¯­è¨€ã€‹è¿™æœ¬ä¹¦å¾ˆè–„ï¼Œæ­£æ–‡åªæœ‰100å¤šé¡µä¸åˆ°200é¡µï¼Œåªæ˜¯è®²äº† C è¯­è¨€ï¼Œå…¶ä»–çœŸçš„ä»€ä¹ˆéƒ½æ²¡æœ‰è®²ã€‚è¿™ä¹¦åŸºæœ¬äººäººéƒ½çœ‹è¿‡ï¼Œä½†æ˜¯çœ‹è¿‡ä¹‹åå¯èƒ½ä¼šæœ‰ä¸€äº›å›°æƒ‘â€œè¿™äº›æˆ‘éƒ½æ‡‚äº†ï¼Œä½†æ˜¯æˆ‘èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿç„¶åæˆ‘åº”è¯¥å­¦ç‚¹ä»€ä¹ˆå‘¢â€ã€‚

å¦‚æœå¸¦ç€ç›®çš„å»ç¿»ä¸€æœ¬ä¹¦ï¼Œè€Œä¸æ˜¯ä»å¤´åˆ°å°¾åœ°çœ‹ï¼Œä¹Ÿè®¸æ”¶è·ä¼šæ›´å¤§ã€‚å› ä¸ºï¼Œä»å¤´çœ‹åˆ°å°¾çš„è¿™ç§æ–¹å¼å¾ˆå®¹æ˜“è®©äººæœ‰ç§é”™è§‰ï¼Œå°±æ˜¯çœ‹å®Œæ•´æœ¬ä¹¦å°±è¯¥ä»€ä¹ˆéƒ½ä¼šäº†ã€‚

Net æ¨¡å—ä¸ä»…æä¾›åŸºäº stream çš„ç½‘ç»œåº•å±‚ TCP APIï¼Œå…¶æ›´é‡è¦çš„åŠŸèƒ½æ˜¯ IPC - Inter-process communicationï¼Œåœ¨ Node ç¯å¢ƒä¸­æœ€å¸¸ç”¨çš„æ‰‹æ®µå°±æ˜¯åŸºäº socket çš„è¿›ç¨‹é—´é€šä¿¡æ‰‹æ®µã€‚

åœ¨ Windows å¹³å°ä¸‹ï¼ŒIPC åŸºäº named pipes å®ç°ï¼Œåœ¨å…¶å®ƒç³»ç»ŸåŸºäº Unix domain socketsã€‚

åŸæœ¬ socket ä¸ºç½‘ç»œé€šè®¯è®¾è®¡ï¼Œè€Œéšç€åŸºäº socket ä¸Šé¢çš„ IPC æœºåˆ¶å®ç°ï¼Œå³ UNIX Domain Socket å¯ä»¥å¸¦æ¥æ›´ä¼˜åŒ–çš„ï¼Œä¸“ç”¨äºè¿›ç¨‹é—´é€šä¿¡çš„ç½‘ç»œé€šä¿¡ã€‚

è™½ç„¶ socket å¯ç”¨äºåŒä¸€å°ä¸»æœºçš„è¿›ç¨‹é—´é€šè®¯ï¼Œé€šè¿‡ loopback 127.0.0.1ï¼Œä½†æ˜¯ UNIX Domain Socket æ–¹å¼ç”¨äº IPC æ›´æœ‰æ•ˆç‡ï¼šä¸éœ€è¦ç»è¿‡ TCP/IP ç½‘ç»œåè®®æ ˆï¼Œä¸éœ€è¦æ‰“åŒ…æ‹†åŒ…ã€è®¡ç®—æ ¡éªŒå’Œã€ç»´æŠ¤åºå·å’Œåº”ç­”ç­‰ï¼Œè€Œæ˜¯ç›´æ¥å°†åº”ç”¨å±‚æ•°æ®ä»ä¸€ä¸ªè¿›ç¨‹æ‹·è´åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚

UNIX Domain Socket æä¾› SOCK_DGRAM æˆ– SOCK_STREAM ä¸¤ç§ API æ¥å£ï¼Œç±»ä¼¼äº TCP/UDPï¼Œä½†æ˜¯é¢å‘æ¶ˆæ¯çš„ UNIX Domain Socket ä¹Ÿæ˜¯å¯é çš„ï¼Œæ¶ˆæ¯æ—¢ä¸ä¼šä¸¢å¤±ä¹Ÿä¸ä¼šé¡ºåºé”™ä¹±ã€‚

UNIX Domain Socket ä¸ç½‘ç»œ Web socket ç¼–ç¨‹æœ€æ˜æ˜¾çš„ä¸åŒåœ¨äºåœ°å€æ ¼å¼ä¸åŒï¼Œç”¨ç»“æ„ä½“ sockaddr_un è¡¨ç¤ºã€‚Web socket æ˜¯ IP:Portï¼Œè€Œ UNIX Domain Socket æ˜¯ä¸€ä¸ª socket ç±»å‹çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ç”± bind() è°ƒç”¨åˆ›å»ºã€‚

æœåŠ¡å™¨ç«¯çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. socket - å»ºç«‹ä¸€ä¸ª socketï¼›
2. bind - æ ¹æ® AF_UNIXã€AF_INET é€šä¿¡æ–¹å¼ç»‘å®š socket åˆ°æŸä¸ªæ–‡ä»¶ä¸Šæˆ–æŸä¸ªç«¯å£ä¸Šï¼›
3. listen - å¼€å§‹ç›‘å¬ï¼Œæ¯ç›‘å¬åˆ°æ–°çš„è¿æ¥å°±ä¿å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…¶é•¿åº¦å°±æ˜¯ backlogï¼›
4. accept - å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶æ–°å»ºä¸€ä¸ª socket å¯¹è±¡å’Œå®¢æˆ·è¿›è¡Œé€šä¿¡ï¼›
5. read/write - è¯»å–æˆ–å‘é€æ•°æ®åˆ°å®¢æˆ·ç«¯ï¼›
6. close - é€šä¿¡å®Œæˆåå…³é—­ socketï¼›

å®¢æˆ·ç«¯çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. socket - å»ºç«‹ä¸€ä¸ª socketï¼›
2. connect - æ ¹æ® AF_UNIXã€AF_INET é€šä¿¡æ–¹å¼ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨ç«¯çš„æŸä¸ªæ–‡ä»¶æˆ–æŸä¸ªç«¯å£ï¼›
3. read/write - æœåŠ¡å™¨ accept è¿æ¥åï¼Œè¯»å–æˆ–å‘é€æ•°æ®åˆ°æœåŠ¡å™¨ç«¯ï¼›
4. close - é€šä¿¡å®Œæˆåå…³é—­ socketï¼›

å…³äº Unix Domain Socket çš„åº”ç”¨ï¼Œå‚è€ƒ cluster æ¨¡å—ã€‚


Server å®ç°ï¼š

```
var net = require('net');

var opt = {
    host: '127.0.0.1',
    port: '3000'
};

var server = net.createServer(function(socket){
    socket.write("Hi there!, I'm web server.");
  socket.on('data', (data) => {
    console.log('server roger that: [%s]', data);
  })
    socket.end();
})
.on('error', err => console.log)
// Grab an arbitrary unused port if opt was omitted.
.listen(opt, ()=>{
  console.log('Server listen on', server.address())
});

```

Client å®ç°ï¼š

```
var net = require('net');
var opt = {
    host: '127.0.0.1',
    port: '3000'
};

var socket = net.connect(opt, function(){
    socket.write("Hi! I'm client");
});

socket.on('data', function(data){
    console.log('client roger that: [%s]', data);
    socket.end();
});
```


- é™æ€æ–¹æ³•åŠæˆå‘˜
    - net.connect()
    - net.connect(options[, connectListener])
    - net.connect(path[, connectListener])
    - net.connect(port[, host][, connectListener])
    - net.createConnection()
    - net.createConnection(options[, connectListener])
    - net.createConnection(path[, connectListener])
    - net.createConnection(port[, host][, connectListener])
    - net.createServer([options][, connectionListener])
    - net.isIP(input)
    - net.isIPv4(input)
    - net.isIPv6(input)

- Class: net.Server
    - new net.Server([options][, connectionListener])
    - Event: 'close'
    - Event: 'connection'
    - Event: 'error'
    - Event: 'listening'
    - server.address()
    - server.close([callback])
    - server.connections â›”
    - server.getConnections(callback)
    - server.listen()
    - server.listen(handle[, backlog][, callback])
    - server.listen(options[, callback])
    - server.listen(path[, backlog][, callback])
    - server.listen([port[, host[, backlog]]][, callback])
    - server.listening
    - server.maxConnections
    - server.ref()
    - server.unref()

- Class: net.Socket
    - new net.Socket([options])
    - Event: 'close'
    - Event: 'connect'
    - Event: 'data'
    - Event: 'drain'
    - Event: 'end'
    - Event: 'error'
    - Event: 'lookup'
    - Event: 'ready'
    - Event: 'timeout'
    - socket.address()
    - socket.bufferSize
    - socket.bytesRead
    - socket.bytesWritten
    - socket.connect()
    - socket.connect(options[, connectListener])
    - socket.connect(path[, connectListener])
    - socket.connect(port[, host][, connectListener])
    - socket.connecting
    - socket.destroy([error])
    - socket.destroyed
    - socket.end([data[, encoding]][, callback])
    - socket.localAddress
    - socket.localPort
    - socket.pause()
    - socket.pending
    - socket.ref()
    - socket.remoteAddress
    - socket.remoteFamily
    - socket.remotePort
    - socket.resume()
    - socket.setEncoding([encoding])
    - socket.setKeepAlive([enable][, initialDelay])
    - socket.setNoDelay([noDelay])
    - socket.setTimeout(timeout[, callback])
    - socket.unref()
    - socket.write(data[, encoding][, callback])


# ğŸš© HTTP/HTTPS Web æ¨¡å—
- https://nodejs.org/docs/latest-v9.x/api/http.html#http_class_http_incomingmessage
- https://nodejs.org/docs/latest-v12.x/api/https.html
- https://nodejs.org/en/docs/guides/anatomy-of-an-http-transaction/

http.get(options[, callback])
http.get(url[, options][, callback])
http.request(options[, callback])
http.request(url[, options][, callback])
https.get(options[, callback])
https.get(url[, options][, callback])
https.globalAgent
https.request(options[, callback])
https.request(url[, options][, callback])

HTTP GET è¯·æ±‚

    var http = require('http');
    var options = {
        host: 'www.jinian.com',
        port:80,
        path:'/wxappApi3/debug?debug=1',
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    };
    http.get(options, function(res) {
        var resData = "";
        res.on("data",function(data){
            resData += data;
        });
        res.on("end", function() {
            let json = JSON.parse(resData);
            console.log([resData,JSON.stringify(json,null,'    ')]);
        });
    }).on("error", function (err) {  
        // (err.stack)  
    });  


HTTPS POST è¯·æ±‚

    // var http = require('http');
    var https = require('https');
    var querystring = require('querystring');
    var postData = querystring.stringify({
        'msg' : 'Hello World!'
    });
     
    var options = {
        host: 'oxyxl.xiubao.com',
        port:443,
        path:'/wxappApi2/debug?debug=1',
        method: 'GET',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Length': Buffer.byteLength(postData)
        }
    };
     
    var req = https.request(options, (res) => {
        let headers = JSON.stringify(res.headers,null,'  ');
        console.log(`STATUS: ${res.statusCode}`);
        console.log(`HEADERS: ${headers}`);
        res.setEncoding('utf8');
        let data = "";
        res.on('data', (chunk) => {
            data += chunk;
            // console.log(`BODY: ${chunk}`);
        });
        res.on('end', () => {
            let json = JSON.parse(data);
            console.log( JSON.stringify(json,null,'  ') );
        });
    });
     
    req.on('error', (e) => {
        console.log(`problem with request: ${e.message}`);
    });
     
    // write data to request body
    req.write(postData);
    req.end();


- Class: http.Agent
    - new Agent([options])
    - agent.createConnection(options[, callback])
    - agent.keepSocketAlive(socket)
    - agent.reuseSocket(socket, request)
    - agent.destroy()
    - agent.freeSockets
    - agent.getName(options)
    - agent.maxFreeSockets
    - agent.maxSockets
    - agent.requests
    - agent.sockets
Class: http.ClientRequest
    - Event: 'abort'
    - Event: 'connect'
    - Event: 'continue'
    - Event: 'response'
    - Event: 'socket'
    - Event: 'timeout'
    - Event: 'upgrade'
    - request.abort()
    - request.aborted
    - request.connection
    - request.end([data[, encoding]][, callback])
    - request.flushHeaders()
    - request.getHeader(name)
    - request.removeHeader(name)
    - request.setHeader(name, value)
    - request.setNoDelay([noDelay])
    - request.setSocketKeepAlive([enable][, initialDelay])
    - request.setTimeout(timeout[, callback])
    - request.socket
    - request.write(chunk[, encoding][, callback])
Class: http.Server
    - Event: 'checkContinue'
    - Event: 'checkExpectation'
    - Event: 'clientError'
    - Event: 'close'
    - Event: 'connect'
    - Event: 'connection'
    - Event: 'request'
    - Event: 'upgrade'
    - server.close([callback])
    - server.listen()
    - server.listening
    - server.maxHeadersCount
    - server.setTimeout([msecs][, callback])
    - server.timeout
    - server.keepAliveTimeout
- Class: http.ServerResponse
    - Event: 'close'
    - Event: 'finish'
    - response.addTrailers(headers)
    - response.connection
    - response.end([data][, encoding][, callback])
    - response.finished
    - response.getHeader(name)
    - response.getHeaderNames()
    - response.getHeaders()
    - response.hasHeader(name)
    - response.headersSent
    - response.removeHeader(name)
    - response.sendDate
    - response.setHeader(name, value)
    - response.setTimeout(msecs[, callback])
    - response.socket
    - response.statusCode
    - response.statusMessage
    - response.write(chunk[, encoding][, callback])
    - response.writeContinue()
    - response.writeHead(statusCode[, statusMessage][, headers])
- Class: http.IncomingMessage
    - Event: 'aborted'
    - Event: 'close'
    - message.destroy([error])
    - message.headers
    - message.httpVersion
    - message.method
    - message.rawHeaders
    - message.rawTrailers
    - message.setTimeout(msecs, callback)
    - message.socket
    - message.statusCode
    - message.statusMessage
    - message.trailers
    - message.url

- é™æ€æ–¹æ³•åŠæˆå‘˜
    - http.METHODS
    - http.STATUS_CODES
    - http.createServer([options][, requestListener])
    - http.get(options[, callback])
    - http.globalAgent
    - http.request(options[, callback])

HTTPS API å‚è€ƒï¼š

- Class: https.Agent
    - new Agent([options])
    - Event: 'keylog'

- Class: https.Server
    - server.close([callback])
    - server.headersTimeout
    - server.listen()
    - server.maxHeadersCount
    - server.setTimeout([msecs][, callback])
    - server.timeout
    - server.keepAliveTimeout
    
- é™æ€æ–¹æ³•åŠæˆå‘˜
    - https.createServer([options][, requestListener])
    - https.get(options[, callback])
    - https.get(url[, options][, callback])
    - https.globalAgent
    - https.request(options[, callback])
    - https.request(url[, options][, callback])


## request å°è£…

    function get_file_contents(url, opts){
        let callback = typeof opts==="function"? opts:opts.callback;
        const http = require("http");
        const https = require("https");

        const querystring = require('querystring');
        var postData = querystring.stringify(opts.data||{'msg' : 'Hello World!'});

        var regs = {
            http :  /^http:\/\/([\.\w]+):?(\d+)?(\/.+)/,
            https:  /^https:\/\/([\.\w]+):?(\d+)?(\/.+)/,
            file:  /^file:\/\//,
            local: /^(\/|^\.\/|^\.\.\/|\w+\/|\w:\/)/
        }
        var options = {
            hostname: '127.0.0.1',
            port: 5858,
            path: '/json/list',
            method: 'POST',
            // key: fs.readFileSync('./keys/client.key'), 
            // cert: fs.readFileSync('./keys/client.crt'),
            // ca: [fs.readFileSync('./keys/ca.crt')],
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Content-Length': 0 // Buffer.byteLength(postData)
            }
        };
        for(let p in opts){
            if( p=="callback" || p=="data" ) continue;
            options[p] = opts[p];
        }

        let webRequest = null, ishttp=regs.http.test(url), ishttps=regs.https.test(url);
        if( ishttp || ishttps ){
            console.log([ishttp, ishttps]);
            let m = regs.http.exec(url) || regs.https.exec(url);
            options['hostname'] = m[1];
            options['port'] = m[2]? m[2]:(ishttp? 80:443);
            options['path'] = m[3];
            if( ishttp ) webRequest = http;
            if( ishttps) webRequest = https;
        }
        let req = webRequest.request(options, (res) => {
            var data = "";
            res.setEncoding('utf8');
            res.on("data",function(chunk){ // Uint8Array
                data += chunk;
                // console.log(chunk+"");
            });
            res.on("end", function() {
                try{
                    let json = JSON.parse(data);
                    callback && callback(data, json);
                }catch(e){
                    callback && callback(data, {});
                }
                // document.write(data);
            });
        }).on('error', (e) => {
            console.log(`problem with request: ${e.message}`);
        });
         
        // write data to request body
        req.write(postData);
        req.end();
    }

    // let url = "http://www.jinian.com/wxappApi3/debug?debug=1";
    let url = "https://oxyxl.xiubao.com/wxappApi2/apimobilestarrank?action=vote_star_wxapp";
    let res = get_file_contents(url, (data,json)=>{
        console.log(data);
        console.log(JSON.stringify(json,null,"  "));
    });


## Request æ¨¡å—
https://github.com/mikeal/request

    // JSON.stringify(json,null,"    ")
    function print_r(o,property,indent,level){
        indent = indent||0;
        level = level||0;
        let isobject = typeof(o)==="object";
        if( level>10 ) return isobject? o+"":typeof(o);
        if( !isobject ) return "\""+o+"\"";

        let max = "                                  ";
        let pad = max.substr(0,indent);
        let padsub = max.substr(0,indent+4);
        let f = [];
        // o.test = "\"\'\"\"++++++";

        for( let p in o){
            if( typeof o[p]==="object" ){
                f.push( arguments.callee(o[p], p, indent+4) );
            }else{
                f.push( padsub+"\""+p+"\":\""+(o[p]+"").replace(/\"/g,"\\\"")+"\"" );
            }
        }
        if( f.length ) f[f.length-1] += "\n";
        return pad+(property? "\""+property+"\":":"")+"{\n"+f.join(",\n")+pad+"}";
    }

    var request = require('request');
    request.post('http://www.jinian.com/wxappApi3/debug?debug=1', function (error, response, body) {
        if (!error && response.statusCode == 200) {
            let json = JSON.parse(body);
            // console.log(print_r(json))
            document.write("<pre>"+print_r(json)+"</pre>")
        }
    })


Request â€”â€” è®© Node.js httpè¯·æ±‚å˜å¾—è¶…ç®€å• - æ±Ÿå°æ¹–ã®Blog - https://segmentfault.com/a/1190000000385867

    var request = require('request'), fs = require('fs');
    var img = 'https://gss0.bdstatic.com/7051cy89RcgCncy6lo7D0j9wexYrbOWh7c50/shangcheng/hiv270170.jpg';
    var stream = fs.createWriteStream('deom.jpg');
    request(img).pipe(strema);


ä»»ä½•å“åº”éƒ½å¯ä»¥è¾“å‡ºåˆ°æ–‡ä»¶æµã€‚

    request('http://google.com/doodle.png').pipe(fs.createWriteStream('doodle.png'))

åè¿‡æ¥ï¼Œä¹Ÿå¯ä»¥å°†æ–‡ä»¶ä¼ ç»™PUTæˆ–POSTè¯·æ±‚ã€‚æœªæä¾›headerçš„æƒ…å†µä¸‹ï¼Œä¼šæ£€æµ‹æ–‡ä»¶åç¼€åï¼Œåœ¨PUTè¯·æ±‚ä¸­è®¾ç½®ç›¸åº”çš„content-typeã€‚

    fs.createReadStream('file.json').pipe(request.put('http://mysite.com/obj.json'))

è¯·æ±‚ä¹Ÿå¯ä»¥pipeç»™è‡ªå·±ã€‚è¿™ç§æƒ…å†µä¸‹ä¼šä¿ç•™åŸcontent-typeå’Œcontent-lengthã€‚

    request.get('http://google.com/img.png').pipe(request.put('http://mysite.com/img.png'))

requestæ”¯æŒ application/x-www-form-urlencoded å’Œ multipart/form-data å®ç°è¡¨å•æ–‡ä»¶ä¸Šä¼ ã€‚

x-www-form-urlencodedå¾ˆç®€å•ï¼š

    request.post('http://service.com/upload', {form:{key:'value'}})
    request.post('http://service.com/upload').form({key:'value'})

ä½¿ç”¨multipart/form-dataä¸ç”¨æ“å¿ƒè®¾ç½®headerä¹‹ç±»çš„çäº‹ï¼Œrequestä¼šå¸®ä½ è§£å†³ã€‚

    var r = request.post('http://service.com/upload')
    var form = r.form()
    form.append('my_field', 'my_value')
    form.append('my_buffer', new Buffer([1, 2, 3]))
    form.append('my_file', fs.createReadStream(path.join(__dirname, 'doodle.png'))
    form.append('remote_file', request('http://google.com/doodle.png'))

HTTPè®¤è¯

    request.get('http://some.server.com/').auth('username', 'password', false);
    request.get('http://some.server.com/', {
      'auth': {
        'user': 'username',
        'pass': 'password',
        'sendImmediately': false
      }
    });

sendImmediatelyï¼Œé»˜è®¤ä¸ºçœŸï¼Œæ”¯æŒDigestè®¤è¯ï¼Œå‘é€ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯headerã€‚è®¾ä¸ºfalseä¹‹åï¼Œæ”¶åˆ°401ä¼šé‡è¯•ï¼ˆæœåŠ¡å™¨çš„401å“åº”å¿…é¡»åŒ…å«WWW-AuthenticateæŒ‡å®šè®¤è¯æ–¹æ³•ï¼‰ã€‚

OAuth ç™»å½•

    // Twitter OAuth
    var qs = require('querystring')
      , oauth =
        { callback: 'http://mysite.com/callback/'
        , consumer_key: CONSUMER_KEY
        , consumer_secret: CONSUMER_SECRET
        }
      , url = 'https://api.twitter.com/oauth/request_token'
      ;
    request.post({url:url, oauth:oauth}, function (e, r, body) {
      // Ideally, you would take the body in the response
      // and construct a URL that a user clicks on (like a sign in button).
      // The verifier is only available in the response after a user has
      // verified with twitter that they are authorizing your app.
      var access_token = qs.parse(body)
        , oauth =
          { consumer_key: CONSUMER_KEY
          , consumer_secret: CONSUMER_SECRET
          , token: access_token.oauth_token
          , verifier: access_token.oauth_verifier
          }
        , url = 'https://api.twitter.com/oauth/access_token'
        ;
      request.post({url:url, oauth:oauth}, function (e, r, body) {
        var perm_token = qs.parse(body)
          , oauth =
            { consumer_key: CONSUMER_KEY
            , consumer_secret: CONSUMER_SECRET
            , token: perm_token.oauth_token
            , token_secret: perm_token.oauth_token_secret
            }
          , url = 'https://api.twitter.com/1/users/show.json?'
          , params =
            { screen_name: perm_token.screen_name
            , user_id: perm_token.user_id
            }
          ;
        url += qs.stringify(params)
        request.get({url:url, oauth:oauth, json:true}, function (e, r, user) {
          console.log(user)
        })
      })
    })

å®šåˆ¶ HTTP headerï¼ŒUser-Agentä¹‹ç±»å¯ä»¥åœ¨optionså¯¹è±¡ä¸­è®¾ç½®ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨github APIæ‰¾å‡ºæŸä»“åº“çš„æ”¶è—æ•°å’Œæ´¾ç”Ÿæ•°ã€‚æˆ‘ä»¬ä½¿ç”¨äº†å®šåˆ¶çš„User-Agentå’Œhttps.

    var request = require('request');

    var options = {
        url: 'https://api.github.com/repos/mikeal/request',
        headers: {
            'User-Agent': 'request'
        }
    };

    function callback(error, response, body) {
        if (!error && response.statusCode == 200) {
            var info = JSON.parse(body);
            console.log(info.stargazers_count + " Stars");
            console.log(info.forks_count + " Forks");
        }
    }

    request(options, callback);

é»˜è®¤æƒ…å†µä¸‹ï¼Œcookiesæ˜¯ç¦ç”¨çš„ã€‚åœ¨defaultsæˆ–optionså°†jarè®¾ä¸ºtrueï¼Œä½¿åç»­çš„è¯·æ±‚éƒ½ä½¿ç”¨cookie.

    var request = request.defaults({jar: true})
    request('http://www.google.com', function () {
      request('http://images.google.com')
    })

é€šè¿‡åˆ›å»ºrequest.jar()çš„æ–°å®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨å®šåˆ¶çš„cookieï¼Œè€Œä¸æ˜¯requestå…¨å±€çš„cookie jarã€‚

    var j = request.jar()
    var request = request.defaults({jar:j})
    request('http://www.google.com', function () {
      request('http://images.google.com')
    })

æˆ–è€…

    var j = request.jar()
    var cookie = request.cookie('your_cookie_here')
    j.setCookie(cookie, uri, function (err, cookie){})
    request({url: 'http://www.google.com', jar: j}, function () {
      request('http://images.google.com')
    })

æ³¨æ„ï¼ŒsetCookieè‡³å°‘éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œæœ€åä¸€ä¸ªæ˜¯å›è°ƒå‡½æ•°ã€‚


# ğŸš© HTTP2 Module
- https://nodejs.org/docs/latest-v12.x/api/http2.html

æ ¸å¿ƒå¯¹è±¡ API å‚è€ƒï¼š


- Class: Http2Session
    - Event: 'close'
    - Event: 'connect'
    - Event: 'error'
    - Event: 'frameError'
    - Event: 'goaway'
    - Event: 'localSettings'
    - Event: 'ping'
    - Event: 'remoteSettings'
    - Event: 'stream'
    - Event: 'timeout'
    - http2session.alpnProtocol
    - http2session.close([callback])
    - http2session.closed
    - http2session.connecting
    - http2session.destroy([error][, code])
    - http2session.destroyed
    - http2session.encrypted
    - http2session.goaway([code[, lastStreamID[, opaqueData]]])
    - http2session.localSettings
    - http2session.originSet
    - http2session.pendingSettingsAck
    - http2session.ping([payload, ]callback)
    - http2session.ref()
    - http2session.remoteSettings
    - http2session.setTimeout(msecs, callback)
    - http2session.socket
    - http2session.state
    - http2session.settings([settings][, callback])
    - http2session.type
    - http2session.unref()

- Class: ServerHttp2Session
    - serverhttp2session.altsvc(alt, originOrStream)
    - Specifying alternative services
    - serverhttp2session.origin(...origins)

- Class: ClientHttp2Session
    - Event: 'altsvc'
    - Event: 'origin'
    - clienthttp2session.request(headers[, options])

- Class: Http2Stream
    - Event: 'aborted'
    - Event: 'close'
    - Event: 'error'
    - Event: 'frameError'
    - Event: 'ready'
    - Event: 'timeout'
    - Event: 'trailers'
    - Event: 'wantTrailers'
    - http2stream.aborted
    - http2stream.bufferSize
    - http2stream.close(code[, callback])
    - http2stream.closed
    - http2stream.destroyed
    - http2stream.endAfterHeaders
    - http2stream.id
    - http2stream.pending
    - http2stream.priority(options)
    - http2stream.rstCode
    - http2stream.sentHeaders
    - http2stream.sentInfoHeaders
    - http2stream.sentTrailers
    - http2stream.session
    - http2stream.setTimeout(msecs, callback)
    - http2stream.state
    - http2stream.sendTrailers(headers)

- Class: ClientHttp2Stream
    - Event: 'continue'
    - Event: 'headers'
    - Event: 'push'
    - Event: 'response'

- Class: ServerHttp2Stream
    - http2stream.additionalHeaders(headers)
    - http2stream.headersSent
    - http2stream.pushAllowed
    - http2stream.pushStream(headers[, options], callback)
    - http2stream.respond([headers[, options]])
    - http2stream.respondWithFD(fd[, headers[, options]])
    - http2stream.respondWithFile(path[, headers[, options]])

- Class: Http2Server
    - Event: 'checkContinue'
    - Event: 'connection'
    - Event: 'request'
    - Event: 'session'
    - Event: 'sessionError'
    - Event: 'stream'
    - Event: 'timeout'
    - server.close([callback])
    - server.setTimeout([msecs][, callback])

- Class: Http2SecureServer
    - Event: 'checkContinue'
    - Event: 'connection'
    - Event: 'request'
    - Event: 'session'
    - Event: 'sessionError'
    - Event: 'stream'
    - Event: 'timeout'
    - Event: 'unknownProtocol'
    - server.close([callback])
    - server.setTimeout([msecs][, callback])

- é™æ€æ–¹æ³•åŠæˆå‘˜
    - http2.createServer(options[, onRequestHandler])
    - http2.createSecureServer(options[, onRequestHandler])
    - http2.connect(authority[, options][, listener])
    - http2.constants
    - http2.getDefaultSettings()
    - http2.getPackedSettings([settings])
    - http2.getUnpackedSettings(buf)


å¯¹åº” HTTP ç±»å‹å·®åˆ«ï¼š

- Class: http2.Http2ServerRequest
    - Event: 'aborted'
    - Event: 'close'
    - request.aborted
    - request.authority
    - request.complete
    - request.destroy([error])
    - request.headers
    - request.httpVersion
    - request.method
    - request.rawHeaders
    - request.rawTrailers
    - request.scheme
    - request.setTimeout(msecs, callback)
    - request.socket
    - request.stream
    - request.trailers
    - request.url

- Class: http2.Http2ServerResponse

    - response.stream
    - response.writableEnded
    - response.createPushResponse(headers, callback)

    ## React-materials ç»„ä»¶ UMD å¯¼å‡ºç¤ºä¾‹[Qrcode]
Fusion Next ç»„ä»¶ Github ä»“åº“åœ°å€: https://github.com/alibaba-fusion/next
Iceworks React-materials https://github.com/ice-lab/react-materials
ä½¿ç”¨ Babel é¿å… Webpack ç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ– https://www.jianshu.com/p/2bbc7d50220f
Webpack babel-loader https://github.com/babel/babel-loader
ReactQRCode https://www.npmjs.com/package/react-qrcode
QrCode.React https://www.npmjs.com/package/qrcode.react

ä»¥å¯¼å‡º React Materials çš„ QRCode ç»„ä»¶ä¸ºä¾‹ï¼Œå®ƒåŸºäº QrCode.React å®ç°ï¼ŒQRcode çµ„ä»¶åæ˜¯ IceQrcodeï¼Œå…¶å†…éƒ¨ä»£ç å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š

- é€šè¿‡ Panel.jsx æ–‡ä»¶å°è£… Qrcode.react ç»„ä»¶
- Qrcode.jsx å°è£… Pannel.jsx å¯¼å‡ºä¸º IceQrcode ç»„ä»¶
- IceQrcode å¼•ç”¨äº† @alifd/next çš„ Balloon ç»„ä»¶ä½œä¸ºå¼¹å‡ºç•Œé¢å®ç°
- QrCodeIcon.jsx åˆ™æ˜¯äºŒç»´ç å›¾æ ‡çš„ SVG å®ç°


é¦–å…ˆåˆ›å»º React å·¥ç¨‹ï¼Œå®‰è£…ä¾èµ–æ¨¡å—ï¼š

    npm init
    npm install react react-dom react-scripts
    npm install ice-scripts ice-plugin-fusion
    npm install @alifd/next moment
    npm install @icedesign/qrcode qrcode.react
    npm install node-sass -g
    npm i node-sass -D --verbose

https://github.com/sass/node-sass/releases

æ³¨æ„ Qrcode ç»„ä»¶æ¨¡å—ç›®å½•ä¸‹æä¾›çš„ build æˆ– start è„šæœ¬åœ¨ Windows å¹³å°æœ‰å…¼å®¹é—®é¢˜ï¼Œå‘½ä»¤å¦‚æœä½¿ç”¨äº†ç‚¹å·ç›¸å¯¹è·¯å¾„å°±éœ€è¦ä½¿ç”¨å¼•å·åŒ…æ‹¬ï¼Œå¦åˆ™éœ€è¦ä½¿ç”¨æ­£æ–œæ è¡¨ç¤ºç›®å½•åˆ†å‰²ï¼Œä¸ç„¶è¯†åˆ«ä¸äº†ï¼Œæ‰€ä»¥å°†å‘½ä»¤æˆ–æ–‡ä»¶çš„è·¯å¾„çš„ forward slash / ä¿®æ”¹ä¸ºåæ–œæ  backslash \ã€‚

      "scripts": {
        "start": "../../node_modules/.bin/ice-scripts dev --config ../../ice.component.config.js",
        "build": "../../node_modules/.bin/ice-scripts build --config ../../ice.component.config.js",
        "prepublishOnly": "npm run build"
      },

åœ¨è¿™é‡Œä¸éœ€è¦ä½¿ç”¨è¿™äº›å®˜æ–¹çš„é…ç½®ï¼Œç›´æ¥é€šè¿‡ @icedesign/qrcode çš„å‘è¡Œæ¨¡å—è¿›è¡Œå¯¼å‡ºï¼Œä½†æ˜¯éœ€è¦å®‰è£… Webpack çš„ç›¸å…³ Loadersï¼Œå› ä¸ºå‘å¸ƒçš„ ES æ¨¡å—ä¾èµ–äº† SCSS æ ·å¼æ¨¡å—ï¼š

    npm install style-loader css-loader sass-loader

æ¥ä¸‹æ¥éœ€è¦é…ç½® Webpackï¼Œï¼š

    // webpack.config.js
    module.exports = {
        mode: 'production',
        entry: './node_modules/@icedesign/qrcode/lib/index.js',
        output: {
            filename: '../../js/icedesign-qrcode.min.js',
            // export to AMD, CommonJS, or window
            libraryTarget: 'umd',
            // the name exported to window
            library: 'Qrcode'
        },
        externals: {
            "react": "React",
            "react-dom": "ReactDOM",
            // "@alifd/next/es/balloon": "Balloon",
        },
        module: {
            rules: [{
                test: /\.scss$/,
                use: [{
                    loader: "style-loader"
                }, {
                    loader: "css-loader"
                }, {
                    loader: "sass-loader"
                }]
            }]
        }
    };

æ¥ç€ä½¿ç”¨æ‰“åŒ…å‘½ä»¤å°† ES æ¨¡å—è½¬æ¢æˆ UMD æ¨¡å—ä¾›æµè§ˆå™¨è¿è¡Œï¼š

    $ webpack --config webpack.config.js
    Hash: 2aa97e4f11021824b76f
    Version: webpack 4.0.0
    Time: 15154ms
    Built at: 2019-11-17 0:30:12
                               Asset     Size  Chunks                    Chunk Names
    ../../js/icedesign-qrcode.min.js  434 KiB       0  [emitted]  [big]  main
       [2] external "React" 42 bytes {0} [built]
       [8] external "ReactDOM" 42 bytes {0} [built]
     [196] ./node_modules/@alifd/next/es/balloon/style.js + 3 modules 221 bytes {0} [built]
           |    4 modules
     [197] ./node_modules/@alifd/next/es/balloon/index.js + 34 modules 141 KiB {0} [built]
           |    35 modules
     [199] ./node_modules/moment/locale sync ^\.\/.*$ 3 KiB {0} [optional] [built]
     [200] (webpack)/buildin/module.js 519 bytes {0} [built]
        + 253 hidden modules

    WARNING in asset size limit: The following asset(s) exceed the recommended size limit (244 KiB).
    This can impact web performance.
    Assets:
      ../../js/icedesign-qrcode.min.js (434 KiB)

å› ä¸º Qrcode ç»„ä»¶ä¾èµ–äº† @alifd/next ç»„ä»¶åº“çš„ Balloonï¼Œæ‰“åŒ…å¾—åˆ°çš„ UMD æ¨¡å—æ–‡ä»¶æ¯”è¾ƒå¤§ã€‚Babel å°çµ„ä»¶è½‰è­¯æ™‚ï¼Œå°ä¾è³´è™•ç†ä½¿ç”¨äº†å…©ç¨®æ–¹å¼ï¼š 

    var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
    var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

    var _balloon = _interopRequireDefault(require("@alifd/next/es/balloon"));
    var _react = _interopRequireWildcard(require("react"));

ç”±äº Babel ä½¿ç”¨ Webpack è¿è¡Œæ—¶æ¨¡å—ä¾èµ–æ–¹å¼åŠ è¼‰ä¾è³´ï¼Œé€™è£å°±ä¸èƒ½ç›´æ¥å°‡ Balloon çµ„ä»¶è¨­ç½®åœ¨ externalsï¼Œé€™æœƒå°è‡´å°å…¥ä¸æ­£ç¢ºï¼Œåœ¨æ¥ä¸‹ä¾†çš„çµ„ä»¶å¯¦ä¾‹åŒ–æ™‚å°è‡´ React ç²å–ä¸åˆ°çµ„ä»¶å®šç¾©ã€‚éœ€è¦è¨­ç½®å¥½ Webpack çš„ externalsï¼Œç”¨ Qrcode åŸä»£ç¢¼é‡æ–°ä»¥é‹è¡Œæ™‚ä¾è³´ Balloon çš„æ–¹å¼ç·¨è­¯ã€‚ä¸€å€‹å–å·§çš„åšæ³•æ˜¯ä¿®æ”¹æ¨¡å¡Šä¸­çš„ `_balloon.default` çˆ²å…¨å±€çš„ Balloon ç¬¦è™Ÿï¼š

    return _react.default.createElement("div", {
        className: clazz,
        style: style
    }, _react.default.createElement(_balloon.default, {
        align: this.alignMap[align] || this.alignMap.left,
        closable: false,
        alignEdge: true,
        trigger: trigger || _react.default.createElement(_QrCodeIcon.default, {
            className: triggerClazz,
            style: triggerStyle
        }),
        triggerType: "hover"
    }, content));

æ³¨æ„ğŸ‘â€ğŸ—¨ æ‰“åŒ…åå¾—åˆ°çš„ UMD æ¨¡å—æ˜¯é€šè¿‡ default å¯¼å‡º Qrcode ç»„ä»¶çš„ï¼Œå› æ­¤åœ¨é¡µé¢ä¸­ä½¿ç”¨ç»„ä»¶æ—¶æ³¨æ„æ­£ç¡®å¼•ç”¨ï¼

    let Qrcode = Qrcode.default;
    let {Panel} = Qrcode.Panel;

å¦‚æœä½¿ç”¨ sass æŠ¥é”™ TypeError: this.getResolve is not a function at Object.loaderï¼Œå¯èƒ½æ˜¯ sass ç‰ˆæœ¬å¤ªé«˜äº†å¦‚ sass 8.0.0ï¼Œå¯ä»¥é€šè¿‡å®‰è£…æŒ‡å®š sass ç‰ˆæœ¬è§£å†³ï¼š

    npm install sass-loader@7.3.1

å¦‚æœå…‹éš† Iceworks React-materials çš„ Github æºä»£ç ä»“åº“å¼€å§‹ï¼Œå°±éœ€è¦é… JSX å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨ React å®˜æ–¹æä¾›çš„ create-react-app è„šæ‰‹æ¶å»ºç«‹æ¨¡æ¿å·¥ç¨‹ï¼Œåœ¨è¿›å…¥ä»“åº“çš„æœ¬åœ°ç›®å½•å®‰è£…å„ä¸ªä¾èµ–æ¨¡å—ï¼Œå¹¶é…ç½®ç›¸å…³çš„ Webpack æ¨¡å—å³æ’ä»¶ç­‰ã€‚

é€šè¿‡ babel-preset-react æ”¯æŒ React JSX è¯­æ³• https://www.babeljs.cn/docs/babel-preset-react

    npm install --save-dev @babel/preset-react
    npm install --save-dev babel-loader

å¹¶å°† @babel/preset-react æ·»åŠ åˆ°ä½ çš„ Babel é…ç½®æ–‡ä»¶ä¸­ .babelrcï¼š
    
    {
      "presets": ["env", "stage-0", "react"],
      "plugins": ["transform-runtime"]
    }

æ·»åŠ  babel-loader é…ç½®é¡¹ï¼š
    
    module: {
        rules: [
          { test: /\.js|jsx$/, use: 'babel-loader', exclude: /node_modules/ }
        ]
    }

ä½“éªŒç‰¹æ€§ classProperties éœ€è¦é…ç½®ææ¡ˆç‰¹æ€§æ’ä»¶ plugin-proposal-class-propertiesï¼š

> Syntax error : Support for the experimental syntax 'classProperties' isn't currently enabled

    npm install --save-dev @babel/plugin-proposal-class-properties

ç„¶åé…ç½®åˆ° .babelrc æˆ– webpack.config.jsï¼š

.babelrc æ–‡é…ç½®å¦‚ä¸‹ï¼Œæ³¨æ„ï¼Œåœ¨æ–°ç‰ˆçš„ Babel 7 ä¸­ï¼Œåƒ `preset-2015` è¿™ç§å¸¦å¹´ä»½çš„é¢„ç½®ä¸å†ä½¿ç”¨äº†ã€‚

    {
        "presets": [
            "@babel/preset-env", 
            "@babel/preset-2015", 
            "@babel/preset-react"
        ],
        "plugins": [
            "transform-runtime",
            "@babel/plugin-proposal-class-properties"
        ]
    }


æˆ–ç›´æ¥é…ç½®åˆ° webpack.config.jsï¼š

    module: {
        rules: [
            {
                test: /\.scss$/,
                use: [{
                    loader: "style-loader"
                }, {
                    loader: "css-loader"
                }, {
                    loader: "sass-loader"
                }]
            },
            {
                test: /\.jsx?$/,
                exclude: /(node_modules|bower_components)/,
                // use: 'babel-loader',
                use: {
                    loader: 'babel-loader',
                    options: {
                        presets: [
                            '@babel/preset-env', 
                            '@babel/preset-react'
                        ],
                        plugins: [
                            '@babel/plugin-transform-runtime',
                            '@babel/plugin-proposal-class-properties'
                        ]
                    }
                }
            }
        ]
    }

å¯¼å‡ºæ¨¡å—æ—¶å¶é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œä¸å¯é‡ç°é—®é¢˜ã€‚å³æ˜¯å¼•ç”¨ Balloon ç»„ä»¶ä¸æ­£ç¡®ï¼Œæ‰‹åŠ¨ä¿®æ”¹ä¸€ä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

    createElement(B.Balloon...)




# ğŸš© React + TypeScript + Cropper å›¾ç‰‡è£å‰ªç¤ºä¾‹
- Getting Started with TypeScript and React https://javascriptplayground.com/react-typescript/
- Adding TypeScript https://create-react-app.dev/docs/adding-typescript/
- Cropper.js https://github.com/fengyuanchen/cropperjs
- Cropper as React components http://roadmanfong.github.io/react-cropper/
- react-cropper https://github.com/roadmanfong/react-cropper
- vue-cropperjs https://github.com/Agontuk/vue-cropperjs
- angular-cropper https://github.com/matheusdavidson/angular-cropperjs
- jquery-cropper https://github.com/fengyuanchen/jquery-cropper
- Cropper for jQueryhttps://github.com/fengyuanchen/cropper

Cropper.js æ˜¯ä¸€ä¸ª JavaScript å›¾ç‰‡è£å‰ªåº“ï¼ŒåŸºäºå®ƒå®ç°çš„æœ‰ React ç»„ä»¶ React-Cropperï¼Œä¹Ÿæœ‰åŸºäº Vue å’Œ Angular çš„ç»„ä»¶ï¼Œè¿˜æœ‰åŸºäº jQuery çš„æ’ä»¶ jQuery-Cropperã€‚

æ³¨æ„ react-cropperjs æ˜¯å¦ä¸€å€‹å°è£ç‰ˆæœ¬ï¼Œå’Œ React-Cropper ä¸æ˜¯åŒä¸€å€‹æ¨¡å¡Šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚

å®˜æ–¹é¡¹ç›®ä»£ç å‘å¸ƒç›®å½•æä¾›äº†åŸºæœ¬çš„æ¨¡å—æ‰“åŒ…æ–‡ä»¶ï¼š

    dist/
    â”œâ”€â”€ cropper.css
    â”œâ”€â”€ cropper.min.css   (compressed)
    â”œâ”€â”€ cropper.js        (UMD)
    â”œâ”€â”€ cropper.min.js    (UMD, compressed)
    â”œâ”€â”€ cropper.common.js (CommonJS, default)
    â””â”€â”€ cropper.esm.js    (ES Module)

ç›´æ¥åœ¨é¡µé¢ä¸­å¼•ç”¨ UMD æ¨¡å—å³å¯ä½¿ç”¨ï¼Œä¸ä¾èµ– jQuery ç­‰ï¼Œä»¥ä¸‹æ˜¯ Cropper.js Example

    <!-- Wrap the image or canvas element with a block element (container) -->
    <div>
      <img id="image" src="picture.jpg">
    </div>
    /* Limit image width to avoid overflow the container */
    img {
      max-width: 100%; /* This rule is very important, please do not ignore this! */
    }

    // import 'cropperjs/dist/cropper.css';
    import Cropper from 'cropperjs';

    const image = document.getElementById('image');
    const cropper = new Cropper(image, {
      aspectRatio: 16 / 9,
      crop(event) {
        console.log(event.detail.x);
        console.log(event.detail.y);
        console.log(event.detail.width);
        console.log(event.detail.height);
        console.log(event.detail.rotate);
        console.log(event.detail.scaleX);
        console.log(event.detail.scaleY);
      },
    });

è¿™é‡Œä¸»è¦ä»‹ç» React-Cropper ç»„ä»¶æ¨¡å—çš„ä½¿ç”¨ã€‚

## Installation

ä½¿ç”¨ React è„šæ‰‹æ¶å·¥å…·å‰µå»ºæ¨¡æ¿å·¥ç¨‹ï¼Œä¸¦å®‰è£ä¾è³´æ¨¡å¡Šï¼š

    $ npm install -g create-react-app
    $ create-react-app react-demo
    Creating a new React app in G:\GitHub\React-demo\react-demo.

    Installing packages. This might take a couple of minutes.
    Installing react, react-dom, and react-scripts...

    $ npm install --save react-cropper

è„šæ‰‹æ¶ä¼šè‡ªåŠ¨å®‰è£…æ ¸å¿ƒçš„ä¾èµ–ï¼Œä¸»è¦æ˜¯ React çš„å…©å€‹ä¾è³´åº«å’Œè„šæ‰‹æ¶æ¨¡å¡Šï¼Œåªéœ€è¦å®‰è£ React-Cropper æ¨¡å¡Šå°±å¯ä»¥ç›´æ¥å¼€å§‹å†™ç»„ä»¶äº†ï¼š

    npm install react react-dom react-scripts 

ä¾è³´ cropperjs çš„æ–‡ä»¶ cropper.css å¯ä»¥åœ¨é …ç›®ç›®éŒ„ä¸‹æ‰¾åˆ°ï¼š
- /node_modules/react-cropper/node_modules/cropperjs/dist/cropper.css
- /node_modules/cropperjs/dist/cropper.css

ä½¿ç”¨ create-react-app æ„å»º TypeScript é¡¹ç›®åªéœ€è¦åœ¨å‰µå»ºé …ç›®æ¨¡æ¿æ™‚æŒ‡å®š --typescript åƒæ•¸ï¼Œä»¥ä¸‹å‘½ä»¤é¸å…¶ä¸€åŸ·è¡Œå‰µå»ºæ¨¡æ¿å·¥ç¨‹ï¼š
    
    create-react-app react-demo --typescript
    yarn create react-app react-demo --typescript

å°æ–¼ç¾æœ‰é …ç›®å¼•å…¥ TypeScript éœ€è¦å®‰è£ TypeScript ä¾è³´ï¼Œé‚„æœ‰å„å€‹æ¨¡å¡Šçš„é¡å‹è²æ˜æ–‡ä»¶ï¼Œä»¥ä¸‹å¯é¸ yarn å‘½ä»¤å®‰è£ä¾è³´ï¼š

    npm install --save typescript @types/node @types/react @types/react-dom @types/jest @types/react-cropper
    yarn add typescript @types/node @types/react @types/react-dom @types/jest @types/react-cropper

å†çµ¦ TypeScript å‰µå»º tsconfig.json é…ç½®æ–‡ä»¶ï¼š

    $ tsc --init

é…ç½®æä¾›äº†å„é¸é …çš„æ³¨è§£ï¼Œé€™è£çµ¦ä¸€ä»½ tsconfig.js æ–‡ä»¶é…ç½®åƒè€ƒï¼š

    {
        "compilerOptions": {
            "target": "es5",
            "module": "commonjs",
            "lib": ["dom", "es2015", "es2015.promise"],
            "jsx": "react",
            "sourceMap": true,
            "strict": true,
            "noImplicitAny": true,
            "baseUrl": "src",
            "paths": {
                "@/*": ["./*"],
            },
            "esModuleInterop": true
        },
        "include": [
            "./src/**/*"
        ]
    }

å†å°‡ react-scripts æ¨¡å¡ŠåŒ…ç›®éŒ„å†…æä¾›çš„ template-typescript å·¥ç¨‹æ¨¡æ¿æ‹·è²ä¸€ä»½å³å¯ä½¿ç”¨ TypeScript èªæ³•å¯«çµ„ä»¶äº†ï¼Œæ³¨æ„è¦çµ¦ React-Cropper å®‰è£ TypeScript çš„é¡å‹è²æ˜æ¨¡å¡Šã€‚æ²’æœ‰é¡å‹è²æ˜æ–‡ä»¶ï¼ŒTypeScript æœƒçµ¦ä¸€å€‹éš±å¼é¡å‹éŒ¯èª¤ä¿¡æ¯ implicitly has an 'any' typeï¼Œæˆ–è€…å¦‚æœæ‚¨ä½¿ç”¨äº†--noImplicitAny æˆ–é€šè¿‡ tsconfig.json çš„ noImplicitAny é€‰é¡¹è¿›è¡Œé…ç½®ç‚º false è¡¨ç¤ºè¨±å¯éš±å¼é¡å‹ï¼Œå®ƒä¸ä¼šä¸ºä»»ä½•æœªçŸ¥ç±»å‹æŠ›å‡ºé”™è¯¯ã€‚é€šå¸¸ä½¿ç”¨é»˜èªé…ç½®ï¼Œå³éœ€è¦é¡¯å¼æŒ‡æ˜ç±»å‹æ³¨é‡Šã€‚

    $ npm install --save @types/react-cropper

å®Œæˆé…ç½®åï¼Œå…¥å£æ–‡ä»¶æœƒå¾é»˜èªçš„ index.js æ›´æ”¹ç‚ºé»˜èªçš„ index.tsxï¼Œå†…å®¹åŸºæœ¬ä¸è®Šã€‚å¾ App çµ„ä»¶é–‹å§‹ï¼Œèªæ³•ä¸Šçš„å·®ç•°å°±é–‹å§‹é«”ç¾äº†ï¼Œå¤šäº†çµ„ä»¶çš„é¡å‹è²æ˜ React.FCï¼š

    const App: React.FC = () => {
        // ...
    }

FC å°±æ˜¯å‡½æ•°ç»„ä»¶ FunctionComponentï¼š

    type FC<P = {}> = FunctionComponent<P>;


é—œæ–¼ TypeScript é¡å‹è«‹åƒè€ƒå®˜æ–¹æ–‡æª”ï¼š

- é«˜çº§ç±»å‹ https://www.tslang.cn/docs/handbook/advanced-types.html
- Advanced Types https://www.typescriptlang.org/docs/handbook/advanced-types.html

TypeScript ä½œä¸ºéœæ…‹ç±»å‹è¯­è¨€ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥æä¾›å°½å¯èƒ½ä¸¥æ ¼çš„ç±»å‹æ£€æµ‹ï¼Œåœ¨ç·¨è­¯æœŸåé¥‹éŒ¯èª¤ä¿¡æ¯ï¼Œé–‹å§‹é©æ‡‰æœŸæœƒè¦ºå¾—ä»£ç¢¼å¯«èµ·ä¾†éº»ç…©ã€‚æ‰€ä»¥åŠæ³•æ— éå°±æ˜¯ä½ ä¸Šè¿°æåˆ°çš„ä¸¤ç§ï¼šè¦ä¸åˆ¤æ–­ï¼Œè¦ä¸åŠ ï¼ä½†ä¸ºäº†é«˜å¯ç»´æŠ¤å¯é¢„æµ‹çš„ä»£ç ï¼Œé€‰æ‹©å¦¥åï¼Œä¸ç„¶è¿˜æ˜¯ç”¨å› JavaScriptã€‚


## Quick Example

ç·¨å¯«ä¸€å€‹ Cropper çµ„ä»¶ï¼Œä¸¦åœ¨ App.js ä¸­å¼•å…¥ä½¿ç”¨ï¼š

    import React, {Component} from 'react';
    import Cropper from 'react-cropper';
    import 'cropperjs/dist/cropper.css'; 
    // see installation section above for versions of NPM older than 3.0.0
    // If you choose not to use import, you need to assign Cropper to default
    // var Cropper = require('react-cropper').default

    import Logo from './logo.svg';

    let review = {position:"fixed", right:0, top:0, zIndex:2};

    export default class Demo extends Component {

      state = {src:""}
      ref = React.createRef();

      _crop(){
        let dt = +Date.now();
        if(this.last > dt-1000/30) return; // set 30fps
        this.last = dt;
        console.log("_crop", this.ref);
        if(!this.ref.current) return;
        let imgdata = this.ref.current.getCroppedCanvas().toDataURL();
        this.setState({src: imgdata});
      }

      render() {
        return (
          [
            <img key="1" src={this.state.src} alt="DEMO" style={review}/>,
            <Cropper
              key="2"
              ref={this.ref}
              src={Logo}
              style={{height: 400, width: '100%'}}
              // Cropper.js options
              aspectRatio={16 / 9}
              guides={false}
              crop={this._crop.bind(this)} >
              </Cropper>,
          ]
        );
      }
    }

ä¾‹å­ä½¿ç”¨äº† React.createRef æ¥æ“çºµ React ç»„ä»¶å®ä¾‹å°æ‡‰çš„ DOM å…ƒç´ ï¼Œåƒè€ƒå®˜æ–¹æ–‡æª”é—œæ–¼ Refs çš„éƒ¨åˆ†ã€‚

- Refs and the DOM https://reactjs.org/docs/refs-and-the-dom.html
- Forwarding Refs https://reactjs.org/docs/forwarding-refs.html

æ¯æ¬¡è£å‰ªå‹•ä½œéƒ½æœƒè§¸ç™¼ `_crop()`ï¼Œåœ¨é€™è£é€²è¡Œåœ–åƒæ•¸æ“šçš„ç²å–åŠè½‰æ›ã€‚

## ä»¥ TypeScript é‡å¯«ä¾‹å­

åœ¨é€™è£éœ€è¦è™•ç†ä¸€å€‹æ£˜æ‰‹çš„å•é¡Œï¼Œå°±æ˜¯ React çš„ Refs æ©Ÿåˆ¶ã€‚æ³¨æ„ï¼šReact Refs æ˜¯å€‹é›£é»æŠ€è¡“ï¼Œæ¿«ç”¨ Refs ç‰¹æ€§å¯èƒ½å°è‡´ç¨‹åºçš„ä¸ç©©å®šã€‚

TypeScript ä¸­çš„ `?:` ç¬¦åˆè¡¨ç¤º Nullable typesï¼Œå³å¯ä»¥ä¸º null çš„ç±»å‹ï¼Œå¯é¸é …ã€‚å¦å¤–å°æ–¼ä¸èƒ½ç¢ºå®šé¡å‹çš„å°è±¡ï¼Œç›´æ¥ä½¿ç”¨ any é¡å‹è²æ˜ä¹Ÿæ˜¯ä¸€å€‹é¸æ“‡ï¼Œä¸‡ç‰©çš† Anyã€‚

åœ¨å˜—è©¦ç¢ºå®š ReactCropper ç›¸é—œçš„ React.createRef() è¿”å›é¡å‹çš„éç¨‹ï¼Œæ ¹æ“š TypeScript çµ¦å‡ºäº†ä»¥ä¸‹é¡å‹æç¤ºï¼š

    ref: React.RefObject<Cropper> = React.createRef();

    TypeScript error in C:/crop-demo/src/Cropper.tsx(41,11):
    No overload matches this call.
      Overload 1 of 2, '(props: Readonly<ReactCropperProps>): ReactCropper', gave the following error.
        Type 'RefObject<Cropper>' is not assignable to type 'string | (string & ((cropper: ReactCropper | null) => any)) | (((instance: ReactCropper | null) => void) & string) | (((instance: ReactCropper | null) => void) & ((cropper: ReactCropper | null) => any)) | (RefObject<...> & string) | (RefObject<...> & ((cropper: ReactCropper | null) => any)) | undefined'.
          Type 'RefObject<Cropper>' is not assignable to type 'RefObject<ReactCropper> & ((cropper: ReactCropper | null) => any)'.
            Type 'RefObject<Cropper>' is not assignable to type 'RefObject<ReactCropper>'.
              Type 'Cropper' is missing the following properties from type 'ReactCropper': on, context, setState, forceUpdate, and 4 more.
      Overload 2 of 2, '(props: ReactCropperProps, context?: any): ReactCropper', gave the following error.
        Type 'RefObject<Cropper>' is not assignable to type 'string | (string & ((cropper: ReactCropper | null) => any)) | (((instance: ReactCropper | null) => void) & string) | (((instance: ReactCropper | null) => void) & ((cropper: ReactCropper | null) => any)) | (RefObject<...> & string) | (RefObject<...> & ((cropper: ReactCropper | null) => any)) | undefined'.
          Type 'RefObject<Cropper>' is not assignable to type 'RefObject<ReactCropper> & ((cropper: ReactCropper | null) => any)'.
            Type 'RefObject<Cropper>' is not assignable to type 'RefObject<ReactCropper>'.  TS2769

        39 |         <ReactCropper
        40 |           key="2"
      > 41 |           ref={this.ref}
           |           ^`
        42 |           src={Logo}
        43 |           style={{height: 400, width: '100%'}}
        44 |           // Cropper.js options

é€™å€‹é¡å‹éŒ¯èª¤ä¿¡æ¯æœ‰å¹¾å€‹è¦é»ï¼š

- æœŸæœ›çš„ ref é¡å‹æ˜¯ä¸€é•·ä¸²çš„äº¤å‰ç±»å‹ Intersection Types åŠè¯åˆé¡å‹ Union Typesï¼ŒåŒ…æ‹¬ `((cropper: ReactCropper | null) => any)`
- React Ref é…ç½®å‡½æ•¸æœ‰å…©ç¨®é‡è¼‰æ–¹å¼éŸ¿æ‡‰ `ref={this.ref}`ï¼Œéƒ½æ˜¯è¿”å› ReactCropper å°è±¡ï¼š
    - (props: Readonly<ReactCropperProps>): ReactCropper
    - (props: ReactCropperProps, context?: any): ReactCropper
- ç»„ä»¶æ ‡ç­¾çš„å±æ€§ `ref={this.ref}` æœŸæœ›èµ‹å€¼ä¸€ä¸ª `RefObject<ReactCropper>`

ä¹Ÿå°±æ˜¯èªª React.createRef() è¿”å›çš„æ˜¯ä¸€å€‹äº¤å‰ç±»å‹ Intersection Typesï¼Œå³ & ç¬¦åˆå°†å¤šä¸ªç±»å‹åˆå¹¶ä¸ºä¸€ä¸ªç±»å‹ï¼Œæ»¿è¶³å…¶ä¸­ä¸€å€‹é¡å‹å°±å¯ä»¥ã€‚æ˜é¡¯ï¼Œæœ€ç°¡å–®çœäº‹çš„åšæ³•å°±æ˜¯è¨­ç½® any é¡å‹ï¼Œå°±æ˜¯ä¸ç®¡é¡å‹ã€‚

ä¸éé€™è£å˜—è©¦ä½¿ç”¨å›èª¿å‡½æ•¸ `(cropper: ReactCropper | null) => any`ï¼Œé€™è£çš„ cropper å°±æ˜¯æœªç¶“éå°è£çš„åŸç”Ÿ Cropper.js å°è±¡ï¼Œ`getCroppedCanvas` æ–¹æ³•åœ¨ Cropper.js çš„é¡å‹è²æ˜æ–‡ä»¶å¯ä»¥çœ‹åˆ°ï¼Œè¨˜å¾—ä½¿ç”¨å‘½ä»¤å®‰è£ `npm install --save @types/cropperjs`ã€‚

    ref: React.RefObject<(current: Cropper)=>any> = React.createRef();

    TypeScript error in C:/coding/md/icework/crop-demo/src/Cropper.tsx(26,44):
    Property 'getCroppedCanvas' does not exist on type '(ref: ReactCropper) => any'.  TS2339

        24 |     console.log("_crop", this.ref);
        25 |     if(!this.ref.current) return;
      > 26 |     let imgdata: String = this.ref.current.getCroppedCanvas().toDataURL();
           |                                            ^
        27 |     this.setState({src: imgdata});
        28 |   }
        29 |

é€™å€‹è²æ˜ ref é¡å‹çš„å¯«æ³•æ˜¯ç¬¦åˆ React çš„é¡å‹å®šç¾©äº†ï¼Œä½†æ˜¯åˆå‡ºç¾å¦ä¸€å€‹å•é¡Œï¼Œåœ¨ crop è™•ç†å‡½æ•¸ä¸­ä¸èƒ½æ­£ç¢ºç²å– current çš„å°è±¡é¡å‹ï¼Œå…¶å¯¦ä»–å°± ReactCropper å°è±¡ã€‚å› çˆ² ref è²æ˜çš„é¡å‹æ˜¯å›èª¿å‡½æ•¸ï¼Œè€Œä¸æ˜¯ React.RefObject<Cropper> é¡å‹ã€‚

çµåˆ React çš„é¡å‹è²æ˜ä¾†çœ‹ï¼ŒcreateRef<T>() æ±å‹å‡½æ•¸çš„é¡å‹ T æ˜¯å®šç¾© current å±¬æ€§çš„ï¼Œå¾èª¿ç”¨ current.getCroppedCanvas() é€™å€‹æ–¹æ³•é€™ä¸€é»ä¾†çœ‹ T é¡å‹æ‡‰è©²æ˜¯ä½¿ç”¨ React.js å°è±¡ï¼Œè€Œä¸æ˜¯ä¸Šé¢æåˆ°çš„é‚£ä¸€ä¸²äº¤å‰é¡å‹ï¼Œé€™å°±å’Œ React å†…éƒ¨çš„ Refs å¯¦ç¾æ©Ÿåˆ¶è¡çªäº†ï¼Œäº‹å¯¦ä¸Šï¼ŒReact åœ¨ Refs æ©Ÿåˆ¶çš„è™•ç†ä¸Šæœ‰æ¬ å¦¥å„…ã€‚

    function createRef<T>(): RefObject<T>;

    interface RefObject<T> {
        readonly current: T | null;
    }

React.createRef() å‡½æ•¸å¯¦ç¾ä»£ç¢¼æ¯”è¼ƒç°¡çŸ­ï¼Œå°±æ˜¯è¿”å›ä¸€å€‹ immutable ä¸å¯è®Šå°è±¡ï¼š

    // an immutable object with a single mutable value
    function createRef() {
      var refObject = {
        current: null
      };
      {
        Object.seal(refObject);
      }
      return refObject;
    }

æœ€å¾Œè§£æ±ºæ–¹æ³•æœ‰äºŒå€‹ï¼š

- ä¸€æ˜¯ä½¿ç”¨ any é¡å‹å®šç¾© this.ref å±¬æ€§ï¼Œè·³é TypeScript çš„é¡å‹æª¢æŸ¥æ©Ÿåˆ¶ï¼Œé€™æ˜¯æœ€ç°¡å–®çš„é€ƒé€¸æ³•ã€‚
- äºŒæ˜¯ä½¿ç”¨ TypeScript çš„é¡å‹æ–·è¨€æ©Ÿåˆ¶ Type assertionsï¼Œå°‡ current å±¬æ€§è½‰æ›ç‚º ReactCropper å°è±¡ã€‚

æˆ‘é¸æ“‡çš„åšæ³•æ˜¯äºŒè€…çµåˆï¼Œæ¸¬è©¦äº†å¤šç¨®æ–¹æ³•åå°‡ Cropped çš„å¯¦ä¾‹æ”¹é€ æˆä»¥ä¸‹çš„çµæœï¼Œæä¾›äº† any æ–¹å¼ï¼Œä¹Ÿæä¾›äº† Ref å›èª¿å‡½æ•¸æ–¹å¼ï¼š

    import React, {Component} from 'react';
    import Cropper from 'react-cropper';
    // import Cropper from 'cropperjs';

    // var Cropper = require('react-cropper').default

    import 'cropperjs/dist/cropper.css'; 

    import Logo from './logo.svg';

    let review: React.CSSProperties = {position:"fixed", right:0, top:0, width: "30vw", zIndex:2};

    export default class Demo extends Component {

      instance?: Cropper;
      // ref: any = React.createRef();
      // ref = {current: Cropper};
      ref: React.RefObject<(cuurent: Cropper)=>any> = React.createRef();
      // ref = (cropper:Cropper): {current: Cropper}=>{
      //   // let cropper = new Cropper(new Image());
      //   console.log("ref init", cropper.constructor.name, this.constructor.name);
      //   this.instance = cropper; 
      //   return { current: cropper};
      // };

      state = {src:""};
      last: Number = 0;

      _crop(){
        let dt = +Date.now();
        if(this.last > dt-1000/30) return; // set 30fps
        this.last = dt;
        console.log("do crop", this.instance, this.ref);

        let cropper = (this.ref as unknown as React.RefObject<Cropper>).current!;
        // let cropper = this.instance!;
        let canvas = cropper.getCroppedCanvas();
        let img: String = canvas.toDataURL();
        console.log("do_crop", canvas, img);
        this.setState({src: img});
      }

      render() {
        return (
          [
            <img key="1" src={this.state.src} alt="cropped review" style={review}/>,
            <Cropper
              key="2"
              ref={this.ref as any}
              src={Logo}
              style={{height: 400, width: '100%'}}
              // Cropper.js options
              aspectRatio={16 / 9}
              guides={false}
              crop={this._crop.bind(this)}
               />
              ,
          ]
        );
      }
    }

ä»¥ä¸Šç¤ºä¾‹ä½¿ç”¨äº†ä»¥ä¸‹ TypeScript ç‰¹æ€§ï¼š

- Type assertions é¡å‹æ–·è¨€
- New `unknown` top type for TypeScript 3.0
- Optional ? parameters and properties å¯é€‰å‚æ•°å’Œå¯é€‰å±æ€§
- Type guards ! ç±»å‹ä¿æŠ¤


## ReactCropper UMD æ¨¡å—å¯¼å‡º
https://www.webpackjs.com/configuration/externals/
https://www.webpackjs.com/configuration/output/

ReactCropper é»˜è®¤å‘å¸ƒå¹¶æ²¡æœ‰æä¾› UMD ç­‰æ¨¡å—æ–‡ä»¶ï¼Œåªæ˜¯æä¾›äº† ES6 æ¨¡å—å®šä¹‰æ–‡ä»¶ï¼Œä¸èƒ½ç›´æ¥åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œã€‚è¦åœ¨æµè§ˆå™¨ç›´æ¥ä½¿ç”¨ ReactCropper ç»„ä»¶å°±éœ€è¦å¯¼å‡º ReactCropper UMD æ¨¡å—ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ Cropper.js æ¨¡å—ã€‚å‚è€ƒ Webpack & UMD æ¨¡å—æ‰“åŒ…ã€‚

    "use strict";

    Object.defineProperty(exports, "__esModule", {
      value: true
    });
    exports.default = void 0;

    var ReactCropper =
    /*#__PURE__*/
    function (_Component) {
      ...
      return ReactCropper;
    }(_react.Component);

    ReactCropper.propTypes = {
        ...
    }

    var _default = ReactCropper;
    exports.default = _default;

å¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å°† ReactCropper å‘å¸ƒçš„ ES6 æ¨¡å—æ‰“åŒ…ä¸º UMD æ¨¡å—ï¼Œä½¿ç”¨ ES6 è€Œéæºä»£ç è¿›è¡Œæ‰“åŒ…ï¼Œæœ‰ä¸ªå¥½å¤„ï¼Œå°±æ˜¯ä¸ç”¨é…ç½® React JSX å¼€å‘ç¯å¢ƒï¼Œç›´æ¥æ‰“åŒ…è½¬æ¢ ES æ¨¡å—ä¸º UMD æ¨¡å—å³å¯ï¼š

    webpack  .\node_modules\react-cropper\dist\react-cropper.js -o .\dist\react-cropper.min.js --mode development --output-library-target umd --output-library Cropper

å¦å¤–ï¼Œè¿™æ ·æ‰“åŒ…è¿˜ä¼šå°†ä¾èµ–çš„ React ä¸€èµ·æ‰“åŒ…åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ï¼ŒWebpack æä¾›äº† `externals` é…ç½®é€‰é¡¹ã€Œä»è¾“å‡ºçš„ bundle ä¸­æ’é™¤ä¾èµ–ã€ã€‚æ­¤åŠŸèƒ½é€šå¸¸å¯¹ **library å¼€å‘äººå‘˜** æ¥è¯´æ˜¯æœ€æœ‰ç”¨çš„ï¼Œç„¶è€Œä¹Ÿä¼šæœ‰å„ç§å„æ ·çš„åº”ç”¨ç¨‹åºç”¨åˆ°å®ƒã€‚

    // webpack.config.js
    module.exports = {
        mode: 'production',
        entry: './node_modules/react-cropper/dist/react-cropper.js',
        output: {
            filename: './react-cropper.min.js',
            // export to AMD, CommonJS, or window
            libraryTarget: 'umd',
            // the name exported to window
            library: 'Cropper'
        },
        externals: {
            "react": "React",
            "react-dom": "ReactDOM",
        }
    };

æ‰§è¡Œæ‰“åŒ…å‘½ä»¤æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š

    webpack --config webpack.config.js

æ³¨æ„ğŸ‘â€ğŸ—¨ æ‰“åŒ…åå¾—åˆ°çš„ UMD æ¨¡å—æ˜¯é€šè¿‡ default å¯¼å‡º ReactCropper ç»„ä»¶çš„ï¼Œå› æ­¤åœ¨é¡µé¢ä¸­ä½¿ç”¨ç»„ä»¶æ—¶æ³¨æ„æ­£ç¡®å¼•ç”¨ï¼

    let ReactCropper = Cropper.default;


## ReactCropper ä¸»è¦å¯¹è±¡å‚è€ƒ

    <Cropper
      src='http://fengyuanchen.github.io/cropper/img/picture.jpg'
      aspectRatio={16 / 9} 
      guides={false} 
      crop={this._crop} />

- src
    Type: string
    Default: null

        <Cropper src='http://fengyuanchen.github.io/cropper/img/picture.jpg' />

- alt
    Type: string
    Default: picture
    crossOrigin
    Type: string
    Default: null

- aspectRatio https://github.com/fengyuanchen/cropperjs#aspectratio
- dragMode https://github.com/fengyuanchen/cropperjs#dragmode
- data https://github.com/fengyuanchen/cropperjs#setdatadata
- scaleX https://github.com/fengyuanchen/cropperjs#scalexscalex
- scaleY https://github.com/fengyuanchen/cropperjs#scalexscaley
- enable https://github.com/fengyuanchen/cropperjs#enable
- disable https://github.com/fengyuanchen/cropperjs#disable
- cropBoxData https://github.com/fengyuanchen/cropperjs#setcropboxdatadata
- canvasData https://github.com/fengyuanchen/cropperjs#setcanvasdata
- zoomTo https://github.com/fengyuanchen/cropperjs#zoomto
- moveTo https://github.com/fengyuanchen/cropperjs#moveto
- rotateTo https://github.com/fengyuanchen/cropperjs#rotateto

TypeScript å¯¹è±¡å®šä¹‰

    export interface Options {

        crop?(event: CustomEvent): void;
        cropend?(event: CustomEvent): void;
        cropmove?(event: CustomEvent): void;
        cropstart?(event: CustomEvent): void;
        ready?(event: CustomEvent): void;
        zoom?(event: CustomEvent): void;

        aspectRatio?: number;
        autoCrop?: boolean;
        autoCropArea?: number;
        background?: boolean;
        center?: boolean;
        checkCrossOrigin?: boolean;
        checkOrientation?: boolean;
        cropBoxMovable?: boolean;
        cropBoxResizable?: boolean;
        data?: Data;
        dragMode?: DragMode;
        guides?: boolean;
        highlight?: boolean;
        initialAspectRatio?: number;
        minCanvasHeight?: number;
        minCanvasWidth?: number;
        minContainerHeight?: number;
        minContainerWidth?: number;
        minCropBoxHeight?: number;
        minCropBoxWidth?: number;
        modal?: boolean;
        movable?: boolean;
        preview?: Element | Element[] | NodeList | string;
        responsive?: boolean;
        restore?: boolean;
        rotatable?: boolean;
        scalable?: boolean;
        toggleDragModeOnDblclick?: boolean;
        viewMode?: ViewMode;
        wheelZoomRatio?: number;
        zoomable?: boolean;
        zoomOnTouch?: boolean;
        zoomOnWheel?: boolean;
    }

    declare class Cropper {
        constructor(element: HTMLImageElement | HTMLCanvasElement, options?: Cropper.Options);
        clear(): Cropper;
        crop(): Cropper;
        destroy(): Cropper;
        disable(): Cropper;
        enable(): Cropper;
        getCanvasData(): Cropper.CanvasData;
        getContainerData(): Cropper.ContainerData;
        getCropBoxData(): Cropper.CropBoxData;
        getCroppedCanvas(options?: Cropper.GetCroppedCanvasOptions): HTMLCanvasElement;
        getData(rounded?: boolean): Cropper.Data;
        getImageData(): Cropper.ImageData;
        move(offsetX: number, offsetY?: number): Cropper;
        moveTo(x: number, y?: number): Cropper;
        replace(url: string, onlyColorChanged?: boolean): Cropper;
        reset(): Cropper;
        rotate(degree: number): Cropper;
        rotateTo(degree: number): Cropper;
        scale(scaleX: number, scaleY?: number): Cropper;
        scaleX(scaleX: number): Cropper;
        scaleY(scaleY: number): Cropper;
        setAspectRatio(aspectRatio: number): Cropper;
        setCanvasData(data: Cropper.SetCanvasDataOptions): Cropper;
        setCropBoxData(data: Cropper.SetCropBoxDataOptions): Cropper;
        setData(data: Cropper.SetDataOptions): Cropper;
        setDragMode(dragMode: Cropper.DragMode): Cropper;
        zoom(ratio: number): Cropper;
        zoomTo(ratio: number, pivot?: {x: number; y: number}): Cropper;
        static noConflict(): Cropper;
        static setDefaults(options: Cropper.Options): void;
    }


# ğŸš© Eggjs
https://eggjs.org/en/intro/quickstart.html

Egg is born for building enterprise application and frameworkï¼Œwe hope Egg will give birth to more application framework to help developers and developing team reduce development and maintenance costs.

Features
- Provide capability to customizd framework base on Egg
- Highly extensible plugin mechanism
- Built-in cluster
- Based on Koa with high performance
- Stable core framework with high test coverage
- Progressive development

Koa is a new Web framework designed by the team behind Express, which aims to be a smaller, more expressive, and more robust foundation for Web applications and APIs.

## Initialization

    $ mkdir egg-example && cd egg-example
    $ npm init egg --type=simple

    $ npm i
    $ npm run dev
    $ open http://localhost:7001

Then add npm scripts to package.json.

    {
      "name": "egg-example",
      "scripts": {
        "dev": "egg-bin dev"
      }
    }

## Enable validate plugin

    // config/plugin.js
    exports.validate = {
      enable: true,
      package: 'egg-validate',
    };

## Router Registry

    // app/router.js
    module.exports = app => {
      const { router, controller } = app;
      router.get('/', controller.home.index);
      router.resources('topics', '/api/v2/topics', controller.topics);
    };

## Create a Controller

    // app/controller/home.js
    const Controller = require('egg').Controller;

    class HomeController extends Controller {
      async index() {
        this.ctx.body = 'Hello world';
      }
    }

    module.exports = HomeController;

Then edit the router file and add a mapping.

    // app/router.js
    module.exports = app => {
      const { router, controller } = app;
      router.get('/', controller.home.index);
    };

Then add a configuration file:

    // config/config.default.js
    exports.keys = <YOUR_SECURITY_COOKIE_KEYS>;

The project directory looks like this:

    egg-example
    â”œâ”€â”€ app
    â”‚   â”œâ”€â”€ controller
    â”‚   â”‚   â””â”€â”€ home.js
    â”‚   â””â”€â”€ router.js
    â”œâ”€â”€ config
    â”‚   â””â”€â”€ config.default.js
    â””â”€â”€ package.json

For more information about directory structure, see Directory Structure.

Now you can start up the Web Server and see your application in action.

    $ npm run dev
    $ open http://localhost:7001

Noteï¼š

You could write Controller with class or exports style, see more detail at Controller.
And Config could write with module.exports or exports style, see more detail at Node.js modules docs.

## Adding Static Assets
Egg has a built-in plugin called static. In production, it is recommended that you deploy static assets to CDN instead of using this plugin.

static maps /public/* to the directory app/public/* by default.

In this case, we just need to put our static assets into the directory app/public.

    app/public
    â”œâ”€â”€ css
    â”‚   â””â”€â”€ news.css
    â””â”€â”€ js
        â”œâ”€â”€ lib.js
        â””â”€â”€ news.js

## Adding Templates for Rendering
In most cases, data are usually read, processed and rendered by the templates before being presented to the user. Thus we need to introduce corresponding template engines to handle it.

Egg does not force to use any particular template engines, but specifies the View Plugins Specification to allow the developers to use different plugins for their individual needs instead.

For more information, cf. View.

In this example, we will use Nunjucks.

First install the corresponding plugin egg-view-nunjucks.

    $ npm i egg-view-nunjucks --save

And enable it.

    // config/plugin.js
    exports.nunjucks = {
      enable: true,
      package: 'egg-view-nunjucks'
    };

    // config/config.default.js
    exports.keys = <YOUR_SECURITY_COOKE_KEYS>;
    // add view's configurations
    exports.view = {
      defaultViewEngine: 'nunjucks',
      mapping: {
        '.tpl': 'nunjucks',
      },
    };

Carefully! config dir, not app/config!

Then create a template for the index page. This usually goes to the app/view directory.

    <!-- app/view/news/list.tpl -->
    <html>
      <head>
        <title>Egg HackerNews Clone</title>
        <link rel="stylesheet" href="/public/css/news.css" />
      </head>
      <body>
        <ul class="news-view view">
          {% for item in list %}
            <li class="item">
              <a href="{{ item.url }}">{{ item.title }}</a>
            </li>
          {% endfor %}
        </ul>
      </body>
    </html>

Then add a controller and router.

    // app/controller/news.js
    const Controller = require('egg').Controller;

    class NewsController extends Controller {
      async list() {
        const dataList = {
          list: [
            { id: 1, title: 'this is news 1', url: '/news/1' },
            { id: 2, title: 'this is news 2', url: '/news/2' }
          ]
        };
        await this.ctx.render('news/list.tpl', dataList);
      }
    }

    module.exports = NewsController;

    // app/router.js
    module.exports = app => {
      const { router, controller } = app;
      router.get('/', controller.home.index);
      router.get('/news', controller.news.list);
    };

Open a browser window and navigate to http://localhost:7001/news. You should be able to see the rendered page.

Tipï¼šIn development, Egg enables the development plugin by default, which reloads your worker process when changes are made to your back-end code.

## Create a Service
In practice, controllers usually won't generate data on their own, neither will they contain complicated business logic. Complicated business logic should be abstracted as a busineess logic layer instead, i.e., service.

    Let's create a service to fetch data from the HackerNews.

    // app/service/news.js
    const Service = require('egg').Service;

    class NewsService extends Service {
      async list(page = 1) {
        // read config
        const { serverUrl, pageSize } = this.config.news;

        // use build-in http client to GET hacker-news api
        const { data: idList } = await this.ctx.curl(`${serverUrl}/topstories.json`, {
          data: {
            orderBy: '"$key"',
            startAt: `"${pageSize * (page - 1)}"`,
            endAt: `"${pageSize * page - 1}"`,
          },
          dataType: 'json',
        });

        // parallel GET detail
        const newsList = await Promise.all(
          Object.keys(idList).map(key => {
            const url = `${serverUrl}/item/${idList[key]}.json`;
            return this.ctx.curl(url, { dataType: 'json' });
          })
        );
        return newsList.map(res => res.data);
      }
    }

    module.exports = NewsService;

Egg has HttpClient built in in order to help you make HTTP requests.

Then slightly modify our previous controller.

    // app/controller/news.js
    const Controller = require('egg').Controller;

    class NewsController extends Controller {
      async list() {
        const ctx = this.ctx;
        const page = ctx.query.page || 1;
        const newsList = await ctx.service.news.list(page);
        await ctx.render('news/list.tpl', { list: newsList });
      }
    }

    module.exports = NewsController;

And also add config.

    // config/config.default.js
    // add news' configurations
    exports.news = {
      pageSize: 5,
      serverUrl: 'https://hacker-news.firebaseio.com/v0',
    };

## Adding Extensions
We might encounter a small problem here. The time that we fetched are Unix Time format, whereas we want to present them in a more friendly way to read.

Egg provides us with a quick way to extend its functionalities. We just need to add extension scripts to the app/extend directory. For more information, cf. Extensions.

In the case of view, we can just write a helper as an extension.

    $ npm i moment --save
    // app/extend/helper.js
    const moment = require('moment');
    exports.relativeTime = time => moment(new Date(time * 1000)).fromNow();

Then use it in the templates.

    <!-- app/view/news/list.tpl -->
    {{ helper.relativeTime(item.time) }}

## Adding Middlewares
Suppose that we wanted to prohibit accesses from Baidu crawlers.

Smart developers might quickly guess that we can achieve it by adding a middleware that checks the User-Agent.

    // app/middleware/robot.js
    // options === app.config.robot
    // test demo:
    // curl localhost:7001/news -A "Baiduspider"
    module.exports = (options, app) => {
      return async function robotMiddleware(ctx, next) {
        const source = ctx.get('user-agent') || '';
        const match = options.ua.some(ua => ua.test(source));
        if (match) {
          ctx.status = 403;
          ctx.message = 'Go away, robot.';
        } else {
          await next();
        }
      }
    };

    // config/config.default.js
    // add middleware robot
    exports.middleware = [
      'robot'
    ];
    // robot's configurations
    exports.robot = {
      ua: [
        /Baiduspider/i,
      ]
    };

Now try it using `curl localhost:7001/news -A "Baiduspider"`.

See Middleware for more details.
https://eggjs.org/en/basics/middleware.html

## Adding Configurations
When writing business logic, it is inevitable that we need to manage configurations. Egg provides a powerful way to manage them in a merged configuration file.

Environment-specific configuration files are well supported, e.g. config.local.js, config.prod.js, etc.
Configurations could be set wherever convenient for Applications/Plugins/Framesworks, and Egg will be careful to merge and load them.
For more information on merging, see Configurations.
https://eggjs.org/en/basics/config.html

    // config/config.default.js
    exports.robot = {
      ua: [
        /curl/i,
        /Baiduspider/i,
      ],
    };

    // config/config.local.js
    // only read at development mode, will override default
    exports.robot = {
      ua: [
        /Baiduspider/i,
      ],
    };

    // app/service/some.js
    const Service = require('egg').Service;

    class SomeService extends Service {
      async list() {
        const rule = this.config.robot.ua;
      }
    }

    module.exports = SomeService;

## Exception Handling
https://eggjs.org/en/core/error-handling.html

Taking benefits from framework asynchronous support, all exceptions can be caught by try catch.

With those features, you can take following implementation as reference:

    // app/service/test.js
    try {
      const res = await this.ctx.curl('http://eggjs.com/api/echo', { dataType: 'json' });
      if (res.status !== 200) throw new Error('response status is not 200');
      return res.data;
    } catch (err) {
      this.logger.error(err);
      return {};
    }

Generally, you can use try catch to catch exceptions. However, some implementations may break this mechanism down. Imaging that await makes generators run in order just like a chain. What will happen if one of them jumpoff the chain? The following code can help you realize the imagination:

    // app/controller/home.js
    class HomeController extends Controller {
      async buy () {
        const request = {};
        const config = await ctx.service.trade.buy(request);
        // checking the deal and don't block current request
        setImmediate(() => {
          ctx.service.trade.check(request).catch(err => ctx.logger.error(err));
        });
      }
    }

In this case, you may find that the exceptions in setImmediate will be swallowed because the scope breaks the chain, although egg already handled exceptions externally.

Above scene is also considered. To catch the exception inside the scope, You can invoke helper method ctx.runInBackground(scope) to wrap the chain back. Now, the exceptions will be detected and caught.

    class HomeController extends Controller {
      async buy () {
        const request = {};
        const config = await ctx.service.trade.buy(request);
        // checking the deal and don't block current request
        ctx.runInBackground(async () => {
          // Exceptions thrown here will be caught in background and printed into log.
          await ctx.service.trade.check(request);
        });
      }
    }


## Adding Unit Testing
Unit Testing is very important, and Egg also provides egg-bin to help you write tests painless.

All the test files should be placed at `{app_root}/test/**/*.test.js`.

    // test/app/middleware/robot.test.js
    const { app, mock, assert } = require('egg-mock/bootstrap');

    describe('test/app/middleware/robot.test.js', () => {
      it('should block robot', () => {
        return app.httpRequest()
          .get('/')
          .set('User-Agent', "Baiduspider")
          .expect(403);
      });
    });

Then add npm scripts.

    {
      "scripts": {
        "test": "egg-bin test",
        "cov": "egg-bin cov"
      }
    }

Also install dependencies.

    $ npm i egg-mock --save-dev

Run it.

    $ npm test

That is all of it, for more detail, see Unit Testing. 
https://eggjs.org/en/core/unittest.html


## Conclusions
We can only touch the tip of the iceberg of Egg with the above short sections. Where to go from here? read our documentation to better understand the framework.

- About Egg boilerplate type, See Boilerplate Type Description.
- Egg provides a powerful mechanism for extending features. See Plugin.
- Egg framework allows small or large teams to work together as fast as possible under the well-documented conventions and coding best practices. In addition, the teams can build up logics on top of the framework to better suit their special needs. See more on [Frameworks].(../advanced/framework.md).
- Egg framework provides code reusabilities and modularities. See details at Progressive.
- Egg framework enables developers to write painless unit testing with many plugins and community-powered toolings. The team should give it a try by using Egg unit testing without worrying about setting up the testing tooling but writing the testing logics. See Unit Testing.


# ğŸš© Egg-MySQL
https://eggjs.org/en/tutorials/mysql.html

MySQL is one of the most common and best RDBMS in terms of web applications. It is used in many large-scale websites such as Google and Facebook.

egg-mysql is provided to access both the MySQL databases and MySQL-based online database service.

Install egg-mysql

    $ npm i --save egg-mysql

Enable Plugin:

    // config/plugin.js
    exports.mysql = {
      enable: true,
      package: 'egg-mysql',
    };

Configure database information in config/config.${env}.js

Single Data Source
Configuration to accesss single MySQL instance as shown below:

    // config/config.${env}.js
    exports.mysql = {
      // database configuration
      client: {
        host: 'mysql.com',
        port: '3306',
        user: 'test_user',
        password: 'test_password',
        database: 'test',
      },
      // load into app, default true
      app: true,
      // load into agent, default false
      agent: false,
    };

Use:

    await app.mysql.query(sql, values); // single instance can be accessed through app.mysql

Multiple Data Sources
Configuration to accesss multiple MySQL instances as below:

    exports.mysql = {
      clients: {
        // clientId, obtain the client instances using the app.mysql.get('clientId')
        db1: {
          host: 'mysql.com',
          port: '3306',
          user: 'test_user',
          password: 'test_password',
          database: 'test',
        },
        db2: {
          host: 'mysql2.com',
          port: '3307',
          user: 'test_user',
          password: 'test_password',
          database: 'test',
        },
        // ...
      },
      //default configuration of all databases
      default: {

      },

      // load into app, default true
      app: true,
      // load into agent, default false
      agent: false,
    };

Use:

    const client1 = app.mysql.get('db1');
    await client1.query(sql, values);

    const client2 = app.mysql.get('db2');
    await client2.query(sql, values);

## Dynamic Creation
Pre-declaration of configuration might not needed in the configuration file. Obtaining the actual parameters dynamically from the configuration center then initialize an instance instead.

    // {app_root}/app.js
    module.exports = app => {
      app.beforeStart(async () => {
        // obtain the MySQL configuration from the configuration center
        // { host: 'mysql.com', port: '3306', user: 'test_user', password: 'test_password', database: 'test' }
        const mysqlConfig = await app.configCenter.fetch('mysql');
        app.database = app.mysql.createInstance(mysqlConfig);
      });
    };

## Service Layer
Connecting to MySQL is a data processing layer in the Web layer. So it is strongly recommended that keeping the code in the Service layer.

An example of connecting to MySQL as follows.

Details of Service layer, refer to service

    // app/service/user.js
    class UserService extends Service {
      async find(uid) {
       // assume we have the user id then trying to get the user details from database
        const user = await this.app.mysql.get('users', { id: 11 });
        return { user };
      }
    }
    After that, obtaining the data from service layer using the controller

    // app/controller/user.js
    class UserController extends Controller {
      async info() {
        const ctx = this.ctx;
        const userId = ctx.params.id;
        const user = await ctx.service.user.find(userId);
        ctx.body = user;
      }
    }

Writing CRUD
Following statments default under app/service if not specifed

Create
INSERT method to perform the INSERT INTO query

    // INSERT
    const result = await this.app.mysql.insert('posts', { title: 'Hello World' }); //insert a record title 'Hello World' to 'posts' table

    => INSERT INTO `posts`(`title`) VALUES('Hello World');

    console.log(result);
    =>
    {
      fieldCount: 0,
      affectedRows: 1,
      insertId: 3710,
      serverStatus: 2,
      warningCount: 2,
      message: '',
      protocol41: true,
      changedRows: 0
    }

    // check if insertion is success or failure
    const insertSuccess = result.affectedRows === 1;

Read
Use get or select to select one or multiple records. select method support query criteria and result customization

get one record

    const post = await this.app.mysql.get('posts', { id: 12 });

    => SELECT * FROM `posts` WHERE `id` = 12 LIMIT 0, 1;

query all from the table

    const results = await this.app.mysql.select('posts');

    => SELECT * FROM `posts`;

query criteria and result customization

    const results = await this.app.mysql.select('posts', { // search posts table
      where: { status: 'draft', author: ['author1', 'author2'] }, // WHERE criteria
      columns: ['author', 'title'], // get the value of certain columns
      orders: [['created_at','desc'], ['id','desc']], // sort order
      limit: 10, // limit the return rows
      offset: 0, // data offset
    });

    => SELECT `author`, `title` FROM `posts`
      WHERE `status` = 'draft' AND `author` IN('author1','author2')
      ORDER BY `created_at` DESC, `id` DESC LIMIT 0, 10;

Update
UPDATE operation to update the records of databases

    // modify data and search by primary key ID, and refresh
    const row = {
      id: 123,
      name: 'fengmk2',
      otherField: 'other field value',    // any other fields u want to update
      modifiedAt: this.app.mysql.literals.now, // `now()` on db server
    };
    const result = await this.app.mysql.update('posts', row); // update records in 'posts'

    => UPDATE `posts` SET `name` = 'fengmk2', `modifiedAt` = NOW() WHERE id = 123 ;

    // check if update is success or failure
    const updateSuccess = result.affectedRows === 1;

    // if primary key is your custom id,such as custom_id,you should config it in `where`
    const row = {
      name: 'fengmk2',
      otherField: 'other field value',    // any other fields u want to update
      modifiedAt: this.app.mysql.literals.now, // `now()` on db server
    };

    const options = {
      where: {
        custom_id: 456
      }
    };
    const result = await this.app.mysql.update('posts', row, options); // update records in 'posts'

    => UPDATE `posts` SET `name` = 'fengmk2', `modifiedAt` = NOW() WHERE custom_id = 456 ;

    // check if update is success or failure
    const updateSuccess = result.affectedRows === 1;

Delete
DELETE operation to delete the records of databases

    const result = await this.app.mysql.delete('posts', {
      author: 'fengmk2',
    });

    => DELETE FROM `posts` WHERE `author` = 'fengmk2';

Implementation of SQL statement
Plugin supports splicing and execute SQL statment directly. It can use query to execute a valid SQL statement

Note!! Strongly do not recommend developers splicing SQL statement, it is easier to cause SQL injection!!

Use the mysql.escape method if you have to splice SQL statement

Refer to preventing-sql-injection-in-node-js

    const postId = 1;
    const results = await this.app.mysql.query('update posts set hits = (hits + ?) where id = ?', [1, postId]);

    => update posts set hits = (hits + 1) where id = 1;


## Transaction
Transaction is mainly used to deal with large data of high complexity. For example, in a personnel management system, deleting a person which need to delete the basic information of the staff, but also need to delete the related information of staff, such as mailboxes, articles and so on. It is easier to use transaction to run a set of operations. A transaction is a set of continuous database operations which performed as a single unit of work. Each individual operation within the group is successful and the transaction succeeds. If one part of the transaction fails, then the entire transaction fails. In gerenal, transaction must be atomic, consistent, isolated and durable.

- Atomicity requires that each transaction be "all or nothing": if one part of the transaction fails, then the entire transaction fails, and the database state is left unchanged.
- The consistency property ensures that any transaction will bring the database from one valid state to another.
- The isolation property ensures that the concurrent execution of transactions results in a system state that would be obtained if transactions were executed sequentially
- The durability property ensures that once a transaction has been committed, it will remain so.

Therefore, for a transaction, must be accompanied by beginTransaction, commit or rollback, respectively, beginning of the transaction, success and failure to roll back.

egg-mysql proviodes two types of transactions

## Manual Control
- adventage: beginTransaction, commit or rollback can be completely under control by developer
- disadventage: more handwritten code, Forgot catching error or cleanup will lead to serious bug.

        const conn = await app.mysql.beginTransaction(); // initialize the transaction

        try {
          await conn.insert(table, row1);  // first step
          await conn.update(table, row2);  // second step
          await conn.commit(); // commit the transaction
        } catch (err) {
          // error, rollback
          await conn.rollback(); // rollback after catching the exception!!
          throw err;
        }

Automatic Control: Transaction with Scope
- APIï¼šbeginTransactionScope(scope, ctx)
    - scope: A generatorFunction which will execute all sqls of this transaction.
    - ctx: The context object of current request, it will ensures that even in the case of a nested transaction, there is only one active transaction in a request at the same time.
- adventage: easy to use, as if there is no transaction in your code.
- disadvantage: all transation will be successful or failed, cannot control precisely

        const result = await app.mysql.beginTransactionScope(async conn => {
            // don't commit or rollback by yourself
            await conn.insert(table, row1);
            await conn.update(table, row2);
            return { success: true };
        }, ctx); // ctx is the context of current request, accessed by `this.ctx`  within in service file.
        // if error throw on scope, will auto rollback

## Literal
Use Literal if need to call literals or functions in MySQL

Inner Literal
NOW()ï¼šThe database system time, obtained by app.mysql.literals.now

    await this.app.mysql.insert(table, {
      create_time: this.app.mysql.literals.now,
    });

    => INSERT INTO `$table`(`create_time`) VALUES(NOW())

Custom literal
The following demo showe how to call CONCAT(s1, ...sn) funtion in mysql to do string splicing.

    const Literal = this.app.mysql.literals.Literal;
    const first = 'James';
    const last = 'Bond';
    await this.app.mysql.insert(table, {
      id: 123,
      fullname: new Literal(`CONCAT("${first}", "${last}"`),
    });

    => INSERT INTO `$table`(`id`, `fullname`) VALUES(123, CONCAT("James", "Bond"))





# ğŸš© Express Web æ¡†æ¶å¼€å‘
- ThinkJS Node.js æ¡†æ¶ https://thinkjs.org/doc/index.html
- CmsWing å†…å®¹ç®¡ç†æ¡†æ¶ https://www.cmswing.com/
- [Express/Node å…¥é—¨](https://developer.mozilla.org/zh-CN/docs/Learn/Server-side/Express_Nodejs/Introduction)
- [Express.js API](http://www.expressjs.com.cn/4x/api.html#app.all)
- [Developing template engines](http://www.expressjs.com.cn/advanced/developing_template_engines.html)
- [Node cors package](https://www.npmjs.com/package/cors)
- [Express Middleware](http://www.expressjs.com.cn/resources/middleware.html)
- [Process managers](http://www.expressjs.com.cn/advanced/pm.html)
- [ä½¿ç”¨æ•°æ®åº“ (Mongoose)](https://developer.mozilla.org/zh-CN/docs/Learn/Server-side/Express_Nodejs/mongoose)


## MongoDB æ•°æ®åº“è®¿é—®

Express åº”ç”¨æœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰ä»»ä½•æ•°æ®åº“ç®¡ç†çš„é™„åŠ è¡Œä¸ºæˆ–éœ€æ±‚ï¼Œä½†å¯ä»¥ä½¿ç”¨ Node æ”¯æŒçš„æ‰€æœ‰æ•°æ®åº“ã€‚åŒ…æ‹¬ PostgreSQLã€MySQLã€Redisã€SQLiteã€MongoDB ç­‰ç­‰ã€‚

ä½¿ç”¨æ•°æ®åº“å‰å…ˆè¦ç”¨ NPM æ¥å®‰è£…é©±åŠ¨ç¨‹åºï¼Œå®‰è£…æµè¡Œçš„ NoSQL æ•°æ®åº“ MongoDB çš„é©±åŠ¨ç¨‹åºï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

    npm install mongodb

æ•°æ®åº“å¯ä»¥å®‰è£…åœ¨æœ¬åœ°æˆ–äº‘ç«¯ï¼Œé€šè¿‡ `require()` å¼•å…¥é©±åŠ¨ç¨‹åºï¼Œè¿æ¥ï¼Œç„¶åè¿›è¡Œæ•°æ®æ“ä½œï¼Œæ‰§è¡Œå¢åŠ ã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤å››ç§æ“ä½œï¼ˆCRUDï¼‰ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æŸ¥æ‰¾ MongoDB è¡¨ä¸­ 'å“ºä¹³åŠ¨ç‰©' çš„è®°å½•ï¼š

    // MongoDB 3.0+ required
    const MongoClient = require('mongodb').MongoClient;

    MongoClient.connect('mongodb://localhost:27017/animals', (err, client) => {
      if(err) throw err;
      
      let db = client.db('åŠ¨ç‰©');
      db.collection('å“ºä¹³åŠ¨ç‰©').find().toArray((err, result) => {
        if(err) throw err;
        console.log(result);
        client.close();
      });
    });

é€šè¿‡å¯¹è±¡å…³ç³»æ˜ å°„ ORM Object Relational Mapper é—´æ¥è®¿é—®æ•°æ®åº“çš„æ–¹æ³•ã€‚å¯ä»¥æŠŠæ•°æ®å®šä¹‰ä¸ºå¯¹è±¡æˆ–æ¨¡å‹ï¼Œç„¶åç”± ORM æ ¹æ®ç»™å®šçš„æ•°æ®åº“æ ¼å¼æå®šæ‰€æœ‰æ˜ å°„å…³ç³»ã€‚è¿™ç§æ–¹æ³•äº§ç”ŸåŸç”Ÿå¯¹è±¡ï¼Œæ–¹ä¾¿ JavaScript å¼€å‘è€…ä½¿ç”¨ï¼Œè€Œæ— éœ€ç›´æ¥ä½¿ç”¨æ•°æ®åº“è¯­æ³•ï¼Œå‚è€ƒ [ä½¿ç”¨æ•°æ®åº“ (Mongoose)]ã€‚


## æ¨¡æ¿å¼•æ“ app.engine(ext, callback)

é€šè¿‡ `app.engine()` å¯ä»¥æ³¨å†Œè‡ªå·±çš„æ¨¡æ¿å¼•æ“ï¼Œåªéœ€è¦å°†æ¨¡æ¿å¼•æ“åå­—å’Œå®ç°æ–¹æ³•ä¼ å…¥å³å¯ï¼Œå‚è€ƒ [Express.js API]ã€‚ä»¥ä¸‹è¿™ä¸ªè¶…ç®€æ¨¡æ¿å¼•æ“ extremely simple template engine æ¥è‡ªå®˜æ–¹æ–‡æ¡£ [Developing template engines]ï¼š

    var express = require('express')
    var fs = require('fs')
    var app = express()

    app.engine('ntl', function (filePath, options, callback) {
      fs.readFile(filePath, function (err, content) {
        if (err) return callback(err)
        var rendered = content.toString().replace('#title#', '<title>' + options.title + '</title>')
        .replace('#message#', '<h1>' + options.message + '</h1>')
        return callback(null, rendered)
      })
    })

ç„¶åé€šè¿‡ `set()` è®¾ç½®ä¸ºé»˜è®¤æ¨¡æ¿å¼•æ“ï¼Œä¸€å¹¶è®¾ç½®æ¨¡æ¿æ–‡ä»¶ä¿å­˜ç›®å½•è·¯å¾„ï¼Œè¿˜æœ‰ä¸€ä¸ªç”¨äºæµ‹è¯•çš„æ ¹åœ°å€è·¯ç”±ï¼š

    app.set('views', './views') // specify the views directory
    app.set('view engine', 'ntl') // register the template engine

    app.get('/', function (req, res) {
      res.render('index', { title: 'Hey', message: 'Hello there!' })
    })

ç„¶ååœ¨æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ç›®å½•ä¸­æ–°å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„æ¨¡æ¿æ–‡ä»¶ `index.ntl`ï¼š

    <html>
        <head>
            #title#
        </head>
        <body>
            #message#
        </body>
    </html>

è¿è¡Œä»¥ä¸Šç¨‹åºå¯ä»¥æ£€æŸ¥æ¨¡æ¿å¼•æ“çš„å·¥ä½œæµç¨‹ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒExpress åº”ç”¨æœ‰å¿…è¦é€šè¿‡è¿›ç¨‹ç®¡ç†å·¥å…·æ¥å¢å¼ºè¿è¡Œç¨³å®šæ€§ï¼Œè¿›ç¨‹ç®¡ç†å™¨å°±åƒæ˜¯åº”ç”¨å®¹å™¨ï¼Œé›†ä¸­ä¸ºåº”ç”¨æä¾›ï¼š

+ åº”ç”¨å¡æ­»æ—¶è‡ªåŠ¨é‡å¯ã€‚Restart the app automatically if it crashes.
+ æŒæ¡è¿è¡Œæ—¶æ€§èƒ½å’Œèµ„æºæ¶ˆè€—ã€‚Gain insights into runtime performance and resource consumption.
+ é€šè¿‡ä¿®æ”¹é…ç½®åŠ¨æ€æå‡æ€§èƒ½ã€‚Modify settings dynamically to improve performance.
+ æ§åˆ¶é›†ç¾¤ã€‚Control clustering.

åœ¨ Node.js ç¯å¢ƒä¸‹å¸¸ç”¨çš„è¿›ç¨‹ç®¡ç†å™¨æœ‰å¦‚ä¸‹ï¼š

+ Forever
+ PM2
+ StrongLoop Process Manager
+ SystemD




# ğŸš© Fusion Design ä½“ç³» - æ¨¡å—åŒ–å¤§å·¥ç¨‹å…¸èŒƒ
- Fusion Design ä»‹ç» https://fusion.design/help.html#/fusion-intro
- Fusion Design ä½“ç³» https://blog.csdn.net/weixin_43665351/article/details/86759547
- Fusion Design Next https://github.com/alibaba-fusion/next
- Iceworks React-materials https://github.com/ice-lab/react-materials
- Iceworks å®˜æ–¹æ–‡æ¡£ https://www.bookstack.cn/read/alibaba-ice/docs-iceworks.md
- Iceworks https://ice.work/docs/iceworks/about
- Iceworks ç‰©æ–™å¼€å‘è§„èŒƒ https://www.bookstack.cn/read/alibaba-ice/docs-materials-material-specification.md
- Ant Design è®¾è®¡ä½“ç³» https://ant.design/index-cn

Fusion æ˜¯ä¸€å¥—ä¼ä¸šçº§ä¸­åå°UIçš„è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºè§£å†³è®¾è®¡å¸ˆä¸å‰ç«¯åœ¨äº§å“ä½“éªŒä¸€è‡´æ€§ã€å·¥ä½œååŒã€å¼€å‘æ•ˆç‡æ–¹é¢çš„é—®é¢˜ã€‚é€šè¿‡ååŠ©ä¸šåŠ¡çº¿æ„å»ºè®¾è®¡ç³»ç»Ÿï¼Œæä¾›ç³»ç»ŸåŒ–å·¥å…·ååŠ©è®¾è®¡å¸ˆå‰ç«¯ä½¿ç”¨è®¾è®¡ç³»ç»Ÿï¼Œä¸‹æ¸¸æä¾›ä¸€ç«™å¼è®¾è®¡é¡¹ç›®åä½œå¹³å°ï¼›æ‰“é€šäº’è”ç½‘äº§å“ä»è®¾è®¡åˆ°å¼€å‘çš„å·¥ä½œæµã€‚

Fusion äº§å“åˆ›å»ºäº2015å¹´åº•ï¼Œé˜¿é‡Œå·´å·´é›†å›¢ä¸­å°æˆ˜ç•¥èƒŒæ™¯ä¸‹ï¼Œç”±å›½é™… UEDï¼ˆç°å›½é™…ç”¨æˆ·ä½“éªŒäº‹ä¸šéƒ¨ï¼‰ä¸ B2B æŠ€æœ¯éƒ¨æˆç«‹ä¸­å°DPLé¡¹ç›®ã€‚ä»å›½é™… UEDï¼Œå¤©çŒ«ï¼Œå•†å®¶ç­‰å„ç±»ä¸šåŠ¡å½¢æ€ä¸­æŠ½è±¡è§£æ„ï¼Œé€šè¿‡ä¸€å¥—è®¾è®¡ç³»ç»Ÿåè®®æå‡è®¾è®¡ä¸å¼€å‘æ•ˆç‡ï¼Œä»¥ç»Ÿä¸€çš„ç‰©æ–™åˆ†å‘å·¥å…·æå‡å›¢é˜ŸååŒèƒ½åŠ›ï¼Œå€ŸåŠ©çµæ´»çš„åœ¨çº¿æ ·å¼é…ç½®æ”¯æ’‘ä¸šåŠ¡çš„è®¾è®¡åˆ›æ–°ã€‚

Fusion è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼š

- ä¸åŒå“ç‰Œä¸‹çš„ä¸­å°ç³»ç»Ÿæ„å»ºé—®é¢˜

    å½“ä¸šåŠ¡æ¼”è¿›åˆ° â€œå¹³å°åŒ–ã€å‚ç›´å¸‚åœºã€é‡‡è´­å¸‚åœºâ€ é˜¶æ®µæ—¶ï¼ŒUI ä¹Ÿé¢å¯¹äº†æ›´å¤šçš„é—®é¢˜å’ŒæŒ‘æˆ˜ï¼šâ€œå‘¨æœŸæ€§ä¸šåŠ¡çš„å“ç‰Œæ›´æ–°â€ï¼Œâ€œä¸åŒå“ç‰Œçš„å¤šç§å‚ç›´ä¸šåŠ¡åŒæœŸæ„å»ºâ€ï¼Œâ€œä¼—å¤šç›¸ä¼¼çš„åå°ç³»ç»Ÿæ„å»ºâ€ã€‚

- è®¾è®¡è§„èŒƒä¸€è‡´æ€§é—®é¢˜

    å¦‚ä½•åœ¨å¤šäººåä½œè¿‡ç¨‹ä¸­ä¿éšœè®¾è®¡è§„èŒƒçš„ä¸€è‡´æ€§åœ¨è®¾è®¡å’Œå¼€å‘è€…ä¹‹é—´è½åœ°

- è®¾è®¡/å‰ç«¯çš„è·¨èŒèƒ½åä½œæˆæœ¬é—®é¢˜

    å¦‚æœåœ¨é¡¹ç›®ä¸­å‡å°‘è®¾è®¡å’Œå¼€å‘è€…ä¹‹é—´çš„åä½œã€æ²Ÿé€šæˆæœ¬

Fusion çš„èƒ½åŠ›

- é€šè¿‡æ„å»ºä¸€å¥—æ ‡å‡†åŒ–ä¸­åå°ä½“éªŒè®¾è®¡åŸåˆ™ï¼Œæå‡ä¸­åå°äº§å“ä½“éªŒä¸€è‡´æ€§é—®é¢˜ã€‚
- é€šè¿‡Fusionå¹³å°çš„ä¸»é¢˜é…ç½®èƒ½åŠ›ï¼Œçº¿ä¸Šä¼˜åŒ–å“ç‰Œæ ·å¼å¹¶åŒæ­¥ç‰©æ–™ç»™è®¾è®¡å¸ˆä¸å¼€å‘ä½¿ç”¨ï¼Œåšåˆ°å“ç‰Œæ ·å¼è¿­ä»£0æˆæœ¬ã€‚èŠ‚çœäº†å¤§é‡çš„è®¾è®¡å¸ˆå’Œå¼€å‘å·¥ä½œé‡ã€‚
- è®¾è®¡å¯ç›´æ¥åœ¨sketchï¼ˆé€šè¿‡æ’ä»¶FusionCoolï¼‰ä½¿ç”¨é…å¥½çš„ç»„ä»¶ç”»è®¾è®¡ç¨¿ï¼›å¼€å‘å¯åœ¨æœ¬åœ°å·¥ç¨‹é‡Œé¢ä½¿ç”¨é…å¥½çš„ä¸»é¢˜å¼€å‘é¡¹ç›®ï¼Œä¸éœ€è¦å…³å¿ƒç»„ä»¶æ ·å¼ï¼ˆæœªæ¥ç”šè‡³é¡µé¢æ ·å¼ï¼‰ï¼›ä»è€Œæ‰“ç ´åä½œå£å’ï¼Œè®©åˆä½œæ›´åŠ é¡ºç•…ã€‚
- é€šè¿‡ FusionCool å¯ä»¥ç›´æ¥æ–¹ä¾¿çš„æ²‰æ·€æ¨¡å—æ¨¡æ¿ï¼›é€šè¿‡è„šæ‰‹æ¶å·¥å…·å¯ä»¥æ–¹ä¾¿çš„æ²‰æ·€ä¸šåŠ¡ç»„ä»¶ã€ä»£ç ç«¯ï¼› è®©é¡¹ç›®æ›´å¿«è½åœ°ã€‚

Fusion Design æ˜¯ä¸€ä¸ªè®¾è®¡å¸ˆä¸å·¥ç¨‹å¸ˆçš„åä½œå¹³å°ï¼Œä¸»è¦æœ‰ 4 ä¸ªç»„æˆéƒ¨åˆ†

- Fusion Next ç»„ä»¶åº“ @alifd/nextï¼›
- Fusion Design ç«™ç‚¹ï¼›
- FusionCool Sketch æ’ä»¶ï¼›
- Iceworks GUI å®¢æˆ·ç«¯ï¼ŒåŸºäº Electron å¼€å‘çš„æ¡Œé¢ç«¯å·¥å…·ï¼›

Iceworks æ˜¯é˜¿é‡Œæ¨å‡ºçš„å‰ç«¯æ¡†æ¶ï¼ŒåŸºäºç‰©æ–™çš„ä¸€ç«™å¼å¯è§†åŒ–æºç ç ”å‘å·¥ä½œå°ï¼ŒReact-materials æ˜¯åŸºäº React çš„ç»„ä»¶åº“ï¼Œä½¿ç”¨ ice-script è„šæ‰‹æ¶å·¥å…·è¿›è¡Œæ‰“åŒ…ç®¡ç†ï¼Œç›¸å…³å·¥å…·èµ„æºå¦‚ä¸‹ï¼š

- ice-devtools  ç‰©æ–™å¼€å‘å·¥å…·ï¼Œæ”¯æŒ React&Vue https://ice.work/docs/materials/about
- ice-scripts   åŸºäº webpack çš„é«˜å¯é…ç½®å¼€å‘æ„å»ºå·¥å…· https://ice.work/docs/cli/about
- icestore      åŸºäº React Hooks çš„è½»é‡çº§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ https://github.com/ice-lab/icestore#icestore
- icestark      é¢å‘å¤§å‹åº”ç”¨çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ https://github.com/ice-lab/icestark#icestark
- react-materials   ç”±å®˜æ–¹æä¾›çš„ä¸°å¯Œçš„é«˜è´¨é‡ React ç‰©æ–™ https://ice.work/scaffold
- vue-materials ç”±ç¤¾åŒºç»´æŠ¤çš„é«˜è´¨é‡ Vue ç‰©æ–™ https://ice.work/block?type=vue

ç‰©æ–™ Materials æ˜¯æŒ‡å‰ç«¯é¡¹ç›®ä¸­çš„ç»“æ„å•å…ƒï¼Œç‰©æ–™ä»å°åˆ°å¤§å¯ä»¥åˆ†ä¸º ç»„ä»¶ Componentï¼Œ åŒºå— Blockï¼Œ æ¨¡æ¿ Templateï¼Œå¸ƒå±€ layout ç­‰ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

- ç»„ä»¶ï¼š
    - åŸºç¡€ç»„ä»¶ï¼šåŒä¸€å…¬å¸åŒç±»ä¸šåŠ¡åº”è¯¥åªæœ‰ä¸€å¥—åŸºç¡€ç»„ä»¶ï¼ŒåŸºç¡€ç»„ä»¶éœ€è¦è¶³å¤ŸåŸå­åŒ–ä»¥åŠçµæ´»æ€§ï¼Œæ¯”å¦‚ Button, Menu ç­‰
    - ä¸šåŠ¡ç»„ä»¶ï¼šé¢å‘ä¸šåŠ¡çš„ç»„ä»¶ä½“ç³»ï¼Œä¸€èˆ¬åŠŸèƒ½æ¯”è¾ƒç¡®å®šåŒæ—¶å¤æ‚åº¦è¾ƒé«˜ï¼Œä¸šåŠ¡é‡Œé€šè¿‡ npm ä¾èµ–ä½¿ç”¨ï¼Œä¸å¯éšæ„æ›´æ”¹ä¸šåŠ¡ç»„ä»¶ä»£ç 

- åŒºå—ï¼šä¸ç»„ä»¶ç›¸æ¯”çµæ´»æ€§è¾ƒé«˜ï¼ŒåŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå¯¹åº”ä»£ç é‡ä¹Ÿæ¯”è¾ƒå°‘ï¼Œä¸šåŠ¡é‡Œä¼šå°†åŒºå—çš„ä»£ç å¤åˆ¶åˆ°é¡¹ç›®é‡Œä½¿ç”¨

- æ¨¡æ¿ï¼šæ ·æ¿å·¥ç¨‹ï¼Œé€šå¸¸ä¼šåŒ…å«é€šç”¨çš„å¸ƒå±€ã€å¸¸ç”¨é¡µé¢ã€å·¥ç¨‹é…ç½®ç­‰ï¼Œå¸¸åœ¨åˆå§‹åŒ–é¡¹ç›®æ—¶ä½¿ç”¨


Fusion ä¸»è¦æ˜¯è§£å†³è®¾è®¡å¸ˆå’Œå‰ç«¯å·¥ä½œååŒçš„é—®é¢˜ã€‚ ä¸€èˆ¬ä¸€ä¸ªé¡¹ç›®çš„ä¸Šçº¿æµç¨‹åŸºæœ¬éƒ½è¦ç»å†ï¼Œè¯„å®¡ã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯• è¿™å‡ ä¸ªé˜¶æ®µã€‚é¡¹ç›®ä¸Šçº¿æµç¨‹è€Œå„ä¸ªé˜¶æ®µåˆå¯ä»¥å†æ·±å…¥è¿›å»çš„æ‹†åˆ†ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

- è¯„å®¡ï¼šä¸šåŠ¡äº¤äº’ï¼ˆäº§å“åŠŸèƒ½äº¤äº’ï¼‰ï¼Œä¸šåŠ¡é€»è¾‘çš„è¯„å®¡
- è®¾è®¡ï¼šè®¾è®¡è§„èŒƒï¼ˆè®¾è®¡å¸ˆå¯¹æ•´ä¸ªäº§å“åœ¨è§†è§‰è§„èŒƒä¸Šé¢çš„å®šä¹‰ï¼‰ï¼Œè§†è§‰è®¾è®¡ï¼ˆç»˜åˆ¶è§†è§‰ç¨¿ï¼‰ï¼Œæ ‡æ³¨ç¨¿ï¼ˆäº§å‡ºæ ‡æ³¨æç»™åˆ°å‰ç«¯ï¼‰
- å¼€å‘ï¼šå‰ç«¯ä¸€èˆ¬éƒ½ä¼šæœ‰ä¸€å¥—ç»„ä»¶åº“ï¼›ä½†æ˜¯ç»„ä»¶åº“å¯èƒ½å’Œè‡ªå·±ä¸šåŠ¡çº¿çš„å“ç‰Œå¹¶ä¸æ˜¯å¯¹åº”çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥éœ€è¦åœ¨ç»„ä»¶å±‚é¢åšUIçš„å®šåˆ¶ï¼Œç„¶åæ˜¯ä¸šåŠ¡é€»è¾‘çš„å¼€å‘ã€‚
- æµ‹è¯•ï¼šæœ€å¸¸è§çš„å°±æ˜¯è®¾è®¡å¸ˆå’Œå‰ç«¯ååœ¨ä¸€èµ·ä¸¤å¤©ä¸“é—¨åšUIè¿˜åŸåº¦reviewï¼›ä¸šåŠ¡é€»è¾‘æµ‹è¯•æ˜¯å¿…åšæµç¨‹ä¸å¤šè¯´ã€‚

Fusion Design ä½“ç°å¯ä»¥æ€»ç»“ä¸ºä¸¤ä¸ªç«¯ä¸€ä¸ªå¹³å°ï¼ŒFusion Design å¹³å°é€šè¿‡å®˜ç½‘ https://fusion.design æä¾›å®šåˆ¶è‡ªå·±çš„ Design Systemã€‚ä¸¤ç«¯å°±æ˜¯é¢å‘å¼€å‘è€…å’Œè®¾è®¡è€…çš„ä¸¤ä¸ªå·¥å…·ï¼Œå¼€å‘è€…å·¥å…· Iceworks å’Œè®¾è®¡å¸ˆå·¥å…· FusionCoolã€‚

åœ¨ Fusion Design ä½“ç³»ä¸‹ï¼Œå·¥ç¨‹å¸ˆå’Œè®¾è®¡å¸ˆé…åˆï¼Œç®€å•æ¥è¯´å°± 4 ä¸ªæ­¥éª¤ã€‚

- è®¾è®¡å¸ˆé…ç½®å®Œæˆä¸€ä¸ª Design System å¹¶å‘å¸ƒã€‚è·å¾— Sketch Symbol å’Œ Fusion ç»„ä»¶åº“ä¸»é¢˜åŒ…
- è®¾è®¡å¸ˆä½¿ç”¨ Sketch åˆ›ä½œè®¾è®¡ç¨¿ã€‚
- å·¥ç¨‹å¸ˆå®‰è£… Fusion ç»„ä»¶åº“ ä¸ è®¾è®¡å¸ˆç»™äºˆçš„ ä¸»é¢˜åŒ…ã€‚
- å·¥ç¨‹å¸ˆ Coding å®ç°è®¾è®¡å¸ˆçš„ç¨¿ä»¶ã€‚


## ice-plugin-fusion æ’ä»¶
ice-scripts plugin for fusion https://npm.taobao.org/package/ice-plugin-fusion
ice-plugin-fusion æ’ä»¶è¯¦ç»†ä»‹ç» https://github.com/alibaba/ice/blob/master/docs/cli/plugin-list/fusion.md
Iceworks Plugins https://ice.work/docs/cli/plugin-list/fusion

    npm i --save-dev ice-plugin-fusion

ice-plugin-fusion æ˜¯ Fusion UI ä½“ç³»å¼€å‘ä¸‹å¿…ä¸å¯å°‘çš„æ’ä»¶ã€‚

- ç»„ä»¶æŒ‰éœ€åŠ è½½
- ç»„ä»¶ï¼ˆåŒ…å«ä¸šåŠ¡ç»„ä»¶ï¼‰æ ·å¼è‡ªåŠ¨å¼•å…¥
- ä¸»é¢˜å®šåˆ¶èƒ½åŠ›
- å¤šä¸ªä¸åŒåŒ…åçš„åŸºç¡€ç»„ä»¶ç»Ÿä¸€

Options

themePackage: ä¸»é¢˜åŒ…ï¼Œå¦‚ä½•æ–°å»ºä¸»é¢˜åŒ…è¯·å‚è€ƒæ–‡æ¡£ ä¸»é¢˜é…ç½®ã€‚https://github.com/alibaba/ice/blob/master/docs/guide/dev/theme.md
themeConfig: ä¸»é¢˜é…ç½®
uniteBaseComponent: å¦‚æœé¡¹ç›®é‡Œä¾èµ–äº†å¤šä¸ªä¸åŒåç§°çš„åŸºç¡€åŒ…ï¼Œå¯ä»¥é€šè¿‡ uniteBaseComponent æ¥ç»Ÿä¸€åŸºç¡€åŒ…ï¼Œå‡å°‘é‡å¤çš„ä»£ç ï¼ˆç¤¾åŒºç”¨æˆ·æ— éœ€å…³å¿ƒè¯¥é—®é¢˜ï¼‰
æ³¨æ„ï¼šthemePackage ä¸ themeConfig ä¸­çš„å˜é‡é…ç½®æ˜¯å†²çªçš„ï¼Œä¸¤ç§æ–¹å¼åªèƒ½é€‰æ‹©ä¸€ä¸ªï¼ŒåŸå›  https://github.com/alibaba/ice/pull/1435#issuecomment-460055905

- é»˜è®¤çš„è“è‰²ä¸»é¢˜ï¼š@icedesign/theme
- æ©™è‰²ä¸»é¢˜ï¼š@alifd/theme-ice-orange
- ç»¿è‰²ä¸»é¢˜ï¼š@alifd/theme-ice-green
- ç´«è‰²ä¸»é¢˜ï¼š@alifd/theme-ice-purple

å®‰è£…ä¸»é¢˜åŒ…

    # é¡¹ç›®/æ¨¡æ¿å®‰è£…åœ¨ dependencies é‡Œ
    npm install @icedesign/theme --save

    # åŒºå—/ç»„ä»¶å®‰è£…åœ¨ devDependencies é‡Œ
    npm install @icedesign/theme --save-dev


ä½¿ç”¨ä¸»é¢˜å˜é‡
æ— è®ºæ˜¯ç»„ä»¶ã€åŒºå—ã€æ¨¡æ¿è¿˜æ˜¯ä¸šåŠ¡é¡¹ç›®é‡Œï¼Œåªè¦åœ¨ä»£ç é‡Œæ­£ç¡®çš„ä½¿ç”¨ä¸»é¢˜å˜é‡ï¼Œå°±å¯ä»¥é€šè¿‡ä¸»é¢˜åŒ…çš„é…ç½®å®ç°ä¸€é”®æ¢è‚¤ã€‚

ä½¿ç”¨ä¸»é¢˜ä¸­çš„å˜é‡
åœ¨å¯¹åº” sass æ–‡ä»¶ä¸­ï¼Œå…ˆé€šè¿‡ @import æ–¹å¼å¼•å…¥å˜é‡æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨å…¶ä¸­çš„ sass å˜é‡å³å¯ï¼š

    // å¼•å…¥ä¸»é¢˜å˜é‡
    @import "~@alifd/next/variables.scss";

    // ä½¿ç”¨ä¸»é¢˜å˜é‡
    .title {
      color: $color-brand1-6;
    }

å¯ä»¥ä½¿ç”¨çš„å˜é‡åˆ—è¡¨è¯·å‚è€ƒ fusion.design Design Tokensã€‚

æŒ‰ç…§è¿™ä¸ªæ­¥éª¤ä¹‹åï¼Œåœ¨é¡¹ç›®æ„å»ºæ—¶ï¼Œå°±ä¼šç”¨å¼€å‘è€…é…ç½®çš„ä¸»é¢˜åŒ…è¦†ç›–æ‰é»˜è®¤å˜é‡ï¼Œå®ç°ä¸€é”®æ¢è‚¤çš„èƒ½åŠ›ã€‚

è™½ç„¶ Design Tokens æä¾›äº†å¤§é‡å˜é‡ï¼Œä½†å®é™…åœºæ™¯é‡Œç”¨åˆ°çš„éå¸¸æœ‰é™ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªé‡ç‚¹çš„å˜é‡ï¼š

- $color-brand1-6: å“ç‰Œä¸»è‰²
- $color-brand1-9: æ·±ä¸€ç‚¹çš„å“ç‰Œä¸»è‰²ï¼Œå¸¸ç”¨æ¥ hover æ•ˆæœ
- $color-brand1-1: éå¸¸æµ…çš„å“ç‰Œä¸»è‰²ï¼Œå¸¸ç”¨æ¥æ”¯æŒèƒŒæ™¯é¢œè‰²

Design Tokens å‚è€ƒ https://fusion.design/component/tokens


åŸºç¡€ç”¨æ³•

ç›´æ¥é…ç½®ä¸»é¢˜åŒ… themePackage æˆ–ä¿®æ”¹é…ç½® scss å˜é‡ï¼Œå¦‚ä¸»å“ç‰Œè‰² primaryColorï¼Œice-scripts ç‰ˆæœ¬ 2.0.0 ä»¥ä¸Šï¼Œ1.x ç‰ˆæœ¬è¯·ä½¿ç”¨ themeConfig çš„é…ç½®æ–¹å¼ã€‚


    // ice.config.js
    module.exports = {
      plugins: [
        ['ice-plugin-fusion', {
          // ä¸»é¢˜åŒ…
          themePackage: '@icedesign/theme',
          themeConfig: {
            // è‡ªå®šä¹‰ css prefixï¼Œéœ€è¦é…åˆ ConfigProvider æ›´æ”¹ js çš„ prefix
            nextPrefix: 'nextfd-',
            // æ ¹æ®é…ç½®æ¨å¯¼ä¸»å“ç‰Œè‰²
            primaryColor: '#f60',
            // è¦†ç›– scss åŸå§‹å˜é‡
            'font-size-body-1': '14px',
          },
          // @icedesign/base | @alife/next | @ali/ice -> @alife/next
          uniteBaseComponent: '@alife/next'
        }]
      ]
    }

ä»¥ä¸Šèƒ½åŠ›ä¾èµ–çš„åŸºç¡€ç»„ä»¶ä¸º @alifd/nextï¼Œå¦‚æœä¾èµ–ä½¿ç”¨ `@icedeisgn/base` å®ç°ä¸»é¢˜å®šåˆ¶ï¼Œå®˜æ–¹é»˜è®¤æä¾›ä¸€å¥— @icedesign/skin çš„ä¸»é¢˜åŒ…æ”¯æŒé»˜è®¤ä¸»é¢˜ï¼Œé…ç½®åœ¨ package.json é‡Œçš„ buildConfig.theme å­—æ®µå³å¯ï¼Œé»˜è®¤æ˜¯è“è‰²ç³»ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹çš„è¯åªéœ€è¦åœ¨ package.json é‡ŒåŠ ä»¥ä¸‹å­—æ®µï¼š

    // package.json
    {
      "themeConfig": {
         "primary-color": "#FF6600",
         "secondary-color": "#FF5500"
      }
    }


å­—ä½“å˜é‡é…ç½®

å¦‚æœå¸Œæœ›å°† css ä¸­çš„ç½‘ç»œèµ„æºæœ¬åœ°åŒ–ï¼Œæ¨èä½¿ç”¨ ice-plugin-css-assets-local

@alifd/next ç»„ä»¶åº“é»˜è®¤å¼•ç”¨ä¸¤ç±»å­—ä½“ï¼ŒåŒ…æ‹¬å›¾æ ‡å­—ä½“å’Œ robot åŸºç¡€å­—ä½“ã€‚å­—ä½“åŒ…æ‹¬ Boldï¼ŒLightã€ Mediumã€ Regularã€ Thin å››ç§æ ·å¼ï¼Œeotã€ ttfã€ woffã€ woff2 äº”ç§æ–‡ä»¶æ ¼å¼å…± 20 ä¸ªå­—ä½“æ–‡ä»¶ï¼Œå›¾æ ‡å­—ä½“åˆ™åªæœ‰ä¸€å¥— 4 ä¸ªæ–‡ä»¶æ ¼å¼ï¼Œå¦‚æœå¸Œæœ›å®šåˆ¶è¿™äº›å­—ä½“çš„è·¯å¾„ï¼Œå¯ä»¥å‚ç…§å¦‚ä¸‹é…ç½®ï¼š

    module.exports = {
      plugins: [
        ['ice-plugin-fusion', {
          // ä¸»é¢˜åŒ…
          themePackage: '@icedesign/theme',
          themeConfig: {
            // æ›¿æ¢è¡¨ç¤ºå›¾æ ‡å­—ä½“æ–‡ä»¶è·¯å¾„çš„å˜é‡ï¼Œè·¯å¾„ä¸‹åº”æœ‰å¯¹åº”4ä¸ª iconfont æ–‡ä»¶
            'icon-font-path': '"/font/icon-font-path"',
            // æ›¿æ¢è¡¨ç¤º Roboto å­—ä½“æ–‡ä»¶è·¯å¾„çš„å˜é‡ï¼Œè·¯å¾„ä¸‹åº”æœ‰å¯¹åº”20ä¸ª roboto å­—ä½“æ–‡ä»¶
            'font-custom-path': '"/font/font-path/"',
          },
        }]
      ]
    }

/font/icon-font-path è·¯å¾„ä¸‹å¯¹åº”çš„4ä¸ªå›¾æ ‡å­—ä½“æ–‡ä»¶åˆ†åˆ«ä¸ºï¼šicon-font.eotã€icon-font.woffã€icon-font.ttf å’Œ icon-font.svgã€‚ /font/font-path/ è·¯å¾„ä¸‹å¯¹åº”çš„20ä¸ªå­—ä½“æ–‡ä»¶å¯æŸ¥çœ‹æ‰“åŒ…ä¸‹è½½åœ°å€ï¼šrobot-font.zip

https://files.alicdn.com/tpsservice/31b61ac0c41fac383a1bffd154674347.zip

å¤šä¸»é¢˜é…ç½®
å¤šä¸»é¢˜èƒ½åŠ›åœ¨ç‰ˆæœ¬ 0.1.7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­æ”¯æŒã€‚

å¤šä¸»é¢˜å¸¸è§„çš„å®ç°æ€è·¯å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š

- å‡†å¤‡ä¸åŒä¸»é¢˜çš„ css
- é€šè¿‡ js åŠ¨æ€åŠ è½½å¯¹åº”çš„ä¸»é¢˜ css
- è€Œå‰ç«¯å·¥ç¨‹åŒ–çš„å¦‚ä»Šï¼Œå¾ˆå¤šåŸºæœ¬ä¾èµ–çš„ç»„ä»¶åº“æœ¬èº«å¸¦æœ‰å¯é…ç½®çš„ä¸»é¢˜å˜é‡,æ¯”å¦‚ fusionï¼Œç”Ÿæˆå¤šä»½ä¸»é¢˜æ„å‘³ç€éœ€è¦æå‰æ‰“åŒ…å‡ºå¤šä»½ä¸åŒçš„ä¸»é¢˜æ–‡ä»¶ï¼Œå¯¹äºå‰ç«¯å·¥ç¨‹çš„è°ƒè¯•å’Œæ„å»ºéƒ½å¸¦æ¥æå¤§çš„å¤„ç†æˆæœ¬ã€‚

ice-plugin-fusion ç»“åˆ fusion è‡ªèº«å¯ä»¥é…ç½®ä¸»é¢˜åŒ…çš„èƒ½åŠ›ï¼Œæ”¯æŒå¤šä¸ªä¸»é¢˜åŒ…çš„é…ç½®ï¼Œå¤§å¤§ç®€åŒ–å¤šä¸»é¢˜åˆ‡æ¢çš„æˆæœ¬ï¼Œé€šè¿‡ css å˜é‡èƒ½åŠ›å®ç°åŠ¨æ€ä¸»é¢˜çš„åˆ‡æ¢ï¼Œæ ¸å¿ƒå®ç°æ€è·¯å¦‚ä¸‹ï¼š

- æå–ä¸»é¢˜åŒ…ä¸­çš„ scss å˜é‡ï¼ˆè‰²å€¼å˜é‡ï¼‰
- å°† scss å˜é‡å…·ä½“å†…å®¹è½¬æ¢ä¸º css å˜é‡ï¼Œå³ $color-brand1-1: #E2EDFF; => $color-brand1-1: var(--color-brand-1);
- æ³¨å…¥æ–°çš„ scss å˜é‡å€¼ï¼ˆå¦‚ $color-brand1-1: var(--color-brand-1) ï¼‰è¿›è¡Œç¼–è¯‘
- åœ¨ window ä¸‹æ³¨å…¥ `__changeTheme__` æ–¹æ³•ï¼Œå®ç°ä¸åŒä¸»é¢˜åŒ…å…¨å±€ css å˜é‡å£°æ˜çš„åˆ‡æ¢

    module.exports = {
      plugins: [
        ['ice-plugin-fusion', {
          // é€šè¿‡æ•°ç»„æ–¹å¼é…ç½®å¤šä¸»é¢˜åŒ…
          themePackage: [{
            name: '@icedesign/theme',
            // è®¾ç½®é»˜è®¤åŠ è½½ä¸»é¢˜ï¼Œå¦‚æœä¸è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤ä»¥æœ€åæ·»åŠ ä¸»é¢˜åŒ…ä½œä¸ºé»˜è®¤ä¸»é¢˜
            default: true,
            // è®¾ç½®è‡ªå®šä¹‰ä¸»é¢˜é¢œè‰²ï¼Œå¯ä»¥åœ¨ scss æ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨è¯¥å˜é‡ï¼Œæ¯”å¦‚ï¼š .bg-color { background: $custom-color; }
            themeConfig: {
              'custom-color': '#000',
            },
          }, {
            name: '@alifd/theme-ice-purple',
            themeConfig: {
              'custom-color': '#fff',
            },
          }],
        }]
      ]
    }

ice.config.js ä¸­å®Œæˆå¤šä¸»é¢˜åŒ…é…ç½®åï¼Œä¸šåŠ¡ä»£ç ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ __changeTheme__ æ–¹æ³•åœ¨å¤šä¸ªä¸»é¢˜åŒ…ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼š

    // å¯ä»¥åœ¨è®¾ç½®çš„ä¸»é¢˜åŒ… @icedesign/theme å’Œ @alifd/theme-ice-purple ä¹‹é—´åˆ‡æ¢
    window.__changeTheme__('@alifd/theme-ice-purple');



## Fusion Next ç»„ä»¶
Fusion Next ç»„ä»¶å¿«é€Ÿä¸Šæ‰‹ https://fusion.design/help.html#/next-start


@alifd/next æ˜¯ Fusion Design ä¸­çš„é¢å‘ PC ç«¯å¯é…ç½®ç»„ä»¶åº“ï¼ŒåŸºäº React å®ç°ï¼Œæ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨å’Œ IE9+, å†…éƒ¨ç§°ä¹‹ä¸ºéª¨æ¶ DPL - Design Pattern Libraryã€‚

Github ä»“åº“åœ°å€: https://github.com/alibaba-fusion/next
æ–‡æ¡£è§: https://fusion.design/component

åŸºäº Nextï¼Œé€šè¿‡å®˜æ–¹æä¾›çš„ Iceworks GUI å·¥å…·å’Œ ice-scripts è„šæ‰‹æ¶å·¥å…·å¯ä»¥å¿«é€Ÿå¤ç”¨ Iceworks çš„æ¨¡æ¿å·¥ç¨‹ã€‚é€è¿‡ Iceworksï¼Œé˜¿é‡Œ Fusion Design ä½“ç°é¢å‘å¼€å‘è€…æä¾›äº†å¼ºå¤§çš„æ¡†æ¶ã€‚

ç®€å•å®‰åˆ©ä¸€ä¸‹ Fusion ç»„ä»¶çš„åŸºæœ¬ç‰¹æ€§ï¼š

- ç»„ä»¶ä¸°å¯Œ 50+ ä¸ªç»„ä»¶,è¦†ç›–ç»å¤§å¤šæ•°åœºæ™¯ä½“ç§¯å° next.min.js 702 KB
- next.min.css 337 KB
- ç»„ä»¶å•æµ‹è¦†ç›–ç‡è¿‘ 90%

å½“ç„¶,æ‹¥æœ‰ä»¥ä¸Šçš„ç‰¹æ€§åªèƒ½ä¿è¯ Fusion ç»„ä»¶å¯ä»¥æ”¾å¿ƒåœ°ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ,ä¸è¾“ä»»ä½•ç°æœ‰çš„ä¸»æµç»„ä»¶åº“çš„ä½“éªŒã€‚

Fusion Next æ˜¯åŸºäº React å®ç°çš„ä¸€å¥— PC ç«¯çš„ç»„ä»¶åº“ï¼Œè¿™å¥—ç»„ä»¶åº“å·²ç»åœ¨é˜¿é‡Œå†…éƒ¨æœåŠ¡äº†ä¸‰å¹´ã€‚è¿™æ¬¡å¼€æºå‡ºæ¥çš„ç‰ˆæœ¬æ˜¯æœ€è¿‘ä¸€å¹´åŸºäºä¹‹å‰ä¸¤å¹´çš„ä½¿ç”¨ç»éªŒã€é—®é¢˜åé¦ˆè¿›è¡Œé‡æ–°æ•´ç†å’Œä¼˜åŒ–è¿‡ã€‚å…·å¤‡ä»¥ä¸‹ç‰¹æ€§

- æ˜“ç”¨æ€§

    å¯¹æ¯”ä¸Šä¸€ä¸ªç‰ˆæœ¬ 80 + åŠŸèƒ½ï¼Œè¿›è¡Œ 300+ ä¼˜åŒ–ï¼Œç»„ä»¶æ•´ä½“ä»£ç ä½“ç§¯å´å‡å°30%

    next.min.js 910KB -> 702KB
    next.min.css 428KB -> 337KB

    ä¸€å…± 50+ç»„ä»¶ï¼Œæ‰“åŒ…ä¸‹æ¥å´åªæœ‰ 700 å¤šKï¼Œè¿™ä¸ªç›®å‰åœ¨ä¸šç•Œæ¯”è¾ƒå°‘ç»„ä»¶æœ‰èƒ½åŠ›åšåˆ°è¿™ç‚¹ã€‚ç»„ä»¶ä¹‹é—´ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œå¤ç”¨åº¦é«˜ä¹Ÿæ˜¯ä½“ç§¯å°çš„åŸå› ã€‚

- ç¨³å®šæ€§

    ç»„ä»¶å•æµ‹è¦†ç›–ç‡è¿‘90%ï¼Œæä¾›æœåŠ¡ä»¥æ¥æ²¡æœ‰äº§ç”Ÿè¿‡èµ·çº¿ä¸Šäº‹æ•…ã€‚

- èƒ½åŠ›å¢å¼º

    å›½é™…åŒ–ã€RTLã€æ— éšœç¢èƒ½åŠ›å…¨é¢æ”¯æŒã€‚

å¦å¤–é’ˆå¯¹ä¸­åå°è¡¨å•å¤§æ•°æ®é‡åœºæ™¯åšäº†å¤§é‡æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”å¦‚æ™®é€š table éšç€æ•°æ®ä¸æ–­å¢é•¿ render ä¼šè¶Šæ¥è¶Šæ…¢ã€‚

é¡µé¢éšèŠ‚ç‚¹ä¸ªæ•°å¢é•¿æ¶ˆè€—çš„æ—¶é—´

Next å¼•å…¥äº† virtual-list ï¼Œç›®å‰ç”¨åœ¨äº† table å’Œ select è¿™ä¸¤ä¸ªä½¿ç”¨é¢‘ç‡è¾ƒé«˜çš„ç»„ä»¶ã€‚å› ä¸ºåœ¨å¤§æ•°æ®é‡(æµ‹è¯•è¿‡1wèŠ‚ç‚¹ï¼‰ä¸‹åªæ¸²æŸ“éœ€è¦å±•ç¤ºçš„èŠ‚ç‚¹ï¼ˆæ¯”å¦‚20ä¸ªï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å°†æ¸²æŸ“æ—¶é•¿æ°¸è¿œçš„æ§åˆ¶åœ¨ 0.3s ä¹‹å†…ã€‚
å¦å¤–, Fusion ç»„ä»¶çš„æ€æ‰‹é”,æœ€å¼ºå¤§çš„ä¸€ä¸ªèƒ½åŠ›ã€‚


1.ä½¿ç”¨ npm å®‰è£…(æ¨è)

    npm install @alifd/next --save

2.æµè§ˆå™¨ç›´æ¥å¼•ç”¨

åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ script å’Œ link æ ‡ç­¾ç›´æ¥å¼•å…¥æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å…¨å±€å˜é‡ Nextã€‚æˆ‘ä»¬åœ¨ npm åŒ…ä¸­æä¾›äº† @alifd/next/dist ç›®å½•ä¸‹çš„ next.js/next.min.js å’Œ next.css/next.min.css ç­‰æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ unpkg æˆ–è€…jsDelivrè¿›è¡Œä¸‹è½½ã€‚jsDelivrç½‘å®¿æœ‰åˆä½œ,æ¨èå¤§é™†ç”¨æˆ·ä½¿ç”¨

å¼€å‘ç¯å¢ƒæ¨èä½¿ç”¨æœªå‹ç¼©çš„ç‰ˆæœ¬,æ–¹ä¾¿é”™è¯¯è°ƒè¯•:

    // alifd cdn
    <link rel="stylesheet" href="https://alifd.alicdn.com/npm/@alifd/next/{ç‰ˆæœ¬å·}/next.css">
    <script src="https://alifd.alicdn.com/npm/@alifd/next/{ç‰ˆæœ¬å·}/next.js"></script>

    // jsDelivr 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@alifd/next/dist/next.css">
    <script src="https://cdn.jsdelivr.net/npm/@alifd/next/dist/next.js"></script>

    // unpkg 
    <link rel="stylesheet" href="https://unpkg.com/@alifd/next/dist/next.css">
    <script src="https://unpkg.com/@alifd/next/dist/next.js"></script>


ç”Ÿäº§ç¯å¢ƒæ¨èå¼•å…¥å›ºå®šç‰ˆæœ¬ä¸”å‹ç¼©è¿‡çš„nextç»„ä»¶,ä»¥ä¿è¯ä»£ç ç¨³å®šå¹¶æé«˜åŠ è½½é€Ÿåº¦:

    // alifd cdn
    <link rel="stylesheet" href="https://alifd.alicdn.com/npm/@alifd/next/1.11.6/next.min.css">
    <script src="https://alifd.alicdn.com/npm/@alifd/next/1.11.6/next.min.js"></script>

    // jsDelivr
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@alifd/next/1.11.6/next.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@alifd/next/1.11.6/next.min.js"></script>

    // unpkg 
    <link rel="stylesheet" href="https://unpkg.com/@alifd/next@1.11.6/dist/next.min.css">
    <script src="https://unpkg.com/@alifd/nextnext@1.11.6/dist/next.min.js"></script>


ä¾èµ–

@alifd/next åŸºäº react@16 å¼€å‘ï¼Œç›®å‰å¹¶ä¸å…¼å®¹ react@15 åŠå…¶ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œä¸”å°† react/react-dom ä½œä¸º peerDependenciesï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æå‰å®‰è£…æˆ–å¼•å…¥ã€‚
@alifd/next åœ¨å¤„ç†æ—¥æœŸæ—¶é—´ç›¸å…³ç»„ä»¶é€»è¾‘æ—¶ï¼Œä½¿ç”¨äº† moment åº“ï¼Œä¸”å°† moment ä½œä¸º peerDependenciesï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æå‰å®‰è£…æˆ–å¼•å…¥ã€‚

å…¨é‡å¼•å…¥

    import '@alifd/next/dist/next.css';
    // import '@alifd/next/index.scss';

    import { Button, Input } from '@alifd/next';

æ‰‹åŠ¨æŒ‰éœ€å¼•å…¥

    import Button from '@alifd/next/lib/button';
    import '@alifd/next/lib/button/style';

ä¼˜ç‚¹ï¼šæŒ‰éœ€å¼•å…¥ js ä»£ç ã€æ ·å¼ä»£ç ï¼Œä¸ä¼šåŠ è½½ä¸å¿…è¦çš„ç»„ä»¶
ç¼ºç‚¹ï¼šä½¿ç”¨èµ·æ¥è¿‡äºç¹çï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ æ¯ä¸€ä¸ªç”¨åˆ°çš„ç»„ä»¶ js ä»£ç åŠæ ·å¼


ä½¿ç”¨ babel-plugin-import (æ¨è)

é€šè¿‡ babel-plugin-import æ’ä»¶ï¼Œå¯ä»¥å°†ä¸‹é¢çš„ä»£ç 

    import { Button } from '@alifd/next';

è½¬åŒ–ä¸ºç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š

    import Button from '@alifd/next/lib/button';
    import '@alifd/next/lib/button/style';

babel é…ç½®ï¼š

    // webpack babel loader option or .babelrc
    {
        // ...
        plugins: [
            [
                'babel-plugin-import',
                {
                    libraryName: '@alifd/next',
                    style: true,
                },
            ],
        ];
    }


å‘å¸ƒå‘¨æœŸ

éµå¾ª Semantic Versioning 2.0.0 è¯­ä¹‰åŒ–ç‰ˆæœ¬ç®¡ç†ç­–ç•¥ï¼š
- z ä½ï¼šæ¯å‘¨ä¸‰ä¼šè¿›è¡Œæ—¥å¸¸ bug ä¿®å¤ç‰ˆæœ¬çš„æ›´æ–°ï¼Œç´§æ€¥é—®é¢˜ä¸å—æ­¤é™åˆ¶ï¼Œå¯ä»¥éšæ—¶å‘å¸ƒ
- y ä½ï¼šæ¯æœˆå‘å¸ƒä¸€ä¸ªå¸¦æœ‰æ–°ç‰¹æ€§çš„å‘ä¸‹å…¼å®¹çš„ç‰ˆæœ¬
- x ä½ï¼šåŒ…å«æœ‰ break change å˜æ›´çš„å¤§ç‰ˆæœ¬ï¼Œä¸€èˆ¬å‘¨æœŸä¸€åˆ°ä¸¤å¹´



## Iceworks CLI & GUI å®¢æˆ·ç«¯å·¥å…·
iceworks cli https://github.com/alibaba/ice/blob/master/docs/cli/start.md
ice-scripts ä½¿ç”¨æŒ‡å— https://www.bookstack.cn/read/alibaba-ice/docs-advanced-webpackrc.md
Iceworks & create-react-app https://www.bookstack.cn/read/alibaba-ice/docs-advanced-work-with-create-react-app.md
ice-scripts ICE SDK https://npm.taobao.org/package/ice-scripts/v/2.1.12
ice-scripts plugin for fusion https://npm.taobao.org/package/ice-plugin-fusion

Fusion Next ç»„ä»¶åº“æœ¬èº«æ˜¯ä¸ä¾èµ–ä»»ä½•è„šæ‰‹æ¶, å®Œå…¨å¯ä»¥é€šè¿‡ cdn å¼•å…¥æˆ–è€…æ•´åˆåˆ° create-react-app ç­‰æ–¹å¼ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿å°† Fusion Next ç»„ä»¶åº“åº”ç”¨åˆ°å‰ç«¯é¡¹ç›®ï¼Œéœ€è¦è„šæ‰‹æ¶ Iceworks CLI å’Œ Iceworks  GUI å®¢æˆ·ç«¯å¸®å¿™å¿«é€Ÿç”Ÿæˆå·¥ç¨‹é¡¹ç›®ã€‚ ICE å›¢é˜Ÿå¼€æºäº†ä¸€ç³»åˆ—äº§å“ï¼Œè€Œ Fusion Design å›¢é˜Ÿé€‰æ‹© Iceworks ä½œä¸º Fusion å®˜æ–¹ä¸»æ¨çš„å¼€å‘å·¥å…·ã€‚

é£å†°é¡¹ç›®é»˜è®¤ä½¿ç”¨ ice-scripts ä½œä¸ºå¼€å‘å·¥å…·ï¼Œå³ ice å‘½ä»¤ï¼ŒIceworks CLI åˆ™å°† ice-scripts æä¾›çš„å‘½ä»¤è¿›è¡Œå°è£…ç®€åŒ–ä½¿ç”¨ï¼Œice-scripts æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½å¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡ï¼š

- å‘½ä»¤è¡Œå·¥å…·
- ä¸»é¢˜é…ç½®
- ä»£ç†é…ç½®
- è‡ªå®šä¹‰ webpack é…ç½®
- Mock ...

å®‰è£… ice-scriptsï¼Œç„¶åä½¿ç”¨ ice å‘½ä»¤ï¼š

    cnpm install ice-scripts 

å¯åŠ¨è°ƒè¯•æœåŠ¡ï¼š

    $ ice dev --help
    Usage: ice-dev [options]
    Options:
      -p, --port <port>      æœåŠ¡ç«¯å£å·
      -h, --host <host>      æœåŠ¡ä¸»æœºå
      --https                å¼€å¯ https
      --analyzer             å¼€å¯æ„å»ºåˆ†æ
      --analyzer-port        è®¾ç½®åˆ†æç«¯å£å·
      --disabled-reload      å…³é—­ hot reload
      --project-type <type>  é¡¹ç›®ç±»å‹, node|web (default: "web")
      --inject-babel <type>  æ³¨å…¥ babel è¿è¡Œç¯å¢ƒ, Enum: polyfill|runtime (default: "polyfill")

æ„å»ºä»£ç ï¼š

    $ ice build --help
    Usage: ice-build [options]
    Options:
      --debug                debug æ¨¡å¼ä¸‹ä¸å‹ç¼©
      --hash                 æ„å»ºåçš„èµ„æºå¸¦ hash ç‰ˆæœ¬
      --project-type <type>  é¡¹ç›®ç±»å‹, node|web (default: "web")
      --inject-babel <type>  æ³¨å…¥ babel è¿è¡Œç¯å¢ƒ, Enum: polyfill|runtime (default: "polyfill")


é£å†°é»˜è®¤ä½¿ç”¨ ice-scripts ä½œä¸ºå¼€å‘å·¥å…·ï¼Œä½†æ˜¯å¦‚æœæƒ³ä½¿ç”¨ React ç¤¾åŒºçš„ create-react-app å¼€å‘é¡¹ç›®ï¼ŒIceworks ä¹Ÿæä¾›äº†åŸºäº create-react-app çš„æ¨¡æ¿ï¼Œæ”¯æŒæŒ‰éœ€å¼•å…¥é£å†°åŸºç¡€ç»„ä»¶ï¼Œæ·»åŠ åŒºå—ç­‰èƒ½åŠ›ã€‚

åŸºäº Iceworks èƒ½å¤Ÿä¸€é”®ç”Ÿæˆ Ice å’Œ Node çš„å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ï¼Œå‰ç«¯ä½¿ç”¨ React æŠ€æœ¯æ ˆï¼Œåç«¯ä½¿ç”¨ Koa 2.x ä½œä¸ºæœåŠ¡ç«¯å¼€å‘æ¡†æ¶ã€‚

Iceworks CLI å·¥å…·å’Œ Iceworks GUI å·¥å…·è¿›è¡Œåˆå§‹åŒ–é¡¹ç›®éƒ½å¾ˆå¥½ç”¨ï¼Œä¸€ä¸ªæ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸€ä¸ªæ˜¯åŸºäº Electron å¼€å‘çš„æ¡Œé¢å›¾å½¢å·¥å…·ã€‚

å…¨å±€å®‰è£… iceworks CLI å·¥å…·å¹¶åˆ›å»ºä¸€ä¸ªå·¥ç¨‹æ¨¡æ¿ï¼š

    $ npm install iceworks -g
    $ iceworks --help

    # åˆ›å»ºä¸€ä¸ªç©ºçš„é¡¹ç›®ç›®å½•
    $ mkdir iceapp && cd iceapp

    # æ ¹æ®å·²æœ‰æ¨¡æ¿åˆ›å»ºé¡¹ç›®
    $ iceworks init

    # å®‰è£…ä¾èµ–
    $ npm install

å®Œæˆé¡¹ç›®åˆå§‹åŒ–åæ—¢å¯ä»¥å¼€å§‹å¼€å§‹é¡¹ç›®è°ƒè¯•å¼€å‘å’Œé¡¹ç›®æ„å»ºã€‚

è°ƒè¯•å¼€å‘
é¡¹ç›®ç›®å½•ä¸‹å¯åŠ¨è°ƒè¯•æœåŠ¡ï¼š

    $ npm start

å¼€å§‹è°ƒè¯•æœåŠ¡åï¼Œå¯ä»¥è®¿é—® http://localhost:4444 è¿›è¡Œé¡µé¢é¢„è§ˆã€‚ä¿®æ”¹æºç å†…å®¹åå°†è‡ªåŠ¨åˆ·æ–°é¡µé¢ã€‚

è°ƒè¯•æœåŠ¡æ”¯æŒçš„å‘½ä»¤å‚æ•°ï¼š

    $ ice-scripts dev --help

    Usage: ice-scripts dev [options]

    Options:
      -p, --port <port>      æœåŠ¡ç«¯å£å·
      -h, --host <host>      æœåŠ¡ä¸»æœºå
      --https                å¼€å¯ https
      --analyzer             å¼€å¯æ„å»ºåˆ†æ
      --analyzer-port        è®¾ç½®åˆ†æç«¯å£å·
      --disabled-reload      å…³é—­ hot reload
      --disabled-mock      å…³é—­ mock åŠŸèƒ½

æ¯”å¦‚ä½¿ç”¨ 3000 ç«¯å£å¯åŠ¨ dev server

    $ npm run start -- -p 3000
    # æˆ–è€…
    $ ice-scripts dev -p 3000

æ¯”å¦‚å¼€å¯ https

    $ npm run start -- --https


æ„å»ºä»£ç 
æ„å»ºé¡¹ç›®ä»£ç ï¼š

    $ npm run build

æ„å»ºæœåŠ¡æ”¯æŒçš„å‘½ä»¤å‚æ•°ï¼š

    $ ice-scripts build --help

    Usage: ice-scripts build [options]

    Options:
      --analyzer             å¼€å¯æ„å»ºåˆ†æ
      --analyzer-port        è®¾ç½®åˆ†æç«¯å£å·

æ„å»ºäº§ç‰©é»˜è®¤ç”Ÿæˆåˆ° ./build ç›®å½•ä¸‹ã€‚


æ›¾ç» Iceworks ä¹Ÿæ˜¯æ”¯æŒå¾®ä¿¡å°ç¨‹åºå¼€å‘çš„ï¼Œä¼°è®¡æ˜¯ç«äº‰å…³ç³»è¢«ç»ˆæ­¢äº†ã€‚åœ¨ Iceworks å¼€å‘å°ç¨‹åºï¼Œå‡çº§åˆ° Iceworks 2.9.0 ç‰ˆæœ¬ï¼Œåœ¨è®¾ç½®é¢æ¿å¼€å¯ å°ç¨‹åºç‰©æ–™æº é€‰é¡¹ï¼Œå³å¯åœ¨æ¨¡æ¿ç•Œé¢å’ŒåŒºå—é¢æ¿çœ‹åˆ°å¯¹åº”çš„å°ç¨‹åºç›¸å…³ç‰©æ–™ï¼Œå…¶ä¸­åŒ…æ‹¬ 4 ä¸ªæ¨¡æ¿ï¼š

- miniapp-lite https://ice.work/rax-materials/miniapp-lite/index.html
- products-admin https://ice.work/rax-materials/products-admin/index.html
- posts-admin https://alibaba.github.io/ice/rax-materials/posts-admin/index.html
- operating-dashboard https://alibaba.github.io/ice/rax-materials/operating-dashboard/index.html



## Fusion ç«™ç‚¹

ä¸»é¢˜é…ç½®èƒ½åŠ›ï¼Œå¯ä»¥é€šè¿‡ Fusion ç«™ç‚¹å¯è§†åŒ–é…ç½®ä¸»é¢˜ï¼ŒFusion ç«™ç‚¹æ˜¯ Fusion Design ç®¡ç†ç­‰èƒ½åŠ›çš„é›†æ•£åœ°ã€‚ä¸»è¦æä¾›ä»¥ä¸‹èƒ½åŠ›:

- è‡ªæœ‰ç«™ç‚¹ç®¡ç†
- ä¸»é¢˜é…ç½®

ä»¥ä¸Šä¸¤ä¸ªæ˜¯ç”¨çš„æ¯”è¾ƒå¤šçš„,å…¶ä»–åŠŸèƒ½å°±ä¸åœ¨å…¥é—¨ç¯‡é‡Œé¢ä¸€ä¸€ä»‹ç»ã€‚

è‡ªæœ‰ç«™ç‚¹

ç®€å•ç†è§£è‡ªæœ‰ç«™ç‚¹å°±æ˜¯ç”¨æˆ·è‡ªå·±åˆ›é€ çš„ä¸€ä¸ªé›†åˆï¼Œä¸»é¢˜ã€ç‰©æ–™éƒ½å¿…é¡»ä¾é™„äºç«™ç‚¹ã€‚ä¸€ä¸ªç«™ç‚¹å¯ä»¥æœ‰å¤šå¥—ä¸»é¢˜,å¤šç§ç‰©æ–™ï¼Œå¤šä¸ªæˆå‘˜ã€‚ç«™ç‚¹ç®¡ç†ç®¡ç†èƒ½åŠ›åŒ…å«æ–°å»ºç«™ç‚¹ã€ç«™ç‚¹æˆå‘˜ç®¡ç†ã€ä¸»é¢˜ç®¡ç†ã€ç‰©æ–™ç®¡ç†ã€‚è¿™ä¸ªå°±ä¸ä¸€ä¸€ç»†è¯´,æœ¬æ–‡åç»­æ¶‰åŠåˆ°çš„ä¼šç»†è¯´ã€‚
ä¸»é¢˜é…ç½®

ä¸»é¢˜è¿™ä¸ªè¯ç”¨çš„ä¸€çœ‹ç¬”è€…å°±æ˜¯ä¸€ä¸ªå‰ç«¯ã€‚åœ¨è®¾è®¡å¸ˆé¢†åŸŸ, ç±»ä¼¼æ¦‚å¿µç§°ä¹‹ä¸º Design Systemã€‚åœ¨ Fusion Design ç«™ç‚¹ä¸Š, è®¾è®¡å¸ˆå¯ä»¥åŸºäº Fusion Design å®˜æ–¹çš„ Design System æ”¹é€ æˆè‡ªå·±ä¸“å±çš„ Design Systemã€‚æ¯ä¸ª Design System å°±æ˜¯ä¸€ä¸ªè‡ªæœ‰ç«™ç‚¹ã€‚ä¸€ä¸ªè‡ªæœ‰ç«™ç‚¹å¯ä»¥æ‹¥æœ‰å¤šä¸ªä¸»é¢˜ã€‚ä¸»é¢˜é…ç½®å¯ä»¥ç¼–è¾‘ Design Token (è¿™ä¹Ÿæ˜¯è®¾è®¡å¸ˆè¯­è¨€,å‰ç«¯åŒå­¦å¯ä»¥æŠŠè¿™ä¸ªç­‰ä»·äº SCSS å˜é‡), ç”Ÿæˆä¸»é¢˜ã€‚

ç¼–è¾‘å®Œæˆä¸»é¢˜ å¹¶ä¸”å‘å¸ƒ,å¹¶ä¸”å‘å¸ƒ,å¹¶ä¸”å‘å¸ƒ (é‡è¦äº‹æƒ…è¯´ä¸‰é),è®¾è®¡å¸ˆå¯ä»¥è·å¾—ä¸¤æ ·ä¸œè¥¿:

- ä¸»é¢˜ä»£ç åŒ…,å¯ä»¥ç›´æ¥æä¾›ç»™å‰ç«¯ä½¿ç”¨
- åŸºç¡€è®¾è®¡ç´ æ, å¯ä»¥é€šè¿‡ FusionCool æ’ä»¶ç›´æ¥åœ¨ Sketch ä¸­ä½¿ç”¨

Fusion Design å¯¹å¤–æ­£å¼å¼€æ”¾çŸ­çŸ­ä¸€ä¸ªæœˆ,æ–°å»º2500ä¸ªç«™ç‚¹,å·²ç»æ²‰æ·€2800+å¥—ä¸»é¢˜ã€‚

é˜¿é‡Œé›†å›¢å†…, å¤©çŒ« MUIã€æ·˜å® ICE Designã€é˜¿é‡Œäº‘ Windã€ç›’é©¬é²œç”Ÿ Hippoã€èœé¸Ÿ Walle ç­‰Design System éƒ½æ˜¯åŸºäº Fusion Design æ·±åº¦å®šåˆ¶, æ»¡è¶³å„ä¸ªBUä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚ç›®å‰é›†å›¢å†…æœåŠ¡40+BUã€é¡¹æ²‰æ·€ä¸»é¢˜1500+å¥—,æœåŠ¡2000+é¡¹ç›®ã€‚

## FusionCool

FusionCool æ˜¯ä¸€ä¸ª Sketch æ’ä»¶, è¾…åŠ©è®¾è®¡å¸ˆåšè®¾è®¡ç¨¿ã€‚ FusionCool æä¾›ä»¥ä¸‹ç´ æ:

- åŸºç¡€ç»„ä»¶
- å›¾æ ‡Icon
- å›¾è¡¨
- æ¨¡å—
- æ¨¡æ¿

å…¶ä¸­ 1 ~ 3 æ˜¯æ ¹æ®è®¾è®¡å¸ˆåœ¨é…ç½®å¹³å°å®Œæˆçš„Design Systemè‡ªåŠ¨ç”Ÿæˆçš„,Design Systemä¸­çš„æŸä¸ªä¸»é¢˜å‘ç”Ÿå˜åŠ¨å¹¶ä¸”å‘å¸ƒä»¥å, FusionCoolä¸­çš„è®¾è®¡ç´ æå°±ä¼šè‡ªåŠ¨è·Ÿç€å˜åŒ–ã€‚ 4 ~ 5 ç´ æ,ç›®å‰éƒ½æ˜¯Fusion Designå®˜æ–¹è®¾è®¡å¸ˆæ‰‹ç»˜,åç»­ä¼šå¯¹é½ 1 ~ 3 çš„èƒ½åŠ›ã€‚

ä»£ç åˆ°è§†è§‰ç¨¿çš„æ— æŸè¿˜åŸ

çªç ´ html2svg çš„å¼Šç«¯ï¼Œåšåˆ°æ— æŸè¿˜åŸ

æ—©åœ¨ä¸€å¹´å‰æˆ‘ä»¬æ˜¯æŠŠè®¾è®¡å¸ˆåœ¨ä¸»é¢˜é…ç½®å¹³å°ï¼ˆç›´æ¥åœ¨webé¡µé¢é…ç½®ç»„ä»¶çš„ä¸»é¢˜ï¼‰çš„ç»„ä»¶ç›´æ¥é€šè¿‡ html2svg æŠ€æœ¯ç›´æ¥æŠŠç»„ä»¶ç›´æ¥è½¬æ¢ä¸ºsvgæ–‡ä»¶ï¼Œä»è€Œè®©è®¾è®¡å¸ˆå¯ä»¥ç›´æ¥åœ¨ sketch é‡Œé¢ä½¿ç”¨ã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆå­˜åœ¨çš„å¼Šç«¯å°±æ˜¯è¿˜åŸåº¦ä¸å¤Ÿï¼ˆå¤§æ¦‚95%è¿˜åŸåº¦ï¼‰ã€‚

æ—©æœŸ html2svg çš„è¿˜åŸåº¦é—®é¢˜

ä¸»è¦åŸå› æ˜¯ html é‡‡ç”¨ç›’æ¨¡å‹ å’Œ svg çš„è½¬æ¢å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ°¸è¿œæœ‰ä¿®ä¸å®Œçš„bugã€‚è™½ç„¶95% æ˜¯å¥½çš„ï¼Œä½†æ˜¯å¯¹äºè®¾è®¡ç«¯æ¥è¯´æ˜¯å®Œå…¨ä¸èƒ½å¿å—çš„ã€‚

æ‰€ä»¥ Fusion é¡¹ç›®å°ç»„ç»è¿‡è¿‘åŠå¹´çš„åŠªåŠ›ç»ˆäºçªç ´äº†è¿˜åŸåº¦çš„é—®é¢˜ï¼Œæµç¨‹å›¾å¦‚ä¸‹

FusionCool æ¸²æŸ“ç»„ä»¶åˆ°sketchæµç¨‹

ä»é…ç½®å¹³å°å¯¼å‡ºçš„ä¸å†æ˜¯ htmlï¼Œè€Œæ˜¯ DesignToken ï¼ˆè®¾è®¡å˜é‡ï¼‰ï¼ŒFusionCool åº•å±‚ä½¿ç”¨ Airbnb æä¾›çš„ react-sketch èƒ½åŠ›å†™æˆçš„ä¸€ä»½ Next ç»„ä»¶ï¼Œç›´æ¥é€šè¿‡ DesignToken è¦†ç›–é»˜è®¤å˜é‡ï¼Œæœ€ç»ˆåœ¨ Sketch ç«¯å®æ—¶æ¸²æŸ“ã€‚åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°

ç»„ä»¶çš„ç±»å‹ã€å¤§å°ã€å†…å®¹éƒ½å¯ä»¥ç›´æ¥åœ¨é¢æ¿é…ç½®

å›¾è¡¨é…ç½®å¯ä»¥ç›´æ¥å”¤èµ·é…ç½®é¢æ¿

sketch ç«¯çš„ä»»ä½•ç‚¹å‡»éƒ½å¯ä»¥é€šè¿‡ Event çš„æ–¹å¼åœ¨ FusionCool äº§ç”Ÿé…ç½®é¢æ¿ã€‚


åç»­è®¾è®¡å¸ˆè‡ªå·±å®Œæˆçš„è®¾è®¡ç´ æä¹Ÿæ”¯æŒé€šè¿‡FusionCoolå¯¼å…¥Design System, å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤ç”¨ã€‚



## å¸¸è§é—®é¢˜

- Fusion Design å’Œ Ant Design æœ‰ä»€ä¹ˆå·®å¼‚?

    ç®€å•åœ°å›ç­”å°±æ˜¯ Ant Designæ˜¯ä¸€å¥—ç»„ä»¶åº“, Fusion Design æ˜¯ä¸€ä¸ªç»„ä»¶åº“ç”Ÿæˆå·¥å‚ã€‚
    Ant Designæ˜¯ä¸€æ¬¾å¾ˆä¼˜ç§€çš„ç»„ä»¶åº“,åœ¨ç¤¾åŒºæ·±å—æ¬¢è¿,å½±å“åŠ›æå¤§ã€‚ä»£ç è´¨é‡ä¼˜ç§€,Fusionç»„ä»¶åº“åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿæœ‰æ‰€å€Ÿé‰´ã€‚Fusion Designä¹Ÿåœ¨é˜¿é‡Œå†…éƒ¨æ²‰æ·€æ‰“ç£¨äº†ä¸‰å¹´, è¦†ç›–å¤§é‡çš„BUå’Œä¸šåŠ¡åœºæ™¯ã€‚å•ä»ç»„ä»¶åº“çš„å±‚é¢è€Œè¨€, Fusion å’Œ AntD çš„ä½“éªŒå·®å¼‚ä¸å¤§ã€‚
    å‚ä¸è¿‡ SEE Conf çš„åŒå­¦éƒ½ä¼šä¸º AntD ä¼˜ç§€çš„è®¾è®¡ç†å¿µæ‰€æŠ˜æœã€‚å¯æ˜¯ä¸€åƒä¸ªäººçœ¼é‡Œæœ‰ä¸€åƒä¸ªå“ˆå§†é›·ç‰¹,å„ä¸ªå…¬å¸(BU/éƒ¨é—¨/äº§å“çº¿)å¯¹äºç¾çš„è®¤çŸ¥æ˜¯ç”±å·®å¼‚çš„,è€Œä¸”ä¸šåŠ¡å½¢æ€çš„ä¸åŒä¹Ÿå¯¹è®¾è®¡é£æ ¼æœ‰ç€ä¸åŒçš„è¦æ±‚,æ‰€æœ‰å„ä¸ªå…¬å¸(BU/éƒ¨é—¨/äº§å“çº¿)å¯¹ç»„ä»¶åº“é»˜è®¤çš„æ ·å¼è¿›è¡Œå®šåˆ¶å°±å¸¸å¸¸æˆä¸ºåˆšéœ€ã€‚å½“ç”¨æˆ·æƒ³è¦å®šåˆ¶ç»„ä»¶åº“çš„æ—¶å€™, AntD å°±ä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ï¼Œéœ€è¦å‰ç«¯å·¥ç¨‹å¸ˆå¤§é‡ä¿®æ”¹ LESS å˜é‡,åå¤ä¸è®¾è®¡å¸ˆç¡®å®šè®¾è®¡ç¨¿è¿˜åŸçš„å‡†ç¡®æ€§ã€‚ AntD å®šåˆ¶ä¸»é¢˜ / Issue: support dark theme
    Fusionç»„ä»¶åº“ç”±é›†å›¢å¤šä¸ª BU çš„è®¾è®¡å¸ˆå…±åŒå‚ä¸è®¾è®¡çš„ï¼Œç›®æ ‡æ˜¯å¸®åŠ©æ¯ä¸ªBUéƒ½èƒ½å®šåˆ¶å±äºè‡ªå·±çš„ XXXX Designã€‚æ‰€ä»¥ Fusion ä¼šåœ¨ UI çš„å®šåˆ¶èƒ½åŠ›ä¸Šæ¯” Antd è®¾è®¡å¾—æ›´ä¸ºé€šç”¨ï¼Œä»¥æ»¡è¶³å„ä¸šåŠ¡çº¿çš„å®šåˆ¶èƒ½åŠ›ã€‚è®¾è®¡å¸ˆé€šè¿‡ Fusion Design çš„å¹³å°,èƒ½å¤Ÿå¯è§†åŒ–ç¼–è¾‘ Fusion ç»„ä»¶åº“çš„æ ·å¼ï¼Œå…¨ç¨‹æ— éœ€å·¥ç¨‹å¸ˆå‚ä¸ã€‚
    é˜¿é‡Œé›†å›¢å†…, å¤©çŒ«MUIã€æ·˜å®ICE Designã€é˜¿é‡Œäº‘ Windã€ç›’é©¬é²œç”Ÿ Hippoã€èœé¸Ÿ Walleç­‰Design Systeméƒ½æ˜¯åŸºäºFusion Designæ·±åº¦å®šåˆ¶, æ»¡è¶³å„ä¸ªBUä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚ç›®å‰é›†å›¢å†…æœåŠ¡ 40+ BUã€é¡¹æ²‰æ·€ä¸»é¢˜ 1500+ å¥—,æœåŠ¡ 2000+ é¡¹ç›®ã€‚

- Fusion å’Œ é£å†°(ICE) æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ

    ICE æ˜¯ Fusion çš„å¥½åŸºå‹ã€‚ Fusion è§£å†³çš„æ˜¯å‰ç«¯ä¸è®¾è®¡å¸ˆçš„ååŒé—®é¢˜ã€‚ ICE è§£å†³çš„æ˜¯å‰ç«¯å¼€å‘çš„æ•ˆç‡é—®é¢˜ã€‚é€šè¿‡æµ·é‡å¯å¤ç”¨ç‰©æ–™ï¼Œé…å¥—æ¡Œé¢å·¥å…·æé€Ÿæ„å»ºå‰ç«¯åº”ç”¨ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚
    Fusion ä¸ICE çš„åˆä½œä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹:

    - ICE å®˜æ–¹reactç‰©æ–™ä½¿ç”¨ fusionç»„ä»¶åº“ä½œä¸ºé»˜è®¤ç»„ä»¶åº“
    - Fusion æ¨èä½¿ç”¨ ICEçš„GUIå®¢æˆ·ç«¯ Iceworks ä½œä¸ºé¦–é€‰å¼€å‘å·¥å…·
    - ICEå®˜æ–¹ React ç‰©æ–™å’Œ Fusion å®˜æ–¹ç‰©æ–™æ˜¯äº’é€šçš„(æ˜¥èŠ‚å‰å®Œæˆ)ï¼ŒåŒæ–¹å…±åŒä¸°å¯Œç‰©æ–™ç”Ÿæ€,æ¨åŠ¨åŒºå—/æ¨¡æ¿ç‰©æ–™çš„å¼€å‘æ¨¡å¼è½åœ°

- è®¾è®¡å¸ˆä½¿ç”¨ FusionCool åˆ›ä½œçš„è®¾è®¡ç¨¿èƒ½ä¸èƒ½å¯¼å‡ºæˆä»£ç ?

    FusionCool å¯¼å‡ºçš„ HTMl ,æ˜¯å¸¦æ ‡æ³¨çš„è®¾è®¡ç¨¿ã€‚
    è®¾è®¡ç¨¿æƒ³è¦è½¬æ¢æˆä»£ç ,åªèƒ½è¯´"è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®,å¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢"ã€‚æƒ³è¦ç›´æ¥å¯¼å‡ºä»£ç ,çŸ­æœŸå†…è¿˜åšä¸åˆ°ã€‚
    Fusion å›¢é˜Ÿç›®å‰åœ¨è¿™æ–¹é¢ä¹Ÿæœ‰æŠ•å…¥å’Œæ‘¸ç´¢ã€‚å¯ä»¥æœŸå¾…ä¸€ä¸‹ã€‚

- Vue ç”¨æˆ·å¯ä»¥ç”¨ Fusion Design ä¹ˆ?

    Fusion ç»„ä»¶åº“æ˜¯åŸºäº ReactæŠ€æœ¯æ ˆå®ç°çš„ã€‚ä½†æ˜¯ Fusion Design çš„ç»„ä»¶é…ç½®èƒ½åŠ›å’Œç»„ä»¶çš„æŠ€æœ¯æ ˆæ˜¯æ— å…³çš„ã€‚åªè¦ä¸€å¥—ç»„ä»¶åº“æŒ‰ç…§ Fusion Design ç»„ä»¶å¼€å‘è§„èŒƒè¿›è¡Œå¼€å‘,å°±å¯ä»¥æ¥å…¥åˆ° Fusion Design ç«™ç‚¹, è·å–é…ç½®èƒ½åŠ›ã€‚
    ElementUI å›¢é˜Ÿå·²ç»å¼€å§‹ Fusion Design é…ç½®èƒ½åŠ›çš„å¯¹æ¥å·¥ä½œï¼Œæ•¬è¯·æœŸå¾…â€¦

- ç§»åŠ¨ç«¯å¯ä»¥ç”¨Fusion Design ä¹ˆ?

    Fusion Design Mobile Web ç«¯ç»„ä»¶æ­£åœ¨å¼€å‘ä¸­ï¼ŒReact Nativeã€Weexã€flutter ä»¥åŠå°ç¨‹åºç”¨çš„ç»„ä»¶æš‚æ— æ’æœŸâ€¦

ç›¸å…³é“¾æ¥Fusion ç«™ç‚¹ï¼šhttps://fusion.design/next
github ä»“åº“ï¼š https://github.com/alibaba-fusion/next

æ–‡ç« åŸä½œï¼šFusion Design æˆå‘˜æš®å°˜

