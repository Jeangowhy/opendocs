
# ğŸš© Nest.js å…‰é€Ÿå…¥é—¨
- https://docs.nestjs.com/
- https://www.fastify.io/
- https://github.com/fastify/fastify
- RenderModule æ•´åˆ Next.js + Nest.js https://github.com/ananiy/nest-next-module
- RxJS å¿«é€Ÿå…¥é—¨ https://www.cnblogs.com/vcluopeng/p/14010904.html
- Nest.js ä¸å¾®æœåŠ¡ https://docs.nestjs.com/microservices/basics
- Nest.js ç¤ºèŒƒä»£ç  https://github.com/nestjs/nest/tree/master/sample
- Demo https://github.com/jimboyeah/nest-demo/

çœŸæ­£å…‰é€Ÿæ˜¯ä¸å¯èƒ½å…‰é€Ÿçš„ï¼Œä½†æ˜¯æŒæ¡ä»¥ä¸‹åŸºæœ¬æ¦‚å¿µï¼Œè¿˜å¯ä»¥æé€Ÿå…¥é—¨çš„ï¼Œä¸¤å¤©æŒæ¡å®˜æ–¹æ–‡æ¡£ä¸­çš„ Overview å’Œ Fundamentals ä¸¤å¤§æ ¸å¿ƒå†…å®¹ã€‚

- Node.js ç¼–ç¨‹ç¯å¢ƒï¼›
- TypeScript é™æ€ç±»å‹è„šæœ¬è¯­è¨€ï¼›
- OOP & FP é¢å‘å¯¹è±¡ç¼–ç¨‹å’Œå‡½æ•°å¼ç¼–ç¨‹ï¼›
- MVC ç¼–ç¨‹æ¨¡å¼æ¦‚å¿µï¼ŒåŒ…æ‹¬åŸºæœ¬çš„è·¯ç”±æ¦‚å¿µï¼›
- IoC & DI ä¾èµ–åè½¬å’Œä¾èµ–æ³¨å…¥ï¼›
- AOP åˆ‡é¢ç¼–ç¨‹æ¨¡å¼ï¼›

æœ¬è´¨ä¸Šï¼Œå‰ç«¯æŠ€æœ¯å¹¶ä¸æ˜¯å‘å±•å¤ªå¿«ï¼Œè€Œæ˜¯å˜åŒ–å¤ªå¿«ï¼Œä½ åº”è¯¥ä»”ç»†å£å‘³è¿™å¥è¯çš„å«ä¹‰ï¼åº”è¯¥æŒæ¡çš„æ˜¯é€šç”¨ç¼–ç¨‹åŸç†å’Œæ–¹æ³•ï¼Œä¾‹å¦‚å…¶ä¸­ç¼–ç¨‹æ¨¡å¼å°±æ˜¯æˆåŠŸçš„å…¸å‹ï¼Œåº”è¯¥å¥½å¥½å­¦ä¹ çš„æŠ€æœ¯ã€‚

Nest æ˜¯ä¸€ä¸ªæ¸è¿›çš„ Node.js æ¡†æ¶ï¼Œç»“åˆ OOP - Object Oriented Programmingï¼ŒFP - Functional Programmingï¼ŒFRP - Functional Reactive Programming ç†å¿µï¼Œå¯ä»¥åœ¨ TypeScript å’Œ JavaScript (ES6ã€ES7ã€ES8) ä¹‹ä¸Šæ„å»ºé«˜æ•ˆã€å¯ä¼¸ç¼©çš„ä¼ä¸šçº§æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºã€‚

Nestjs å“²å­¦: Nest æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åº”ç”¨ç¨‹åºæ¶æ„ï¼Œå…è®¸å¼€å‘äººå‘˜å’Œå›¢é˜Ÿåˆ›å»ºé«˜åº¦å¯æµ‹è¯•ï¼Œå¯æ‰©å±•ï¼Œæ¾æ•£è€¦åˆä¸”æ˜“äºç»´æŠ¤çš„åº”ç”¨ç¨‹åºã€‚

Nestjs ä¸å¹³å°æ— å…³ï¼ŒæŠ€æœ¯ä¸Šè®²ï¼Œä¾èµ– Node.js å¹³å°ï¼Œå³è·¨å¹³å°ã€‚Nest å¯ä»¥åœ¨åˆ›å»ºé€‚é…å™¨åä½¿ç”¨ä»»ä½• Node HTTP æ¡†æ¶ï¼Œæœ‰ä¸¤ä¸ªæ”¯æŒå¼€ç®±å³ç”¨çš„ HTTP å¹³å°ï¼šexpress å’Œ fastifyã€‚ 

Nestjs åœ¨è®¾è®¡ä¸Šçš„å¾ˆå¤šçµæ„Ÿæ¥è‡ªäº `Angular`ï¼ŒAngular çš„å¾ˆå¤šæ¨¡å¼åˆæ¥è‡ªäº Java ä¸­çš„ `Spring` æ¡†æ¶ï¼Œä¾èµ–æ³¨å…¥ã€é¢å‘åˆ‡é¢ç¼–ç¨‹ç­‰ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è®¤ä¸ºï¼š Nest æ˜¯ Node.js ç‰ˆçš„ Spring æ¡†æ¶ã€‚å¯¹äºç†Ÿæ‚‰ Java çš„å¼€å‘è€…ï¼ŒNest ææ˜“ä¸Šæ‰‹ï¼ŒNest ä¸ Spring MVC å¦‚å‡ºä¸€è¾™çš„åˆ†å±‚æ¶æ„å’Œæ³¨è§£æ ‡ç­¾ï¼Œä»¥åŠä¾èµ–æ³¨å…¥ã€æ§åˆ¶åè½¬ã€ç”Ÿå‘½å‘¨æœŸç­‰å®ç°ï¼Œä¹Ÿè®© Angular æ˜“äºå¼€å‘å¤§å‹å‰ç«¯çš„ä¼˜åŠ¿ä¹Ÿå‘æŒ¥åœ¨ Node æœåŠ¡å™¨ç«¯ã€‚

Node æœ‰ Express ç­‰æ¡†æ¶çš„ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³æ¶æ„é—®é¢˜ï¼Œå› ä¸º Express æ˜¯ unopinionatedï¼Œåªæ˜¯ä¸€å¥—åŸºäº middleware çš„åº“ï¼Œæ²¡æœ‰è§„èŒƒä»£ç çš„ç»“æ„ã€‚

è€Œ Angular æ˜¯ opinionatedï¼Œå®šä¹‰äº† Templateã€Componentã€Filter(Pipe)ã€Serviceã€Module è¿™äº›æ¦‚å¿µï¼Œè®©ä»£ç ç»„ç»‡èµ·æ¥æ›´è§„èŒƒã€‚

ä»£ç ç»„ç»‡è§„èŒƒï¼Œå°±æ˜¯ Nestjs æ–‡æ¡£ä¸­è¯´çš„æ¶æ„é—®é¢˜ã€‚åªæœ‰ä»£ç æ›´è§„èŒƒï¼Œå¼€å‘å‡ºçš„åº”ç”¨æ‰å¯ä»¥æ˜“æµ‹è¯•ã€å¯æ‰©å±•ã€æ¾è€¦åˆã€æ˜“ç»´æŠ¤ã€‚

`å‡½æ•°å¼å“åº”å¼ç¼–ç¨‹` FRP - Functional Reactive Programming å‡½æ•°å¼å“åº”å¼ç¼–ç¨‹åˆè¡·æ˜¯ä¸ºäº†è§£å†³ listenerã€callback é€»è¾‘è¡¨è¾¾ä¸ç›´è§‚ï¼Œä»£ç ä¹±æˆä¸€å›¢éº»çš„é—®é¢˜ã€‚å¯¹äºä¸€ä¸ªå…¸å‹çš„ç™»å½•ç•Œé¢ï¼Œè¦æ±‚æ£€éªŒå¯†ç ä¸€è‡´ï¼Œå‡½æ•°å¼å“åº”å¼åšæ³•ï¼Œinput è¾“å…¥æœ‰å˜åŒ–ï¼Œbutton çŠ¶æ€å°±ä¼šè·Ÿç€å˜ã€‚ç›¸æ¯”è¾ƒ input è¾“å…¥å˜äº†ã€å†è°ƒä¸€éå‡½æ•°ã€æ ¹æ®å‡½æ•°è¾“å‡ºä¿®æ”¹ button çŠ¶æ€ï¼Œè¦æ›´è‡ªåŠ¨åŒ–ã€‚

å¯¹æ¯”ç¼–ç¨‹èŒƒå¼ï¼š

- `å‘½ä»¤å¼ç¼–ç¨‹` Imperative ä¸»è¦æ€æƒ³æ˜¯å…³æ³¨è®¡ç®—æœºæ‰§è¡Œçš„æ­¥éª¤ï¼Œå³ä¸€æ­¥ä¸€æ­¥å‘Šè¯‰è®¡ç®—æœºå…ˆåšä»€ä¹ˆå†åšä»€ä¹ˆã€‚
- `å£°æ˜å¼ç¼–ç¨‹` Declarative å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯å‘Šè¯‰è®¡ç®—æœºåº”è¯¥åšä»€ä¹ˆï¼Œä½†ä¸æŒ‡å®šå…·ä½“è¦æ€ä¹ˆåšã€‚ç»å…¸çš„ SQL ç¼–ç¨‹å°±æ˜¯ä¾‹å­ï¼Œä»¥æ•°æ®ç»“æ„çš„å½¢å¼æ¥è¡¨è¾¾ç¨‹åºæ‰§è¡Œçš„é€»è¾‘ã€‚


## ğŸ‘‰ Basic Concepts
- https://docs.nestjs.com/
- https://docs.nestjs.com/modules
- https://docs.nestjs.com/first-steps
- https://github.com/nestjs/nest-cli
- https://docs.nestjs.com/cli/overview

å®‰è£…ä½¿ç”¨ï¼ŒåŸºäº Node.js å¼€å‘ç¯å¢ƒæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    $ npm i -g @nestjs/cli
    $ nest new project-name
    $ nest g controller cats
    $ npm run start

Nest ä¾èµ–äº†ä»¥ä¸‹ä¸¤ä¸ªé‡è¦çš„æ¨¡å—ï¼š

- `rxjs` å³å“åº”å¼ç¼–ç¨‹ Reactive Extension JavaScriptï¼Œé€šè¿‡å°†ä»£ç åŠŸèƒ½æ—¶åºæŠ½è±¡ä¸ºæˆä¸€æ ¹æ—¶é—´è½´ï¼Œåœ¨è¿™æ ¹æ—¶é—´è½´ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œï¼Œè€Œå¼‚æ­¥ç›¸å…³çš„æ—¶åºå¤„ç†å°±äº¤ç»™å„ç§ operator å¤„ç†ã€‚
- `reflect-metadata` æä¾› JavaScript/TypeScript åå°„ APIï¼Œä¸»è¦ç”¨äºå®ç°è£…é¥°å™¨ï¼Œå…ƒæ•°æ®ç¼–ç¨‹ï¼›


æŸ¥çœ‹ main.ts ä»£ç ï¼Œé»˜è®¤ç»‘å®šç«¯å£ 3000ã€‚

    src/
      +-- app.controller.spec.ts æµ‹è¯•ç”¨ä¾‹
      +-- app.controller.ts æ§åˆ¶å™¨
      +-- app.module.ts æ ¹æ¨¡å—
      +-- app.service.ts æœåŠ¡ä¾›åº”å™¨
      +-- main.ts ä¸»ç¨‹åºå…¥å£æ–‡ä»¶

åŸºæœ¬æ¡†æ¶ç»„ä»¶æ¦‚å¿µï¼š

- Modules æ¨¡å—æ˜¯ç¨‹åºçš„åŸºæœ¬è¿è¡Œå•å…ƒï¼Œç”± `NestFactory` å®ä¾‹åŒ–ï¼Œé»˜è®¤å•ä¾‹ï¼Œå¯ä»¥åœ¨å¤šä¸ªæ¨¡å—ä¹‹é—´å…±äº«ï¼Œåªéœ€è®¾ç½®åˆ°æ¨¡å— exports æ•°ç»„ä¸­æ•°ç»„ä¸­å¹¶å¯¼å‡º;
- Controllers æ§åˆ¶å™¨ï¼Œè´Ÿè´£å®šä¹‰è·¯ç”±è§„åˆ™å’Œ HTTP å“åº”æ–¹æ³•ï¼›
- Providers æœåŠ¡ä¾›åº”å™¨ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥æä¾›æœåŠ¡ï¼›
- Middleware ä¸­é—´ä»¶æ˜¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚ `next()` ä¸­é—´ä»¶å‡½æ•°ï¼›
- Exception filters å¼‚å¸¸è¿‡æ»¤å™¨ï¼Œä½¿ç”¨æˆ–ç»§æ‰¿ `HttpException` ç±»è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼›
- Pipes å¤„ç†ç®¡é“ï¼Œä½¿ç”¨ `@Injectable()` è£…é¥°å™¨ä¿®é¥°å¹¶ä¸”å®ç° `PipeTransform` æ¥å£ï¼Œé€šå¸¸ç”¨æ¥å¤„ç†è¾“å…¥æ•°æ®è½¬æ¢ï¼Œä¸ºåç»­æ­¥éª¤è¿›è¡Œæ•°æ®éªŒè¯ã€‚
- Guards è·¯ç”±å®ˆå«ï¼Œä¸»è¦ç¡®å®šè¯·æ±‚æ˜¯å¦åº”è¯¥ç”±è·¯ç”±å¤„ç†ç¨‹åºå¤„ç†ã€‚
- Interceptors æ‹¦æˆªå™¨ï¼Œå®ç° `NestInterceptor`ï¼Œå¯ä»¥ç»‘å®šåˆ°æŒ‡å®šå‡½æ•°ï¼Œå¹¶åœ¨å‡½æ•°æ‰§è¡Œå‰ã€åè¿è¡Œæ‹¦æˆªå™¨ã€‚
- DTO - Data Transfer Object æ˜¯éœ€è¦è·¨è¿›ç¨‹æˆ–ç½‘ç»œè¾¹ç•Œä¼ è¾“çš„ä¸€ç»„èšåˆæ•°æ®çš„ç®€å•å®¹å™¨ï¼Œä¾‹å¦‚å°†å®¢æˆ·ç«¯ä¼ è¾“ç»™æœåŠ¡å™¨çš„è¯·æ±‚æ•°æ®è½¬æ¢ä¸º DTO å¯¹è±¡ã€‚

ä»åŸºæœ¬ç»„ä»¶å¯ä»¥çœ‹åˆ°ï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ AOP - Aspect Oriented Programming ä¹Ÿè´¯ç©¿ Nest åº”ç”¨å¼€å‘ã€‚AOP ä¸»è¦æ˜¯é’ˆå¯¹ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„åˆ‡é¢è¿›è¡Œæå–ï¼Œåœ¨æŸä¸ªæ­¥éª¤å’Œé˜¶æ®µè¿›è¡Œä¸€äº›æ“ä½œï¼Œä»è€Œè¾¾åˆ° DRY - Don't Repeat Yourself è½¯ä»¶å¼€å‘å‡†åˆ™ã€‚

åœ¨ Nestjs ä¸­ï¼ŒAOP å¯ä»¥æŒ‰è¯·æ±‚å¤„ç†é¡ºåºæ’åˆ—ï¼š

- Middlewares
- Guards
- Interceptors
- Pipes
- Interceptors
- Exception filters

è„šæ‰‹æ¶ Nest.js CLI é»˜è®¤å·¥ç¨‹æ˜¯ standard modeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ monorepo modeï¼Œå³å•ä»“åº“å¤šé¡¹ç›®çš„ç®¡ç†æ¨¡å¼ï¼Œé€šè¿‡ `nest g app` å‘½ä»¤ç”Ÿæˆå­åº”ç”¨æˆ–è€… libraryã€‚

æä¾›å„ç§åŸºæœ¬å¯¹è±¡ç±»å‹è‡ªåŠ¨ç”ŸæˆåŠŸèƒ½ï¼Œåé¢ä¸€ä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªç›®å½•ï¼š

    $ nest g application app
    $ nest g app app-modules
    $ nest g library lib-modules
    $ nest g controller products
    $ nest g service products
    $ nest g module products
    $ nest g pipe validation pipes
    $ nest g guard auth guards
    $ nest g interceptor logging interceptions

    generate|g [options] <schematic> [name] [path]  Generate a Nest element.
    
    Available schematics:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ name          â”‚ alias       â”‚ description                                  â”‚
      â”‚ ------------- â”‚ ----------- â”‚ -----------                                  â”‚
      â”‚ application   â”‚ application â”‚ Generate a new application workspace         â”‚
      â”‚ class         â”‚ cl          â”‚ Generate a new class                         â”‚
      â”‚ configuration â”‚ config      â”‚ Generate a CLI configuration file            â”‚
      â”‚ controller    â”‚ co          â”‚ Generate a controller declaration            â”‚
      â”‚ decorator     â”‚ d           â”‚ Generate a custom decorator                  â”‚
      â”‚ filter        â”‚ f           â”‚ Generate a filter declaration                â”‚
      â”‚ gateway       â”‚ ga          â”‚ Generate a gateway declaration               â”‚
      â”‚ guard         â”‚ gu          â”‚ Generate a guard declaration                 â”‚
      â”‚ interceptor   â”‚ in          â”‚ Generate an interceptor declaration          â”‚
      â”‚ interface     â”‚ interface   â”‚ Generate an interface                        â”‚
      â”‚ middleware    â”‚ mi          â”‚ Generate a middleware declaration            â”‚
      â”‚ module        â”‚ mo          â”‚ Generate a module declaration                â”‚
      â”‚ pipe          â”‚ pi          â”‚ Generate a pipe declaration                  â”‚
      â”‚ provider      â”‚ pr          â”‚ Generate a provider declaration              â”‚
      â”‚ resolver      â”‚ r           â”‚ Generate a GraphQL resolver declaration      â”‚
      â”‚ service       â”‚ s           â”‚ Generate a service declaration               â”‚
      â”‚ library       â”‚ lib         â”‚ Generate a new library within a monorepo     â”‚
      â”‚ sub-app       â”‚ app         â”‚ Generate a new application within a monorepo â”‚
      â”‚ resource      â”‚ res         â”‚ Generate a new CRUD resource                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è£…é¥°å™¨ Decorator ä½œä¸º ES7 çš„ä¸€å¤§ç‰¹æ€§ï¼Œåœ¨ TypeScript ä¸­å¯ä»¥è¢«è‡ªç”±è¿ç”¨ï¼Œåœ¨ Nest ä¸­æ›´æ˜¯å¾—åˆ°äº†åˆç†çš„å¼€å‘ä¸åˆ©ç”¨ã€‚

è£…é¥°å™¨è´¯ç©¿äº†æ•´ä¸ª Nest æ¡†æ¶ï¼š

- `@Module()` è£…é¥°å™¨ä¿®é¥°çš„ç±»ä»£è¡¨ä¸€ä¸ªæ¨¡å—ï¼›
- `@Controller()` è£…é¥°å™¨ä¿®é¥°çš„ç±»ä»£è¡¨ä¸€ä¸ªæ§åˆ¶å™¨ï¼›
- `@Injectable()` ä¾èµ–æ³¨å…¥è£…é¥°å™¨ä¿®é¥°çš„ç±»ä»£è¡¨ä¸€ä¸ªæœåŠ¡ä¾›åº”å™¨ï¼Œå¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥æä¾›æœåŠ¡ï¼›
- `@Get()` ä¿®é¥°ä¸€ä¸ª HTTP GET å“åº”æ–¹æ³•ï¼›
- `@Query()` å±æ€§è£…é¥°å™¨ï¼›


å…¶å®ƒå¯¹åº” express å¯¹è±¡çš„è£…é¥°å™¨ï¼š

|        nest è£…é¥°å™¨       |           express å¯¹è±¡           |
|--------------------------|----------------------------------|
| @Request() @Req()        | req                              |
| @Response() @Res()       | res                              |
| @Next()                  | next                             |
| @Session()               | req.session                      |
| @Param(param?: string)   | req.params / req.params[param]   |
| @Body(param?: string)    | req.body / req.body[param]       |
| @Query(param?: string)   | req.query / req.query[param]     |
| @Headers(param?: string) | req.headers / req.headers[param] |
| @Ip()                    | req.ip                           |
| @HostParam()             | req.hosts                        |


## ğŸ‘‰ Modules ç¨‹åºæ¨¡å—
- https://docs.nestjs.com/modules
- https://docs.nestjs.com/fundamentals/dynamic-modules

æ¯ä¸ª Nest åº”ç”¨è‡³å°‘éœ€è¦ä¸€ä¸ªæ¨¡å—ï¼Œå³æ ¹æ¨¡å— root moduleï¼Œæ˜¯ä¸€ä¸ªä½¿ç”¨ `@Module()` è£…é¥°å™¨è¿›è¡Œå®šä¹‰çš„ç±»å‹ï¼Œæ¨¡å—ä½¿ç”¨æ§åˆ¶å™¨è¿›è¡Œè·¯ç”±å®šä¹‰å’Œå®ç°å„ä¸ª HTTP å“åº”æ–¹æ³•ã€‚

æ¨¡å—æä¾›ä»¥ä¸‹å››ä¸ªæ³¨å†Œåˆ—è¡¨ï¼š

- `providers`   ä¾èµ–æ³¨å†Œåˆ—è¡¨ï¼Œæ‰€æœ‰ä¾›åº”å™¨éƒ½å¯ä»¥åœ¨è¿™é‡Œæ³¨å†Œï¼Œä¾›å½“å‰æ¨¡å—æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼›
- `controllers` æ¨¡å—ä½¿ç”¨åˆ°çš„æ§åˆ¶å™¨æ³¨å†Œåˆ—è¡¨ï¼›
- `imports` å¯¼å…¥å…¶å®ƒæ¨¡å—ï¼›
- `exports` å¯¼å‡ºå½“å‰æ¨¡å—ä¾›å…¶å®ƒæ¨¡å—å¯¼å…¥ä½¿ç”¨ï¼›

ä½œä¸ºç¨‹åºçš„åŸºæœ¬è¿è¡Œå•å…ƒï¼Œç”± `NestFactory` å®ä¾‹åŒ–ç¨‹åºæ¨¡å—ï¼Œé»˜è®¤å•ä¾‹ `Singleton`ï¼Œå¯ä»¥åœ¨å¤šä¸ªæ¨¡å—ä¹‹é—´å…±äº«ï¼Œåªéœ€è®¾ç½®åˆ°æ¨¡å— exports æ•°ç»„ä¸­å¹¶å¯¼å‡ºã€‚å¹¶ä¸”ï¼Œå¯ä»¥å°†å¯¼å…¥çš„æ¨¡å—å†æ¬¡å¯¼å‡ºã€‚

å¯¹äºé‚£äº›é€šç”¨çš„æ¨¡å—ï¼Œå¦‚åŠ©æ‰‹æ¨¡å—ï¼Œå¯ä»¥æŒ‰å…¨å±€æ¨¡å—å¤„ç†ï¼Œä½¿ç”¨ `@Global()` è£…é¥°å™¨ä¿®é¥°å®ƒç„¶åéšå¤„å¯ç”¨ï¼Œè¿™æ ·å°±ä¸ç”¨åˆ°å¤„æ³¨å†Œã€‚

ä½¿ç”¨è„šæ‰‹æ¶å¯ä»¥è‡ªåŠ¨ç”Ÿæˆç¨‹åºæ¨¡å—ï¼š

    $ nest g module cats

ç¤ºèŒƒä»£ç å¦‚ä¸‹ app.module.tsï¼š

```ts
import { Module, Global } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { CatsController } from './cats/cats.controller';
import { CreateCatDto, ListAllEntities, UpdateCatDto } from './cats/dto';
import { CatsService } from './cats/cats.service';

@Global()
@Module({
  imports: [],
  controllers: [AppController, CatsController],
  providers: [AppService, CreateCatDto, UpdateCatDto, ListAllEntities, CatsService],
})
export class AppModule {}
```

ç„¶åå°±æ˜¯ä¸»ç¨‹å…¥å£ï¼Œå®ä¾‹åŒ–ç¨‹åºæ¨¡å—ï¼Œåœ¨ REST åº”ç”¨ä¸­å¯ä»¥ä¼ å…¥å¦‚ CORS è¿™æ ·çš„å‚æ•°ï¼š

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe } from './pipes/validation.pipe';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // const app = await NestFactory.create(AppModule, { cors: true });
  // app.enableCors();
  // app.useGlobalPipes(new ValidationPipe());
  await app.listen(3001);
}
bootstrap();
```



Nest æœ‰ä¸€ä¸ªåŠ¨æ€æ¨¡å—çš„æ¦‚å¿µï¼Œå³å¯ä»¥åŠ¨æ€é…ç½® Providers çš„æ¨¡å—ï¼Œç®€å•è¯´å°±æ˜¯é€šè¿‡é™æ€ç±»æˆå‘˜ `forRoot()` åŒæ­¥æˆ–å¼‚æ­¥åœ°è¿”å›ä¸€ä¸ªæ¨¡å—å¯¹è±¡ï¼Œæ¯”å¦‚é€šè¿‡ Promise æ–¹å¼ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•å®ç°æŒ‡å®šé…ç½®é€‰é¡¹ï¼Œå³åŠ¨æ€é…ç½®ã€‚

ç¤ºèŒƒ DatabaseModule åŠ¨æ€æ¨¡å—çš„å®šä¹‰ï¼š

```ts
import { Module, DynamicModule } from '@nestjs/common';
import { createDatabaseProviders } from './database.providers';
import { Connection } from './connection.provider';

@Module({
  providers: [Connection],
})
export class DatabaseModule {
  static forRoot(entities = [], options?): DynamicModule {
    const providers = createDatabaseProviders(options, entities);
    return {
      // global: true,
      module: DatabaseModule,
      providers: providers,
      exports: providers,
    };
  }
}
```

å¦‚æœè¦åœ¨å…¨å±€ä¸­ä½¿ç”¨åŠ¨æ€æ¨¡å—ï¼Œè¯·å°† `global` é…ç½®æ‰“å¼€ï¼Œé€šå¸¸æ³¨å†Œä¸ºå…¨å±€å¹¶ä¸æ˜¯ä»€ä¹ˆå¤ªå¥½çš„ç‚¹å­ã€‚

ä½¿ç”¨åŠ¨æ€æ¨¡å—ï¼Œå°±åœ¨å¯¼å…¥æ—¶æ‰§è¡Œ `forRoot()` é™æ€æ–¹æ³•ï¼š 

```ts
import { Module } from '@nestjs/common';
import { DatabaseModule } from './database/database.module';
import { User } from './users/entities/user.entity';

@Module({
  imports: [DatabaseModule.forRoot([User])],
  // exports: [DatabaseModule],
})
export class AppModule {}
```

åŠ¨æ€æ¨¡å—çš„ä¸€ä¸ªç¤ºèŒƒåœºæ™¯å°±æ˜¯å®ç°ç±»ä¼¼æ’ä»¶æœºåˆ¶çš„åŠŸèƒ½ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ FUNDAMENTALS éƒ¨åˆ†ï¼š

```ts
@Module({
  imports: [ConfigModule.register({ folder: './config' })],
  controllers: [AppController],
  providers: [AppService],
})
```



## ğŸ‘‰ Provider & DI ä¾èµ–æ³¨å…¥
- https://docs.nestjs.com/providers
- https://docs.nestjs.com/fundamentals/custom-providers
- https://docs.nestjs.com/fundamentals/injection-scopes
- https://docs.nestjs.com/fundamentals/circular-dependency
- https://docs.nestjs.com/fundamentals/module-ref

Nest çš„è®¾è®¡ç†å¿µæ˜¯ï¼šä¸‡ç‰©çš† Provider æœåŠ¡ï¼Œå¦‚æœåŠ¡ç±» Serviceã€ä»“åº“ç±» Repositoryã€å·¥å‚ç±» Factoryã€åŠ©æ‰‹ç±» Helper ç­‰ç­‰ã€‚

ç®€å•æ¥è¯´ï¼Œ`ä¾èµ–æ³¨å…¥`è®¾è®¡æ¨¡å¼ DI - Dependency Injection æ—¨åœ¨æä¾›ä¸€ä¸ªä¾èµ–å…³ç³»çš„ç»Ÿä¸€ç®¡ç†ç¯å¢ƒã€‚ä»¥å‰é¢çš„æ§åˆ¶å™¨ä¸ºä¸ºä¾‹ï¼Œå®ƒéœ€è¦ä½¿ç”¨ `getHello()` æœåŠ¡ï¼Œè¿™å°±è¡¨ç¤ºæ§åˆ¶å™¨å¯¹ä¸€ä¸ª API çš„ä¾èµ–å…³ç³»ã€‚é€šè¿‡ DI ç¼–ç¨‹æ¨¡å¼ï¼Œåœ¨æœåŠ¡ç±»ä¸Šä½¿ç”¨ `@Injectable()` æ¥è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ³¨å…¥çš„å¯¹è±¡ï¼Œç„¶ååœ¨æ¨¡å—ä¸­åŒ¹é…ç›¸åº”çš„æœåŠ¡ä¾›åº”å™¨çš„æ³¨å…¥ã€‚

ä½¿ç”¨æ—¶ï¼Œåªéœ€è¦åœ¨æ§åˆ¶å™¨ä¸­ç›´æ¥å¼•ç”¨ï¼Œthis æŒ‡å‘çš„æ˜¯ä¸€ä¸ª DI æ¨¡å¼çš„å®¹å™¨å®ç°ï¼Œå®ƒå¯ä»¥å¤„ç†é‚£äº›å£°æ˜ä¸ºå¯ä»¥è¢«æ³¨å…¥çš„ç±»ï¼Œå¹¶åœ¨æ§åˆ¶å™¨éœ€è¦ä½¿ç”¨æ—¶æä¾›æœåŠ¡å®ä¾‹ã€‚æ‰€ä»¥ï¼Œåœ¨æ§åˆ¶å™¨ä¸­ï¼Œç›´æ¥å°±å¯ä»¥è°ƒç”¨å…¶ä¾èµ–çš„ AppService å®ä¾‹å¯¹è±¡ï¼Œè€Œæ— éœ€å…³å¿ƒ DI ç³»ç»Ÿæ˜¯å¦‚ä½•æä¾›æœåŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯ DI ç¼–ç¨‹æ¨¡å¼çš„ä¸€å¤§å¥½å¤„ï¼Œè§£è€¦ï¼Œçœå¿ƒã€‚

é€šå¸¸ï¼Œå®ç° DI å®¹å™¨æ˜¯é€šè¿‡ IoC - Inversion of Control æ§åˆ¶åè½¬å®ç°çš„ï¼Œè¿™æ˜¯å…¶ä¸­ä¸€ç§å¸¸è§çš„ DI å®¹å™¨å®ç°æ–¹å¼ã€‚


å¦‚æœç”¨ä¸€æ®µå¯¹è¯æ¥è§£æä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ç¼–ç¨‹æ¨¡å¼ï¼Œå¯èƒ½ä¼šæ¯”æ¡†æ¶å›¾æ›´å®¹æ˜“ç†è§£ï¼š

- Servicesï¼šä¸€å †çš„æœåŠ¡åœ¨è®¨è®ºå®ƒä»¬è¢«å¼€å§‹å«Œå¼ƒå¤ªéš¾ç®¡ç†äº†ï¼Œä½†æœåŠ¡å¤šä¸æ˜¯é”™ï¼›
- IoC Containerï¼šä½ ä»¬éƒ½åˆ«åµï¼Œæ¥æˆ‘è€åŒ…è¿™é‡Œç™»è®°ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥çš„å·¥ä½œæˆ‘è·Ÿç”¨æˆ·å¯¹æ¥ï¼›
- Customerï¼šå¬è¯´è€åŒ…é‚£é‡Œä»€ä¹ˆäººæ‰éƒ½æœ‰ï¼Œä»¥åä¸ç”¨è·Ÿä¸€å †çš„ Services æ‰¯éº»çº¿äº†ï¼Œç›´æ¥è·ŸåŒ…å·¥å¤´è¦äººï¼›
- Customerï¼šè€åŒ…ï¼Œæˆ‘æƒ³è¦ä¸€ä¸ªäººï¼Œä¼š TypeScript çš„å°±è¡Œï¼Œæœ‰å—ï¼Ÿ
- IoC Containerï¼šæ˜¯å—ï¼Œæˆ‘çœ‹çœ‹ç™»è®°æœ¬ï¼Œå“¦æœ‰ä¸€ä¸ªï¼Œå¯æ˜¯ A åœ¨æ‰¾ä¸€æœ¬ Thinking Java (äºŒæ¬¡ä¾èµ–)ã€‚
- IoC Containerï¼šæˆ‘çœ‹çœ‹ç™»è®°è¡¨æ˜¯ä¸æ˜¯æœ‰è¿™æœ¬ä¹¦ï¼Œè¯¶è¿™é‡Œè¿˜çœŸæœ‰ä¸€æœ¬ã€‚æŠŠä¹¦äº¤ç»™ A(ä¾èµ–æ³¨å…¥å·²ç»å‘ç”Ÿ)ï¼Œç„¶åé€ A åˆ° Customer é‚£é‡Œã€‚
- Customerï¼šå“Ÿï¼Œè¿™ä¹ˆå¿«æ‰¾åˆ°äººæ‰‹äº†å•Šï¼Œå¥½ç°åœ¨å°±å¼€å§‹åšäº‹......


è‡ªåŠ¨å¤„ç†ä¾èµ–ä¼šæœ‰ç§ç‰¹æ®Šæƒ…å†µï¼Œé‚£å°±æ˜¯ä¸¤ä¸ªç›¸äº’ä¾èµ–çš„ç±»å‹ï¼ŒåŒ…æ‹¬é—´æ¥çš„å¾ªç¯ä¾èµ–æˆ–è‡ªèº«ä¾èµ–ä¹Ÿç®—ï¼Œè¿™å« Circular dependencyï¼Œä¸è¿‡å¯ä»¥ç”¨ä¾èµ–è½¬å‘ Forward Referencing æŠ€æœ¯æ¥è§£å†³ã€‚ä½¿ç”¨ `ModuleRef` å³ Module Reference ç±»æˆ– `forwardRef()` æ–¹æ³•ï¼Œå®ç°é—´æ¥ä»å®¹å™¨ä¸­è·å–ä¾èµ–æœåŠ¡å®ä¾‹ã€‚è¿™ç§ä» Spring æ¡†æ¶å°±æµè¡Œçš„æ–¹æ³•å¾ˆå·§å¦™åœ°ä½¿ç”¨å¤šçº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå½“ç„¶ç›´æ¥åœ¨æœåŠ¡ç±»ä¸­å¾ªç¯å¼•ç”¨è¿™æ˜¯ä¸ªæ­»ç»“ã€‚é€šè¿‡æ”¹é€ ç±»çš„ç»“æ„ï¼Œä½¿åŸæ¥çš„ç›´æ¥ä¾èµ–ï¼Œè½¬å˜æˆå¯¹ç¼“å­˜å¯¹è±¡ä¾èµ–ã€‚å®ä¾‹åŒ–è¿‡ç¨‹ä¸­æŸ¥è¯¢ç¼“å­˜æ—¶ï¼Œå¦‚æœå‘ç°æ²¡æœ‰ç›¸åº”çš„ä¾èµ–å¯¹è±¡ï¼Œå°±å…ˆè¿›è¡Œæš‚å­˜ï¼Œç­‰åˆ°å…¶å®ƒå¯ä»¥ä¼˜å…ˆå®ä¾‹åŒ–çš„æµç¨‹å…ˆèµ°ä¸€éï¼Œå†å›è¿‡å¤´æ¥è§£å†³å¾ªç¯ä¾èµ–çš„æœåŠ¡ã€‚

```ts
import { Injectable, forwardRef } from '@nestjs/common';

// cats.service.ts

@Injectable()
export class CatsService {
  constructor(
    @Inject(forwardRef(() => CommonService))
    private commonService: CommonService,
  ) {}
}

// common.service.ts

@Injectable()
export class CommonService {
  constructor(
    @Inject(forwardRef(() => CatsService))
    private catsService: CatsService,
  ) {}
}

// common.module.ts
@Module({
  imports: [forwardRef(() => CatsModule)],
})
export class CommonModule {}
```

ä½¿ç”¨ `ModuleRef` å·¥å…·ç±»è§£å†³å¾ªç¯å¼•ç”¨å‚è€ƒï¼š

```ts
// cats.service.ts
import { Injectable } from '@nestjs/common';
import { ModuleRef } from '@nestjs/core'

@Injectable()
export class CatsService implements OnModuleInit {
  private service: Service;
  constructor(private moduleRef: ModuleRef) {}

  onModuleInit() {
    this.service = this.moduleRef.get(Service);
  }
}
```

### å››ç§æœåŠ¡ä¾èµ–å®šä¹‰æ–¹å¼

Nest.js æä¾›å››ç§æœåŠ¡ä¾èµ–å®šä¹‰æ–¹å¼ï¼š

- `useClass` æœåŠ¡ç±»ï¼›
- `useValue` æ•°æ®ä¾èµ–ï¼š
- `useFactory` åŠ¨æ€åœ°åˆ›å»ºæœåŠ¡ä¾èµ–;
- `useExisting` åˆ«åæ–¹å¼ï¼›

é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª cats.service.tsï¼ŒåŒ…æ‹¬æµ‹è¯•æ ·ä¾‹æ–‡ä»¶ï¼Œä¿å­˜åœ¨ /src/cats ç›®å½•ä¸‹ï¼š

    nest g service cats

```ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class CatsService {
  log(){
    console.log("CatsService from nest g service cats")
  }
}
```

å¹¶ä¸”ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°ç¨‹åºæ ¹æ¨¡å—ä¸­ï¼š

```js
@Module({
  imports: [/*import app modules*/],
  controllers: [AppController],
  providers: [AppService, CatsService],
})
```

é€šè¿‡ä¾èµ–æ³¨å…¥çš„å¯¹è±¡éœ€è¦åœ¨ç±»æ„é€ å‡½æ•°ä¸­ä½œä¸ºæ³¨å…¥ç‚¹ï¼Œä¸èƒ½é€šè¿‡æ–¹æ³•æ³¨å…¥ã€‚

```ts
@Controller('cats')
export class CatsController {
  constructor(private readonly catsService: CatsService) {}
  
  @Post()
  create(@Body() body, catsService: CatsService) {
    console.log('catsService', this.catsService, catsService,  body);
    return 'This action adds a new cat';
  }
}
```

å®é™…ä¸Šï¼Œä»¥ä¸Šæ³¨å†Œè¡¨è¾¾å¼æ˜¯ç®€åŒ–çš„ï¼Œå®Œæ•´çš„è¡¨è¾¾åº”è¯¥å¦‚ä¸‹ï¼š

```ts
providers: [
  {
    provide: CatsService,   // Token
    useClass: CatsService,  // Class
  },
];
```

æ€»ç»“ä¸€ä¸‹ DI æœåŠ¡ç±»çš„è¦ç‚¹ï¼š

- ä½¿ç”¨ `@Injectable()` å®ç°æœåŠ¡å™¨ï¼›
- åœ¨ç¨‹åºæ¨¡å—çš„ `providers` åˆ—è¡¨æ·»åŠ ä»¥æ³¨å†ŒæœåŠ¡ï¼›
- åœ¨éœ€è¦ä½¿ç”¨çš„ç±»ä¸­ï¼Œåœ¨æ„é€ å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­å£°æ˜æœåŠ¡ç±»å½¢çš„å‚æ•°ï¼Œå®Œæˆä¾èµ–æ³¨å…¥ï¼›

é™¤äº† `useClass` æ³¨å†ŒæœåŠ¡ç±»ï¼Œè¿˜å¯ä»¥æ³¨å†Œéç±»å¯¹è±¡çš„ä¾èµ–ï¼Œä½¿ç”¨ `useValue` å®šä¹‰æ•°æ®ä¾èµ–ï¼š

```ts
import { CatsService } from './cats.service';

const mockCatsService = {
  /* mock implementation
  ...
  */
};

@Module({
  imports: [CatsModule],
  providers: [
    {
      provide: CatsService,
      useValue: mockCatsService,
    },
  ],
})
export class AppModule {}
```

éç±»å¯¹è±¡ä¾èµ– Non-class-based éœ€è¦æ ¹æ® provider tokens æ¥ç¡®å®šå¦‚ä½•æ³¨å…¥ï¼Œæ¯”å¦‚æ³¨å†Œæ—¶è®¾ç½®çš„ Provide Token ä¸º "CONNECTION"ï¼Œé‚£ä¹ˆå°±æŒ‰å¦‚ä¸‹ä½¿ç”¨ `@Inject()` æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œéœ€è¦å¯¼å‡ºæ—¶ä¹ŸåŒæ ·å°† Token å¡«å†™åœ¨ `exports` åˆ—è¡¨ä¸­ï¼š

```ts
import { Inject } from '@nestjs/common';

@Injectable()
export class CatsRepository {
  constructor(@Inject('CONNECTION') connection: Connection) {}
}
```

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹å¼‚åŠŸèƒ½çš„æœåŠ¡ï¼Œ`useFactory` åŠ¨æ€åœ°åˆ›å»ºæœåŠ¡ä¾èµ–ï¼Œå’Œåˆ«å `useExisting`ï¼Œå‚è€ƒä»£ç ï¼š

```ts
@Injectable()
class LoggerService {
  /* implementation details */
}

const loggerAliasProvider = {
  provide: 'AliasedLoggerService',
  useExisting: LoggerService,
};

const connectionFactory = {
  provide: 'CONNECTION',
  useFactory: (optionsProvider: OptionsProvider) => {
    const options = optionsProvider.get();
    return new DatabaseConnection(options);
  },
  inject: [OptionsProvider],
};

@Module({
  providers: [connectionFactory, LoggerService, loggerAliasProvider],
})
export class AppModule {}
```

ç‰¹åˆ«åœ°ï¼Œ`useFactory` åŠ¨æ€æœåŠ¡ä¾èµ–å¯ä»¥ç»“åˆ async/await å®ç°å¼‚æ­¥ç¼–ç¨‹è¿”å› Promiseï¼š

```ts
{
  provide: 'ASYNC_CONNECTION',
  useFactory: async () => {
    const connection = await createConnection(options);
    return connection;
  },
}
```

### Injection Scope æ³¨å…¥ä½œç”¨åŸŸ
- https://docs.nestjs.com/fundamentals/injection-scopes

åœ¨ Nest åº”ç”¨ä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯åœ¨ä¼ å…¥çš„è¯·æ±‚ä¹‹é—´å…±äº«çš„ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼Œå…·æœ‰å…¨å±€çŠ¶æ€çš„å•ä¾‹æœåŠ¡å®¹å™¨ç­‰ç­‰ã€‚è®°ä½ï¼ŒNode.js ä¸éµå¾ªè¯·æ±‚/å“åº”å¤šçº¿ç¨‹æ— çŠ¶æ€æ¨¡å‹ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ç”±å•ç‹¬çš„çº¿ç¨‹å¤„ç†ã€‚å› æ­¤ï¼Œå¯¹äº Nest åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œä½¿ç”¨å•ä¾‹å®ä¾‹æ˜¯å®Œå…¨å®‰å…¨çš„ã€‚

ä½†æ˜¯ï¼Œåœ¨ä¸€äº›è¾¹ç¼˜æƒ…å†µï¼ŒåŸºäºè¯·æ±‚çš„ç”Ÿå­˜å‘¨æœŸå¯èƒ½æ˜¯æ‰€éœ€çš„è¡Œä¸ºï¼Œä¾‹å¦‚ GraphQL æŸ¥è¯¢æ¥å£åº”ç”¨ç¨‹åºä¸­çš„æ¯ä¸ªè¯·æ±‚ç¼“å­˜ã€è¯·æ±‚è·Ÿè¸ªå’Œ`å¤šé‡ç§Ÿèµæ¶æ„` Multi-Tenancyï¼Œæ³¨å…¥ä½œç”¨åŸŸé…ç½®æä¾›äº†ä¸€ç§è·å¾—æ‰€éœ€çš„ Provider ç¨‹åºç”Ÿå­˜æœŸè¡Œä¸ºçš„æœºåˆ¶ã€‚

ç®€å•è¯´å°±æ˜¯é€šè¿‡è®¾ç½®ä¸åŒçš„æ³¨å…¥ä½œç”¨åŸŸï¼Œå¾—åˆ°ä¸ä¸€æ ·çš„ä¾èµ–æ³¨å…¥æ•ˆæœã€‚

æä¾›ä»¥ä¸‹ä¸‰ç§ Provider scopeï¼š

- `DEFAULT` é»˜è®¤çš„æ³¨å…¥ä½œç”¨åŸŸï¼ŒSingleton å•ä¾‹æ³¨å…¥ï¼Œæ¨èä½¿ç”¨ã€‚ä¾èµ–æ³¨å…¥çš„å®ä¾‹åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å…±äº«ï¼Œå’Œåº”ç”¨ç¨‹åºåŒç”Ÿå‘½å‘¨æœŸï¼›
- `REQUEST` æ¯ä¸€è¯·æ±‚ä½œç”¨åŸŸï¼Œåœ¨æ¯ä¸ªå…¥ç«™è¯·æ±‚å®ä¾‹æ³¨å…¥ï¼Œå³æ¯ä¸ªè¯·æ±‚å¯¹åº”çš„ä¾èµ–éƒ½æ˜¯æ–°çš„å®ä¾‹ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å®Œæˆåæ¸…ç†ï¼›
- `TRANSIENT` æš‚æ€ä½œç”¨åŸŸï¼Œä¾èµ–å®ä¾‹ä¸ä¼šåœ¨ä½¿ç”¨è€…ä¹‹é—´å…±äº«ï¼Œæ¯ä¸ªä½¿ç”¨è€…å°†æ”¶åˆ°ä¸€ä¸ªæ–°çš„ä¸“ç”¨å®ä¾‹ã€‚

é…ç½®ç¤ºèŒƒï¼š

```ts
import { Injectable, Scope } from '@nestjs/common';

@Injectable({ scope: Scope.REQUEST })
export class CatsService {}
```

æˆ–è€…åœ¨ç¨‹åºæ¨¡å—ä¸­æ³¨å†Œæ—¶æŒ‡å®šï¼š

```js
{
  provide: 'CACHE_MANAGER',
  useClass: CacheManager,
  scope: Scope.TRANSIENT,
}
```

å¯¹äºæ§åˆ¶å™¨ï¼Œä¹Ÿç±»ä¼¼åœ°åœ¨è£…é¥°å™¨ä¸­æŒ‡å®šæ³¨å…¥ä½œç”¨åŸŸï¼š

```ts
@Controller({
  path: 'cats',
  scope: Scope.REQUEST,
})
export class CatsController {}

```

åŸºäº HTTP çš„æœåŠ¡å™¨åº”ç”¨ï¼Œå¦‚ä½¿ç”¨ `@nestjs/platform-express` æˆ–è€… `@nestjs/platform-fastify`ï¼Œåœ¨ä½¿ç”¨ Scope.REQUEST æ—¶é€šå¸¸ä¼šéœ€è¦è®¿é—®åŸå§‹çš„è¯·æ±‚å¯¹è±¡ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼æ‰§è¡Œä¾èµ–æ³¨å…¥ `REQUEST`ï¼š


```ts
import { Injectable, Scope, Inject } from '@nestjs/common';
import { REQUEST } from '@nestjs/core';
import { Request } from 'express';

@Injectable({ scope: Scope.REQUEST })
export class CatsService {
  constructor(@Inject(REQUEST) private request: Request) {}
}
```

è€Œå¯¹äº GraphQL åº”ç”¨ï¼Œç”±äºåº•å±‚åè®®å·®å¼‚ï¼Œéœ€è¦ä¸º Microservice æˆ– GraphQL åº”ç”¨æ³¨å…¥ `CONTEXT` è€Œä¸æ˜¯ `REQUEST`ï¼š

```ts
import { Injectable, Scope, Inject } from '@nestjs/common';
import { CONTEXT } from '@nestjs/graphql';

@Injectable({ scope: Scope.REQUEST })
export class CatsService {
  constructor(@Inject(CONTEXT) private context) {}
}
```




## ğŸ‘‰ Controllers æ§åˆ¶å™¨
- https://docs.nestjs.com/controllers

æ§åˆ¶å™¨å¸¸ç”¨è£…é¥°å™¨ï¼š

- `@Controller('cats')` ä¿®é¥°æ§åˆ¶å™¨ç±»ï¼Œå‚æ•° 'cats' è¡¨ç¤ºè·¯ç”±è§„åˆ™ä¸­ä½¿ç”¨ '/cats' è·¯å¾„ï¼›
- `@Controller({ host: 'admin.example.com' })` ç»™æ§åˆ¶å™¨ç»‘å®šå­åŸŸåï¼›
- `@Post()` è£…é¥°ä¸€ä¸ª HTTP POST è¯·æ±‚çš„å“åº”æ–¹æ³•ï¼›
- `@Get(':id')` è£…é¥°ä¸€ä¸ª HTTP GET è¯·æ±‚çš„å“åº”æ–¹æ³•ï¼Œå¹¶å®šä¹‰è·¯å¾„åŒ…å« id å‚æ•°ï¼Œé…åˆ `@Param('id')` ç»‘å®šè·¯å¾„å‚æ•°åˆ°æ–¹æ³•å±æ€§ï¼›

å¯ä»¥ä¸ºæ§åˆ¶å™¨æ–¹æ³•ç»‘å®šå¤šæ¡è·¯ç”±ï¼Œä»¥åŠå¤šä¸ªå‚æ•°å®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š

```js
@Get(['/:id/:name', ':id'])
findOne(@Param('id') id: string, @Param('name') name: string) {
    return `This action returns a #${id} cat ${name}`;
}
```

å®Œæ•´çš„ HTTP è°“è¯å¯¹åº”çš„è£…é¥°å™¨æœ‰ @Get(), @Post(), @Put(), @Delete(), @Patch(), @Options(), è¿˜æœ‰ @Head() å’Œ @All()

å¦å¤–ï¼Œæ”¯æŒ Promise å¼‚æ­¥ç¼–ç¨‹ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡ async/await å®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚

POST æäº¤æ•°æ®å¯ä»¥ä½¿ç”¨ CURL æ¥è°ƒè¯•ï¼š

    curl -d "id=101" localhost:3000/cats

ä»¥ä¸‹è£…é¥°å™¨ç»‘å®šæ•°æ®åˆ°å‚æ•°ä¸Šï¼š

- `@Body()` è¡¨ç¤ºç»‘å®š HTTP POST è¯·æ±‚æ•°æ®ä½“ Request payloads åˆ°æ§åˆ¶å™¨æ–¹æ³•å‚æ•°ä¸Šï¼›
- `@Param('id')` è¡¨ç¤ºç»‘å®š URL ä¸­çš„è·¯å¾„å‚æ•°åˆ°æ§åˆ¶å™¨æ–¹æ³•çš„å±æ€§ä¸Šï¼Œå¦‚ URL '/cats/100' è¡¨ç¤ºå±æ€§å°†ç»‘å®šå€¼ä¸º 100ï¼›
- `@HostParam('account')` ç»‘å®šä¸»æœºå‚æ•°åˆ°æ–¹æ³•å‚æ•°ä¸Šï¼›
- `@Query('name')` è¡¨ç¤ºç»‘å®š URL çš„ name è¯·æ±‚å‚æ•°åˆ°æ–¹æ³•çš„å‚æ•°ä¸Šï¼Œå¦‚ URL '/cats?name=Jeango' è¡¨ç¤ºå±æ€§ç»‘å®šå€¼ä¸º "Jeango"ï¼›
- `@HttpCode(204)` ç»‘å®š HTTP çŠ¶æ€ç ï¼›
- `@Header('Cache-Control', 'none')` ç»‘å®š HTTP å“åº”å¤´ï¼›
- `@Redirect('https://nestjs.com', 301)` ç»‘å®š 301 æ°¸ä¹…æ€§è½¬ç§» Permanently Movedï¼Œé»˜è®¤æ˜¯ 302 æš‚æ—¶æ€§è½¬ç§» Temporarily Movedï¼›

Nest.js è·¯ç”±æ”¯æŒé€šæ­£åˆ™æ¨¡å¼åŒ¹é…ï¼Œå­—ç¬¦ ?ã€+ã€* ä»¥åŠ () æ˜¯æ­£åˆ™è¡¨è¾¾å¼å¯¹åº”é¡¹ï¼Œæ˜Ÿå·è¢«ç”¨ä½œé€šé…ç¬¦ï¼Œå°†åŒ¹é…ä»»ä½•å­—ç¬¦ç»„åˆã€‚è¿å­—ç¬¦ (-) å’Œç‚¹ (.) æŒ‰å­—ç¬¦ä¸²è·¯å¾„è§£æã€‚

å¦‚æœè¦ä½¿ç”¨æ›´åº•å±‚çš„ HTTP è¯·æ±‚æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `Response` `Request` å¯¹è±¡ï¼š

```ts
  create(@Res() res: Response) {
    res.status(HttpStatus.CREATED).send();
  }

  findAll(@Req() request: Request): string {
    return 'This action returns all cats';
  }
```


ä¾‹å¦‚ï¼Œä½¿ç”¨å±æ€§è£…é¥°å™¨ï¼Œå¾€ app.controller.ts çš„ GET æ–¹æ³•ä¸­ç»‘å®šå‚æ•°ï¼š

```ts
// app.controller.ts
import { Query } from '@nestjs/common';

@Get()
getHello(@Query('name') name: string = 'Victor'): string {
    return this.appService.getHello(name);
}


// app.service.ts
@Injectable()
export class AppService {
  getHello(name: string = 'World'): string {
    return `Hello ${name}!`;
  }
}

// app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

è®¿é—® http://localhost:3000/?name=Jeango æµ‹è¯•æŸ¥è¯¢å‚æ•°ä¼ å…¥ã€‚


æ§åˆ¶å™¨é€šè¿‡è£…é¥°å™¨ç»‘å®šè·¯ç”±è§„åˆ™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª REST API æ§åˆ¶å™¨ç¤ºä¾‹ï¼Œç»‘å®šäº†å‰ç¼€ç›¸åº”åœ¨ URL ä¹Ÿè¦ä½¿ç”¨ cats è·¯å¾„ï¼š

```ts
// cats.controller.ts
import { Controller, Get, Query, Post, Body, Put, Param, Delete } from '@nestjs/common';
import { CatsService } from './cats/cats.service';
import { CreateCatDto, UpdateCatDto, ListAllEntities } from './dto';

@Controller('cats')
export class CatsController {
    constructor(private readonly catsService: CatsService) {}
  
  @Post()
  create(@Body() body: CreateCatDto) {
    console.log('createCatDto', this.catsService, body);
    return 'This action adds a new cat';
  }

  @Get()
  findAll(@Query() query, list: ListAllEntities) {
    console.log('query', list, query);
    return `This action returns all cats (limit: ${list} items)`;
  }

  @Get(['/:id/:name', ':id'])
  findOne(@Param('id') id: string, @Param('name') name: string) {
    return `This action returns a #${id} cat ${name}`;
  }

  @Put(':id')
  update(@Param('id') id: string, @Body() updateCatDto: UpdateCatDto) {
    return `This action updates a #${id} cat`;
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return `This action removes a #${id} cat`;
  }
}
```

æ³¨å†Œåˆ°ç¨‹åºæ¨¡å—çš„ providers åˆ—è¡¨ä¸­çš„æœåŠ¡ï¼Œå¯ä»¥åœ¨æ§åˆ¶å™¨çš„æ„é€ å‡½æ•°ä¸­æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œä½†æ³¨æ„ï¼Œè¿˜ä¸èƒ½åœ¨æ–¹æ³•ä¸­æ³¨å…¥ä¾èµ–ã€‚

POST æ•°æ®æµ‹è¯•è¯·ä½¿ç”¨ CURLï¼š

    curl -d "id=101" localhost:3000/cats



## ğŸ‘‰ Pipe & DTO ä½¿ç”¨ç®¡é“å¤„ç†æ•°æ®
- https://github.com/typestack/class-validator
- class-validator è‡ªåŠ¨éªŒè¯ https://zhuanlan.zhihu.com/p/87039375
- http://npmjs.com/package/class-transformer
- https://docs.nestjs.com/pipes

è¿™é‡Œå¼•å…¥äº† DTO - Data Transfer Object æ•°æ®ä¼ è¾“å¯¹è±¡æ¦‚å¿µï¼Œåœ¨ä¸¤ç«¯ç‚¹ä¹‹é—´ä¼ è¾“æ•°æ®çš„è½¯ä»¶ï¼Œå¾€å¾€éœ€è¦å¯¹æ•°æ®æ¥æºè¿›è¡Œä¸€æ¬¡éªŒè¯å¤„ç†ï¼Œè€Œ DTO è®¾è®¡æ¨¡å¼ä¸‹ï¼Œå¯ä»¥æ¸…æ™°åœ°è¡¨è¾¾æ•°æ®è½¬æ¢åˆ°å¯¹è±¡åçš„ç»“æ„ï¼Œä½¿ç”¨ Pipes ç®¡é“é…åˆ class-validator å¯¹å‚æ•°ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨éªŒè¯å¤±è´¥çš„æ—¶å€™æŠ›å‡ºé”™è¯¯ä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¿¡æ¯ï¼Œåƒè¿™æ ·ç»™è£…é¥°å™¨è®¾ç½®é€‰é¡¹ï¼š

    @IsArray({message:'æ•°ç»„ ä¸èƒ½ä¸ºç©º'})

å¯é€‰é¡¹å‚è€ƒæ¥å£ `ValidatorOptions` å®šä¹‰ï¼š

    /**
     * Specifies if validated value is an array and each of its items must be validated.
     */
    each?: boolean;
    /**
     * Error message to be used on validation fail.
     * Message can be either string or a function that returns a string.
     */
    message?: string | ((validationArguments: ValidationArguments) => string);
    /**
     * Validation groups used for this validation.
     */
    groups?: string[];
    /**
     * Indicates if validation must be performed always, no matter of validation groups used.
     */
    always?: boolean;
    context?: any;


æ³¨æ„ï¼Œç±»è½¬æ¢å™¨åº“å’Œç±»éªŒè¯å™¨åº“ç”±åŒä¸€ä¸ªä½œè€…ä½œï¼Œä»–ä»¬ä¸€èµ·ç©ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œè®¾å®šçš„éªŒè¯ã€‚

    npm i --save class-validator class-transformer

é¦–å…ˆï¼Œæ ¹æ®éœ€è¦çº¦å®šä¸€ä¸‹ DTO ç±»çš„éªŒè¯æ¡ä»¶ï¼Œä½¿ç”¨ **readonly** å£°æ˜é¿å…å¯¹åŸå§‹æ•°æ®çš„ä¿®æ”¹ï¼š

```ts
import  { IsString, IsInt } from 'class-validator';
import { Injectable } from '@nestjs/common';

@Injectable()
export class CreateCatDto {

  @IsString()
  readonly name: string;

  @IsInt()
  readonly age: number;

  @IsString()
  readonly breed: string;
}
```

å½“ç„¶ï¼ŒNest æ”¯æŒä½¿ç”¨ Interface æ¥å®šä¹‰ DTOï¼Œä¸è¿‡ Nest å»ºè®®ä½¿ç”¨ Classï¼Œæ¯” Interface æ–¹ä¾¿ã€‚åŸå› æ˜¯ä½œä¸ºç±»å‹å£°æ˜çš„ interface åœ¨ç¼–è¯‘æˆåä¼šè¢«åˆ é™¤ï¼ŒåŒæ—¶ç”¨ä¸äº†è£…é¥°å™¨ï¼Œæ— æ³•åœ¨ swagger æ˜¾ç¤ºã€‚


åœ¨å‰é¢ï¼Œå·²ç»ä¸ºéœ€è¦åšéªŒè¯çš„ç±»ç±»è®¾ç½®å¥½æ ¡éªŒå±æ€§ï¼Œæ¥ä¸‹æ¥å°±åœ¨ç®¡é“ä¸­å¯¹æ•°æ®è¿›è¡ŒéªŒè¯æ“ä½œã€‚

ä½¿ç”¨ class-transformer æ¨¡å—ï¼Œå®ƒå¯ä»¥å®ç° Plain Object ä¸ Class å®ä¾‹å¯¹è±¡çš„äº’ç›¸è½¬æ¢ï¼Œä¾‹å¦‚å°† POST çš„ JSON å¯¹è±¡è½¬æ¢ä¸ºç±»ç±»å®ä¾‹ã€‚ç»è¿‡ç®¡é“çš„éªŒè¯è½¬æ¢åï¼Œå®¢æˆ·ç«¯æäº¤çš„ JSON Body æ•°æ®è½¬æ¢æˆåˆæ ¼çš„ç±»å®ä¾‹ï¼Œç„¶åå†é€šè¿‡ `@Body()` è£…é¥°å™¨ä¸æ§åˆ¶å™¨çš„å‚æ•° ç»‘å®šï¼Œå¹¶å°†ç±»å‹å®šä¹‰ä¸ºè½¬æ¢åçš„ç±»ç±»ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨ TypeScript çš„é™æ€ç±»å‹åŠŸèƒ½ã€‚

    curl localhost:3000/cats?a=a -d "{""a"":1}" -H "Content-Type: binary/octet-stream"
    curl localhost:3000/cats -d "{""name"":""Jean""}" -H "Content-Type: application/json"
    curl localhost:3001/cats -d "{""name"":""Jean"",""age"":""10""}" -H "Content-Type: application/json"

class-validator å¯¼å‡ºçš„ `validate` æ–¹æ³•è¿”å›åŒ…å« ValidationError å¯¹è±¡çš„ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒåŒ…å«é”™è¯¯æç¤ºä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```js
[
  ValidationError {
    target: CreateCatDto { name: 'Jeango', age: '10' },
    value: '10',
    property: 'age',
    children: [],
    constraints: { isInt: 'age must be an integer number' }
  },
  ValidationError {
    target: CreateCatDto { name: 'Jeango', age: '10' },
    value: undefined,
    property: 'breed',
    children: [],
    constraints: { isString: 'breed must be a string' }
  }
]
```

ç»‘å®šç®¡é“å’Œ Guards é‚£æ ·ï¼Œç›´æ¥ç”¨ä¿®é¥°ç¬¦ç»‘å®šåœ¨ Controller ä¸Šï¼Œç„¶åå°†æ§åˆ¶å™¨æ–¹æ³•çš„ @Body è£…é¥°çš„å‚æ•°ç±»å‹æŒ‡å®šä¸º DTO ç±»å‹å³å¯ã€‚

ç®¡é“ç±»éœ€è¦å®ç° PipeTransform interfaceï¼Œæœ‰ä¸¤ä¸ªå…¸å‹çš„ç”¨ä¾‹ï¼š

- `transformation`: æ•°æ®è½¬æ¢ï¼Œä¾‹å¦‚å°† string è½¬æ¢ä¸º integerï¼›
- `validation`: éªŒè¯æ•°æ®è¾“å…¥ï¼Œé€šè¿‡éªŒè¯å°±ç›´æ¥æ”¾è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸å¤„ç†ï¼›

åœ¨ `@nestjs/common` å¯¼å‡ºçš„å†…å»ºç®¡é“ Built-in pipesï¼š

- `ValidationPipe` 
- `ParseIntPipe` å†…ç½®ç®¡é“æ•°æ®ç±»å‹è½¬æ¢ string -> integer;
- `ParseBoolPipe`  å†…ç½®ç®¡é“æ•°æ®ç±»å‹è½¬æ¢ string -> boolean;
- `ParseArrayPipe` 
- `ParseUUIDPipe` 
- `DefaultValuePipe` 

ValidationPipe æ˜¯ Nest.js è‡ªå¸¦çš„ä¸‰ä¸ªå¼€ç®±å³ç”¨çš„ç®¡é“ä¹‹ä¸€ï¼Œå®ƒä¹Ÿæ˜¯ä¸º class-validator å®šåˆ¶çš„ï¼Œå…¶é€‰é¡¹æ¥å£ `ValidatorOptions` ä¼šåœ¨éªŒè¯æ—¶ä¼ é€’ç»™ç±»éªŒè¯æ¨¡å—ã€‚

æŒæ¡æ¦‚å¿µåï¼Œç”¨ä¸‹å‘½ä»¤åœ¨ pipes æ–‡ä»¶å¤¹åˆ›å»ºç®¡é“ç¨‹åº validation.pipe.tsï¼š

    $ nest g pipe validation pipes

ä»¥ä¸‹ä½œä¸ºä¸€ä¸ªå¸¦éªŒè¯æ“ä½œçš„ç®€å•ç®¡é“åŠŸèƒ½æ¼”ç¤ºï¼š

```ts
import { ArgumentMetadata, BadRequestException, Injectable, PipeTransform } from '@nestjs/common';

@Injectable()
export class ValidationPipe implements PipeTransform<any> {
  transform(value: any, metadata: ArgumentMetadata) {
    console.log("validation.pipe.ts...", value, metadata)
    if(value.name!=="Jeango"){
      throw new BadRequestException(`Validation failed: ${JSON.stringify(value)}`);
    }
    value.id = -1;
    return value;
  }
}
```

å®šä¹‰ Pipes å¤„ç†ç®¡é“ï¼Œéœ€è¦ä½¿ç”¨ `@Injectable()` è£…é¥°å™¨ä¿®é¥°ï¼Œä»¥è‡ªåŠ¨ä¾èµ–æ³¨å…¥ã€‚å¹¶ä¸”å®ç° `PipeTransform` æ¥å£ï¼Œåªæœ‰ä¸€ä¸ª `transform()` æ–¹æ³•ï¼Œé€šå¸¸ç”¨æ¥å¤„ç†è¾“å…¥æ•°æ®è½¬æ¢ï¼Œä¸ºåç»­æ­¥éª¤è¿›è¡Œæ•°æ®éªŒè¯ã€‚

è½¬æ¢æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•° `value` æ˜¯å½“å‰å¤„ç†çš„æ•°æ®å€¼ï¼Œè€Œ `metadata` æ˜¯å…¶å…ƒæ•°æ®å¯¹è±¡ï¼Œå‚è€ƒä»¥ä¸‹æ¥å£å®šä¹‰ï¼š

```ts
export interface ArgumentMetadata {
  readonly type: 'body' | 'query' | 'param' | 'custom';
  readonly metatype?: Type<any>;
  readonly data?: string;
}
```

å› æ­¤å®šä¹‰ç®¡é“ä½¿ç”¨äº† `@Injectable()` è£…é¥°å™¨ï¼Œæ‰€ä»¥é€šè¿‡ `@UsePipes()` ç»‘å®šç®¡é“æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è¿›è¡Œä¾èµ–æ³¨å…¥ã€‚

å‚è€ƒä»¥ä¸‹ä»£ç ï¼Œç»™æ§åˆ¶å™¨æ–¹æ³•ç»‘å®šç®¡é“éªŒè¯ï¼Œè¯­æ³•å’Œç»‘å®šå®ˆå«ç±»ä¼¼ï¼š

```js
@UseGuards(AuthGuard('jwt'))
@UsePipes(new ValidationPipe())
@Post('register')
async register(@Body() body: RegisterInfoDTO) {
  returnawaitthis.usersService.register(body);
}
```

å®˜æ–¹æ–‡æ¡£è¿˜æœ‰ç»™æ§åˆ¶å™¨æ–¹æ³•ç»‘å®šç®¡é“çš„ç¤ºèŒƒï¼Œä½¿ç”¨å†…ç½®çš„ `ParseIntPipe` ç®¡é“è¿›è¡Œå­—ç¬¦ä¸²è½¬æ•°å€¼ï¼š

```js
@Get(':id')
async findOne(@Param('id', ParseIntPipe) id: number) {
  return this.catsService.findOne(id);
}

@Get(':id')
async findOne(
  @Param('id', new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }))
  id: number,
) {
  return this.catsService.findOne(id);
}
```

å¯¹äºé€šç”¨åŠŸèƒ½ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å…¨å±€ç®¡é“ Global scoped pipesï¼Œä½¿ç”¨ main.ts ç¨‹åºå¯¹è±¡çš„ `useGlobalPipes()` æ–¹æ³•ç»‘å®šï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe());
  await app.listen(3000);
}
bootstrap();
```

è¯·æ³¨æ„ï¼Œä»»ä½•æ¨¡å—å¤–éƒ¨æ³¨å†Œçš„å…¨å±€ç®¡é“ä¸èƒ½æ³¨å…¥ä¾èµ–é¡¹ï¼Œå¦‚ä¸Šé¢ä½¿ç”¨ `useGlobalPipes()` æ³¨å†Œçš„éªŒè¯ç®¡é“ï¼Œå› ä¸ºç»‘å®šæ˜¯åœ¨ä»»ä½•æ¨¡å—çš„ä¸Šä¸‹æ–‡ä¹‹å¤–å®Œæˆçš„ã€‚

è§£å†³æ–¹æ³•æ˜¯ç›´æ¥åœ¨æ¨¡å—å®šä¹‰ä½¿ç”¨ä»¥ä¸‹æ„é€ è®¾ç½®å…¨å±€ç®¡é“ï¼š

```ts
import { Module } from '@nestjs/common';
import { APP_PIPE } from '@nestjs/core';

@Module({
  providers: [
    {
      provide: APP_PIPE,
      useClass: ValidationPipe,
    },
  ],
})
export class AppModule {}
```




## ğŸ‘‰ Middleware ä¸­é—´ä»¶
- https://docs.nestjs.com/middleware

ä¸­é—´ä»¶ Middleware ä¹‹æ‰€ä»¥ç§°ä¸ºä¸­é—´ä»¶ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨å®¢æˆ·è¯·æ±‚å’ŒæœåŠ¡å™¨è·¯ç”±å¤„ç†ä¹‹é—´æ‰§è¡Œï¼Œè¿™ç§åœ¨ç¨‹åºè¿è¡Œé€»è¾‘ä¸­æŸç‚¹æ‰§è¡Œçš„ç¼–ç¨‹æ–¹å¼ä¹Ÿå« AOP - Aspect Oriented Programming åˆ‡é¢ç¼–ç¨‹æ¨¡å¼ã€‚ä½ å¯ä»¥æƒ³è±¡ AOP å°±æ˜¯æ°´ç®¡ä¸Šçš„æ°´é˜€ï¼Œå½“ä¸‹æ¸¸çˆ†æ°´ç®¡æ—¶ï¼Œåªéœ€è¦æ‹§ç´§å®ƒå°±å¯ä»¥é¿å…æ°´æµæµªè´¹è¿˜å®¹æ˜“åšæ°´ç®¡ç»´æŠ¤å·¥ä½œã€‚

ä¸­é—´ä»¶å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥è®¿é—® request å’Œ response å¯¹è±¡ï¼Œå¹¶ä¸”ï¼Œ`next()` æ˜¯ä¸€ä¸ªå†…ç½®çš„ä¸­é—´ä»¶ï¼Œéœ€è¦åœ¨å„ä¸ªä¸­é—´ä»¶ä¸­æ‰§è¡Œï¼Œè¡¨ç¤ºå°†å®¢æˆ·è¯·æ±‚äº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†ã€‚

å½“ç„¶ï¼Œå®ç°ä¸€ä¸ªä¸­é—´ä»¶å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å®ç° `NestMiddleware` æ¥å£çš„ç±»å½¢ï¼Œä½†éƒ½éœ€è¦ä½¿ç”¨ `@Injectable()` è£…é¥°å™¨ã€‚

é€šå¸¸ï¼ŒNest ä¸­é—´ä»¶å°±æ˜¯ express middlewareï¼Œå®˜æ–¹æè¿°ä¸­é—´ä»¶çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

- æ‰§è¡Œä»»ä½•ä»£ç ï¼›
- ä¿®æ”¹ request & response å¯¹è±¡æ•°æ®ï¼›
- ç»ˆæ­¢å®¢æˆ·è¯·æ±‚å¤„ç†å’Œå“åº”ï¼›
- è°ƒç”¨ `next()` ä¸­é—´ä»¶ï¼Œä»¥æ‰§è¡Œå †æ ˆä¸­çš„å…¶å®ƒä¸­é—´ä»¶ï¼›
- å¦‚æœå½“å‰ä¸­é—´ä»¶ä¸ç»ˆæ­¢è¯·æ±‚å¤„ç†ï¼Œå°±è°ƒç”¨ `next()` å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¦åˆ™è¯·æ±‚ä¼šæŒ‚èµ·ï¼›

```ts
// logger.middleware.ts

import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...');
    next();
  }
}
```

å’Œå‰é¢è§£æè¿‡çš„ä¸€æ ·ï¼Œä¾èµ–æ³¨å…¥å¯ä»¥é€šè¿‡ç±»çš„æ„é€ å‡½æ•°æ‰§è¡Œã€‚

åœ¨ `@Module()` æ¨¡å—è£…é¥°å™¨ä¸­æ²¡æœ‰ä¸­é—´ä»¶çš„ä½ç½®ï¼Œä½¿ç”¨ä¸­é—´ä»¶éœ€è¦é€šè¿‡æ¨¡å—ç±»çš„ `configure()` æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå› æ­¤ï¼ŒåŒ…å«ä¸­é—´ä»¶çš„æ¨¡å—å¿…é¡»å®ç° `NestModule` æ¥å£ã€‚

ç¤ºèŒƒåœ¨ AppModule æ¨¡å—è®¾ç½® loggermdware ä¸­é—´ä»¶ï¼Œæ³¨æ„ `forRoutes()` æ–¹æ³•æŒ‡å®šäº†ä¸­é—´ä»¶åªå¯¹æŒ‡å®šçš„è·¯ç”±ç”Ÿæ•ˆï¼Œè€Œ `exclude()` è¡¨ç¤ºè¦æ’é™¤çš„è·¯ç”±ï¼š

```ts
// app.module.ts

import { Module, NestModule, MiddlewareConsumer } from '@nestjs/common';
import { LoggerMiddleware } from './common/middleware/logger.middleware';
import { CatsModule } from './cats/cats.module';

@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
      // .apply(cors(), helmet(), logger)
      .exclude(
        { path: 'cats', method: RequestMethod.GET },
        { path: 'cats', method: RequestMethod.POST },
        'cats/(.*)',
      )
      .forRoutes('cats');
      // .forRoutes({ path: 'cats', method: RequestMethod.GET });
      // .forRoutes({ path: 'ab*cd', method: RequestMethod.ALL });
  }
}
```

åŒæ ·ï¼Œå¯ä»¥æŒ‰å¼‚æ­¥æ–¹å¼ async/await å®ç° `configure()` æ–¹æ³•ï¼ŒMiddlewareConsumer çš„ `apply()` æ–¹æ³•å¯ä»¥ä¼ å…¥å¤šä¸ªä¸­é—´ä»¶ã€‚

è·¯ç”±æŒ‡å®šä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œå¯¹äºä½¿ç”¨ fastifyï¼Œå› ä¸ºä½¿ç”¨äº†æœ€æ–°çš„ `path-to-regexp` è€Œä¸å†æ”¯æŒæ˜Ÿå·é€šé…ç¬¦ï¼Œåº”è¯¥ä½¿ç”¨å‚æ•°ï¼Œå¦‚ `.*` `:splat*`ã€‚

å‡½æ•°å¼ä¸­é—´ä»¶å®šä¹‰ï¼š

```ts
import { Request, Response, NextFunction } from 'express';

export function logger(req: Request, res: Response, next: NextFunction) {
  console.log(`Request...`);
  next();
};
```

æ³¨å†Œå…¨å±€ä¸­é—´ä»¶æ›´å®¹æ˜“ï¼š

```ts
const app = await NestFactory.create(AppModule);
app.use(logger);
await app.listen(3000);
```


## ğŸ‘‰ Guards å®ˆå«
- https://docs.nestjs.com/guards
- https://docs.nestjs.com/security/authentication
- https://docs.nestjs.com/security/authorization
- https://docs.nestjs.com/fundamentals/execution-context
- https://docs.nestjs.com/security/cors
- https://docs.nestjs.com/security/csrf

å®ˆå«åªæœ‰ä¸€ä¸ªèŒè´£ï¼Œå°±æ˜¯æ ¹æ®è¿è¡Œæ—¶å­˜åœ¨çš„æŸäº›æ¡ä»¶ï¼Œå¦‚æƒé™ã€è§’è‰²ã€ACL - Access Control List ç­‰æ¡ä»¶ç¡®å®šæ˜¯å¦åº”è¯¥å°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„è·¯ç”±å¤„ç†ç¨‹åºï¼Œé€šå¸¸ç§°ä¸ºèº«ä»½éªŒè¯æˆ–é‰´æƒ Authentication & Authorizationã€‚

åœ¨å¾®æœåŠ¡å½“é“çš„ä¸–ç•Œï¼ŒåŸºäº Session çš„ä¼ ç»Ÿè®¤è¯æ‰€æ˜¾éœ²çš„é—®é¢˜è¶Šæ¥è¶Šçªå‡ºï¼š

- Session: è®¤è¯ä¿¡æ¯éœ€è¦åœ¨æœåŠ¡ç«¯ä¿å­˜ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·ä¸‹æ¬¡é‰´æƒï¼Œé€šå¸¸ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œéšç€è®¤è¯ç”¨æˆ·çš„å¢å¤šå¼€é”€ä¼šæ˜æ˜¾å¢å¤§ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡ Redis ç­‰è¿›è¡Œå¤–éƒ¨å­˜å‚¨ã€‚
- å¯æ‰©å±•æ€§ä¸è¶³: è®¤è¯çš„è®°å½•è¢«ä¿å­˜åœ¨å†…å­˜ä¸­çš„è¯ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚è¿˜å¿…é¡»è¦è¯·æ±‚åœ¨è¿™å°æœåŠ¡å™¨ä¸Šï¼Œé™åˆ¶äº†åˆ†å¸ƒå¼çš„åº”ç”¨ã€‚
- CSRF è·¨ç«™æ”»å‡»: åŸºäº Cookie ä¼ é€’ï¼Œå½“å®ƒè¢«æˆªè·ï¼Œå°±å¾ˆå®¹æ˜“å—åˆ°è·¨ç«™è¯·æ±‚ä¼ªé€ çš„æ”»å‡»ã€‚


æµè¡Œçš„é‰´æƒæœºåˆ¶åŸºäº Tokenï¼Œå®ƒä¸éœ€è¦åœ¨æœåŠ¡ç«¯å»ä¿ç•™ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯æˆ–è€…ä¼šè¯ä¿¡æ¯ã€‚è¿™å°±æ„å‘³ç€åŸºäº Token è®¤è¯æœºåˆ¶çš„åº”ç”¨ä¸éœ€è¦å»è€ƒè™‘ç”¨æˆ·åœ¨å“ªä¸€å°æœåŠ¡å™¨ç™»å½•äº†ï¼Œè¿™å°±ä¸ºåº”ç”¨çš„æ‰©å±•æä¾›äº†ä¾¿åˆ©ã€‚

åŸºæœ¬æµç¨‹ï¼š

- ç”¨æˆ·è¯·æ±‚ç™»å½•æœåŠ¡å™¨ï¼›
- æœåŠ¡å™¨éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼›
- æœåŠ¡å™¨é€šè¿‡éªŒè¯å‘é€ç»™ç”¨æˆ·ä¸€ä¸ª Tokenï¼›
- å®¢æˆ·ç«¯å­˜å‚¨ Token å¹¶åœ¨æ¯æ¬¡è¯·æ±‚æ—¶é™„é€ä¸Šï¼›
- æœåŠ¡ç«¯éªŒè¯ Token å€¼ï¼Œå¹¶è¿”å›æ•°æ®ï¼›

è¿™ä¸ª Token å¿…é¡»è¦åœ¨æ¯æ¬¡è¯·æ±‚æ—¶ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œå®ƒåº”è¯¥ä¿å­˜åœ¨è¯·æ±‚å¤´é‡Œï¼Œå¦å¤–ï¼ŒæœåŠ¡ç«¯è¦æ”¯æŒ CORS è·¨æ¥æºèµ„æºå…±äº«ç­–ç•¥ï¼Œä¸€èˆ¬å¯ä»¥åœ¨æœåŠ¡ç«¯æ·»åŠ å“åº”å¤´ `Access-Control-Allow-Origin: *`ã€‚

JWT - JSON Web Token ä¸€ä¸ªå¼€æ”¾åè®®æ ‡å‡† RFC 7519ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘çš„ã€è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºä½œä¸º JSON å¯¹è±¡åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚è¯¥ä¿¡æ¯å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ï¼Œå› ä¸ºå®ƒæ˜¯æ•°å­—ç­¾åçš„ã€‚

JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨åœ†ç‚¹è¿æ¥ï¼š

- Header å¤´éƒ¨
- Payload è½½è·
- Signature ç­¾å

ç”¨Tokençš„å¥½å¤„ - æ— çŠ¶æ€å’Œå¯æ‰©å±•æ€§ï¼šTokenså­˜å‚¨åœ¨å®¢æˆ·ç«¯ã€‚å®Œå…¨æ— çŠ¶æ€ï¼Œå¯æ‰©å±•ã€‚æˆ‘ä»¬çš„è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†ç”¨æˆ·ä¼ é€’åˆ°ä»»æ„æœåŠ¡å™¨ï¼Œå› ä¸ºåœ¨ä»»ä½•åœ°æ–¹éƒ½æ²¡æœ‰çŠ¶æ€æˆ–ä¼šè¯ä¿¡æ¯ã€‚ - å®‰å…¨ï¼šTokenä¸æ˜¯Cookieã€‚ï¼ˆThe token, not a cookie.ï¼‰æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™Tokenéƒ½ä¼šè¢«å‘é€ã€‚è€Œä¸”ï¼Œç”±äºæ²¡æœ‰Cookieè¢«å‘é€ï¼Œè¿˜æœ‰åŠ©äºé˜²æ­¢CSRFæ”»å‡»ã€‚å³ä½¿åœ¨ä½ çš„å®ç°ä¸­å°†tokenå­˜å‚¨åˆ°å®¢æˆ·ç«¯çš„Cookieä¸­ï¼Œè¿™ä¸ªCookieä¹Ÿåªæ˜¯ä¸€ç§å­˜å‚¨æœºåˆ¶ï¼Œè€Œéèº«ä»½è®¤è¯æœºåˆ¶ã€‚æ²¡æœ‰åŸºäºä¼šè¯çš„ä¿¡æ¯å¯ä»¥æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¼šè¯!

è¿˜æœ‰ä¸€ç‚¹ï¼Œtokenåœ¨ä¸€æ®µæ—¶é—´ä»¥åä¼šè¿‡æœŸï¼Œè¿™ä¸ªæ—¶å€™ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬ä¿æŒå®‰å…¨ã€‚è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå«tokenæ’¤é”€ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ ¹æ®ç›¸åŒçš„æˆæƒè®¸å¯ä½¿ç‰¹å®šçš„tokenç”šè‡³ä¸€ç»„tokenæ— æ•ˆã€‚

ä¸ JWT ä¸€æ ·æµè¡Œçš„è¿˜æœ‰ OAuth æˆæƒæ¡†æ¶ï¼Œå³ç¬¬ä¸‰æ–¹è´¦å·æˆæƒç™»å½•æ¡†æ¶ï¼Œæ¯”ä¾‹æŸä¸ªç½‘ç«™å¸Œæœ›ç”¨ä½ çš„ Github è´¦æˆ·å®Œæˆç™»å½•è¿‡ç¨‹ï¼Œé¿å…äº†ä½ åˆè¦å†é‡æ–°æ³¨å†Œçš„æ“ä½œã€‚æ¯”è¾ƒ JWTï¼Œå®ƒä½œä¸ºä¸€ç§åè®®ï¼Œç›®çš„æ˜¯å®ç°å‰åç«¯åˆ†ç¦»ï¼Œå®ç°é‰´æƒçš„å®Œå…¨æ— çŠ¶æ€åŒ–ï¼Œé€šè¡Œè¯å°±æ˜¯ä¸€ä¸ªå¯ä»¥é€šè¿‡ç­¾åç®—æ³•éªŒè¯çš„ Tokenã€‚


ä¼ ç»Ÿ Express åº”ç”¨ç¨‹åºçš„æˆæƒï¼Œä»¥åŠèº«ä»½éªŒè¯ï¼Œé€šå¸¸éœ€è¦åä½œï¼Œç”±ä¸­é—´ä»¶æ¥å¤„ç†ã€‚ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èº«ä»½éªŒè¯é€‰æ‹©ï¼Œå› ä¸ºåƒä»¤ç‰ŒéªŒè¯ã€é™„åŠ å±æ€§åˆ°è¯·æ±‚å¯¹è±¡è¿™æ ·çš„äº‹æƒ…ä¸ç‰¹å®šçš„è·¯ç”±ä¸Šä¸‹æ–‡æ²¡æœ‰å¾ˆå¼ºçš„è”ç³»ã€‚

ä¸­é—´ä»¶æœ¬èº«ä¸çŸ¥é“è°ƒç”¨ `next()` å‡½æ•°åå°†æ‰§è¡Œå“ªä¸ªå¤„ç†ç¨‹åºï¼Œè€Œå®ˆå«å¯ä»¥è®¿é—® `ExecutionContext` å®ä¾‹ï¼Œä»è€Œç¡®åˆ‡åœ°çŸ¥é“æ¥ä¸‹æ¥è¦æ‰§è¡Œä»€ä¹ˆã€‚å®ƒä»¬çš„è®¾è®¡å¾ˆåƒå¼‚å¸¸è¿‡æ»¤å™¨ã€ç®¡é“å’Œæ‹¦æˆªå™¨ï¼Œå…è®¸æ‚¨åœ¨è¯·æ±‚/å“åº”å‘¨æœŸçš„æ­£ç¡®ç‚¹æ’å…¥å¤„ç†é€»è¾‘ï¼Œå¹¶ä»¥å£°æ˜çš„æ–¹å¼è¿™æ ·åšï¼Œè¿™æœ‰åŠ©äºä¿æŒä»£ç çš„ DRY - Don't Repeat Yourself è½¯ä»¶å¼€å‘å‡†åˆ™å’Œå£°æ˜æ€§ã€‚

æç¤ºï¼Œå®ˆå«ä¼šåœ¨ä¸­é—´ä»¶ä¹‹åã€æ‹¦æˆªå™¨å’Œç®¡é“ä¹‹å‰æ‰§è¡Œã€‚

ä½¿ç”¨è„šæ‰‹æ¶è‡ªåŠ¨ç”Ÿæˆï¼š

    $ nest g guard auth guards

å®ç°ä¸€ä¸ªå®ˆå«åªéœ€è¦å®ç° `CanActivate` æ¥å£ï¼Œå½“ç„¶ä¾èµ–æ³¨å…¥éœ€è¦ä½¿ç”¨ `@Injectable()`ï¼š

```ts
// auth.guard.ts

import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    const request = context.switchToHttp().getRequest();
    return validateRequest(request);
  }
}
```

åœ¨å…¶ä¸­çš„ `validateRequest()` å®ç°è®¤è¯é€»è¾‘ï¼Œè¿”å› true è¡¨ç¤ºé€šè¿‡è®¤è¯ï¼Œæ”¾è¡Œè¯·æ±‚ã€‚`canActivate()` å‡½æ•°æ¥å—ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ `ExecutionContext` å‚æ•°å®ä¾‹ï¼Œå®ƒç»§æ‰¿è‡ª `ArgumentsHost`ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåªæ˜¯ä½¿ç”¨åœ¨ ArgumentsHost ä¸Šå®šä¹‰çš„åŠ©æ‰‹æ–¹æ³•æ¥è·å–å®¢æˆ·è¯·æ±‚å¯¹è±¡çš„å¼•ç”¨ã€‚


é‰´æƒå¤±è´¥æ—¶ï¼Œé»˜è®¤ä¼šæŠ›å‡º `ForbiddenException`ï¼Œå¯ä»¥è‡ªè¡Œé€‰æ‹©åˆé€‚çš„å¼‚å¸¸ï¼Œå¦‚ï¼š

    throw new UnauthorizedException();


ç»‘å®šå®ˆå«å’Œç»‘å®šç®¡é“ç±»ä¼¼ï¼Œä½¿ç”¨ `@UseGuards()` è£…é¥°å™¨ï¼š

```ts
@Controller('cats')
@UseGuards(RolesGuard)
export class CatsController {}
```

å¯ä»¥ç»™æ§åˆ¶å™¨ã€æ§åˆ¶å™¨æ–¹æ³•ã€å¼‚å¸¸è¿‡æ»¤å™¨ã€ç®¡é“ä¸­ç»‘å®šå®ˆå«ï¼ŒæŒ‡å®šç±»æˆ–å®ä¾‹éƒ½å¯ä»¥ï¼Œå¦‚æœç»‘å®šå¤šä¸ªå®ˆå«å°±ä½¿ç”¨é€—å·åˆ†éš”ã€‚

å…¨å±€ç»‘å®šå®ˆå«å¦‚ä¸‹ï¼š

```js
const app = await NestFactory.create(AppModule);
app.useGlobalGuards(new RolesGuard());
```

å…¨å±€é˜²æŠ¤åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆï¼Œç”¨äºæ¯ä¸ªæ§åˆ¶å™¨å’Œæ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åºã€‚å¯¹äºä¾èµ–é¡¹æ³¨å…¥ï¼Œä»ä»»ä½•æ¨¡å—å¤–éƒ¨æ³¨å†Œçš„å…¨å±€å®ˆå«ï¼Œå¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨ `useGlobalGuards()` ä¸èƒ½æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œå› ä¸ºè¿™åœ¨ä»»ä½•æ¨¡å—çš„ä¸Šä¸‹æ–‡ä¹‹å¤–å®Œæˆçš„ã€‚

è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼Œç›´æ¥åœ¨ç¨‹åºæ¨¡å—ä¸­è®¾ç½®å®ˆå«ï¼š

```ts
// app.module.ts

import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';

@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: RolesGuard,
    },
  ],
})
export class AppModule {}
```

å½“ä½¿ç”¨è¿™ç§æ–¹æ³•æ‰§è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼Œè¯·æ³¨æ„ï¼Œä¸ç®¡åœ¨å“ªä¸ªæ¨¡å—ä¸­ä½¿ç”¨è¿™ç§æ„é€ ï¼Œå®ˆå«éƒ½æ˜¯å…¨å±€çš„ã€‚


æ ¹æ®è§’è‰²æ‰§è¡Œçš„å®ˆå«æ˜¯å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯ Nest æœ€é‡è¦çš„ä¿æŠ¤ç‰¹æ€§ï¼Œåˆ©ç”¨ `@SetMetadata()` èƒ½æ›´è‡ªåŠ¨åŒ–åœ°ä¸ºä¸åŒè§’è‰²æ‰§è¡Œå®ˆå«ã€‚

ä¾‹å¦‚ï¼ŒCatsController å¯ä»¥å¯¹ä¸åŒçš„è·¯ç”±ä½¿ç”¨ä¸åŒçš„æƒé™æ–¹æ¡ˆï¼Œæœ‰äº›å¯èƒ½åªå¯¹ç®¡ç†å‘˜ç”¨æˆ·å¯ç”¨ï¼Œæœ‰äº›åˆ™å¯¹æ‰€æœ‰äººå¼€æ”¾ã€‚æˆ‘ä»¬å¦‚ä½•ä»¥çµæ´»å’Œå¯é‡ç”¨çš„æ–¹å¼å°†è§’è‰²ä¸è·¯ç”±ç›¸åŒ¹é…ï¼Ÿ

é€šè¿‡ `@SetMetadata()` ä¿®é¥°ç¬¦ç»‘å®šå…ƒæ•°æ®åˆ°è·¯ç”±å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªå…ƒæ•°æ®å¯ä»¥ä¸ºå®ˆå«ç¨‹åºæä¾›è§’è‰²æ•°æ®ï¼Œæ™ºèƒ½å®ˆå«éœ€è¦è¿™äº›æ•°æ®æ¥åšå‡ºå†³ç­–ã€‚

ç¤ºèŒƒå¦‚ä½•ä½¿ç”¨ `@SetMetadata()`ï¼š

```js
// cats.controller.ts

@Post()
@SetMetadata('roles', ['admin'])
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```

ç›´æ¥ä½¿ç”¨ `@SetMetadata()` è£…é¥°å™¨æŒ‡å®šè§’è‰²ä¹Ÿè®¸è¿˜ä¸å¤Ÿç›´è§‚ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª `@Roles()` è£…é¥°å™¨ï¼Œå¯¹å…¶è¿›è¡ŒäºŒæ¬¡åŒ…è£…ï¼š

```ts
// roles.decorator.ts

import { SetMetadata } from '@nestjs/common';

export const Roles = (...roles: string[]) => SetMetadata('roles', roles);
```

ç„¶åå°† `@Roles()` è£…é¥°åº”ç”¨åˆ°æ§åˆ¶å™¨ä¸Šï¼š

```ts
// cats.controller.ts

@Post()
@Roles('admin')
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```

åŸºäºè§’è‰²çš„å®ˆå«å®ç°å¦‚ä¸‹ï¼š

```ts
// roles.guard.ts

import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const roles = this.reflector.get<string[]>('roles', context.getHandler());
    if (!roles) {
      return true;
    }
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    return matchRoles(roles, user.roles);
  }
}
```

é€šè¿‡ `Reflector` åå°„æ¨¡å—è·å–å‰é¢ç»‘å®šçš„è§’è‰² Metadata æ•°æ®ï¼Œç„¶ååœ¨ `matchRoles()` å®ç°é‰´æƒé€»è¾‘ã€‚



## ğŸ‘‰ Interceptors æ‹¦æˆªå™¨
- https://docs.nestjs.com/interceptors
- Explore all RxJS operators https://reactive.how/rxjs/
- https://rxjs.dev/api/operators/map

å’Œç®¡é“ã€å®ˆå«ä¸€æ ·ï¼Œæ‹¦æˆªå™¨ä¹Ÿéœ€è¦ `@Injectable()` è£…é¥°å™¨ï¼Œæ‹¦æˆªå™¨éœ€è¦å®ç° `NestInterceptor` æ¥å£ï¼Œå®ƒä»¬éƒ½æ˜¯å—é¢å‘åˆ‡é¢ç¼–ç¨‹ AOP æŠ€æœ¯çš„å¯å‘å»¶ä¼¸å‡ºæ¥çš„æ¦‚å¿µã€‚

æ‹¦æˆªå™¨å…·æœ‰ä¸€ç³»åˆ—æœ‰ç”¨çš„åŠŸèƒ½ï¼š

- åœ¨å‡½æ•°æ‰§è¡Œä¹‹å‰/ä¹‹åç»‘å®šé¢å¤–çš„é€»è¾‘ï¼›
- è½¬æ¢å‡½æ•°è¿”å›çš„ç»“æœï¼›
- è½¬æ¢å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸ï¼›
- æ‰©å±•åŸºæœ¬å‡½æ•°è¡Œä¸ºï¼›
- æ ¹æ®æ‰€é€‰æ¡ä»¶å®Œå…¨é‡å†™å‡½æ•°ï¼Œä¾‹å¦‚ç¼“å­˜ï¼›

åˆ°æ‹¦æˆªå™¨è¿™éƒ¨åˆ†ï¼Œæ¶‰åŠäº† RxJS å“åº”å¼æµç¼–ç¨‹ï¼Œå¯ä»¥å‚è€ƒç›¸åº”çš„å†…å®¹ã€‚

æ‹¦æˆªå™¨å®ç°çš„ `intercept()` æ–¹æ³•æ¥æ”¶ 2 ä¸ªå‚æ•°ï¼Œ`ExecutionContext` æ‰§è¡Œä¸Šä¸‹æ–‡å®ä¾‹ï¼Œä¸å®ˆå«æ¥æ”¶çš„å®Œå…¨ç›¸åŒçš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯ `CallHandler`ï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨å…¶ `handle()` æ–¹æ³•ï¼Œåˆ™ä¸»å¤„ç†ç¨‹åºæ ¹æœ¬ä¸ä¼šè¿›è¡Œæ±‚å€¼ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸåŸºæœ¬ä¸Šï¼ŒCallHandler æ˜¯ä¸€ä¸ªåŒ…è£…æ‰§è¡Œæµçš„å¯¹è±¡ï¼Œå› æ­¤æ¨è¿Ÿäº†æœ€ç»ˆçš„å¤„ç†ç¨‹åºæ‰§è¡Œã€‚

è¿™å°±è¡¨æ˜æ‹¦æˆªå™¨ `intercept()` æ–¹æ³•å¯ä»¥æœ‰æ•ˆåœ°åŒ…è£…è¯·æ±‚/å“åº”æµï¼Œåœ¨æ‰§è¡Œè·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰ã€ä¹‹åå®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚

ä½†æ˜¯å¦‚ä½•å½±å“ä¹‹åå‘ç”Ÿçš„äº‹æƒ…å‘¢ï¼Ÿå› ä¸º `handle()` æ³•è¿”å›ä¸€ä¸ª Observableï¼Œå¯ä»¥ä½¿ç”¨å¼ºå¤§çš„ RxJS æ“ä½œç¬¦æ¥è¿›ä¸€æ­¥æ“ä½œå“åº”ã€‚ä½¿ç”¨é¢å‘æ–¹é¢çš„ç¼–ç¨‹æœ¯è¯­ï¼Œè·¯ç”±å¤„ç†ç¨‹åºçš„è°ƒç”¨ï¼Œå³è°ƒç”¨ `handle()` è¢«ç§°ä¸ºåˆ‡å…¥ç‚¹ï¼Œè¡¨ç¤ºå®ƒæ˜¯æ’å…¥é¢å¤–é€»è¾‘çš„ç‚¹ã€‚

æ¯”æ–¹è¯´ï¼Œå‘ `/cats` å‘å‡º POST è¯·æ±‚ï¼Œè·¯ç”±æŒ‡å‘åœ¨ CatsController çš„ `create()` å¤„ç†å‡½æ•°ã€‚å¦‚æœåœ¨æ­¤è¿‡ç¨‹ä¸­æœªè°ƒç”¨æ‹¦æˆªå™¨çš„ `handle()` æ–¹æ³•ï¼Œåˆ™ `create()` æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰ `handle()` è¢«è°ƒç”¨å¹¶ä¸”å·²è¿”å›å€¼ï¼Œæœ€ç»ˆæ–¹æ³•æ‰ä¼šè¢«è§¦å‘ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º Nest è®¢é˜…äº†è¿”å›çš„æµï¼Œå¹¶ä½¿ç”¨æ­¤æµç”Ÿæˆçš„å€¼æ¥ä¸ºæœ€ç»ˆç”¨æˆ·åˆ›å»ºå•ä¸ªå“åº”æˆ–å¤šä¸ªå“åº”ã€‚è€Œä¸”ï¼Œ`handle()` è¿”å›ä¸€ä¸ª Observableï¼Œè¿™æ„å‘³ç€ RxJS  ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç»„éå¸¸å¼ºå¤§çš„è¿ç®—ç¬¦ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œå“åº”æ“ä½œã€‚

ç¬¬ä¸€ä¸ªä¾‹å­æ˜¯ä½¿ç”¨æ‹¦æˆªå™¨åœ¨å‡½æ•°æ‰§è¡Œä¹‹å‰æˆ–ä¹‹åæ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œç”¨æœ¯è¯­å³æ˜¯åˆ‡é¢æˆªå– Aspect interceptionã€‚å½“éœ€è¦è®°å½•ä¸åº”ç”¨ç¨‹åºçš„äº¤äº’æ—¶ï¼Œå®ƒå¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ å­˜å‚¨ç”¨æˆ·è°ƒç”¨ï¼Œå¼‚æ­¥è°ƒåº¦äº‹ä»¶æˆ–è®¡ç®—æ—¶é—´æˆ³ã€‚

å¯ä»¥ä½¿ç”¨è„šæ‰‹æ¶ç”Ÿæˆä»£ç æ–‡ä»¶ï¼š

    $ nest g interceptor logging interceptions

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ LoggingInterceptorï¼š

```ts
// logging.interceptor.ts

import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('Before...');

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => console.log(`After... ${Date.now() - now}ms`)),
      );
  }
}
```

`NestInterceptor<Tï¼ŒR>` æ³›å‹æ¥å£ä¸­ T è¡¨ç¤ºå·²å¤„ç†çš„ `Observable<T>` çš„ç±»å‹ï¼Œæä¾› response æµï¼Œè€Œ R è¡¨ç¤ºåŒ…å«åœ¨è¿”å›çš„ `Observable<R>` ä¸­çš„å€¼çš„è¿”å›ç±»å‹ã€‚

æ‹¦æˆªå™¨çš„ä½œç”¨ä¸æ§åˆ¶å™¨ï¼Œæä¾›ç¨‹åºï¼Œå®ˆå«ç­‰ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ‰§è¡Œä¾èµ–æ³¨å…¥ã€‚

ä½¿ç”¨ `@UseInterceptors()` è£…é¥°å™¨ç»‘å®šæ‹¦æˆªå™¨ï¼Œä¸å®ˆå«ä¸€æ ·ï¼Œæ‹¦æˆªå™¨å¯ä»¥æ˜¯æ§åˆ¶å™¨èŒƒå›´å†…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–¹æ³•èŒƒå›´å†…çš„ï¼Œæˆ–è€…å…¨å±€èŒƒå›´ã€‚ç»‘å®šæ—¶ï¼Œå¯ä»¥ä¸€æ ·å¯ä»¥æŒ‡å®šç±»å‹ï¼Œç”± Nest é€šè¿‡ä¾èµ–æ³¨å…¥å®ä¾‹åŒ–ï¼Œæˆ–è€…ç›´æ¥ä¼ å…¥å®ä¾‹ã€‚

    import { UseInterceptors } from '@nestjs/common';

    @UseInterceptors(LoggingInterceptor)
    @UseInterceptors(new LoggingInterceptor())

    app.useGlobalInterceptors(new LoggingInterceptor());

å…¨å±€æ‹¦æˆªå™¨ç”¨äºæ•´ä¸ªåº”ç”¨ç¨‹åºã€æ¯ä¸ªæ§åˆ¶å™¨å’Œæ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åºã€‚åœ¨ä¾èµ–æ³¨å…¥æ–¹é¢ï¼Œä»ä»»ä½•æ¨¡å—å¤–éƒ¨æ³¨å†Œçš„å…¨å±€æ‹¦æˆªå™¨ï¼Œå¦‚ä¸Šé¢çš„ `useGlobalInterceptors()`ï¼Œæ— æ³•æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œå› ä¸ºå®ƒä»¬ä¸å±äºä»»ä½•æ¨¡å—çš„ä¸Šä¸‹æ–‡ã€‚

è§£å†³æ–¹æ³•å’Œå…¨å±€å®ˆå«åšæ³•ç±»ä¼¼ï¼Œç›´æ¥ä¸ºæ¨¡å—é…ç½®ä¸€ä¸ªæ‹¦æˆªå™¨ï¼š

```ts
// app.module.ts

import { Module } from '@nestjs/common';
import { APP_INTERCEPTOR } from '@nestjs/core';

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: LoggingInterceptor,
    },
  ],
})
export class ApplicationModule {}
```

ä¸Šé¢è§£æäº† `handle()` è¿”å›ä¸€ä¸ª RxJS Observable æ•°æ®æµï¼ŒåŒ…å«ä»è·¯ç”±å¤„ç†ç¨‹åºè¿”å›çš„å€¼ï¼Œå¯ä»¥è½»æ¾åœ°ä½¿ç”¨ `map()` è¿ç®—ç¬¦æ›´æ”¹æ•°æ®ã€‚

å“åº”æ˜ å°„åŠŸèƒ½ Response Mapping ä¸é€‚ç”¨äºç‰¹å®šäºåº“çš„å“åº”ç­–ç•¥ï¼Œç›´æ¥ä½¿ç”¨ `@Res()` å¯¹è±¡æ˜¯ç¦æ­¢çš„ã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª TransformInterceptor, å®ƒå°†æ‰“åŒ…å“åº”å¹¶å°†å…¶åˆ†é…ç»™ data å±æ€§ã€‚

```ts
// transform.interceptor.ts

import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

export interface Response<T> {
  data: T;
}

@Injectable()
export class TransformInterceptor<T> implements NestInterceptor<T, Response<T>> {
  intercept(context: ExecutionContext, next: CallHandler): Observable<Response<T>> {
    return next.handle().pipe(map(data => ({ data })));
  }
}
```

åˆ‡é¢ç¼–ç¨‹åœ¨åˆ›å»ºç”¨äºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„å¯é‡ç”¨è§£å†³æ–¹æ¡ˆæ—¶å…·æœ‰å·¨å¤§çš„æ½œåŠ›ï¼Œä¾‹å¦‚ï¼Œè¦å°†æ¯ä¸ªå‘ç”Ÿçš„ null å€¼è½¬æ¢ä¸ºç©ºå­—ç¬¦ä¸² ''ã€‚ä½¿ç”¨ä¸€è¡Œä»£ç å¹¶å°†æ‹¦æˆªå™¨ç»‘å®šä¸ºå…¨å±€ä»£ç å°±å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œå®ƒä¼šè¢«æ¯ä¸ªæ³¨å†Œçš„å¤„ç†ç¨‹åºè‡ªåŠ¨é‡ç”¨ã€‚

å¦ä¸€ä¸ªæœ‰è¶£çš„ç”¨ä¾‹æ˜¯åˆ©ç”¨ RxJS çš„ `catchError()` æ“ä½œç¬¦æ¥è¦†ç›–æŠ›å‡ºçš„å¼‚å¸¸ï¼š

```ts
// errors.interceptor.ts

import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  BadGatewayException,
  CallHandler,
} from '@nestjs/common';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';

@Injectable()
export class ErrorsInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next
      .handle()
      .pipe(
        catchError(err => throwError(new BadGatewayException())),
      );
  }
}
```

å¯¹å“åº”æµè¿›è¡Œè¦†ç›– Stream overriding å¯ä»¥å®Œå…¨é˜»æ­¢è°ƒç”¨å¤„ç†ç¨‹åºå¹¶è¿”å›ä¸åŒçš„å€¼ã€‚

ä¾‹å¦‚ï¼Œç”±äºæ€§èƒ½é—®é¢˜è€Œä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚ç¼“å­˜æ‹¦æˆªå™¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œç¼“å­˜ä¼šè€ƒè™‘å…¶å®ƒå› ç´ ï¼Œå¦‚ TTL - Time To Liveï¼Œç¼“å­˜å¤±æ•ˆ Cache Invalidationï¼Œç¼“å­˜å¤§å°ç­‰ç­‰ã€‚è¿™é‡Œæä¾›ä¸€ä¸ªç®€åŒ–å®ç°ï¼Œä»¥æ¼”ç¤ºåŸºæœ¬æ¦‚å¿µå’Œé€»è¾‘ï¼š

```ts
// cache.interceptor.ts

import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable, of } from 'rxjs';

@Injectable()
export class CacheInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const isCached = true;
    if (isCached) {
      return of([]);
    }
    return next.handle();
  }
}
```

è¿™ä¸ª `CacheInterceptor` å¸¦æœ‰ç¡¬ç¼–ç çš„ `isCached` å˜é‡å’Œç¡¬ç¼–ç çš„å“åº” `[]`ï¼Œåœ¨è¿™é‡Œé€šè¿‡ `of()` è¿ç®—ç¬¦åˆ›å»ºå¹¶è¿”å›äº†ä¸€ä¸ªæ–°çš„æµï¼Œå› æ­¤è·¯ç”±å¤„ç†ç¨‹åºæ ¹æœ¬ä¸ä¼šè¢«è°ƒç”¨ã€‚

å½“è¯·æ±‚è°ƒç”¨ `CacheInterceptor` çš„ç«¯ç‚¹æ—¶ï¼Œä¸€ä¸ªç¡¬ç¼–ç çš„ç©ºæ•°ç»„å“åº”å°†ç«‹å³è¿”å›ã€‚ä¸ºäº†åˆ›å»ºä¸€ä¸ªé€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥åˆ©ç”¨ `Reflector` åå°„åˆ›å»ºè‡ªå®šä¹‰ä¿®é¥°ç¬¦ï¼Œåå°„å™¨ Reflector åœ¨å®ˆå«ç« èŠ‚ä½¿ç”¨è¿‡ã€‚

RxJS æä¾›äº†æ•°åä¸ªæ“ä½œç¬¦å·ï¼ŒåŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚



## ğŸ‘‰ Exception Filters å¼‚å¸¸è¿‡æ»¤
- https://docs.nestjs.com/exception-filters
- https://developer.mozilla.org/en-US/docs/Web/HTTP/Status

å†…ç½®çš„å¼‚å¸¸å±‚è´Ÿè´£å¤„ç†æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå½“æ•è·åˆ°æœªå¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œæœ€ç»ˆç”¨æˆ·å°†æ”¶åˆ°å‹å¥½çš„å“åº”ï¼Œæ¯ä¸ªå¼‚å¸¸éƒ½ä¼šé»˜è®¤ä»¥ JSON å“åº”å®¢æˆ·ã€‚

æ¯ä¸ªå‘ç”Ÿçš„å¼‚å¸¸éƒ½ç”±å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†, å½“è¿™ä¸ªå¼‚å¸¸æ— æ³•è¢«è¯†åˆ«æ—¶ï¼Œæ—¢ä¸æ˜¯ `HttpException` ä¹Ÿä¸æ˜¯å®ƒçš„å­ç±»ï¼Œé‚£ä¹ˆç”¨æˆ·å°†æ”¶åˆ°ä»¥ä¸‹ JSON å“åº”ï¼š

    {
        "statusCode": 500,
        "message": "Internal server error"
    }

Nest åœ¨ `@nestjs/common` åŒ…å¯¼å‡ºäº†ä¸€äº›å†…ç½®çš„ HttpException å­ç±»ï¼Œå…¸å‹çš„ HTTP REST/GraphQL API åº”ç”¨ç¨‹åºï¼Œæœ€ä½³å®è·µæ˜¯åœ¨å‘ç”ŸæŸäº›é”™è¯¯æƒ…å†µæ—¶å‘é€æ ‡å‡† HTTP å“åº”å¯¹è±¡ã€‚

HTTP çŠ¶æ€ä¿¡æ¯åˆ†ä¸º 5 ç±»ï¼Œæ¯ç±»ä»¥åŒä¸€ä¸ªæ•°å€¼å¼€å¤´ï¼š

- Informational responses (100â€“199)
- Successful responses (200â€“299)
- Redirects (300â€“399)
- Client errors (400â€“499)
- Server errors (500â€“599)

| Status Code |            Exception             |          Message           |
|-------------|----------------------------------|----------------------------|
|         400 | BadRequestException              | Bad Request                |
|         401 | UnauthorizedException            | Unauthorized               |
|         403 | ForbiddenException               | Forbidden                  |
|         404 | NotFoundException                | Not Found                  |
|         405 | MethodNotAllowedException        | Method Not Allowed         |
|         406 | NotAcceptableException           | Not Acceptable             |
|         408 | RequestTimeoutException          | Request Timeout            |
|         409 | ConflictException                | Conflict                   |
|         410 | GoneException                    | Gone                       |
|         412 | PreconditionFailedException      | Precondition Failed        |
|         413 | PayloadTooLargeException         | Payload Too Large          |
|         415 | UnsupportedMediaTypeException    | Unsupported Media Type     |
|         418 | ImATeapotException               | I'm a Teapot               |
|         421 | MisdirectedException             | Bad Gateway                |
|         422 | UnprocessableEntityException     | Unprocessable Entity       |
|         500 | InternalServerErrorException     | Internal Server Error      |
|         501 | NotImplementedException          | Not Implemented            |
|         502 | BadGatewayException              | Bad Gateway                |
|         503 | ServiceUnavailableException      | Service Unavailable        |
|         504 | GatewayTimeoutException          | Gateway Timeout            |
|         505 | HttpVersionNotSupportedException | HTTP Version Not Supported |

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJSON å“åº”ä¸»ä½“åŒ…å«ä¸¤ä¸ªå±æ€§ï¼š

- `statusCode` é»˜è®¤ä¸º status å‚æ•°ä¸­æä¾›çš„ HTTP çŠ¶æ€ä»£ç ï¼›
- `message` åŸºäºçŠ¶æ€çš„ HTTP é”™è¯¯çš„ç®€çŸ­æè¿°ï¼›

HttpException æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ªå¿…è¦çš„å‚æ•°æ¥å†³å®šå“åº”ä¸»ä½“ï¼š

- `response` å‚æ•°å®šä¹‰ JSON å“åº”ä½“ï¼Œå¯ä»¥æ˜¯ string ç”¨äºè¦†ç›– messageï¼Œæˆ–è€…ä¸€ä¸ª object ç”¨äºè¦†ç›–æ•´ä¸ªå“åº”ä¸»ä½“ã€‚
- `status` å‚æ•°å®šä¹‰ HTTP çŠ¶æ€ä»£ç ã€‚

Nest ä¼šæ‰§è¡Œåºåˆ—åŒ–ï¼Œå°†è¿”å›å¯¹è±¡è½¬æ¢ä¸º JSON å“åº”è¿”å›ã€‚ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæœ‰æ•ˆçš„ HTTP çŠ¶æ€ä»£ç ï¼Œæœ€ä½³å®è·µæ˜¯ä½¿ç”¨ `@nestjs/common` å¯¼å…¥çš„ HttpStatus æšä¸¾ã€‚

è™½ç„¶å†…ç½®çš„å¼‚å¸¸è¿‡æ»¤å™¨å¯ä»¥è‡ªåŠ¨å¤„ç†è®¸å¤šæƒ…å†µï¼Œä½†å¯ä»¥è‡ªä¸»æ§åˆ¶å¼‚å¸¸å¤„ç†å±‚ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼‚å¸¸å¤„ç†ä¸­æ·»åŠ æ—¥å¿—è®°å½•ï¼Œæˆ–åŸºäºæŸäº›åŠ¨æ€å› ç´ ä½¿ç”¨ä¸åŒçš„ JSON æ¨¡å¼ã€‚å¼‚å¸¸è¿‡æ»¤å™¨æ­£æ˜¯ä¸ºæ­¤è€Œè®¾è®¡çš„ï¼Œå®ƒä»¬å…è®¸æ‚¨æ§åˆ¶ç¡®åˆ‡çš„æ§åˆ¶æµä»¥åŠå‘é€å›å®¢æˆ·ç«¯çš„å“åº”çš„å†…å®¹ã€‚

ä»¥ä¸‹åˆ›å»ºä¸€ä¸ªå¼‚å¸¸è¿‡æ»¤å™¨ï¼Œè´Ÿè´£æ•è· `HttpException` å¼‚å¸¸ï¼Œå¹¶ä¸ºå®ƒä»¬å®ç°å®šåˆ¶çš„å“åº”é€»è¾‘ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®åº•å±‚å¹³å°è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥æå–åŸå§‹ URL å¹¶å°†å…¶åŒ…å«åœ¨æ—¥å¿—ä¿¡æ¯ä¸­ã€‚ä½¿ç”¨ `Response` å¯¹è±¡çš„ `json()` æ–¹æ³•ç›´æ¥æ§åˆ¶å‘é€å“åº”ã€‚

```ts
// http-exception.filter.ts

import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();

    response
      .status(status)
      .json({
        statusCode: status,
        timestamp: new Date().toISOString(),
        path: request.url,
      });
  }
}
```

æ‰€æœ‰å¼‚å¸¸è¿‡æ»¤å™¨åº”è¯¥å®ç° `ExceptionFilter<T>` æ³›å‹æ¥å£ï¼Œè¿™è¦æ±‚å®ç° `catch()` æ–¹æ³•ï¼ŒT æŒ‡æ˜å¼‚å¸¸ç±»å‹ã€‚é€šè¿‡è£…é¥°å™¨ `@Catch()` å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸ç±»å‹ï¼Œæ ¹æ®éœ€è¦æŒ‡å®šï¼Œå¦‚æœç•™ç©ºå°±è¡¨ç¤ºæ•æ‰ä¸€åˆ‡å¼‚å¸¸ã€‚

å…¶ä¸­å‚æ•°å¯„ä¸»å¯¹è±¡ `ArgumentsHost` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å®ç”¨ç¨‹åºå¯¹è±¡ï¼Œåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸€ç« è¿›è¡Œè§£æã€‚åœ¨è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œå®ƒç”¨æ¥è·å–è¯·æ±‚ã€å“åº”å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™äº›å¯¹è±¡æœ¬åº”ä¼ é€’ç»™åŸå§‹è¯·æ±‚å¤„ç†ç¨‹åºã€‚

å’Œæ‹¦æˆªå™¨ï¼Œæä¾›ç¨‹åºï¼Œå®ˆå«ç­‰ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œæˆ–ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œæ³¨å†Œ `@UseFilters()`ã€‚

```ts
@UseFilters(new HttpExceptionFilter())

app.useGlobalFilters(new HttpExceptionFilter());
```

åŒæ ·ï¼Œå…¨å±€çš„å¼‚å¸¸è¿‡æ»¤å™¨éœ€è¦æŒ‰ä»¥ä¸‹ç»“æ„æ³¨å†Œæ‰èƒ½æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼š

```ts
// app.module.ts

import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';

@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: HttpExceptionFilter,
    },
  ],
})
export class AppModule {}
```

è‡ªå®šä¹‰å¼‚å¸¸è¿‡æ»¤ç±»å‹å‚è€ƒï¼š

```ts
// all-exceptions.filter.ts

import { Catch, ArgumentsHost } from '@nestjs/common';
import { BaseExceptionFilter } from '@nestjs/core';

@Catch()
export class AllExceptionsFilter extends BaseExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    super.catch(exception, host);
  }
}
```


## ğŸ‘‰ Execution Context æ‰§è¡Œä¸Šä¸‹æ–‡
- https://docs.nestjs.com/fundamentals/execution-context

Nest æä¾›äº†å‡ ä¸ªå®ç”¨å·¥å…·ç±»ï¼Œä»¥ç®€åŒ–åº”ç”¨ç¨‹åºå®ç°è·¨å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡è¿è¡Œã€‚

ä¾‹å¦‚ï¼ŒåŸºäº Nest HTTP æœåŠ¡å™¨ã€microservices å’Œ WebSockets çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€‚è¿™äº›å®ç”¨å·¥å…·ç±»æä¾›æœ‰å…³å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œç”¨äºæ„å»ºé€šç”¨çš„å®ˆå«ã€è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨ï¼Œè¿™äº›ä¿æŠ¤ç¨‹åºã€è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨å¯è·¨ä¸€ç»„é€šç”¨çš„æ§åˆ¶å™¨ã€æ–¹æ³•å’Œæ‰§è¡Œä¸Šä¸‹æ–‡å·¥ä½œã€‚

è¿™é‡Œä¸»è¦è§£æä¸¤ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒArgumentsHost å’Œ ExecutionContextã€‚

`ArgumentsHost` ç±»æä¾›çš„æ–¹æ³•ç”¨äºæ£€ç´¢ä¼ é€’ç»™å¤„ç†ç¨‹åºçš„å‚æ•°ï¼Œå®ƒåªæ˜¯ä½œä¸ºå¤„ç†ç¨‹åºå‚æ•°çš„æŠ½è±¡ï¼Œå®ƒå…è®¸åˆ‡æ¢é€‰æ‹©é€‚å½“çš„ä¸Šä¸‹æ–‡å¹¶ä»ä¸­æ£€ç´¢å‚æ•°ï¼Œå¦‚ä¸‹ï¼š

- `switchToHttp()`: HttpArgumentsHost åˆ‡æ¢ä¸º HTTPï¼Œç„¶åå†é€šè¿‡ `getRequest()` `.getResponse()` ç­‰æ–¹æ³•è·å–ç›¸åº”çš„åº•å±‚å¯¹è±¡ï¼›
- `switchToRpc()`: RpcArgumentsHost åˆ‡æ¢ä¸º RPCï¼ˆmicroserviceï¼‰
- `switchToWs()`: WsArgumentsHost åˆ‡æ¢ä¸º Websocket

æ¡†æ¶æä¾›äº† ArgumentsHost çš„å®ä¾‹ï¼Œé€šå¸¸ä½œä¸ºå®¿ä¸»å‚æ•°å¼•ç”¨ï¼Œåœ¨æ‚¨å¯èƒ½éœ€è¦è®¿é—®å®ƒçš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ ArgumentsHostinstance è°ƒç”¨å¼‚å¸¸ç­›é€‰å™¨çš„ `catch()` æ–¹æ³•ã€‚

å¯¹äº HTTP æœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œå³ä½¿ç”¨ `@nestjs/platform` `express` æ—¶ï¼Œä¸»æœºå¯¹è±¡å°è£…äº† express çš„ [requestï¼Œresponseï¼Œnext]æ•°ç»„ï¼ŒåŒ…å«è¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡ï¼Œnext æ˜¯æ§åˆ¶åº”ç”¨ç¨‹åºè¯·æ±‚å“åº”å‘¨æœŸçš„å‡½æ•°ã€‚

å¦ä¸€æ–¹é¢ï¼Œå¯¹äº GraphQL åº”ç”¨ç¨‹åºï¼Œå®¿ä¸»å¯¹è±¡åŒ…å« [rootï¼Œargsï¼Œcontextï¼Œinfo] æ•°ç»„ã€‚


æ„å»ºè¦åœ¨å¤šä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„é€šç”¨å®ˆå«ã€è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨æ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹æ³•æ¥ç¡®å®šå½“å‰æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„ç±»å‹ï¼Œå³`å½“å‰ç¨‹åºä¸Šä¸‹æ–‡`ä¿¡æ¯ã€‚ä½¿ç”¨ ArgumentsHost çš„ `getType()` æ–¹æ³•æ‰§è¡Œæ­¤æ“ä½œï¼š

```ts
import { GqlContextType } from @nestjs/graphql;

if (host.getType() === 'http') {
  // do something that is only important in the context of regular HTTP requests (REST)
} else if (host.getType() === 'rpc') {
  // do something that is only important in the context of Microservice requests
} else if (host.getType<GqlContextType>() === 'graphql') {
  // do something that is only important in the context of GraphQL requests
}
```

è·å–å¯„ä¸»å¤„ç†ç¨‹åºå‚æ•° Host handler arguments å¯ä»¥é€šè¿‡ `getArgs()` æˆ– `getArgByIndex()` æ–¹æ³•å®ç°ï¼š

```js
const [req, res, next] = host.getArgs();

const request = host.getArgByIndex(0);
const response = host.getArgByIndex(1);
```

æˆ–è€…åˆ‡æ¢åˆ°æŒ‡å®šçš„ä¸Šä¸‹æ–‡ï¼Œå†è·å–ç›¸åº”çš„åº•å±‚å¯¹è±¡ï¼š

```ts
const ctx = host.switchToHttp();
const request = ctx.getRequest<Request>();
const response = ctx.getResponse<Response>();
```

ç›¸ä¼¼åœ°ï¼Œå¯¹äº `WsArgumentsHost` `RpcArgumentsHost` ä¹Ÿæœ‰ç›¸åº”çš„æ–¹æ³•è·å–åº•å±‚å¯¹è±¡ï¼š

```ts
export interface WsArgumentsHost {
  getData<T>(): T;
  getClient<T>(): T;
}

export interface RpcArgumentsHost {
  getData<T>(): T;
  getContext<T>(): T;
}
```

ç¬¬äºŒä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ `ExecutionContext` æ‰©å±•äº† `ArgumentsHost`ï¼Œæä¾›äº†é¢å¤–çš„æ–¹æ³•ï¼Œ`getClass<T>()` è·å–æ§åˆ¶å™¨ç±»å‹ä¿¡æ¯ï¼Œ`getHandler()` è·å–è·¯ç”±å¤„ç†å‡½æ•°ã€‚å’Œ `ArgumentsHost` ç±»ä¼¼ï¼ŒNest ä¼šåœ¨éœ€è¦çš„åœºåˆä¸­æä¾› `ExecutionContext` å®ä¾‹ï¼Œå¦‚å®ˆå«çš„ `canActivate()` æ–¹æ³•ä¸­ï¼Œæ‹¦æˆªå™¨çš„ `intercept()` æ–¹æ³•ä¸­ã€‚

```ts
export interface ExecutionContext extends ArgumentsHost {
  /**
   * Returns the type of the controller class which the current handler belongs to.
   */
  getClass<T>(): Type<T>;
  /**
   * Returns a reference to the handler (method) that will be invoked next in the
   * request pipeline.
   */
  getHandler(): Function;
}
```

ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äº HTTP ä¸Šä¸‹æ–‡ï¼Œå…¥ç«™ä¸€ä¸ª POST è¯·æ±‚ï¼Œå‡å®šè·¯ç”±åˆ° `CatsController` æ§åˆ¶å™¨çš„ `create()` æ–¹æ³•ï¼Œé‚£ä¹ˆï¼š

- æ‰§è¡Œä¸Šä¸‹æ–‡çš„ `getHandler()` æ–¹æ³•è¿”å›çš„å°±æ˜¯ `create()` æ–¹æ³•çš„å¼•ç”¨ï¼›
- æ‰§è¡Œä¸Šä¸‹æ–‡çš„ `getClass()` è¿”å›çš„æ˜¯ `CatsControllertype` ç±»å‹ï¼Œæ³¨æ„ä¸æ˜¯å®ä¾‹ã€‚

```js
const methodKey = ctx.getHandler().name; // "create"
const className = ctx.getClass().name; // "CatsController"
```

å‰é¢è§£æå®ˆå«æ—¶å·²ç»æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨ `@SetMetadata()` æä¾›å…ƒæ•°æ®ï¼Œå¹¶ä¸”é€šè¿‡åå°„æ¨¡å—è·å–å®ƒï¼Œ

```ts
// cats.controller.ts

@Post()
@SetMetadata('roles', ['admin'])
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```

```ts
// roles.guard.ts

@Injectable()
export class RolesGuard {
  constructor(private reflector: Reflector) {}
}
```

ç„¶ååœ¨å®ˆå«æ–¹æ³•ä¸­ï¼Œé€šè¿‡ `Reflector` ç±»è¯»å–å‡ºå…ƒæ•°æ®ï¼š

    const roles = this.reflector.get<string[]>('roles', context.getHandler());




## ğŸ‘‰ Lifecycle Events ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
- https://docs.nestjs.com/fundamentals/lifecycle-events
- Process Signal Events https://nodejs.org/api/process.html#process_signal_events

Nest åº”ç”¨å’Œå„åº”ç”¨å…ƒç´ éƒ½æœ‰ç”Ÿæˆå‘¨æœŸï¼ŒNest æä¾›å‹¾å­æœºåˆ¶ä½¿å…³é”®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å…·æœ‰å¯è§æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œæ“ä½œï¼Œå¦‚åœ¨æ¨¡å—ã€å¯æ³¨å…¥æˆ–æ§åˆ¶å™¨ä¸Šè¿è¡Œæ³¨å†Œä»£ç ã€‚

åº”ç”¨æ‰§è¡Œå¯ä»¥ç®€å•åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š

- initializing åˆå§‹åŒ–ï¼›
- running è¿è¡Œä¸­ï¼›
- terminating ç»“æŸé€€å‡ºï¼›

ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š

|        Lifecycle Hook        |                                    è§¦å‘æ—¶æœº                                   |
|------------------------------|-------------------------------------------------------------------------------|
| onModuleInit()               | å¯„ä¸»æ¨¡å—ä¾èµ–è§£å†³æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚                                                  |
| onApplicationBootstrap()     | æ¨¡å—åˆå§‹åŒ–åï¼Œåœ¨ä¾¦å¬è¿æ¥å‰æ‰§è¡Œä¸€æ¬¡ã€‚                                          |
| onModuleDestroy()*           | æ”¶åˆ°ç»“æŸä¿¡å·æ—¶æ‰§è¡Œ (e.g., SIGTERM)ã€‚                                          |
| beforeApplicationShutdown()* | åœ¨æ‰€æœ‰æ¨¡å—å®Œæˆæ¸…ç†åæ‰§è¡Œï¼ŒPromises è§£å†³ï¼Œæ‰€æœ‰è¿æ¥éƒ½ä¼šå…³é—­ï¼Œapp.close() è¢«è°ƒç”¨ |
| onApplicationShutdown()*     | è¿æ¥å…³é—­ï¼Œapp.close() è¢«è°ƒç”¨                                                  |

* åŠ æ˜Ÿçš„äº‹ä»¶ï¼Œå¦‚æœä¸æ˜¯æ˜¾å¼è°ƒç”¨ app.close() è§¦å‘ï¼Œå°±éœ€è¦é€‰æ‹©æ€§åŠ å…¥ï¼Œé¡»ä¸ç³»ç»Ÿä¿¡æ¯ä¸€èµ·å·¥ä½œï¼Œå¦‚ä¿¡å· SIGTERMã€‚

å…³é—­äº‹ä»¶å‹¾å­æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œé»˜è®¤æ˜¯å…³é—­çš„ï¼Œé€šè¿‡ `enableShutdownHooks()` æ¿€æ´»ï¼š

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Starts listening for shutdown hooks
  app.enableShutdownHooks();

  await app.listen(3000);
}
bootstrap();
```

ç”±äºæ“ä½œç³»ç»Ÿå·®å¼‚ï¼ŒNestJS åœ¨ Windows ä¸Šå®ç° Shutdown Hook æœ‰äº›é™åˆ¶ã€‚å¯ä»¥æœŸæœ› `SIGINT` å’Œ `SIGBREAK` ä¿¡å·æ­£å¸¸å·¥ä½œï¼Œæœ‰æ—¶ `SIGHUP` ä¹Ÿå¯ä»¥ã€‚ç„¶è€Œï¼Œ`SIGTERM` æ°¸è¿œä¸ä¼šåœ¨ Windows ä¸Šå·¥ä½œï¼Œå› ä¸ºåœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ç»ˆæ­¢è¿›ç¨‹æ˜¯æ— æ¡ä»¶çš„ï¼Œå³åº”ç”¨ç¨‹åºæ— æ³•æ£€æµ‹æˆ–é˜»æ­¢å®ƒã€‚

å‚è€ƒ Node.js æˆ– libuv å…³äº `SIGINT` `SIGBREAK` ç­‰ Windows ä¿¡å·çš„å¤„ç†ã€‚


æ¯ä¸ªå‹¾å­éƒ½å¯¹åº”ä¸€ä¸ªæ¥å£ï¼Œéœ€è¦ä½¿ç”¨æ—¶å°±å®ç°å¯¹åº”çš„æ¥å£ï¼Œå¯ä»¥é€‰æ‹© async/await å¼‚æ­¥æ–¹å¼å®ç°ï¼š

```
import { Injectable, OnModuleInit } from '@nestjs/common';

@Injectable()
export class UsersService implements OnModuleInit {
  onModuleInit() {
    console.log(`The module has been initialized.`);
  }
  //  onModuleInit(): Promise<void> {
  //    this.fetch();
  // }
}
```




## ğŸ‘‰ Testing æµ‹è¯•
- https://docs.nestjs.com/fundamentals/testing
- https://github.com/visionmedia/superagent

è‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯ä»»ä½•é‡è¦è½¯ä»¶ç³»ç»Ÿä¸­å¿…è¦ç¯èŠ‚ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å®ç°å¤§å¹…åº¦çš„ä»£ç æµ‹è¯•è¦†ç›–ï¼Œæé«˜è½¯ä»¶è´¨é‡ï¼Œå¹¶ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¿«çš„åé¦ˆå¾ªç¯ã€‚

è‡ªåŠ¨åŒ–æ—¢æé«˜äº†å•ä¸ªå¼€å‘äººå‘˜çš„ç”Ÿäº§åŠ›ï¼Œåˆç¡®ä¿æµ‹è¯•åœ¨å…³é”®çš„å¼€å‘ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œä¾‹å¦‚æºä»£ç æ§åˆ¶ç­¾å…¥ã€ç‰¹æ€§é›†æˆå’Œç‰ˆæœ¬å‘å¸ƒã€‚

æµ‹è¯•é€šå¸¸è·¨è¶Šå¤šç§ç±»å‹ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯• Unit Testsã€ç«¯åˆ°ç«¯æµ‹è¯• End-to-End Testsã€é›†æˆæµ‹è¯• Integration Tests ç­‰ç­‰ã€‚è™½ç„¶å¥½å¤„æ˜¯è‚¯å®šçš„ï¼Œä½†èŠ±æ—¶é—´åœ¨å®ƒä»¬èº«ä¸Šå¯èƒ½ä¼šå¾ˆä¹å‘³ã€‚

Nest Testing è‡´åŠ›äºä¿ƒè¿›å¼€å‘æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬æœ‰æ•ˆçš„æµ‹è¯•ï¼ŒåŒ…å«å¦‚ä¸‹ç‰¹æ€§ï¼š

- è‡ªåŠ¨åŒ–è„šæ‰‹æ¶ä¸ºç»„ä»¶ç”Ÿæˆé»˜è®¤çš„å•å…ƒæµ‹è¯•ï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›ç«¯åˆ°ç«¯æµ‹è¯•ï¼›
- æä¾›é»˜è®¤çš„å·¥å…·ï¼Œå¦‚æ„å»ºç‹¬ç«‹æ¨¡å—/åº”ç”¨åŠ è½½ç¨‹åºçš„æµ‹è¯•è¿è¡Œç¨‹åºï¼›
- é›†æˆå¼€ç®±å³ç”¨çš„ Jest å’Œ Supertestï¼ŒåŒæ—¶ä¿æŒæµ‹è¯•å·¥å…·çš„ç®€æ´æ€§ï¼›
- æµ‹è¯•ä¸­ä¿æŒä¾èµ–æ³¨å…¥ç³»ç»Ÿæœ‰æ•ˆï¼Œå®ç°ç»„ä»¶çš„æ¨¡æ‹Ÿï¼›

Nest ä¸å¼ºåˆ¶ä»»ä½•ç‰¹å®šçš„æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨å–œæ¬¢çš„æµ‹è¯•æ¡†æ¶ã€‚åªéœ€æ›¿æ¢æ‰€éœ€çš„å…ƒç´ ï¼Œå¦‚ test runnerï¼Œä»ç„¶å¯ä»¥äº«å— Nest ç°æˆæµ‹è¯•è®¾æ–½ã€‚

å®‰è£…æµ‹è¯•æ¨¡å—ï¼š

    $ npm i --save-dev @nestjs/testing


### Unit Tests å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•ç¤ºèŒƒï¼Œæ³¨æ„æµ‹è¯•è„šæœ¬å¸¦æœ‰ `spec` æˆ–è€… `test` åç¼€ï¼š

```js
// cats.controller.spec.ts

import { CatsController } from './cats.controller';
import { CatsService } from './cats.service';

describe('CatsController', () => {
  let catsController: CatsController;
  let catsService: CatsService;

  beforeEach(() => {
    catsService = new CatsService();
    catsController = new CatsController(catsService);
  });

  describe('findAll', () => {
    it('should return an array of cats', async () => {
      const result = ['test'];
      jest.spyOn(catsService, 'findAll').mockImplementation(() => result);

      expect(await catsController.findAll()).toBe(result);
    });
  });
});
```

ä½¿ç”¨ `@nestjs/testing` å¯¼å‡ºçš„å…¶å®ƒæµ‹è¯•å·¥å…· Testing utilitiesï¼š

```js
// cats.controller.spec.ts

import { Test } from '@nestjs/testing';
import { CatsController } from './cats.controller';
import { CatsService } from './cats.service';

describe('CatsController', () => {
  let catsController: CatsController;
  let catsService: CatsService;

  beforeEach(async () => {
    const moduleRef = await Test.createTestingModule({
        controllers: [CatsController],
        providers: [CatsService],
      }).compile();

    catsService = moduleRef.get<CatsService>(CatsService);
    catsController = moduleRef.get<CatsController>(CatsController);
  });

  describe('findAll', () => {
    it('should return an array of cats', async () => {
      const result = ['test'];
      jest.spyOn(catsService, 'findAll').mockImplementation(() => result);

      expect(await catsController.findAll()).toBe(result);
    });
  });
});
```

æ³¨æ„ `TestingModule` ç»§æ‰¿è‡ª Module Referenceï¼Œå¯ä»¥è§£å†³ä¾èµ–çš„å¾ªç¯å¼•ç”¨ã€‚

å¦å¤–ï¼Œ`resolve()` æ–¹æ³•åœ¨æ¯æ¬¡æ‰§è¡Œï¼Œè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªæ–°å®ä¾‹ï¼š

    catsService = await moduleRef.resolve(CatsService);


### End-to-End ç«¯åˆ°ç«¯æµ‹è¯•

ä¸å…³æ³¨å•ä¸ªæ¨¡å—å’Œç±»çš„å•å…ƒæµ‹è¯•ä¸åŒï¼Œç«¯åˆ°ç«¯æµ‹è¯•æ¶µç›–äº†ç±»å’Œæ¨¡å—åœ¨æ›´èšåˆçº§åˆ«ä¸Šçš„äº¤äº’ï¼Œå³æ›´æ¥è¿‘æœ€ç»ˆç”¨æˆ·äº¤äº’ç¯å¢ƒä¸‹çš„æµ‹è¯•ã€‚éšç€åº”ç”¨ç¨‹åºçš„å¢é•¿ï¼Œæ‰‹åŠ¨æµ‹è¯•æ¯ä¸ª API ç«¯ç‚¹çš„ç«¯åˆ°ç«¯è¡Œä¸ºå˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚è‡ªåŠ¨åŒ–çš„ç«¯åˆ°ç«¯æµ‹è¯•å¸®åŠ©æˆ‘ä»¬ç¡®ä¿ç³»ç»Ÿçš„æ•´ä½“è¡Œä¸ºæ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”æ»¡è¶³é¡¹ç›®éœ€æ±‚ã€‚ä¸ºäº†æ‰§è¡Œ e2e æµ‹è¯•ï¼Œä½¿ç”¨ä¸å•å…ƒæµ‹è¯•ä¸­ç±»ä¼¼çš„é…ç½®ã€‚æ­¤å¤–ï¼ŒNest ä½¿ç”¨ Supertest åº“ä½¿å¾—æ¨¡æ‹Ÿ HTTP è¯·æ±‚å˜å¾—å¾ˆå®¹æ˜“ã€‚

Supertest è¿™ä¸ªæ¨¡å—çš„åŠ¨æœºæ˜¯ä¸ºæµ‹è¯• HTTP æä¾›é«˜çº§æŠ½è±¡ï¼ŒåŒæ—¶ä»ç„¶å…è®¸ä½¿ç”¨ superagent æä¾›çš„ä½çº§ API æ‰§è¡Œ AJAX è¯·æ±‚ã€‚

ç”¨å¤§ç™½è¯è¯´ï¼Œå°±æ˜¯åƒæ­£å¸¸ä½¿ç”¨è½¯ä»¶é‚£æ ·å¯¹ API è¿›è¡Œæµ‹è¯•ï¼š

```js
// cats.e2e-spec.ts

import * as request from 'supertest';
import { Test } from '@nestjs/testing';
import { CatsModule } from '../../src/cats/cats.module';
import { CatsService } from '../../src/cats/cats.service';
import { INestApplication } from '@nestjs/common';

describe('Cats', () => {
  let app: INestApplication;
  let catsService = { findAll: () => ['test'] };

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [CatsModule],
    })
      .overrideProvider(CatsService)
      .useValue(catsService)
      .compile();

    app = moduleRef.createNestApplication();
    await app.init();
  });

  it(`/GET cats`, () => {
    return request(app.getHttpServer())
      .get('/cats')
      .expect(200)
      .expect({
        data: catsService.findAll(),
      });
  });

  afterAll(async () => {
    await app.close();
  });
});
```

å¦‚æœä½¿ç”¨ Fastify ä½œä¸º HTTP adapterï¼Œéœ€è¦ç¨ä½œé…ç½®ä¿®æ”¹ï¼š

```js
let app: NestFastifyApplication;

beforeAll(async () => {
  app = moduleRef.createNestApplication<NestFastifyApplication>(
    new FastifyAdapter(),
  );

  await app.init();
  await app.getHttpAdapter().getInstance().ready();
})

it(`/GET cats`, () => {
  return app
    .inject({
      method: 'GET',
      url: '/cats'
    }).then(result => {
      expect(result.statusCode).toEqual(200)
      expect(result.payload).toEqual(/* expectedPayload */)
    });
})
```

ä¸¤ä¸ªä¾‹å­çš„å·®åˆ«åœ¨ `compile()` å’Œ `createNestApplication()` æ–¹æ³•çš„ä½¿ç”¨ã€‚ç”¨ Supertest æä¾›çš„ `request()` æ–¹æ³•æ¥æ¨¡æ‹Ÿ HTTP è¯·æ±‚ã€‚


Overriding globally registered enhancers

å¦‚æœä½¿ç”¨äº†å…¨å±€å®ˆå«ï¼Œæˆ–ç®¡é“ã€æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ï¼Œåˆ™éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥å¢å¼ºè¦†ç›–ã€‚

If you have a globally registered guard (or pipe, interceptor, or filter), you need to take a few more steps to override that enhancer. To recap the original registration looks like this:

```js
providers: [
  {
    provide: APP_GUARD,
    useClass: JwtAuthGuard,
  },
],
```

This is registering the guard as a "multi"-provider through the APP_* token. To be able to replace the JwtAuthGuard here, the registration needs to use an existing provider in this slot:


```js
providers: [
  {
    provide: APP_GUARD,
    useExisting: JwtAuthGuard,
  },
  JwtAuthGuard,
],
```

Now the JwtAuthGuard is visible to Nest as a regular provider that can be overridden when creating the TestingModule:

```js
const moduleRef = await Test.createTestingModule({
  imports: [AppModule],
})
  .overrideProvider(JwtAuthGuard)
  .useClass(MockAuthGuard)
  .compile();
```


## ğŸ‘‰ Security å®‰å…¨æ€§
- https://docs.nestjs.com/security/authentication
- https://docs.nestjs.com/security/authorization

### Encryption & Hashing
- https://nodejs.org/api/crypto.html
- https://www.cnblogs.com/yanzi-meng/p/9640546.html

Nest è‡ªèº«æ²¡æœ‰ç›¸å…³çš„æ¨¡å—ï¼Œé€šè¿‡ä½¿ç”¨ Node.js å†…å»ºçš„åŠ å¯†åŠŸèƒ½æ¨¡å— crypto moduleï¼Œå¯ä»¥å®ç°å¯¹ strings, numbers, buffers, streams ç­‰å†…å®¹çš„åŠ å¯†ä¸è§£å¯†ã€‚ 

ç¤ºèŒƒ AES - Advanced Encryption System åŠ å¯†ç®—æ³• `aes-256-ctr`ï¼š

```ts
import { createCipheriv, randomBytes } from 'crypto';
import { promisify } from 'util';

const iv = randomBytes(16);
const password = 'Password used to generate key';

// The key length is dependent on the algorithm.
// In this case for aes256, it is 32 bytes.
const key = (await promisify(scrypt)(password, 'salt', 32)) as Buffer;
const cipher = createCipheriv('aes-256-ctr', key, iv);

const textToEncrypt = 'Nest';
const encryptedText = Buffer.concat([
  cipher.update(textToEncrypt),
  cipher.final(),
]);
```

ç„¶åå¯¹ encryptedText è¿›è¡Œè§£å¯†ï¼š

```ts
import { createDecipheriv } from 'crypto';

const decipher = createDecipheriv('aes-256-ctr', key, iv);
const decryptedText = Buffer.concat([
  decipher.update(encryptedText),
  decipher.final(),
]);
```

AES æ˜¯ä¸€ç§åˆ†ç»„å¯†ç  Block Cipherï¼Œå³å°†æ˜æ–‡æ¶ˆæ¯ç¼–ç è¡¨ç¤ºåçš„æ˜æ–‡æ•°å­—åºåˆ—ï¼Œåˆ’åˆ†æˆé•¿åº¦ä¸º n çš„åˆ†ç»„ï¼Œå¯çœ‹æˆé•¿åº¦ä¸º n çš„çŸ¢é‡ï¼Œæ¯ç»„åˆ†åˆ«åœ¨å¯†é’¥çš„æ§åˆ¶ä¸‹å˜æ¢æˆç­‰é•¿çš„è¾“å‡ºåºåˆ—ï¼Œå³å¯†æ–‡æ•°å­—ã€‚

AES æœ‰äº”ç§å·¥ä½œä½“åˆ¶

- ECB - Electronic Codebook Book ç”µç æœ¬æ¨¡å¼ï¼Œå°†æ•´ä¸ªæ˜æ–‡åˆ†æˆè‹¥å¹²æ®µç›¸åŒçš„å°æ®µï¼Œç„¶åå¯¹æ¯ä¸€å°æ®µè¿›è¡ŒåŠ å¯†ã€‚
- CBC - Cipher Block Chaining å¯†ç åˆ†ç»„é“¾æ¥æ¨¡å¼ï¼Œå…ˆå°†æ˜æ–‡åˆ‡åˆ†æˆè‹¥å¹²å°æ®µï¼Œç„¶åä¸åˆå§‹å—æˆ–è€…ä¸Šä¸€æ®µçš„å¯†æ–‡æ®µè¿›è¡Œå¼‚æˆ–è¿ç®—åï¼Œå†è¿›è¡ŒåŠ å¯†ã€‚
- CTR - Counter è®¡æ•°å™¨æ¨¡å¼ï¼Œæœ‰è‡ªå¢çš„ç®—å­ï¼Œç®—å­åŠ å¯†ä¹‹åçš„è¾“å‡ºå’Œæ˜æ–‡å¼‚æˆ–çš„ç»“æœå¾—åˆ°å¯†æ–‡ï¼Œç›¸å½“äºä¸€æ¬¡ä¸€å¯†ã€‚è¿™ç§åŠ å¯†æ–¹å¼ç®€å•å¿«é€Ÿï¼Œå®‰å…¨å¯é ï¼Œå¯ä»¥å¹¶è¡ŒåŠ å¯†ã€‚
- CFB - Cipher FeedBack å¯†ç åé¦ˆæ¨¡å¼ï¼Œè¿™ç§ç®—æ³•æ¨¡å¼è¾ƒå¤æ‚ã€‚
- OFB - Output FeedBack è¾“å‡ºåé¦ˆæ¨¡å¼ï¼ŒåŒä¸Šã€‚

å¯¹äºå“ˆå¸Œæ•£åˆ—æ•° Hashing ä½¿ç”¨ bcrypt æˆ–è€… argon2 æ¨¡å—ã€‚

    $ npm i bcrypt
    $ npm i -D @types/bcrypt

ä¾‹å¦‚ä½¿ç”¨ `bcrypt` ç”Ÿæˆéšæœºå¯†ç çš„å“ˆå¸Œï¼Œä½¿ç”¨ `genSalt()` åŠ ç›æå‡å®‰å…¨æ€§ï¼Œå“ˆå¸Œæ£€éªŒä½¿ç”¨ `compare()` å‡½æ•°ï¼š

```ts
import * as bcrypt from 'bcrypt';

const saltOrRounds = 10;
// const salt = await bcrypt.genSalt();

const password = 'random_password';
const hash = await bcrypt.hash(password, saltOrRounds);

const isMatch = await bcrypt.compare(password, hash);
```


### CSRF Protection è·¨ç«™ä¼ªé€ è¯·æ±‚æ”»å‡»
- https://docs.nestjs.com/security/csrf

è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ æ”»å‡» Cross-site request forgery ä¹Ÿç§°ä¸º CSRF æˆ– XSRFï¼Œæ˜¯é€šè¿‡ä¼ªé€ è¯·æ±‚å¯¹ç½‘ç«™å®æ–½çš„ä¸€ç§æ¶æ„æ”»å‡»ï¼Œé€šè¿‡åœ¨ Web åº”ç”¨ç¨‹åºä¿¡ä»»çš„ç”¨æˆ·å¤„ä¼ªé€ æœªç»æˆæƒçš„å‘½ä»¤å¹¶å‘å¾€æœåŠ¡å™¨ï¼Œä»è€Œæ¨¡æ‹Ÿå‡ºåˆæ³•æœ‰æ•ˆçš„æ“ä½œè¾¾åˆ°æ”»å‡»ç›®çš„ã€‚

ä¹Ÿè¢«ç§°ä¸º One Click Attack æˆ–è€… Session Ridingï¼Œä¹Ÿå°±æ˜¯äººä»¬æ‰€çŸ¥é“çš„é’“é±¼ç½‘ç«™ã€‚å°½ç®¡å¬èµ·æ¥åƒè·¨ç«™è„šæœ¬æ”»å‡» XSSï¼Œä½†å®ƒä»¬éå¸¸ä¸åŒï¼Œå¹¶ä¸”æ”»å‡»æ–¹å¼å‡ ä¹ç›¸å·¦ã€‚XSS åˆ©ç”¨ç«™ç‚¹å†…çš„ä¿¡ä»»ç”¨æˆ·ï¼Œè€Œ CSRF åˆ™é€šè¿‡ä¼ªè£…æ¥è‡ªå—ä¿¡ä»»ç”¨æˆ·çš„è¯·æ±‚æ¥åˆ©ç”¨å—ä¿¡ä»»çš„ç½‘ç«™ã€‚ä¸ XSS æ”»å‡»ç›¸æ¯”ï¼ŒCSRF æ”»å‡»å¾€å¾€ä¸å¤§æµè¡Œï¼Œå› æ­¤å¯¹å…¶è¿›è¡Œé˜²èŒƒçš„èµ„æºä¹Ÿç›¸å½“ç¨€å°‘ï¼Œå’Œéš¾ä»¥é˜²èŒƒï¼Œæ‰€ä»¥è¢«è®¤ä¸ºæ¯” XSS æ›´å…·å±é™©æ€§ã€‚

ç®€å•åœ°è¯´ï¼ŒXSS å°±æ˜¯æ”»å‡»è€…å¾€é¡µé¢æ’å…¥æ¶æ„ Script ä»£ç ï¼Œå½“ç”¨æˆ·æµè§ˆè¯¥é¡µä¹‹æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ”»å‡»ç›®çš„ã€‚

å¯ä»¥è¿™ä¹ˆç†è§£ CSRF æ”»å‡»ï¼šæ”»å‡»è€…ç›—ç”¨äº†ä½ çš„èº«ä»½ï¼Œä¼ªè£…æˆä½ å‘é€æ¶æ„è¯·æ±‚ã€‚CSRF èƒ½å¤Ÿåšçš„äº‹æƒ…åŒ…æ‹¬ï¼šä»¥ä½ åä¹‰å‘é€é‚®ä»¶ï¼Œå‘æ¶ˆæ¯ï¼Œç›—å–ä½ çš„è´¦å·ï¼Œç”šè‡³äºè´­ä¹°å•†å“ï¼Œè™šæ‹Ÿè´§å¸è½¬è´¦ç­‰ç­‰ï¼Œé€ æˆä¸ªäººéšç§æ³„éœ²ä»¥åŠå¨èƒè´¢äº§å®‰å…¨ã€‚

å…¸å‹çš„ CSRF å‘ç”Ÿåœºæ™¯ï¼šç™»å½•å—ä¿¡ä»»ç½‘ç«™ Aï¼Œå¹¶åœ¨æœ¬åœ°ç”Ÿæˆ Cookieï¼Œåœ¨ä¸ç™»å‡º A çš„æƒ…å†µä¸‹ï¼Œè®¿é—®å±é™©ç½‘ç«™ B å°±å¯èƒ½è¢«æ”»å‡»ã€‚

ä¾‹å¦‚ GET ç±»å‹çš„ CSRF æ”»å‡»ï¼š

    <img src="http://wooyun.org/csrf?xx=11" /> 

åœ¨è®¿é—®å«æœ‰è¿™ä¸ª img çš„é¡µé¢åï¼ŒæˆåŠŸå‘æœåŠ¡å‘å‡ºäº†ä¸€æ¬¡ HTTP GET è¯·æ±‚ï¼Œå¹¶ä¸”æœ‰æ•ˆçš„ Cookie æ•°æ®ä¹Ÿä¸€å¹¶å‘é€ã€‚æ‰€ä»¥ï¼Œå¦‚æœå°†è¯¥ç½‘å€æ›¿æ¢ä¸ºå­˜åœ¨ GET å‹ CSRF çš„åœ°å€ï¼Œå°±èƒ½å®Œæˆæ”»å‡»äº†ã€‚

å†æ¯”å¦‚ POST ç±»å‹çš„ CSRF æ”»å‡»ï¼š

```html
<form action="http://wooyun.org/csrf.php" method="POST">
    <input type="text" name="xx" value="11" />
</form>
<script> document.forms[0].submit(); </script> 
```

è¿™ç§ç±»å‹çš„ CSRF å±å®³æ²¡æœ‰ GET å‹çš„å¤§ï¼Œå› ä¸ºéœ€è¦åˆ©ç”¨è¡¨ç¤ºæäº¤åŠ¨åŠ¨ã€‚è®¿é—®æ”»å‡»é¡µé¢åï¼Œè¡¨å•ä¼šè‡ªåŠ¨æäº¤ï¼Œç›¸å½“äºæ¨¡æ‹Ÿç”¨æˆ·å®Œæˆäº†ä¸€æ¬¡ POST æ“ä½œã€‚

åœ¨ä¸šç•Œç›®å‰é˜²å¾¡ CSRF æ”»å‡»ä¸»è¦æœ‰ä¸‰ç§ç­–ç•¥ï¼š

- HTTP Referer å¼•ç”¨é¡µé¢å­—æ®µéªŒè¯ï¼›
- Token éªŒè¯ï¼Œåœ¨è¯·æ±‚åœ°å€ä¸­æ·»åŠ éªŒè¯ä»¤ç‰Œï¼›
- è‡ªå®šä¹‰ HTTP å¤´ä¿¡æ¯ï¼Œå¹¶éªŒè¯ï¼›

é€šå¸¸ Referer çš„å€¼æ˜¯ç”±æµè§ˆå™¨æä¾›çš„ï¼Œè™½ç„¶ HTTP åè®®ä¸Šæœ‰æ˜ç¡®çš„è¦æ±‚ï¼Œä½†æ˜¯æ¯ä¸ªæµè§ˆå™¨å¯¹äº Referer çš„å…·ä½“å®ç°å¯èƒ½æœ‰å·®åˆ«ï¼Œå¹¶ä¸èƒ½ä¿è¯æµè§ˆå™¨è‡ªèº«æ²¡æœ‰å®‰å…¨æ¼æ´ã€‚ä½¿ç”¨ Referer éªŒè¯çš„æ–¹æ³•ï¼Œå°±æ˜¯æŠŠå®‰å…¨æ€§éƒ½ä¾èµ–äºç¬¬ä¸‰æ–¹ï¼ˆå³æµè§ˆå™¨ï¼‰æ¥ä¿éšœï¼Œä»ç†è®ºä¸Šæ¥è®²ï¼Œè¿™æ ·å¹¶ä¸å®‰å…¨ã€‚äº‹å®ä¸Šï¼Œå¯¹äºæŸäº›æµè§ˆå™¨ï¼Œæ¯”å¦‚ IE6 æˆ– FF2ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•å¯ä»¥ç¯¡æ”¹ Referer å€¼ã€‚

CSRF æ”»å‡»ä¹‹æ‰€ä»¥èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºé»‘å®¢å¯ä»¥å®Œå…¨ä¼ªé€ ç”¨æˆ·çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¸­æ‰€æœ‰çš„ç”¨æˆ·éªŒè¯ä¿¡æ¯éƒ½æ˜¯å­˜åœ¨äº cookie ä¸­ï¼Œå› æ­¤é»‘å®¢å¯ä»¥åœ¨ä¸çŸ¥é“è¿™äº›éªŒè¯ä¿¡æ¯çš„æƒ…å†µä¸‹ç›´æ¥åˆ©ç”¨ç”¨æˆ·è‡ªå·±çš„ cookie æ¥é€šè¿‡å®‰å…¨éªŒè¯ã€‚è¦æŠµå¾¡ CSRFï¼Œå…³é”®åœ¨äºåœ¨è¯·æ±‚ä¸­æ”¾å…¥é»‘å®¢æ‰€ä¸èƒ½ä¼ªé€ çš„ä¿¡æ¯ï¼Œå¹¶ä¸”è¯¥ä¿¡æ¯ä¸å­˜åœ¨äº cookie ä¹‹ä¸­ã€‚å¯ä»¥åœ¨ HTTP è¯·æ±‚ä¸­ä»¥å‚æ•°çš„å½¢å¼åŠ å…¥ä¸€ä¸ªéšæœºäº§ç”Ÿçš„ tokenï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯å»ºç«‹ä¸€ä¸ªæ‹¦æˆªå™¨æ¥éªŒè¯è¿™ä¸ª tokenï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ token æˆ–è€… token å†…å®¹ä¸æ­£ç¡®ï¼Œåˆ™è®¤ä¸ºå¯èƒ½æ˜¯ CSRF æ”»å‡»è€Œæ‹’ç»è¯¥è¯·æ±‚ã€‚

é€šå¸¸åœ¨ä¸€ä¸ª hidden è¡¨å•ä¸­è®¾ç½® Tokenï¼š

    <input type=â€hiddenâ€ name=â€csrftokenâ€ value=â€tokenvalueâ€/>

ä½†æ˜¯ï¼Œåœ¨ä¸€ä¸ªç½‘ç«™ä¸­ï¼Œå¯ä»¥æ¥å—è¯·æ±‚çš„åœ°æ–¹éå¸¸å¤šï¼Œè¦å¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½åŠ ä¸Š token æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“æ¼æ‰ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç»Ÿä¸€çš„ HTTP è¯·æ±‚å°è£…ï¼Œå°† Token ä½œä¸ºä¸€ä¸ªå¿…éœ€å‚æ•°é»˜è®¤æ·»åŠ åˆ°æ¯ä¸ªè¯·æ±‚ä¸­ã€‚å¸¸è§„åšæ³•å°±æ˜¯å°† Token è®¾ç½®åˆ° HTTP å¤´ä¿¡æ¯ä¸­ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åè¿›è¡ŒéªŒè¯ã€‚


è¦å‡è½»è¿™ç§æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨ csurf åŒ…ï¼Œå’Œ Express ä½¿ç”¨ï¼š

    $ npm i --save csurf

å®‰è£…æ¨¡å—åï¼Œå°† csurf middleware ä½œä¸ºå…¨å±€ä¸­é—´ä»¶ä½¿ç”¨ï¼š

```ts
import * as csurf from 'csurf';
// somewhere in your initialization file
app.use(csurf());
```

ä½¿ç”¨ Fastify Web æœåŠ¡æŒ‰ä»¥ä¸‹æ“ä½œï¼š

    $ npm i --save fastify-csrf

å®‰è£…æ¨¡å—åï¼Œæ³¨å†Œ fastify-csrf æ’ä»¶ï¼š

```ts
import fastifyCsrf from 'fastify-csrf';
// somewhere in your initialization file
app.register(fastifyCsrf);
```

### Rate Limiting é€Ÿç‡é™åˆ¶
- https://docs.nestjs.com/security/rate-limiting

é€Ÿç‡é™åˆ¶ Rate limiting æ˜¯ä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æš´åŠ›æ”»å‡»ï¼Œbrute-force attacksï¼Œçš„ä¸€ç§å¸¸è§æŠ€æœ¯ï¼Œè®¸å¤š Express æ¨¡å—éƒ½æä¾›äº†è¿™ä¸€åŠŸèƒ½ã€‚

ä¸€ä¸ªæµè¡Œçš„æ¨¡æ‹Ÿæ˜¯ express-rate-limitï¼Œå®‰è£…ä½¿ç”¨ï¼š

    $ npm i --save express-rate-limit

ç„¶åï¼Œå°† `rate-limiter` æ³¨å†Œä¸ºå…¨å±€ä¸­é—´ä»¶ï¼š

```ts
import * as rateLimit from 'express-rate-limit';
// somewhere in your initialization file
app.use(
  rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // limit each IP to 100 requests per windowMs
  }),
);
```

å¦‚æœæœåŠ¡å™¨ä½¿ç”¨äº†è´Ÿè½½å‡è¡¡ï¼Œæˆ–åå‘ä»£ç†æ—¶ï¼Œload balancer or reverse proxyï¼Œå¯èƒ½éœ€è¦ä¸º Express é…ç½®ä¿¡ä»»ä»£ç†çš„æ ‡å¤´ï¼Œä»¥ä¾¿æœ€ç»ˆç”¨æˆ·è·å–æ­£ç¡®çš„ IPã€‚ä¸ºæ­¤ï¼Œåœ¨åˆ›å»ºåº”ç”¨ç¨‹åºå®ä¾‹æ—¶ä½¿ç”¨ `NestExpressApplication` å¹³å°æ¥å£ï¼Œç„¶åå¯ç”¨ä¿¡ä»»ä»£ç†è®¾ç½®ï¼š

```ts
const app = await NestFactory.create<NestExpressApplication>(AppModule);
// see https://expressjs.com/en/guide/behind-proxies.html
app.set('trust proxy', 1);
```



### CORS è·¨åŸŸèµ„æºå…±äº«
- https://docs.nestjs.com/security/cors
- https://github.com/expressjs/cors#configuration-options

ä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æš´åŠ›æ”»å‡»çš„ä¸€ç§å¸¸è§æŠ€æœ¯æ˜¯é€Ÿç‡é™åˆ¶ rate-limitï¼Œè®¸å¤š express çš„å­˜åœ¨æ˜¯ä¸ºäº†æä¾›é€Ÿç‡é™åˆ¶åŠŸèƒ½ã€‚ä¸€ä¸ªæµè¡Œçš„æ˜¯ç‰¹å¿«ä¸“é€’é™é¢ã€‚

åœ¨ REST åº”ç”¨ä¸­ï¼Œä¸»ç¨‹å…¥å£å®ä¾‹åŒ–ç¨‹åºæ¨¡å—æ—¶ï¼Œå¯ä»¥ä¼ å…¥å¦‚ CORS è¿™æ ·çš„å‚æ•°ï¼š

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe } from './pipes/validation.pipe';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // const app = await NestFactory.create(AppModule, { cors: true });
  // app.enableCors();
  // app.useGlobalPipes(new ValidationPipe());
  await app.listen(3001);
}
bootstrap();
```

æ³¨æ„ï¼ŒCorsOptionsDelegate ä¸èƒ½åœ¨ apollo-server-fastify æ¨¡å—ä¸­å·¥ä½œã€‚

GraphQL æ¨¡å—çš„ CORS è®¾ç½®æ–¹æ³•ï¼š

```ts
GraphQLModule.forRoot({
  cors: {
    origin: 'http://localhost:3000',
    credentials: true,
  },
}),
```



# ğŸš© RxJS å…‰é€Ÿå…¥é—¨
- Explore all RxJS operators https://reactive.how/rxjs/
- Interactive diagrams of Rx Observables https://rxmarbles.com
- FRP - Functional Reactive Programming https://www.cnblogs.com/apolis/p/11437688.html
- Taming snakes with reactive streams https://blog.thoughtram.io/rxjs/2017/08/24/taming-snakes-with-reactive-streams.html
- Cycle.js äººæœºäº¤äº’æ¡†æ¶ https://cycle.js.org

RxJS å³å“åº”å¼ç¼–ç¨‹ Reactive Extension JavaScriptï¼Œé€šè¿‡å°†ä»£ç åŠŸèƒ½æ—¶åºæŠ½è±¡ä¸ºæˆä¸€æ ¹æ—¶é—´è½´ï¼Œåœ¨è¿™æ ¹æ—¶é—´è½´ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œï¼Œè€Œå¼‚æ­¥ç›¸å…³çš„æ—¶åºå¤„ç†å°±äº¤ç»™å„ç§ operator å¤„ç†ã€‚

ä»è¿™ç‚¹çœ‹ï¼Œå‡½æ•°å“åº”å¼ç¼–ç¨‹è¿™ä¸ªåå­—å¹¶æ²¡æœ‰å¾ˆå¥½æ¦‚æ‹¬ RxJSï¼Œå®ƒæ˜¯æ—¶åºç›¸å…³çš„æ•°æ®æµï¼Œè€Œæµä¸Šçš„æ•°æ®å°±ç›¸å½“äºæ—¶åºä¿¡å· Signalï¼Œè€Œå„ç§æ“ä½œå‡½æ•°å°±æ˜¯ä¿¡æ¯å¤„ç†å‡½æ•°ã€‚

JavaScript æ˜¯ä¸ªå¤šèŒƒå¼è¯­è¨€ï¼Œå®ƒæ—¢æ”¯æŒè¿‡ç¨‹å¼ç¼–ç¨‹ï¼Œåˆæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ï¼Œä¸¤è€…åˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºåˆã€‚åœ¨åŒæ­¥ç¯å¢ƒä¸‹ï¼Œä¸¤è€…å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œç”šè‡³æœ‰æ—¶å€™è¿‡ç¨‹å¼ä¼šæ›´ç®€æ˜ä¸€äº›ã€‚ä½†åœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œå…¸å‹åœºæ™¯æ˜¯å‰åä¾èµ–çš„è¿ç»­ Ajax è¯·æ±‚ï¼Œéœ€è¦ä¸€å±‚å±‚åœ°åµŒå¥—æ‰§è¡Œï¼Œç®€ç›´å°±æ˜¯ Callback åœ°ç‹±ã€‚ç”±äºæ— æ³•æ§åˆ¶æ‰§è¡Œå’Œå®Œæˆçš„é¡ºåºï¼Œæ‰€ä»¥å°±æ— æ³•ä½¿ç”¨ä¼ ç»Ÿçš„è¿‡ç¨‹å¼å†™æ³•ï¼Œå‡½æ•°å¼å°±ä¼šå±•ç°å‡ºå…¶ä¼˜åŠ¿ã€‚

2012 å¹´ï¼Œå¾®è½¯ .NET å¼€å‘ç»„çš„ä¸€ä¸ªå›¢é˜Ÿä¸ºäº†ç»™ LinQ è®¾è®¡æ‰©å±•æœºåˆ¶è€Œå¼•å…¥äº† FRP æ¦‚å¿µï¼Œå´å‘ç° FRP çš„ä»·å€¼ä¸æ­¢äºæ­¤ã€‚äºæ˜¯ä¸€ä¸ªæ–°çš„é¡¹ç›®å‡ºç°äº†ï¼Œå®ƒå°±æ˜¯ ReactiveXï¼Œå¼‚æ­¥ç¼–ç¨‹ç¥å™¨ã€‚

ä¸¥æ ¼æ¥è¯´ ReactiveX åº”è¯¥æ˜¯ä¸€ç»„ FRP åº“ï¼Œå› ä¸ºå®ƒå‡ ä¹åœ¨æ¯ä¸ªä¸»æµè¯­è¨€ä¸‹éƒ½æä¾›äº†å®ç°ï¼Œè€Œä¸”è¿™äº›å®ç°éƒ½æ˜¯è¯­è¨€åŸç”Ÿé£æ ¼çš„ï¼Œä¸æ˜¯ç®€å•åœ°è¿ç§»ã€‚å¦‚æœä½ åœ¨ä»»ä½•è¯­è¨€ä¸‹ç”¨è¿‡å¸¦æœ‰ Rx å‰ç¼€çš„åº“ï¼Œé‚£å¤šåŠå„¿å°±æ˜¯ ReactiveX çš„ä¸€ä¸ªå®ç°äº†ï¼Œå¦‚ RxJavaã€Rx.NETã€RxGroovyã€RxSwift ç­‰ç­‰ã€‚

ReactiveX æœ¬èº«å…¶å®å¹¶ä¸éš¾ï¼Œéš¾çš„æ˜¯ FRP ç¼–ç¨‹èŒƒå¼ä»¥åŠå¯¹æ“ä½œç¬¦ operator çš„ç†è§£ã€‚æ‰€ä»¥ï¼Œåªè¦å­¦ä¼šäº† Rx æœºåˆ¶ï¼Œé‚£ä¹ˆå…¶å®ƒè¯­è¨€çš„åº“å°±å¯ä»¥è§¦ç±»æ—é€šäº†ã€‚

ä¸ºäº†å¸®åŠ©å¼€å‘è€…æ›´å®¹æ˜“åœ°ç†è§£ ReactiveX çš„å·¥ä½œåŸç†ï¼ŒReactiveX å¼€å‘ç»„è¿˜è®¾è®¡äº†ä¸€ç§å¾ˆå½¢è±¡çš„äº¤äº’å›¾ Marble Diagram å®çŸ³å›¾ï¼š

    Execution of input Observable from let to right
    ------(4)-------(6)---------(a)-------(8)-----|-->

    ================= multiply by 10 =================

    ------(4)-------(6)------------------------------>

ç®­å¤´çº¿è¡¨ç¤ºè¡¨ç¤ºæŒ‰æ—¶åºäº§ç”Ÿçš„æ•°æ®åºåˆ—ï¼Œç§°ä¸ºæ•°æ®æµ Streamï¼Œä¸Šæ–¹æ˜¯è¾“å…¥æµï¼Œä¸‹æ–¹æ˜¯è¾“å‡ºæµã€‚è¾“å…¥æµå¯èƒ½æœ‰å¤šä¸ªï¼Œä½†æ˜¯è¾“å‡ºæµåªä¼šæœ‰ä¸€ä¸ªï¼Œä¸è¿‡ï¼Œæµä¸­çš„æ¯ä¸ªæ•°æ®é¡¹ä¹Ÿå¯ä»¥æ˜¯åˆ«çš„æµã€‚

æ•°æ®åºåˆ—ä¸Šçš„æ¯ä¸ªåœ†åœˆä½çš„æ˜¯ä¸€ä¸ªä¸ªæ•°æ®é¡¹ï¼Œå…¶ä½ç½®å‡ºç°çš„å…ˆåé¡ºåºå…·æœ‰æ—¶åºæ€§ï¼Œå¦‚è¿›è¡Œ merge æ“ä½œæ—¶ï¼Œä¼šæŒ‰æ—¶åºé¡ºåºæ‹¼åˆæ•°æ®ã€‚ä½†æ˜¯ä¸€èˆ¬ä¸ä¼šè¡¨ç¤ºç²¾ç¡®çš„æ—¶é—´æ¯”ä¾‹ï¼Œæ¯”å¦‚åœ¨ä¸€æ¯«ç§’å†…æ¥è¿å‡ºç°çš„ä¸¤ä¸ªæ•°æ®ä¹‹é—´ä»ç„¶ä¼šæœ‰è¾ƒå¤§çš„è·ç¦»ã€‚åªæœ‰å°‘æ•°æ¶‰åŠåˆ°æ—¶é—´çš„æ“ä½œï¼Œå®çŸ³å›¾æ‰ä¼šè¡¨ç°å‡ºç²¾ç¡®çš„æ—¶é—´æ¯”ä¾‹ã€‚

çº¿æ¡å³ä¾§é€šå¸¸ä¼šæœ‰ä¸€æ¡ç«–çº¿è¡¨ç¤ºè¿™ä¸ªæµæ­£å¸¸ç»ˆæ­¢ï¼Œæˆ–è€…ä¸€ä¸ªå‰å·è¡¨ç¤ºè¿™ä¸ªæµæŠ›å‡ºé”™è¯¯å¯¼è‡´å¼‚å¸¸ä¸­æ­¢ã€‚è¿˜æœ‰ä¸€ç§æµï¼Œæ—¢æ²¡æœ‰ç«–çº¿ä¹Ÿæ²¡æœ‰å‰å·ï¼Œè¿™ç§å«åšæ— å°½æµï¼Œæ¯”å¦‚ä¸€ä¸ªç”±æ‰€æœ‰è‡ªç„¶æ•°ç»„æˆçš„æµå°±ä¸ä¼šä¸»åŠ¨ç»ˆæ­¢ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œæ— å°½æµä»ç„¶æ˜¯å¯ä»¥å¤„ç†çš„ï¼Œå› ä¸ºéœ€è¦å¤šå°‘é¡¹æ˜¯ç”±æ¶ˆè´¹è€…å†³å®šçš„ã€‚ä½ å¯ä»¥æŠŠè¿™ä¸ªæ™ºèƒ½ä¼ é€å¸¦ç†è§£ä¸ºç”±ä¸‹ä¸€ä¸ªå·¥åºï¼Œä¾æ¬¡å¤„ç†ã€‚

ä¸­é—´çš„å¤§æ¡†è¡¨ç¤ºä¸€ä¸ªæ“ä½œ operator å³ä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œçš„æ“ä½œå°±æ˜¯ä¹˜ 10ï¼Œå¹¶å°†ç»“æœå­˜æ”¾äºè¾“å‡ºæµä¸­ã€‚

çœ‹æ‡‚äº†å®çŸ³å›¾ï¼Œå°±èƒ½å¾ˆå½¢è±¡çš„ç†è§£å„ç§æ“ä½œç¬¦äº†ã€‚

RxJS å°±æ˜¯ ReactiveX åœ¨ JavaScript è¯­è¨€ä¸Šçš„å®ç°ã€‚ç”±äº JavaScript æœ¬èº«çš„ç¼ºé™·ï¼ŒRxJS ä¸å¾—ä¸é‡‡ç”¨äº†å¾ˆå¤šæ€ªå¼‚çš„å†™æ³•ï¼Œå®ƒå¯¹äº Java / C# ç­‰èƒŒæ™¯çš„ç¨‹åºå‘˜æ¥è¯´å¯èƒ½ä¼šæ˜¾å¾—æ¯”è¾ƒæ€ªå¼‚ã€‚

## ğŸ‘‰ Basic Concepts

RxJS çš„ä¸»è¦æ¦‚å¿µï¼š

- `Observable` å¯è§‚å¯Ÿå¯¹è±¡: ä¸€ä¸ªæœªæ¥å¯è°ƒç”¨çš„å€¼æˆ–äº‹ä»¶çš„é›†åˆã€‚
- `Observer` è§‚å¯Ÿè€…: ä¸€ä¸ªå›è°ƒå‡½æ•°çš„é›†åˆï¼Œç”¨å®ƒç›‘å¬ç”± Observable æä¾›çš„å€¼ã€‚
- `Subscription` è®¢é˜…: è¡¨ç¤º Observable çš„æ‰§è¡Œï¼Œä¸»è¦ç”¨äºå–æ¶ˆ Observable çš„æ‰§è¡Œã€‚
- `Operators` æ“ä½œç¬¦: é‡‡ç”¨å‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„çº¯å‡½æ•° Pure Functionï¼Œä½¿ç”¨åƒ mapã€filterã€concatã€flatMap ç­‰è¿™æ ·çš„æ“ä½œç¬¦æ¥å¤„ç†é›†åˆã€‚
- `Subject` ä¸»ä½“: ç›¸å½“äº EventEmitterï¼Œå¹¶ä¸”æ˜¯å°†å€¼æˆ–äº‹ä»¶å¤šè·¯æ¨é€ç»™å¤šä¸ª Observer çš„å”¯ä¸€æ–¹å¼ã€‚
- `Schedulers` è°ƒåº¦å™¨: ç”¨æ¥æ§åˆ¶å¹¶å‘å¹¶ä¸”æ˜¯ä¸­å¤®é›†æƒçš„è°ƒåº¦å‘˜ï¼Œå…è®¸æˆ‘ä»¬åœ¨å‘ç”Ÿè®¡ç®—æ—¶è¿›è¡Œåè°ƒï¼Œä¾‹å¦‚ setTimeout æˆ– requestAnimationFrame æˆ–å…¶ä»–ã€‚

RxJS ä¸­å«æœ‰ Observables ä¸ Observer ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œ`å¯è§‚å¯Ÿå¯¹è±¡`åŸºäºè§‚å¯Ÿè€…æ¨¡å¼å’Œè¿­ä»£å™¨æ¨¡å¼ï¼Œä»¥å‡½æ•°å¼ç¼–ç¨‹æ€ç»´æ¥å®ç°ã€‚Observables ä½œä¸ºè¢«è§‚å¯Ÿè€…ï¼Œæ˜¯ä¸€ä¸ªå€¼æˆ–äº‹ä»¶çš„æµé›†åˆï¼Œæ˜¯å¤šä¸ªå€¼çš„æƒ°æ€§æ¨é€é›†åˆã€‚è€Œ Observer åˆ™ä½œä¸ºè§‚å¯Ÿè€…ï¼Œæ ¹æ® Observables è¿›è¡Œå¤„ç†ã€‚

æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼Œé¦–å…ˆï¼Œæ•°æ®æ¥æºäº Creation operator  æ“ä½œç¬¦ï¼Œç›¸å½“äºå¯åŠ¨ç”Ÿäº§çº¿ï¼Œå¹¶æä¾›åŸæ–™ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸ªäº§ç”Ÿæ•°æ®çš„å‡½æ•°ã€‚ç„¶åï¼Œæ˜¯ç®¡é“æ“ä½œç¬¦ Pipeable operator éœ€è¦ä»æµæ°´çº¿æ‹¿åŸæ–™ï¼Œå°±ä¼šè°ƒç”¨ Creator æ•°æ®æ¥æºå‡½æ•°ã€‚RxJS æä¾›äº†å¾ˆå¤šé¢„å®šä¹‰çš„æ•°æ®æ¥æºï¼Œå½“ç„¶å¯ä»¥è‡ªå·±å®ç°è¿™ä¸ªæ•°æ®æºï¼Œä½†é€šå¸¸æ˜¯ä¸ç”¨çš„ã€‚

```js
// Creation operator 
import { of, fromEvent, merge } from 'rxjs';

// Pipeable operator 
import { map, filter, scan } from 'rxjs/operators';
```

å…ˆä¸Šæ‰‹å‡ ä¸ªå¸¸ç”¨çš„æ•°æ®ç”Ÿæˆå‡½æ•°ï¼Œç”Ÿæˆå™¨éƒ½ç”¨äºäº§ç”Ÿ Observable å¯¹è±¡ï¼š

- `of()` ç”¨äºåˆ›å»ºç®€å•çš„ Observableï¼Œåªå‘å‡ºç»™å®šçš„å‚æ•°ï¼Œåœ¨å‘é€å®Œè¿™äº›å‚æ•°åå‘å‡ºå®Œæˆé€šçŸ¥ã€‚
- `from()` ä»ä¸€ä¸ªæ•°ç»„ã€ç±»æ•°ç»„å¯¹è±¡ã€promiseã€è¿­ä»£å™¨å¯¹è±¡æˆ–è€… Observable å¯¹è±¡åˆ›å»ºä¸€ä¸ª Observableã€‚
- `fromEvent()` å°†äº‹ä»¶å¯¹è±¡ event è½¬æ¢æˆ Observableã€‚
- `range()` åœ¨æŒ‡å®šèµ·å§‹å€¼è¿”å›æŒ‡å®šåŒºé—´æ•°é‡æ•°å€¼ã€‚
- `interval()` åŸºäºç»™å®šæ—¶é—´é—´éš”å‘å‡ºæ•°å­—åºåˆ—ï¼Œæ— é™è‡ªå¢çš„åºåˆ—æ•´æ•°ï¼Œå¯ä»¥æŒ‡å®šæ—¶é—´é—´éš”ã€‚
- `timer()` åˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆå§‹å»¶æ—¶åŠŸèƒ½çš„ Observable å¯¹è±¡ï¼Œç»è¿‡æŒ‡å®šå»¶æ—¶ä¹‹åæ‰å¼€å§‹å‘é€æ•°æ®ï¼Œæ•°å€¼æŒ‰å›ºå®šå‘¨æœŸè‡ªå¢ã€‚

æ¥çœ‹çœ‹å®˜æ–¹ç¤ºèŒƒï¼Œä½¿ç”¨ map å°†äº‹ä»¶å¯¹è±¡ä¸­çš„åæ ‡ä½œä¸ºå¾…è§‚å¯Ÿçš„æ•°æ®å¯¹è±¡ï¼š

```js
import { fromEvent } from 'rxjs';
import { map } from 'rxjs/operators';

const clicks = fromEvent(document, 'click');
const positions = clicks.pipe(map(ev => ev.clientX));
positions.subscribe(x => console.log(x));
```

åœ¨ Taming snakes with reactive streams ä¸€æ–‡ä¸­ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä»¥å“åº”å¼æµç¼–ç¨‹å®ç°è´ªåƒè›‡æ¸¸æˆï¼Œä¹Ÿä½¿ç”¨äº† map æ¥å½±å°„é”®ç›˜æŒ‰é”®ä¸è¿åŠ¨æ–¹å‘é¢„è®¾æ•°æ®ã€‚

```ts
export interface Point2D {
  x: number;
  y: number;
}

export interface Directions {
  [key: number]: Point2D;
}

export const DIRECTIONS: Directions = {
  37: { x: -1, y: 0 }, // Left Arrow
  39: { x: 1, y: 0 },  // Right Arrow
  38: { x: 0, y: -1 }, // Up Arrow
  40: { x: 0, y: 1 }   // Down Arrow
};

export function nextDirection(previous, next) {
  let isOpposite = (previous: Point2D, next: Point2D) => {
    return next.x === previous.x * -1 || next.y === previous.y * -1;
  };

  if (isOpposite(previous, next)) {
    return previous;
  }

  return next;
}

let keydown$ = Observable.fromEvent(document, 'keydown');

let direction$ = keydown$
  .map((event: KeyboardEvent) => DIRECTIONS[event.keyCode])
  .filter(direction => !!direction)
  .scan(nextDirection)
  .startWith(INITIAL_DIRECTION)
  .distinctUntilChanged();
```


## ğŸ‘‰ Observer & Observable å¯¹è±¡

ä»ä»£ç ä¸Šçœ‹ï¼Œ`Observer` å¯¹è±¡å°±æ˜¯ä¸€ç³»åˆ—å‡½æ•°ï¼Œä¾› `Observable` å¯¹è±¡è°ƒç”¨ä»¥ä¼ é€’æ•°æ®ï¼Œåªéœ€è¦è°ƒç”¨ `subscribe()` æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼š

```ts
const observer = {
  next: x => console.log('Observer got a next value: ' + x),
  error: err => console.error('Observer got an error: ' + err),
  complete: () => console.log('Observer got a complete notification'),
};

observable.subscribe(observer);
```

å½“è°ƒç”¨ Observable çš„ subscribe æ–¹æ³•æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ªè®¢é˜… `Subscription` ç±»å‹å¼•ç”¨ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªè®¢é˜…å‡­è¯ã€‚æŠŠå®ƒä¿å­˜ä¸‹æ¥ï¼Œç­‰æ°å½“çš„æ—¶æœºè°ƒç”¨å®ƒçš„ unsubscribe æ–¹æ³•å°±å¯ä»¥å–æ¶ˆè®¢é˜…äº†ã€‚è®¢é˜…ä¹Ÿå«åš `Disposable`ï¼Œè¿™æ˜¯æ—§å¼ç§°è°“ã€‚

è§£é™¤å¯¹å›è°ƒå‡½æ•°çš„å¼•ç”¨æœ‰ä¸¤ç§æ—¶æœºï¼Œä¸€ç§æ˜¯æ•°æ®æµå®Œæˆ complete æ—¶è‡ªåŠ¨è§£é™¤ï¼ŒåŒ…æ‹¬æ­£å¸¸ç»“æŸå’Œå¼‚å¸¸ç»“æŸï¼Œå¦ä¸€ç§æ˜¯æ•°æ®è§‚å¯Ÿè€…ä¸»åŠ¨å–æ¶ˆã€‚æ‰€æœ‰çš„æœ‰é™æµéƒ½æ˜¯ä¼šè‡ªåŠ¨å®Œæˆçš„ï¼Œåªæœ‰æ— å°½æµæ‰éœ€è¦ç‰¹åˆ«å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è®¢é˜…æ–¹è¦ä¸»åŠ¨å–æ¶ˆè®¢é˜…ã€‚

è®¢é˜… `Observable` ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸º `next()` æ–¹æ³•ä½¿ç”¨ï¼š

    observable.subscribe(x => console.log('Observer got a next value: ' + x));

`Observables` æ˜¯ lazy Push æ•°æ®é›†ï¼Œä½¿ç”¨ä¸¤å¥—æ•°æ®æ”¶å‘æœºåˆ¶ Pull versus Pushï¼š

            SINGLE      MULTIPLE
    Pull    Function    Iterator
    Push    Promise     Observable

            PRODUCER    CONSUMER
    Pull    Passive: produces data when requested.  Active: decides when data is requested.
    Push    Active: produces data at its own pace.  Passive: reacts to received data.

åœ¨ Pull æ–¹å¼ä¸‹ï¼Œæ•°æ®ç”Ÿäº§æ˜¯è¢«åŠ¨çš„ï¼Œå³æ‰§è¡Œè®¢é˜…æ–¹æ³•æ—¶ç”Ÿäº§æ•°æ®ï¼Œè€Œæ•°æ®æ¶ˆè´¹æ˜¯ä¸»åŠ¨çš„ã€‚

åœ¨ Push æ–¹å¼ä¸‹ï¼Œæ•°æ®ç”Ÿäº§æ˜¯ä¸»åŠ¨çš„ï¼Œä¸»åŠ¨å‘è§‚å¯Ÿè€…æ¨é€æ•°æ®ï¼Œè€Œæ•°æ®æ¶ˆè´¹æ˜¯è¢«åŠ¨çš„ã€‚

æ¯ä¸ª JavaScript å‡½æ•°éƒ½æ˜¯ Pull æ–¹å¼ï¼Œç”±è°ƒç”¨è€…ä»å‡½æ•°è¿”å›å€¼æ‹‰å–æ•°æ® Pulling Dataã€‚ES2015 å¼•å…¥ç”Ÿæˆå™¨å‡½æ•°å’Œè¿­ä»£å™¨ generator & iteratorsï¼Œä¹Ÿæ˜¯æ˜¯ Pull çš„æ–¹å¼ï¼Œé€šè¿‡ `iterator.next()` æ‹‰å–æ•°æ®ã€‚

å…¸å‹çš„ Promises æ–¹æ¡ˆå°±æ˜¯ Push æ–¹å¼ï¼Œä¸€ä¸ª Promise ä¼šåœ¨å®Œæˆæ•°æ®ç”Ÿæˆåé€šè¿‡å·²ç»æ³¨å†Œå¥½çš„å›è°ƒå‡½æ•°ä¼ é€’æ•°æ®ç»™è§‚å¯Ÿè€…ã€‚

RxJS å¼•å…¥ Observables å¯¹è±¡ï¼Œä½œä¸ºä¸€å¥—æ–°çš„ Push å®ç°ï¼Œå®ƒç”Ÿäº§å¤šä¸ªæ•°æ®ï¼Œå¹¶æ¨é€ç»™æ•°æ®çš„è§‚å¯Ÿè€…ã€‚

å¯¹æ¯”å„ç§æ–¹å¼ï¼Œå¯ä»¥å‘ç° RxJS çš„å¯è§‚å¯Ÿæ•°æ®å¯¹è±¡æ˜¯æœ€çµæ´»çš„å®ç°ï¼š

- `Function` å»¶æ—¶è®¡ç®—åŒæ­¥è¿”å›å•ä¸€å€¼ï¼›
- `generator` å»¶æ—¶è®¡ç®—åŒæ­¥è¿”å›é›¶å€¼åˆ°å¯èƒ½çš„æ— é™è¿­ä»£å€¼ï¼›
- `Promise` æœ€ç»ˆå¯èƒ½è¿”å›ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰è¿”å›å€¼ã€‚
- `Observable` å»¶æ—¶è®¡ç®—ï¼Œå¹¶ä¸”å¯ä»¥å®ç°åŒæ­¥æˆ–å¼‚æ­¥è¿”å›é›¶å€¼åˆ°å¯èƒ½çš„æ— é™å€¼ï¼›


åˆ›å»º `Observable` å¯¹è±¡ï¼Œå®ƒæ‰§è¡Œçš„å°±æ˜¯é€»è¾‘å°±æ˜¯ä½¿ç”¨ `Observer` æä¾›çš„ä¸€å¥—å‡½æ•°æ¥ä¼ é€’æ•°æ®ï¼š

```ts
import { Observable } from 'rxjs';
 
const observable = new Observable(subscriber => {
  subscriber.next(1);
  subscriber.next(2);
  subscriber.next(3);
  setTimeout(() => {
    subscriber.next(4);
    subscriber.complete();
  }, 1000);
});
 
console.log('just before subscribe');
observable.subscribe({
  next(x) { console.log('got value ' + x); },
  error(err) { console.error('something wrong occurred: ' + err); },
  complete() { console.log('done'); }
});
console.log('just after subscribe');
```

ä»¥ä¸Šç¤ºèŒƒä»£ç è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

    just before subscribe
    got value 1
    got value 2
    got value 3
    just after subscribe
    got value 4
    done


æœ‰ä¸€ç±»ç‰¹æ®Šç±»å‹çš„ Observableï¼Œ`Subject` å®ƒå…è®¸å°†å€¼å¤šæ’­ç»™å¤šä¸ªè§‚å¯Ÿè€…ï¼Œè€Œæ™®é€šçš„ Observables æ˜¯å•æ’­çš„ï¼Œæ¯ä¸ªå·²è®¢é˜…çš„ Observable åªå‘å”¯ä¸€çš„è§‚å¯Ÿè€…æä¾›æ•°æ®ã€‚Subject è¿˜åƒæ˜¯ EventEmittersï¼Œç»´æŠ¤ç€å¤šä¸ªç›‘å¬å™¨çš„æ³¨å†Œè¡¨ã€‚

```js
import { from, Subject } from 'rxjs';
import { multicast } from 'rxjs/operators';
 
const source = from([1, 2, 3]);
const subject = new Subject();
const multicasted = source.pipe(multicast(subject));
 
// These are, under the hood, `subject.subscribe({...})`:
multicasted.subscribe({
  next: (v) => console.log(`observerA: ${v}`)
});
multicasted.subscribe({
  next: (v) => console.log(`observerB: ${v}`)
});
 
// This is, under the hood, `source.subscribe(subject)`:
multicasted.connect();
// source.subscribe(subject);
```

è¿˜æœ‰ä¸€äº›ç‰¹æ®Šç±»å‹çš„ Subjectï¼š

- `BehaviorSubject` æœ‰å½“å‰å€¼æ¦‚å¿µï¼Œå³ä¿å­˜å‘é€ç»™æ¶ˆè´¹è€…çš„æœ€æ–°å€¼ã€‚å¹¶ä¸”å½“æœ‰æ–°çš„è§‚å¯Ÿè€…è®¢é˜…æ—¶ï¼Œä¼šç«‹å³ä»å®ƒé‚£æ¥æ”¶åˆ°å½“å‰å€¼ã€‚
- `ReplaySubject` å›æ”¾æ•°æ®ç»™æ–°çš„è®¢é˜…è€…ï¼Œé™¤äº†ç¼“å†²æ•°é‡ï¼Œä½ è¿˜å¯ä»¥æŒ‡å®šè®°å½• window time æ¯«ç§’ä¹‹å‰çš„å€¼ã€‚
- `AsyncSubject` æ‰§è¡Œ `complete()` å®Œæˆæ—¶æ‰ä¼šå°†æœ€åä¸€ä¸ªå€¼å‘é€ç»™è§‚å¯Ÿè€…ã€‚




## ğŸ‘‰ Operators å„ç§æ“ä½œç¬¦
- https://rxjs.dev/guide/operators

æ‰€æœ‰æ“ä½œç¬¦éƒ½æ˜¯ Pipeable å‡½æ•°ï¼Œç®¡é“æ“ä½œç¬¦æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œå®ƒä»¥ä¸€ä¸ª Observable ä½œä¸ºè¾“å…¥å¹¶ç”Ÿæˆå¦ä¸€ä¸ª Observable ä½œä¸ºè¾“å‡ºã€‚è®¢é˜…äº†è¾“å‡ºçš„ Observable ä¹Ÿå°±å°†è®¢é˜…äº†è¾“å…¥çš„ Observableã€‚ 

æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼Œé¦–å…ˆï¼Œæ•°æ®æ¥æºäº Creation operator  æ•°æ®ç”Ÿæˆæ“ä½œç¬¦ï¼Œç›¸å½“äºå¯åŠ¨ç”Ÿäº§çº¿ï¼Œå¹¶æä¾›åŸæ–™ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸ªäº§ç”Ÿæ•°æ®çš„å‡½æ•°ã€‚ç„¶åï¼Œæ˜¯ç®¡é“æ“ä½œç¬¦ Pipeable operator éœ€è¦ä»æµæ°´çº¿æ‹¿åŸæ–™ï¼Œå°±ä¼šè°ƒç”¨ Creator æ•°æ®æ¥æºå‡½æ•°ã€‚

RxJS æä¾›äº†å¾ˆå¤šé¢„å®šä¹‰çš„æ•°æ®æ¥æºï¼Œå½“ç„¶å¯ä»¥è‡ªå·±å®ç°è¿™ä¸ªæ•°æ®æºï¼Œä½†é€šå¸¸æ˜¯ä¸ç”¨çš„ã€‚

æ“ä½œç¬¦å·åˆ†ç±»å‚è€ƒï¼š

    |     ç”Ÿæˆæ“ä½œ      |  è”åˆç”Ÿæˆæ“ä½œ  |   è½¬æ¢æ“ä½œ    |         è¿‡æ»¤æ“ä½œ        |
    |------------------|---------------|--------------|-------------------------|
    | ajax             | combineLatest | buffer       | audit                   |
    | bindCallback     | concat        | bufferCount  | auditTime               |
    | bindNodeCallback | forkJoin      | bufferTime   | debounce                |
    | defer            | merge         | bufferToggle | debounceTime            |
    | empty            | partition     | bufferWhen   | distinct                |
    | from             | race          | concatMap    | distinctKey             |
    | fromEvent        | zip           | concatMapTo  | distinctUntilChanged    |
    | fromEventPattern |               | exhaust      | distinctUntilKeyChanged |
    | generate         |               | exhaustMap   | elementAt               |
    | interval         |               | expand       | filter                  |
    | of               |               | groupBy      | first                   |
    | range            |               | map          | ignoreElements          |
    | throwError       |               | mapTo        | last                    |
    | timer            |               | mergeMap     | sample                  |
    | iif              |               | mergeMapTo   | sampleTime              |
    |                  |               | mergeScan    | single                  |
    |                  |               | pairwise     | skip                    |
    |                  |               | partition    | skipLast                |
    |                  |               | pluck        | skipUntil               |
    |                  |               | scan         | skipWhile               |
    |                  |               | switchMap    | take                    |
    |                  |               | switchMapTo  | takeLast                |
    |                  |               | window       | takeUntil               |
    |                  |               | windowCount  | takeWhile               |
    |                  |               | windowTime   | throttle                |
    |                  |               | windowToggle | throttleTime            |
    |                  |               | windowWhen   |                         |

    | æ•°å­¦ä¸èšåˆ  | æ¡ä»¶ä¸å¸ƒå°”æ“ä½œ  |    è”åˆæ“ä½œ     |     å¤šæ’­æ“ä½œ     |  é”™è¯¯å¤„ç†   |    å…¶å®ƒå·¥å…·   |
    |------------|----------------|----------------|-----------------|------------|---------------|
    | count      | defaultIfEmpty | combineAll     | multicast       | catchError | tap           |
    | max        | every          | concatAll      | publish         | retry      | delay         |
    | min        | find           | exhaust        | publishBehavior | retryWhen  | delayWhen     |
    | reduce     | findIndex      | mergeAll       | publishLast     |            | dematerialize |
    | isEmpty    | startWith      | publishReplay  | share           |            | materialize   |
    |            |                | withLatestFrom |                 |            | observeOn     |
    |            |                |                |                 |            | subscribeOn   |
    |            |                |                |                 |            | timeInterval  |
    |            |                |                |                 |            | timestamp     |
    |            |                |                |                 |            | timeout       |
    |            |                |                |                 |            | timeoutWith   |
    |            |                |                |                 |            | toArray       |
    |            |                |                |                 |            |               |


## ğŸ‘‰ Scheduler è°ƒåº¦å™¨
- https://rxjs.dev/guide/scheduler

è°ƒåº¦å™¨æ§åˆ¶ç€ä½•æ—¶å¯åŠ¨ Subscription ä»¥åŠä½•æ—¶å‘é€é€šçŸ¥ã€‚

å®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

- ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ ¹æ®ä¼˜å…ˆçº§æˆ–å…¶ä»–æ ‡å‡†æ¥å­˜å‚¨ä»»åŠ¡ï¼Œå¹¶å¯¹ä»»åŠ¡è¿›è¡Œæ’åºã€‚
- ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå®ƒè¡¨ç¤ºåœ¨ä½•æ—¶ä½•åœ°æ‰§è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚ç«‹å³æˆ–å›è°ƒå‡½æ•°ã€‚
- ä¸€ä¸ªè™šæ‹Ÿçš„æ—¶é’Ÿï¼Œé€šè¿‡è°ƒåº¦å™¨çš„ now() æä¾›äº†æ—¶é—´çš„æ¦‚å¿µï¼Œåœ¨å…·ä½“è°ƒåº¦å™¨ä¸Šå®‰æ’çš„ä»»åŠ¡å°†ä¸¥æ ¼éµå¾ªè¯¥æ—¶é’Ÿæ‰€è¡¨ç¤ºçš„æ—¶é—´ã€‚

è°ƒåº¦å™¨å¯ä»¥è®©ä½ è§„å®š Observable åœ¨ä»€ä¹ˆæ ·çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­å‘é€é€šçŸ¥ç»™å®ƒçš„è§‚å¯Ÿè€…ã€‚

å¼‚æ­¥è°ƒåº¦å™¨æ˜¯ RxJS å†…ç½®è°ƒåº¦å™¨ä¸­çš„ä¸€ä¸ªï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ Scheduler å¯¹è±¡çš„é™æ€å±æ€§åˆ›å»ºå¹¶è¿”å›å…¶ä¸­çš„æ¯ç§ç±»å‹çš„è°ƒåº¦å™¨ã€‚

- `null`    ä¸ä¼ é€’ä»»ä½•è°ƒåº¦å™¨çš„è¯ï¼Œä¼šä»¥åŒæ­¥é€’å½’çš„æ–¹å¼å‘é€é€šçŸ¥ï¼Œç”¨äºå®šæ—¶æ“ä½œæˆ–å°¾é€’å½’æ“ä½œã€‚
- `queueScheduler`  å½“å‰äº‹ä»¶å¸§ä¸­çš„é˜Ÿåˆ—è°ƒåº¦(è¹¦åºŠè°ƒåº¦å™¨)ï¼Œç”¨äºè¿­ä»£æ“ä½œã€‚
- `asapScheduler`   å¾®ä»»åŠ¡çš„é˜Ÿåˆ—è°ƒåº¦ï¼Œå®ƒä½¿ç”¨å¯ç”¨çš„æœ€å¿«é€Ÿçš„ä¼ è¾“æœºåˆ¶ï¼Œæ¯”å¦‚ Node.js çš„ process.nextTick() æˆ– Web Worker çš„ MessageChannel æˆ– setTimeout æˆ–å…¶ä»–ï¼Œç”¨äºå¼‚æ­¥è½¬æ¢ã€‚
- `asyncScheduler`  ä½¿ç”¨ setInterval çš„è°ƒåº¦ï¼Œç”¨äºåŸºäºæ—¶é—´çš„æ“ä½œç¬¦ã€‚
- `animationFrameScheduler` è®¡åˆ’å°†åœ¨ä¸‹ä¸€æ¬¡æµè§ˆå™¨å†…å®¹é‡æ–°ç»˜åˆ¶ä¹‹å‰å‘ç”Ÿçš„ä»»åŠ¡ï¼Œå¯ç”¨äºåˆ›å»ºæµç•…çš„æµè§ˆå™¨åŠ¨ç”»ã€‚

æ‰€æœ‰å¤„ç†å¹¶å‘çš„ Observable æ“ä½œç¬¦éƒ½æœ‰å¯é€‰çš„è°ƒåº¦å™¨ï¼Œæ²¡æœ‰æ˜¾å¼æŒ‡å®šè°ƒåº¦å™¨ç±»å‹çš„æƒ…å†µä¸‹ï¼ŒRxJS ä½¿ç”¨æœ€å°å¹¶å‘åŸåˆ™ï¼Œé€‰æ‹©ä¸€ä¸ªé»˜è®¤çš„è°ƒåº¦å™¨ã€‚è¿™å°±æ˜¯è¯´æœ€å°‘å¹¶å‘çš„è°ƒåº¦å™¨éœ€è¦å®‰å…¨çš„é€‰æ‹©æ“ä½œç¬¦ï¼Œä¾‹å¦‚ï¼Œè¿”å›ä¸€ä¸ªæœ‰é™å’Œå°‘é‡çš„ Observable çš„æ“ä½œç¬¦ï¼ŒRxJS ä¸ä½¿ç”¨è°ƒåº¦å™¨ï¼Œä¾‹å¦‚ null æˆ– undefinedã€‚

`observeOn()` åˆ›å»ºä½¿ç”¨æŒ‡å®šè°ƒåº¦å™¨çš„ Observable å¯¹è±¡ï¼Œå®ƒä½¿æ¯ä¸ª onNext è°ƒç”¨åœ¨æŒ‡å®šçš„ Scheduler ä¸­è¿è¡Œã€‚

`subscribeOn()` å¼ºåˆ¶åœ¨ç‰¹å®šçš„ Scheduler ä¸Šè¿è¡Œè®¢é˜…å’Œå–æ¶ˆè®¢é˜…ï¼Œè€Œä¸æ˜¯é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œå¹¶åœ¨è®¢é˜…è°ƒç”¨ä¸­æ‰§è¡Œé‡è¦å·¥ä½œæ—¶ï¼Œå´ä¸å¸Œæœ›ç”¨å®ƒæ¥é˜»æ­¢ UI çº¿ç¨‹ï¼ŒsubscribeOn éå¸¸æœ‰ç”¨ã€‚


ä»¥ä¸‹ç¤ºèŒƒåŒæ­¥åœ°ç”Ÿæˆç®€å•çš„ 1, 2, 3 æ•°æ®ï¼Œå¹¶ä½¿ç”¨ `observeOn` æ“ä½œæŒ‡å®šå¼‚æ­¥è°ƒåº¦å™¨æ¥åˆ†å‘è¿™æ­¤å€¼ï¼š

```ts
import { Observable, asyncScheduler } from 'rxjs';
import { observeOn } from 'rxjs/operators';
 
const observable = new Observable((proxyObserver) => {
  proxyObserver.next(1);
  proxyObserver.next(2);
  proxyObserver.next(3);
  proxyObserver.complete();
}).pipe(
  observeOn(asyncScheduler)
);
 
cosnt finalObserver = {
  next(x) {
    console.log('got value ' + x)
  },
  error(err) {
    console.error('something wrong occurred: ' + err);
  },
  complete() {
     console.log('done');
  }
};
 
console.log('just before subscribe');
observable.subscribe(finalObserver);
console.log('just after subscribe');
```

è¾“å‡ºå†…å®¹ï¼š

    just before subscribe
    just after subscribe
    got value 1
    got value 2
    got value 3
    done

View on Stackblitz https://stackblitz.com/edit/typescript-jexdny



# ğŸš© Prisma æ£±é•œæ•°æ®å±‚
- Quickstart (5 min) https://www.prisma.io/docs/getting-started/quickstart-typescript
- https://docs.nestjs.com/recipes/sql-typeorm
- https://docs.nestjs.com/recipes/prisma
- Prisma CLI https://www.prisma.io/docs/concepts/components/prisma-cli
- Prisma schema https://www.prisma.io/docs/concepts/components/prisma-schema
- Prisma Client https://www.prisma.io/docs/concepts/components/prisma-client
- ORM for TypeScript and JavaScript https://github.com/typeorm/typeorm
- Next-generation ORM for Node.js & TypeScript https://github.com/prisma/prisma
- Next-generation ORM for Node.js & TypeScript https://www.prisma.io/
- https://scotch.io/tutorials/get-started-w-prisma-for-super-simple-graphql

æ•°æ®åº“å·¥å…·å¦‚ ORM å’Œ SQL Builder éœ€è¦é¢å¯¹ä¸€ä¸ªåŸºæœ¬çš„é—®é¢˜ï¼šSQL è¯­æ³•æ§åˆ¶èƒ½åŠ›å’Œç”Ÿäº§åŠ›çš„å¹³è¡¡ã€‚è¿™ä¹Ÿæ˜¯ç°å­˜äº Node.js å’Œ TypeScript ç”Ÿæ€ç¯å¢ƒä¸­çš„æ•°æ®åº“å·¥å…·çš„ä¸»è¦é—®é¢˜ã€‚

Web åº”ç”¨çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ä¸å…³ç³»å‹æ•°æ®åº“æ‰“äº¤é“ï¼Œä½ å¯èƒ½éœ€è¦èŠ±è´¹æ•°å°æ—¶æ¥è°ƒè¯• SQL æŸ¥è¯¢è¯­å¥æˆ–è€…å¤æ‚çš„ ORM å¯¹è±¡æ¨¡å‹ã€‚

è‡ªå·±æ‰‹å†™ SQL ä½¿ç”¨æ•°æ®åº“é©±åŠ¨ API å½“ç„¶å¯ä»¥å®Œå…¨æ§åˆ¶æ•°æ®åº“æ“ä½œï¼Œä½†æ˜¯ï¼Œç”Ÿäº§åŠ›æä½ï¼Œè€Œä¸”ä¼šé‡åˆ°å¾ˆå¤šç»†ç¢çš„äº‹æƒ…ï¼Œå¦‚æ‰‹åŠ¨å¤„ç†é“¾æ¥ã€æ“ä½œæ¨¡æ¿ã€‚è€Œä½¿ç”¨ ORM å·¥å…·ï¼Œé¢ä¸´çš„é—®é¢˜å°±æ˜¯é€šè¿‡ä¸€å±‚å°è£…ï¼ŒSQL æ§åˆ¶åŠ›è¢«å‰Šå¼±ï¼Œéœ€è¦æ ¹æ® ORM è§„èŒƒæ„é€  SQLã€‚

ä½¿ç”¨ SQL Builder å¯ä»¥å®ç° SQL è¯­è¨€çš„å¼ºåŠ›æ§åˆ¶ï¼Œä½†ç”Ÿäº§åŠ›ä¸€èˆ¬ï¼Œå¦‚ knex.js è¿™ç§å·¥å…·ä¸ºæ„å»º SQL è¯­å¥æä¾›äº†å°è£…å±‚æ¬¡è¾ƒé«˜çš„ APIã€‚ä½†æœ€å¤§çš„é—®é¢˜åœ¨äºè¿™ç§å·¥å…·éœ€è¦å¼€å‘è€…ä» SQL çš„è§’åº¦æ¥å¯¹å¾…æ•°æ®ï¼Œæ•°æ®å¾€å¾€æ˜¯å…³ç³»å‹çš„å¯¹è±¡ï¼Œè¿™å°±ä¼šå¯¼è‡´äº†æ•°æ®åœ¨è®¤çŸ¥å±‚é¢ä¸å®é™…å±‚é¢çš„å·®å¼‚ï¼Œå¼€å‘è€…ä¸å¾—ä¸ç»å¸¸åˆ‡æ¢æ€ç»´æ¨¡å‹æ‰èƒ½å†™å¥½ SQL è¯­å¥ã€‚

å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœå¼€å‘è€…å¯¹ SQL çš„æŒæ¡å¦‚æœä¸å¤Ÿå¥½ï¼Œç»å¸¸ä¼šæ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šã€‚

ä½¿ç”¨ ORM å·¥å…·ï¼Œå¦‚ TypeORMï¼ŒTypeGoose åˆ™å¯ä»¥å®Œå…¨å°†äºŒç»´çš„å…³ç³»å‹æ•°æ®è½¬æ¢ä¸ºå¯¹è±¡æ¨¡å‹ï¼Œå¯ä»¥é«˜æ•ˆç‡çš„è¿›è¡Œå¼€å‘ï¼Œä½†æ˜¯å¯¹ SQL è¯­è¨€çš„æ§åˆ¶åŠ›å¤§å¤§æ¶ˆå¼±ã€‚

ä½¿ç”¨ ORM è¡¨é¢ä¸Šå¯ä»¥é€šè¿‡ç‚¹ç¬¦åˆæ¥è®¿é—®å¦ä¸€ä¸ªå®ä½“ï¼Œä½†æ˜¯ç§åº•ä¸‹å´ä¼šæ„é€  SQL JOIN è¯­å¥ï¼Œè¿™äº› JOIN æ˜¯æœ‰æ€§èƒ½é™·é˜±çš„ï¼Œå¾ˆå¯èƒ½æŠŠä½ çš„åº”ç”¨æ‹–å¾—å¾ˆæ…¢ï¼Œæ¯”å¦‚è‘—åçš„ n+1 é—®é¢˜ã€‚

æ€»ä¹‹ï¼ŒORMçš„ä¼˜ç‚¹æ˜¯æŠ½è±¡å‡ºå…³ç³»æ¨¡å‹å¹¶ä»…æ ¹æ®å¯¹è±¡æ¥æ“ä½œæ•°æ®ã€‚ä½†æ˜¯é—®é¢˜åœ¨äºï¼Œå…³ç³»å‹æ•°æ®è¡¨å¹¶ä¸èƒ½è½»æ¾åœ°æ˜ å°„åˆ°å¯¹è±¡ï¼Œè¿™ä¼šå¸¦æ¥å¾ˆå¤šå¤æ‚æ€§ï¼Œä»è€Œå¼•å‘é™·é˜±ã€‚

Prisma è‡ªç§°ä¸ºä¸‹ä¸€ä»£ ORMï¼Œä¸»è¦ç›®æ ‡å°±æ˜¯è®©å¼€å‘è€…åœ¨å¤„ç†æ•°æ®åº“æ˜¯æ›´å…·ç”Ÿäº§åŠ›ï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒPrisma åšå‡ºäº†ä»¥ä¸‹åŠªåŠ›ï¼š

- ç”¨å¯¹è±¡æ¥æ€è€ƒï¼Œè€Œä¸æ˜¯åœ¨å¤§è„‘ä¸­æ˜ å°„å…³ç³»å‹æ•°æ®åº“
- æŸ¥è¯¢ä¸æ˜¯ç±»ï¼Œä»¥é¿å…å¤æ‚çš„æ•°æ®æ¨¡å‹ï¼Œæä¾›ä¸€å¥—ç®€æ´çš„ APIï¼Œä½¿ä½ æ›´åŠ æ–¹ä¾¿åœ°æ“ä½œæ•°æ®åº“å’Œç†è§£æŸ¥è¯¢è¯­å¥ã€‚
- å•ä¸€çœŸç†æ¥æºï¼Œæ•°æ®åº“å’Œæ•°æ®æ¨¡å‹æ¥è‡ªåŒä¸€ä¸ªåœ°æ–¹
- å¥åº·çš„çº¦æŸï¼Œç”¨æ¥é˜²æ­¢å¸¸è§çš„é™·é˜±å’Œåæ¨¡å¼
- ä½¿åšæ­£ç¡®çš„äº‹æƒ…å˜å¾—å®¹æ˜“ï¼ˆâ€œæˆåŠŸä¹‹é“â€ï¼‰
- æŸ¥è¯¢ç»“æœç±»å‹å®‰å…¨ï¼Œè¿”å›çš„æ•°æ®æ˜¯ plain old JavaScript objectsã€‚
- å°‘ç”¨æ¨¡æ¿ï¼Œè¿™æ ·å¼€å‘è€…å¯ä»¥å…³æ³¨äºä¸šåŠ¡
- ç¼–è¾‘å™¨è‡ªåŠ¨è¡¥å…¨

åŒ…å«ä¸‰ä¸ªä¸»è¦æ¨¡å—ï¼Œå®‰è£… Prisma CLI åè·å–ï¼š

- `Prisma Client`: è‡ªåŠ¨ä¸º Node.js & TypeScript ç”Ÿæˆ Query Builderï¼Œå‘æ•°æ®æ‰§è¡ŒæŸ¥è¯¢ï¼›
- `Prisma Migrate`: å£°æ˜å¼æ•°æ®æ¨¡å‹ä¸è¿ç§»ç³»ç»Ÿï¼›
- `Prisma Studio`: æ•°æ®ç¼–è¾‘ GUI ç•Œé¢å·¥å…·ï¼Œéå¼€æºè½¯ä»¶ï¼›

Prisma Client å¯ä»¥ä¸ºåŸºäº Node.js or TypeScript çš„åç«¯åº”ç”¨æä¾›æ•°æ®å±‚æœåŠ¡ï¼ŒåŒ…æ‹¬ serverless æˆ– microservicesã€‚ä¾‹å¦‚ REST APIï¼ŒGraphQL API æˆ– gRPC API ç­‰ç­‰éœ€è¦æ•°æ®å±‚çš„åº”ç”¨ã€‚

é¦–å…ˆï¼Œéœ€è¦å®‰è£… Prisma ä»¥åŠå®¢æˆ·æ¨¡å—ï¼š

    $ npm install prisma -g
    $ npm install @prisma/client

    $ npx prisma studio -g

æ³¨æ„ï¼Œè¿™ä¸ªå®¢æˆ·æ¨¡å—è°ƒç”¨çš„æ˜¯ prisma generate å‘½ä»¤ç”Ÿæˆçš„ï¼Œè¯¥å‘½ä»¤è¯»å– schema.prisma æ•°æ®æ¨¡å‹æ–‡ä»¶å¹¶ç”Ÿæˆå®¢æˆ·æ¨¡å—ä»£ç ã€‚

- ç”Ÿæˆçš„å®¢æˆ·æ¨¡å—ä»£ç ä½äº `node_modules/.prisma/client` ç›®å½•ï¼›
- ç±»å‹å£°æ˜å±•å‡ºæ–‡ä»¶ `node_modules/@prisma/client/index.d.ts`ï¼›

æ›´æ”¹æ•°æ®æ¨¡å‹åï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°ç”Ÿæˆ Prisma Clientï¼Œä»¥ç¡®ä¿å®¢æˆ·æ¨¡å—ä»£ç å¾—åˆ°æ›´æ–°ï¼š

    $ prisma generate

Prisma åªéœ€ç»´æŠ¤ä¸€ä»½ `schema.prisma` æ•°æ®æ¨¡å‹æ–‡ä»¶ï¼Œæ¯æ¬¡æ‰§è¡Œè¿ç§»æŒ‡ä»¤å°±ä¼šå®Œæˆæ•°æ®åº“çš„ç»“æ„æ›´æ–°ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ç»„ migration æ–‡ä»¶ï¼ŒåŒ…æ‹¬æœ¬æ¬¡çš„å˜æ›´åçš„æ•°æ®åº“ç‰ˆæœ¬ï¼ŒåŠå˜æ›´ä¹‹å¤„ã€‚

åœ¨æ•°æ®æ¨¡å‹æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹ä¸‰éƒ¨åˆ†å†…å®¹ï¼š

- Data source æ•°æ®åº“è¿æ¥ï¼›
- Generator ç”Ÿæˆå™¨ç”¨æ¥è‡ªåŠ¨ç”Ÿæˆ Prisma Clientï¼›
- Data model æ•°æ®æ¨¡å‹å®šä¹‰åº”ç”¨ä¸­æ•°æ®æ¨¡å‹ï¼›

ä»¥ä¸‹æ˜¯æ•°æ®æ¨¡å‹æ–‡ä»¶å‚è€ƒï¼š

```js
// Data source
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Generator
generator client {
  provider = "prisma-client-js"
}

// Data model
model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User?   @relation(fields:  [authorId], references: [id])
  authorId  Int?
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  posts Post[]
}
```

Prisma CLI ä¼šæŒ‰ä»¥ä¸‹é…ç½®æŸ¥æ‰¾æ•°æ®æ¨¡å‹æ–‡ä»¶ï¼š

- æ‰§è¡Œ introspect, generate, migrate ç­‰å‘½ä»¤æ—¶ï¼Œé€šè¿‡ --schema å‚æ•°æŒ‡å®šçš„ä½ç½®ï¼›

        prisma generate --schema=./alternative/schema.prisma 

- åœ¨å·¥ç¨‹é…ç½®æ–‡ä»¶ package.json æŒ‡å®šçš„ä½ç½®ï¼š

        "prisma": {
            "schema": "db/schema.prisma"
        }

- é»˜è®¤ä½ç½®ï¼š

        ./prisma/schema.prisma
        ./schema.prisma

Prisma æ˜¯å°†æ•°æ®åº“è½¬æ¢ä¸ºGraphQL APIçš„æ•°æ®å±‚ã€‚ æˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºä¸€ç§ORMï¼Œä½†å®ƒæ¯”ä¼ ç»Ÿçš„ORMå¼ºå¤§å¾—å¤šã€‚ ä½¿ç”¨Prismaï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆPrismaæœåŠ¡å™¨ï¼‰ä½œä¸ºæ•°æ®åº“çš„ä»£ç†ï¼Œå¹¶åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œé«˜æ€§èƒ½æŸ¥è¯¢å¼•æ“ï¼Œè¯¥å¼•æ“ä¸ºæˆ‘ä»¬ç”Ÿæˆå®é™…çš„æ•°æ®åº“æŸ¥è¯¢ã€‚ é™¤è¿™äº›ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜è·å¾—äº†ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆPrismaå®¢æˆ·ç«¯ï¼‰ï¼Œå¯ç”¨äºä¸æœåŠ¡å™¨äº¤äº’ã€‚ Prismaè¿˜å‘æˆ‘ä»¬çš„æ•°æ®åº“æ·»åŠ äº†å®æ—¶äº‹ä»¶ç³»ç»Ÿï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å®æ—¶è®¢é˜…æ•°æ®åº“äº‹ä»¶ã€‚


ä½¿ç”¨ Prisma åˆ›å»ºæ–°æ•°æ®åº“åŸºæœ¬æ­¥éª¤ï¼š

- åˆ›å»ºä¸€ä¸ªæ–°çš„ Prisma æœåŠ¡ï¼›
- è®¾ç½® Prisma å¹¶ä¸æ•°æ®åº“è¿æ¥ï¼›
- å®šä¹‰æ•°æ®æ¨¡å‹ï¼›
- éƒ¨ç½² Prisma APIï¼›
- ç”Ÿæˆ Prisma clientï¼›
- åˆ›å»º GraphQL æœåŠ¡å™¨ä»¥ä½¿ç”¨ Prisma client å‘æ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢ï¼›

åœ¨ç°æœ‰æ•°æ®åº“ä¸­ä½¿ç”¨ Prisma çš„åŸºæœ¬æ­¥éª¤ï¼š

- åˆ›å»ºä¸€ä¸ª Prisma æœåŠ¡ï¼›
- ä½¿ç”¨ Prisma Docker æ˜ åƒè®¾ç½® Prisma ä¸ç°æœ‰æ•°æ®åº“è¿æ¥ï¼›
- ä¸ºæ•°æ®åº“æ¶æ„ç”Ÿæˆå¯¹åº”æ•°æ®æ¨¡å‹ï¼›
- éƒ¨ç½² Prisma APIï¼›
- ç”Ÿæˆ Prisma clientï¼›
- åˆ›å»º GraphQL æœåŠ¡å™¨ä»¥ä½¿ç”¨ Prisma client å‘æ•°æ®åº“æŒªæŸ¥è¯¢ï¼›


ä½¿ç”¨ Prisma Client æ‰§è¡Œæ•°æ®æŸ¥è¯¢ï¼Œæ ¹æ®ä¸åŒçš„ä»£ç è¿è¡Œç¯å¢ƒï¼Œé€‰æ‹©æ¨¡å—ç›¸åº”çš„å¯¼å…¥æ–¹å¼ï¼š

```js
// ESM
import { PrismaClient } from '@prisma/client'

// Node.js CommonJS
const { PrismaClient } = require('@prisma/client')

const prisma = new PrismaClient()

// run inside `async` function
const newUser = await prisma.user.create({
  data: {
    name: 'Alice',
    email: 'alice@prisma.io',
  },
})
const users = await prisma.user.findMany()
```
