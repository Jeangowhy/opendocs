
# =ğŸš© 10 Best C# Books 
- [10 Best C# Books](http://www.developersfeed.com/10-best-c-books-to-learn-programming/)
- [C# 3.0 Cookbook, Third Edition](https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2008/ff518995(v=orm.10))

- C# 5.0 in a Nutshell: The Definitive Reference
- Head First C#
- Pro C# 5.0 and the .NET 4.5 Framework (Expertâ€™s Voice in .NET)
- C# in Depth, 4th Edition https://csharpindepth.com

        Table of Contents (4th edition)
        Part 1: C# in context
        1: Survival of the sharpest
        Part 2: C# 2-5
        2: C# 2
        3: C# 3: LINQ and everything that comes with it
        4: C# 4: Improving interoperability
        5: Writing asynchronous code
        6: Async implementation
        7: C# 5 bonus features
        Part 3: C# 6
        8: Super-sleek properties and expression-bodied members
        9: Stringy features
        10: A smÃ¶rgÃ¥sbord of features for concise code
        Part 4: C# 7 and beyond
        11: Composition using tuples
        12: Deconstruction and pattern matching
        13: Improving efficiency with more pass by reference
        14: Concise code in C# 7
        15: C# 8 and beyond
        Appendix: Language features by version

- Programming C# 5.0: Building Windows 8, Web, and Desktop Applications for the .NET 4.5 Framework
- Adaptive Code via C#: Agile coding with design patterns and SOLID principles (Developer Reference)
- C# 5.0 Unleashed
- The C# Playerâ€™s Guide
- MCSD Certification Toolkit (Exam 70-483): Programming in C#
- Murachâ€™s C# 2012

# =ğŸš© Getting Started

å‚è€ƒæ–‡æ¡£ï¼š

- https://dotnet.microsoft.com/
- https://docs.microsoft.com/en-us/dotnet/core
- https://docs.microsoft.com/zh-cn/dotnet/api/
- https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-8
- https://docs.microsoft.com/en-us/dotnet/core/install/linux-package-manager-ubuntu-1804
- https://docs.microsoft.com/en-us/dotnet/core/install/linux-package-manager-debian10
- https://docs.microsoft.com/en-us/dotnet/core/additional-tools/uninstall-tool?tabs=windows
- http://docs.libuv.org/en/v1.x/design.html

.Net Core é¡¹ç›®å¼€æºåœ°å€ï¼š

- https://github.com/dotnet/runtime
- https://github.com/dotnet/corefx
- https://github.com/dotnet/coreclr
- https://github.com/dotnet/efcore
- https://github.com/dotnet/blazor
- https://github.com/dotnet/aspnetcore
- https://github.com/aspnet
- https://github.com/aspnet/EntityFrameworkCore
- https://github.com/aspnet/Configuration
- https://github.com/aspnet/Routing
- https://github.com/aspnet/Security
- https://github.com/aspnet/DependencyInjection
- https://github.com/aspnet/HttpAbstractions
- https://github.com/aspnet/Options
- https://github.com/aspnet/Mvc
- https://github.com/aspnet/Hosting
- https://github.com/aspnet/razor
- https://source.dot.net/

- .NET Core 2.0 https://dotnet.microsoft.com/en-us/download/dotnet/2.0
- .Net Standard https://docs.microsoft.com/en-us/dotnet/standard/net-standard
- .Net Standard Interactive Table https://dotnet.microsoft.com/en-us/platform/dotnet-standard
- Target frameworks in SDK-style projects https://docs.microsoft.com/en-us/dotnet/standard/frameworks

å…ˆè¦åˆ†æ¸…è§„èŒƒå’Œæ¡†æ¶è¿™ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œ.NET Standard æ˜¯ä¸€å¥—æŠ€æœ¯è§„èŒƒï¼Œ.NET Framework æ˜¯ä¸€ä¸ªå®ç°è§„èŒƒçš„æŠ€æœ¯æ¡†æ¶ï¼Œéµå®ˆè¿™å¥—è§„èŒƒçš„ç±»åº“å¯ä»¥è¢«ä¸åŒ .NET æ¡†æ¶å¼•ç”¨ï¼Œæ¯”å¦‚ .NET Core é¡¹ç›®å’Œ .NET Framework é¡¹ç›®éƒ½å¯ä»¥å¼•ç”¨è¿™ä¸ªç±»åº“ã€‚

.NET Standard è§„èŒƒä» 2000 å¹´ 11 æœˆå¼€å§‹å‘å¸ƒç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå‘å±•åˆ°ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ .Net Standard 2.1ï¼Œä¸­é—´ç»è¿‡ 1.0ã€1.1ã€1.2ã€1.3ã€1.4ã€1.5ã€1.6ã€2.0ã€2.1 ç‰ˆæœ¬å·ã€‚

ä»¥ä¸‹æ˜¯æ ¹æ® .Net Standard Interactive Table åˆ¶ä½œçš„ .NET è§„èŒƒä¸å®ç°æ¡†æ¶æˆ–å·¥å…·ä¹‹é—´çš„ç‰ˆæœ¬å…³ç³»ï¼š

|    .NET implementation     | .Net Standard 2.0 | .Net Standard 2.1  |
|----------------------------|-------------------|--------------------|
| .NET and .NET Core         | 2.0, 2.1, 2.2,    | 3.0, 3.1, 5.0, 6.0 |
| .NET Framework             | 4.6.1 ~  4.8      |                    |
| Mono                       | 5.4               | 6.4                |
| Xamarin.iOS                | 10.14             | 12.16              |
| Xamarin.Mac                | 3.8               | 5.16               |
| Xamarin.Android            | 8.0               | 10.0               |
| Universal Windows Platform | 10.0.16299        | TBD                |
| Unity                      | 2018.1            |                    |

æ³¨æ„ï¼Œ.NET Core 3.1 ç‰ˆæœ¬åé¢ç‰ˆæœ¬å·ç›´æ¥ä½¿ç”¨ .NET 5 è¿™æ ·çš„è¡¨è¾¾ï¼Œæ›´æ”¹ç‰ˆæœ¬å·åŸºäºä»¥ä¸‹ä¸¤ä¸ªåŸå› :

- è·³è¿‡ 4.x ç‰ˆæœ¬å·ä»¥é¿å…æ··æ·† .NET Framework 4.xã€‚
- ç§»é™¤ "Core" è¿™ä¸ªç‰ˆæœ¬å·çš„åå­—å¼ºè°ƒè¿™æ˜¯ .NET çš„ä¸»è¦å®ç°åœ¨æ›´è¿›ï¼Œæ›´å¤šå¹³å°çš„åº”ç”¨ç±»å‹åœ¨ .NET 5 å¼•å…¥ã€‚

å¦å¤–ï¼ŒASP.NET Core 5.0 ä¿ç•™äº† "Core" ç‰ˆæœ¬å·ä»¥é¿å…å’Œ ASP.NET MVC 5 æ··æ·†ï¼Œç±»ä¼¼çš„å…³ç³»è¿˜æœ‰ Entity Framework Core 5.0 ä¸ç›¸å¯¹çš„ Entity Framework 5 æˆ– 6ã€‚

éšç€ .Net Core ç‰ˆæœ¬å·çš„æ›´æ”¹ï¼Œå•ç‹¬ä½¿ç”¨ .NET è¿™ä¸ªåè¯æŒ‡ä»£ .Net Coreã€‚

ç»§ .NET Framework åï¼Œå¾®è½¯å‘è¡Œç²¾ç®€ç‰ˆçš„ .NET Core ä½¿å¾— C# æˆä¸ºè·¨å¹³å°å¼€å‘è¯­è¨€çš„é¦–å…ˆä¹‹ä¸€ï¼Œå®ƒå¸¦æ¥çš„æ–°è¯­è¨€ç‰¹æ€§æ”¹è¿›äº† C++/Java çš„ä¸€äº›ç¼ºç‚¹ã€‚.NET Core æ˜¯ä¸€ä¸ªæ–°çš„å¼€æºå¹¶ä¸”è·¨å¹³å°çš„ç”¨æ¥æ„å»ºå¯ä»¥æ‰€æœ‰æ“ä½œç³»ç»Ÿï¼ŒåŒ…æ‹¬ Windows, Mac, and Linux ä¸Šé¢è¿è¡Œçš„åº”ç”¨çš„çš„æ¡†æ¶ã€‚ç‰¹æ€§åŒ…æ‹¬å¼€æºã€è·¨å¹³å°ã€ç°ä»£ã€çµæ´»ã€è½»é‡çº§ã€å¿«é€Ÿã€å‹å¥½ã€å¯å…±äº«ï¼Œä»¥åŠä¸ºæœªæ¥çš„è½¯ä»¶å¼€å‘è€Œæ„å»ºçš„ã€‚

æ–°å¼ .NET æ”¯æŒå¤šä¸ªæ“ä½œç³»ç»Ÿå’Œè®¾å¤‡ï¼Œå¼€æºåº“æ”¯æŒå°½å¯èƒ½å¤šçš„å¼€å‘äººå‘˜ï¼Œæ— è®ºæ˜¯æ„å»º Azure ä¸­æ‰˜ç®¡çš„ ASP.NET ç½‘ç«™çš„å¼€å‘äººå‘˜ï¼Œè¿˜æ˜¯åœ¨ Unity ä¸­å¼€å‘ .NET æ¸¸æˆçš„å¼€å‘äººå‘˜ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚

ä¸€å¥— .NET å®ç°éœ€è¦åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š

âœ… ä¸€ä¸ªæˆ–å¤šä¸ªè¿è¡Œæ—¶æ”¯æŒï¼Œä¾‹å¦‚ CLR, CoreRTï¼›
âœ… ä¸€å¥— .NET Standard ç±»åº“ï¼Œä¾‹å¦‚ .NET Framework å’Œ .NET 5 è¿˜æœ‰ .NET Core å…±ç”¨çš„ BCLs - Basic Class Libraryï¼›
âœ… å…¶å®ƒå¯é€‰çš„åº”ç”¨æ¡†æ¶ï¼Œä¾‹å¦‚ .NET Framework å’Œ .NET 5+ åŒ…å«çš„ ASP.NET, Windows Forms, WPF ç­‰åº”ç”¨æ¡†æ¶ï¼›
âœ… å…¶å®ƒå¯é€‰çš„å¼€å‘å·¥å…·ï¼›

ç°æœ‰çš„ .NET å®ç°æ¡†æ¶ä¸»è¦æœ‰ä»¥ä¸‹å››ä¸ªï¼š

âœ… .NET Framework
âœ… .NET 5 (and .NET Core) and later versions
âœ… Universal Windows Platform (UWP)
âœ… Mono (open source, cross-platform)

å‰é¢ä¸¤ç§ .NET å®ç°å¯ç”¨äºç”ŸæˆæœåŠ¡å™¨ç«¯åº”ç”¨ï¼š.NET Framework å’Œ .NET Core ä¸¤è€…å…±äº«è®¸å¤šç›¸åŒçš„ç»„ä»¶ï¼Œå¯åœ¨å®ƒä»¬ä¹‹é—´å…±äº«ä»£ç ã€‚ ä½†ä¸¤è€…ä¹‹é—´å­˜åœ¨æ ¹æœ¬çš„å·®å¼‚ï¼Œå¯æ ¹æ®éœ€è¦å®ç°çš„ç›®æ ‡è¿›è¡Œé€‰æ‹©ã€‚ 

.NET Core åŒ…å« ASP.NET Coreï¼Œå®ƒæ˜¯ ASP.NET 4.x çš„é‡æ–°è®¾è®¡ï¼Œæ¯”è¾ƒå¦‚ä¸‹ï¼š

ASP.NET Coreï¼š

- é’ˆå¯¹ Windowsã€macOSã€Linux è¿›è¡Œç”Ÿæˆã€‚
- Razor Pages æ˜¯åœ¨ ASP.NET Core 2.x åŠæ›´é«˜ç‰ˆæœ¬ä¸­åˆ›å»º Web UI æ—¶å»ºè®®ä½¿ç”¨çš„æ–¹æ³•ã€‚ MVCã€Web API å’Œ SignalRã€‚
- æ¯ä¸ªè®¡ç®—æœºå¤šä¸ªç‰ˆæœ¬ã€‚
- ä½¿ç”¨ C# æˆ– F# é€šè¿‡ VS æˆ– VSCode è¿›è¡Œå¼€å‘ã€‚
- æ¯” ASP.NET 4.x æ€§èƒ½æ›´é«˜ã€‚
- ä½¿ç”¨ .NET Core è¿è¡Œæ—¶ã€‚

ASP.NET 4.xï¼š

- é’ˆå¯¹ Windows è¿›è¡Œç”Ÿæˆã€‚
- ä½¿ç”¨ Web Formsã€SignalRã€MVCã€Web APIã€WebHook æˆ–ç½‘é¡µã€‚
- æ¯ä¸ªè®¡ç®—æœºä¸€ä¸ªç‰ˆæœ¬ã€‚
- ä½¿ç”¨ C#ã€VB æˆ– F# é€šè¿‡ VS è¿›è¡Œå¼€å‘ã€‚
- è‰¯å¥½çš„æ€§èƒ½ã€‚
- ä½¿ç”¨ .NET Framework è¿è¡Œæ—¶ã€‚

.NET Core æ˜¯ç”± Microsoft å¼€å‘ï¼Œç›®å‰åœ¨ .NET Foundation éè¥åˆ©å¼€æºç»„ç»‡ç®¡ç†ã€‚.NET Core æ˜¯ç”¨ C# å’Œ C++ ç¼–å†™çš„ï¼Œå¹¶é‡‡ç”¨ MIT åè®®ä½œä¸ºå¼€æºåè®®ã€‚ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ .NET Core 1.0 æ˜¯åœ¨ 2016 å¹´å‘å¸ƒçš„ï¼ŒåŠŸèƒ½æœ‰é™ã€‚NET Core 2.0 äº 2017å¹´8æœˆ14æ—¥å‘å¸ƒï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­å‘å¸ƒçš„ä¸¤ä¸ªæ ¸å¿ƒæ¡†æ¶æ˜¯ ASP.NET Core 2.0 å’Œ Entity Framework Core 2.0ã€‚

.NET Core çš„å½“å‰ç‰ˆæœ¬ä¸º 2.1 LTS/3.1 LTSï¼Œæ”¯æŒæœ€æ–°çš„ C# 8.0ï¼Œä»¥ä¸‹æ˜¯ .NET Core 3.0 ä¸­çš„å…¶ä»–åŠŸèƒ½å’Œå¢å¼ºåŠŸèƒ½åˆ—è¡¨ï¼Œ

- Windows æ¡Œé¢çš„ MSIX éƒ¨ç½²
- MSIX æ˜¯ä¸€ç§æ–°çš„ Windows åº”ç”¨ç¨‹åºåŒ…æ ¼å¼ã€‚å®ƒå¯ç”¨äºå°† .NET Core 3.0 æ¡Œé¢åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Windows 10ã€‚
- å¿«é€Ÿå†…ç½® JSONæ”¯ æŒ
- IEEE æµ®ç‚¹æ”¹è¿›
- .NET å¹³å°ä¾èµ–å†…åœ¨å‡½æ•°
- ä¾èµ–äºæ¡†æ¶çš„å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒ
- æ„å»ºå‰¯æœ¬ä¾èµ–é¡¹
- è£…é…å¸è½½
- Windows Native Interop
- Linux ä¸Šçš„ TLS 1.3 å’Œ OpenSSL 1.1.1
- æ”¹è¿›çš„å¯†ç å­¦
- é€‚ç”¨äº Linux çš„ SerialPort
- ARM64 Linux æ”¯æŒ
- GPIO æ”¯æŒ Raspberry Pi

åœ¨å¼€å‘ç¨‹åºæ—¶ï¼Œåœ¨å·¥ç¨‹ä¸­æŒ‡å®š TargetFramework å°±æ˜¯é€‰æ‹©ä¸€ä¸ª Target Framework Moniker (TFM)ï¼Œå°±è¡¨ç¤ºåŸºäºé€‰æ‹©çš„è¿™å¥— API è¿›è¡Œç¨‹åºçš„å¼€å‘ã€‚

æ ¹æ®åº”ç”¨ç±»å‹çš„ä¸åŒï¼Œéœ€è¦ä½¿ç”¨çš„ TFM ä¹Ÿä¸åŒï¼Œå‚è€ƒå¦‚ä¸‹ï¼Œæ–¹æ‹¬å·è¡¨ç¤ºç­‰ä»·ï¼Œå¦‚ `win81` ç­‰ä»· TFM æ˜¯ `netcore451`ï¼š

| Target Framework            | TFM                                                             |
|-----------------------------|-----------------------------------------------------------------|
| .NET 5+ (and .NET Core)     | netcoreapp1.0  netcoreapp1.1                                    |
|                             | netcoreapp2.0  netcoreapp2.1  netcoreapp2.2                     |
|                             | netcoreapp3.0  netcoreapp3.1                                    |
|                             | net5.0*        net6.0*                                          |
|-----------------------------|-----------------------------------------------------------------|
| .NET Standard               | netstandard1.0                                                  |
|                             | netstandard1.1  netstandard1.2  netstandard1.3                  |
|                             | netstandard1.4  netstandard1.5  netstandard1.6                  |
|                             | netstandard2.0  netstandard2.1                                  |
|-----------------------------|-----------------------------------------------------------------|
| .NET Framework              | net11  net20   net35  net40  net403  net45  net451  net452      |
|                             | net46  net461  net462 net47  net471  net472  net48              |
|-----------------------------|-----------------------------------------------------------------|
| Windows Store               | netcore [netcore45], netcore45 [win] [win8], netcore451 [win81] |
|-----------------------------|-----------------------------------------------------------------|
| .NET Micro Framework        | netmf                                                           |
|-----------------------------|-----------------------------------------------------------------|
| Silverlight                 | sl4, sl5                                                        |
|-----------------------------|-----------------------------------------------------------------|
| Windows Phone               | wp [wp7], wp7, wp75, wp8, wp81, wpa81                           |
|-----------------------------|-----------------------------------------------------------------|
| Universal Windows Platform  | uap [uap10.0], uap10.0 [win10] [netcore50]                      |

æœ€æ–°ç‰ˆæœ¬åŠ å…¥äº† .NET 5+ OS-specific TFMsï¼Œå¯ä»¥åœ¨ `net5.0` and `net6.0` TFMs ä¸­æŒ‡å®šä¸åŒçš„ç³»ç»Ÿå¹³å°ï¼Œ*OS-specific TFM* å¯ç”¨å¹³å°ç›¸å…³çš„ APIsï¼Œæ¯”å¦‚ï¼ŒWindows Forms æˆ– iOS ç»‘å®šï¼Œå¹¶ä¸”ä¼šç»§æ‰¿åŸºç¡€ APIã€‚

ä¸‹è¡¨æ˜¾ç¤º .NET 5+ TFMs å…¼å®¹æ€§ï¼Œ.NET 5 å¼•å…¥äº† `net5.0-windows` OS-specific TFMï¼Œè¿™ä¸ªç›®æ ‡æ¡†æ¶ç»‘å®š WinForms, WPF, UWP APIsã€‚

|        TFM         |                         Compatible with                         |
|--------------------|-----------------------------------------------------------------|
| net5.0             | net1..4, netcoreapp1..3.1, netstandard1..2.1                    |
| net5.0-windows     | netcoreapp1..3.1 (plus everything else inherited from `net5.0`) |
| net6.0             | (subsequent version of `net5.0`)                                |
| net6.0-android     | `xamarin.android` (+everything else inherited from `net6.0`)    |
| net6.0-ios         | `xamarin.ios` (+everything else inherited from `net6.0`)        |
| net6.0-macos       | `xamarin.mac` (+everything else inherited from `net6.0`)        |
| net6.0-maccatalyst | `xamarin.ios` (+everything else inherited from `net6.0`)        |
| net6.0-tvos        | `xamarin.tvos` (+everything else inherited from `net6.0`)       |
| net6.0-windows     | (subsequent version of `net5.0-windows`)                        |

ä»¥ä¸‹æ˜¯å¼ƒç”¨çš„ target frameworksï¼Œä½¿ç”¨æ–°çš„æ›¿ä»£ç›®æ ‡æ¡†æ¶ï¼š

|                             Deprecated TFM                            | Replacement |
|-----------------------------------------------------------------------|-------------|
| aspnet50 aspnetcore50 dnxcore50 dnx dnx45 dnx451 dnx452               | netcoreapp  |
| dotnet dotnet50 dotnet51 dotnet52 dotnet53 dotnet54 dotnet55 dotnet56 | netstandard |
| netcore50                                                             | uap10.0     |
| win                                                                   | netcore45   |
| win8                                                                  | netcore45   |
| win81                                                                 | netcore451  |
| win10                                                                 | uap10.0     |
| winrt                                                                 | netcore45   |

å…¶å®ƒç›®æ ‡æ¡†æ¶ç›¸å…³çš„é¢„å¤„ç†ç¬¦å·å®šä¹‰å‚è€ƒæ–‡æ¡£ dotnet-docs\docs\standard\frameworks.md


ä¸ºäº†è®©ä½¿ç”¨è€…ä¸å¿…é’ˆå¯¹å„ä¸ªæ¡†æ¶æ„å»ºï¼Œåº”è¯¥å°½é‡è·å– .NET Standard è¾“å‡ºä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šäºæ¡†æ¶çš„è¾“å‡ºã€‚ é€šè¿‡å¤šç›®æ ‡ï¼Œæ‰€æœ‰ç¨‹åºé›†éƒ½æ‰“åŒ…åœ¨ä¸€ä¸ª NuGet åŒ…ä¸­ã€‚ ç„¶åï¼Œä½¿ç”¨è€…å¯ä»¥å¼•ç”¨åŒä¸€ä¸ªåŒ…ï¼ŒNuGet å°†é€‰æ‹©é€‚å½“çš„å®ç°ã€‚ ä½ çš„ .NET Standard åº“å……å½“åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨çš„å›é€€åº“ï¼ˆNuGet åŒ…æä¾›ç‰¹å®šäºæ¡†æ¶çš„å®ç°çš„æƒ…å†µé™¤å¤–ï¼‰ã€‚ é€šè¿‡å¤šç›®æ ‡å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨æ¡ä»¶ç¼–è¯‘å¹¶è°ƒç”¨ç‰¹å®šäºæ¡†æ¶çš„ APIã€‚

```C#
public static class GpsLocation
{
    // This project uses multi-targeting to expose device-specific APIs to .NET Standard.
    public static async Task<(double latitude, double longitude)> GetCoordinatesAsync()
    {
#if NET461
        return CallDotNetFramworkApi();
#elif WINDOWS_UWP
        return CallUwpApi();
#else
        throw new PlatformNotSupportedException();
#endif
    }

    // Allows callers to check without having to catch PlatformNotSupportedException
    // or replicating the OS check.
    public static bool IsSupported
    {
        get
        {
#if NET461 || WINDOWS_UWP
            return true;
#else
            return false;
#endif
        }
    }
}
```


âŒ å¦‚æœä½ çš„æºä»£ç æºä»£ç å¯¹æ‰€æœ‰ç›®æ ‡éƒ½ç›¸åŒï¼Œè¯·é¿å…å¤šç›®æ ‡ä»¥åŠé¢å‘ .NET Standardï¼Œå®ç°ä¼šå¢åŠ  nupkg å¤§å°ï¼Œä¸ä¼šæä¾›ä»»ä½•å¥½å¤„ã€‚
âœ”ï¸ è¯·è€ƒè™‘åœ¨æä¾› netstandard2.0 ç›®æ ‡æ—¶ä¸º net461 æ·»åŠ ç›®æ ‡ã€‚åœ¨ .NET Framework ä¸­ä½¿ç”¨ .NET Standard 2.0 å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåœ¨ .NET Framework 4.7.2 ä¸­å·²å¾—åˆ°è§£å†³ã€‚ 
âœ”ï¸ è¯·ä½¿ç”¨ NuGet åŒ…åˆ†å‘åº“ã€‚NuGet å°†ä¸ºå¼€å‘äººå‘˜é€‰æ‹©æœ€ä½³ç›®æ ‡ï¼Œä½¿ä»–ä»¬æ— éœ€é€‰æ‹©é€‚å½“å®ç°ã€‚
âœ”ï¸ è¯·åŠ¡å¿…åœ¨ä½¿ç”¨å¤šç›®æ ‡æ—¶ä½¿ç”¨é¡¹ç›®æ–‡ä»¶çš„ TargetFrameworks å±æ€§ã€‚

    <Project Sdk="Microsoft.NET.Sdk">
      <PropertyGroup>
        <!-- This project will output netstandard2.0 and net461 assemblies -->
        <TargetFrameworks>netstandard2.0;net461</TargetFrameworks>
      </PropertyGroup>
    </Project>

é‡è¦çš„åŸºç¡€ç±»åº“ç»“æ„ï¼š

    >dotnet --list-runtimes
    Microsoft.AspNetCore.All 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
    Microsoft.AspNetCore.App 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
    Microsoft.NETCore.App 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
    Microsoft.WindowsDesktop.App 3.1.4 [C:\Program Files\dotnet\shared\Microsoft.WindowsDesktop.App]

- Microsoft.AspNetCore.App

    ASP.NET Core å…±äº«æ¡†æ¶åŒ…å«ç”± Microsoft å¼€å‘å’Œæ”¯æŒçš„ç¨‹åºé›†ã€‚ NET Core 3.0 æˆ–æ›´é«˜ç‰ˆæœ¬ SDK æ—¶ï¼Œæä¾›å®‰è£…åœ¨è®¡ç®—æœºä¸ŠåŒ…æ‹¬è¿è¡Œæ—¶ç»„ä»¶å’Œç›®æ ‡åŒ…çš„ä¸€ç»„ç¨‹åºé›† DLL æ–‡ä»¶ã€‚ é¢å‘ Microsoft.NET.Sdk.Web SDK çš„é¡¹ç›®éšå¼å¼•ç”¨ Microsoft.AspNetCore.App æ¡†æ¶ã€‚

    é»˜è®¤çš„ Web è¿è¡Œæ—¶ï¼Œæä¾› Microsoft.NETCore.Appï¼Œæ­¤å¤–å¢åŠ  HTTP server APIï¼Œä»¥æ‰¿è½½ Kestrel, Mvc, SignalR, Razor, åŠ EF Core çš„éƒ¨åˆ†åŠŸèƒ½ã€‚

    ä½¿ç”¨ Microsoft.NET.Sdk æˆ– Microsoft.NET.Sdk.Razor SDK çš„é¡¹ç›®å¿…é¡»å¼•ç”¨ ASP.NET Coreï¼Œæ‰èƒ½ä½¿ç”¨å…±äº«æ¡†æ¶ä¸­çš„ ASP.NET Core APIã€‚è‹¥è¦å¼•ç”¨ ASP.NET Coreï¼Œè¯·å°†ä»¥ä¸‹ <FrameworkReference> å…ƒç´ æ·»åŠ åˆ°é¡¹ç›®æ–‡ä»¶ï¼š

        <Project Sdk="Microsoft.NET.Sdk">

            <PropertyGroup>
                <TargetFramework>netcoreapp3.0</TargetFramework>
            </PropertyGroup>

            <ItemGroup>
                <FrameworkReference Include="Microsoft.AspNetCore.App" />
            </ItemGroup>

        </Project>

    ä»… .NET Core 3.x çš„é¡¹ç›®æ”¯æŒä½¿ç”¨æ­¤æ–¹å¼å¼•ç”¨ ASP.NET Coreã€‚

- Microsoft.NETCore.App 

    åŸºç¡€çš„è¿è¡Œæ—¶ï¼Œæä¾›è¯¸å¦‚ System.Object, List<T>, string, memory management, file, network IO, threading ç­‰ç­‰åŸºç¡€æœåŠ¡ã€‚


- Microsoft.AspNetCore.All

    å¼•ç”¨å…±äº«æ¡†æ¶çš„å…ƒåŒ…ï¼Œé›†æˆç¬¬ä¸‰æ–¹å·¥å…·ï¼Œä¹Ÿå¼•å…¥äº† Microsoft.AspNetCore.App åŸºç¡€ã€‚æ·»åŠ  EF Core + SQLite, Redis æ‰©å±•ï¼ŒAzure Key Vault é…ç½®ç­‰ã€‚ä½†åœ¨ .Net Core 3.0 å¼ƒç”¨è½¬è€Œä½¿ç”¨ Microsoft.AspNetCore.Appï¼Œå…¶å®ƒç”¨çš„ç¬¬ä¸‰æ–¹åŒ…å¦è¡Œå¼•å…¥ã€‚


# =ğŸš© Install .Net SDK or Runtime
- https://dotnet.microsoft.com/en-us/download/dotnet/6.0
- https://docs.microsoft.com/en-us/dotnet/core/install/
- https://docs.microsoft.com/en-us/dotnet/standard/net-standard
- https://docs.microsoft.com/en-us/dotnet/framework/tools/

åˆ©ç”¨ .Net SDK æä¾›çš„å‘½ä»¤è¡Œç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»“åˆå¼€æºæ–‡æœ¬ç¼–è¾‘å™¨ Visual Studio Code æˆ– Sublime Text è¿›è¡Œ Windowsï¼ŒLinux å’Œ Mac OS è·¨å¹³å°å¼€å‘ã€‚VSCode è¿˜æ”¯æŒ IntelliSense å’Œ debuggingï¼Œå°±åƒ Sublime, Emacs, and VI é‚£æ ·ã€‚

.NET Core 3.1 æ”¯æŒçš„ Linux ç³»ç»Ÿåˆ†å‘ç‰ˆæœ¬ï¼š

|              OS              | Version |   Architectures   |
|------------------------------|---------|-------------------|
| Red Hat Enterprise Linux     | 6, 7, 8 | x64               |
| CentOS                       | 7+      | x64               |
| Oracle Linux                 | 7+      | x64               |
| Fedora                       | 30+     | x64               |
| Debian                       | 9+      | x64, ARM32, ARM64 |
| Ubuntu                       | 16.04+  | x64, ARM32, ARM64 |
| Linux Mint                   | 18+     | x64               |
| openSUSE                     | 15+     | x64               |
| SUSE Enterprise Linux (SLES) | 12 SP2+ | x64               |
| Alpine Linux                 | 3.10+   | x64, ARM64        |

ä¸‹è½½å®‰è£…æœ€æ–°ç‰ˆæœ¬ .NET Core SDK 3.1.418ï¼Œå®‰è£ä¸‹åˆ—é …ç›®: 'C:\Program Files\dotnet\'

    â€¢ .NET Core SDK 3.1.418
    â€¢ .NET Core Runtime 3.1.24
    â€¢ ASP.NET Core Runtime 3.1.24
    â€¢ .NET Core Windows Desktop Runtime 3.1.24

å®‰è£… .NET Framework æˆ– .Net Core SDK å³å¯ä»¥å¼€å§‹ç¼–å†™ä»£ç ï¼ŒWindows ç³»ç»Ÿä¸‹è½½å®‰è£…åŒ…å®‰è£…ã€‚

    >dotnet --list-sdks
    2.1.806 [C:\Program Files\dotnet\sdk]
    3.0.100 [C:\Program Files\dotnet\sdk]
    3.1.300 [C:\Program Files\dotnet\sdk]
    5.0.100-preview.4.20258.7 [C:\Program Files\dotnet\sdk]

Windows ä¸Šå®‰è£… .NET Framework å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ï¼š

    C:\Windows\Microsoft.NET\Framework\v2.0.50727\
    C:\Windows\Microsoft.NET\Framework64\v2.0.50727\
    C:\Windows\Microsoft.NET\Framework\v4.0.30319\
    C:\Windows\Microsoft.NET\Framework64\v4.0.30319

å®‰è£…å’Œç§»é™¤ä¾èµ–çš„æ–¹å¼ï¼Œä»¥ Xamarin.Forms.theme.base ä¸ºä¾‹ï¼š

    dotnet add package Xamarin.Forms.pages --version 4.6.0.847
    dotnet add package Xamarin.Forms.theme.base --version 1.0.0.43-pre1
    dotnet add package Xamarin.Forms.theme.light --version 1.0.0.43-pre1
    dotnet add package Xamarin.Forms.theme.dark --version 1.0.0.43-pre1
    dotnet add package -s c:\download Xamarin.Forms.theme.base
    dotnet package --package-directory c:\download Xamarin.Forms.Pages
    dotnet remove package Xamarin.Forms.Pages

Ubuntu 18.04 ç³»ç»Ÿå®‰è£… .Net SDK 3.1 æ­¥éª¤åŠå‘½ä»¤ï¼Œå…¶å®ƒç‰ˆæœ¬å¯é€‰ 3.0 æˆ– 2.1ï¼š

    # Add Microsoft repository key and feed

    wget https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
    sudo dpkg -i packages-microsoft-prod.deb

    # Install the .NET Core SDK

    sudo add-apt-repository universe
    sudo apt-get update
    sudo apt-get install apt-transport-https
    sudo apt-get update
    sudo apt-get install dotnet-sdk-3.1

    # Install the ASP.NET Core runtime

    sudo add-apt-repository universe
    sudo apt-get update
    sudo apt-get install apt-transport-https
    sudo apt-get update
    sudo apt-get install aspnetcore-runtime-3.1


å¦‚ä½•å®šä½ä¸åˆ° .NET Core ä¾èµ–åŒ…ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š

    sudo dpkg --purge packages-microsoft-prod && sudo dpkg -i packages-microsoft-prod.deb
    sudo apt-get update
    sudo apt-get install {the .NET Core package}

    sudo apt-get install -y gpg
    wget -O - https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o microsoft.asc.gpg
    sudo mv microsoft.asc.gpg /etc/apt/trusted.gpg.d/
    wget https://packages.microsoft.com/config/ubuntu/18.04/prod.list
    sudo mv prod.list /etc/apt/sources.list.d/microsoft-prod.list
    sudo chown root:root /etc/apt/trusted.gpg.d/microsoft.asc.gpg
    sudo chown root:root /etc/apt/sources.list.d/microsoft-prod.list

    sudo apt-get install -y apt-transport-https
    sudo apt-get update
    sudo apt-get install {the .NET Core package}


Ubuntu 18.04 å’Œ Debian 10 æ˜¯åŒæºç³»ç»Ÿï¼Œå®‰è£…å‘½ä»¤ç›¸ä¼¼ï¼š

```sh
# Add Microsoft repository key and feed

wget -O - https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.asc.gpg
sudo mv microsoft.asc.gpg /etc/apt/trusted.gpg.d/
wget https://packages.microsoft.com/config/debian/10/prod.list
sudo mv prod.list /etc/apt/sources.list.d/microsoft-prod.list
sudo chown root:root /etc/apt/trusted.gpg.d/microsoft.asc.gpg
sudo chown root:root /etc/apt/sources.list.d/microsoft-prod.list

# Install the .NET Core SDK

sudo apt-get update
sudo apt-get install apt-transport-https
sudo apt-get update
sudo apt-get install dotnet-sdk-3.1

# Install the ASP.NET Core runtime

sudo apt-get update
sudo apt-get install apt-transport-https
sudo apt-get update
sudo apt-get install aspnetcore-runtime-3.1

# Install the .NET Core runtime

sudo apt-get update
sudo apt-get install apt-transport-https
sudo apt-get update
sudo apt-get install dotnet-runtime-3.1
```

CentOS 8 / RHEL 8 / Fedora 32 ç­‰ç³»ç»Ÿä¸Šå®‰è£…ï¼š

```sh
# Install the .NET Core SDK

sudo dnf install dotnet-sdk-3.1

# Install the ASP.NET Core Runtime

sudo dnf install aspnetcore-runtime-3.1

#Install the .NET Core Runtime

sudo dnf install dotnet-runtime-3.1
```

openSUSE 15 ç³»ç»Ÿä¸Šå®‰è£…ï¼š

```sh
# Add Microsoft repository feed and signing key to trusted list

sudo zypper install libicu
sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
wget https://packages.microsoft.com/config/opensuse/15/prod.repo
sudo mv prod.repo /etc/zypp/repos.d/microsoft-prod.repo
sudo chown root:root /etc/zypp/repos.d/microsoft-prod.repo

#Install the .NET Core SDK

sudo zypper install dotnet-sdk-3.1

#Install the ASP.NET Core runtime

sudo zypper install aspnetcore-runtime-3.1

#Install the .NET Core runtime

sudo zypper install dotnet-runtime-3.1
```

é€šå¸¸ï¼Œæ–°ç‰ˆæœ¬å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œå¯ä»¥å¦è¡Œå®‰è£… .NET Core Uninstall å·¥å…· dotnet-core-uninstall  å¸è½½æ—§ç‰ˆæœ¬ã€‚ .NET Core 3.0 SDK å‰é¢çš„ç‰ˆæœ¬å®‰è£…ä¾èµ–ä¼šä½¿ç”¨ NuGetFallbackFolder ï¼Œå¦‚æœä¸è€ƒè™‘å›åˆ°æ—§ç‰ˆæœ¬çš„å¼€å‘ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ NuGet fallbackï¼Œä½¿ç”¨å›å¤å‘½ä»¤åŠå›æ»šç›®å½•ä½ç½®ï¼š

    dotnet restore
    dotnet build /t:Restore

    C:\Program Files\dotnet\sdk on Windows and at 
    /usr/local/share/dotnet/sdk 

ç¼–è¯‘å™¨ä¸ C# ç‰ˆæœ¬æ ¹æ® .Net æ¡†æ¶ç‰ˆæœ¬ä¸åŒä½¿ç”¨ä¸åŒé»˜è®¤å€¼ï¼š

| .NET Core      | 3.x  | C# 8.0 |
| .NET Core      | 2.x  | C# 7.3 |
| .NET Standard  | 2.1  | C# 8.0 |
| .NET Standard  | 2.0  | C# 7.3 |
| .NET Standard  | 1.x  | C# 7.3 |
| .NET Framework | å…¨éƒ¨ | C# 7.3 |

å¦‚æœå¿…é¡»æ˜ç¡®æŒ‡å®š C# ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°ï¼š

- æ‰‹åŠ¨ç¼–è¾‘é¡¹ç›®æ–‡ä»¶ã€‚
- ä¸ºå­ç›®å½•ä¸­çš„å¤šä¸ªé¡¹ç›®è®¾ç½®è¯­è¨€ç‰ˆæœ¬ã€‚
- é…ç½® -langversion ç¼–è¯‘å™¨é€‰é¡¹ã€‚

å¦‚æœ SDK ç‰ˆæœ¬å¤ªä½ï¼Œæ¯”å¦‚ .NET Framework v4.0.30319 åªèƒ½é€šè¿‡ -langversion æŒ‡å®š C# ç‰ˆæœ¬ä¸º ISO-1ã€ISO-2ã€3ã€4ã€5ï¼Œå…¶å®ƒæ›´é«˜çš„ C# ç‰ˆæœ¬æ”¯æŒå°±éœ€è¦æ›´æ–° SDK æˆ– Visual Studio è‡ªå¸¦çš„ç¼–è¯‘å™¨æ¥è·å¾—ã€‚Visual Studio çš„ç¼–è¯‘å¼•æ“æ˜¯ MSBuild - Microsoft Build Tools ï¼Œå®ƒæä¾›äº†ä¸€å¥— NuGet é¡¹ç›®æ–‡ä»¶ .csproj , .vbproj , vcxproj çš„ XML Schema ç”¨æ¥æŒ‡å®šå¦‚ä½•å¤„ç†å’Œç¼–è¯‘é¡¹ç›®ã€‚å½“ç„¶ MSBuild ä¸ä¾èµ–äº Visual Studioï¼Œå®Œå…¨å¯ä»¥ç‹¬ç«‹å®‰è£…ä½¿ç”¨ MSBuildï¼Œå®ƒæ˜¯ MIT License å¼€æºè½¯ä»¶ã€‚ å¯ä»¥ä¸‹è½½ Microsoft Build Tools 2013/2015 ä»¥æ”¯æŒ C# 6.0ã€‚

    https://www.microsoft.com/en-us/download/details.aspx?id=40760#msbuild_tools_2013
    https://www.microsoft.com/en-us/download/details.aspx?id=48159#msbuild_tools_2015

    C:\Program Files (x86)\MSBuild\14.0\Bin

æ³¨æ„ï¼Œä» .NET Framework 4 å¼€å§‹ï¼Œæ‰€æœ‰çš„ .NET Framework ç‰ˆæœ¬éƒ½æ˜¯å‡çº§æ›´æ–°ï¼Œå› æ­¤åœ¨ç³»ç»Ÿä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ª 4.x çš„ç‰ˆæœ¬ã€‚æ›´æ–°å†…å®¹å®‰è£…ä½ç½®ï¼š

    C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\

ä½¿ç”¨ dotnet å‘½ä»¤æµ‹è¯•å®‰è£…ç»“æœï¼š

```sh
>dotnet

Usage: dotnet [options]
Usage: dotnet [path-to-application]

Options:
  -h|--help         Display help.
  --info            Display .NET Core information.
  --list-sdks       Display the installed SDKs.
  --list-runtimes   Display the installed runtimes.

path-to-application:
  The path to an application .dll file to execute.


>where dotnet
C:\Program Files\dotnet\dotnet.exe

>dotnet --list-sdks
2.1.806 [C:\Program Files\dotnet\sdk]
3.0.100 [C:\Program Files\dotnet\sdk]

>dotnet --list-runtimes
Microsoft.AspNetCore.All 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
Microsoft.AspNetCore.App 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
Microsoft.AspNetCore.App 3.0.0 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
Microsoft.NETCore.App 2.1.18 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
Microsoft.NETCore.App 3.0.0 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
Microsoft.WindowsDesktop.App 3.0.0 [C:\Program Files\dotnet\shared\Microsoft.WindowsDesktop.App]

> dotnet new console -o myApp
> cd myApp
```


é»˜è®¤æƒ…å†µä¸‹ï¼ŒASP.NET Core é¡¹ç›®æ¨¡æ¿ä½¿ç”¨ Kestrel Web æœåŠ¡å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº libuv åº“çš„è½»é‡çº§é«˜å¹¶å‘è·¨å¹³å°æœåŠ¡å™¨ï¼Œæ”¯æŒåå‘ä»£ç†ã€‚ libuv æœ€å…ˆæ˜¯ä¸º Node.js å¼€å‘çš„ï¼Œå› ä¸ºå…¶è‰¯å¥½çš„äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥ IO è®¾è®¡è€Œå¾—åˆ°å¹¿æ³›çš„åº”ç”¨ï¼Œ I/O loop ä¹Ÿç§°ä¸º Event Loop æ˜¯å…¶æ ¸å¿ƒè®¾è®¡ã€‚

å‚è€ƒæ–‡æ¡£ AspNetCore.Docs\aspnetcore\fundamentals\servers\kestrel.md - Kestrel web server implementation in ASP.NET Core 

åœ¨é¡¹ç›® Program.cs çš„ ConfigureWebHostDefaults æ–¹æ³•è°ƒç”¨ UseKestrel ï¼š

    public static void Main(string[] args)
    {
        CreateHostBuilder(args).Build().Run();
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureWebHostDefaults(webBuilder =>
            {
                webBuilder.UseStartup<Startup>();
            });


    webBuilder.UseKestrel((context, serverOptions) =>
    {
        serverOptions.Configure(context.Configuration.GetSection("Kestrel"))
            .Endpoint("HTTPS", listenOptions =>
            {
                listenOptions.HttpsOptions.SslProtocols = SslProtocols.Tls12;
            });
    });


    // using System.Security.Cryptography.X509Certificates;
    webBuilder.UseStartup<Startup>()
        .UseKestrel(options =>
        {
            options.ConfigureHttpsDefaults(i =>
            {
                i.ServerCertificate = new X509Certificate2("ca-test/localhost.pfx", "123456");
            });
        })
        .UseContentRoot(Directory.GetCurrentDirectory())
        .UseUrls("https://*:443");

UseContentRoot è®¾ç½®çš„æ˜¯æ ¹ç›®å½•ï¼Œwwwroot æ‰æ˜¯ Web è®¿é—®åˆ°çš„ç›®å½•ã€‚

è‹¥è¦åœ¨è°ƒç”¨ ConfigureWebHostDefaults åæä¾›å…¶ä»–é…ç½®ï¼Œè¯·ä½¿ç”¨ ConfigureKestrelï¼š

    webBuilder.ConfigureKestrel(serverOptions =>
    {
        serverOptions.Limits.MaxConcurrentConnections = 100;
        serverOptions.Limits.MaxConcurrentUpgradedConnections = 100;
        serverOptions.Limits.MaxRequestBodySize = 10 * 1024;
        serverOptions.Limits.MinRequestBodyDataRate =
            new MinDataRate(bytesPerSecond: 100, 
                gracePeriod: TimeSpan.FromSeconds(10));
        serverOptions.Limits.MinResponseDataRate =
            new MinDataRate(bytesPerSecond: 100, 
                gracePeriod: TimeSpan.FromSeconds(10));
        serverOptions.Listen(IPAddress.Loopback, 5000);
        serverOptions.Listen(IPAddress.Loopback, 5001, 
            listenOptions =>
            {
                listenOptions.UseHttps("testCert.pfx", 
                    "testPassword");
            });
        serverOptions.Limits.KeepAliveTimeout = 
            TimeSpan.FromMinutes(2);
        serverOptions.Limits.RequestHeadersTimeout = 
            TimeSpan.FromMinutes(1);
    })




# =ğŸš© .Net Core Sources


å¦‚ä½•é˜…è¯» .Net Core æºä»£ç ï¼Ÿ

ç¬¬ä¸€æ‰‹èµ„æºæ˜¯å®˜æ–¹æ–‡æ¡£ä»“åº“ï¼š

- https://github.com/dotnet/docs
- https://github.com/dotnet/standard
- https://github.com/dotnet/csharpstandard
- https://github.com/dotnet/dotnet-api-docs
- https://github.com/dotnet/AspNetCore.Docs

å¿«æ·æºæŸ¥è¯¢ .NET Framework ä»£ç å¯ä»¥ä½¿ç”¨ Reference Source https://referencesource.microsoft.com/

.Net Core æœ‰ä¸‰ä¸ªæ ¸å¿ƒå¼€æºä»£ç ä»“åº“ï¼Œå¤–åŠ ä¸€ä¸ª ASP.NET Core å’Œ Roslynï¼Œé¡¹ç›®å®¹é‡å¦‚ä¸‹ï¼š

|        Projects        |     Repository    |  Size  | Files  | Folders |
|------------------------|-------------------|--------|--------|---------|
| .NET Runtime           | runtime-6.0.4     | 811 MB | 56,191 | 9,565   |
| .NET Core Runtime      | coreclr-3.1.24    | 529 MB | 30,146 | 6,180   |
| .NET Core Libraries    | corefx-3.1.24     | 201 MB | 20,880 | 2,930   |
| .NET Compiler Platform | roslyn-4.0.1      | 304 MB | 16,576 | 3,061   |
| ASP.NET Core           | aspnetcore-3.1.24 | 113 MB | 12,505 | 2,830   |

âœ… .NET Runtime (Runtime) 

    git clone https://github.com/dotnet/runtime
    git clone git@github.com:dotnet/runtime.git

.NET is a cross-platform runtime for cloud, mobile, desktop, and IoT apps.

This repo contains the code to build the .NET runtime, libraries and shared host (dotnet) installers for all supported platforms, as well as the sources to .NET runtime and libraries.

âœ… .NET Core Libraries (CoreFX) 

    git clone https://github.com/dotnet/corefx
    git clone git@github.com:dotnet/corefx.git

This repo is used for servicing PR's for .NET Core 2.1 and 3.1. Please visit us at https://github.com/dotnet/runtime

This repo contains the library implementation (called "CoreFX") for .NET Core. It includes System.Collections, System.IO, System.Xml, and many other components. 

âœ… .NET Core Runtime (CoreCLR) 

    git clone https://github.com/dotnet/coreclr
    git clone git@github.com:dotnet/coreclr.git

CoreCLR is the runtime for .NET Core. It includes the garbage collector, JIT compiler, primitive data types and low-level classes.

This repo contains the runtime implementation for .NET Core. It includes RyuJIT, the .NET GC, and many other components. Runtime-specific library code (System.Private.CoreLib) lives in the CoreCLR repo. It needs to be built and versioned in tandem with the runtime.

The rest of CoreFX is agnostic of runtime-implementation and can be run on any compatible .NET runtime (e.g. CoreRT).

âœ… ASP.NET Core (AspNetCore) 

    git clone https://github.com/dotnet/aspnetcore
    git clone git@github.com:dotnet/aspnetcore.git

ASP.NET Core å®¹é‡æ˜¯æœ€å°çš„ï¼Œä½†é¡¹ç›®å®åœ¨è¿˜æ˜¯å¤ªå¤§ï¼Œæœ‰ 566 csproj æ–‡ä»¶ï¼ŒåŒ…å« 251 å•å…ƒå·¥ç¨‹æµ‹è¯•åœ¨å†…ï¼Œ26 ä¸ªè§£å†³æ–¹æ¡ˆ .sln æ–‡ä»¶ä¹Ÿä¸å°‘ã€‚åœ¨ .\src ç›®å½•ä¸‹é¢æœ‰å¾ˆå¤šå­ç›®å½•ï¼Œæ¯ä¸€ä¸ªå­ç›®å½•éƒ½æ˜¯ä¸€ä¸ªå­é¡¹ç›®ï¼Œæ¯ä¸ªå­é¡¹ç›®ä¸­éƒ½åŒ…å«äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚æ­¤å¤–ï¼Œè¿˜å¥½äº› MSBuild å·¥ç¨‹æ–‡ä»¶ï¼Œ.debproj .javaproj .npmproj .pkgproj .proj .rpmproj .vcxproj .wixprojï¼Œè¿™ä¹ˆå¤šçš„å·¥ç¨‹ç±»å‹æ˜¯å› ä¸º ASP.NET Core æ˜¯åŸºäº Web çš„ç¼–ç¨‹ï¼Œæ¶‰åŠå‰ç«¯ JavaScript è„šæœ¬ï¼ŒNodeJS ä»¥åŠ Java ç­‰å¼€å‘ç¯å¢ƒã€‚

âœ… Roslyn .NET compiler (roslyn) 

    git clone https://github.com/dotnet/roslyn
    git clone git@github.com:dotnet/roslyn.git

The .NET Compiler Platform, the Roslyn .NET compiler provides C# and Visual Basic languages with rich code analysis APIs.

Roslyn is the open-source implementation of both the C# and Visual Basic compilers with an API surface for building code analysis tools.

Roslyn é¡¹ç›®æ˜¯ .NET å¼€æºç¼–è¯‘å™¨ï¼Œ.NET å¹³å°ç¨‹åºçš„æ‰§è¡Œæ¨¡å‹çš„ä¸åŒé˜¶æ®µæœ‰ä¸¤ä¸ªä¸åŒçš„ç¼–è¯‘å™¨ï¼šä¸€ä¸ªå« Roslyn ç¼–è¯‘å™¨ï¼Œè´Ÿè´£æŠŠ C# å’Œ VB ä»£ç ç¼–è¯‘ä¸ºç¨‹åºé›†ï¼›å¦ä¸€ä¸ªå« RyuJIT ç¼–è¯‘å™¨ï¼Œè´Ÿè´£æŠŠç¨‹åºé›†ä¸­çš„ IL ä¸­é—´è¯­è¨€ä»£ç ç¼–è¯‘ä¸ºæœºå™¨ç ã€‚

æœ€åˆ C# è¯­è¨€çš„ç¼–è¯‘å™¨æ˜¯ç”¨ C++ ç¼–å†™çš„ï¼Œåæ¥å¾®è½¯æ¨å‡ºäº†ä¸€ä¸ªæ–°çš„ç”¨ C# è‡ªèº«ç¼–å†™çš„ç¼–è¯‘å™¨ï¼šRoslynï¼Œå®ƒå±äºè‡ªä¸¾ç¼–è¯‘å™¨ï¼Œå³ç¼–è¯‘å™¨ç”¨è‡ªèº«è¯­è¨€æ¥å®ç°è‡ªå·±ã€‚Roslyn æ”¯æŒ C# å’Œ Visual Basic ä»£ç ç¼–è¯‘ï¼Œå¹¶æä¾›ä¸°å¯Œçš„ä»£ç åˆ†æ APIï¼Œå¯ä»¥ç”¨å®ƒæ¥åšä»£ç ç”Ÿæˆå™¨ã€‚



# =ğŸš© CSC C# Compiler
- [C# Compiler Options Listed by Category](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/listed-by-category)

åŸºæœ¬æ“ä½œ

Compiles File.cs producing File.exe:

    csc File.cs 

Compiles File.cs producing File.dll:

    csc /target:library File.cs

Compiles File.cs and creates My.exe:

    csc /out:My.exe File.cs

Compiles all the C# files in the current directory, with optimizations on and defines the DEBUG symbol. The output is File2.exe:

    csc /define:DEBUG /optimize /out:File2.exe *.cs

Compiles all the C# files in the current directory producing a debug version of File2.dll. No logo and no warnings are displayed:

    csc /target:library /out:File2.dll /warn:0 /nologo /debug *.cs

Compiles all the C# files in the current directory to Something.xyz (a DLL):

    csc /target:library /out:Something.xyz *.cs

ç”Ÿæˆè°ƒè¯•ä¿¡æ¯

    csc /define:DEBUG /optimize /out:File2.exe *.cs

æ¨¡å—åŒ– DLL ç”Ÿæˆå’Œç¨‹åºé›†å¼•ç”¨

    csc /target:library /out:File2.dll /warn:0 /nologo /debug *.cs
    csc /target:library /out:lib/Class1.dll Class1.cs
    csc /lib:lib_path /reference:Class1.dll /reference:File2.dll HelloWorld.cs

HelloWorld.exe è¿è¡Œæ—¶ï¼Œéœ€è¦å’Œ DLL åœ¨åŒä¸€ä¸ªç›®å½•

Module VS Assemblyï¼šModuleæ˜¯ç¼–è¯‘å•å…ƒï¼ŒAssemlyæ˜¯éƒ¨ç½²å•å…ƒã€‚

The /reference option causes the compiler to import public type information in the specified file into the current project, thus enabling you to reference metadata from the specified assembly files.

    /reference:[alias=]filename
    /r:filename

The /lib option specifies the location of assemblies referenced by means of the /reference (C# Compiler Options) option.

    /lib:dir1[,dir2]

åœ¨ CSC ç¼–è¯‘ç›®å½•ä¸‹ï¼Œæœ‰é»˜è®¤çš„å“åº”æ–‡ä»¶è®¾ç½®ï¼Œå®ƒå¼•ç”¨äº† .NET Framework é™„å¸¦çš„æ‰€æœ‰ç¨‹åºé›†ï¼Œä»¥ MSBuild å·¥å…·ç›®å½•ä¸ºä¾‹ï¼š

    C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\Roslyn\csc.rsp

/noconfig é€‰é¡¹é€šçŸ¥ç¼–è¯‘å™¨ä¸è¦ä½¿ç”¨ csc.rsp æ–‡ä»¶è¿›è¡Œç¼–è¯‘ã€‚

åœ¨å·¥ç¨‹æ–‡ä»¶ä¸­å¯ä»¥è®¾ç½® TargetFrameworks ä»¥é€‰æ‹©ç¨‹åºæ‰€ä½¿ç”¨çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ— æ³•é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šï¼š

```XML
<PropertyGroup>
  <TargetFrameworks>netcoreapp3.1;net462</TargetFrameworks>
  <LangVersion>8.0</LangVersion>
</PropertyGroup>
```

éœ€è¦ä½¿ç”¨ devenv æˆ– dotnet å‘½ä»¤ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼Œå‘½ä»¤è¡Œï¼š

    devenv "test.csproj" /build

è¾“å‡ºé€‰é¡¹

To create an .exe file for Windows 8.x Store apps.

    /target:appcontainerexe

To create an .exe file.

    /target:exe

To create a code library.

    /target:library

To create a module.

    /target:module

To create a Windows program.

    /target:winexe

To create an intermediate .winmdobj file.

    /target:winmdobj


ç¼–è¯‘å‘½ä»¤æœ‰å‡ ä¸ªä¸ªåµŒå…¥èµ„æºçš„é€‰é¡¹ï¼š

    -linkresource
    -resource
    -win32res

åœ¨æ—§ Win32 ç¨‹åºä¸­å¯ä»¥æ”¯æŒ res åè®®ï¼Œæ¯”å¦‚ CHM HTML Helper ä½¿ç”¨åœ¨ DLL æˆ– EXE ä¸­å†…åµŒçš„ HTML é¡µé¢èµ„æºï¼š

    res://resource file[/resource type]/resource id

å…¶ä¸­ `resource type` ç¼ºçœæ—¶è¡¨ç¤ºé»˜è®¤çš„ 23 å³ HTMLï¼Œ`resource file` æ˜¯èµ„æºåœ¨ EXE or DLL çš„è·¯å¾„ï¼Œ`resource id` å°±æ˜¯åµŒå…¥èµ„æºçš„åç§°ã€‚

ä½†æ˜¯ .NET ç¨‹åºçš„èµ„æºä¸åŒå¤„ç†ï¼ŒC# or VB.NET å·¥ç¨‹ä¸ç›´æ¥æ”¯æŒï¼Œæ‰˜ç®¡çš„ Managed C++ project æ”¯æŒã€‚

.NET ç¨‹åºæˆ– DLL å¯ä»¥é€šè¿‡ csc.exe æˆ– al.exe æä¾›çš„ `/win32res` ç¼–è¯‘é€‰é¡¹ç¼–è¯‘èµ„æºã€‚

æœ‰ä¸€ä¸ªå·¥å…· Resource Hacker å¯ä»¥åšèµ„æºçš„ä¿®æ”¹æˆ–æå–ã€‚ 
http://www.angusj.com/resourcehacker/

è¾“å‡ºæ–‡ä»¶ä¸­åˆ›å»ºåˆ° .Net èµ„æºçš„é“¾æ¥ç®€å†™æ˜¯ /linkresï¼Œèµ„æºæ–‡ä»¶å°±æ˜¯åœ¨é‚£äº›åœ¨å·¥ç¨‹æ–‡ä»¶ä¸­ä½¿ç”¨åˆ°çš„æ‰€æœ‰çš„èµ„æºï¼Œåƒå›¾ç‰‡ã€å£°éŸ³ç­‰ã€‚è¿™ä¸ªé€‰é¡¹åªæ˜¯å¯¹äºèµ„æºæ–‡ä»¶å»ºç«‹é“¾æ¥ï¼Œè¿™æ ·æœ‰åŠ©äºç®¡ç†ä½¿ç”¨åŒä¸€èµ„æºçš„ç¨‹åºï¼Œè€Œä¸éœ€è¦å¤šä¸ªå‰¯æœ¬ã€‚æ­¤é€‰é¡¹çš„å…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š

    /linkresource:filename,identifier,mimetype

/resource é€‰é¡¹å’Œ /linkresource æ­£å¥½ç›¸åï¼Œæ˜¯æŠŠèµ„æºæ–‡ä»¶åµŒå…¥åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ï¼Œå‚æ•°ã€ç”¨æ³•éƒ½å’Œ /linkresource ç›¸åŒã€‚ç›¸åº”çš„è¯»å–ä»£ç ï¼š

    using System.Reflection;
    using System.IO;
    using System.Resources;

        // csc media.cs -resource:"surface.wav"
        protected static void ResourceRead()
        {
            Assembly assembly = Assembly.GetExecutingAssembly();
            Stream steam = assembly.GetManifestResourceStream("surface.wav");


CSC: Optimization

    -filealign  Specifies the size of sections in the output file.
    -optimize   Enables/disables optimizations.

CSC: Output Files

    -deterministic  Causes the compiler to output an assembly whose binary content is identical across compilations if inputs are identical.
    -doc    Specifies an XML file where processed documentation comments are to be written.
    -out    Specifies the output file.
    -pathmap    Specify a mapping for source path names output by the compiler
    -pdb    Specifies the file name and location of the .pdb file.
    -platform   Specify the output platform.
    -preferreduilang    Specify a language for compiler output.
    -refout Generate a reference assembly in addition to the primary assembly.
    -refonly    Generate a reference assembly instead of a primary assembly.
    -target Specifies the format of the output file using one of five options: -target:appcontainerexe, -target:exe, -target:library, -target:module, -target:winexe, or -target:winmdobj.
    -modulename:<string>    Specify the name of the source module

CSC:.NET Framework Assemblies

    -addmodule  Specifies one or more modules to be part of this assembly.
    -delaysign  Instructs the compiler to add the public key but to leave the assembly unsigned.
    -keycontainer   Specifies the name of the cryptographic key container.
    -keyfile    Specifies the filename containing the cryptographic key.
    -lib    Specifies the location of assemblies referenced by means of -reference.
    -nostdlib   Instructs the compiler not to import the standard library (mscorlib.dll).
    -publicsign Apply a public key without signing the assembly, but set the bit in the assembly indicating the assembly is signed.
    -reference  Imports metadata from a file that contains an assembly.
    -analyzer   Run the analyzers from this assembly (Short form: /a)
    -additionalfile Names additional files that don't directly affect code generation but may be used by analyzers for producing errors or warnings.
    -embed  Embed all source files in the PDB.
    -embed:<file list>  Embed specific files in the PDB.

CSC: Debugging/Error Checking

    -bugreport  Creates a file that contains information that makes it easy to report a bug.
    -checked    Specifies whether integer arithmetic that overflows the bounds of the data type will cause an exception at run time.
    -debug  Instruct the compiler to emit debugging information.
    -errorreport    Sets error reporting behavior.
    -fullpaths  Specifies the absolute path to the file in compiler output.
    -nowarn Suppresses the compiler's generation of specified warnings.
    -warn   Sets the warning level.
    -warnaserror    Promotes warnings to errors.
    -ruleset:<file> Specify a ruleset file that disables specific diagnostics.

CSC: Preprocessor

    -define Defines preprocessor symbols.

CSC: Resources

    -link   Makes COM type information in specified assemblies available to the project.
    -linkresource   Creates a link to a managed resource.
    -resource   Embeds a .NET Framework resource into the output file.
    -win32icon  Specifies an .ico file to insert into the output file.
    -win32res   Specifies a Win32 resource to insert into the output file.

CSC: Miscellaneous

    @   Specifies a response file.
    -?  Lists compiler options to stdout.
    -baseaddress    Specifies the preferred base address at which to load a DLL.
    -codepage   Specifies the code page to use for all source code files in the compilation.
    -help   Lists compiler options to stdout.
    -highentropyva  Specifies that the executable file supports address space layout randomization (ASLR).
    -langversion    Specify language version: Default, ISO-1, ISO-2, 3, 4, 5, 6, 7, 7.1, 7.2, 7.3, or Latest
    -main   Specifies the location of the Main method.
    -noconfig   Instructs the compiler not to compile with csc.rsp.
    -nologo Suppresses compiler banner information.
    -recurse    Searches subdirectories for source files to compile.
    -subsystemversion   Specifies the minimum version of the subsystem that the executable file can use.
    -unsafe Enables compilation of code that uses the unsafe keyword.
    -utf8output Displays compiler output using UTF-8 encoding.
    -parallel[+|-]  Specifies whether to use concurrent build (+).
    -checksumalgorithm:<alg>    Specify the algorithm for calculating the source file checksum stored in PDB. Supported values are: SHA1 (default) or SHA256.
    Due to collision problems with SHA1, Microsoft recommends SHA256.

CSC: Obsolete Options

    -incremental    Enables incremental compilation.


# =ğŸš© nuget command
- https://docs.microsoft.com/zh-cn/nuget/
- https://docs.microsoft.com/en-us/nuget/reference/nuget-exe-cli-reference
- https://blog.davidebbo.com/2011/01/nuget-versioning-part-1-taking-on-dll.html

NuGet æ˜¯å®˜æ–¹çš„ä¾èµ–ç®¡ç†å·¥å…·ï¼Œä¸€ä¸ªå…¸å‹çš„ NuGet æºçš„å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š

    \\myserver\packages
      â””â”€<packageID>
        â””â”€<version>
          â”œâ”€<packageID>.<version>.nupkg
          â”œâ”€<packageID>.<version>.nupkg.sha512
          â””â”€<packageID>.nuspec

ä¸ºå¼€æ”¾æºä»£ç  .NET åº“åˆ›å»º NuGet åŒ…ç®¡ç†å¹³å°ï¼ŒåŒ…æ‹¬åœ¨ NuGet.org ä¸Šå…¬å¼€å‘å¸ƒçš„æ‰€æœ‰åŒ…çš„æ¨èå…ƒæ•°æ®ã€‚

NuGet åŒ… `*.nupkg` æ˜¯ä¸€ä¸ª zip æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« .NET ç¨‹åºé›†å’Œå…³è”çš„å…ƒæ•°æ®ã€‚

NuGet æ˜¯ .NET ç”Ÿæ€ç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨ï¼Œå¹¶ä¸”æ˜¯å¼€å‘äººå‘˜ç”¨æ¥å‘ç°å¹¶è·å– .NET å¼€æ”¾æºä»£ç åº“çš„ä¸»è¦æ–¹æ³•ã€‚ NuGet.orgï¼ˆç”±æ‰˜ç®¡ NuGet åŒ…çš„ Microsoft æä¾›çš„å…è´¹æœåŠ¡ï¼‰æ˜¯å…¬å…± NuGet åŒ…çš„ä¸»è¦ä¸»æœºï¼Œä½†å¯ä»¥å‘å¸ƒåˆ°è‡ªå®šä¹‰ NuGet æœåŠ¡ï¼Œå¦‚ MyGet å’Œ Azure Artifactsã€‚

åˆ›å»º NuGet åŒ…æœ‰ä¸¤ç§ä¸»è¦æ–¹å¼ã€‚ è¾ƒæ–°çš„æ¨èæ–¹å¼æ˜¯ä» SDK æ ·å¼é¡¹ç›®ï¼Œå…¶å†…å®¹ä»¥ `<Project Sdk="Microsoft.NET.Sdk">` å¼€å¤´çš„é¡¹ç›®æ–‡ä»¶åˆ›å»ºåŒ…ã€‚ ç¨‹åºé›†å’Œç›®æ ‡ä¼šè‡ªåŠ¨æ·»åŠ åˆ°åŒ…ï¼Œå‰©ä½™å…ƒæ•°æ®ä¼šæ·»åŠ åˆ° MSBuild æ–‡ä»¶ï¼Œå¦‚åŒ…åç§°å’Œç‰ˆæœ¬å·ã€‚ ä½¿ç”¨ `dotnet pack` å‘½ä»¤ç¼–è¯‘ä¼šè¾“å‡º `*.nupkg` æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç¨‹åºé›†ã€‚

NuGet åŒ…æ”¯æŒå¤šä¸ªå…ƒæ•°æ®å±æ€§ã€‚ ä¸‹è¡¨åŒ…å« NuGet.org ä¸Šçš„æ¯ä¸ªåŒ…åº”æä¾›çš„æ ¸å¿ƒå…ƒæ•°æ®ï¼š

|  MSBuild å±æ€§åç§° | Nuspec åç§° |                                    è¯´æ˜                               |
|-------------------|-------------|----------------------------------------------------------------------|
| PackageId         | id          | åŒ…æ ‡è¯†ç¬¦ã€‚ å¦‚æœæ ‡è¯†ç¬¦çš„å‰ç¼€æ»¡è¶³æ¡ä»¶ï¼Œåˆ™å¯ä»¥ä¿ç•™è¯¥å‰ç¼€ã€‚                    |
| PackageVersion    | version     | NuGet åŒ…ç‰ˆæœ¬ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… NuGet åŒ…ç‰ˆæœ¬ã€‚                       |
| Title             | title       | æ˜äº†æ˜“ç”¨çš„åŒ…æ ‡é¢˜ã€‚ é»˜è®¤ä¸º PackageIdã€‚                                   |
| Description       | description | UI ä¸­æ˜¾ç¤ºçš„åŒ…çš„è¯¦ç»†è¯´æ˜ã€‚                                              |
| Authors           | authors     | åŒ…åˆ›å»ºè€…çš„é€—å·åˆ†éš”åˆ—è¡¨ï¼Œä¸ nuget.org ä¸Šçš„é…ç½®æ–‡ä»¶åç§°ä¸€è‡´ã€‚               |
| PackageTags       | tags        | æè¿°åŒ…çš„æ ‡è®°å’Œå…³é”®å­—çš„ç©ºæ ¼åˆ†éš”åˆ—è¡¨ã€‚ æœç´¢åŒ…æ—¶ä½¿ç”¨æ ‡è®°ã€‚                    |
| PackageIconUrl    | iconUrl     | è¦ç”¨ä½œåŒ…çš„å›¾æ ‡çš„å›¾åƒ URLã€‚ URL åº”ä¸º HTTPSï¼Œå›¾åƒåº”ä¸º 64x64 å¹¶å…·æœ‰é€æ˜èƒŒæ™¯ã€‚ |
| PackageProjectUrl | projectUrl  | é¡¹ç›®ä¸»é¡µæˆ–æºå­˜å‚¨åº“çš„ URLã€‚                                              |
| PackageLicenseExpression  | license   | é¡¹ç›®è®¸å¯è¯çš„ SPDX æ ‡è¯†ç¬¦ã€‚ åªæœ‰è·å¾— OSI å’Œ FSF æ‰¹å‡†çš„è®¸å¯è¯æ‰èƒ½ä½¿ç”¨æ ‡è¯†ç¬¦ã€‚ å…¶ä»–è®¸å¯è¯åº”ä½¿ç”¨ PackageLicenseFileã€‚ |


ç†è§£ 3 ä¸ªåŸºæœ¬çš„ä»£ç ç»„ç»‡æ¦‚å¿µï¼Œä½¿ç”¨å®ƒä»¬çš„ç›®çš„æ˜¯å®ç°ä»£ç å¤ç”¨ï¼š

- å‘½åç©ºé—´ Namespaceï¼Œè¡¨ç°ä¸ºä¸€ä¸²å­—ç¬¦ï¼Œå¦‚ System.Collectionsï¼Œæ˜¯ä»£ç çš„æŠ½è±¡ç»„ç»‡å•ä½ï¼ŒåŒä¸€ç©ºé—´çš„ API å¯ä»¥å½’å±äºä¸åŒçš„æ®µä¹‰å’Œé›†ã€‚
- ç¨‹åºé›† Assembliesï¼Œè¡¨ç°ä¸º exe æˆ– dll åŠ¨æ€è¿æ¥åº“ï¼Œæ˜¯ä¸€ç»„ç”¨æ–‡ä»¶è¿›è¡Œç®¡ç†çš„ API ä»£ç ï¼›
- åŒ… Packageï¼Œè¡¨ç°ä¸ºä»»æ„æ–‡ä»¶çš„æ‰“åŒ…ï¼Œç”¨åŒ…ååŠç‰ˆæœ¬æ¥æ ‡è¯†ï¼Œå¦‚ Microsoft.WSMan.Runtime v7.0.0ï¼›

å½“å·¥ç¨‹ä¸­ä½¿ç”¨äº†æ²¡æœ‰å¼•å…¥çš„ç¨‹åºé›†çš„å‘½åç©ºé—´æ—¶ï¼Œå°±ä¼šå¼•å‘ CS0234 ç¼ºå°‘ç¨‹åºé›†å¼•ç”¨ã€‚ç¼–è¯‘å™¨å‘½ä»¤å¼•å…¥ç¨‹åºé›†å‚è€ƒï¼š

    csc -lib:c:\ -reference:somelib.dll some.cs

å¦å¤–ï¼ŒWindows Package Manager (winget) å’Œ Windows Terminal æ˜¯ä¸é”™çš„ä¸¤æ¬¾å·¥å…·ã€‚

    winget search "sublime text"
    Name                Id                         Version      Source
    --------------------------------------------------------------------
    Sublime Text 4      SublimeHQ.SublimeText.4    4.0.0.412100 winget
    Sublime Text 3      SublimeHQ.SublimeText.3    3.2.2        winget

é…åˆ NuGet ç­‰ä¾èµ–ç®¡ç†å·¥å…·å®‰è£…ç¨‹åºåŒ…ï¼Œä»¥ä¸‹æ˜¯å„ç§å®‰è£…ä¾èµ–çš„æ–¹å¼ï¼Œå®‰è£… winget åå°±å¯ä»¥è°ƒç”¨ Install-Package å‘½ä»¤ï¼š

```py
# Package Manager (winget)
Install-Package Microsoft.WSMan.Runtime -Version 7.0.0

# .NET CLI
dotnet add package Microsoft.WSMan.Runtime --version 7.0.0

# PackageReference
<PackageReference Include="Microsoft.WSMan.Runtime" Version="7.0.0" />

# Paket CLI
paket add Microsoft.WSMan.Runtime --version 7.0.0

# Script & Interactive
#r directive can be used in F# Interactive, C# scripting and .NET Interactive. 
# Copy this into the interactive tool or source code of the script to reference the package.
#r "nuget: Microsoft.WSMan.Runtime, 7.0.0"

# Cake
# Install Microsoft.WSMan.Runtime as a Cake Addin
#addin nuget:?package=Microsoft.WSMan.Runtime&version=7.0.0

# Install Microsoft.WSMan.Runtime as a Cake Tool
#tool nuget:?package=Microsoft.WSMan.Runtime&version=7.0.0
```

Nuget å‘½ä»¤å‚è€ƒï¼š

```sh
NuGet Version: 6.1.0.106
usage: NuGet <command> [args] [options] 
Type 'NuGet help <command>' for help on a specific command.

Command Syntax:

 nuget add <packagePath> -Source <sourcePath> [options]
 nuget init <source> <destination> [options]
 nuget install <packageID | configFilePath> [options]
 nuget config -Set <name>=[<value>] [<name>=<value> ...] [options]
 nuget config -AsPath <name> [options]
 nuget delete <packageID> <packageVersion> [options]
 nuget list [search terms] [options]
 nuget locals <folder> [options]
 nuget mirror <packageID | configFilePath> <listUrlTarget> <publishUrlTarget> [options]
 nuget restore <projectPath> [options]
 nuget push <packagePath> [options]
 nuget pack <nuspecPath | projectPath> [options] [-Properties ...]

 nuget search [search terms] [options]
 nuget sources <operation> -Name <name> -Source <source>
 nuget spec [<packageID>] [options]
 nuget update <configPath> [options] 

 nuget setapikey <key> -Source <url> [options]
 nuget sign <package(s)> [options]
 nuget verify <-All|-Signatures> <package(s)> [options]
 nuget trusted-signers <list|add|remove|sync> [options]

Available commands:

 add            Adds the given package to a hierarchical source.

 client-certs   Provides the ability to manage list of client certificates located in NuGet.config files

 config         è·å–æˆ–è®¾ç½® NuGet é…ç½®å€¼ã€‚

 delete         ä»æœåŠ¡å™¨çš„æºåˆ—è¡¨ä¸­åˆ é™¤ç¨‹åºåŒ…ã€‚

 help (?)       æ˜¾ç¤ºä¸€èˆ¬å¸®åŠ©ä¿¡æ¯ï¼Œä»¥åŠæœ‰å…³å…¶ä»–å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ã€‚

 init           æ·»åŠ  <srcPackageSourcePath> ç›®å½•ä¸­æ‰€æœ‰åŒ…åˆ° <destPackageSourcePath>.

 install        å®‰è£…æŒ‡å®šçš„æºç¨‹åºåŒ…ï¼Œä¸æŒ‡å®šæºåˆ™ä½¿ç”¨ NuGet é…ç½®æ–‡ä»¶çš„æ‰€æœ‰æºï¼Œæˆ–ä½¿ç”¨ NuGet æºã€‚

 list           æ˜¾ç¤ºç»™å®šæºä¸­çš„ç¨‹åºåŒ…åˆ—è¡¨ã€‚
                å¦‚æœæœªæŒ‡å®šæºï¼Œåˆ™ä½¿ç”¨ %AppData%\NuGet\NuGet.config ä¸­å®šä¹‰çš„æ‰€æœ‰æºã€‚
                å¦‚æœ NuGet.config æœªæŒ‡å®šæºï¼Œåˆ™ä½¿ç”¨é»˜è®¤ NuGet æºã€‚

 locals         Clears or lists local NuGet resources 
                such as http requests cache, temp cache or machine-wide global packages folder.

 pack           åŸºäºæŒ‡å®šçš„ nuspec æˆ–é¡¹ç›®æ–‡ä»¶åˆ›å»º NuGet ç¨‹åºåŒ…ã€‚

 push           å°†ç¨‹åºåŒ…æ¨é€åˆ°æœåŠ¡å™¨å¹¶è¿›è¡Œå‘å¸ƒã€‚
                é€šè¿‡åŠ è½½ %AppData%\NuGet\NuGet.configï¼Œ
                ç„¶ååŠ è½½æ ¹ç›®å½•åˆ°å½“å‰ç›®å½•ä¸­ä»»ä½• nuget.config æˆ– .nuget\nuget.config é…ç½®ã€‚

 restore        è¿˜åŸ NuGet ç¨‹åºåŒ…ã€‚

 search         æœç´¢æŒ‡å®šæºä¸­çš„åŒ…ï¼ŒæœªæŒ‡å®šæºåˆ™ä½¿ç”¨ %AppData%\NuGet\NuGet.config é…ç½®ã€‚

 setApiKey      ä¿å­˜ç»™å®šæœåŠ¡å™¨ URL æ‰€å¯¹åº”çš„ API å¯†é’¥ã€‚å¦‚æœæœªæä¾› URLï¼Œåˆ™ä¿å­˜ NuGet åº“çš„ API å¯†é’¥ã€‚

 sign           ä½¿ç”¨æŒ‡å®šè¯ä¹¦ç­¾å NuGet åŒ…ã€‚

 sources        å¯ä»¥ç®¡ç†ä½äº %AppData%\NuGet\NuGet.config çš„æºåˆ—è¡¨

 spec           ä¸ºæ–°ç¨‹åºåŒ…ç”Ÿæˆ nuspecï¼Œåœ¨é¡¹ç›®(.csprojã€.vbprojã€.fsproj)æ–‡ä»¶å¤¹ä¸­è¿è¡Œï¼Œåˆ™åˆ›å»ºå·²æ ‡è®°åŒ–çš„ nuspec æ–‡ä»¶ã€‚

 trusted-signers ç®¡ç† trusted signers åˆ—è¡¨ã€‚

 update         å°†ç¨‹åºåŒ…æ›´æ–°åˆ°æœ€æ–°çš„å¯ç”¨ç‰ˆæœ¬ï¼Œè¿˜æ›´æ–° NuGet.exe æœ¬èº«ã€‚

 verify         éªŒè¯å·²ç­¾åçš„ NuGet åŒ…ã€‚
```



# =ğŸš© dotnet command
- https://docs.microsoft.com/en-us/aspnet/web-forms/overview/deployment/web-deployment-in-the-enterprise/understanding-the-project-file
- https://docs.microsoft.com/en-us/visualstudio/msbuild/how-to-use-project-sdk
- https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild-concepts

    >dotnet --help
    .NET Core SDK (3.0.100)
    ä½¿ç”¨æƒ…å†µ: dotnet [runtime-options] [path-to-application] [arguments]

    æ‰§è¡Œ .NET Core åº”ç”¨ç¨‹åºã€‚

    runtime-options:
      --additionalprobingpath <path>   è¦æ¢æµ‹çš„åŒ…å«æ¢æµ‹ç­–ç•¥å’Œç¨‹åºé›†çš„è·¯å¾„ã€‚
      --additional-deps <path>         æŒ‡å‘å…¶ä»– deps.json æ–‡ä»¶çš„è·¯å¾„ã€‚
      --fx-version <version>           è¦ç”¨äºè¿è¡Œåº”ç”¨ç¨‹åºçš„å®‰è£…ç‰ˆå…±äº«æ¡†æ¶çš„ç‰ˆæœ¬ã€‚
      --roll-forward <setting>         å‰æ»šè‡³æ¡†æ¶ç‰ˆæœ¬(LatestPatch, Minor, LatestMinor, Major, LatestMajor, Disable)ã€‚

    path-to-application:
      è¦æ‰§è¡Œçš„åº”ç”¨ç¨‹åº .dll æ–‡ä»¶çš„è·¯å¾„ã€‚

    ä½¿ç”¨æƒ…å†µ: dotnet [sdk-options] [command] [command-options] [arguments]

    æ‰§è¡Œ .NET Core SDK å‘½ä»¤ã€‚

    sdk-options:
      -d|--diagnostics  å¯ç”¨è¯Šæ–­è¾“å‡ºã€‚
      -h|--help         æ˜¾ç¤ºå‘½ä»¤è¡Œå¸®åŠ©ã€‚
      --info            æ˜¾ç¤º .NET Core ä¿¡æ¯ã€‚
      --list-runtimes   æ˜¾ç¤ºå®‰è£…çš„è¿è¡Œæ—¶ã€‚
      --list-sdks       æ˜¾ç¤ºå®‰è£…çš„ SDKã€‚
      --version         æ˜¾ç¤ºä½¿ç”¨ä¸­çš„ .NET Core SDK ç‰ˆæœ¬ã€‚

    SDK å‘½ä»¤:
      add               å°†åŒ…æˆ–å¼•ç”¨æ·»åŠ åˆ° .NET é¡¹ç›®ã€‚
      build             ç”Ÿæˆ .NET é¡¹ç›®ã€‚
      build-server      ä¸ç”±ç”Ÿæˆç‰ˆæœ¬å¯åŠ¨çš„æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚
      clean             æ¸…ç† .NET é¡¹ç›®çš„ç”Ÿæˆè¾“å‡ºã€‚
      help              æ˜¾ç¤ºå‘½ä»¤è¡Œå¸®åŠ©ã€‚
      list              åˆ—å‡º .NET é¡¹ç›®çš„é¡¹ç›®å¼•ç”¨ã€‚
      msbuild           è¿è¡Œ Microsoft ç”Ÿæˆå¼•æ“(MSBuild)å‘½ä»¤ã€‚
      new               åˆ›å»ºæ–°çš„ .NET é¡¹ç›®æˆ–æ–‡ä»¶ã€‚
      nuget             æä¾›å…¶ä»– NuGet å‘½ä»¤ã€‚
      pack              åˆ›å»º NuGet åŒ…ã€‚
      publish           å‘å¸ƒ .NET é¡¹ç›®è¿›è¡Œéƒ¨ç½²ã€‚
      remove            ä» .NET é¡¹ç›®ä¸­åˆ é™¤åŒ…æˆ–å¼•ç”¨ã€‚
      restore           è¿˜åŸ .NET é¡¹ç›®ä¸­æŒ‡å®šçš„ä¾èµ–é¡¹ã€‚
      run               ç”Ÿæˆå¹¶è¿è¡Œ .NET é¡¹ç›®è¾“å‡ºã€‚
      sln               ä¿®æ”¹ Visual Studio è§£å†³æ–¹æ¡ˆæ–‡ä»¶ã€‚
      store             åœ¨è¿è¡Œæ—¶åŒ…å­˜å‚¨ä¸­å­˜å‚¨æŒ‡å®šçš„ç¨‹åºé›†ã€‚
      test              ä½¿ç”¨ .NET é¡¹ç›®ä¸­æŒ‡å®šçš„æµ‹è¯•è¿è¡Œç¨‹åºè¿è¡Œå•å…ƒæµ‹è¯•ã€‚
      tool              å®‰è£…æˆ–ç®¡ç†æ‰©å±• .NET ä½“éªŒçš„å·¥å…·ã€‚
      vstest            è¿è¡Œ Microsoft æµ‹è¯•å¼•æ“(VSTest)å‘½ä»¤ã€‚

    æ†ç»‘å·¥å…·ä¸­çš„å…¶ä»–å‘½ä»¤:
      dev-certs         åˆ›å»ºå’Œç®¡ç†å¼€å‘è¯ä¹¦ã€‚
      fsi               å¯åŠ¨ F# äº¤äº’/æ‰§è¡Œ F# è„šæœ¬ã€‚
      sql-cache         SQL Server ç¼“å­˜å‘½ä»¤è¡Œå·¥å…·ã€‚
      user-secrets      ç®¡ç†å¼€å‘ç”¨æˆ·å¯†ç ã€‚
      watch             å¯åŠ¨æ–‡ä»¶è§‚å¯Ÿç¨‹åºï¼Œå®ƒä¼šåœ¨æ–‡ä»¶å‘ç”Ÿæ›´æ”¹æ—¶è¿è¡Œå‘½ä»¤ã€‚

    è¿è¡Œ "dotnet [command] --help"ï¼Œè·å–æœ‰å…³å‘½ä»¤çš„è¯¦ç»†ä¿¡æ¯ã€‚


é…ç½® deps.json, runtimeconfig.json ç”¨äºå¸®åŠ© dotnet è¿è¡Œ DLL åº”ç”¨ç¨‹åºã€‚

- deps.json æ˜¯ç”¨æ¥é…ç½®ä¾èµ–çš„ã€‚
- runtimeconfig.json å¯¹äº.NET Core åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯ç”¨æ¥é…ç½®è¿è¡Œæ—¶çš„ã€‚

.NET Core æ‰§è¡Œ Program.dll æ–‡ä»¶å¿…éœ€è¦å…ˆçŸ¥é“ DLL æ˜¯ä»€ä¹ˆç±»å‹ç¨‹åºï¼Œåˆ›å»ºåä¸º Program.runtimeconfig.json çš„æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å¦‚ä¸‹å†…å®¹ï¼š

    {
      "runtimeOptions": {
        "framework": {
          "name": "Microsoft.NETCore.App",
          "version": "3.1.0"
        }
      }
    }

è¿™äº›è®¾ç½®æŒ‡ç¤º dotnet ä½¿ç”¨ Microsoft.NETCore.App 3.1.0 å…±äº«æ¡†æ¶ã€‚è¯¥æ¡†æ¶ä¹Ÿæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ¡†æ¶ï¼Œè¿˜æœ‰å…¶å®ƒçš„æ¡†æ¶ï¼Œä¾‹å¦‚ Microsoft.AspNetCore.Web.Appã€‚ä¸åƒ .NET Framework æ˜¯è£…ä¸ªæœºå™¨èŒƒå›´ç”Ÿæ•ˆï¼Œå¯ä»¥æœ‰å¤šä¸ª .NET Core å…±äº«æ¡†æ¶å®‰è£…åœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œdotnet å°†è¯»å–è¯¥ JSON æ–‡ä»¶ï¼Œåœ¨ /usr/local/share/dotnet/shared/$FrameworkName/$Version/ ä¸­æŸ¥æ‰¾éœ€è¦çš„æ–‡ä»¶å¹¶è¿è¡Œåº”ç”¨ç¨‹åºã€‚

å¯¹äº .NET Core åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œruntime.config.json æ–‡ä»¶æ˜¯å¿…éœ€çš„ã€‚æœ¯è¯­ runtime ã€shared frameworkã€æˆ–è€… platform ç»å¸¸äº’æ¢ï¼Œä½†æ˜¯ï¼Œåœ¨è°ˆè®º .NET Core çš„æ—¶å€™ï¼Œå®ƒä»¬æ˜¯ä¸€å›äº‹ã€‚

deps.json æ˜¯ä¸€ä¸ªè®°å½• .NET Core ä¸­ä¾èµ–æ¸…å•çš„æ–‡ä»¶ï¼Œå‚è€ƒ deps.jsonï¼š

    {
      "runtimeTarget": {
        "name": ".NETCoreApp,Version=v2.0"
      },
      "runtimeOptions": {
        "additionalProbingPaths": [ "/Users/packages/" ]
      },
      "targets": {
        ".NETCoreApp,Version=v2.0": {
          "Newtonsoft.Json/10.0.3": {
            "runtime": {
              "lib/netstandard1.3/Newtonsoft.Json.dll": {
                "assemblyVersion": "10.0.0.0",
                "fileVersion": "10.0.3.21018"
              }
            }
          }
        }
      },
      "libraries": {
        "Newtonsoft.Json/10.0.3": {
          "type": "package",
          "serviceable": false,
          "sha512": ""
        }
      }
    }

ä½¿ç”¨ dotnet new å¯åˆ›å»ºçš„é¡¹ç›®æ¨¡æ¿ï¼š

    Templates                                         Short Name               Language          Tags
    ----------------------------------------------------------------------------------------------------------------------------------
    Console Application                               console                  [C#], F#, VB      Common/Console
    Class library                                     classlib                 [C#], F#, VB      Common/Library
    WPF Application                                   wpf                      [C#]              Common/WPF
    WPF Class library                                 wpflib                   [C#]              Common/WPF
    WPF Custom Control Library                        wpfcustomcontrollib      [C#]              Common/WPF
    WPF User Control Library                          wpfusercontrollib        [C#]              Common/WPF
    Windows Forms (WinForms) Application              winforms                 [C#]              Common/WinForms
    Windows Forms (WinForms) Class library            winformslib              [C#]              Common/WinForms
    Worker Service                                    worker                   [C#]              Common/Worker/Web
    Unit Test Project                                 mstest                   [C#], F#, VB      Test/MSTest
    NUnit 3 Test Project                              nunit                    [C#], F#, VB      Test/NUnit
    NUnit 3 Test Item                                 nunit-test               [C#], F#, VB      Test/NUnit
    xUnit Test Project                                xunit                    [C#], F#, VB      Test/xUnit
    Razor Component                                   razorcomponent           [C#]              Web/ASP.NET
    Razor Page                                        page                     [C#]              Web/ASP.NET
    MVC ViewImports                                   viewimports              [C#]              Web/ASP.NET
    MVC ViewStart                                     viewstart                [C#]              Web/ASP.NET
    Blazor Server App                                 blazorserver             [C#]              Web/Blazor
    ASP.NET Core Empty                                web                      [C#], F#          Web/Empty
    ASP.NET Core Web App (Model-View-Controller)      mvc                      [C#], F#          Web/MVC
    ASP.NET Core Web App                              webapp                   [C#]              Web/MVC/Razor Pages
    ASP.NET Core with Angular                         angular                  [C#]              Web/MVC/SPA
    ASP.NET Core with React.js                        react                    [C#]              Web/MVC/SPA
    ASP.NET Core with React.js and Redux              reactredux               [C#]              Web/MVC/SPA
    Razor Class Library                               razorclasslib            [C#]              Web/Razor/Library/Razor Class Library
    ASP.NET Core Web API                              webapi                   [C#], F#          Web/WebAPI
    ASP.NET Core gRPC Service                         grpc                     [C#]              Web/gRPC
    dotnet gitignore file                             gitignore                                  Config
    global.json file                                  globaljson                                 Config
    NuGet Config                                      nugetconfig                                Config
    Dotnet local tool manifest file                   tool-manifest                              Config
    Web Config                                        webconfig                                  Config
    Solution File                                     sln                                        Solution
    Protocol Buffer File                              proto                                      Web/gRPC

    Examples:
        dotnet new mvc --auth Individual
        dotnet new classlib --framework netcoreapp3.0
        dotnet new --help


# =ğŸš© Sublime Project Config

é…ç½®ä½ çš„ Sublime ç¼–è¯‘å·¥å…·ï¼Œå°† Sublime é¡¹ç›®æ–‡ä»¶ä¿å­˜åˆ° DotNet é¡¹ç›®ç›®å½•ä¸­ï¼Œè·¯å¾„å¯ä»¥ä½¿ç”¨ $project_path å¼•ç”¨ã€‚

åœ¨ä¸­æ–‡ç³»ç»Ÿä¸­æŒ‡å®š "encoding": "cp936" æˆ–è€… "utf8" é˜²æ­¢æ§åˆ¶å°ä¹±ç ï¼Œ"quiet": true åœ¨ç¼–è¯‘å‡ºé”™æ—¶ä¸è¾“å‡ºå½“å‰ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼Œfile_regex æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼ä»¥è·å–é”™è¯¯ä¿¡æ¯è¾“å‡ºçš„è¡Œå·ã€åˆ—å·å’Œé”™è¯¯æç¤ºï¼š

æŸ¥çœ‹å½“å‰å®‰è£…çš„ C# ç¼–è¯‘å™¨ä½ç½®åŠ C# ç‰ˆæœ¬æ”¯æŒï¼š

```sh
> whereis csc.exe
C:\Program Files (x86)\MSBuild\14.0\Bin\csc.exe 
C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe
C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\MSBuild\15.0\Bin\Roslyn\csc.exe
C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\Roslyn\csc.exe

> csc /? | findstr  "langversion Default"
 /langversion:<string>         Specify language version mode: ISO-1, ISO-2, 3, 
                               4, 5, 6, or Default
> &"C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe" /? |findstr "langversion Default"
/langversion:<å­—ç¬¦ä¸²>          æŒ‡å®šè¯­è¨€ç‰ˆæœ¬æ¨¡å¼: ISO-1ã€ISO-2ã€3ã€4ã€5 æˆ– Default
```

è¿˜å¯ä»¥åœ¨é¡¹ç›®æ–‡ä»¶ .csproj ä¸­æŒ‡å®š C# ç‰ˆæœ¬ï¼Œè®¾ç½®ä¸º preview è¡¨ç¤ºä½¿ç”¨å½“å‰æ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬ï¼š

```xml
<Project>
 <PropertyGroup>
   <LangVersion>preview</LangVersion>
    <LangVersion>9.0</LangVersion>
 </PropertyGroup>
</Project>
```

ç¼–è¯‘å™¨ä¸€èˆ¬éš Visual Studi å®‰è£…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ MSBuild å·¥å…·åŒ…å®‰è£…ï¼Œå½“ç„¶ç¼–è¯‘å™¨ä¹Ÿéœ€è¦å®‰è£…æ‰èƒ½ä½¿ç”¨ã€‚

Build Tools for Visual Studio 2017 å¯ä»¥æ”¯æŒ C# 7.0 ~ 7.3 ä»¥ä¸Šã€‚

ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ Build Tools for Visual Studio 2022ï¼Œå¯¹åº”å·¥å…·ç‰ˆæœ¬ MSVC v17.0ã€‚

ä»¥ä¸‹æ˜¯æ”¯æŒ C# è¯­è¨€ç‰ˆæœ¬ï¼š

```sh
> csc /langversion:?
æ”¯æŒçš„è¯­è¨€ç‰ˆæœ¬:
default
1  2  3  4  5  6  7.0  7.1  7.2  7.3  8.0  9.0  10.0 (default)
latestmajor
preview
latest
```

å®‰è£…å®Œ MSBuild å·¥å…·åŒ…ï¼Œä¼šç›¸åº”æä¾›ä¸€ä¸ªç¯å¢ƒé…ç½®è„šæœ¬ï¼ŒBAT è„šæœ¬æˆ– PowerShell è„šæœ¬ï¼Œåœ¨ä½¿ç”¨ç¼–è¯‘å·¥å…·æ—¶è¡Œæ‰§è¡Œå®ƒï¼š

```sh
# C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\
VsDevCmd.bat
Launch-VsDevShell.ps1
```

ä¸ºäº†é¿å… MSBuild æ‰¾ä¸åˆ°æŒ‡å®šçš„ SDKï¼Œæ¯”å¦‚ â€œMicrosoft.NET.Sdkâ€ï¼Œå¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­ç¼–è¾‘ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  MSBuildSDKsPath å˜é‡ï¼š

    vim .bashrc
    export MSBuildSDKsPath="/opt/dotnet/sdk/2.2.108/Sdks/"

MSBuild ä¼šé€šè¿‡è¿™ä¸ªè·¯å¾„æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶æŒ‡å®šçš„ SDKï¼Œå®ƒåº”è¯¥å¯¹åº”äº† SDKs è·¯å¾„ä¸­çš„ä¸€ä¸ªå­ç›®å½•ã€‚

æœ€å¥½çš„åšæ³•æ˜¯é€šè¿‡ dotnet new æ¥åˆ›å»ºé¡¹ç›®æ¨¡å—ï¼Œä»¥åŠä½¿ç”¨ dotnet msbuild å‘½ä»¤è°ƒç”¨æ„å»ºã€‚


ç”¨äº C# é¡¹ç›®çš„ Sublime ç¼–è¯‘å·¥å…·é…ç½®æ–‡ä»¶ï¼Œä¿å­˜åˆ°é…ç½®ç›®å½•ä¸‹çš„ sublime-build æ–‡ä»¶å³å¯ä»¥ä½¿ç”¨ï¼š

```json
// Preferences -> Browser Packages -> Users -> C#.sublime-build
{
    "env": {
        "libs":"-reference:netstandard.dll",
        "VCVARS": "C:/Program Files (x86)/Microsoft Visual Studio/2017/BuildTools/VC/Auxiliary/Build/vcvars64.bat",
        "VCVARS": "C:/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/Common7/Tools/VsDevCmd.bat",
        "VCVARS": "C:/Program Files (x86)/Microsoft Visual Studio/2019/Community/VC/Auxiliary/Build/vcvars64.bat",
        "MSBuildSDKsPath": "C:/Program Files/dotnet/sdk/6.0.102/sdks",
        "MSBuild": "\"C:/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/MSBuild/Current/Bin/MSBuild.exe\"",
    },
    "working_dir": "$file_path",
    "shell_cmd": "\"%VCVARS%\" & where csc && csc /langversion:? & where MSBuild & %MSBuild% /version",
    "file_regex": "^(.[^\\(]*)\\(([0-9]+),([0-9]+)\\):(.*)$",
    "selector": "source.cs, source.msbuild, text.xml, source.xaml, source.fsharp",
    "encoding": "gbk",
    "quiet": true,
    "variants": [
    {
        "name": "MSBuild proj",
        "shell_cmd": "\"%VCVARS%\" && %MSBuild% /maxcpucount:4 $file"
    },{
        "name": "MSBuild proj - DEBUG",
        "shell_cmd": "\"%VCVARS%\" && %MSBuild% /p:Configuration=DEBUG /maxcpucount:4 $file"
    },{
        "name": ".Net MSBuild Project",
        "shell_cmd": "dotnet msbuild \"$file\""
    },{
        "name": ".Net Run Project",
        "shell_cmd": "echo dotnet run --project \"$file_path\""
    },{
        "name": ".Net Watch Project",
        "shell_cmd": "dotnet watch run --project \"$file_path\""
    },{
        "name": "C# Build Exe & Run (C# 10.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:10.0 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 1.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:1 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 9.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:9.0 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 8.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:8.0 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 7.3)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:7.3 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 7.2)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:7.2 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 7.1)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:7.1 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 7.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:7.0 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 6.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:6 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 5.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:5 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 4.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:4 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 3.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:3 $file_name && $file_base_name"
    },{
        "name": "C# Build Exe & Run (C# 2.0)...",
        "shell_cmd": "\"%VCVARS%\" && where csc && csc.exe %libs% /langversion:2 $file_name && $file_base_name"
    },{
        "name": "C# Build DLL",
        "shell_cmd": "\"%VCVARS%\" && csc.exe /target:library $file"
    },{
        "name": "Run",
        "shell_cmd": "$file_base_name"
    },{
        "name": ".Net Info (SDKs & Runtimes List)",
        "shell_cmd": "dotnet --info & rem dotnet --list-sdks & dotnet --list-runtimes"
    },{
        "name": ".Net New Console",
        "shell_cmd": "dotnet new console -o demo"
    },{
        "name": ".Net Run",
        "shell_cmd": "dotnet run"
    },{
        "name": ".Net Watch",
        "shell_cmd": "dotnet watch run"
    },{
        "name": ".Net New - console",
        "shell_cmd": "dotnet new console"
    },{
        "name": ".Net New - winforms",
        "shell_cmd": "dotnet new winforms"
    },{
        "name": "Run with Test Arguments",
        "shell_cmd": "$file_base_name http://baidu.com/ http://golang.org/ http://goproxy.io"
    }]
}
```

# =ğŸš© Web Over HTTPS
- https://docs.microsoft.com/zh-cn/aspnet/core/security/enforcing-ssl?view=aspnetcore-3.1
- https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1
- https://forums.xamarin.com/discussion/90195/how-can-i-do-https-requests
- https://docs.microsoft.com/en-us/xamarin/cross-platform/app-fundamentals/transport-layer-security?tabs=windows

ä½¿ç”¨ dotnet dev-certs åˆ›å»ºå’Œç®¡ç†å¼€å‘è¯ä¹¦ï¼Œé»˜è®¤çš„ Web é¡¹ç›®åŸºäº HTTPS åè®®ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨å¯ä»¥ä½¿ç”¨ --no-https é€‰é¡¹ï¼š

    dotnet new webApp -o myWebApp --no-https

ä¹Ÿå¯ä»¥å»æ‰ --no-https å¯ç”¨è¯ä¹¦æ¨¡å¼ï¼Œå¹¶é€šè¿‡å‘½ä»¤ä¿¡ä»»å¼€å‘è¯ä¹¦ã€‚å·¥ç¨‹æ¨¡æ¿ä¼šä¸º Web åº”ç”¨æ·»åŠ ä¸€ä¸ª localhost è‡ªè®¤è¯è¯ä¹¦ï¼Œè¯ä¹¦åç§°ä¸º ASP.NET Core HTTPS development certificateã€‚

ç›¸å…³çš„ Startup é…ç½®ï¼š

    app.UseHsts();
    app.UseHttpsRedirection();

    services.AddHsts(options =>
    {
        options.Preload = true;
        options.IncludeSubDomains = true;
        options.MaxAge = TimeSpan.FromDays(60);
        options.ExcludedHosts.Add("example.com");
        options.ExcludedHosts.Add("www.example.com");
    });

    services.AddHttpsRedirection(options =>
    {
        options.RedirectStatusCode = StatusCodes.Status308PermanentRedirect;
        options.HttpsPort = 443;
    });

é€šè¿‡åœ¨ appsettings.json ä¸­æ·»åŠ é¡¶çº§æ¡ç›®ï¼š

    {
        "https_port": 443,
        "Logging": {
            "LogLevel": {
                "Default": "Information",
                "Microsoft": "Warning",
                "Microsoft.Hosting.Lifetime": "Information"
            }
        },
        "AllowedHosts": "*"
    }

ä¾¦å¬åœ°å€æˆ–ç«¯å£åœ¨ launchSetting.json è®¾ç½®ï¼š

    "applicationUrl": "http://*:5001;http://localhost:5000",


é…ç½® Kestrel æœåŠ¡æŒ‡å®šè¯ä¹¦æ–‡ä»¶çš„å‡ ç§æ–¹å¼ï¼š
    
    webBuilder.ConfigureKestrel(serverOptions =>
    {
        serverOptions.Listen(IPAddress.Loopback, 5001, 
            listenOptions =>
            {
                listenOptions.UseHttps("testCert.pfx", 
                    "testPassword");
            });
    });

    webBuilder.UseStartup<Startup>()
    .UseKestrel(options =>
    {
        // æŒ‡å®š pfx æ–‡ä»¶è·¯å¾„
        options.Listen(IPAddress.Parse("172.16.0.10"), 5002, listenOptions =>
        {
            listenOptions.UseHttps(pfx, "123456");
        });

        options.ConfigureHttpsDefaults(i =>
        {
            i.ServerCertificate = new System.Security.Cryptography.X509Certificates.X509Certificate2("./ssl.pfx", "123456");
        });

    })
    .UseContentRoot(Directory.GetCurrentDirectory())
    .UseUrls("https://*:443");


è‡ªè®¤è¯è¯ä¹¦ä¸è¢«ä¿¡ä»»ï¼Œå³è¯ä¹¦ä¸æ˜¯æœ‰æ­£è§„ CA æœºæ„é¢å‘ï¼Œç”±è‡ªå·±é€šè¿‡è¯ä¹¦ç”Ÿæˆå·¥å…·æˆ–å‘½ä»¤ç”Ÿæˆï¼ŒChrome æµè§ˆå™¨ä¼šæç¤ºé¡µé¢ä¸å®‰å…¨è€Œä¸ä¼šç›´æ¥è®¿é—®è¯¥é¡µé¢ã€‚

    NET::ERR_CERT_AUTHORITY_INVALID

å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨æä¾›çš„è¿™ä¸ªè‡ªç­¾åè¯ä¹¦å°±ä¼šæœ‰é—®é¢˜ã€‚ç”±äº CA æ ¹è¯ä¹¦ä¸åœ¨å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„å­˜å‚¨åŒºä¸­ï¼Œæ‰€ä»¥å®ƒä¸å—ä¿¡ä»»ã€‚æµè§ˆå™¨å°±ä¼šè®¤å®šæ˜¯ä¸å®‰å…¨çš„é“¾æ¥ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨å°†æœåŠ¡å™¨æä¾›çš„è¯ä¹¦å¯¼å‡ºï¼Œå®‰è£…åˆ°ç³»ç»Ÿçš„ä¿¡ä»»åˆ—è¡¨ï¼ŒChrome æµè§ˆå™¨å¯ä»¥åœ¨éšç§è®¾ç½®å’Œå®‰å…¨æ€§ç®¡ç†è¯ä¹¦ï¼Œå¯¼å…¥å¯¼å‡ºç­‰ï¼Œå®ƒç®¡ç†çš„æ˜¯ä¸ªäººè´¦æˆ·ä¸Šçš„è¯ä¹¦ã€‚

æˆ–è€…åœ¨å®¢æˆ·ç«¯å°†æœåŠ¡å™¨è¯ä¹¦å¯¼å…¥åˆ°å—ä¿¡ä»»æ ¹è¯ä¹¦é¢å‘æœºæ„åˆ—è¡¨ä¸­ï¼Œè¿™æ ·æµè§ˆå™¨å°±ä¼šå› ä¸ºè¿™æ˜¯ç³»ç»Ÿä¿¡ä»»çš„è¯ä¹¦è€Œè®¤ä¸ºé“¾æ¥æ˜¯å®‰å…¨çš„ã€‚

è®© Windows æ ¹æ®è¯ä¹¦ç±»å‹è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ä½ç½®æ—¶ï¼Œé€šå¸¸ä¼šå°†å¯¼å…¥åˆ°ä¸­é—´è¯ä¹¦é¢å‘æœºæ„åˆ†ç±»ä¸‹ã€‚

Windows è®¿é—®å‡­è¯è¯ä¹¦ç®¡ç†åœ¨ æ§åˆ¶é¢æ¿ - ç”¨æˆ·å¸æˆ·å’Œå®¶åº­å®‰å…¨ - å‡­æ®ç®¡ç†å™¨ã€‚å®Œæ•´çš„ç®¡ç†è¿è¡Œæœ¬åœ°è®¡ç®—æœºçš„è¯ä¹¦ç®¡ç†å·¥å…· certlm.msc æˆ–å½“å‰ç”¨æˆ·çš„è¯ä¹¦ç®¡ç†å·¥å…· certmgr.mscã€‚


é»˜è®¤çš„è‡ªç­¾è¯ä¹¦çš„å…³è”ä¸»æœºæ˜¯ localhostï¼Œå¦‚æœå¼€å‘éœ€è¦å¤šå°æœºå™¨è®¿é—®æœåŠ¡å™¨ï¼Œå¯èƒ½æŒ‡å®š IP è®¿é—®ï¼Œè¿™ä¼šå¯¼è‡´å®¢æˆ·ç«¯é“¾æ¥å¼‚å¸¸ï¼š

    Javax.Net.Ssl.SSLHandshakeException: java.security.cert.CertPathValidatorException

ç”Ÿæˆè‡ªç­¾åè¯ä¹¦åŠæ¸…é™¤è¯ä¹¦ï¼Œæ£€æŸ¥è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼š

    dotnet dev-certs https --trust
    dotnet dev-certs https --clean
    dotnet dev-certs https --check

åˆ›å»ºå¹¶å¯¼å‡ºè¯ä¹¦ï¼Œä½¿ç”¨å¯†ç åŠ å¯†ï¼Œå¯¼å‡ºçš„æ˜¯ä¸ªäººä¿¡æ¯äº¤æ¢æ ¼å¼ pfx æ–‡ä»¶ï¼š

    dotnet dev-certs https --export-path localhost.pfx --password 123456

å¯¼å‡ºè¯ä¹¦å¯ä»¥é€šè¿‡ OpenSSL è¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œè¾“å…¥å¯†ç æ“ä½œï¼š

    openssl pkcs12 -in localhost.pfx -out localhost.pem -nodes
    
    >openssl verify localhost.pem
    localhost.pem: /CN=localhost
    error 20 at 0 depth lookup:unable to get local issuer certificate


Windows æä¾›çš„å¼€å‘å·¥å…·ä¼šæä¾› makecert å‘½åæ¥ç”Ÿæˆè¯ä¹¦ï¼š

    makecert -r -pe -n "CN=localhost" -b 01/01/2000 -e 01/01/2036 -eku 1.3.6.1.5.5.7.3.1 -ss my -sr localMachine -sky exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12

    makecert.exe â€“pe -r  â€“n  "CN=localhost" -ss my -sr LocalMachine -a sha1 -len 2048  MyCA.cer

å‚æ•°è§£æï¼š

`-n` æŒ‡å®šä¸»é¢˜çš„åå­—ï¼Œå›ºå®šæ ¼å¼ï¼ŒCN=ä¸»é¢˜åå­—ï¼ŒCN - Certificate Name å³è¢«è®¤è¯æ–¹åå­—ã€‚è¿™é‡Œå¯ä»¥æŒ‡å®šä¸€äº›ä¸»é¢˜çš„å…¶å®ƒé™„åŠ ä¿¡æ¯ï¼Œä¾‹å¦‚ O= *** è¡¨ç¤ºç»„ç»‡ä¿¡æ¯ç­‰ç­‰ã€‚

`-r` åˆ›å»ºè‡ªç­¾ç½²è¯ä¹¦ï¼Œæ„æ€å°±æ˜¯è¯´åœ¨ç”Ÿæˆè¯ä¹¦æ—¶ï¼Œå°†è¯ä¹¦çš„å‘å¸ƒæœºæ„è®¾ç½®ä¸º CNã€‚

`-pe` å°†æ‰€ç”Ÿæˆçš„ç§é’¥æ ‡è®°ä¸ºå¯å¯¼å‡ºã€‚æ³¨æ„ï¼ŒæœåŠ¡å™¨å‘é€è¯ä¹¦ç»™å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åªèƒ½ä»è¯ä¹¦é‡Œé¢è·å–å…¬é’¥ï¼Œç§é’¥æ˜¯æ— æ³•è·å–çš„ã€‚å¦‚æœæˆ‘ä»¬æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œè¯ä¹¦åœ¨å®‰è£…åœ¨æœºå™¨ä¸Šåï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»è¯ä¹¦ä¸­å¯¼å‡ºç§é’¥ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸èƒ½å¯¼å‡ºç§é’¥çš„ã€‚æ­£è§„çš„é€”å¾„å‘å¸ƒçš„è¯ä¹¦ï¼Œæ˜¯ä¸å¯èƒ½è®©ä½ å¯¼å‡ºç§é’¥çš„ã€‚

`-b` `â€“e` è¯ä¹¦çš„æœ‰æ•ˆæœŸ

`-ss` è¯ä¹¦çš„å­˜å‚¨åç§°ï¼Œå°±æ˜¯ windows è¯ä¹¦å­˜å‚¨åŒºçš„ç›®å½•åï¼Œå¦‚æœä¸å­˜åœ¨åœ¨çš„è¯å°±åˆ›å»ºä¸€ä¸ªã€‚

`-sr` è¯ä¹¦çš„å­˜å‚¨ä½ç½®ï¼Œåªæœ‰currentuserï¼ˆé»˜è®¤å€¼ï¼‰æˆ– localmachineä¸¤ä¸ªå€¼ã€‚

`-sv` æŒ‡å®šä¿å­˜ç§é’¥çš„æ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œé¢é™¤äº†åŒ…å«ç§é’¥å¤–ï¼Œå…¶å®ä¹ŸåŒ…å«äº†è¯ä¹¦ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯éœ€è¦ä¿å¯†çš„ï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨æœåŠ¡ç«¯é…ç½®æ—¶æ˜¯éœ€è¦ç”¨åˆ°çš„ã€‚

`-a` æŒ‡å®šç­¾åç®—æ³•ï¼Œå¿…é¡»æ˜¯ md5 æˆ– rsa1ã€‚

`-in` æŒ‡å®šè¯ä¹¦å‘å¸ƒæœºæ„çš„åç§°

`-len` è¿™ä¸ªå‚æ•°åœ¨ä¸­æ–‡çš„å¸®åŠ©æ–‡æ¡£ä¸­å¥½åƒæ²¡æœ‰æåˆ°ï¼Œä½†æ˜¯è¿™ä¸ªå…¶å®å¾ˆé‡è¦ï¼Œç”¨äºæŒ‡å®šå…¬é’¥çš„ä½æ•°ï¼Œè¶Šå¤§è¶Šå®‰å…¨ï¼Œé»˜è®¤å€¼æ˜¯1024ï¼Œæ¨è2048ã€‚æˆ‘è¯•äº†ä¸‹ï¼Œè¿™ä¸ªä¸ä¸º1024çš„å€æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚


ä½¿ç”¨ OpenSSL å·¥å…·ç®±ç”Ÿæˆè‡ªç­¾è¯ä¹¦çš„å„æ­¥éª¤ï¼Œä½œä¸ºè¢«è®¤è¯æ–¹ï¼Œå…ˆè¦æœ‰è‡ªå·±çš„ RSA å¯†é’¥å¯¹ï¼Œå†ç”Ÿæˆç›¸åº”çš„è¯è®¤è¯è¯·è¯·æ±‚æ–‡ä»¶ï¼Œå†äº¤ç»™ CA è®¤è¯ã€‚ä½œä¸ºè‡ªç­¾è¯è¯ä¹¦ï¼Œé¦–å…ˆå°±æ˜¯å‡†å¤‡è‡ªå·±çš„è¯ä¹¦ä½œä¸ºæ ¹è¯ä¹¦ï¼Œå†ç”¨è‡ªå·±çš„è¯ä¹¦å»è®¤è¯ã€‚

å…ˆä¸º Root CA æœºæ„ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªå¯†ç çŸ­è¯­ï¼š

    openssl genrsa -des3 -out ca.key

ç„¶åç”Ÿæˆ CA çš„è¯ä¹¦è¯·æ±‚æ–‡ä»¶ CSR - Certificate Signing Requestï¼š

    openssl req -new -key ca.key -out ca.csr


å†æŒ‰ -x509 æ ¼å¼äº§ç”Ÿè‡ªç­¾åçš„è¯ä¹¦ crtï¼š

    openssl x509 -req -days 731 -sha1 -extensions v3_cs -signkey ca.key -in ca.csr -out ca.crt

æ¥ä¸‹æ¥ï¼ŒæŒ‰åŒæ ·çš„æ“ä½œï¼Œåˆ©ç”¨å‰é¢ç”Ÿæˆçš„ CA è¯ä¹¦æ¥ä¸ºå…¶å®ƒç”³è¯·è€…æä¾›è¯ä¹¦ç­¾åæœåŠ¡ï¼Œä¸ºè¯ä¹¦è¯·æ±‚æ–¹ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼Œè¿™é‡Œä½¿ç”¨ 2048 ä½å¯†ç é•¿åº¦ï¼Œå‰é¢ä½¿ç”¨é»˜è®¤ 512 ä½å¯†ç ã€‚ä½æ•°å¤ªä½å¯èƒ½è¢«è®¤ä¸ºè¯ä¹¦æ˜¯ä¸€ä¸ªæ— æ•ˆçš„æ•°å­—ç­¾åã€‚

ç„¶åå†ç”Ÿæˆè¯ä¹¦è®¤è¯è¯·æ±‚æ–‡ä»¶ï¼Œéœ€è¦å‰é¢è®¾ç½®çš„å¯†ç çŸ­è¯­ï¼ŒæŒ‰è¦æ±‚è¾“å…¥è¯ä¹¦ç”³è¯·æ–¹ä¿¡æ¯ï¼š

    openssl genrsa -des3 -out server.key 2048
    
    openssl req -new -key server.key -out server.req
    
    openssl x509 -req -days 731 -sha1 -extensions v3_req -CA ca.crt -CAkey ca.key -CAserial ca.srl -CAcreateserial -in server.req -out server.crt

    openssl pkcs12 -export -in server.crt -inkey server.key -out server.pfx


å¯ä»¥é€šè¿‡ -subj å‚æ•°ä¼ å…¥è®¤è¯è¯·æ±‚æ–¹ä¿¡æ¯ï¼Œè¿å¸¦å¯†ç ç”Ÿæˆä¸€æ­¥æ“ä½œç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼š

    openssl req -newkey rsa:2048 -nodes -keyout ca.key -x509 -days 731 -out ca.crt -subj "/C=CN/ST=GD/L=HY/O=Xamarin/OU=Tech./CN=Xamware/emailAddress=jeango@gmail.com"

ä¸€æ­¥ç”Ÿæˆè¯ä¹¦å¯†é’¥åŠè¯·æ±‚æ–‡ä»¶ï¼Œæ³¨æ„ç»™ç½‘ç«™ä½¿ç”¨çš„è¯ä¹¦è¦ç¡®ä¿ CN ä¸ºåŸŸåæˆ– IP åœ°å€ï¼š

    openssl req -newkey rsa:2048 -nodes -keyout server.key -days 731 -out server.csr -subj "/C=CN/ST=GD/L=HY/O=xamarin.com/OU=Tech./CN=xamware.com/emailAddress=jeango@xamware.com"


å¯¹è¯ä¹¦è¯·è¿›è¡Œç­¾åï¼š

    openssl x509 -req -days 731 -in server.csr -CA ca.crt -CAkey ca.key -passin pass:123456 -CAcreateserial -out server.crt

è­¬å¦‚ï¼Œç»™æœ¬åœ°ä¸»æœºç­¾å‘è¯ä¹¦ï¼Œå¹¶è½¬æ¢æ ¼å¼ï¼š

    openssl req -newkey rsa:2048 -nodes -keyout localhost.key -days 731 -out localhost.csr -subj "/C=CN/ST=GD/L=HY/O=xamarin.com/OU=Tech./CN=localhost/emailAddress=jeango@xamware.com"

    openssl x509 -req -days 731 -in localhost.csr -CA ca.crt -CAkey ca.key -passin pass:123456 -CAcreateserial -out localhost.crt

    openssl pkcs12 -export -in localhost.crt -inkey localhost.key -out localhost.pfx

ç§ç­¾è¯ä¹¦åœ¨ Xamarin Android åº”ç”¨ä¸Šï¼Œè¿˜ä¼šå¼•å‘è¯ä¹¦ä¿¡ä»»é“¾å¼‚å¸¸ï¼š

    CertPathValidatorException: Trust anchor for certification path not found.

éœ€è¦åœ¨ Android ä¸Šå®‰è£…è¯ä¹¦ï¼ŒSettings - Security & Location - Advanced - Encryption & credentialsã€‚


å‘½ä»¤å‚è€ƒï¼š

    >dotnet dev-certs https --help

    Usage: dotnet dev-certs https [options]

    Options:
      -ep|--export-path  Full path to the exported certificate
      -p|--password      Password to use when exporting the certificate with the private key into a pfx file
      -c|--check         Check for the existence of the certificate but do not perform any action
      --clean            Cleans all HTTPS development certificates from the machine.
      -t|--trust         Trust the certificate on the current platform
      -v|--verbose       Display more debug information.
      -q|--quiet         Display warnings and errors only.
      -h|--help          Show help information




# =ğŸš© Start Coding

- [ASP.Net Core ç±»åº“ç»“æ„](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/target-aspnetcore?view=aspnetcore-3.1)
- [Blazor åº”ç”¨](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/build-your-first-blazor-app?view=aspnetcore-3.1)
- [Razor Page Web åº”ç”¨](https://docs.microsoft.com/zh-cn/aspnet/core/razor-pages/?view=aspnetcore-3.1)
- [ASP.NET Core Razor æ–‡ä»¶ç¼–è¯‘](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/view-compilation?view=aspnetcore-3.1)
- [ASP.NET Core MVC Web åº”ç”¨](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-mvc-app/start-mvc?view=aspnetcore-3.1)
- [ASP.NET documentation](https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-3.1)
- [Windows åº”ç”¨å¼€å‘äººå‘˜æ–‡æ¡£](https://docs.microsoft.com/zh-cn/windows/apps/)
- [Windows Universal Samples](https://github.com/Microsoft/Windows-universal-samples)
- [Create a Razor Pages web app with ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/tutorials/razor-pages/?view=aspnetcore-3.1)
- [Create your first C# app](https://docs.microsoft.com/en-us/visualstudio/get-started/csharp/tutorial-console?view=vs-2019)
- [Create a web app](https://docs.microsoft.com/en-us/visualstudio/get-started/csharp/tutorial-aspnet-core?view=vs-2019)
- [Create a UWP app](https://docs.microsoft.com/en-us/visualstudio/get-started/csharp/tutorial-uwp?view=vs-2019)
- [Create a WPF application](https://docs.microsoft.com/en-us/visualstudio/get-started/csharp/tutorial-wpf?view=vs-2019)
- [Create a Windows Forms app](https://docs.microsoft.com/en-us/visualstudio/ide/create-csharp-winform-visual-studio?view=vs-2019)
- [Create React App](https://create-react-app.dev/docs/getting-started/)

å¼€å§‹ä½ çš„ä»£ç ï¼š

    using System;

    namespace myApp
    {
        class Program
        {
            static void Main(string[] args)
            {
                Console.WriteLine("Hello World!");
            }
        }
    }

    csc /lib:"C:\Program Files\dotnet\packs\Microsoft.AspNetCore.App.Ref\3.1.2\ref\netcoreapp3.1" /reference:Microsoft.AspNetCore.dll /reference:Microsoft.AspNetCore.Hosting.dll coding.cs

ä½¿ç”¨å‘½ä»¤åˆ›å»ºé¡¹ç›®ï¼Œç„¶å dotnet run è¿è¡Œï¼Œæˆ–è€…ç›‘è§†æ”¹åŠ¨å³é‡æ–°ç¼–è¯‘è¿è¡Œ dotnet watch runï¼š

    >dotnet new console -o csdemo
    >dotnet new console -n csdemo -o .

æˆ–æŒ‡å®šä½¿ç”¨å·²å®‰è£…çš„æ¡†æ¶ç‰ˆæœ¬åˆ›å»ºç±»åº“ï¼š

    >dotnet new classlib --framework netstandard2.1
    >dotnet new classlib --framework netcoreapp3.0

è¦åˆ›å»º Web åº”ç”¨ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œç„¶åæ‰§è¡Œ dotnet run è¿è¡Œï¼ŒASP.NET å¯ä»¥é…åˆ Razor Pages è¿™ä¸ªå†…ç½® MVC æ¡†æ¶å¼€å‘ Web åº”ç”¨ï¼š

    dotnet new webApp -o myWebApp --no-https

    dotnet new webApp -o myWebApp
    dotnet dev-certs https --trust

Web åº”ç”¨çš„æ‰€æœ‰æ–‡æ¡£éƒ½åœ¨ ASP.NET æ–‡æ¡£ï¼ŒåŒ…å«æ•™ç¨‹ã€ç¤ºä¾‹ä»£ç ã€åŸºç¡€çŸ¥è¯†ã€API å‚è€ƒï¼Œå¯ä»¥äº†è§£å¦‚ä½•ä½¿ç”¨ ASP.NET Core åˆ›å»ºå¿«é€Ÿã€å®‰å…¨ã€è·¨å¹³å°å’ŒåŸºäºäº‘çš„ Web åº”ç”¨å’ŒæœåŠ¡ï¼Œä»¥åŠä½¿ç”¨ SignalR çš„å®æ—¶æ¶ˆæ¯æ¨é€åº”ç”¨ï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ (RPC) åº”ç”¨ï¼ŒRESTful Web API åº”ç”¨ç­‰ã€‚

è¿˜æœ‰ç»„ä»¶åŒ–çš„ Blazor æ¡†æ¶ç»“åˆ WebAssembly å°±å¯ä»¥ç”¨ C# æ¥å®ç°äº¤äº’å¼å®¢æˆ·ç«¯ Web UIï¼Œå®ƒåŸºäº SignalR å³ WebSocket æŠ€æœ¯å®ç°æ¶ˆæ¯æ¨é€ï¼Œé«˜æ•ˆè·¨å¹³å°ã€‚


ASP.NET Core åº”ç”¨æä¾›äº†ä¾¿æ·çš„ç»„ä»¶åŒ–å®¢æˆ·ç«¯å¼€å‘æ¨¡æ¿ï¼Œå¦‚æœå·²å®‰è£… ASP.NET Core 2.1ï¼Œåˆ™åŒ…å«äº† Angular æˆ– React æ¡†æ¶ã€‚

æ›´æ–°çš„ Angular é¡¹ç›®æ¨¡æ¿ä¸ºä½¿ç”¨ Angular å’Œ Angular CLI å®ç°ä¸°å¯Œçš„å®¢æˆ·ç«¯ç”¨æˆ·ç•Œé¢ (UI) çš„ ASP.NET Core åº”ç”¨æä¾›äº†ä¾¿æ·èµ·ç‚¹ã€‚

è¯¥æ¨¡æ¿ç­‰åŒäºåˆ›å»ºç”¨ä½œ API åç«¯çš„ ASP.NET Core é¡¹ç›®ï¼Œè€Œ Angular CLI é¡¹ç›®ç”¨ä½œ UIã€‚ è¯¥æ¨¡æ¿æä¾›åœ¨å•ä¸ªåº”ç”¨é¡¹ç›®ä¸­æ‰˜ç®¡ä¸¤ç§é¡¹ç›®ç±»å‹çš„ä¾¿åˆ©ã€‚ å› æ­¤ï¼Œåº”ç”¨é¡¹ç›®å¯ä»¥ä½œä¸ºå•ä¸ªå•å…ƒæ¥ç”Ÿæˆå’Œå‘å¸ƒã€‚

    dotnet new angular -o netcoreAngular
    cd my-new-app

æ›´æ–°çš„ React é¡¹ç›®æ¨¡æ¿ä¸ºä½¿ç”¨ React å’Œ create-react-app (CRA) çº¦å®šå®ç°ä¸°å¯Œçš„å®¢æˆ·ç«¯ç”¨æˆ·ç•Œé¢ (UI) çš„ ASP.NET Core åº”ç”¨ç¨‹åºæä¾›äº†ä¾¿æ·èµ·ç‚¹ã€‚

è¯¥æ¨¡æ¿ç­‰åŒäºåˆ›å»ºä¸¤ä¸ªé¡¹ç›®ï¼Œå³ç”¨ä½œ API åç«¯çš„ ASP.NET Core é¡¹ç›®å’Œç”¨ä½œ UI çš„æ ‡å‡† CRA React é¡¹ç›®ï¼Œä½†å‡å¯åœ¨å¯ä»¥ç”Ÿæˆå¹¶å‘å¸ƒä¸ºå•ä¸ªå•å…ƒçš„å•ä¸ªåº”ç”¨ç¨‹åºé¡¹ç›®ä¸­è¿›è¡Œæ‰˜ç®¡ã€‚ClientApp ç›®å½•æ˜¯æ ‡å‡†çš„ CRA React åº”ç”¨ã€‚ 

æ­¤æ¨¡æ¿åˆ›å»ºçš„ React åº”ç”¨ä¸ CRA è‡ªèº«åˆ›å»ºçš„åº”ç”¨ä¹‹é—´å­˜åœ¨ç»†å¾®å·®å¼‚ï¼›ä½†æ˜¯ï¼Œè¯¥åº”ç”¨çš„åŠŸèƒ½æœªå˜ã€‚ è¯¥æ¨¡æ¿åˆ›å»ºçš„åº”ç”¨åŒ…å«åŸºäº Bootstrap çš„å¸ƒå±€å’ŒåŸºæœ¬è·¯ç”±ç¤ºä¾‹ã€‚

React é¡¹ç›®æ¨¡æ¿ä¸é€‚ç”¨äºæœåŠ¡å™¨ç«¯å‘ˆç° (SSR)ã€‚ å¯¹äºå¸¦æœ‰ React å’Œ Node.js çš„ SSRï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Next.js æˆ– Razzleã€‚

    dotnet new react -o netcoreReact
    cd my-new-app

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨åœ¨ä¸ºå¼€å‘äººå‘˜ä¹‹ä¾¿è€Œä¼˜åŒ–çš„æ¨¡å¼ä¸‹è¿è¡Œã€‚ ä¾‹å¦‚ï¼ŒJavaScript æ†ç»‘åŒ…åŒ…å«æºæ˜ å°„ï¼Œè¿™æ ·åœ¨è°ƒè¯•æ—¶å¯ä»¥æŸ¥çœ‹åŸå§‹ TypeScript ä»£ç ã€‚ è¯¥åº”ç”¨ç›‘è§†ç£ç›˜ä¸Šçš„ TypeScriptã€HTML å’Œ CSS æ–‡ä»¶æ›´æ”¹ï¼Œå¹¶åœ¨çœ‹åˆ°è¿™äº›æ–‡ä»¶æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡æ–°åŠ è½½ã€‚

åœ¨ç”Ÿäº§ä¸­ï¼Œæä¾›é’ˆå¯¹æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–çš„åº”ç”¨ç‰ˆæœ¬ã€‚ è¯¥æ“ä½œè¢«é…ç½®ä¸ºè‡ªåŠ¨å‘ç”Ÿã€‚ å‘å¸ƒæ—¶ï¼Œç”Ÿæˆé…ç½®ä¼šå‘å‡ºé¢„å…ˆ (AoT) ç¼–è¯‘çš„å‹ç¼©å®¢æˆ·ç«¯ä»£ç ç‰ˆæœ¬ã€‚ ä¸å¼€å‘ç‰ˆæœ¬ä¸åŒï¼Œç”Ÿäº§ç‰ˆæœ¬ä¸éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Node.jsï¼Œé™¤éå·²å¯ç”¨æœåŠ¡å™¨ç«¯å‘ˆç° (SSR)ã€‚

å¦‚æœä¸º Angular åº”ç”¨å…¨å±€å®‰è£…äº† ng å·¥å…·ï¼Œåˆ™å¯ä»¥è¿è¡Œå…¶ä»»ä½•å‘½ä»¤ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿è¡Œ ng lintã€ng test æˆ–ä»»ä½•å…¶ä»– Angular CLI å‘½ä»¤ã€‚ ä¸è¿‡æ— éœ€è¿è¡Œ ng serveï¼Œå› ä¸º ASP.NET Core åº”ç”¨ä¸ºåº”ç”¨çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éƒ¨åˆ†æä¾›æœåŠ¡ã€‚ åœ¨å†…éƒ¨ï¼Œå®ƒåœ¨å¼€å‘ä¸­ä½¿ç”¨ ng serveã€‚

å¦‚æœæœªå®‰è£… ng å·¥å…·ï¼Œè¯·æ”¹ä¸ºè¿è¡Œ npm run ngã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿è¡Œ npm run ng lint æˆ– npm run ng testã€‚


æ ¹æ®å®¢æˆ·ç«¯é¡¹ç›®éœ€è¦è¦å®‰è£…ç¬¬ä¸‰æ–¹ npm ç¨‹åºåŒ…ï¼Œå®‰è£…å®¢æˆ·ç«¯ä¾èµ–æ¨¡å—ä»¥è¿è¡Œ ClientAppï¼Œè¿›å…¥å®¢æˆ·ç«¯é¡¹ç›®ç›®å½• ClientApp æ‰§è¡Œå‘½ä»¤ï¼š

    npm install --save
    npm install --save <package_name>


è¦å¼€å‘æ¡Œé¢ç¨‹åºå¯ä»¥é€‰æ‹© WPF Application æˆ– Windows Forms Applicationã€‚

WPF - Windows Presentation Foundation ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨ Windows ä¸Šæ„å»ºä¸šåŠ¡çº¿æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œå¼ºåº¦äºéå‡¡è§†è§‰æ•ˆæœã€‚WPF çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸åˆ†è¾¨ç‡æ— å…³ä¸”åŸºäºçŸ¢é‡çš„å‘ˆç°å¼•æ“ï¼Œæ—¨åœ¨å……åˆ†åˆ©ç”¨ç°ä»£å›¾å½¢ç¡¬ä»¶ã€‚ WPF é€šè¿‡ä¸€å¥—å®Œå–„çš„åº”ç”¨ç¨‹åºå¼€å‘åŠŸèƒ½å¯¹è¯¥æ ¸å¿ƒè¿›è¡Œäº†æ‰©å±•ï¼Œè¿™äº›åŠŸèƒ½åŒ…æ‹¬å¯æ‰©å±•åº”ç”¨ç¨‹åºæ ‡è®°è¯­è¨€ (XAML)ã€æ§ä»¶ã€æ•°æ®ç»‘å®šã€å¸ƒå±€ã€äºŒç»´å’Œä¸‰ç»´å›¾å½¢ã€åŠ¨ç”»ã€æ ·å¼ã€æ¨¡æ¿ã€æ–‡æ¡£ã€åª’ä½“ã€æ–‡æœ¬å’Œç‰ˆå¼ã€‚ WPF å±äº .NETï¼Œå› æ­¤å¯ä»¥ç”Ÿæˆæ•´åˆ .NET API å…¶ä»–å…ƒç´ çš„åº”ç”¨ç¨‹åºã€‚

ä»å‘å±•ä¸Šæ¥çœ‹ï¼Œå°è£… WIN32 API çš„ MFC - Microsoft Foundation Classes æ˜¯æœ€å…ˆæµè¡Œçš„æ¡†æ¶ï¼Œç„¶åå†æœ‰ Windows Forms çš„å°è£…ã€‚

æ’‡å¼€ QT/Electron ç­‰ç¬¬ä¸‰æ–¹ GUI æ¡†æ¶ä¸è°ˆï¼ŒUWP è¿˜ä¸æ”¯æŒä¼¼ä¹ä¹Ÿæ˜¯å‡‰å‡‰çš„ï¼Œè¿™é‡Œ WPF/WinForms ä¸¤ä¸ª GUI æ¡†æ¶ä½œä¸€ä¸ªå¯¹æ¯”ï¼š

    dotnet new wpf
    dotnet new winforms

- HTML5 ç§»åŠ¨äº’è”ç½‘å…´èµ·ï¼Œæ¡Œé¢ç¨‹åºä»½é¢ç¼©å°æ˜¯äº‹å®ï¼ŒASP.NET Core + TypeScript å¯ä»¥æï¼ŒReact/Angular/Vue é€‰æ‹©å¤šï¼›
- WinForm å¯ä»¥è¯´æ˜¯ MFC çš„ä¸‹ä¸€ä»£æ¡†æ¶ï¼Œä» MFC è§’åº¦çœ‹å¾ˆå®Œç¾ï¼Œä¸è®ºæ˜¯æ§ä»¶çš„æ‹–åŠ¨è¿˜æ˜¯ WIN32 çš„å°è£…ï¼›
- WinForm ç®€å•å¥½ç”¨å¯åŠ¨è¿…é€Ÿï¼Œä¸åŠ WPF å¤æ‚ï¼Œæ€§èƒ½ä½ä¸‹ï¼›
- WPF æ˜¯æ–°æ¦‚å¿µæ¡†æ¶ï¼Œç•Œé¢ä¸é€»è¾‘åˆ†ç¦»ï¼Œ3D/2D ç•Œé¢å¯ä»¥ DX ç»˜åˆ¶ï¼ŒXAML åŠ¨æ€å¸ƒå±€ï¼Œè¿˜æœ‰ MVVMï¼›
- WPF è§¦æ§æ”¯æŒè¾ƒå¥½ï¼ŒçŸ¢é‡ç»„å›¾æ–¹ä¾¿ï¼Œæä¾›é…·ç‚«çš„æ§ä»¶ï¼Œè‡ªå¸¦é€šç”¨çš„åŠ¨ç”»ï¼›
- ä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œæ¡Œé¢ç¨‹åºåŸºæœ¬æœåŠ¡ç”Ÿäº§ï¼Œç”¨æˆ·åªåœ¨ä¹å¥½ä¸å¥½ç”¨(WinForm)ï¼Œä¸ç®¡å¥½ä¸å¥½çœ‹(WPF)ï¼›
- WPF æ¦‚å¿µæ³›æ»¥ï¼Œæ¯”å¦‚åŒå‘ç»‘å®š button ç»‘å®šæ ‡é¢˜ï¼Œå¯¹ VUE æ¡†æ¶å°±æ˜¯ä¸ªå­—ç¬¦ä¸²ç»‘å®šï¼Œè€Œ WPF å°±æ˜¯å†…å®¹å¯¹è±¡ç»‘å®šï¼ŒäºŒè€…çš„å·®è·å°±æ˜¯ 1 vs 10 è¡Œä»£ç çš„å·®è·ï¼Œè¿™å¯ä¸æ˜¯ä¸€ä»¶å¥½äº‹ã€‚åŒæ—¶ï¼Œé«˜æ€§èƒ½çš„è½¯ä»¶ä¸ä¼šç”¨.netè¿™ç§æ‰˜ç®¡è¯­è¨€ï¼›

å¦‚æœä½¿ç”¨ Visual Studio å°±å¯ä»¥åˆ©ç”¨å¯è§†åŒ–çš„æ‹–æ‹½è®¾è®¡ç•Œé¢ï¼Œä½¿ç”¨ VSCode æˆ– Sublime å°±æ‰‹å†™ä»£ç ã€‚VSCode æœ¬èº«ä¹Ÿæ”¯æŒè°ƒè¯•å’Œè‡ªåŠ¨æç¤ºåŠŸèƒ½ï¼Œè¿™ä¸ªåŸºäº Electron å¼€å‘çš„å·¥å…·çœŸçš„æ˜¯ Visual Studio å®Œç¾æ›¿ä»£ã€‚

æ³¨æ„ï¼ŒWPF/WinForms éƒ½ä¸æ˜¯è·¨å¹³å°çš„æ¡†æ¶ï¼Œè¦è·å–è·¨å¹³å°çš„ç§»åŠ¨ç«¯å¼€å‘èƒ½åŠ›ï¼Œä½¿ç”¨å“²é©¬æ— xamarin æ¡†æ¶ã€‚



# =ğŸš© WinForm Application Startup
- [Creating Event Handlers in Windows Forms](https://docs.microsoft.com/en-us/dotnet/framework/winforms/creating-event-handlers-in-windows-forms)
- []()

é€šè¿‡å‘½ä»¤åˆ›å»ºçš„ WinForms æ¨¡æ¿ç¨‹åºï¼š

    dotnet new winforms

Windows Forms é¡¹ç›®ç»“æ„ç›¸å¯¹æ¥è®²è¦ç®€å•ï¼Œé»˜è®¤çš„æ¨¡æ¿å·¥ç¨‹æœ‰ä¸€ä¸ªå…¥å£ç±» Program.cs ä¸­å®šä¹‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªé™æ€å…¥å£å‡½æ•° Main()ï¼Œæ‰“å¼€ç¨‹åºæ—¶å°±ä¼šæ‰§è¡Œå®ƒã€‚é»˜è®¤ä»£ç æ‰§è¡Œ System.Windows.Forms.Application ç±»çš„é™æ€æ–¹æ³•åˆå§‹åŒ–ç¨‹åºæ‰§è¡Œï¼š

    Application.SetHighDpiMode(HighDpiMode.SystemAware);
    Application.EnableVisualStyles();
    Application.SetCompatibleTextRenderingDefault(false);
    Application.Run(new Form1());

Windows ç³»ç»Ÿç»Ÿä¸€ç®¡ç† IO èµ„æºï¼Œå®ƒä»¬äº§ç”Ÿçš„æ•°æ®æˆ–äº‹ä»¶éƒ½ä»¥æ¶ˆæ¯çš„æ–¹å¼é€šçŸ¥ç³»ç»Ÿè¿è¡Œçš„ç¨‹åºï¼Œæ‰€æœ‰ç¨‹åºéƒ½æœ‰æ¶ˆæ¯é˜Ÿåˆ— Message Loopï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„ while å¾ªç¯ä½¿ç”¨ GetMessage() è·å–ç³»ç»Ÿé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œè¿™æ˜¯ä¸ªé˜»å¡æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯é˜Ÿåˆ—ä¸ºç©ºæ—¶æ–¹æ³•å°±ä¼šè¢«é˜»å¡ï¼Œä»è€Œé‡Šæ”¾ CPU æ—¶é—´ã€‚è¿™ä¸ª while å¾ªç¯æš‚æ—¶åœæ­¢ä»¥é¿å…ç¨‹åºæŠŠ CPU æ—¶é—´è€—å°½ï¼Œè®©å…¶å®ƒç¨‹åºéš¾ä»¥å¾—åˆ°å“åº”ã€‚æŸäº› 3D æ¸¸æˆæˆ–è€…å³æ—¶æˆ˜ç•¥æ¸¸æˆä¸­ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ PeekMessage è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒä¸ä¼šè¢« Windows é˜»å¡ï¼Œä»è€Œä¿è¯æ•´ä¸ªæ¸¸æˆçš„æµç•…å’Œæ¯”è¾ƒé«˜çš„å¸§é€Ÿã€‚æ¶ˆæ¯ç¯å¤„ç†çš„ä¸»çº¿ç¨‹ç»´æŠ¤ç€æ•´ä¸ªçª—ä½“ä»¥åŠä¸Šé¢çš„å­æ§ä»¶çš„æ¶ˆæ¯åˆ†å‘ï¼Œå½“å®ƒå¾—åˆ°ä¸€ä¸ªæ¶ˆæ¯ï¼Œå°±ä¼šè°ƒç”¨ DispatchMessage æ–¹æ³•æ´¾å‘æ¶ˆæ¯ã€‚

å…¸å‹çš„æ¶ˆæ¯ç¯å¦‚ä¸‹ï¼š

    while(GetMessage( &msg, NULL, 0, 0 ) ){
        TranslateMessage( &msg );
        DispatchMessage( &msg );
    }

åŸå§‹çš„ Windows ç¨‹åºä¸­çš„çª—ä½“å¯¹è±¡ WNDCLASS å¯ä»¥è®¾ç½®ä¸€ä¸ªçª—ä½“æ¶ˆæ¯å¤„ç†å‡½æ•° lpfnWndProcã€‚å½“ç¨‹åºä¸­çš„æ¶ˆæ¯ç¯ GetMessage è·å–åˆ°æ¶ˆæ¯åå°±åˆ†å‘å‡ºå»ï¼Œç³»ç»Ÿå°±ä¼šå‘å¾€çª—ä½“æ¶ˆæ¯å¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™å°±ä¸¢å¼ƒæ¶ˆæ¯ã€‚å½“çª—ä½“è¦å³å‡ºæ—¶ï¼Œå¯ä»¥é€šè¿‡ PostQuitMessage å‘å‡ºä¸€ä¸ªé€€å‡ºæ¶ˆæ¯ï¼Œç³»ç»Ÿè·å–åå°±ä¼šå‘Šå°±ç»™æ¶ˆæ¯ç¯è¿”å› false ä»¥é€€å‡º while å¾ªç¯ã€‚Windows æ¶ˆæ¯æœºåˆ¶æ˜¯çº¿ç¨‹æˆ–è€…è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä¹‹ä¸€ï¼Œå³æ¶ˆæ¯é©±åŠ¨ï¼Œè¿™ç§é€šè¿‡æ¶ˆæ¯äº¤æµçš„æ–¹å¼æ˜¯ Windows ç¨‹åºçš„åŸºæœ¬ç»“æ„ã€‚åˆ°äº†é«˜çº§çš„æ¶æ„ï¼Œæ¶ˆæ¯é©±åŠ¨çš„æœºåˆ¶å°è£…æˆäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ Form å¯¹è±¡ä¸­ OnLoadã€ OnClick ç­‰äº‹ä»¶å¤„ç†æ–¹æ³•çš„è‡ªåŠ¨æ‰§è¡Œèƒ½åŠ›ã€‚æˆ–è€…ä½¿ç”¨äº‹ä»¶å¤„ç†å‡½æ•°çš„å§”æ‰˜å¯¹è±¡ï¼Œç›¸æ¯”æ¶ˆæ¯é©±åŠ¨ï¼Œè¿™æ˜¯ææ–¹ä¾¿çš„ä¸€ç§ GUI ç¼–ç¨‹æ–¹å¼ã€‚

.Net é‡Œé¢çš„æ¶ˆæ¯å¾ªç¯å¤„ç†æ˜¯é€šè¿‡ Application å¯¹è±¡å°è£…çš„ï¼Œé€šè¿‡ Application.Run æ–¹æ³•å¯åŠ¨æ¶ˆæ¯ç¯ï¼š

    public static void Main(string[] args)
    {
        Form f = new Form();
        Application.Run(f);
    }

åœ¨çª—å£æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­ï¼š

    LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);

lParam å’Œ wParam æ˜¯å®å®šä¹‰ï¼Œå®ƒçš„å­—é¢æ„ä¹‰ï¼Œw è¡¨ç¤º wordï¼Œl è¡¨ç¤º longï¼Œå¯¹äº 32 ä½ç³»ç»Ÿåˆ†åˆ«æ˜¯æ— ç¬¦å·æ•´æ•° unsigned int å’Œé•¿æ•´å‹ long ã€‚ä¹ æƒ¯ä¸Šï¼Œä½¿ç”¨ LPARAM ä¼ é€’åœ°å€ï¼ŒWPARAM ä¼ é€’å…¶ä»–å‚æ•°ã€‚å®ƒä»¬æ˜¯ Win16 ç³»ç»Ÿé—ç•™ä¸‹æ¥çš„äº§ç‰©ï¼Œåœ¨ Win16 API ä¸­ WndProc æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª WORD ç±»å‹çš„ 16 ä½æ•´å‹å˜é‡ï¼Œå¦ä¸€ä¸ªæ˜¯ LONG ç±»å‹çš„ 32 ä½æ•´å‹å˜é‡ã€‚

åˆ°äº† Win32 API ä¸­ï¼ŒåŸæ¥çš„ 16 ä½å˜é‡ä¹Ÿè¢«æ‰©å±•ä¸º 32 ä½ï¼Œå› æ­¤ lParam å’Œ wParam çš„å¤§å°å®Œå…¨ç›¸åŒã€‚å¦‚æ˜¯ä» 32 ä½åˆ° 64 ä½ï¼Œé‚£ä¹ˆå¯¹ WPARAM é‡‡ç”¨è¡¥é›¶æ‰©å±• zero-extendedï¼Œå¯¹ LPARAM å’Œ LRESULT é‡‡ç”¨ç¬¦å·æ‰©å±• sign-extendedã€‚

    var wp = (IntPtr.Size == 8) ? (int)((long)wParam << 32 >> 32) : (int)wParam;
    var lp = (IntPtr.Size == 8) ? (int)lParam.ToInt64() : lParam.ToInt32();

åœ¨ Form ç±»ä¸­ï¼Œæ‰€æœ‰ä»¥ On å¼€å¤´çš„æ–¹æ³•éƒ½æ˜¯å¤„ç†å„ç§æ¶ˆæ¯çš„ virtual æ–¹æ³•ï¼Œå­ç±»è¦å¤„ç†å¯¹åº”çš„æ¶ˆæ¯äº‹ä»¶ï¼Œå¯ä»¥è¦†ç›–å®ç°ã€‚ä¸€èˆ¬ä¼šä½¿ç”¨æ¶ˆæ¯äº‹ä»¶å¤„ç†å§”æ‰˜å¯¹è±¡ï¼š

    public delegate void EventHandler(object sender, EventArgs e);
    public delegate void KeyEventHandler(object sender, KeyEventArgs e);
    public delegate void MouseEventHandler(object sender, MouseEventArgs e);

    this.Click += handler;
    this.Click += new EventHandler(handler);
    this.Click += new MouseEventHandler(handler);
    this.Load += (sender, eventArgs) => Console.WriteLine("Form load");
    this.Load += handler; // also override by OnLoad event handler method
    // private void handler(object sender, EventArgs e)
    // protected override void OnLoad(EventArgs e)

çª—ä½“ keyPreview æŒ‡ç¤ºåœ¨å°†é”®äº‹ä»¶ä¼ é€’åˆ°å…·æœ‰ç„¦ç‚¹çš„æ§ä»¶å‰ï¼Œçª—ä½“æ˜¯å¦å°†æ¥æ”¶æ­¤é”®äº‹ä»¶ï¼Œå€¼è®¾ç½®æˆ true åè§¦å‘æŒ‰é”®äº‹ä»¶ã€‚æ–¹å‘é”®æ˜¯ä½œä¸ºç³»ç»Ÿé”®æ¥å¤„ç†çš„ï¼Œé»˜è®¤æ–¹å‘é”®çš„ä½œç”¨æ˜¯ç§»åŠ¨ç„¦ç‚¹ï¼Œç³»ç»Ÿå¤„ç†å®Œäº†å°±ä¸ä¼šå°†é”®ç›˜çš„é”®å€¼ä¼ é€’ä¸ªçª—ä½“æˆ–è·å–ç„¦ç‚¹çš„æ§ä»¶ï¼Œä¹Ÿä¸ä¼šè§¦å‘çª—ä½“çš„KeyDownäº‹ä»¶ã€‚ è¦†ç›–é»˜è®¤çš„ç³»ç»Ÿé”®å¤„ç†æ–¹å¼ï¼Œè¿™æ ·é”®å€¼å°±ä¼šè¢«ä¼ é€’åˆ°çª—ä½“ï¼š

    protected override bool ProcessDialogKey(Keys keyData)

ä¸»çª—ä½“ Form1.cs ä¸­å’Œ WPF çš„çª—ä½“ç±»ä¼¼åœ°æ‰§è¡Œ InitializeComponent æ–¹æ³•æ¥åˆå§‹åŒ–æ§ä»¶ï¼Œä½†æ˜¯å®ƒä»¬å®ç°çš„æœºåˆ¶æ˜¯ä¸åŒçš„ï¼Œä¸»è¦ä½¿ç”¨çš„å‘½åç©ºé—´ä¹Ÿä¸ä¸€æ ·ï¼š

- System.ComponentModel å‘½åç©ºé—´

    æä¾›ç”¨äºå®ç°ç»„ä»¶å’Œæ§ä»¶çš„è¿è¡Œæ—¶å’Œè®¾è®¡æ—¶è¡Œä¸ºçš„ç±»ï¼Œæ”¯æŒ IComponent æ¥å£ï¼Œéƒ½æ”¯æŒå¯è§†åŒ–è®¾è®¡å™¨æ“ä½œã€‚

    è¿™äº›ç»„ä»¶éƒ½æ˜¯é€šè¿‡ç»„ä»¶çª—å£ IContainer ç®¡ç†ï¼Œå®ä¾‹åŒ–ç»„ä»¶æ—¶ä¼ å…¥å…¶å½’å±çš„å®¹å™¨å®ä¾‹ã€‚ IComponent é€šè¿‡ ISite å…³è”åˆ°ç»„ä»¶å®¹å™¨ä¸Šï¼ŒISite ä¿å­˜ç»„ä»¶å’Œå…¶å½’å±å®¹å™¨çš„å¼•ç”¨ï¼Œç»„ä»¶å®¹å™¨ä¿å­˜ç»„ä»¶å¼•ç”¨é›†åˆã€‚

    .NET 2.0 å¢åŠ äº† INestedContainerï¼ŒåµŒå¥—å®¹å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¹Ÿæ˜¯è¢«å¦å¤–ä¸€ä¸ª IComponent æŒæœ‰

    è¿˜åŒ…å«é€šå¸¸ç”¨åˆ°çš„ DataAnnotations å’Œ DataAnnotations.Schema ç­‰ç”¨äºæ•°æ®æ“ä½œçš„ç‰¹æ€§ï¼Œå„ç§ Attributeã€‚

- System.Windows.Forms å‘½åç©ºé—´

    åŒ…å«ç”¨äºåˆ›å»ºåŸºäº Windows çª—å£çš„åº”ç”¨ç¨‹åºçš„ç±»ï¼Œä»¥å……åˆ†åˆ©ç”¨ Microsoft Windows æ“ä½œç³»ç»Ÿä¸­æä¾›çš„ä¸°å¯Œçš„ç”¨æˆ·ç•Œé¢åŠŸèƒ½ã€‚


çª—ä½“é…å¥—çš„çš„ Form1.Designer.cs æ˜¯ä¸ºå¯è§†åŒ–ç¼–è¾‘ç”¨æ¥ä¿å­˜è‡ªåŠ¨ç”Ÿæˆä»£ç çš„ï¼Œç§°ä¸ºè®¾è®¡å™¨ä»£ç æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ª IContainer å³ç»„ä»¶å®¹å™¨ï¼Œè¿˜æœ‰ç»„ä»¶åˆå§‹åŒ–æ–¹æ³• InitializeComponentï¼ŒDispose æ–¹æ³•ç”¨æ¥æ¸…ç†ç»„ä»¶ã€‚Visual Studio ä¸­çš„ Windows çª—ä½“è®¾è®¡å™¨æä¾›äº†ç”¨äºæ‰¿è½½ Windows Presentation Foundation æ§ä»¶çš„å¯è§†åŒ–è®¾è®¡ç¯å¢ƒã€‚

ä¸¤ä¸ªæ–‡ä»¶åˆä½“å°±æ˜¯ä¸€ä¸ªå®Œå…¨çš„ Form1 çª—ä½“ç±»ã€‚

    namespace winform
    {
        partial class Form1
        {
            /// <summary>
            ///  Required designer variable.
            /// </summary>
            private System.ComponentModel.IContainer components = null;

            /// <summary>
            ///  Clean up any resources being used.
            /// </summary>
            /// <param name="disposing">true if managed resources should be disposed; otherwise, false.</param>
            protected override void Dispose(bool disposing)
            {
                if (disposing && (components != null))
                {
                    components.Dispose();
                }
                base.Dispose(disposing);
            }

            #region Windows Form Designer generated code

            /// <summary>
            ///  Required method for Designer support - do not modify
            ///  the contents of this method with the code editor.
            /// </summary>
            private void InitializeComponent()
            {
                this.components = new System.ComponentModel.Container();
                this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
                this.ClientSize = new System.Drawing.Size(800, 450);
                this.Text = "Form1";
            }

            #endregion
        }
    }

åŸºäº Windows çª—ä½“çš„åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ WPF æ§ä»¶ï¼Œå°½ç®¡è¿™æ˜¯ä¸¤ç§ä¸åŒçš„è§†å›¾æŠ€æœ¯ï¼Œä½†å®ƒä»¬å¯ä»¥é¡ºç•…åœ°äº’æ“ä½œã€‚WPF æ§ä»¶ç”±åä¸º ElementHost çš„ç‰¹æ®Š Windows çª—ä½“æ§ä»¶æ‰¿è½½ï¼Œå®ƒåœ¨ System.Windows.Forms.Integration å‘½åç©ºé—´å®šä¹‰ã€‚ æ­¤æ§ä»¶å…è®¸ WPF æ§ä»¶å‚ä¸çª—ä½“çš„å¸ƒå±€ä»¥åŠæ¥æ”¶é”®ç›˜å’Œé¼ æ ‡æ¶ˆæ¯ã€‚ åœ¨è®¾è®¡æ—¶ï¼Œæ‚¨å¯ä»¥åƒå¯¹ä»»ä½• Windows çª—ä½“æ§ä»¶ä¸€æ ·æ’åˆ— ElementHost æ§ä»¶ã€‚

- åœ¨ Windows Forms é¡¹ç›®é€šè¿‡ ElementHost æ§ä»¶æ¥ä½¿ç”¨ WPF UIElementï¼›
- åœ¨ WPF é¡¹ç›®é€šè¿‡ WindowsFormsHost æ¥ä½¿ç”¨ Windows Forms æ§ä»¶ï¼›

éœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥ System.Windows.Forms.Integration å‘½åç©ºé—´ï¼Œæ‰€éœ€æ–‡ä»¶ WindowsFormsIntegration.dll å’Œ WPF æ¡†æ¶ä¸€å¹¶å®‰è£…ï¼š 

    %programfiles%\Reference Assemblies\Microsoft\Framework\v3.0\WindowsFormsIntegration.dll

System.Windows.Controls å‘½åç©ºé—´åœ¨ PresentationFramework.dllä¸­ã€‚
åœ¨ .Net Core 3.0 é¡¹ç›®ä¸­æ·»åŠ æœ¬åœ° DLL ç¨‹åºé›†å¼•ç”¨ï¼Œéœ€è¦ä¿®æ”¹ csproj é¡¹ç›®é…ç½®ï¼š

    <Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">

      <PropertyGroup>
        <OutputType>WinExe</OutputType>
        <TargetFramework>netcoreapp3.1</TargetFramework>
        <UseWindowsForms>true</UseWindowsForms>
      </PropertyGroup>

      <ItemGroup>
        <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="3.1.4" />
          <Reference Include="BabySDK">

            <HintPath>C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\v3.0\WindowsFormsIntegration.dll</HintPath>
        </Reference>
        <Reference Include="PresentationFramework">
            <HintPath>C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\v3.0\PresentationFramework.dll</HintPath>
        </Reference>
        <Reference Include="PresentationFramework">
            <HintPath>C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\v3.0\PresentationCore.dll</HintPath>
        </Reference>
      </ItemGroup>
    </Project>

ç¤ºä¾‹ï¼š

    using System;
    using System.Collections.Generic;
    using System.ComponentModel;
    using System.Data;
    using System.Drawing;
    using System.Linq;
    using System.Text;
    using System.Threading.Tasks;
    using WPF = System.Windows;
    using Controls = System.Windows.Controls;
    using Media = System.Windows.Media;
    using System.Windows.Forms;
    using System.Windows.Forms.Integration;

    namespace winform
    {
        public partial class Form1 : Form
        {
            public Form1()
            {
                InitializeComponent();
            }

            public Form1(ITextService textSevice)
            {
                InitializeComponent();
                this.Text = textSevice.GetText();
                this.Load += Form1_Load;
            }

            private void Form1_Load(object sender, EventArgs e)
            {
                Button btn = new Button();
                btn.Text ="Exit";
                btn.Top = 200;
                btn.Height = 100;
                btn.Width = 300;

                this.Controls.Add(btn);

                // Use ElementHost control for hosting the WPF UserControl.
                ElementHost host = new ElementHost();
                host.Dock = DockStyle.Fill;

                // Create the WPF UserControl.
                Controls::Button uc = new Controls::Button();

                // Assign the WPF UserControl to the ElementHost control's Child property.
                host.Child = uc;

                // Settings up UserControl
                uc.Background = Media.Brushes.Red;
                uc.Content = "WPF Button";
                uc.Height = 100;
                uc.Width = 300;
                uc.VerticalAlignment = WPF::VerticalAlignment.Center;

                // Add the ElementHost control to the form's collection of child controls.
                this.Controls.Add(host);

                // Events Binddings
                // uc.Click += new RoutedEventHandler((sendrr, eventargs) => Close());
                btn.Click += (sendrr, eventargs) => {
                        try{
                            Close();
                            // Application.Exit();
                            Environment.Exit(0);
                        } catch (System.Runtime.InteropServices.SEHException e) {
                            Console.WriteLine(e);
                        }
                    };
            }

        }
    }




# =ğŸš© WPF Application Startup
- [Creating Event Handlers in Windows Forms](https://docs.microsoft.com/en-us/dotnet/framework/winforms/creating-event-handlers-in-windows-forms)
- [Windows Presentation Foundation è·¯ç”±äº‹ä»¶](https://docs.microsoft.com/zh-cn/dotnet/framework/wpf/advanced/events-wpf)
- [WPF UIElement](https://docs.microsoft.com/zh-cn/dotnet/api/system.windows.uielement)
- [WPF ContentElement](https://docs.microsoft.com/zh-cn/dotnet/api/system.windows.contentelement)
- [WPF FrameworkElement](https://docs.microsoft.com/zh-cn/dotnet/api/system.windows.frameworkelement)
- [WPF FrameworkContentElement](https://docs.microsoft.com/zh-cn/dotnet/api/system.windows.frameworkcontentelement)
- [XAML in WPF](https://docs.microsoft.com/zh-cn/dotnet/framework/wpf/advanced/xaml-in-wpf)
- [WPF Data Binding](https://docs.microsoft.com/zh-cn/dotnet/desktop-wpf/data/data-binding-overview)
- [WPF Threading Model](https://docs.microsoft.com/zh-cn/dotnet/framework/wpf/advanced/threading-model)
- [WPF Samples](https://github.com/microsoft/WPF-Samples)
- []()

è¿™é‡Œä»‹ç»é€šè¿‡å‘½ä»¤åˆ›å»ºçš„ WPF å’Œ WinForms æ¨¡æ¿ç¨‹åºï¼š

    dotnet new wpf
    dotnet new winforms

è¿™ä¸¤ç§ Windows GUI é¡¹ç›®æœ‰ç›¸ä¼¼çš„ csproj é…ç½®ï¼Œå·®åˆ«åœ¨äºä½¿ç”¨äº†ä¸åŒå¼€å‘æ¡†æ¶å’Œå¼€å‘æ¨¡å¼ã€‚ WPF ä½¿ç”¨ UI å’Œä»£ç åˆ†äº«çš„å¼€å‘æ¨¡å¼ï¼ŒWinForms æ˜¯å…¨ä»£ç çš„æ—§æ–¹å¼ã€‚

å…ˆæ¥è®¤è¯† WPF - Windows Presentation Foundation ç¨‹åº çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸åˆ†è¾¨ç‡æ— å…³ä¸”åŸºäºçŸ¢é‡çš„å‘ˆç°å¼•æ“ï¼Œæ—¨åœ¨å……åˆ†åˆ©ç”¨ç°ä»£å›¾å½¢ç¡¬ä»¶ã€‚ WPF é€šè¿‡ä¸€å¥—å®Œå–„çš„åº”ç”¨ç¨‹åºå¼€å‘åŠŸèƒ½å¯¹è¯¥æ ¸å¿ƒè¿›è¡Œäº†æ‰©å±•ï¼Œè¿™äº›åŠŸèƒ½åŒ…æ‹¬å¯æ‰©å±•åº”ç”¨ç¨‹åºæ ‡è®°è¯­è¨€ XAMLã€æ§ä»¶ã€æ•°æ®ç»‘å®šã€å¸ƒå±€ã€äºŒç»´å’Œä¸‰ç»´å›¾å½¢ã€åŠ¨ç”»ã€æ ·å¼ã€æ¨¡æ¿ã€æ–‡æ¡£ã€åª’ä½“ã€æ–‡æœ¬å’Œç‰ˆå¼ã€‚ WPF å±äº .NETï¼Œå› æ­¤å¯ä»¥ç”Ÿæˆæ•´åˆ .NET API å…¶ä»–å…ƒç´ çš„åº”ç”¨ç¨‹åºã€‚

WPF ä½œä¸ºå¤§éƒ¨åˆ†ä½äº System.Windows å‘½åç©ºé—´ä¸­çš„ .NET ç±»å‹çš„ä¸€ä¸ªå­é›†å­˜åœ¨ã€‚ä½ å¯ä»¥ä½¿ç”¨æœ€å–œæ¬¢çš„ .NET ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚ C# æˆ– Visual Basicï¼‰æ¥å®Œæˆå®ä¾‹åŒ–ç±»ã€è®¾ç½®å±æ€§ã€è°ƒç”¨æ–¹æ³•ä»¥åŠå¤„ç†äº‹ä»¶ç­‰æ“ä½œã€‚

WPF è¿˜åŒ…æ‹¬å¢å¼ºå±æ€§å’Œäº‹ä»¶çš„å…¶ä»–ç¼–ç¨‹æ„é€ ï¼š ä¾èµ–é¡¹å±æ€§ å’Œ è·¯ç”±äº‹ä»¶ã€‚

WPF æœ‰å››ä¸ªå…³é”®ç±»ï¼Œå®ç°äº† WPF ç¼–ç¨‹ä¸­å¯ç”¨çš„å¤§é‡å…¬å…±å…ƒç´ åŠŸèƒ½ï¼š

| åŸºç¡€å¯¹è±¡ | åŠŸèƒ½è¦ç‚¹ |
| :------ | :------ |
| UIElement | WPF æ ¸å¿ƒçº§å®ç°çš„åŸºç±»ï¼Œå…¶å®ƒ UI å®ç°æ˜¯åœ¨æ­¤å…ƒç´ å’ŒåŸºæœ¬è¡¨ç¤ºç‰¹æ€§ä¸Šç”Ÿæˆçš„ã€‚ |
| ContentElement    | ä¸ºå†…å®¹å…ƒç´ æä¾› WPF æ ¸å¿ƒçº§åŸºç±»ã€‚ å†…å®¹å…ƒç´ è®¾è®¡ç”¨äºæµæ ·å¼æ˜¾ç¤ºï¼Œå®ƒä»¬ä½¿ç”¨é¢å‘æ ‡è®°çš„ç›´è§‚å¸ƒå±€æ¨¡å‹å’Œç²¾å¿ƒè®¾è®¡çš„ç®€å•å¯¹è±¡æ¨¡å‹ã€‚ |
| FrameworkElement  | æä¾› WPF å…ƒç´ çš„å±æ€§ã€äº‹ä»¶å’Œæ–¹æ³•çš„ WPF æ¡†æ¶çº§åˆ«é›†ã€‚ æ­¤ç±»è¡¨ç¤ºæ‰€æä¾›çš„ WPF æ¡†æ¶çº§åˆ«å®ç°åŸºäº UIElement å®šä¹‰çš„ WPF æ ¸å¿ƒçº§åˆ« APIã€‚ |
| FrameworkContentElementï¼Œ  | æ˜¯ ContentElement åŸºç±»çš„ WPF æ¡†æ¶çº§åˆ«çš„å®ç°å’Œæ‰©å±•ã€‚ å¢åŠ äº†é’ˆå¯¹ä¸‹åˆ—å„é¡¹çš„æ”¯æŒï¼šé™„åŠ è¾“å…¥ APIï¼ˆåŒ…æ‹¬å·¥å…·æç¤ºå’Œä¸Šä¸‹æ–‡èœå•ï¼‰ã€æ¼”ç¤ºå›¾æ¿ã€ç”¨äºæ•°æ®ç»‘å®šçš„æ•°æ®ä¸Šä¸‹æ–‡ã€æ ¼å¼æ”¯æŒå’Œé€»è¾‘æ ‘å¸®åŠ©ç¨‹åº APIã€‚ |


XAML æ˜¯ä¸€ç§åŸºäº XML çš„æ ‡è®°è¯­è¨€ï¼Œåƒ HTML ä¸€æ ·ä»¥å£°æ˜å½¢å¼å®ç°åº”ç”¨ç¨‹åºçš„å¤–è§‚ã€‚ é€šå¸¸ç”¨å®ƒåˆ›å»ºçª—å£ã€å¯¹è¯æ¡†ã€é¡µå’Œç”¨æˆ·æ§ä»¶ï¼Œå¹¶å¡«å……æ§ä»¶ã€å½¢çŠ¶å’Œå›¾å½¢ã€‚

æ¨¡æ¿åˆ›å»ºçš„ App.xaml å’Œé…å¥—çš„ App.xaml.cs å°±æ˜¯ç¨‹åºçš„å…¥å£ï¼Œå®ƒä»¬å¯¹åº”äº†ä¸€ä¸ª System.Windows.Application å®ä¾‹ï¼Œå…¶å±æ€§ `StartupUri` æŒ‡ç¤ºäº†ç¨‹åºè¿è¡Œçš„ç¬¬ä¸€ä¸ªçª—ä½“å¯¹è±¡ï¼ŒåŒæ—¶å¯ä»¥è®¾ç½® `Startup` æŒ‡å®šä¸€ä¸ªå¯åŠ¨æ—¶è¦æ‰§è¡Œçš„äº‹ä»¶ï¼Œå¯ä»¥ä¸è®¾ç½® `StartupUri` è€Œé€šè¿‡æŒ‡å®šçš„å¯åŠ¨äº‹ä»¶æ¥å®ä¾‹åŒ–çª—ä½“ã€‚

    <Application x:Class="wpf.App"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:local="clr-namespace:wpf"
                 StartupUri="MainWindow.xaml">
        <Application.Resources>
             
        </Application.Resources>
    </Application>

`Startup` æŒ‡å®šä¸€ä¸ªå¯åŠ¨äº‹ä»¶ä»£ç å°±å†™åœ¨ App.xaml.cs æ–‡ä»¶å†…ï¼Œæ¯”å¦‚æŒ‡å®š `Startup="App_OnStartup"`ï¼š

    using System;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Data;
    using System.Linq;
    using System.Threading.Tasks;
    using System.Windows;

    namespace wpf
    {
        /// <summary>
        /// Interaction logic for App.xaml
        /// </summary>
        public partial class App : Application
        {
            public IServiceProvider _serviceProvider;

            public App()
            {
                ...
            }

            private void App_OnStartup(object sender, StartupEventArgs e)
            {
                ...
            }
        }
    }

é»˜è®¤çš„ä¸»çª—ä½“ä¹Ÿä¸€æ ·æœ‰ä¸¤ä¸ªæ–‡ä»¶å¯¹åº” System.Windows.Window å¯¹è±¡ã€‚

MainWindow.xaml:

    <Window x:Class="wpf.MainWindow"
            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:local="clr-namespace:wpf"
            mc:Ignorable="d"
            Title="MainWindow" Height="450" Width="800">
        <Grid>

        </Grid>
    </Window>

MainWindow.xaml.cs:

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.Threading.Tasks;
    using System.Windows;
    using System.Windows.Controls;
    using System.Windows.Data;
    using System.Windows.Documents;
    using System.Windows.Input;
    using System.Windows.Media;
    using System.Windows.Media.Imaging;
    using System.Windows.Navigation;
    using System.Windows.Shapes;

    namespace wpf
    {
        /// <summary>
        /// Interaction logic for MainWindow.xaml
        /// </summary>
        public partial class MainWindow : Window
        {
            public MainWindow()
            {
                InitializeComponent();
            }
        }
    }

æ•´ä¸ª WPF ç¨‹åºæœ‰ä¸¤ç§å¼€å‘æ¨¡å¼ï¼ŒXAML çš„æ ‡ç­¾åŒ– UI ç¼–è¾‘æ¨¡å¼ï¼Œå¯ä»¥åœ¨ Visual Studio ä¸­æ‹–æ”¾å¯¹è±¡ç»„ä»¶ã€‚å¦ä¸€ç§æ˜¯ä»£ç ç¼–å†™æ¨¡å¼ï¼Œç”¨æ¥å®ç°ç¨‹åºé€»è¾‘ã€‚WPF é€šè¿‡ XAML å®ç°äº† UI å’Œä»£ç çš„åˆ†äº«ã€‚è¿™ç§è½¯ä»¶å¼€å‘æ¨¡å¼æ˜æ˜¾ä¼˜äº WinForms æ—§å¼çš„çº¯ä»£ç å¼€å‘ã€‚

æ¯”å¦‚ï¼Œåœ¨ MainWindow.xaml æ·»åŠ ä¸€ä¸ªæŒ‰é’®æ§ä»¶å¯¹è±¡:

    <!-- Add button to window -->
    <Button Name="button" Click="button_Click">Click Me!</Button>

åœ¨ MainWindow.xaml.cs æ·»åŠ ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°:

    void button_Click(object sender, RoutedEventArgs e)
    {
        // Show message box when button is clicked.
        MessageBox.Show("Hello, Windows Presentation Foundation!");
    }

å½“æ„é€ å‡½æ•°è°ƒç”¨ InitializeComponent æ–¹æ³•æ—¶ï¼Œå°±ä¼šå°†æ ‡è®°å®šä¹‰çš„ UI æ§ä»¶ä¸èƒŒåçš„ä»£ç åˆå¹¶åœ¨ä¸€èµ·ï¼Œå®ƒç”Ÿæˆåº”ç”¨ç¨‹åºä¸ºæ‚¨æ­£ç¡®åˆå§‹åŒ– UI ç»„ä»¶çš„å®ç°ä»£ç ï¼ŒåŒ…æ‹¬å°†æŒ‰é’®çš„ Click äº‹ä»¶ä¸äº‹ä»¶å¤„ç†ç¨‹åºå…³è”ã€‚è¿™å°±æ˜¯ Markup & Code-Behindï¼Œç”¨æ ‡è®°å®šä¹‰æ§ä»¶ï¼Œç”¨èƒŒåçš„ä»£ç è‡ªåŠ¨å®ç°ã€‚


æ¥ä¸‹æ¥å°±æ˜¯æ·±å…¥å„ä¸ªç¼–ç¨‹ç»†èŠ‚çš„å®ç°ï¼Œç½—åˆ—ä»¥ä¸‹é¡¹ç›®ï¼Œä½†åˆä¸ä»…é™äºæ­¤ï¼š

- æ§åˆ¶
- è¾“å…¥å’Œå‘½ä»¤
- å¸ƒå±€
- æ•°æ®ç»‘å®š
- å›¾å½¢
- åŠ¨ç”»
- åª’ä½“
- æ–‡æœ¬å’Œç‰ˆå¼
- è‡ªå®šä¹‰ WPF åº”ç”¨


## ==âš¡ WPF Routing Events


## ==âš¡ Host WinForms with WindowsFormsHost
- [WindowsFormsHost å…ƒç´ çš„å¸ƒå±€æ³¨æ„äº‹é¡¹](https://docs.microsoft.com/zh-cn/previous-versions/dotnet/netframework-4.0/ms744952(v=vs.100))

WinForms æ˜¯ç¬¬ä¸€ä¸ª .NET UI æ¡†æ¶ï¼Œå’Œ WPF æ˜¯ä¸¤ä¸ªä¸åŒçš„ UI æ¡†æ¶ã€‚ åŒæ–¹ç»„ä»¶ä¸èƒ½ç›´æ¥å€Ÿç”¨ï¼Œå¦‚æœç¡®å®éœ€è¦ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ WindowsFormsHost ä½œä¸º WinForms ç»„ä»¶å¯„ä¸»ã€‚

- åœ¨ Windows Forms é¡¹ç›®é€šè¿‡ ElementHost æ§ä»¶æ¥ä½¿ç”¨ WPF UIElementï¼›
- åœ¨ WPF é¡¹ç›®é€šè¿‡ WindowsFormsHost æ¥ä½¿ç”¨ Windows Forms æ§ä»¶ï¼›

Windows Forms ä¸­çš„å¸ƒå±€æ˜¯ä¸è®¾å¤‡ç›¸å…³çš„ï¼Œå¾ˆå¯èƒ½æ˜¯é™æ€çš„ã€‚ é€šå¸¸ï¼Œä½¿ç”¨ä»¥ç¡¬ä»¶åƒç´ ä¸ºå•ä½æŒ‡å®šçš„ç»´åº¦ï¼Œåœ¨çª—ä½“ä¸Šä»¥ç»å¯¹æ–¹å¼æ¥å®šä½ Windows Formsæ§ä»¶ã€‚ ä¸è¿‡ï¼ŒWindows Formsä¸æ”¯æŒæŸäº›åŠ¨æ€å¸ƒå±€åŠŸèƒ½ï¼Œå¦‚ä¸‹è¡¨æ±‡æ€»æ‰€ç¤ºã€‚

- è‡ªåŠ¨è°ƒæ•´å¤§å°

    æŸäº› Windows Formsæ§ä»¶å¯ä»¥è°ƒæ•´è‡ªèº«å¤§å°ï¼Œä»¥ä¾¿æ°å½“åœ°æ˜¾ç¤ºå†…å®¹ã€‚ æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ AutoSize å±æ€§æ¦‚è¿°ã€‚

- é”šå®šå’Œåœé 

    Windows Formsæ§ä»¶æ”¯æŒåŸºäºçˆ¶å®¹å™¨è¿›è¡Œå®šä½å’Œå¤§å°è°ƒæ•´ã€‚ æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Control.Anchor å’Œ Control.Dockã€‚

- è‡ªåŠ¨ç¼©æ”¾

    å®¹å™¨æ§ä»¶åŸºäºè¾“å‡ºè®¾å¤‡çš„åˆ†è¾¨ç‡æˆ–é»˜è®¤å®¹å™¨çš„å­—å·ï¼ˆå•ä½ä¸ºåƒç´ ï¼‰æ¥è°ƒæ•´è‡ªèº«åŠå…¶å­æ§ä»¶çš„å¤§å°ã€‚ æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Windows çª—ä½“ä¸­çš„è‡ªåŠ¨ç¼©æ”¾ã€‚

- å¸ƒå±€å®¹å™¨

    FlowLayoutPanel å’Œ TableLayoutPanel æ§ä»¶æ ¹æ®å…¶å†…å®¹æ¥æ’åˆ—å­æ§ä»¶ä»¥åŠè®¾å®šè‡ªèº«å¤§å°ã€‚

é€šå¸¸ï¼Œæ— æ³•å°† Windows Formsæ§ä»¶ç¼©æ”¾åŠè½¬æ¢åˆ° WPF ä¸­å¯èƒ½çš„èŒƒå›´ã€‚ 

æŸäº›æƒ…å†µä¸‹ï¼ŒWindows Forms æ§ä»¶æ— æ³•è°ƒæ•´å¤§å°ï¼Œæˆ–è€…å¤§å°åªèƒ½è°ƒæ•´ä¸ºç‰¹å®šçš„å°ºå¯¸ã€‚ ä¾‹å¦‚ï¼ŒWindows Forms ComboBox æ§ä»¶ä»…æ”¯æŒç”±æ§ä»¶çš„å­—å·å®šä¹‰çš„å•ä¸€é«˜åº¦ã€‚ åœ¨å…ƒç´ å¯ä»¥å‚ç›´æ‹‰ä¼¸çš„ WPF åŠ¨æ€å¸ƒå±€ä¸­ï¼Œæ‰¿è½½çš„ ComboBox æ§ä»¶ä¸ä¼šå¦‚é¢„æœŸé‚£æ ·æ‹‰ä¼¸ã€‚

Windows Forms æ§ä»¶ä¸èƒ½æ—‹è½¬æˆ–æ‰­æ›²ã€‚ å¦‚æœåº”ç”¨æ‰­æ›²æˆ–æ—‹è½¬å˜æ¢ï¼ŒWindowsFormsHost å…ƒç´ ä¼šå¼•å‘ LayoutError äº‹ä»¶ã€‚ å¦‚æœæœªå¤„ç† LayoutError äº‹ä»¶ï¼Œä¼šå¼•å‘ InvalidOperationExceptionã€‚

æŸäº›æƒ…å†µä¸‹ï¼ŒWindows Forms æ§ä»¶ä¸æ”¯æŒæŒ‰æ¯”ä¾‹ç¼©æ”¾ã€‚ å°½ç®¡è¯¥æ§ä»¶çš„æ•´ä½“å°ºå¯¸å°†ä¼šç¼©æ”¾ï¼Œä½†å…¶å­æ§ä»¶å’Œç»„ä»¶å…ƒç´ å¯èƒ½ä¸ä¼šå¦‚é¢„æœŸé‚£æ ·è°ƒæ•´å¤§å°ã€‚ æ­¤é™åˆ¶å–å†³äºæ¯ä¸ª Windows Formsæ§ä»¶æ”¯æŒç¼©æ”¾çš„ç¨‹åº¦ã€‚ æ­¤å¤–ï¼Œæ‚¨ä¸èƒ½å°† Windows Forms æ§ä»¶ç¼©å°è‡³ 0 åƒç´ å¤§å°ã€‚

Windows Forms æ§ä»¶æ”¯æŒè‡ªåŠ¨ç¼©æ”¾ï¼Œå…¶ä¸­çš„çª—ä½“ä¼šåŸºäºå­—å·è‡ªåŠ¨è°ƒæ•´è‡ªèº«åŠå…¶æ§ä»¶çš„å¤§å°ã€‚ åœ¨ WPF ç”¨æˆ·ç•Œé¢ä¸­ï¼Œæ›´æ”¹å­—å·ä¸ä¼šæ”¹å˜æ•´ä¸ªå¸ƒå±€çš„å¤§å°ï¼Œä¸è¿‡ä¸ªåˆ«å…ƒç´ å¯èƒ½ä¼šåŠ¨æ€è°ƒæ•´å¤§å°ã€‚

Z Index åœ¨ WPF ç”¨æˆ·ç•Œé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ›´æ”¹å…ƒç´ çš„ z é¡ºåºä»¥æ§åˆ¶é‡å è¡Œä¸ºã€‚ ç”±äºæ‰¿è½½çš„ Windows Forms æ§ä»¶æ˜¯åœ¨å•ç‹¬çš„ HWND ä¸­ç»˜åˆ¶çš„ï¼Œæ‰€ä»¥å®ƒå§‹ç»ˆç»˜åˆ¶åœ¨ WPF å…ƒç´ çš„é¡¶éƒ¨ã€‚


MainWindow.cs

    using System.Windows;
    using System.Windows.Forms;
    using System.Windows.Forms.Integration;

    namespace HostingWfInWPF
    {
        public partial class MainWindow : Window
        {
            public MainWindow()
            {
                InitializeComponent();
            }

            private void WindowLoaded(object sender, RoutedEventArgs e)
            {
                // Create the interop host control.
                var host = new WindowsFormsHost();

                // Create the MaskedTextBox control.
                var mtbDate = new MaskedTextBox("00/00/0000");

                // Assign the MaskedTextBox control as the host control's child.
                host.Child = mtbDate;

                // Add the interop host control to the Grid
                // control's collection of child controls.
                grid1.Children.Add(host);


                host = new WindowsFormsHost();

                // Create a Windows Forms tab control.
                var tc = new TabControl();
                tc.TabPages.Add("Tab1");
                tc.TabPages.Add("Tab2");

                // Assign the Windows Forms tab control as the hosted control.
                host.Child = tc;

                // Assign the host element to the parent Grid element.
                grid1.Children.Add(host);
            }
        }
    }

MainWindow.xaml

    <Window x:Class="HostingWfInWPF.MainWindow"
            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:local="clr-namespace:HostingWfInWPF"
            mc:Ignorable="d"
            Title="MainWindow" Height="350" Width="525" Loaded="WindowLoaded">

        <Grid Name="grid1" >
            <Button VerticalAlignment="Center">Click</Button>
        </Grid>
    </Window>

æˆ–è€…åœ¨ XAML ä¸­ç›´æ¥ä½¿ç”¨ï¼š

    <Window x:Class="HostingWfInWPF.MainWindow"
        xmlns:WinFormHost="clr-namespace:System.Windows.Forms.Integration;assembly=WindowsFormsIntegration"
        xmlns:WinFormControls="clr-namespace:System.Windows.Forms;assembly=System.Windows.Forms"
        ...>
        <WindowsFormsHost Height="196" HorizontalAlignment="Left" Margin="104,65,0,0" Name="windowsFormsHost1" VerticalAlignment="Top" Width="286" >

            <WinFormControls:Button Text="WinformButton" Width="150"/>

        </WindowsFormsHost>
    </Window>



# =ğŸš© Customize Your CLI Templates
- https://docs.microsoft.com/en-us/dotnet/core/tutorials/cli-templates-create-project-template
- https://docs.microsoft.com/en-us/nuget/reference/msbuild-targets
- https://docs.microsoft.com/en-us/dotnet/core/tools/custom-templates
- https://docs.microsoft.com/en-us/nuget/reference/target-frameworks


## ==âš¡ Tutorial: Create an item template

åˆ›å»ºè‡ªå·±çš„ .NET Core æ¡ç›®æ¨¡æ¿ï¼Œå­¦ä¹  install å’Œ uninstall å‘½ä»¤å®‰è£…å’Œå¸è½½æ¨¡æ¿ï¼Œå­¦ä¹ ç›®æ ‡ï¼š

- Create a class for an item template
- Create the template config folder and file
- Install a template from a file path
- Test an item template
- Uninstall an item template


åŸºæœ¬æ¨¡æ¿ç›®å½•ç»“æ„ï¼š

    â””â”€â”€â”€ mytemplate
        â”‚   console.cs
        â”‚   readme.txt
        â”‚
        â””â”€â”€â”€.template.config
                template.json

åŸºæœ¬æ¨¡æ¿é…ç½®æ–‡ä»¶ template.json å‚è€ƒï¼š

    {
      "$schema": "http://json.schemastore.org/template",
      "author": "Travis Chau",
      "classifications": [ "Common", "Console" ],
      "identity": "AdatumCorporation.ConsoleTemplate.CSharp",
      "name": "Adatum Corporation Console Application",
      "shortName": "adatumconsole"
    }

å„é…ç½®é¡¹åŠŸèƒ½è§£æï¼š

| Member    | Type  | Description |
| :------   | :------   | :------ |
| $schema   | URI   | å›ºå®šçš„ JSON schemaï¼Œå¯¹æ”¯æŒçš„ç¼–è¾‘å™¨æœ‰æ•ˆï¼Œå¦‚ Visual Studio Code ä½¿ç”¨å®ƒå®ç°è‡ªåŠ¨æç¤º IntelliSenseã€‚ |
| author    | string    | æ¨¡æ¿ä½œè€…ä¿¡æ¯ã€‚ |
| classifications   | array(string) | ä»»æ„ä¸ªæŒ‡å®šåˆ†ç±»å…³é”®è¯ï¼Œç”¨æˆ·å¯èƒ½é€šè¿‡ `dotnet new -l|--list` æœç´¢åˆ°ã€‚ |
| identity  | string    | è¡¨ç¤ºæ¨¡æ¿çš„å”¯ä¸€æ ‡å¿—ã€‚ |
| name  | string    | æ¨¡æ¿åç§°ã€‚ |
| shortName | string    | æ¨¡æ¿ç®€ç§°ï¼Œé€šè¿‡æ˜¯å‘½ä»¤è¡Œä¸­ä½¿ç”¨çš„ï¼Œä¸€èˆ¬ä¸åœ¨ GUI ä¸­ä½¿ç”¨ç®€ç§°ã€‚|


éœ€è¦å®‰è£… NET Core 2.2 SDK ä»¥ä¸Šç‰ˆæœ¬ï¼Œåˆ›å»ºä»¥ä¸‹æ¨¡æ¿ç›®å½•ç»“æ„ï¼š

    parent_folder
    â”œâ”€â”€â”€ test
    â””â”€â”€â”€ working
        â””â”€â”€â”€ templates

åœ¨ templates æ¨¡æ¿ç›®å½• extensions ä¸‹åˆ›å»ºä¸€ä¸ªæ¡ç›®æ¨¡æ¿ï¼š

    working
    â””â”€â”€â”€ templates
        â””â”€â”€â”€ extensions

åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°ä¸€ä¸ª Reverse æ–¹æ³•ä½œä¸ºæ¨¡æ¿æ–‡ä»¶ Reverse.cs çš„ä»£ç å†…å®¹ï¼š

    using System;

    namespace System
    {
        public static class StringExtensions
        {
            public static string Reverse(this string value)
            {
                var tempArray = value.ToCharArray();
                Array.Reverse(tempArray);
                return new string(tempArray);
            }
        }
    }

å†åˆ›å»ºé…å¥—çš„æ¨¡æ¿é…ç½®æ–‡ä»¶ï¼š

    working
    â””â”€â”€â”€ templates
        â””â”€â”€â”€ extensions
            â””â”€â”€â”€ .template.config
                    template.json

é…ç½®æ–‡ä»¶å†…å®¹ç±»ä¼¼å¦‚ä¸‹ï¼š

    {
      "$schema": "http://json.schemastore.org/template",
      "author": "Me",
      "classifications": [ "Common", "Code" ],
      "identity": "ExampleTemplate.StringExtensions",
      "name": "Example templates: string extensions",
      "shortName": "stringext",
      "tags": {
        "language": "C#",
        "type": "item"
      }
    }

ç„¶åï¼Œæ‰§è¡Œå‘½ä»¤å®‰è£…æ¨¡æ¿ï¼Œ-i è¡¨ç¤º --install å®‰è£…ï¼Œä»¥ä¸‹å‘½ä»¤å®‰è£…å½“å‰ç›®å½•ä¸­çš„æ¨¡æ¿ï¼š

    On Windows: dotnet new -i .\
    On Linux or macOS: dotnet new -i ./

å¹¶æµ‹è¯•ä½¿ç”¨å®‰è£…ï¼Œçœ‹åˆ°è¾“å‡º Reverse æ–¹æ³•å¤„ç†ç»“æœ `!dlroW olleH` å³å®Œæˆï¼š
    
    dotnet new console
    dotnet new stringext
    dotnet run

è¦å¸è½½æ¨¡æ¿ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    dotnet new -u C:\working\templates\extensions



## ==âš¡ Tutorial: Create an project template

åˆ›å»ºé¡¹ç›®æ¨¡æ¿ä¸æ¡ç›®æ¨¡æ¿ç±»ä¼¼ï¼Œä½¿ç”¨äº† csproj æ–‡ä»¶ä½œä¸º C# é¡¹ç›®æ–‡ä»¶:

    working
    â””â”€â”€â”€ templates
        â””â”€â”€â”€ consoleasync
                consoleasync.csproj
                Program.cs

ç¼–å†™é¡¹ç›®å…¥å£æ–‡ä»¶ä»£ç  Program.csï¼š

    using System;
    using System.Threading.Tasks;

    namespace consoleasync
    {
        class Program
        {
            static async Task Main(string[] args)
            {
                await Console.Out.WriteAsync("Hello World with C# 8.0!");
            }
        }
    }

ä¿®æ”¹é¡¹ç›®æ–‡ä»¶ consoleasync.csproj é…ç½®é¡¹ç›®ç±»å‹ï¼Œä½¿ç”¨çš„æ¡†æ¶ç‰ˆæœ¬å’Œä½¿ç”¨çš„è¯­è¨€ç‰ˆæœ¬ç­‰ã€‚ä»¥ä¸‹æŒ‡å®šäº†è¾“å‡º .Net Core App 2.0 çš„ EXE å¯æ‰§è¡Œç¨‹åºï¼š

    <Project Sdk="Microsoft.NET.Sdk">

      <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>netcoreapp2.2</TargetFramework>

        <LangVersion>8.0</LangVersion>

      </PropertyGroup>
      
    </Project>

ç„¶åè®¾ç½®æ¨¡æ¿é…ç½®æ–‡ä»¶ï¼š

    working
    â””â”€â”€â”€templates
        â””â”€â”€â”€consoleasync
            â””â”€â”€â”€.template.config
                    template.json

ç¼–è¾‘ template.json æ¨¡æ¿é…ç½®å†…å®¹ï¼š

    {
      "$schema": "http://json.schemastore.org/template",
      "author": "Me",
      "classifications": [ "Common", "Console", "C#8" ],
      "identity": "ExampleTemplate.AsyncProject",
      "name": "Example templates: async project",
      "shortName": "consoleasync",
      "tags": {
        "language": "C#",
        "type": "project"
      }
    }

è®¾ç½® tags æ–¹ä¾¿ NuGet ç¤¾åŒºçš„ç”¨æˆ·æŸ¥æ‰¾åˆ°æ¨¡æ¿ã€‚

ç„¶åï¼Œæ‰§è¡Œå‘½ä»¤å®‰è£…æ¨¡æ¿å¹¶æµ‹è¯•ä½¿ç”¨ï¼Œ-i è¡¨ç¤º --install å®‰è£…ï¼Œä»¥ä¸‹å‘½ä»¤å®‰è£…å½“å‰ç›®å½•ä¸­çš„æ¨¡æ¿ã€‚å®‰è£…é¡¹ç›®æ¨¡æ¿æ—¶ä¼šåˆ›å»º consoleasync ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¸å†æ¡ç›®æ¨¡æ¿çš„å®‰è£…ä¼šåŒ…å«å…¶ç›®å½•ï¼š

    dotnet new -i .\

    dotnet new consoleasync
    dotnet run

    dotnet new -u C:\working\templates\consoleasync

ä½¿ç”¨æ¨¡æ¿åˆ›å»ºæ—¶ï¼Œextensions æ¨¡æ¿æ¡ç›®åŒ…æ‹¬æ–‡ä»¶å¤¹å°±ä¼šå¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹ã€‚



## ==âš¡ Tutorial: Create a template pack

åˆ›å»ºæ¨¡æ¿æ‰“åŒ…è¦å®ç°çš„ç›®æ ‡ï¼š

- Create a `*.csproj` project to build a template pack
- Configure the project file for packing
- Install a template from a NuGet package file
- Uninstall a template by package ID

æ‰“åŒ…ä»¥ NuGet package (.nupkg) æ–‡ä»¶å­˜å‚¨ï¼Œå’Œå…¶å®ƒ NuGet åŒ…ä¸€æ ·ï¼Œå¯ä»¥ä¸Šä¼ åˆ° NuGet feed æœåŠ¡å™¨ï¼Œä½¿ç”¨ `dotnet new -i` å‘½ä»¤ä»æœåŠ¡å™¨ä¸Šå®‰è£…ï¼Œç„¶åä¸­ä½¿ç”¨ã€‚

å¯ä»¥é€šè¿‡ä¿®æ”¹ç°æœ‰æ¨¡æ¿å¼€å§‹ç€æ‰‹æ‰“é€ è‡ªå·±çš„æ¨¡æ¿ï¼š

    dotnet new console -n templatepack -o .

åˆ›å»ºæ¨¡æ¿å·¥ç¨‹ï¼Œå¾—åˆ°ä¸€ä¸ªé¡¹ç›®æ–‡ä»¶ï¼Œä¿®æ”¹å®ƒ templatepack.csproj ï¼š

    <Project Sdk="Microsoft.NET.Sdk">

      <PropertyGroup>
        <PackageType>Template</PackageType>
        <PackageVersion>1.0</PackageVersion>
        <PackageId>AdatumCorporation.Utility.Templates</PackageId>
        <Title>AdatumCorporation Templates</Title>
        <Authors>Me</Authors>
        <Description>Templates to use when creating an application for Adatum Corporation.</Description>
        <PackageTags>dotnet-new;templates;contoso</PackageTags>

        <TargetFramework>netstandard2.0</TargetFramework>
        <!-- 
            <OutputType>Exe</OutputType>
            <TargetFramework>netcoreapp2.0</TargetFramework>
         -->

        <IncludeContentInPack>true</IncludeContentInPack>
        <IncludeBuildOutput>false</IncludeBuildOutput>
        <ContentTargetFolders>content</ContentTargetFolders>
      </PropertyGroup>

      <ItemGroup>
        <Content Include="templates\**\*" Exclude="templates\**\bin\**;templates\**\obj\**" />
        <Compile Remove="**\*" />
      </ItemGroup>

    </Project>

ç•™æ„ `<PropertyGroup>` è®¾ç½®å„ç§å±æ€§ï¼Œåˆ†æˆä¸‰ç±»ã€‚

ä¸»è¦æ˜¯å‰é¢é…ç½®çš„ NuGet package ä¿¡æ¯ï¼Œç”¨äºç¡®å®šä¾èµ–åŒ…åœ¨ NuGet feed çš„ä½ç½®ï¼Œ æŒ‡å®š `<PackageId>` æ ‡å¿—å¯ä»¥åœ¨å¸è½½æ¨¡æ¿æ—¶æ›¿ä»£ç›®å½•è·¯å¾„ï¼Œä» NuGet feed æœåŠ¡å™¨ä¸Šå®‰è£…æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚å…¶å®ƒçš„ `<Title>` æˆ– `<PackageTags>` å°±æ˜¯åœ¨ NuGet feed æ˜¾ç¤ºçš„å…ƒæ•°æ®ï¼Œå¯ä»¥æŒ‡å®šæ ‡é¢˜æˆ–ä½œè€…ä¿¡æ¯ç­‰ã€‚ 

`<TargetFramework>` è®¾ç½® MSBuild ç¼–è¯‘å·¥å…·ä»¥åˆé€‚çš„æ¡†æ¶æ‰“åŒ…å·¥ç¨‹ï¼Œè¿™é‡ŒæŒ‡å®šçš„ TFM æ˜¯ .Net Standard 2.0 åº“æ–‡ä»¶è¾“å‡ºã€‚è¦è¾“å‡ºå¯æŒ‡æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿ç”¨æ³¨è§£éƒ¨åˆ†æ›¿æ¢å³å¯ï¼Œä½†æœ€åè¿˜æ˜¯ç”Ÿæˆåº“æ–‡ä»¶ã€‚

åé¢çš„éƒ¨åˆ†é…ç½®æ‰“åŒ… NuGet pack æ—¶ï¼Œå¦‚ä½•åŒ…å«æ¨¡æ¿çš„ç›®å½•ç­‰ã€‚

`<ItemGroup>`åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œ `<Content>` è®¾ç½® Include ä½¿ç”¨åŒæ˜ŸåŒ¹é…ä»»æ„å±‚çº§ç›®å½•ï¼Œå•æ˜Ÿé…ç½®ä»»æ„æ–‡ä»¶ï¼Œå³åŒ…å«æŒ‡å®šç›®å½•çš„æ‰€æœ‰å†…å®¹åˆ°æ¨¡æ¿ã€‚è®¾ç½® Exclude æ’é™¤æŒ‡å®šç›®å½•çš„æ‰€æœ‰å†…å®¹ã€‚ ç¬¬äºŒéƒ¨åˆ†æ˜¯ `<Compile>` è®¾ç½®åœ¨ç¼–è¯‘æ—¶æ’é™¤æ‰€æœ‰ä»£ç æ–‡ä»¶ï¼Œä»»ä½•ä½ç½®ï¼Œè¿™é˜²æ­¢åˆ›å»ºæ¨¡æ¿æ—¶å°†ä»£ç ç¼–è¯‘ã€‚

æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼ŒNuGet package ä¼šè¾“å‡ºåˆ° working\bin\Debug ç›®å½•ä¸‹ï¼š

    dotnet pack

ç„¶åï¼Œæ‰§è¡Œæ¨¡æ¿å®‰è£…å‘½ä»¤ `dotnet new -i PATH_TO_NUPKG_FILE` æµ‹è¯•å®‰è£…æ¨¡æ¿ï¼š

    dotnet new -i C:\working\bin\Debug\AdatumCorporation.Utility.Templates.1.0.0.nupkg

å¦‚æœä½¿ç”¨ NuGet Feedï¼Œå¯ä»¥ä½¿ç”¨ `dotnet new -i PACKAGEID` å‘½ä»¤å®‰è£…æ¨¡æ¿ï¼Œ PACKAGEID å³ `<PackageId>` æŒ‡å®šçš„ã€‚

ä½¿ç”¨å‘½ä»¤å¸è½½æ¨¡æ¿ï¼š

    Run dotnet new -u AdatumCorporation.Utility.Templates


é€‰æ‹©åˆé€‚çš„ SDK å’Œåº”ç”¨ç±»å‹ï¼Œå†³å®šäº†ç¼–è¯‘æ—¶ç”Ÿæˆçš„æ–‡ä»¶ç±»å‹ã€‚è¦ç”Ÿæˆ Web EXE å¯æ‰§è¡Œç¨‹åºï¼Œé…ç½®é¡¹ç›®æ—¶å¯ä»¥è®¾ç½®å·¥ç¨‹ç±»å‹ä¸º Microsoft.NET.Sdk.Web ï¼Œnetstandard2.0 å’Œ netcoreapp2.0 ç±»åº“æ¡†æ¶é™¤å¤–ï¼Œå…¶å®ƒæ¡†æ¶éƒ½å¯ä»¥ç”Ÿæˆ DLL åº“å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚é€šè¿‡è®¾ç½®ä¸åŒçš„ SDK ç”¨æ¥ç”Ÿæˆä¸åŒçš„ç¨‹åºè¾“å‡ºï¼š

| .NET Sdk ç±»å‹                     | ç›®æ ‡åº”ç”¨                            |
| :-------------------------------- | ----------------------------------- |
| Microsoft.NET.Sdk                 | Libraray/Console                    |
| Microsoft.NET.Sdk.Web             | Web/MVC/Razor/Blazor/Web API ...    |
| Microsoft.NET.Sdk.WindowsDesktop  | WinForm/WPF                         |


å¯ä»¥ä½¿ç”¨æ¡†æ¶ç‰ˆæœ¬é€‰æ‹©ï¼š

    <TargetFramework>netstandard2.0</TargetFramework>
    <TargetFramework>netcoreapp2.0</TargetFramework>
    <TargetFramework>netcoreapp3.1</TargetFramework>
    <TargetFramework>netcoreapp3.0</TargetFramework>
    <TargetFrameworks>netcoreapp5.0;net4.7.2;net4.6.1;net4.6.2;</TargetFrameworks>

æŒ‡å®šäº†å¤šç›®æ ‡æ¡†æ¶æ—¶ï¼Œå¯ä»¥æŒ‡å®šè¿è¡Œçš„ç›®æ ‡æ¡†æ¶ï¼š

    dotnet run --framework netcoreapp5.0
    dotnet run --framework net4.7.2

ç¼–è¯‘æ—¶ï¼Œä¼šç»Ÿä¸€ç”Ÿæˆå„ç›®æ ‡æ¡†æ¶çš„ç¨‹åºï¼š

    >dotnet build
    Microsoft (R) Build Engine version 16.7.0-preview-20220-01+80e487bff for .NET Core
    Copyright (C) Microsoft Corporation. All rights reserved.

      Determining projects to restore...
      Restored c:\working\async.csproj (in 426 ms).
      You are using a preview version of .NET. See: https://aka.ms/dotnet-core-preview
      async -> c:\working\bin\Debug\netcoreapp5.0\async.dll
      async -> c:\working\bin\Debug\net4.7.2\async.exe
      async -> c:\working\bin\Debug\net4.6.1\async.exe
      async -> c:\working\bin\Debug\net4.6.2\async.exe
      async -> c:\working\bin\Debug\netcoreapp3.1\async.dll
      async -> c:\working\bin\Debug\netcoreapp3.0\async.dll
      async -> c:\working\bin\Debug\netcoreapp2.0\async.dll
      async -> c:\working\bin\Debug\netstandard2.0\async.dll




# =ğŸš© Demo Cookbook


## ==âš¡ Exit Program

é€€å‡ºä¸€ä¸ª Window GUI ç¨‹åºéœ€è¦å‘é€ç»ˆæ­¢æ¶ˆæ¯æ¥ç»“æŸæ¶ˆæ¯ç¯ Message Loopï¼Œä»¥ä¸‹ä¸‰ç§æ–¹å¼çš„å·®åˆ«ï¼š

- form.Close();

    è°ƒç”¨çª—å£å®ä¾‹çš„å…³é—­æ–¹æ³•ï¼Œåªæ˜¯å…³é—­å½“å‰çª—å£ï¼Œè‹¥ä¸æ˜¯ä¸»çª—ä½“å°±æ— æ³•é€€å‡ºç¨‹åºï¼Œå¦å¤–è‹¥æœ‰æ‰˜ç®¡çº¿ç¨‹ï¼ˆéä¸»çº¿ç¨‹ï¼‰ï¼Œä¹Ÿæ— æ³•å¹²å‡€åœ°é€€å‡ºã€‚

- Application.Exit();

    å¼ºåˆ¶æ‰€æœ‰æ¶ˆæ¯æ³µç»ˆæ­¢ï¼Œé€€å‡ºæ‰€æœ‰çš„çª—ä½“ï¼Œä½†æ˜¯è‹¥æœ‰æ‰˜ç®¡çº¿ç¨‹ï¼ˆéä¸»çº¿ç¨‹ï¼‰ï¼Œä¹Ÿæ— æ³•å¹²å‡€åœ°é€€å‡ºã€‚ 

- Application.ExitThread();

    å¼ºåˆ¶ä¸­æ­¢è°ƒç”¨çº¿ç¨‹ä¸Šçš„æ‰€æœ‰æ¶ˆæ¯ï¼ŒåŒæ ·é¢ä¸´å…¶å®ƒçº¿ç¨‹æ— æ³•æ­£ç¡®é€€å‡ºçš„é—®é¢˜ã€‚

- Environment.Exit(exitCode);

    è¿™æ˜¯æœ€å½»åº•çš„é€€å‡ºæ–¹å¼ï¼Œä¸ç®¡ä»€ä¹ˆçº¿ç¨‹éƒ½è¢«å¼ºåˆ¶é€€å‡ºï¼ŒæŠŠç¨‹åºç»“æŸçš„å¾ˆå¹²å‡€ã€‚ 


## ==âš¡ Randomize
https://docs.microsoft.com/en-us/dotnet/api/system.random

    Random rnd = new Random();
    string[] malePetNames = { "Rufus", "Bear", "Dakota", "Fido",
                              "Vanya", "Samuel", "Koani", "Volodya",
                              "Prince", "Yiska" };
    string[] femalePetNames = { "Maggie", "Penny", "Saya", "Princess",
                                "Abby", "Laila", "Sadie", "Olivia",
                                "Starlight", "Talla" };

    // Generate random indexes for pet names.
    int mIndex = rnd.Next(malePetNames.Length);
    int fIndex = rnd.Next(femalePetNames.Length);

    // Display the result.
    Console.WriteLine("Suggested pet name of the day: ");
    Console.WriteLine("   For a male:     {0}", malePetNames[mIndex]);
    Console.WriteLine("   For a female:   {0}", femalePetNames[fIndex]);

    // The example displays the following output:
    //       Suggested pet name of the day:
    //          For a male:     Koani
    //          For a female:   Maggie


    // Instantiate random number generator using system-supplied value as seed.
    var rand = new Random();

    // Generate and display random byte (integer) values.
    var bytes = new byte[5];
    rand.NextBytes(bytes);

    // Generate and display random integers.
    Console.Write("{0,15:N0}", rand.Next());

    // Generate and display random integers between 0 and 100.
    Console.Write("{0,8:N0}", rand.Next(101));

    // Generate and display random integers from 50 to 100.
    Console.Write("{0,8:N0}", rand.Next(50, 101));

    // Generate and display random floating point values from 0 to 1.
    Console.Write("{0,8:N3}", rand.NextDouble());

    // Generate and display random floating point values from 0 to 5.
    Console.Write("{0,8:N3}", rand.NextDouble() * 5);


## ==âš¡ RSA Certificate è¯ä¹¦è¯»å†™
https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.x509certificates.x509contenttype

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ X509Certificate2 å¯¹è±¡è¯»å– PFX è¯ä¹¦æ–‡ä»¶ï¼Œä»¥å¯å¯¼å‡ºçš„æ–¹å¼è¯»å–ï¼Œä»¥ä½¿ç”¨ Export å†æ¬¡å¯¼å‡ºï¼Œå¯¼å‡ºæ—¶æ²¡æœ‰è®¾ç½®å¯†ç ã€‚

    using System;
    using System.IO;
    using System.Security.Cryptography.X509Certificates;

    public class X509
    {

        public static void Main()
        {
            // The path to the certificate.
            string Certificate = "ca-test/localhost.pfx";

            // Load the certificate into an X509Certificate2 object.
            X509Certificate2 cert = new X509Certificate2(Certificate, "123456",  X509KeyStorageFlags.Exportable);

            cert.FriendlyName = ".Net Core Test";
            byte[] bytes = cert.Export(X509ContentType.Pkcs12);
            File.WriteAllBytes(Certificate.Replace(".pfx", "-friendly.pfx"), bytes);

            byte[] certData = cert.Export(X509ContentType.Cert);

            X509Certificate newCert = new X509Certificate(certData);

            // Get the value.
            string resultsTrue = newCert.ToString(true);

            // Display the value to the console.
            Console.WriteLine(resultsTrue);

            // Get the value.
            string resultsFalse = newCert.ToString(false);

            // Display the value to the console.
            Console.WriteLine(resultsFalse);
        }
    }

åˆ›å»º X509 è¯ä¹¦æ–¹æ³•è¾ƒå¤šï¼Œé€šè¿‡CAè·å–è¯ä¹¦ï¼Œ é€šè¿‡å¾®è½¯æä¾›çš„ makecert å·¥å…·ç”Ÿæˆç”¨äºæµ‹è¯•çš„è¯ä¹¦ã€‚ç¼–ç¨‹çš„æ–¹æ³•åˆ›å»ºæœ€çµæ´»ï¼Œ.Net æä¾›äº† X509Certificate2 ç±»ï¼Œè¯¥ç±»å¯ä»¥ç”¨äºåˆ›å»ºè¯ä¹¦ï¼Œä½†åªèƒ½ä» RawData ä¸­åˆ›å»ºï¼Œåˆ›å»ºåæ— æ³•ä¿®æ”¹é™¤ FriendlyName ä»¥å¤–çš„ä»»ä½•å±æ€§ã€‚

X509ContentType æšä¸¾ï¼š

| Authenticode  | 6 | An Authenticode X.509 certificate. |
| Cert      | 1 | A single X.509 certificate. |
| Pfx       | 3 | A PFX-formatted certificate, identical to the Pkcs12 |
| Pkcs12    | 3 | A PKCS #12-formatted certificate. |
| Pkcs7     | 5 | A PKCS #7-formatted certificate. |
| SerializedCert    | 2 | A single serialized X.509 certificate. |
| SerializedStore   | 4 | A serialized store. |
| Unknown   | 0 | An unknown X.509 certificate. |



## ==âš¡ STAThread & MTAThread & COM
- [STAThread Attribute](https://docs.microsoft.com/en-us/dotnet/api/system.stathreadattribute)
- [MTAThread Attribute](https://docs.microsoft.com/en-us/dotnet/api/system.mtathreadattribute)
- [Understanding and Using COM Threading Models](https://docs.microsoft.com/en-us/previous-versions/ms809971(v=msdn.10))
- [.NET Standard 2.2 - System.Threading](netstandard\ref\System.Threading.cs)

[STAThread] æ˜¯ä¸€ç§çº¿ç¨‹å•å…ƒæ¨¡å‹ï¼Œåªç”¨åœ¨ç¨‹åºçš„å…¥å£æ–¹æ³•ä¸Šï¼ŒC# å’Œ VB.NET é‡Œæ˜¯ Main() å…¥å£æ–¹æ³•ï¼Œæ¥æŒ‡å®šå½“å‰ COM çº¿ç¨‹æ¨¡å‹çš„æ˜¯å•ä¸€çº¿ç¨‹å•å…ƒçº¿ç¨‹ STA - Single Thread Apartmentï¼Œä¸ä¹‹å¯¹åº”çš„æ˜¯ MTA - Multithreaded Apartment æ¨¡å¼ã€‚

    [System.AttributeUsage(System.AttributeTargets.Method)]
    public sealed class STAThreadAttribute : Attribute

    [System.AttributeUsage(System.AttributeTargets.Method)]
    public sealed class MTAThreadAttribute : Attribute

ç”±äºå¾ˆå¤š COM ç»„ä»¶ä¸èƒ½åœ¨ .NET çš„å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¿è¡Œï¼Œå¦‚æœä¸å£°æ˜ç¨‹åºä¸º STAThread çš„è¯ï¼Œ.NET å°±ä¼šè‡ªåŠ¨ä½¿ç”¨å¤šçº¿ç¨‹æ¥æé«˜æ•ˆç‡ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸å¯é¢„çŸ¥çš„åæœã€‚

æ¯”å¦‚å¼€æ–‡ä»¶çª—å£ï¼š

    var dialog1 = new OpenFileDialog();
    if (dialog1.ShowDialog() == DialogResult.OK)...

åœ¨å¼€å§‹çº¿ç¨‹å‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æŒ‡å®šçº¿ç¨‹æ¨¡å‹ï¼š

    Thread thred = new Thread(new ThreadStart(InvokeMethod));
    thread.SetApartmentState(ApartmentState.STA);
    thread.TrySetApartmentState(ApartmentState.STA);

ç¤ºä¾‹ï¼š

    private Thread invokeThread;
    private DialogResult result;
    private OpenFileDialog openDialog;
    private void button1_Click(object sender, /*LinkLabelLinkClicked*/EventArgs e)
    {
        openDialog = new OpenFileDialog();
        // openDialog.InitialDirectory = path;
        openDialog.Filter = "wav files (*.wav)|*.wav|mpeg-3 layer|*.mp3";

        invokeThread = new Thread(new ThreadStart(InvokeMethod));
        invokeThread.SetApartmentState(ApartmentState.STA);
        invokeThread.Start();
        invokeThread.Join();

        if (result == DialogResult.OK)
        {
            if (openDialog.FileName != "")
            {
                PlaySound(openDialog.FileName, new System.IntPtr(), PlaySoundFlags.SND_ASYNC);
            }
        }
    }

    private void InvokeMethod()
    {
        result = openDialog.ShowDialog();
    }


åœ¨ .NET Framework 2.0ï¼Œé»˜è®¤çš„ COM çº¿ç¨‹æ¨¡å‹æ ¹æ®ä¸åŒçš„è¯­è¨€æœ‰ä¸åŒçš„é»˜è®¤å€¼ï¼š

| Language  | COM apartment model |
| :-------- | :------------------ |
| C#    | Multithreaded apartment |
| C++   | Multithreaded apartment |
| Visual Basic  | Single-threaded apartment |

è®¤è¯†ä¸€ä¸‹çº¿ç¨‹å•å…ƒæ¨¡å‹çš„å…³é”®ç‚¹ï¼š

- An apartment is not a thread. The one-to-one relationship between threads and single-threaded apartments may lead you to believe that the two terms are interchangeableâ€”they are not.
- An object is not an apartment. Objects are created in apartments.
- A particular instance of an object can belong to only one apartment.
- An apartment's concurrency model, whether it is single-threaded or multi-threaded, cannot be changed after it is created.
- A process can have zero or more single-threaded apartmentsâ€”one for each thread that calls CoInitialize.
- A process has one multi-threaded apartment or none at allâ€”all threads that call CoInitializeEx with COINIT_MULTITHREADED share the same apartment.

åœ¨ COM ç»„ä»¶çš„ Client ä¸ Server é—´ï¼ŒObject Threading Models å‚è€ƒï¼š

| Client Model  | Server Model  | Server created in:    | Inter-object communication via: |
| :-----------  | :-----------  | :----------- | :----------- |
| STA   | MTA   | MTA (created if one doesn't already exist)    | Marshaling, unless server implements the free-threaded marshaler and is in the same process |
| MTA   | STA   | A new STA, created by COM | Marshaling |
| STA   | Both  | Client's STA  | Direct access |
| MTA   | Both  | MTA   | Direct access |


System.Diagnostics.Process.Start() é™æ€æ–¹æ³•å¯ä»¥å¼¹çª—æ‰“å¼€æŸä¸ªé“¾æ¥ç½‘å€ï¼Œå®šä½æ‰“å¼€æŸä¸ªæ–‡ä»¶ç›®å½•ï¼Œæ‰“å¼€ç³»ç»Ÿç‰¹æ®Šæ–‡ä»¶å¤¹ï¼Œå¦‚æ§åˆ¶é¢æ¿ç­‰ã€‚

| åç§°    | è¯´æ˜ |
| :------ | :------ |
| Start()    | å¯åŠ¨ï¼ˆæˆ–é‡ç”¨ï¼‰æ­¤ Process ç»„ä»¶çš„ StartInfo å±æ€§æŒ‡å®šçš„è¿›ç¨‹èµ„æºï¼Œå¹¶å°†å…¶ä¸è¯¥ç»„ä»¶å…³è”ã€‚ |
| Start(ProcessStartInfo)    | å¯åŠ¨ç”±åŒ…å«è¿›ç¨‹å¯åŠ¨ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œè¦å¯åŠ¨çš„è¿›ç¨‹çš„æ–‡ä»¶åï¼‰çš„å‚æ•°æŒ‡å®šçš„è¿›ç¨‹èµ„æºï¼Œå¹¶å°†è¯¥èµ„æºä¸æ–°çš„ Process ç»„ä»¶å…³è”ã€‚ |
| Start(String)    | é€šè¿‡æŒ‡å®šæ–‡æ¡£æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶çš„åç§°æ¥å¯åŠ¨è¿›ç¨‹èµ„æºï¼Œå¹¶å°†èµ„æºä¸æ–°çš„ Process ç»„ä»¶å…³è”ã€‚ |
| Start(String, String)    | é€šè¿‡æŒ‡å®šåº”ç”¨ç¨‹åºçš„åç§°å’Œä¸€ç»„å‘½ä»¤è¡Œå‚æ•°æ¥å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹èµ„æºï¼Œå¹¶å°†è¯¥èµ„æºä¸æ–°çš„ Process ç»„ä»¶ç›¸å…³è”ã€‚ |
| Start(String, String, SecureString, String)    | é€šè¿‡æŒ‡å®šåº”ç”¨ç¨‹åºçš„åç§°ã€ç”¨æˆ·åã€å¯†ç å’ŒåŸŸæ¥å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹èµ„æºï¼Œå¹¶å°†è¯¥èµ„æºä¸æ–°çš„ Process ç»„ä»¶å…³è”èµ·æ¥ã€‚ |
| Start(String, String, String, SecureString, String)    | é€šè¿‡æŒ‡å®šåº”ç”¨ç¨‹åºçš„åç§°å’Œä¸€ç»„å‘½ä»¤è¡Œå‚æ•°ã€ç”¨æˆ·åã€å¯†ç å’ŒåŸŸæ¥å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹èµ„æºï¼Œå¹¶å°†è¯¥èµ„æºä¸æ–°çš„ Process ç»„ä»¶å…³è”èµ·æ¥ã€‚ |


WinForms ç¤ºä¾‹ç¨‹åºï¼š

    using System;
    using System.Drawing;
    using System.Windows.Forms;
    using System.Runtime.InteropServices;
    using System.Threading;

    namespace WinSound
    {
        public partial class Form1 : Form
        {
            private TextBox textBox1;
            private Button button1;

            // [STAThread]
            [MTAThread]
            public static void Main()
            {
                var form = new Form1();
                form.Load += (sender, eventArgs) => Console.WriteLine($"Form load [{sender}] [{eventArgs}]");

                form.Show();
                Application.Run(form); // handle Windows Message Loop
            }

            public Form1()  // Constructor.
            {
                InitializeComponent();
            }

            protected override void OnLoad(EventArgs e)
            {
                Console.WriteLine("On load "+DateTime.Now.ToString("mm:ss-ffff"));
                this.KeyPreview = true;
            }

            [DllImport("winmm.DLL", EntryPoint = "PlaySound", SetLastError = true, CharSet = CharSet.Unicode, ThrowOnUnmappableChar = true)]
            private static extern bool PlaySound(string szSound, System.IntPtr hMod, PlaySoundFlags flags);

            [System.Flags]
            public enum PlaySoundFlags : int
            {
                SND_SYNC = 0x0000,
                SND_ASYNC = 0x0001,
                SND_NODEFAULT = 0x0002,
                SND_LOOP = 0x0008,
                SND_NOSTOP = 0x0010,
                SND_NOWAIT = 0x00002000,
                SND_FILENAME = 0x00020000,
                SND_RESOURCE = 0x00040004
            }

            private void button1_Click_STAThread(object sender, System.EventArgs e)
            {
                var dialog1 = new OpenFileDialog();

                dialog1.Title = "Browse to find sound file to play";
                dialog1.InitialDirectory = @"c:\";
                dialog1.Filter = "Wav Files (*.wav)|*.wav";
                dialog1.FilterIndex = 2;
                dialog1.RestoreDirectory = true;

                if (dialog1.ShowDialog() == DialogResult.OK)
                {
                    textBox1.Text = dialog1.FileName;
                    PlaySound(dialog1.FileName, new System.IntPtr(), PlaySoundFlags.SND_ASYNC );
                }
                Console.WriteLine("On button click "+DateTime.Now.ToString("mm:ss-ffff"));
            }

            private Thread invokeThread;
            private DialogResult result;
            private OpenFileDialog openDialog;
            private void button1_Click(object sender, /*LinkLabelLinkClicked*/EventArgs e)
            {
                openDialog = new OpenFileDialog();
                // openDialog.InitialDirectory = path;
                openDialog.Filter = "wav files (*.wav)|*.wav|mpeg-3 layer|*.mp3";

                invokeThread = new Thread(new ThreadStart(InvokeMethod));
                invokeThread.SetApartmentState(ApartmentState.STA);
                invokeThread.Start();
                invokeThread.Join();

                if (result == DialogResult.OK)
                {
                    if (openDialog.FileName != "")
                    {
                        PlaySound(openDialog.FileName, new System.IntPtr(), PlaySoundFlags.SND_ASYNC);
                    }
                }
            }

            private void InvokeMethod()
            {
                result = openDialog.ShowDialog();
            }

            private Keys _key = Keys.NoName;
            protected override void OnKeyDown(KeyEventArgs e) {
                Console.WriteLine("On key down "+e.KeyCode.ToString());
                base.OnKeyDown(e);
                _key = e.KeyCode;
                Refresh(); // cause paint event
            }
        
            private Point _point = new Point();
            protected override void OnMouseMove(MouseEventArgs e) {
                base.OnMouseDown(e);
                _point = new Point(e.X, e.Y);
                Console.WriteLine($"On mouse move {_point}");
                Refresh();
            }

            protected override void OnPaint(PaintEventArgs e) {
                base.OnPaint(e);
                Console.WriteLine("On paint "+DateTime.Now.ToString("mm:ss-ffff"));
        
                Font font = new Font(this.Font.FontFamily, 24F);

                e.Graphics.DrawString(
                    String.Format("{0} : {1}", _point.X, _point.Y), // Draw Content
                    font, new SolidBrush(Color.Red),
                    _point  // Draw Position
                    );
        
                string showText = _key.ToString();
                font = new Font(this.Font.FontFamily, 16F);
                SizeF size = e.Graphics.MeasureString(showText, font);

                e.Graphics.DrawString(showText, font, new SolidBrush(Color.Green), 
                    (_point.X-this.Width/2)/2 + this.Width/2, (_point.Y-this.Height/2)/2 + this.Height/2);
            }

            private void InitializeComponent()
            {
                this.button1 = new System.Windows.Forms.Button();
                this.textBox1 = new System.Windows.Forms.TextBox();
                this.SuspendLayout();

                this.button1.Location = new System.Drawing.Point(192, 40);
                this.button1.Name = "button1";
                this.button1.Size = new System.Drawing.Size(88, 24);
                this.button1.TabIndex = 0;
                this.button1.Text = "Browse";
                this.button1.Click += new System.EventHandler(this.button1_Click);

                this.textBox1.Location = new System.Drawing.Point(8, 40);
                this.textBox1.Name = "textBox1";
                this.textBox1.Size = new System.Drawing.Size(168, 20);
                this.textBox1.TabIndex = 1;
                this.textBox1.Text = "FIle path";

                this.AutoScaleDimensions = new System.Drawing.SizeF(5, 13);
                this.ClientSize = new System.Drawing.Size(292, 266);
                this.Controls.Add(this.textBox1);
                this.Controls.Add(this.button1);
                this.Name = "Form1";
                this.Text = "Platform Invoke WinSound C#";
                this.ResumeLayout(false);
                this.PerformLayout();       }
        }
    }



## ==âš¡ Windows HOOK API
- [EasyHook for Windows API](http://easyhook.github.io/tutorials/createlocalhook.html)

é’©å­ Hook API æ˜¯ Windows çš„ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œåˆ©ç”¨é’©å­å¯ä»¥ç›‘å¬ç³»ç»Ÿæ¶ˆæ¯äº‹ä»¶ï¼Œæ¯”å¦‚å…¶å®ƒç¨‹åºçš„æŒ‰é”®æ¶ˆæ¯ç­‰ï¼Œå…¶å®ƒç¨‹åºè°ƒç”¨æŸå‡½æ•°å‰è¿›è¡Œæ‹¦æˆªç­‰ã€‚ä½¿ç”¨ C++ ç¼–å†™å¯ä»¥è·å–å®Œæ•´çš„ Hook API åŠŸèƒ½ï¼Œä½¿ç”¨ C# åªèƒ½æœ¬åœ°è¿›ç¨‹ä½¿ç”¨ã€‚

    using System;
    using System.Linq;
    using System.Drawing;
    using System.Runtime.InteropServices;
    using System.Windows.Forms;

    public class DiDemo
    {
        [DllImport("user32.dll", CharSet = CharSet.Auto, CallingConvention = CallingConvention.StdCall)]
        public static extern int SetWindowsHookEx(int idHook, HookProc lpfn, IntPtr hInstance, int threadId);

        [DllImport("user32.dll", CharSet = CharSet.Auto, CallingConvention = CallingConvention.StdCall)]
        public static extern bool UnhookWindowsHookEx(int idHook);

        [DllImport("user32.dll", CharSet = CharSet.Auto, CallingConvention = CallingConvention.StdCall)]
        public static extern int CallNextHookEx(int idHook, int nCode, Int32 wParam, IntPtr lParam);

        [DllImport("kernel32.dll")]
        public static extern int GetCurrentThreadId();

        public delegate int HookProc(int nCode, int wParam, IntPtr lParam);


        public struct MSG
        {
             public Point p;
             public IntPtr HWnd;
             public uint wHitTestCode;
             public int dwExtraInfo;
        }
         
        public struct KeyMSG
        {
             public int vkCode;
             public int scanCode;
             public int flags;
             public int time;
             public int dwExtraInfo;
        }
         
        // MSG m = (MSG) Marshal.PtrToStructure(lParam, typeof(MSG));
        // KeyMSG m = (KeyMSG) Marshal.PtrToStructure(lParam, typeof(KeyMSG));

        private static Form form;
        private static void Main(string[] args)
        {
            form = new Form();
            form.KeyPreview = true;
            form.Text = "Press H or X to use KeyBoardHook";
            form.Click += (o, e) => {
                Console.WriteLine("Click");
            };
            form.KeyPress += (o, e) => {
                Console.WriteLine("KeyPress "+e.KeyChar);
                if (e.KeyChar == 'h')
                {
                    HookStart();
                }
                else if(e.KeyChar == 'x')
                {
                    HookStop();
                }
            };
            Application.Run(form);
        }

        static int KeyboardHook = 0;

        private static int KeyboardHookProcedure(int nCode, Int32 wParam, IntPtr lParam)
        {
            Keys keyData = (Keys)wParam;
            var wp = (IntPtr.Size == 8) ? (int)((long)wParam << 32 >> 32) : (int)wParam;
            var lp = (IntPtr.Size == 8) ? (int)lParam.ToInt64() : lParam.ToInt32();
            
            if(keyData == Keys.X) HookStop();
            
            string keystate = (lp>0? "Key down ":"Key up")+ $"... {keyData} ";
            Console.WriteLine( keystate );
            Console.WriteLine($" {lp:N} {lParam:X} {lParam.ToInt64():X}");
            form.Text = (KeyboardHook==0? "Hook Uninstalled ":"Hook Installed ") + keystate;

            if (nCode >= 0)
            {
                return 1;
            }
            return CallNextHookEx(KeyboardHook, nCode, wParam, lParam);
        }

        // SetWindowsHookEx( 13,KeyboardHookProcedure,
        // Marshal.GetHINSTANCE(Assembly.GetExecutingAssembly().GetModules()[0]),0)
        public static void HookStart()
        {
            if (KeyboardHook == 0)
            {
                // KeyboardHookHandler = new HookProc(KeyboardHookProcedure);
                KeyboardHook = SetWindowsHookEx(2, KeyboardHookProcedure, IntPtr.Zero, GetCurrentThreadId());

                if (KeyboardHook == 0)
                {
                    throw new Exception("å®‰è£…é’©å­å¤±è´¥");
                }
                form.Text = "Hook Install";
            }
        }

        public static void HookStop()
        {
            bool retKeyboard = true;
            if (KeyboardHook != 0)
            {
                retKeyboard = UnhookWindowsHookEx(KeyboardHook);
                KeyboardHook = 0;
            }
            if (!retKeyboard) 
            {
                throw new Exception("é’©å­å¸è½½å¤±è´¥");
            }
            form.Text = "Hook Uninstall";
        }
    }


## ==âš¡ SoundPlayer /resource èµ„æºæµæ’­æ”¾
- [MediaSource æ­å»ºæµå¼æ’­æ”¾å™¨](https://zhuanlan.zhihu.com/p/26374202)
- https://archive.codeplex.com/?p=naudio
- [IE Media Source Extensions](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/samples/dn551369(v=vs.85)
- [Firefox Media Source Extensions](https://developer.mozilla.org/en-US/docs/Web/API/MediaSource)
- [The 'Codecs' and 'Profiles' Parameters for "Bucket" Media Types](https://tools.ietf.org/html/rfc6381)

Code:

    using System;
    using System.ComponentModel;
    using System.Reflection;
    using System.IO;
    using System.Resources;
    using System.Media;
    using System.Diagnostics;

    namespace ResourcePlayer
    {
        public partial class Demo
        {
            public static void Main(string[] args)
            {
                if(args.Length == 0 )
                {
                    Console.WriteLine(@"usage: meidia your.wav");
                    ResourcePlay();
                    return; 
                }
                SoundPlayer player = new SoundPlayer();
                SetEventHandler(player);
                // Set file's path 
                player.SoundLocation = args[0];
                player.LoadAsync();
                player.Play(); // PlaySync() PlayLooping() Stop();
                Console.ReadKey();
            }

            private static void SetEventHandler(SoundPlayer player)
            {
                // Listen events
                player.LoadCompleted += new AsyncCompletedEventHandler(player_LoadCompleted);
                // player.OnStreamChanged += new EventHandler(player_StreamChange);
                player.SoundLocationChanged += new EventHandler(player_LocationChanged);
            }
            static private void player_LoadCompleted(object s, AsyncCompletedEventArgs e){
                Console.WriteLine($"LoadCompleted {((SoundPlayer)s).SoundLocation}"); 
            }
            static private void player_StreamChange(object s, EventArgs e){
                Console.WriteLine("StreamChange"); 
            }
            static private void player_LocationChanged(object s, EventArgs e){
                Console.WriteLine($"LocationChanged {e}"); 
            }

            // csc media.cs -resource:"surface.wav"
            protected static void ResourcePlay()
            {
                Assembly assembly = Assembly.GetExecutingAssembly();
                Stream steam = assembly.GetManifestResourceStream("surface.wav");
                // player.Stream = Resources.ResourceManager.GetStream("mySound");
                try
                {
                    Console.WriteLine($"{steam}:{steam.Length}");
                } catch (Exception ex)
                {
                    Console.WriteLine(ex.Message);
                }
                SoundPlayer player = new SoundPlayer(steam);
                SetEventHandler(player);
                player.Play(); 
                Console.ReadKey();
                player.Stream = assembly.GetManifestResourceStream("sub_snare01.wav");
                player.Play();
                Console.ReadKey();
            }
        }
    }

    /*SoundPlayer sp = new SoundPlayer(global::WindowsApplication1.Properties.Resources.yoursoundfilename); */


## ==âš¡ InteropServices DllImport å¯¼å…¥ Win32 API
- [Building a cross-platform C++ library to call from .NET Core](https://www.olegtarasov.me/build-cross-platform-c-library/)
- [Calling a cross-platform C++ library from .NET Core](https://www.olegtarasov.me/call-native-lib-from-net-core/)
- [.Net Source](https://source.dot.net/#System.IO.FileSystem/Interop.CopyFile.cs)
- [C# .Net Interoperablity with Native C Library](https://www.codeproject.com/Tips/709270/Csharp-NET-Interoperability-with-Native-C-Librarie)
- [C# é¢„å¤„ç†å™¨æŒ‡ä»¤](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/preprocessor-directives/)
- [DllImportAttribute ç‰¹æ€§](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.dllimportattribute)
- [Interoperating with unmanaged code](https://docs.microsoft.com/en-us/dotnet/framework/interop/)
- [Interoperability (C# Programming Guide)](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/interop/)
- [å¹³å°è°ƒç”¨ (P/Invoke)](https://docs.microsoft.com/zh-cn/dotnet/standard/native-interop/pinvoke)

C# ä¸ Windows ç³»ç»Ÿ C++ API æˆ– COM äº’æ“ä½œä½¿ç”¨ InteropServices å‘½ä»¤ç©ºé—´ï¼Œéæ‰˜ç®¡çš„ DLL é€šè¿‡ DllImport å±æ€§ç‰¹æ€§å¯¼å…¥ï¼š

    using System;
    using System.Runtime.InteropServices;

    public class Win32 {
         [DllImport("user32.dll", CharSet=CharSet.Auto)]
         public static extern IntPtr MessageBox(int hWnd, String text,
                         String caption, uint type);
    }
    public class HelloWorld {
        public static void Main() {
           Win32.MessageBox(0, "Hello World", "Platform Invoke Sample", 0);
        }
    }

ä¸Šé¢æ¼”ç¤ºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿæ¶ˆæ¯çª—å£ APIï¼Œè°ƒç”¨éæ‰˜ç®¡ API çš„æ­¥éª¤ï¼š

- ç¡®å®š DLL çš„å‡½æ•°ï¼Œè‡³å°‘å‡½æ•°åå’Œ DLL æ–‡ä»¶è¦çŸ¥é“ï¼›
- åˆ›å»ºä¸€ä¸ªå°è£…ç±»æ¥æ‰˜ç®¡è¿™ä¸ª APIï¼›
- ä½¿ç”¨ DllImportAttribute åœ¨æ‰˜ç®¡ä»£ç ä¸­ç¼–å†™ API çš„åŸå‹ï¼›
- ä¼ å…¥å‚æ•°è°ƒç”¨ API;


ä»¥ä¸‹ä»£ç æ¥æº .Net Core ï¼ŒLibraries.SystemNative åº”è¯¥æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œä¼šç”¨ç³»ç»Ÿæ‰€ç”¨çš„ API æ–‡ä»¶æ›¿æ¢ï¼Œå¯ä»¥ä½¿ç”¨ shell32.dllï¼š

    // Licensed to the .NET Foundation under one or more agreements.
    // The .NET Foundation licenses this file to you under the MIT license.
    // See the LICENSE file in the project root for more information.
     
    using Microsoft.Win32.SafeHandles;
    using System;
    using System.Runtime.InteropServices;
     
    internal static partial class Interop
    {
        internal static partial class Sys
        {
            [DllImport(Libraries.SystemNative, EntryPoint = "SystemNative_CopyFile", SetLastError = true)]
            internal static extern int CopyFile(SafeFileHandle source, string srcPath, string destPath, int overwrite);
        }
    }


ä¾‹å¦‚ä»¥ä¸‹ C++ ä»£ç å¯¼å‡ºä¸€ä¸ª APIï¼š

    #include <stdio.h>
    #include <string.h>
    #include <malloc.h>
     
    #ifdef __cplusplus    // If used by C++ code, 
    extern "C" {          // we need to export the C interface
    #endif
            typedef struct Temp
            {       int * iVal;
                   char * chVal;
            }MyTemp;
     
            /*___________________PLATFORM BASED EXPORT DECLARATION STARTS_____*/
                   #ifdef UNIX 
                           #define EXPORT extern
                   #elif (defined (_WINDOWS))
                           #define EXPORT extern __declspec( dllexport )
                   #endif
            /*___________________PLATFORM BASED EXPORT DECLARATION ENDS________*/
            
            EXPORT void ctestFreeResource (void * ptr)
            {
                   if(ptr) free(ptr);
                   ptr = NULL;
            }
     
            EXPORT void ctestFillStructure(MyTemp *iTempVal)
            {
                   iTempVal->iVal = (int*) malloc(sizeof(int));
                   iTempVal->chVal = (char*) malloc(5);  
                   *((*iTempVal).iVal) = 500;
                   strcpy(iTempVal->chVal,"Moh"); 
                   return;
            }
    #ifdef __cplusplus
    }
    #endif

ç¼–è¯‘å‘½ä»¤ï¼š

    LINUX BUILD:
     COMPILE       :       gcc -c -Wall -Werror -fpic ./ctest.c -DUNIX
     LINK          :       gcc -shared -o libctest.so ctest.o

äº¤äº’è°ƒç”¨çš„ C# ä»£ç ï¼š

    using System;
    using System.Runtime.InteropServices;
    using System.Collections;
     
    namespace UseSharedObject
    {
            [StructLayout(LayoutKind.Sequential)] 
            public  struct Temp
            {
                   public IntPtr  m_iVal;
                   public  string m_strVal;
            }
     
            class MainClass
            {              
            #if (UX_PLATFORM)      
                   [DllImport ("./assembly/libctest.so", EntryPoint="ctestFillStructure")]
                    private static extern void ctestFillStructure(ref Temp i);
                           
                   [DllImport ("./assembly/libctest.so", EntryPoint="ctestFreeResource")]
                   private static extern void ctestFreeResource(IntPtr ptr);    
     
            #elif (WINDOWS)
                   [DllImport ("./assembly/libctest.dll", EntryPoint="ctestFillStructure")]
                    private static extern void ctestFillStructure(ref Temp i);
                           
                   [DllImport ("./assembly/libctest.dll", EntryPoint="ctestFreeResource")]
                   private static extern void ctestFreeResource(IntPtr ptr);     
            #endif
                   
                   public static  void Main (string[] args)
                   {
                           Temp valTemp = new Temp();                    
                           ctestFillStructure(ref valTemp);                      
                           Console.WriteLine ("RETURN VALUES FROM NATIVE LIBRARIES: valTemp.m_iVal = {0} valTemp.m_strVal = {1} ",
                               Marshal.ReadInt32( valTemp.m_iVal), valTemp.m_strVal);
                           Console.WriteLine ("CURRENT  PLATFORM = {0}", 
                               Environment.OSVersion.Platform.ToString());                  
                           ctestFreeResource( (IntPtr) (valTemp.m_iVal));                       
                           valTemp.m_iVal = (IntPtr)0;                   
                   }
            }
    }


## ==âš¡ System.IO æ–‡ä»¶è¯»å†™
https://docs.microsoft.com/en-us/dotnet/api/system.io

- åŸºæœ¬å¯¹è±¡

    - æ–‡ä»¶æµ       System.IO.FileStream
    - è¯»å†™æµ       System.IO.StreamReader/StreamWriter
    - ç¼–ç         System.Text.Encoding
    - å¤„ç†å¼‚å¸¸  System.IO.Exception
    - å…±äº«é”       System.IO.FileShare
    - æ–‡ä»¶ç›‘è§†  System.IO.FileSystemWatcher
    - æ–‡ä»¶ä¿¡æ¯  System.IO.FileInfo

- FileMode æŒ‡å®šæ“ä½œç³»ç»Ÿæ‰“å¼€æ–‡ä»¶çš„æ–¹å¼

    - 0x06 Append è¿½åŠ æˆ–åˆ™åˆ›å»ºï¼Œè¯»å†™å¤´å¯»å€åˆ°ç»“æŸä½å¼‚å¸¸ IOExceptionï¼Œè¯»å–å¼‚å¸¸  NotSupportedExceptionï¼›
    - 0x02 Create åˆ›å»ºæ–°æ–‡ä»¶è¦†ç›–ä¸º 0 å­—èŠ‚ï¼Œå†™å¤±è´¥å¼‚å¸¸ UnauthorizedAccessExceptionï¼›
    - 0x01 CreateNew åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ–‡ä»¶å­˜åœ¨å¼‚å¸¸ IOExceptionã€‚
    - 0x03 Open æŒ‡å®šæ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸å­˜åœ¨å¼‚å¸¸ FileNotFoundExceptionã€‚
    - 0x04 OpenOrCreate æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼›
    - 0x05 Truncate æ‰“å¼€æ–‡ä»¶å†™å…¥å†…å®¹ä¸º 0 å­—èŠ‚ï¼Œæ–‡ä»¶å°†è¢«æ¸…ç©ºä¸ºé›¶å­—èŠ‚ã€‚ ArgumentException æ²¡æœ‰å†™æƒé™å¼‚å¸¸ã€‚

- FileAccess

    - 0x01 Read     è¯»æ–‡ä»¶
    - 0x02 ReadWrite    è¯»å†™æ–‡ä»¶
    - 0x03 Write    å†™æ–‡ä»¶

- FileShare æšä¸¾ï¼Œå®šä¹‰å¸¸é‡ï¼Œæ§åˆ¶å…¶ä»–FileStreamå¯¹äºåŒä¸€ä¸ªæ–‡ä»¶æ‰€èƒ½å…·æœ‰çš„è®¿é—®æƒã€‚è¿™äº›å€¼å¯ä»¥æŒ‰ä½ä¸æ“ä½œã€‚

    - 0x04 Delete å…è®¸åˆ é™¤æ–‡ä»¶
    - 0x10 Inheritable ä½¿æ–‡ä»¶å¥æŸ„å¯ä»¥æœ‰å­è¿›ç¨‹ç»§æ‰¿ï¼Œä¸æ”¯æŒWin32
    - 0x00 None æ‹’ç»å…±äº«å½“å‰æ–‡ä»¶
    - 0x01 Read å…è®¸åé¢çš„è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ¥è¯»
    - 0x02 ReadWrite å…è®¸åé¢çš„è¿›ç¨‹æ‰“å¼€æ–‡ä»¶è¯»æˆ–å†™
    - 0x03 Write å…è®¸åé¢çš„è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ¥å†™

- FileOptions æšä¸¾ï¼Œåˆ›å»º FileStream çš„é«˜çº§é€‰é¡¹

    - Asynchronous å¼‚æ­¥è¯»å–å’Œå†™å…¥
    - DeleteOnClose å…³é—­å³åˆ é™¤
    - Encrypted æ–‡ä»¶æ˜¯åŠ å¯†çš„
    - None æ²¡æœ‰é™„åŠ æ¡ä»¶
    - RandomAccess éšæœºè®¿é—®æ–‡ä»¶
    - SequentialAccess é¡ºåºè®¿é—®æ–‡ä»¶
    - WriteThrough æŒ‡ç¤ºç³»ç»Ÿé€šè¿‡ä»»ä½•ä¸­é—´ç¼“å­˜ã€ç›´æ¥å†™å…¥ç£ç›˜

- FielInfo å¸¸ç”¨æ–¹æ³•

    - OpenText è¿”å› UTF8 ç¼–ç  StreamReader
    - OpenRead è¿”å›åªè¯»æµ FileStream
    - OpenWrite è¿”å›åªå†™æµ FileStream

æ ‡å‡†è¾“å…¥è¾“å‡º Console.ReadLine(), WriteLine()

    using System;
    using System.IO;

    class Test
    {
        
        public static void Main()
        {
            string path = Path.GetTempFileName();
            var fi1 = new FileInfo(path);

            // Create a file to write to.
            using (StreamWriter sw = fi1.CreateText())
            {
                sw.WriteLine("Hello");
                sw.WriteLine("And");
                sw.WriteLine("Welcome");
            }

            // Open the file to read from.
            using (StreamReader sr = fi1.OpenText())
            {
                var s = "";
                while ((s = sr.ReadLine()) != null)
                {
                    Console.WriteLine(s);
                }
            }

            try
            {
                string path2 = Path.GetTempFileName();
                var fi2 = new FileInfo(path2);

                // Ensure that the target does not exist.
                fi2.Delete();

                // Copy the file.
                fi1.CopyTo(path2);
                Console.WriteLine($"{path} was copied to {path2}.");

                // Delete the newly created file.
                fi2.Delete();
                Console.WriteLine($"{path2} was successfully deleted.");
            }
            catch (Exception e)
            {
                Console.WriteLine($"The process failed: {e.ToString()}");
            }
        }
    }


## ==âš¡ MemoryStream å†…å­˜æµ

æ„é€ å‡½æ•°

| MemoryStream() | åˆå§‹åŒ– 0 å®¹é‡ï¼Œå¯è‡ªåŠ¨æ‰©å±• |
| MemoryStream(Byte[]) | åˆå§‹åŒ–è‡ª buffer å®¹é‡ï¼Œä¸å¯æ‰©å±•  |
| MemoryStream(Byte[], Boolean) | åˆå§‹åŒ–è‡ª buffer å®¹é‡ï¼Œä¸å¯æ‰©å±•ï¼ŒæŒ‡å®š CanWrite |
| MemoryStream(Byte[], Int32, Int32) | åˆå§‹åŒ–è‡ª buffer å®¹é‡ï¼Œä¸å¯æ‰©å±•ï¼ŒæŒ‡å®š buffer åŒºåŸŸ |
| MemoryStream(Byte[], Int32, Int32, Boolean) | åˆå§‹åŒ–è‡ª buffer å®¹é‡ï¼Œä¸å¯æ‰©å±•ï¼ŒæŒ‡å®š buffer åŒºåŸŸå’Œ CanWrite |
| MemoryStream(Byte[], Int32, Int32, Boolean, Boolean) | åˆå§‹åŒ–è‡ª buffer å®¹é‡ï¼Œä¸å¯æ‰©å±•ï¼ŒæŒ‡å®š buffer åŒºåŸŸå’Œ CanWriteï¼ŒæŒ‡å®š GetBuffer() èƒ½åŠ› |
| MemoryStream(Int32) | æŒ‡å®šåˆå§‹åŒ–å®¹é‡ï¼Œå¯è‡ªåŠ¨æ‰©å±• |

ç¤ºä¾‹ï¼š

    using System;
    using System.IO;
    using System.Text;

    class MemStream
    {
        static void Main()
        {
            int count;
            byte[] byteArray;
            char[] charArray;
            UnicodeEncoding uniEncoding = new UnicodeEncoding();

            // Create the data to write to the stream.
            byte[] firstString = uniEncoding.GetBytes(new String('v', 1000).ToCharArray());
            byte[] secondString = uniEncoding.GetBytes(
                Path.GetInvalidPathChars());
            // byte[] buf = new byte[256]; // with fixed capacity
            // using(MemoryStream memStream = new MemoryStream(buf))
            using(MemoryStream memStream = new MemoryStream(100))
            {
                // Write the first string to the stream.
                memStream.Write(firstString, 0 , firstString.Length);

                // Write the second string to the stream, byte by byte.
                count = 0;
                while(count < secondString.Length)
                {
                    memStream.WriteByte(secondString[count++]);
                }

                // Write the stream properties to the console.
                Console.WriteLine(
                    "Capacity = {0}, Length = {1}, Position = {2}\n",
                    memStream.Capacity.ToString(),
                    memStream.Length.ToString(),
                    memStream.Position.ToString());

                // Set the position to the beginning of the stream.
                memStream.Seek(0, SeekOrigin.Begin);

                // Read the first 20 bytes from the stream.
                byteArray = new byte[memStream.Length];
                count = memStream.Read(byteArray, 0, 20);

                // Read the remaining bytes, byte by byte.
                while(count < memStream.Length)
                {
                    byteArray[count++] =
                        Convert.ToByte(memStream.ReadByte());
                }

                // Decode the byte array into a char array
                // and write it to the console.
                charArray = new char[uniEncoding.GetCharCount(
                    byteArray, 0, count)];
                uniEncoding.GetDecoder().GetChars(
                    byteArray, 0, count, charArray, 0);
                Console.WriteLine(charArray);
            }
        }
    }



## ==âš¡ StreamRead & StreamWriter

StreamReader (Stream stream);
StreamReader (string path);
StreamReader (Stream stream, bool detectEncodingFromByteOrderMarks);
StreamReader (Stream stream, Encoding encoding);
StreamReader (string path, bool detectEncodingFromByteOrderMarks);
StreamReader (String, Encoding) 
StreamReader (Stream, Encoding, Boolean)    
StreamReader (String, Encoding, Boolean)    
StreamReader (Stream stream, Encoding encoding, bool detectEncodingFromByteOrderMarks, int bufferSize);
StreamReader(String, Encoding, Boolean, Int32)  
StreamReader (Stream stream, Encoding encoding = default, bool detectEncodingFromByteOrderMarks = true, int bufferSize = -1, bool leaveOpen = false);

    using System.IO;
    using System.Text;
    namespace CSharpConvertString2Stream
    {    
     class Program    
     {               
           static void Main( string[] args )
            {            
                string str = "Testing 1-2-3";             //convert string 2 stream            
                byte[] array = Encoding.ASCII.GetBytes(str);            
                MemoryStream stream = new MemoryStream(array);             //convert stream 2 string      
                StreamReader reader = new StreamReader(stream);
                string text = reader.ReadToEnd();
                Console.WriteLine(text); 
                Console.ReadLine(); 
           }  
      }
    }

StreamWriter(Stream)    
StreamWriter(String)    
StreamWriter(Stream, Encoding)  
StreamWriter(String, Boolean)   
StreamWriter(Stream, Encoding, Int32)   
StreamWriter(String, Boolean, Encoding) 
StreamWriter(Stream, Encoding, Int32, Boolean)  
StreamWriter(String, Boolean, Encoding, Int32)

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.IO;

    namespace StreamReadWrite
    {
        class Program
        {
            static void Main(string[] args)
            {
                DirectoryInfo[] cDirs = new DirectoryInfo(@"c:\").GetDirectories();

                using (StreamWriter sw = new StreamWriter("CDriveDirs.txt"))
                {
                    foreach (DirectoryInfo dir in cDirs)
                    {
                        sw.WriteLine(dir.Name);
                    }
                }

                string line = "";
                using (StreamReader sr = new StreamReader("CDriveDirs.txt"))
                {
                    while ((line = sr.ReadLine()) != null)
                    {
                        Console.WriteLine(line);
                    }
                }
            }
        }
    }


## ==âš¡ BinaryRead & BinaryWriter

    using System;
    using System.IO;

    class ConsoleApplication
    {
        const string fileName = "AppSettings.dat";

        static void Main()
        {
            WriteDefaultValues();
            DisplayValues();
        }

        public static void WriteDefaultValues()
        {
            using (BinaryWriter writer = new BinaryWriter(File.Open(fileName, FileMode.Create)))
            {
                writer.Write(1.250F);
                writer.Write(@"c:\Temp");
                writer.Write(10);
                writer.Write(true);
            }
        }

        public static void DisplayValues()
        {
            float aspectRatio;
            string tempDirectory;
            int autoSaveTime;
            bool showStatusBar;

            if (File.Exists(fileName))
            {
                using (BinaryReader reader = new BinaryReader(File.Open(fileName, FileMode.Open)))
                {
                    aspectRatio = reader.ReadSingle();
                    tempDirectory = reader.ReadString();
                    autoSaveTime = reader.ReadInt32();
                    showStatusBar = reader.ReadBoolean();
                }

                Console.WriteLine("Aspect ratio set to: " + aspectRatio);
                Console.WriteLine("Temp directory is: " + tempDirectory);
                Console.WriteLine("Auto save time set to: " + autoSaveTime);
                Console.WriteLine("Show status bar: " + showStatusBar);
            }
        }
    }

è¾“å‡º Binary æ–‡ä»¶å†…å®¹ï¼ŒäºŒä¸ªå­—èŠ‚ä¸€ç»„åˆ†å¼€æ˜¾ç¤ºï¼Œæµ®ç‚¹å€¼å  5 ä¸ªå­—èŠ‚ï¼Œæ•´æ•° 10 å å››ä¸ªå­—èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°å°æœ‰æ•ˆä½æ”¾å†…å­˜å¼€å¤´ï¼Œå³ Little-Endianï¼Œæ˜¯å…¸å‹çš„ Intel CPU è¡Œä¸ºã€‚å¯¹äºå•å­—èŠ‚ç±»å‹çš„æ•°æ®ï¼Œä¸å­˜åœ¨å­—èŠ‚åºè¿™ä¸ªè¯´æ³•ã€‚ï¼š

    0000 a03f 0763 3a5c 5465 6d70 0a00 0000 01

ä¸¤ç§å­—èŠ‚å­˜å‚¨é¡ºåºå¤§ç«¯åºå’Œå°ç«¯åº Big-Endian å’Œ Little-Endianï¼Œå­—èŠ‚åºåªé’ˆå¯¹äºå¤šå­—èŠ‚ç±»å‹çš„æ•°æ®å¤„ç†ï¼Œæ¯”å¦‚å¯¹äº int æ•´æ•° 0x12345678ï¼Œå®ƒå æœ‰ 4 ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼š

- 0x12 0x34 0x56 0x78 Big-Endian é«˜ä½å­˜äºä½åœ°å€ç«¯ï¼Œä½ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€ç«¯ï¼›
- 0x78 0x56 0x34 0x12 Little-Endian ä½ä½å­˜äºä½åœ°å€ç«¯ï¼Œé«˜ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€ç«¯ã€‚

Big-endian çš„å†…å­˜é¡ºåºå’Œæ•°å­—çš„ä¹¦å†™é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œæ–¹ä¾¿é˜…è¯»ç†è§£ã€‚
Little-endian åœ¨å˜é‡æŒ‡é’ˆè½¬æ¢çš„æ—¶å€™åœ°å€ä¿æŒä¸å˜ï¼Œæ¯”å¦‚ int64* è½¬åˆ° int32*

## ==âš¡ System.IO.Pipelines
https://devblogs.microsoft.com/dotnet/system-io-pipelines-high-performance-io-in-net/
https://github.com/davidfowl/TcpEcho/tree/master/src
https://docs.microsoft.com/zh-cn/dotnet/api/system.io.pipelines
https://www.cnblogs.com/robertyao/p/9930195.html
https://www.dazhuanlan.com/2019/09/04/94848bdbb334/

System.IO.Pipelines æ˜¯ä¸€ä¸ªæ–°çš„åº“ï¼Œæ—¨åœ¨ç®€åŒ–åœ¨ .NET ä¸­æ‰§è¡Œé«˜æ€§èƒ½ IO çš„è¿‡ç¨‹ã€‚å®ƒæ˜¯ä¸€ä¸ªä¾èµ– .NET Standard çš„åº“ï¼Œé€‚ç”¨äºæ‰€æœ‰ .NET å®ç°ã€‚

System.IO.Pipelines å‘½åç©ºé—´æä¾›äº†ç”¨äºæ‰§è¡Œå¤æ‚çš„é«˜æ€§èƒ½è¾“å…¥è¾“å‡º (IO) æ“ä½œçš„ç±»å‹ã€‚

| ç±»å‹    | åŠŸèƒ½    |
| :---- | :---- |
| Pipe  | é»˜è®¤çš„ PipeWriter å’Œ PipeReader å®ç°ã€‚ |
| PipeOptions   | è¡¨ç¤ºä¸€ç»„ Pipe é€‰é¡¹ã€‚ |
| PipeReader    | å®šä¹‰æä¾›å¯¹ç®¡é“è¯»å–ç«¯çš„è®¿é—®æƒé™çš„ç±»ã€‚ |
| PipeScheduler | ç”¨äºè¿è¡Œ PipeReader å’Œ PipeWriter å›è°ƒå’Œå»¶ç»­çš„æŠ½è±¡ã€‚ |
| PipeWriter    | å®šä¹‰æä¾›å¯å°†æ•°æ®å†™å…¥åˆ°çš„ç®¡é“çš„ç±»ã€‚ |
| StreamPipeExtensions  | ä¸º Stream æä¾›æ‰©å±•æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ”¯æŒç›´æ¥å¯¹ç®¡é“è¿›è¡Œçš„è¯»å–å’Œå†™å…¥æ“ä½œã€‚ |
| StreamPipeReaderOptions   | è¡¨ç¤ºä¸€ç»„ç”¨äºæ§åˆ¶ PipeReader åˆ›å»ºçš„é€‰é¡¹ã€‚ |
| StreamPipeWriterOptions   | è¡¨ç¤ºä¸€ç»„ç”¨äºæ§åˆ¶ PipeWriter åˆ›å»ºçš„é€‰é¡¹ã€‚ |


| ç»“æ„    | ä½œç”¨    |
| :---- | :---- |
| FlushResult   | FlushAsync(CancellationToken) è°ƒç”¨è¿”å›çš„ç»“æœã€‚ |
| ReadResult    | è¡¨ç¤º ReadAsync(CancellationToken) è°ƒç”¨çš„ç»“æœã€‚ |


| æ¥å£    | ç”¨é€”    |
| :---- | :---- |
| IDuplexPipe | å®šä¹‰æä¾›å¯ä»ä¸­è¯»å–å¹¶å†™å…¥æ•°æ®çš„åŒå·¥ç®¡é“çš„ç±»ã€‚ |


Pipelines è¯ç”Ÿäº .NET Core å›¢é˜Ÿï¼Œä¸ºä½¿ Kestrel æˆä¸ºä¸šç•Œæœ€å¿«çš„ Web æœåŠ¡å™¨ä¹‹ä¸€ã€‚æœ€åˆä»ä½œä¸º Kestrel å†…éƒ¨çš„å®ç°ç»†èŠ‚å‘å±•æˆä¸ºå¯é‡ç”¨çš„ APIï¼Œå®ƒåœ¨ .Net Core 2.1 ä¸­ä½œä¸ºå¯ç”¨äºæ‰€æœ‰ .NET å¼€å‘äººå‘˜çš„æœ€é«˜çº§ BCL APIï¼ˆSystem.IO.Pipelinesï¼‰æä¾›ã€‚

ä¸ºäº†æ­£ç¡®è§£æ Stream æˆ– Socket ä¸­çš„æ•°æ®ï¼Œä»£ç æœ‰å›ºå®šçš„æ ·æ¿ï¼Œå¹¶ä¸”æœ‰è®¸å¤šæç«¯æƒ…å†µï¼Œä¸ºäº†å¤„ç†ä»–ä»¬ï¼Œä¸å¾—ä¸ç¼–å†™éš¾ä»¥ç»´æŠ¤çš„å¤æ‚ä»£ç ã€‚
å®ç°é«˜æ€§èƒ½å’Œæ­£ç¡®æ€§ï¼ŒåŒæ—¶ä¹Ÿéš¾ä»¥å¤„ç†è¿™ç§å¤æ‚æ€§ã€‚Pipelines æ—¨åœ¨è§£å†³è¿™ç§å¤æ‚æ€§ã€‚

å®ƒæ²¡æœ‰åˆ†é…æ˜¾å¼ç¼“å†²åŒºã€‚è¿™æ˜¯ç®¡é“çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ã€‚æ‰€æœ‰ç¼“å†²åŒºç®¡ç†éƒ½å§”æ‰˜ç»™ PipeReader/PipeWriter å®ç°ã€‚

é™¤äº†å¤„ç†å†…å­˜ç®¡ç†ä¹‹å¤–ï¼Œå…¶ä»–æ ¸å¿ƒç®¡é“åŠŸèƒ½è¿˜åŒ…æ‹¬èƒ½å¤Ÿåœ¨ Pipe ä¸å®é™…æ¶ˆè€—æ•°æ®çš„æƒ…å†µä¸‹æŸ¥çœ‹æ•°æ®ã€‚

PipeReader æœ‰ ReadAsync å’Œ AdvanceTo ä¸¤ä¸ªæ ¸å¿ƒ APIã€‚ReadAsync è·å– Pipe æ•°æ®ï¼ŒAdvanceTo å‘Šè¯‰ PipeReader ä¸å†éœ€è¦è¿™äº›ç¼“å†²åŒºï¼Œä»¥ä¾¿å¯ä»¥ä¸¢å¼ƒå®ƒä»¬ï¼ˆä¾‹å¦‚è¿”å›åˆ°åº•å±‚ç¼“å†²æ± ï¼‰ã€‚

ReadOnlySequence<T> 
è¯¥å®ç°å­˜å‚¨äº†åœ¨ PipeWriter å’Œ PipeReader ä¹‹é—´ä¼ é€’çš„ç¼“å†²åŒºçš„é“¾æ¥åˆ—è¡¨ã€‚ReadAsync æš´éœ²ä¸€ä¸ª ReadOnlySequence<T> æ–°çš„ BCL ç±»å‹ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª ReadOnlyMemory<T> æ®µçš„è§†å›¾ï¼Œç±»ä¼¼äº Span<T> å’Œ Memory<T> æä¾›æ•°ç»„å’Œå­—ç¬¦ä¸²çš„è§†å›¾ã€‚


ç¼–å†™ç½‘ç»œç¨‹åºçš„æ—¶å€™ï¼Œç»å¸¸ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

- ç”³è¯·ä¸€ä¸ªç¼“å†²åŒº
- ä»æ•°æ®æºä¸­è¯»å…¥æ•°æ®è‡³ç¼“å†²åŒº
- è§£æç¼“å†²åŒºçš„æ•°æ®
- é‡å¤ç¬¬2æ­¥

è¡¨é¢ä¸Šçœ‹æ¥è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§„è€Œç®€å•çš„æ“ä½œï¼Œä½†å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å¾€å¾€å­˜åœ¨å¦‚ä¸‹ç—›ç‚¹ï¼š

- æ•°æ®è¯»ä¸å…¨

    å¯èƒ½ä¸èƒ½åœ¨ä¸€æ¬¡readæ“ä½œä¸­è¯»å…¥æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦åœ¨ç¼“å†²åŒºä¸­ç»´æŠ¤ä¸€ä¸ªæ¸¸æ ‡ï¼Œè®°å½•ä¸‹æ¬¡è¯»å–æ“ä½œçš„èµ·å§‹ä½ç½®ï¼Œè¿™ä¸ªæ¸¸æ ‡å¸¦äº†äº†ä¸å°çš„å¤æ‚åº¦ï¼š

    ä»ç¼“å†²åŒºè¯»æ•°æ®æ—¶ï¼Œè¦æ ¹æ®æ¸¸æ ‡è®¡ç®—ç¼“å†²åŒºèµ·å§‹å†™ä½ç½®ï¼Œä»¥åŠå‰©ä½™ç©ºé—´å¤§å°ã€‚å¢åŠ äº†è¯»æ•°æ®çš„å¤æ‚åº¦ã€‚
    
    è§£ææ•°æ®ä¹Ÿæ˜¯å¤ç”¨è¿™ä¸ªç¼“å†²åŒºçš„ï¼Œè§£æçš„æ—¶å€™ä¹Ÿè¦åˆ¤æ–­æ¸¸æ ‡èµ·å§‹ä½ç½®ï¼Œå‰©ä½™ç©ºé—´å¤§å°ã€‚åŒæ—¶å¢åŠ äº†è§£ææ•°æ®çš„å¤æ‚åº¦ã€‚

    è§£æåè¿˜è¦ç§»åŠ¨æ¸¸æ ‡ï¼Œé‡æ–°æ ‡è®°ç¼“å†²åŒºèµ·å§‹ä½ç½®ï¼Œå†æ¬¡å¢åŠ äº†å¤æ‚åº¦ã€‚
 

- ç¼“å†²åŒºå®¹é‡æœ‰é™

    ç”±äºç¼“å†²åŒºæœ‰é™ï¼Œå¯èƒ½ç”³è¯·çš„ç¼“å†²åŒºä¸å¤Ÿç”¨ï¼Œéœ€è¦å¼•å…¥åŠ¨æ€ç¼“å†²åŒºã€‚è¿™ä¹Ÿå¤§å¹…åŠ å¤§äº†ä»£ç çš„å¤æ‚åº¦ã€‚

    å¦‚æœæ¯æ¬¡éƒ½ç”³è¯·æ›´å¤§çš„å†…å­˜ï¼Œä¸€æ–¹é¢å¸¦æ¥çš„å†…å­˜ç”³è¯·é‡Šæ”¾å¼€é”€ï¼Œå¦ä¸€æ–¹é¢éœ€è¦å°†åŸæ¥çš„æ•°æ®ç§»åŠ¨ï¼Œå¹¶æ›´æ–°æ¸¸æ ‡ï¼Œå¸¦æ¥æ›´å¤æ‚çš„é€»è¾‘ã€‚

    å¦‚æœé å¤šæ®µçš„å†…å­˜ç»„æˆä¸€ä¸ªé€»è¾‘æ•´ç†ï¼Œæ•°æ®çš„è¯»å†™æ–¹å¼éƒ½æ¯”è¾ƒå¤æ‚ã€‚
    ä½¿ç”¨å®Œåçš„å†…å­˜è¦é‡Šæ”¾ï¼Œå¦‚æœéœ€è¦æ›´é«˜çš„æ•ˆç‡è¿˜è¦ç»´æŒä¸€ä¸ªå†…å­˜æ± ã€‚
 

- è¯»å’Œç”¨æ²¡æœ‰åˆ†ç¦»

    æˆ‘ä»¬çš„ä¸šåŠ¡æœ¬èº«åªå…³å¿ƒä½¿ç”¨æ“ä½œï¼Œä½†è¯»å’Œç”¨æ“ä½œæ²¡æœ‰åˆ†ç¦»ï¼Œå¤æ‚çš„éƒ½æ“ä½œå¯¼è‡´ç”¨æ“ä½œä¹Ÿå˜å¾—å¤æ‚ï¼Œå¹¶ä¸”ä¸¥é‡å¹²æ‰°ä¸šåŠ¡é€»è¾‘ã€‚

 
System.IO.Pipelines è§£å†³äº†è¿™äº›ç—›ç‚¹ï¼Œå®ƒä¸»è¦åŒ…å«ä¸€ä¸ª Pipe å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª Writer å’Œ Reader å±æ€§ã€‚

    var pipe   = new Pipe();
    var writer = pipe.Writer;
    var reader = pipe.Reader;

Writerå¯¹è±¡ç”¨äºä»æ•°æ®æºè¯»å–æ•°æ®ï¼Œå°†æ•°æ®å†™å…¥ç®¡é“ä¸­ï¼›å®ƒå¯¹åº”ä¸šåŠ¡ä¸­çš„"è¯»"æ“ä½œã€‚

    var content = Encoding.Default.GetBytes("hello world");
    var data    = new Memory<byte>(content);
    var result  = await writer.WriteAsync(data);

å¦å¤–ï¼Œå®ƒä¹Ÿæœ‰ä¸€ç§ä½¿ç”¨ Pipe ç”³è¯· Memory çš„æ–¹å¼

    var buffer = writer.GetMemory(512);
    content.CopyTo(buffer);
    writer.Advance(content.Length);
    var result = await writer.FlushAsync();

 
Reader å¯¹è±¡ç”¨äºä»ç®¡é“ä¸­è·å–æ•°æ®æºï¼Œå®ƒå¯¹åº”ä¸šåŠ¡ä¸­çš„å–ç”¨æ•°æ®çš„æ“ä½œã€‚

    var result = await reader.ReadAsync();
    var buffer = result.Buffer;

è¿™ä¸ª Buffer æ˜¯ä¸€ä¸ª `ReadOnlySequence<byte>`å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç›¸å½“å¥½çš„åŠ¨æ€å†…å­˜å¯¹è±¡ï¼Œå¹¶ä¸”ç›¸å½“é«˜æ•ˆã€‚å®ƒæœ¬èº«ç”±å¤šæ®µ `Memory<byte>` ç»„æˆï¼ŒæŸ¥çœ‹ Memory æ®µçš„æ–¹æ³•æœ‰ï¼š

- IsSingleSegment   åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€æ®µ
- First è·å–ç¬¬ä¸€æ®µ
- GetEnumerator è·å–åˆ†æ®µçš„

å®ƒä»é€»è¾‘ä¸Šä¹Ÿå¯ä»¥çœ‹æˆä¸€æ®µè¿ç»­çš„æ®µï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„æ–¹æ³•ï¼š

- Length    æ•´ä¸ªæ•°æ®ç¼“å†²åŒºé•¿åº¦
- Slice åˆ†å‰²ç¼“å†²åŒº
- CopyTo    å°†å†…å®¹å¤åˆ¶åˆ°Spanä¸­
- ToArray   å°†å†…å®¹å¤åˆ¶åˆ°byte[]ä¸­

å¦å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªç±»ä¼¼æ¸¸æ ‡çš„ä½ç½®å¯¹è±¡ SequencePositionï¼Œå¯ä»¥ä»å…¶ Position ç›¸å…³å‡½æ•°ä¸­ä½¿ç”¨ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚

è¿™ä¸ªç¼“å†²åŒºè§£å†³äº†æ•°æ®æ²¡è¯»å¤Ÿçš„é—®é¢˜ï¼Œä¸€æ¬¡è¯»å–çš„ä¸å¤Ÿä¸‹æ¬¡å¯ä»¥æ¥ç€è¯»ï¼Œä¸ç”¨ç¼“å†²åŒºçš„åŠ¨æ€åˆ†é…ï¼Œé«˜æ•ˆçš„å†…å­˜ç®¡ç†æ–¹å¼å¸¦æ¥äº†è‰¯å¥½çš„æ€§èƒ½ï¼Œå¥½ç”¨çš„æ¥å£æ˜¯æˆ‘ä»¬èƒ½æ›´å…³æ³¨ä¸šåŠ¡ã€‚

è·å–åˆ°ç¼“å†²åŒºåï¼Œå°±æ˜¯ä½¿ç”¨ç¼“å†²åŒºçš„æ•°æ®

    var data = buffer.ToArray();

ä½¿ç”¨å®Œåï¼Œå‘Šè¯‰PIPEå½“å‰ä½¿ç”¨äº†å¤šå°‘æ•°æ®ï¼Œä¸‹æ¬¡æ¥ç€ä»ç»“æŸä½ç½®åè¯»èµ·

    reader.AdvanceTo(buffer.GetPosition(4));

è¿™æ˜¯ä¸€ä¸ªç›¸å½“å®ç”¨çš„è®¾è®¡ï¼Œå®ƒè§£å†³äº†"è¯»äº†å°±å¾—ç”¨"çš„é—®é¢˜ï¼Œä¸ä»…å¯ä»¥å°†ä¸ç”¨çš„æ•°æ®ä¸‹æ¬¡å†ä½¿ç”¨ï¼Œè¿˜å¯ä»¥å®ç°Peekçš„æ“ä½œï¼Œåªè¯»ä½†ä¸æ”¹å˜æ¸¸æ ‡ã€‚


é™¤äº†"è¯»"å’Œ"ç”¨"æ“ä½œå¤–ï¼Œå®ƒä»¬ä¹‹é—´è¿˜éœ€è¦ä¸€äº›äº¤äº’ï¼Œä¾‹å¦‚ï¼š

è¯»è¿‡ç¨‹ä¸­æ•°æ®æºä¸å¯ç”¨ï¼Œéœ€è¦åœæ­¢ä½¿ç”¨ã€‚ ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸šåŠ¡ç»“æŸï¼Œéœ€è¦ä¸­æ­¢æ•°æ®æºã€‚ Reader å’Œ Writer éƒ½æœ‰ä¸€ä¸ª Complete å‡½æ•°ï¼Œç”¨äºé€šçŸ¥ç»“æŸï¼š

    reader.Complete();
    writer.Complete();

åœ¨ Writer å†™å…¥å’Œ Reader è¯»å–æ—¶ï¼Œä¼šè·å¾—ä¸€ä¸ªç»“æœ

    FlushResult result = await writer.FlushAsync();
    ReadResult result = await reader.ReadAsync();

å®ƒä»¬éƒ½æœ‰ä¸€ä¸ª IsComplete å±æ€§ï¼Œå¯ä»¥æ ¹æ®å®ƒæ˜¯å¦ä¸ºtrueåˆ¤æ–­æ˜¯å¦å·²ç»ç»“æŸäº†è¯»å’Œå†™çš„æ“ä½œã€‚

 

å–æ¶ˆ

åœ¨å†™å…¥å’Œè¯»å–çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ª CancellationTokenï¼Œç”¨äºå–æ¶ˆç›¸åº”çš„æ“ä½œã€‚

    writer.FlushAsync(CancellationToken.None);
    reader.ReadAsync(CancellationToken.None);

å¦‚æœå–æ¶ˆæˆåŠŸï¼Œå¯¹åº”çš„ Result çš„ IsCanceled åˆ™ä¸º trueï¼ˆæ²¡æœ‰éªŒè¯è¿‡ï¼‰


ä½¿ç”¨ç¤ºèŒƒ Client.csï¼š

    using System;
    using System.Diagnostics;
    using System.Linq;
    using System.Net;
    using System.Net.Sockets;
    using System.Text;
    using System.Threading.Tasks;

    namespace TcpEcho
    {
        class Program
        {
            static async Task Main(string[] args)
            {
                var clientSocket = new Socket(SocketType.Stream, ProtocolType.Tcp);

                Console.WriteLine("Connecting to port 8087");

                clientSocket.Connect(new IPEndPoint(IPAddress.Loopback, 8087));
                var stream = new NetworkStream(clientSocket);

                await Console.OpenStandardInput().CopyToAsync(stream);
            }
        }
    }

Server.csï¼š

    using System;
    using System.Buffers;
    using System.IO.Pipelines;
    using System.Net;
    using System.Net.Sockets;
    using System.Text;
    using System.Threading.Tasks;

    namespace Server
    {
        class Program
        {
            static async Task Main(string[] args)
            {
                var listenSocket = new Socket(SocketType.Stream, ProtocolType.Tcp);
                listenSocket.Bind(new IPEndPoint(IPAddress.Loopback, 8087));

                Console.WriteLine("Listening on port 8087");

                listenSocket.Listen(120);

                while (true)
                {
                    var socket = await listenSocket.AcceptAsync();
                    _ = ProcessLinesAsync(socket);
                }
            }

            private static async Task ProcessLinesAsync(Socket socket)
            {
                Console.WriteLine($"[{socket.RemoteEndPoint}]: connected");

                // Create a PipeReader over the network stream
                var stream = new NetworkStream(socket);
                var reader = PipeReader.Create(stream);

                while (true)
                {
                    ReadResult result = await reader.ReadAsync();
                    ReadOnlySequence<byte> buffer = result.Buffer;

                    while (TryReadLine(ref buffer, out ReadOnlySequence<byte> line))
                    {
                        // Process the line.
                        ProcessLine(line);
                    }

                    // Tell the PipeReader how much of the buffer has been consumed.
                    reader.AdvanceTo(buffer.Start, buffer.End);

                    // Stop reading if there's no more data coming.
                    if (result.IsCompleted)
                    {
                        break;
                    }
                }

                // Mark the PipeReader as complete.
                await reader.CompleteAsync();

                Console.WriteLine($"[{socket.RemoteEndPoint}]: disconnected");
            }

            private static bool TryReadLine(ref ReadOnlySequence<byte> buffer, out ReadOnlySequence<byte> line)
            {
                // Look for a EOL in the buffer.
                SequencePosition? position = buffer.PositionOf((byte)'\n');

                if (position == null)
                {
                    line = default;
                    return false;
                }

                // Skip the line + the \n.
                line = buffer.Slice(0, position.Value);
                buffer = buffer.Slice(buffer.GetPosition(1, position.Value));
                return true;
            }

            private static void ProcessLine(in ReadOnlySequence<byte> buffer)
            {
                foreach (var segment in buffer)
                {
    #if NETCOREAPP2_1
                    Console.Write(Encoding.UTF8.GetString(segment.Span));
    #else
                    Console.Write(Encoding.UTF8.GetString(segment));
    #endif
                }
                Console.WriteLine();
            }
        }
    }


æä¾›æ‰©å±•æ–¹æ³• SocketExtensions.csï¼š

    #if NET461
    using System;
    using System.Net.Sockets;
    using System.Runtime.InteropServices;
    using System.Text;
    using System.Threading.Tasks;

    namespace Server
    {
        internal static class SocketExtensions
        {
            public static Task<int> ReceiveAsync(this Socket socket, Memory<byte> memory, SocketFlags socketFlags)
            {
                var arraySegment = GetArray(memory);
                return SocketTaskExtensions.ReceiveAsync(socket, arraySegment, socketFlags);
            }

            public static string GetString(this Encoding encoding, ReadOnlyMemory<byte> memory)
            {
                var arraySegment = GetArray(memory);
                return encoding.GetString(arraySegment.Array, arraySegment.Offset, arraySegment.Count);
            }

            private static ArraySegment<byte> GetArray(Memory<byte> memory)
            {
                return GetArray((ReadOnlyMemory<byte>)memory);
            }

            private static ArraySegment<byte> GetArray(ReadOnlyMemory<byte> memory)
            {
                if (!MemoryMarshal.TryGetArray(memory, out var result))
                {
                    throw new InvalidOperationException("Buffer backed by array was expected");
                }

                return result;
            }
        }
    }
    #endif



## ==âš¡ BufferStream

Example 1: Code that runs on the client

    using System;
    using System.IO;
    using System.Globalization;
    using System.Net;
    using System.Net.Sockets;

    public class Client
    {
        const int dataArraySize    =   100;
        const int streamBufferSize =  1000;
        const int numberOfLoops    = 10000;

        static void Main(string[] args)
        {
            // Check that an argument was specified when the
            // program was invoked.
            if(args.Length == 0)
            {
                Console.WriteLine("Error: The name of the host computer" +
                    " must be specified when the program is invoked.");
                return;
            }

            string remoteName = args[0];

            // Create the underlying socket and connect to the server.
            Socket clientSocket = new Socket(AddressFamily.InterNetwork,
                SocketType.Stream, ProtocolType.Tcp);

            clientSocket.Connect(new IPEndPoint(
                Dns.Resolve(remoteName).AddressList[0], 1800));

            Console.WriteLine("Client is connected.\n");

            // Create a NetworkStream that owns clientSocket and
            // then create a BufferedStream on top of the NetworkStream.
            // Both streams are disposed when execution exits the
            // using statement.
            using(Stream
                netStream = new NetworkStream(clientSocket, true),
                bufStream =
                      new BufferedStream(netStream, streamBufferSize))
            {
                // Check whether the underlying stream supports seeking.
                Console.WriteLine("NetworkStream {0} seeking.\n",
                    bufStream.CanSeek ? "supports" : "does not support");

                // Send and receive data.
                if(bufStream.CanWrite)
                {
                    SendData(netStream, bufStream);
                }
                if(bufStream.CanRead)
                {
                    ReceiveData(netStream, bufStream);
                }

                // When bufStream is closed, netStream is in turn
                // closed, which in turn shuts down the connection
                // and closes clientSocket.
                Console.WriteLine("\nShutting down the connection.");
                bufStream.Close();
            }
        }

        static void SendData(Stream netStream, Stream bufStream)
        {
            DateTime startTime;
            double networkTime, bufferedTime;

            // Create random data to send to the server.
            byte[] dataToSend = new byte[dataArraySize];
            new Random().NextBytes(dataToSend);

            // Send the data using the NetworkStream.
            Console.WriteLine("Sending data using NetworkStream.");
            startTime = DateTime.Now;
            for(int i = 0; i < numberOfLoops; i++)
            {
                netStream.Write(dataToSend, 0, dataToSend.Length);
            }
            networkTime = (DateTime.Now - startTime).TotalSeconds;
            Console.WriteLine("{0} bytes sent in {1} seconds.\n",
                numberOfLoops * dataToSend.Length,
                networkTime.ToString("F1"));

            // Send the data using the BufferedStream.
            Console.WriteLine("Sending data using BufferedStream.");
            startTime = DateTime.Now;
            for(int i = 0; i < numberOfLoops; i++)
            {
                bufStream.Write(dataToSend, 0, dataToSend.Length);
            }
            bufStream.Flush();
            bufferedTime = (DateTime.Now - startTime).TotalSeconds;
            Console.WriteLine("{0} bytes sent in {1} seconds.\n",
                numberOfLoops * dataToSend.Length,
                bufferedTime.ToString("F1"));

            // Print the ratio of write times.
            Console.WriteLine("Sending data using the buffered " +
                "network stream was {0} {1} than using the network " +
                "stream alone.\n",
                (networkTime/bufferedTime).ToString("P0"),
                bufferedTime < networkTime ? "faster" : "slower");
        }

        static void ReceiveData(Stream netStream, Stream bufStream)
        {
            DateTime startTime;
            double networkTime, bufferedTime = 0;
            int bytesReceived = 0;
            byte[] receivedData = new byte[dataArraySize];

            // Receive data using the NetworkStream.
            Console.WriteLine("Receiving data using NetworkStream.");
            startTime = DateTime.Now;
            while(bytesReceived < numberOfLoops * receivedData.Length)
            {
                bytesReceived += netStream.Read(
                    receivedData, 0, receivedData.Length);
            }
            networkTime = (DateTime.Now - startTime).TotalSeconds;
            Console.WriteLine("{0} bytes received in {1} seconds.\n",
                bytesReceived.ToString(),
                networkTime.ToString("F1"));

            // Receive data using the BufferedStream.
            Console.WriteLine("Receiving data using BufferedStream.");
            bytesReceived = 0;
            startTime = DateTime.Now;

            int numBytesToRead = receivedData.Length;

            while (numBytesToRead > 0)
            {
                // Read may return anything from 0 to numBytesToRead.
                int n = bufStream.Read(receivedData,0, receivedData.Length);
                // The end of the file is reached.
                if (n == 0)
                    break;
                bytesReceived += n;
                numBytesToRead -= n;
            }

            bufferedTime = (DateTime.Now - startTime).TotalSeconds;
            Console.WriteLine("{0} bytes received in {1} seconds.\n",
                bytesReceived.ToString(),
                bufferedTime.ToString("F1"));

            // Print the ratio of read times.
            Console.WriteLine("Receiving data using the buffered network" +
                " stream was {0} {1} than using the network stream alone.",
                (networkTime/bufferedTime).ToString("P0"),
                bufferedTime < networkTime ? "faster" : "slower");
        }
    }

Example 2: Code that runs on the server

    using System;
    using System.Net;
    using System.Net.Sockets;

    public class Server
    {
        static void Main()
        {
            // This is a Windows Sockets 2 error code.
            const int WSAETIMEDOUT = 10060;

            Socket serverSocket;
            int bytesReceived, totalReceived = 0;
            byte[] receivedData = new byte[2000000];

            // Create random data to send to the client.
            byte[] dataToSend = new byte[2000000];
            new Random().NextBytes(dataToSend);

            IPAddress ipAddress =
                Dns.Resolve(Dns.GetHostName()).AddressList[0];
                // Dns.GetHostEntry("127.0.0.1").AddressList[0];

            IPEndPoint ipEndpoint = new IPEndPoint(ipAddress, 1800);

            // Create a socket and listen for incoming connections.
            using(Socket listenSocket = new Socket(
                AddressFamily.InterNetwork, SocketType.Stream,
                ProtocolType.Tcp))
            {
                listenSocket.Bind(ipEndpoint);
                listenSocket.Listen(1);

                // Accept a connection and create a socket to handle it.
                serverSocket = listenSocket.Accept();
                Console.WriteLine("Server is connected.\n");
            }

            try
            {
                // Send data to the client.
                Console.Write("Sending data ... ");
                int bytesSent = serverSocket.Send(
                    dataToSend, 0, dataToSend.Length, SocketFlags.None);
                Console.WriteLine("{0} bytes sent.\n",
                    bytesSent.ToString());

                // Set the timeout for receiving data to 2 seconds.
                serverSocket.SetSocketOption(SocketOptionLevel.Socket,
                    SocketOptionName.ReceiveTimeout, 2000);

                // Receive data from the client.
                Console.Write("Receiving data ... ");
                try
                {
                    do
                    {
                        bytesReceived = serverSocket.Receive(receivedData,
                            0, receivedData.Length, SocketFlags.None);
                        totalReceived += bytesReceived;
                    }
                    while(bytesReceived != 0);
                }
                catch(SocketException e)
                {
                    if(e.ErrorCode == WSAETIMEDOUT)
                    {
                        // Data was not received within the given time.
                        // Assume that the transmission has ended.
                    }
                    else
                    {
                        Console.WriteLine("{0}: {1}\n",
                            e.GetType().Name, e.Message);
                    }
                }
                finally
                {
                    Console.WriteLine("{0} bytes received.\n",
                        totalReceived.ToString());
                }
            }
            finally
            {
                serverSocket.Shutdown(SocketShutdown.Both);
                Console.WriteLine("Connection shut down.");
                serverSocket.Close();
            }
        }
    }


## ==âš¡ Timer Demo

    using System;
    using System.Threading;

    class TimerExample
    {
        static void Main()
        {
            // Create an AutoResetEvent to signal the timeout threshold in the
            // timer callback has been reached.
            var autoEvent = new AutoResetEvent(false);
            
            var statusChecker = new StatusChecker(10);

            // Create a timer that invokes CheckStatus after one second, 
            // and every 1/4 second thereafter.
            Console.WriteLine("{0:h:mm:ss.fff} Creating timer.\n", 
                              DateTime.Now);
            var stateTimer = new Timer(statusChecker.CheckStatus, 
                                       autoEvent, 1000, 100);

            // When autoEvent signals, change the period to every half second.
            autoEvent.WaitOne();
            stateTimer.Change(0, 500);
            Console.WriteLine("\nChanging period to .5 seconds.\n");

            Console.WriteLine("\nChanging period to 0 for one tick & delay .3 seconds.\n");
            statusChecker.maxCount = 1;
            stateTimer.Change(300, 0);

            // When autoEvent signals the second time, dispose of the timer.
            autoEvent.WaitOne();
            stateTimer.Dispose();
            Console.WriteLine("\nDestroying timer.");
        }
    }

    class StatusChecker
    {
        public int invokeCount;
        public int  maxCount;

        public StatusChecker(int count)
        {
            invokeCount  = 0;
            maxCount = count;
        }

        // This method is called by the timer delegate.
        public void CheckStatus(Object stateInfo)
        {
            AutoResetEvent autoEvent = (AutoResetEvent)stateInfo;
            Console.WriteLine("{0} Checking status {1,2}.", 
                DateTime.Now.ToString("h:mm:ss.fff"), 
                (++invokeCount).ToString());

            if(invokeCount == maxCount)
            {
                // Reset the counter and signal the waiting thread.
                invokeCount = 0;
                autoEvent.Set();
            }
        }
    }



## ==âš¡ Console æ§ä»¶å°ç¨‹åº
https://docs.microsoft.com/en-us/dotnet/api/system.console
https://docs.microsoft.com/en-us/dotnet/api/system.text.utf8encoding

æ§åˆ¶å°ç¨‹åºé»˜è®¤ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œå³åœ¨æ§åˆ¶å°çª—å£é€šè¿‡ System.IO. & TextWriter å®Œæˆå­—ç¬¦è¾“å…¥è¾“å‡ºè¡Œä¸ºï¼Œé€šè¿‡ Console é™æ€ç±»å®ç°ï¼Œè°ƒç”¨ SetIn(TextReader) å’Œ SetOut(TextWriter) æ–¹æ³•å¯ä»¥æ”¹å˜è¾“å…¥è¾“å‡ºè¡Œä¸ºã€‚

    using System;

    public class Example {
        public static void Main()
        {
            Console.Write("Hello ");
            Console.WriteLine("World!");
            Console.Write("Enter your name: ");
            String name = Console.ReadLine();
            Console.Write("Good day, ");
            Console.Write(name);
            Console.WriteLine("!");
        }
    }

WriteLine æ–¹æ³•ä¸­ï¼Œå‚æ•°é€—å·åæŒ‡å®šçš„æ ¼å¼æ•°å­—è¡¨ç¤ºå³å¯¹é½ 32 ä¸ªå­—ç¬¦ç©ºé—´ï¼Œé€—å·åå¯ä»¥æœ‰ç©ºæ ¼ï¼Œè´Ÿå· - è¡¨ç¤ºå·¦å¯¹é½ï¼š

    Console.WriteLine("{0, 32} {1, -32}", "WriteLine", "format {{index, wide}}...");


æ ¼å¼è®¾ç½®æœ‰ä¸¤ä¸ªä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ•°æ®æ¥æºï¼Œå®½åº¦å’Œå·¦å³å¯¹é½ï¼Œæ•°æ®ç±»å‹å’Œå°æ•°ç‚¹ä½æ•°ï¼Œæ ¼å¼ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚ä»¥ `"{0,-16:C4}"` ä¸ºä¾‹ï¼Œç¬¬ä¸€ä¸ª 0 è¡¨æ•°æ®æ¥æºè‡ªç´§è·Ÿæ ¼å¼å­—ç¬¦ä¸²åçš„å˜é‡ï¼Œå†åé¢ä¸€ä¸ªå˜é‡å‚æ•°å°±æ˜¯ `{1}` ç­‰ç­‰ã€‚ç„¶åï¼Œæ˜¯é€—å·åé¢æŒ‡å®šçš„å®½åº¦ 16 ä¸ªå­—ç¬¦å’Œè´Ÿå·æŒ‡å®šå·¦å¯¹é½ï¼Œé»˜è®¤ä¸ä½¿ç”¨è´Ÿå·å³å¯¹é½ï¼Œåªè¦å®½åº¦è¶³å¤Ÿã€‚æœ€åæ˜¯å†’å·åé¢æŒ‡å®šçš„æ•°æ®ç±»å‹ C - Currency è´§å¸ï¼ŒE - Scientific ç§‘å­¦è®¡æ•°æ³•ã€‚æ•°æ®ç±»å‹åé¢çš„æ•°å­—æŒ‡å®šå°æ•°ç‚¹åçš„ä½æ•°ï¼Œé»˜è®¤ä¸º 2 ä½å°æ•°ã€‚å¯¹äºä¸åŒçš„æ•°æ®æ¥æºï¼Œæ¯”å¦‚ D è¡¨ç¤ºåè¿›åˆ¶æ•°å€¼æ ¼å¼ï¼Œæˆ–è€…è¡¨ç¤ºæ—¥æœŸçš„é•¿æ ¼å¼ã€‚

å¯ä»¥ä½¿ç”¨ PC èœ‚é¸£å™¨ Beep() æˆ–è€… Beep(frequency, duration) æ¥æé†’ç”¨æˆ·ã€‚Beep å‡½æ•°å°è£…çš„æ˜¯ Windows Beep APIï¼Œå®ƒæ˜¯å¦èƒ½å‘å‡ºå£°éŸ³å–å†³ 8254 å¯ç¼–ç¨‹å®šæ—¶å™¨èŠ¯ç‰‡ã€‚

åäºŒå¹³å‡å¾‹ï¼Œå…«åº¦ Octave åˆ†æˆåäºŒä¸ªåŠéŸ³éŸ³ç¨‹çš„å¾‹åˆ¶ï¼Œå„ç›¸é‚»ä¸¤å¾‹ä¹‹é—´çš„æŒ¯åŠ¨æ•°ä¹‹æ¯”å®Œå…¨ç›¸ç­‰ï¼Œé’¢ç´å³æ˜¯æ ¹æ®åäºŒå¹³å‡å¾‹æ¥å®šéŸ³çš„ã€‚æ¯ä¸€ç­‰ä»½ç§°ä¸ºä¸€ä¸ªåŠéŸ³å°äºŒåº¦ï¼Œä¸€ä¸ªå¤§äºŒåº¦åˆ™æ˜¯ä¸¤ç­‰ä»½ã€‚å°†ä¸€ä¸ªå…«åº¦åˆ†æˆ 12 ç­‰ä»½æœ‰ç€æƒŠäººçš„ä¸€äº›å‡‘å·§ï¼Œå®ƒçš„çº¯äº”åº¦éŸ³ç¨‹çš„ä¸¤ä¸ªéŸ³çš„é¢‘ç‡æ¯”ï¼Œå³ 2 çš„ 7/12 æ¬¡æ–¹ ä¸ 1.5 éå¸¸æ¥è¿‘ï¼Œäººè€³åŸº æœ¬ä¸Šå¬ä¸å‡ºäº”åº¦ç›¸ç”Ÿå¾‹å’ŒåäºŒå¹³å‡å¾‹çš„äº”åº¦éŸ³ç¨‹çš„å·®åˆ«ã€‚

å½¼æ­¤çš„å…³ç³»å¾ˆç®€å•ï¼Œè‡ªç„¶éŸ³é˜¶ 7 ä¸ªéŸ³çš„ do-reã€re-miã€fa-soã€so-laã€la-si ä¹‹é—´çš„é¢‘ç‡æ¯”éƒ½æ˜¯ 9:8ï¼Œçº¦ä¸º 1.12ï¼Œè¿™ä¸ªæ¯”ä¾‹è¢«ç§°ä¸ºå…¨éŸ³ Toneï¼›mi-faã€si-do ä¹‹é—´çš„é¢‘ç‡æ¯”éƒ½æ˜¯ 256:243 çº¦ä¸º 1.06ï¼Œä¹Ÿå°±æ˜¯ 2 çš„ 12 æ¬¡æ–¹æ ¹ï¼Œè¿™ä¸ªæ¯”ä¾‹è¢«ç§°ä¸ºåŠéŸ³ Semitoneã€‚æ ‡å‡†éŸ³ Standard Pitch A1 = 440Hzã€‚

    using System;
    using System.Threading;

    class Sample
    {
        public static void Main()
        {
            // Declare the first few notes of the song, "Mary Had A Little Lamb".
            Note[] Mary =
                {
                new Note(Tone.B1, Duration.QUARTER),
                new Note(Tone.A1, Duration.QUARTER),
                new Note(Tone.G2, Duration.QUARTER),
                new Note(Tone.A1, Duration.QUARTER),
                new Note(Tone.B1, Duration.QUARTER),
                new Note(Tone.B1, Duration.QUARTER),
                new Note(Tone.B1, Duration.HALF),
                new Note(Tone.A1, Duration.QUARTER),
                new Note(Tone.A1, Duration.QUARTER),
                new Note(Tone.A1, Duration.HALF),
                new Note(Tone.B1, Duration.QUARTER),
                new Note(Tone.D1, Duration.QUARTER),
                new Note(Tone.D1, Duration.HALF)
                };
            Note[] melody = {
                new Note(Tone.e, Duration.QUARTER),
                new Note(Tone.f, Duration.EIGHTH),
                new Note(Tone.a, Duration.EIGHTH),
                new Note(Tone.b, Duration.HALF),
                new Note(Tone.e, Duration.QUARTER),
                new Note(Tone.f, Duration.EIGHTH),
                new Note(Tone.b, Duration.EIGHTH),
                new Note(Tone.a, Duration.HALF),
                new Note(Tone.c, Duration.HALF),
                new Note(Tone.A, Duration.WHOLE),
            };

            Play(melody);
            Play(Mary);
        }

        protected static void Play(Note[] tune)
        {
            foreach (Note n in tune)
            {
                if (n.NoteTone == Tone.REST)
                    Thread.Sleep((int)n.NoteDuration);
                else
                    Console.Beep((int)n.NoteTone, (int)n.NoteDuration);
            }
        }

        // Define the frequencies of notes in an octave, as well as silence (rest).
        protected enum Tone
        {
            REST   = 0,
            G3      = 196,
            A3      = 220,
            A3sharp = 233,
            B3      = 247,
            C2      = 262,
            C2sharp = 277,
            D2      = 294,
            D2sharp = 311,
            E2      = 330,
            F2      = 349,
            F2sharp = 370,
            G2      = 392,
            G2sharp = 415,
            A2      = 220,
            B2      = 247,
            C1      = 262,
            D1      = 294,
            E1      = 330,
            F1      = 350,
            G1      = 392,
            A1      = 440,
            B1      = 494,
            C       = 524,
            D       = 588,
            E       = 660,
            F       = 699,
            Gsharp  = 736,
            G       = 784,
            A       = 880,
            B       = 988,
            c       = 1047,
            d       = 1175,
            e       = 1319,
            f       = 1397,
            g       = 1568,
            a       = 1761,
            b       = 1976,

        }

        // Define the duration of a note in units of milliseconds.
        protected enum Duration
        {
            WHOLE     = 1000,
            HALF      = WHOLE/2,
            QUARTER   = HALF/2,
            EIGHTH    = QUARTER/2,
            SIXTEENTH = EIGHTH/2,
        }

        // Define a note as a frequency (tone) and the amount of
        // time (duration) the note plays.
        protected struct Note
        {
            Tone     toneVal;
            Duration durVal;

            // Define a constructor to create a specific note.
            public Note(Tone frequency, Duration time)
            {
                toneVal = frequency;
                durVal  = time;
            }

            // Define properties to return the note's tone and duration.
            public Tone NoteTone { get{ return toneVal; } }
            public Duration NoteDuration { get{ return durVal; } }
        }
    }

ä½¿ç”¨ BackgroundColor & ForegroundColorï¼š

    using System;

    class Example
    {
       public static void Main()
       {
          // Get an array with the values of ConsoleColor enumeration members.
          ConsoleColor[] colors = (ConsoleColor[]) ConsoleColor.GetValues(typeof(ConsoleColor));

          ConsoleColor currentBackground = Console.BackgroundColor;
          ConsoleColor currentForeground = Console.ForegroundColor;

          // Display all foreground colors except the one that matches the background.
          Console.WriteLine("All the foreground colors except {0}, the background color:",
                            currentBackground);
          foreach (var color in colors) {
             if (color == currentBackground) continue;

             Console.ForegroundColor = color;
             Console.WriteLine("   The foreground color is {0}.", color);
          }
          Console.WriteLine();

          Console.ForegroundColor = currentForeground;

          // Display each background color except the one that matches the current foreground color.
          Console.WriteLine("All the background colors except {0}, the foreground color:",
                            currentForeground);
          foreach (var color in colors) {
             if (color == currentForeground) continue;

             Console.BackgroundColor = color;
             Console.WriteLine("   The background color is {0}.", color);
          }

          // Restore the original console colors.
          Console.ResetColor();
          Console.WriteLine("\nOriginal colors restored...");
       }
    }

ConsoleColor Enumï¼š

| Black     | 0 | The color black. |
| Blue      | 9 | The color blue. |
| Cyan      | 11    | The color cyan (blue-green). |
| DarkBlue  | 1 | The color dark blue. |
| DarkCyan  | 3 | The color dark cyan (dark blue-green). |
| DarkGray  | 8 | The color dark gray. |
| DarkGreen | 2 | The color dark green. |
| DarkMagenta   | 5 | The color dark magenta (dark purplish-red). |
| DarkRed   | 4 | The color dark red. |
| DarkYellow    | 6 | The color dark yellow (ochre). |
| Gray      | 7 | The color gray. |
| Green     | 10    | The color green. |
| Magenta   | 13    | The color magenta (purplish-red). |
| Red       | 12    | The color red. |
| White     | 15    | The color white. |
| Yellow    | 14    | The color yellow. |




## ==âš¡ FileSystemWatcher æ–‡ä»¶ç›‘è§†
https://docs.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher

FileSystemWatcher ä¼¼ä¹åªèƒ½ä»¥æ–‡ä»¶å¤¹ä¸ºå•ä½æ£€æµ‹ï¼Œäº‹ä»¶åŒ…æ‹¬ï¼šChanged, Created, Deleted, Disposed, Error, Renamed

Windows æ“ä½œç³»ç»Ÿä½¿ç”¨ FileSystemWatcher åˆ›å»ºçš„ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé€šçŸ¥ç¨‹åºæ–‡ä»¶çš„ä¿®æ”¹ä¿¡æ¯ï¼Œå¦‚æœåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…æœ‰éå¸¸å¤šçš„æ–‡ä»¶ä¿®æ”¹ï¼Œè¿™ä¸ªç¼“å†²åŒºä¼šæº¢å‡ºï¼Œ é€ æˆéƒ¨åˆ†è¿½è¸ªä¸¢å¤±ï¼Œå¹¶ä¸” FileSystemWatcher ä¸ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚åŠ å¤§ InternalBufferSize å±æ€§å€¼å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚

InternalBufferSize é»˜è®¤å€¼æ˜¯8Kï¼Œå¯ä»¥è®¾ç½®çš„æœ€å°å€¼æ˜¯4Kï¼Œå¢åŠ æˆ–å‡å°æœ€å¥½ç”¨ 4K çš„æ•´æ•°å€ã€‚æ¯ä¸€ä¸ªäº‹ä»¶é€šçŸ¥éœ€è¦ä½¿ç”¨ 16 å­—èŠ‚ï¼Œå¹¶ä¸åŒ…å«æ–‡ä»¶åã€‚InternalBufferSize ä½¿ç”¨ non-paged å†…å­˜ï¼Œæ³¨æ„è¿™éƒ¨åˆ†å†…å­˜èµ„æºæ¯”è¾ƒå®è´µã€‚

ä½¿ç”¨ NotifyFilterã€IncludeSubdirectories å±æ€§å‡å° trace èŒƒå›´ï¼Œè®¾ç½® filter å±æ€§å¹¶ä¸ä¼šå½±å“è¿›å…¥ç¼“å†²åŒºçš„äº‹ä»¶é€šçŸ¥ï¼Œå¦å¤–å°½å¿«çš„å®Œæˆäº‹ä»¶å¤„ç†ï¼Œä¹Ÿæ˜¯é¿å…ç¼“å†²åŒºæº¢å‡ºé€ æˆäº‹ä»¶ä¸¢å¤±çš„ä¸€ä¸ªæªæ–½ã€‚

éšè—æ–‡ä»¶ä¹Ÿä¼šç›‘æ§ã€‚

æœ‰äº›ç³»ç»Ÿä¸­ FileSystemWatcher çš„äº‹ä»¶é‡Œå¯¹é•¿æ–‡ä»¶åä½¿ç”¨ 8.3 çŸ­æ–‡ä»¶åæ–¹å¼è¡¨ç¤ºã€‚

å¦‚æœå¤šä¸ª FileSystemWatcher åœ¨ç›‘æ§åŒä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨Windows XP SP1 ä¹‹å‰ï¼ŒWindows 2000 SP2 æˆ–ä¹‹å‰çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ª FileSystemWatcher æ¥æ”¶åˆ°é€šçŸ¥ï¼›æ›´æ–°ç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿä¸­æ‰€æœ‰ FileSystemWatcher éƒ½ä¼šæ”¶åˆ°é€šçŸ¥ã€‚

ä¸€æ¬¡æ–‡ä»¶æ“ä½œäº§ç”Ÿå¤šä¸ªäº‹ä»¶é€šçŸ¥ï¼ŒæŸäº›æ–‡ä»¶æ“ä½œå¯èƒ½ä¼šå¼•å‘å¤šä¸ªæ–‡ä»¶æ›´æ”¹äº‹ä»¶ï¼Œä¾‹å¦‚æ–°å¢æ–‡ä»¶ã€æ‹·è´ç²˜è´´ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç­‰ã€‚ç”¨ Sublime åˆ›å»ºæ–°æ–‡ä»¶äº§ç”Ÿä¸€ä¸ª Createdï¼Œä¸€ä¸ª Deletedï¼Œå¤šä¸ª Changedã€‚å¾®è½¯çš„è§£é‡Šæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œå¦å¤–è¿˜æœ‰å…¶å®ƒç¨‹åºçš„å½±å“ï¼Œä¾‹å¦‚æ€æ¯’è½¯ä»¶ç­‰ã€‚

æ–‡ä»¶ç®¡ç†å™¨åˆæ­¥æµ‹è¯•ï¼ŒRenameã€Deleteã€New åªä¼šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼ŒSaveã€Paste æ—¶ä¼šæœ‰å¤šä¸ªäº‹ä»¶ã€‚

å¯ä»¥é€šè¿‡è®¡æ—¶å™¨æ¥æ»¤æ³¢ï¼Œåœ¨æ–‡ä»¶äº‹ä»¶å¤„ç†ä¸­è®©è®¡æ—¶å™¨å»¶è¿Ÿä¸€æ®µæ—¶é—´ä¹‹åï¼Œå†æ‰§è¡ŒåŠ è½½æ–°çš„é…ç½®æ–‡ä»¶æ“ä½œã€‚è¿™æ ·å¯ä»¥é¿å…å¯¹æ–‡ä»¶åšä¸€æ¬¡æ“ä½œè§¦å‘äº†å¤šä¸ªæ›´æ”¹äº‹ä»¶ï¼Œè€Œå¤šæ¬¡åŠ è½½é…ç½®æ–‡ä»¶ã€‚

åŒæ—¶ç›‘æ§å¤šç§ç±»å‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ `*.xml + *.cs` æˆ– `*.txt; *.cs`ï¼Œä½† Filter å±æ€§åªæ”¯æŒ `*.*`ï¼Œåœ¨äº‹ä»¶é‡Œå†è¿›è¡Œå­—ç¬¦ä¸²åˆ¤æ–­è¿‡æ»¤ e.FullPath.EndsWith(".xml") ã€‚

    using System;
    using System.Collections;
    using System.IO;
    using System.Security.Permissions;
    using System.Threading;

    public class Watcher
    {

        public static void Main()
        {
            string[] args = System.Environment.GetCommandLineArgs();
            string filter = args.Length>2? args[2]:"*.txt";

            // If a directory is not specified, exit program.
            if(args.Length < 2)
            {
                show();
                return;
            }
            Setup(args[1], filter);
            
            FileInfo ti = new FileInfo(Watcher._tmp);
            ti.Delete();
        }

        // Display the proper way to call the program.
        private static void show()
        {
            Console.WriteLine("FileSystemWatcher Usage: ");
            Console.WriteLine(" Watcher.exe directory filter");
            Console.WriteLine(" Watcher.exe . *.txt");
        }

        private static Timer _timer;
        private static string _tmp = Path.GetTempFileName();
        private static string tip_exit = "Watching {0} and press \"Alt + X\" to exit.";

        [PermissionSet(SecurityAction.Demand, Name="FullTrust")]
        public static void Setup(string path, string filter)
        {
            // Timer(TimerCallback, state_4_callback, dueTime, period)
            Watcher._timer = new Timer(new TimerCallback(OnTimerTick), null, Timeout.Infinite, Timeout.Infinite);

            // Create a new FileSystemWatcher and set its properties.
            FileSystemWatcher watcher = new FileSystemWatcher();

            /* Watch for changes in LastAccess and LastWrite times, and
               the renaming of files or directories. */
            watcher.NotifyFilter = NotifyFilters.LastAccess | NotifyFilters.LastWrite
               | NotifyFilters.FileName | NotifyFilters.DirectoryName;

            // Only watch text files.
            watcher.Filter = filter;

            // Add event handlers.
            watcher.Changed += new FileSystemEventHandler(OnChanged);
            watcher.Created += new FileSystemEventHandler(OnChanged);
            watcher.Deleted += new FileSystemEventHandler(OnChanged);
            watcher.Renamed += new RenamedEventHandler(OnRenamed);

            try
            {
                // Begin watching.
                watcher.Path = path;
                watcher.EnableRaisingEvents = true;
            } catch (ArgumentException e) {
                Console.WriteLine(e.Message);
                show();
                return;
            }

            // Wait for the user to quit the program.
            Console.WriteLine(Watcher.tip_exit, filter);
            ConsoleKeyInfo ki;
            bool suspress = true, Alt_X;
            do
            {
                ki = Console.ReadKey(suspress);
                Alt_X = ki.Key == ConsoleKey.X && (ki.Modifiers & ConsoleModifiers.Alt) > 0;
            } while (!Alt_X);
        }

        // Define the event handlers.
        private static void OnChanged(object source, FileSystemEventArgs e)
        {
            // Specify what is done when a file is changed, created, or deleted.
            string msg = string.Concat(new string[]{"File ", e.ChangeType.ToString(), ": ",  e.FullPath});
            loginfo(e.FullPath, msg);
        }

        private static void OnRenamed(object source, RenamedEventArgs e)
        {
            // Specify what is done when a file is renamed.
            string msg = string.Format("File Renamed: {0} renamed to {1}", e.OldFullPath, e.FullPath);
            loginfo(e.FullPath, msg);
        }

        private static ArrayList files = new ArrayList();
        private static void OnTimerTick(object state)
        {
            files.Clear();
        }

        private static void loginfo(string path, string msg)
        {
            Console.WriteLine(msg);
            FileInfo ti = new FileInfo(Watcher._tmp);

            // set timer filters 
            if (files.Contains(path)) return;
            files.Add(path);
            Watcher._timer.Change(300, 0);

            Console.WriteLine("Log to " + ti.FullName);
            using(StreamWriter sw = ti.AppendText()) // CreateText()/
            {
                FileInfo fi = new FileInfo(path);
                sw.WriteLine(msg);
                sw.WriteLine("Time ticks of {0}: ", path);
                sw.WriteLine("  {0:10} {1}", "Creation: ", fi.CreationTimeUtc.Ticks.ToString());
                sw.WriteLine("  {0:10} {1}", "Last Access: ", fi.LastAccessTimeUtc.Ticks.ToString());
                sw.WriteLine("  {0:10} {1}", "Last Write: ", fi.LastWriteTimeUtc.Ticks.ToString());
            }
        }
    }

## ==âš¡ C# å½“å‰ç¨‹åºè·¯å¾„ä¿¡æ¯

1. ASP.Net webform 

ç”¨ Request.PhysicalApplicationPath è·å–ç«™ç‚¹æ‰€åœ¨è™šæ‹Ÿç›®å½•çš„ç‰©ç†è·¯å¾„ï¼Œæœ€ååŒ…å«â€œ\â€ï¼›
 
2. C# Winform

- Application.StartupPath è·å–å½“å‰åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•çš„è·¯å¾„ï¼Œæœ€åä¸åŒ…å«â€œ\â€ï¼›
- Application.ExecutablePath  è·å–å½“å‰åº”ç”¨ç¨‹åºæ–‡ä»¶çš„è·¯å¾„ï¼ŒåŒ…å«æ–‡ä»¶çš„åç§°ï¼›
- AppDomain.CurrentDomain.BaseDirectory è·å–å½“å‰åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•çš„è·¯å¾„ï¼Œæœ€ååŒ…å«â€œ\â€ï¼›
- System.Threading.Thread.GetDomain().BaseDirectory è·å–å½“å‰åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•çš„è·¯å¾„ï¼Œæœ€ååŒ…å«â€œ\â€ï¼›
- Environment.CurrentDirectory è·å–å½“å‰åº”ç”¨ç¨‹åºçš„è·¯å¾„ï¼Œæœ€åä¸åŒ…å«â€œ\â€ï¼›
- System.IO.Directory.GetCurrentDirectory è·å–å½“å‰åº”ç”¨ç¨‹åºçš„è·¯å¾„ï¼Œæœ€åä¸åŒ…å«â€œ\â€ï¼›
 
3. C# windows service æœåŠ¡ä¸­ç”¨

AppDomain.CurrentDomain.BaseDirectory æˆ– System.Threading.Thread.GetDomain().BaseDirectoryï¼›

ç”¨ Environment.CurrentDirectory å’Œ System.IO.Directory.GetCurrentDirectory å°†å¾—åˆ° system32 ç›®å½•çš„è·¯å¾„ï¼›

å¦‚æœè¦ä½¿ç”¨ Application.StartupPath æˆ– Application.ExecutablePath ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ å¯¹ System.Windows.Forms.dll  çš„å¼•ç”¨ï¼Œå¹¶åœ¨ç¨‹åºå¼€å¤´ç”¨ using   System.Windows.Forms å£°æ˜è¯¥å¼•ç”¨ï¼›
 
4.åœ¨å¸è½½ç¨‹åºè·å–ç³»ç»Ÿå®‰è£…çš„ç›®å½•ï¼š

    System.Reflection.Assembly curPath = System.Reflection.Assembly.GetExecutingAssembly();
    string path=curPath.Location;
    //å¾—åˆ°å®‰è£…ç¨‹åºç±»SetupLibraryæ–‡ä»¶çš„è·¯å¾„ï¼Œè·å–è¿™ä¸ªæ–‡ä»¶è·¯å¾„æ‰€åœ¨çš„ç›®å½•å³å¾—åˆ°å®‰è£…ç¨‹åºçš„ç›®å½•;
 
    System.Diagnostics.StackFrame f = new System.Diagnostics.StackFrame(1);
    MethodBase mb = f.GetMethod();

    System.Web.HttpContext.Current.Response.Write(mb.DeclaringType.ToString()); 

è·å–è°ƒç”¨ç±»çš„ä¿¡æ¯,å¯ä»¥ä»çˆ¶ç±»çŸ¥é“å­ç±»çš„æƒ…å†µ



## ==âš¡ win32icon å›¾æ ‡ç¼–è¯‘

åŸºæœ¬å±æ€§

æ ‡é¢˜ Form.Text
å¤§å° Form.Size
ä½ç½® Form.StartPosition
å›¾æ ‡ Form.Icon
æ€»æ˜¯æœ€å‰ Form.TopMost


    using System;
    using System.ComponentModel;
    using System.Drawing;
    using System.Windows.Forms;

    /**
     * coding.cs
     * csc /target:winexe /win32icon:favicon.ico coding.cs
     */
    namespace demo
    {
        public class DemoForm : Form
        {
            public DemoForm()
            {
                // set caption
                this.Text = "çª—å£çš„æ ‡é¢˜";
                // CenterParent, CenterScreen, Manual, WindowsDefaultBounds, WindowsDefaultLocation
                this.StartPosition = FormStartPosition.CenterScreen;
                // weight, height
                this.Size = new Size(500, 600);
                // icon
                this.Icon = new System.Drawing.Icon("favicon.ico");
            }

            [STAThread]
            static void Main()
            {
                Application.EnableVisualStyles();
                Application.Run(new DemoForm());
            }
        }
    }


## ==âš¡ Diagnostics.Process 

æä¾›å¯¹æœ¬åœ°å’Œè¿œç¨‹è¿›ç¨‹çš„è®¿é—®æƒé™ï¼Œå¹¶ä½¿ä½ èƒ½å¤Ÿå¯åŠ¨å’Œåœæ­¢æœ¬åœ°ç³»ç»Ÿè¿›ç¨‹ã€‚

Process ç»„ä»¶æä¾›å¯¹è®¡ç®—æœºä¸Šè¿è¡Œçš„è¿›ç¨‹çš„è®¿é—®ã€‚ æœ€ç®€å•çš„è¿‡ç¨‹æ˜¯æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚ çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå‘å…¶åˆ†é…å¤„ç†å™¨æ—¶é—´çš„åŸºæœ¬å•å…ƒã€‚ çº¿ç¨‹å¯ä»¥æ‰§è¡Œè¿›ç¨‹çš„ä»»ä½•ä»£ç éƒ¨åˆ†ï¼ŒåŒ…æ‹¬å½“å‰ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„éƒ¨åˆ†ã€‚

Process ç»„ä»¶æ˜¯ç”¨äºå¯åŠ¨ã€åœæ­¢ã€æ§åˆ¶å’Œç›‘è§†åº”ç”¨ç¨‹åºçš„æœ‰ç”¨å·¥å…·ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ Process ç»„ä»¶è·å–æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥å¯åŠ¨æ–°çš„è¿›ç¨‹ã€‚ Process ç»„ä»¶ç”¨äºè®¿é—®ç³»ç»Ÿè¿›ç¨‹ã€‚ åˆå§‹åŒ– Process ç»„ä»¶åï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥è·å–æœ‰å…³æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¿¡æ¯ã€‚ æ­¤ç±»ä¿¡æ¯åŒ…æ‹¬ä¸€ç»„çº¿ç¨‹ã€å·²åŠ è½½çš„æ¨¡å—ï¼ˆ.dll å’Œ .exe æ–‡ä»¶ï¼‰ä»¥åŠæ€§èƒ½ä¿¡æ¯ï¼Œå¦‚è¿›ç¨‹æ­£åœ¨ä½¿ç”¨çš„å†…å­˜é‡ã€‚

    using System;

    public class demo : Form
    {

        [STAThread]
        static void Main()
        {
            string str = Console.ReadLine();

            System.Diagnostics.Process p = new System.Diagnostics.Process();
            p.StartInfo.FileName = "cmd.exe";
            p.StartInfo.UseShellExecute = false;    //æ˜¯å¦ä½¿ç”¨æ“ä½œç³»ç»Ÿshellå¯åŠ¨
            p.StartInfo.RedirectStandardInput = true;//æ¥å—æ¥è‡ªè°ƒç”¨ç¨‹åºçš„è¾“å…¥ä¿¡æ¯
            p.StartInfo.RedirectStandardOutput = true;//ç”±è°ƒç”¨ç¨‹åºè·å–è¾“å‡ºä¿¡æ¯
            p.StartInfo.RedirectStandardError = true;//é‡å®šå‘æ ‡å‡†é”™è¯¯è¾“å‡º
            p.StartInfo.CreateNoWindow = true;//ä¸æ˜¾ç¤ºç¨‹åºçª—å£
            p.Start();

            // å‘cmdçª—å£å‘é€è¾“å…¥ä¿¡æ¯
            p.StandardInput.WriteLine(str + "&exit");
            p.StandardInput.AutoFlush = true;
            // è¿™é‡Œä½¿ç”¨&æ˜¯æ‰¹å¤„ç†å‘½ä»¤çš„ç¬¦å·ï¼Œè¡¨ç¤ºå‰é¢ä¸€ä¸ªå‘½ä»¤ä¸ç®¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸéƒ½æ‰§è¡Œåé¢(exit)å‘½ä»¤ï¼Œå¦‚æœä¸æ‰§è¡Œexitå‘½ä»¤ï¼Œåé¢è°ƒç”¨ReadToEnd()æ–¹æ³•ä¼šå‡æ­»
            //åŒç±»çš„ç¬¦å·è¿˜æœ‰&&å’Œ||å‰è€…è¡¨ç¤ºå¿…é¡»å‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡ŒæˆåŠŸæ‰ä¼šæ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œåè€…è¡¨ç¤ºå¿…é¡»å‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå¤±è´¥æ‰ä¼šæ‰§è¡Œåé¢çš„å‘½ä»¤


            //è·å–cmdçª—å£çš„è¾“å‡ºä¿¡æ¯
            string output = p.StandardOutput.ReadToEnd();

            //StreamReader reader = p.StandardOutput;
            //string line=reader.ReadLine();
            //while (!reader.EndOfStream)
            //{
            //    str += line + "  ";
            //    line = reader.ReadLine();
            //}

            p.WaitForExit();
            p.Close();


            Console.WriteLine(output);
        }
    }


å…³äº rundll32.exe çš„ç”¨é€” 

- ç³»ç»Ÿé‡å¯å…³é—­

    - rundll32.exe user.exe,restartwindows 
    - rundll32.exe user.exe,exitwindows

- æ˜¾ç¤ºæ§åˆ¶é¢æ¿ 

    - rundll32.exe shell32.dll,Control_RunDLL 
    - rundll32.exe shell32.dll,Control_RunDLL access.cpl,,1 
    - rundll32.exe shell32.dll,Control_RunDLL telephon.cpl 




## ==âš¡ Drag&Drop æ‹–æ”¾

    using System;
    using System.Collections;
    using System.ComponentModel;
    using System.Drawing;
    using System.Windows.Forms;

    namespace coding
    {
        public class DemoForm : Form
        {
            public DemoForm()
            {
                // set caption
                this.Text = "è¯•è¯•æ‹–åŠ¨æ–‡å­—åˆ°çª—å£";
                // CenterParent, CenterScreen, Manual, WindowsDefaultBounds, WindowsDefaultLocation
                this.StartPosition = FormStartPosition.CenterScreen;
                // weight, height
                this.Size = new Size(500, 600);
                this.Icon = new System.Drawing.Icon("favicon.ico");

                // drap and drop settings
                this.AllowDrop = true;
                this.DragEnter += this.OnDragEnter;
                this.DragDrop += this.OnDragDrop;
            }

            [STAThread]
            static void Main()
            {
                Application.EnableVisualStyles();
                Application.Run(new DemoForm());
            }

            private void OnDragDrop(object sender, DragEventArgs e)
            {
                if(Formats.Contains(DataFormats.Html))
                {
                    string sa = (string)e.Data.GetData(DataFormats.Html);
                    Console.WriteLine(sa);
                    return;
                }else if(Formats.Contains(DataFormats.Text)){
                    string sa = (string)e.Data.GetData(DataFormats.Text);
                    Console.WriteLine(sa);
                    return;
                }

                // Ensure that the list item index is contained in the data.
                string[] s=(string[])e.Data.GetData(DataFormats.FileDrop, false);

                for (int i = 0; i < s.Length; i++)
                {
                    Console.WriteLine(s[i]);
                }
            }

            private ArrayList Formats = new ArrayList(); 
            private void OnDragEnter(object sender, DragEventArgs e)
            {
                // get formats from IDataObject.GetFormats()
                Formats.Clear();
                Formats.AddRange(e.Data.GetFormats());
                Console.WriteLine("GetFormats "+String.Join(",", Formats.ToArray()));
                if (e.Data.GetDataPresent(DataFormats.FileDrop) || Formats.Contains(DataFormats.Text))
                {
                    e.Effect = DragDropEffects.All;
                } else {
                    e.Effect = DragDropEffects.None;
                }
            }
        }
    }




## ==âš¡ NotifyIcon æœ€å°åŒ–è‡³ä»»åŠ¡æ 

    csc /target:winexe /win32icon:favicon.ico coding.cs

æœ€å°åŒ–è‡³ä»»åŠ¡æ  System.Windows.Forms.NotifyIconï¼Œç¼–è¯‘åŠ å…¥å›¾æ ‡èµ„æºï¼š


    using System;
    using System.Drawing;
    using System.Windows.Forms;

    public class Form1 : Form
    {
        private NotifyIcon notifyIcon;
        private ContextMenu contextMenu;
        private MenuItem menuItem;
        private System.ComponentModel.IContainer components;

        [STAThread]
        static void Main()
        {
            Application.Run(new Form1());
        }

        public Form1()
        {
            this.components = new System.ComponentModel.Container();
            this.contextMenu = new ContextMenu();
            this.menuItem = new MenuItem();

            // Initialize contextMenu
            this.contextMenu.MenuItems.AddRange(
                        new MenuItem[] {this.menuItem});

            // Initialize menuItem
            this.menuItem.Index = 0;
            this.menuItem.Text = "E&xit";
            this.menuItem.Click += new System.EventHandler(this.menuItem_Click);

            // Set up how the form should be displayed.
            this.ClientSize = new System.Drawing.Size(292, 266);
            this.Text = "Notify Icon Example";

            // Create the NotifyIcon.
            this.notifyIcon = new NotifyIcon(this.components);

            // The Icon property sets the icon that will appear
            // in the systray for this application.
            notifyIcon.Icon = new Icon("favicon.ico");

            // The ContextMenu property sets the menu that will
            // appear when the systray icon is right clicked.
            notifyIcon.ContextMenu = this.contextMenu;

            // The Text property sets the text that will be displayed,
            // in a tooltip, when the mouse hovers over the systray icon.
            notifyIcon.Text = "Form1 (NotifyIcon example)";

            // Handle the DoubleClick event to activate the form.
            notifyIcon.DoubleClick += new System.EventHandler(this.notifyIcon_DoubleClick);

            this.SizeChanged += new System.EventHandler(this.Form1_SizeChanged);
        }

        protected override void Dispose( bool disposing )
        {
            // Clean up any components being used.
            if( disposing && components != null)
            {
                components.Dispose();
            }

            base.Dispose( disposing );
        }

        #region æœ€å°åŒ–éšè—ä»»åŠ¡æ å›¾æ ‡ã€æ˜¾ç¤ºæ‰˜ç›˜å›¾æ ‡
        private void Form1_SizeChanged(object sender, EventArgs e)
        {
            if (WindowState == FormWindowState.Minimized)
            {
                this.ShowInTaskbar = false;
                notifyIcon.Visible = true;
            }
        }
        #endregion

        private void notifyIcon_DoubleClick(object Sender, EventArgs e)
        {
            // Show the form when the user double clicks on the notify icon.

            // Set the WindowState to normal if the form is minimized.
            if (this.WindowState == FormWindowState.Minimized)
            {
                this.WindowState = FormWindowState.Normal;
            }

            this.Activate();

            this.ShowInTaskbar = true;
            notifyIcon.Visible = false;
        }

        private void menuItem_Click(object Sender, EventArgs e) {
            this.Close();
        }
    }



# =ğŸš© IoC & Dependence Injection ä¾èµ–æ³¨å…¥
- [Microsoft DependencyInjection Source](https://github.com/aspnet/DependencyInjection)
- [WPF and IOC on .NET Core 3.0](https://laurentkempe.com/2019/04/18/WPF-and-IOC-on-NET-Core-3-0/)
- [IoC ä¾èµ–å€’ç½®åŸåˆ™](https://www.cnblogs.com/gaochundong/p/dependency_inversion_principle.html)
- [Inversion of Control Containers and the Dependency Injection pattern](https://www.martinfowler.com/articles/injection.html)
- [Microsoft.Extensions.DependencyInjection API](https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection?view=dotnet-plat-ext-3.1)
- [ASP.NET Core 3.0 æ¡†æ¶æ­ç§˜ ServicePrvider å®ç°](https://www.cnblogs.com/artech/p/asp-net-core-di-service-provider-1.html)
- [ASP.NET Core æ¡†æ¶ 7 ä¸ªæ ¸å¿ƒå¯¹è±¡](https://www.cnblogs.com/artech/p/inside-asp-net-core-framework.html)

Microsoft DependencyInjection ä½œä¸ºä¸€ä¸ªå¼€æºçš„ä¾èµ–æ³¨å…¥å®ç°ï¼Œå®ƒåœ¨ .Net Core é‡Œè¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œå®Œå…¨å¯ä»¥æ‰©å±•æ”¯æŒå…¶å®ƒç¬¬ä¸‰æ–¹çš„ IoC å®¹å™¨ã€‚


åœ¨ .NET Core åº”ç”¨ç¨‹åºé‡Œï¼Œä½ ä¼šå‘ç°åœ¨ Startup ç±»ä¸­å¤§é‡ä½¿ç”¨äº†ä¾èµ–æ³¨å…¥æ–¹æ³•å‘åº”ç”¨ç¨‹åºä¸­æ³¨å†Œç»„ä»¶æ¨¡å—ï¼Œå¦‚ï¼š

- services.AddMvc();
- services.AddSignalR();
- services.AddControllersWithViews();
- services.AddServerSideBlazor();
- services.AddRazorPages()
- services.AddDbContext<UserDC>();

- services.Add(new ServiceDescriptor(typeof(dbContext), new dbContext(cons)));
- services.AddSingleton(typeof(ILogger), typeof(ApiLogger));
- services.AddDistributedMemoryCache();
- services.AddSingleton<MainWindow>();

ç¤ºä¾‹ï¼Œå‡å®š ApiLogger ç±»å‹å®ç° ILogger æ¥å£ï¼š

    ApiLoggerConfig config = new ApiLoggerConfig();
    services.AddSingleton(config);
    services.AddSingleton(typeof(ILogger), typeof(ApiLogger));

ä»£ç ä¸­ä»¥å•ä¾‹æ¨¡å¼æ³¨å†Œé…ç½®å¯¹è±¡ configï¼Œå®ƒä¼šåœ¨ DependencyInjection å®ä¾‹åŒ– ILogger æ¥å£ç±»å‹å¯¹è±¡æ—¶æ³¨å…¥å…¶æ„é€ æ–¹æ³•ã€‚

æ³¨å†Œå¥½çš„æœåŠ¡ï¼Œè¦ä½¿ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡å„ç§æ–¹æ³•è·å–æœåŠ¡å®ä¾‹ï¼š

    HttpContext.RequestServices.GetService(typeof(dbContext)) as dbContext;
    ServiceProvider.GetService<MainWindow>();

è¿˜å¯ä»¥åœ¨æ§åˆ¶å™¨ç±»çš„æ„é€ å‡½æ•°çš„å‚æ•°ä¸­é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œåœ¨å®ä¾‹åŒ–æ—¶å¡«å……è¿›æ¥ï¼š

    public class Hello : Controller
    {
        private readonly UserDC _context;

        public Hello(UserDC context)
        {
            _context = context;
        }
    }


DependencyInjection è§£è€¦äº†æ•´ä¸ª .NET Core ç¨‹åºä½¿ç”¨çš„ç»„ä»¶ï¼Œè¿™æ ·åœ¨ç»´æŠ¤å’Œ NuGet åŒ…å‡çº§æ—¶éƒ½æ›´çµæ´»ï¼Œå„è‡ªæ¨¡å—è‡ªå·±æœ‰é—®é¢˜å°±è‡ªå·±è§£å†³ï¼Œè€Œä¸å½±å“å…¶å®ƒæ¨¡å—ã€‚


é€šå¸¸æ¨¡å—åŒ–ç»„ä»¶ä¼šéœ€è¦ç”¨åˆ°æ§åˆ¶åè½¬æ¨¡å¼ IoC - Inversion of Controlï¼Œå®ƒæœ€å…ˆè·Ÿéš Java çš„ Spring æ¡†æ¶æµè¡Œï¼Œé€šè¿‡åè½¬ä¾èµ–å…³ç³»ï¼Œå¯ä»¥æœ‰æ•ˆè§£è€¦æ¨¡å—åŒ–çš„ä»£ç ã€‚IoC çš„åŸºæœ¬æ€æƒ³æ˜¯ç­‰é€šçŸ¥ï¼šé…ç½®å¥½ï¼Œç­‰ä¾èµ–æ–¹å‘¼å«ã€‚æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š

- ä¾èµ–æŸ¥æ‰¾ Dependency Lookupï¼Œå·²ç»è¢«æŠ›å¼ƒï¼Œå› ä¸ºä»–éœ€è¦ç”¨æˆ·è‡ªå·±å»æ˜¯ä½¿ç”¨ API è¿›è¡ŒæŸ¥æ‰¾èµ„æºå’Œç»„è£…å¯¹è±¡ï¼Œå³æœ‰ä¾µå…¥æ€§ã€‚

- ä¾èµ–æ³¨å…¥ Dependency Injectionï¼Œæ˜¯ Spring ä½¿ç”¨çš„æ–¹å¼ï¼Œå®¹å™¨è´Ÿè´£ç»„ä»¶çš„è£…é…ã€‚Spring ä½œè€… Rod Johnson è®¾è®¡äº†ä¸¤ä¸ªæ¥å£ BeanFactory å’Œ ApplicationContext ç”¨ä»¥è¡¨ç¤ºå®¹å™¨ã€‚

Robert Martin ã€ŠThe Dependency Inversion Principleã€‹ æœ‰æ¸…æ¥šçš„è§£é‡‹ï¼Œå…¶ä¸­æåˆ°ä¸¤æ¡é‡è¦æ¦‚å¿µï¼š é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—ï¼Œå®ƒä»¬äºŒè€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ï¼› æŠ½è±¡ä¸åº”è¯¥ä¾èµ–äºç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚

ä¾è³´æ³¨å…¥åœ¨ Martin Fowler çš„æ–‡ç« æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š

- Type 1 IoC: Interface injection
- Type 2 IoC: Setter injection
- Type 3 IoC: Constructor injection

Setter å’Œ Constructor ä¸¤ç§æ–¹å¼åŒºåˆ«åœ¨äºåè€…é€šè¿‡æ„é€ å‡½æ•°å®ç°ä¾èµ–æ³¨å…¥ï¼Œå‰è€…åˆ™ä½¿ç”¨ä¸“ç”¨æ–¹æ³•æ¥å®ç°ã€‚Spring æ¡†æ¶é¼“åŠ±ä½¿ç”¨ Type 2 IoC å³ Setter injection æ–¹å¼ã€‚


ä¾èµ–åè½¬åŸåˆ™ Dependency Inversion Principle æ˜¯å¾ˆå¤šé¢å‘å¯¹è±¡æŠ€æœ¯çš„æ ¹åŸºï¼Œå®ƒç‰¹åˆ«é€‚åˆåº”ç”¨äºæ„å»ºå¯å¤ç”¨çš„è½¯ä»¶æ¡†æ¶ï¼Œå…¶å¯¹äºæ„å»ºå¼¹æ€§åœ°æ˜“äºå˜åŒ–çš„ä»£ç ä¹Ÿç‰¹åˆ«é‡è¦ã€‚å¹¶ä¸”ï¼Œå› ä¸ºæŠ½è±¡å’Œç»†èŠ‚å·²ç»å½¼æ­¤éš”ç¦»ï¼Œä»£ç ä¹Ÿå˜å¾—æ›´æ˜“ç»´æŠ¤ã€‚

ä¸¾å®ä¾‹è¯´æ˜ï¼Œç°åœ¨æœ‰ä¸ªç¨‹åºéœ€æ±‚æ˜¯å®ç°ä¸€ä¸ªè®°å½•å†™å…¥çš„ç»„ä»¶ï¼Œç›®å‰åªæœ‰è½¯ç›˜ä½œè®°å½•ï¼Œé‚£ä¹ˆç»„ä»¶å®ç°å¯èƒ½ä¼šæœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•

    public function saveToFloppy(String content){
        ...
    }

ä½†è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„å®ç°ï¼Œå› ä¸ºä¾èµ–äº†å…·è±¡ï¼Œç»„ä»¶çš„å®ç°ä¾èµ–äº†å­˜å‚¨ä»‹è´¨ï¼Œè¿™å°±æ˜¯é«˜è€¦åˆçš„ Type 1 IoCï¼Œå…·æœ‰å¼·çš„ä¾µå…¥æ€§ï¼Œä½¿ç”¨å®ƒä¾†å¯¦ç¾ä¾è³´æ³¨å…¥æœƒä½¿å¾—çµ„ä»¶ç›¸ä¾æ–¼å®¹å™¨ï¼ˆæ¡†æ¶ï¼‰ï¼Œé™ä½çµ„ä»¶çš„é‡ç”¨æ€§ã€‚

å¦‚æœéœ€æ±‚è¿›ä¸€æ­¥å˜åŒ–äº†ï¼Œç°åœ¨éœ€è¦å†™å…¥ USB ç§»åŠ¨ç£ç›˜äº†ï¼Œé‚£ä¹ˆç¨‹åºé€»è¾‘å°±ä¸èƒ½å¾ˆå¥½æ»¡è¶³äº†ï¼Œå¿…éœ€ä¿®æ”¹ç°æœ‰ä»£ç åŒ¹é…æ–°éœ€æ±‚ã€‚ä½†æ›´å¥½çš„çš„æ–¹æ³•æ˜¯æŒ‰å‰é¢æåˆ°çš„ä¸¤æ¡ä¾èµ–åŸåˆ™æ¥å®ç°ï¼Œç»„ä»¶ä¸åº”è¯¥ä¾èµ–å…·ä½“çš„å­˜å‚¨ä»‹è´¨ã€‚

æŠŠæ¶‰åŠå­˜å‚¨ä»‹è´¨çš„é«˜è€¦åˆéƒ¨åˆ†æ‹†è§£å‡ºå»ï¼Œç»„ä»¶åªå…³å¿ƒé«˜å±‚æ¬¡çš„æŠ½è±¡åŠŸèƒ½ã€‚å³ç»„ä»¶åªå…³å¿ƒå¦‚æœå®ç°å®ç°å®šç¨¿è®°å½•çš„åŠ¨ä½œï¼Œè€Œè‡³äºå†™å…¥åˆ°ä»€ä¹ˆä»‹è´¨åˆ™äº¤ç”±å…·ä½“åº•å±‚å»å®ç°ï¼Œé‚£ä¹ˆè¿™äº›åº•å±‚å¯ä»¥å«åš FloppyWriterã€UsbDiskWriterï¼Œå®ƒä»¬å…³å¿ƒå†™çš„åŠ¨ä½œã€‚è€ŒæŠ½è±¡åçš„ç»„ä»¶åˆ™å°†é‡å¿ƒè½¬ç§»åˆ°å¦‚ä½•åè°ƒè¿™äº›åº•å±‚çš„è°ƒç”¨ï¼Œè¿™å°±éœ€è¦è¿›è¡Œä¸€ä¸ªæŠ½è±¡æ¥å£çš„ç»Ÿä¸€ã€‚å¯ä»¥è§„å®šæ¥å£ä¸º IDeviceWriterï¼Œå®ç°ä¸€ä¸ª saveToDevice æ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å®ç°å†™å…¥åŠ¨ä½œï¼Œé‚£ä¹ˆæŠ½è±¡åçš„ç»„ä»¶åº”è¯¥è¿™è¿™æ ·å®ç°ï¼š

    public class FloppyWriter implements IDeviceWriter { 
        public void saveToDevice() { 
            .... 
        } 
    } 

    public class UsbDiskWriter implements IDeviceWriter { 
        public void saveToDevice() { 
            .... 
        } 
    }


åœ¨ä¸€ä¸ªåº”ç”¨æ¡†æ¶ä¸­ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨å„ç§å„æ ·çš„æœåŠ¡ï¼Œæœ‰å¿…è¦å°†å®ƒä»¬é›†ä¸­ç®¡ç†ï¼Œéœ€è¦ä»€ä¹ˆæœåŠ¡å°±å‘ IoC å®¹å™¨æ³¨å†Œä»€ä¹ˆæœåŠ¡ï¼Œåœ¨ä½¿ç”¨æœåŠ¡æ—¶å‘ IoC å®¹å™¨è·å–ç›¸åº”çš„æœåŠ¡å®ä¾‹ã€‚åœ¨ä½¿ç”¨ Java Spring æ¡†æ¶ä¸­ï¼Œæä¾›ä¸¤ä¸ªæ ¸å¿ƒå®¹å™¨ï¼ŒBeanFactory å’Œ ApplicationContextï¼Œè¿™ä¸¤ä¸ªå®¹å™¨çš„å°±æ˜¯ Spring ä¾èµ–ç®¡ç†çš„æ ¸å¿ƒæ‰€åœ¨ã€‚


IoC å®¹å™¨çš„ä¸€èˆ¬çš„ä½¿ç”¨æµç¨‹ï¼š

- å®ä¾‹åŒ–ä¸€ä¸ªæœåŠ¡å®¹å™¨ ServiceCollection å¹¶æ³¨å†Œéœ€è¦ä½¿ç”¨çš„æœåŠ¡ï¼›
- é€šè¿‡ ServiceCollection çš„ BuildServiceProvider æ–¹æ³•è¿”å›ä¸€ä¸ªæœåŠ¡ä¾›åº”è€…å®ä¾‹ï¼›
- é€šè¿‡æœåŠ¡ä¾›åº”è€…çš„ GetService æ–¹æ³•è·å–ç›¸åº”çš„æœåŠ¡å®ä¾‹ï¼›
- ä½¿ç”¨æœåŠ¡å®ä¾‹ã€‚

æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å†³å®š ServiceProvider é‡‡ç”¨æ€æ ·çš„æ–¹å¼åˆ›å»ºå’Œå›æ”¶æœåŠ¡å®ä¾‹ï¼Œæšä¸¾ç±»å‹ ServiceLifetime æŒ‡å®šä¸‰ä¸ªæ–¹å¼ï¼š

- Singleton è¡¨ç¤ºä»¥å•ä¾‹çš„æ–¹å¼ç®¡ç†æœåŠ¡å®ä¾‹ï¼Œå³åœ¨æ¯æ¬¡è·å–æœåŠ¡æ—¶ï¼ŒæœåŠ¡å®ä¾‹æ˜¯åŒä¸€ä¸ªï¼›
- Transient åˆ™å®Œå…¨ç›¸åï¼Œå¯¹äºæ¯æ¬¡æœåŠ¡æä¾›è¯·æ±‚ï¼Œæ€»ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚
- Scoped æ–¹å¼æŒ‡å®šä¸€ä¸ª ServiceScope æ¥åœˆå®šæœåŠ¡çš„ä½œç”¨åŸŸï¼Œå®ƒç»§æ‰¿è‡ª IDisposable æ¥å£ï¼Œæ‰§è¡Œ Dispose æ–¹æ³•å›æ”¶æœåŠ¡å®ä¾‹ã€‚



ä»¥ä¸‹æ˜¯å‡ ä¸ªé‡è¦çš„ç±»æˆ–æ¥å£ï¼š

- ServiceCollection

    ç”¨æ¥æ³¨å†ŒæœåŠ¡çš„ IoC å®¹å™¨ï¼ŒæœåŠ¡æ³¨å†Œåï¼Œå¯ä»¥åœ¨ä»»æ„ç±»å‹çš„æ„é€ æ–¹æ³•ä¸­ä½¿ç”¨å®ƒï¼Œè€Œä¸æ˜¯åªèƒ½åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ã€‚

    å„ç§æ³¨å†ŒæœåŠ¡çš„ C# æ‰©å±•æ–¹æ³•åŸºæœ¬æŒ‰ LifeTime æ–¹å¼åˆ†æˆä¸‰ç±»ï¼ŒSingleton/Transient/Scopedã€‚å®šä¹‰åœ¨ ServiceCollectionServiceExtensions å…¶å®ƒæ›´å¤šçš„æ˜¯é‡è½½æ–¹æ³•ï¼Œæ³¨å†Œæ–¹æ³•éƒ½ä¼šè¿”å›æœåŠ¡å®¹å™¨ï¼Œå¯ä»¥é“¾å¼è°ƒç”¨ã€‚æ³›å‹æ³¨å†Œæ–¹æ³•ä¼šé—´æ¥è°ƒç”¨éæ³›å‹æ³¨å†Œæ–¹æ³•ï¼Œæ¯”å¦‚ `AddSingleton<TService>()` ç­‰ä»· `AddSingleton(typeof(TService))`ã€‚è·å–æœåŠ¡æ—¶ï¼Œä¹Ÿè¦ç”¨å¯¹åº”çš„æ–¹å¼ `GetService<TService>()`ã€‚

    - AddScoped<TService>()     æœåŠ¡åŸŸæ–¹å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡
    - AddSingleton<TService>()  å•ä¾‹æ¨¡å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡
    - AddTransient<TService>()  æŒ‰ä¸´æ—¶æ€ç”Ÿå‘½å‘¨æœŸæ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡

    - Add(ServiceDescriptor)    é€šè¿‡æœåŠ¡æè¿°ç¬¦å¯¹è±¡æ·»åŠ æœåŠ¡
    - Add(IEnumerable<ServiceDescriptor>)   é€šè¿‡å¤šä¸ªæœåŠ¡æè¿°ç¬¦å¯¹è±¡æ·»åŠ æœåŠ¡

    - RemoveAll(Type)   ç§»é™¤æŒ‡å®šç±»å‹çš„æœåŠ¡
    - RemoveAll<T>()    ç§»é™¤æŒ‡å®šç±»å‹çš„æœåŠ¡
    - Replace(ServiceDescriptor)    æ ¹æ®æœåŠ¡æè¿°ç¬¦å¯¹è±¡ç§»é™¤æœåŠ¡

    - AddSingleton(Type)    å•ä¾‹æ¨¡å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡
    - AddSingleton(Type, Func<IServiceProvider,Object>) å•ä¾‹æ¨¡å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡å¹¶æŒ‡å®šå·¥å‚å‡½æ•°
    - AddSingleton(Type, Object)    å•ä¾‹æ¨¡å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡å¹¶æŒ‡å®šå®ç°å®ä¾‹
    - AddSingleton(Type, Type)  å•ä¾‹æ¨¡å¼æ·»åŠ æŒ‡å®šç±»å‹çš„æœåŠ¡å’Œç›¸åº”å®ç°çš„ç±»å‹

- ServiceDescriptor

    æœåŠ¡æè¿°ç¬¦ç±»å‹è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

    - æœåŠ¡ç±»å‹ `ServiceType`
    - å®ç°ç±»å‹ `ImplementationType`
    - æœåŠ¡å¯¹è±¡å®ä¾‹ `ImplementationInstance`
    - å®ä¾‹åŒ–å·¥å‚å‡½æ•° `ImplementationFactory`
    - æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸ `Lifetime`

    åœ¨ ServiceCollection ä¸­æ³¨å†Œçš„æœåŠ¡éƒ½ä¼šè®°å½•åœ¨ä¸€ä¸ª List<ServiceDescriptor>ã€‚

- ServiceProvider

    æœåŠ¡ä¾›åº”è€…ï¼Œå®ƒä»…æä¾›äº†å”¯ä¸€ä¸ª GetService æ–¹æ³•ä»æœåŠ¡å®¹å™¨è·å–æœåŠ¡ç±»å‹å®ä¾‹ã€‚

- ServiceScope & ServiceScopeFactory
- DynamicServiceProviderEngine
- CompiledServiceProviderEngine
- ServiceProviderEngine

    æ˜¯ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒï¼Œå®ƒå®šä¹‰äº† GetService() æ–¹æ³•è¢« IServiceProvider è°ƒç”¨ã€‚


ä¸ºäº†åœ¨æ€§èƒ½ä¸å¼€é”€ä¸­è·å–å¹³è¡¡ï¼ŒDependencyInjection åœ¨åˆæ¬¡è¯·æ±‚æ—¶ä½¿ç”¨åå°„å®ä¾‹åŒ–ç›®æ ‡æœåŠ¡ï¼Œå†æ¬¡è¯·æ±‚æ—¶å¼‚æ­¥ä½¿ç”¨è¡¨è¾¾å¼æ ‘æ›¿æ¢äº†ç›®æ ‡å®ä¾‹åŒ–å§”æ‰˜ï¼Œä½¿å¾—åç»­è¯·æ±‚å°†å¾—åˆ°æ€§èƒ½æå‡ã€‚DependencyInjection å¹¶éæ˜¯é“¶å¼¹ï¼Œå®ƒçš„ä¾¿åˆ©æ€§æ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„å…¸å‹ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»¥ä¸‹æƒ…å†µæœ‰æ‰€äº†è§£ï¼š

- é‡åº¦ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„å¤§å‹é¡¹ç›®å¯åŠ¨è¿‡ç¨‹ç›¸å½“ä¹‹æ…¢ï¼›
- å¦‚æœå•æ¬¡è¯·æ±‚éœ€è¦å®ä¾‹åŒ–çš„ç›®æ ‡æœåŠ¡è¿‡å¤šï¼Œå‰æœŸè¯·æ±‚çš„å†…å­˜å¼€é”€ä¸å¯è½»è§†ï¼›
- ç”±äºå®ä¾‹åŒ–ä¼´éšç€é€’å½’è°ƒç”¨ï¼Œè¿‡æ·±çš„ä¾èµ–å°†ä¸å¯é¿å…åœ°å¯¼è‡´å †æ ˆæº¢å‡ºï¼›

å¯ä»¥ä½¿ç”¨ Visual Studio 2017 è‡ªå¸¦çš„è¯Šæ–­å·¥å…· Diagnostic Tools è¿›è¡Œæ€§èƒ½åˆ†æã€‚


å…¶å®ƒä½¿ç”¨ Microsoft.Extensions.DependencyInjection çš„ IoC å®¹å™¨ï¼š

- Autofac https://autofac.readthedocs.org/en/latest/integration/aspnetcore.html
- DryIoc https://www.nuget.org/packages/DryIoc.Microsoft.DependencyInjection
- Grace https://www.nuget.org/packages/Grace.DependencyInjection.Extensions
- LightInject https://github.com/seesharper/LightInject.Microsoft.DependencyInjection
- StructureMap https://github.com/structuremap/StructureMap.Microsoft.DependencyInjection
- Stashbox https://github.com/z4kn4fein/stashbox-extensions-dependencyinjection
- Unity https://www.nuget.org/packages/Unity.Microsoft.DependencyInjection/


## ==âš¡ DependenceInjection WPF Demo

æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ª WPF ç¨‹åºæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å„ç§ä¾èµ–æ³¨å…¥æ–¹å¼çš„ä½¿ç”¨ã€‚æ‰§è¡Œå‘½ä»¤åˆ›å»º WPF ç¨‹åºå·¥ç¨‹æ¨¡æ¿ï¼Œå¹¶å®‰è£… DependencyInjection æ¨¡å—ï¼š

    dotnet new wpf -o WPF-DI
    dotnet add package Microsoft.Extensions.DependencyInjection  -version 3.1.4

åˆ›å»ºå­—ç¬¦ä¸²æœåŠ¡ç±»å‹ï¼Œåªæä¾›æ–‡å­—æœåŠ¡ä»¥æ¼”ç¤ºï¼š

    public interface ITextService
    {
        string GetText();
    }

    class TextService : ITextService
    {
        private string _text;

        public TextService(string text)
        {
            _text = text;
        }
        
        public string GetText()
        {
            return _text;
        }
    }

ç„¶åï¼Œä¸»çª—ä½“ç±»ä»£ç  MainWindow.xaml.csï¼Œä¸»è¦æ˜¯æä¾›ä¸¤ä¸ªæ„é€ å‡½æ•°ä»¥æ¼”ç¤ºä¾èµ–æ³¨å…¥å¦‚ä½•å¡«å……å‚æ•°ï¼š

    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
            Console.WriteLine($"MainWindow()");
        }
        
        public MainWindow(ITextService textService)
        {
            InitializeComponent();
            Console.WriteLine($"MainWindow(ITextService)");
            Label.Content = textService.GetText();
        }

        private void button_click(object sendr, RoutedEventArgs e)
        {
            // MessageBox.Show("Hello WPF!");
            // Application.Current.Shutdown();
            Close();
        }
    }

å¯ä»¥åœ¨ MainWindow.xaml æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®è¿™æ˜¯å¯é€‰çš„ï¼š

    <Button Name="button" Click="button_click">Click</Button>

æ¥ä¸‹æ¥æ˜¯ä¸»ç¨‹åºä»£ç  App.xaml.csï¼š

    using System;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Data;
    using System.Linq;
    using System.Threading.Tasks;
    using System.Windows;
    using Microsoft.Extensions.DependencyInjection;

    namespace wpf
    {
        /// <summary>
        /// Interaction logic for App.xaml
        /// </summary>
        public partial class App : Application
        {
            public IServiceProvider _serviceProvider;

            public App()
            {
                var serviceCollection = new ServiceCollection();
                ConfigureServices(serviceCollection);

                _serviceProvider = serviceCollection.BuildServiceProvider();

                var mainWindow = _serviceProvider.GetService<MainWindow>();
                Console.WriteLine($"GetService {mainWindow}");
                mainWindow?.Show();
            }

            private void ConfigureServices(IServiceCollection services)
            {

                var ts = new TextService("Hi WPF .NET Core 1.0!");
                services.AddSingleton(typeof(ITextService), ts);

                services.AddSingleton<ITextService, TextService>(provider =>{
                    Console.WriteLine($"Provider {provider}");
                    return new TextService("Hi WPF .NET Core 3.0!");
                    });

                services.AddSingleton<MainWindow>(provider => {
                    // Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope
                    // Console.WriteLine($"Provider {provider.GetType()}");
                    // MessageBox.Show("Lambada ImplementationFactory");
                    return new MainWindow(new TextService("Hi WPF!"));
                    });

                services.AddSingleton<MainWindow>();
            }
        }
    }

æ³¨æ„ï¼ŒæœåŠ¡è¿™ä¸ªæ¦‚å¿µå¹¶ä¸å±€é™äº TextService è¿™ä¸ªå¯¹è±¡ï¼Œæ³¨æ„ `GetService<MainWindow>()` è¿™å¥ä»£ç çš„éšå«æ„æ€å°±æ˜¯å°† MainWindow ç±»å½¢å½“æœåŠ¡ï¼Œæ‰€ä»¥è¿™ä¸ªç¤ºä¾‹ä»£ç å­˜åœ¨ TextService å’Œ MainWindow ä¸¤ç§æœåŠ¡ç±»å‹ã€‚

è¿™é‡Œä½¿ç”¨äº†å››ç§æœåŠ¡æ³¨å†Œæ–¹å¼ï¼Œç¬¬ä¸€ã€äºŒç§åˆ†åˆ«ä½¿ç”¨çš„æ˜¯ä»¥ä¸‹å½¢å¼ï¼š

    services.AddSingleton(ImplementationType, ImplementationInstance)
    services.AddSingleton<ServiceType, ImplementationType>(ImplementationFactory)

ä¸¤ç§éƒ½ä½¿ç”¨äº†å¯¹è±¡å®ä¾‹ï¼Œç¬¬äºŒç§é€šè¿‡ Lambada æ–¹å¼å®ç°çš„ ImplementationFactory å·¥å‚å‡½æ•°è¿”å›å®ä¾‹ã€‚å› ä¸ºè¿™ä¸¤ä¸ªæœåŠ¡æ˜¯è¦ä½œä¸ºå…¶å®ƒæœåŠ¡çš„æ„é€ å‡½æ•°å‚æ•°ä½¿ç”¨çš„ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å¡«å……åˆ° MainWindow çš„ç¬¬äºŒä¸ªæ„é€ å‡½æ•°ä¸­ï¼Œå¡«å……æ—¶é€‰æ‹©æœ€åæ³¨å†Œçš„æœåŠ¡å®ä¾‹ã€‚å¦‚æœä¸æ³¨å†Œè¿™ä¸¤ä¸ªæœåŠ¡å®ä¾‹ï¼Œé‚£ä¹ˆ DependencyInjection åœ¨å®ä¾‹åŒ–å…¶å®ƒæœåŠ¡æ—¶ï¼Œä¸ä¼šä»¥æœ‰ä¾èµ–æ³¨å…¥è¡Œä¸ºã€‚å³æ‰§è¡ŒæœåŠ¡ç±»å‹çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ„é€ å‡½æ•°ã€‚

ç¬¬ä¸‰ã€å››ç§ä½¿ç”¨ä»¥ä¸‹æ³¨å†Œæ–¹å¼ï¼š

    services.AddSingleton<ImplementationType>(ImplementationFactory)
    services.AddSingleton<ImplementationType>()

å®ƒä»¬éƒ½æ²¡æœ‰ä½¿ç”¨ ImplementationInstanceï¼Œç¬¬ä¸‰ç§æ³¨å†Œæ–¹å¼ç›´æ¥åœ¨ ImplementationFactory ä¸­æ³¨å…¥äº†æœåŠ¡ä¾èµ–çš„å¯¹è±¡ã€‚ç¬¬å››ç§æ³¨å†Œæ–¹å¼ä¼šæ ¹æ®å·²ç»æ³¨å†Œè¿‡çš„æœåŠ¡å†³å®šå¦‚ä½•è°ƒç”¨æ„é€ å‡½æ•°ï¼Œå‡å¦‚æ²¡æœ‰ç¬¬ä¸€ã€äºŒç§æ³¨å†Œå¥½çš„æœåŠ¡å®ä¾‹ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œé»˜è®¤çš„æ„é€ å‡½æ•°ã€‚å¦‚æœåˆæ²¡æœ‰æä¾›é»˜è®¤æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•è§£å†³ä¾èµ–æ³¨å…¥çš„å‚æ•°ã€‚

åªæœ‰åœ¨ç¬¬ä¸€ã€äºŒã€å››ç§æœåŠ¡éƒ½æ²¡æœ‰æ³¨å†Œçš„æƒ…å†µä¸‹ï¼Œ`GetService<MainWindow>()` æ‰ä¼šè§¦å‘ç¬¬ä¸‰ç§æ³¨å†Œæ–¹å¼ä¸­çš„å·¥å‚å‡½æ•°ï¼Œå»å®ä¾‹åŒ–ä¸€ä¸ª MainWindow å¯¹è±¡ã€‚









# =ğŸš© Razor Page æ¡†æ¶
- [ASP.NET Core Razor Pages](https://docs.microsoft.com/zh-cn/aspnet/core/razor-pages/?view=aspnetcore-3.1)
- [ASP.NET ä¸»æœºé…ç½®](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-3.1)

Razor Pages æ˜¯ ASP.NET Core MVC çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œä½¿ç”¨ Razor æ¨¡æ¿è¯­æ³•ï¼Œä½¿ç”¨ cshtml è§†å›¾æ¨¡æ¿æ–‡ä»¶ï¼Œå®ƒå¯ä»¥ä½¿åŸºäºé¡µé¢çš„ç¼–ç æ–¹å¼æ›´ç®€å•é«˜æ•ˆï¼Œç®€åŒ–äº†ä¼ ç»Ÿçš„ MVC æ¨¡å¼ã€‚

è¦åˆ›å»ºåŸºæœ¬ Web åº”ç”¨ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œç„¶åæ‰§è¡Œ dotnet run è¿è¡Œï¼ŒASP.NET å¯ä»¥é…åˆ ï¼š

    dotnet new webApp -o myWebApp --no-https

    dotnet new webApp -o myWebApp
    dotnet dev-certs https --trust

é¡¹ç›®ç»“æ„ï¼š

- Pages æ–‡ä»¶å¤¹

    åŒ…å« Razor é¡µé¢å’Œæ”¯æŒæ–‡ä»¶ï¼Œæ¯ä¸ª Razor é¡µé¢éƒ½ç”±ä¸¤éƒ¨åˆ†ç»„ä»¶ï¼Œ`.cshtml` å’Œä¸€ä¸ªåŒ…å«å¤„ç†é¡µé¢äº‹ä»¶çš„ C# ä»£ç æ–‡ä»¶ `.cshtml.cs`ã€‚

    æ”¯æŒæ–‡ä»¶çš„åç§°ä»¥ä¸‹åˆ’çº¿å¼€å¤´ã€‚ ä¾‹å¦‚ï¼Œ`_Layout.cshtml` æ–‡ä»¶å¯é…ç½®æ‰€æœ‰é¡µé¢é€šç”¨çš„ UI å…ƒç´ ï¼Œå¯ä»¥æ˜¯ HTML æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥æ˜¯ç±»ä¼¼ HTML æ ‡ç­¾çš„ ASP.NET Core åŠ©æ‰‹æ ‡ç­¾ï¼Œè¿˜å¯ä»¥åŒ…å« Razor è¯­æ³•çš„ Cï¼ƒ ä»£ç ã€‚

    åŠ©æ‰‹æ ‡ç­¾å’Œ HTML æ ‡ç­¾çš„åŒºåˆ«åœ¨äº `asp-` å‰ç¼€ï¼Œ

        <a class="nav-link text-dark" asp-area="" asp-page="/Index">Home</a>
        <a class="nav-link text-dark" href="/Index/Session">Session</a>

- wwwroot æ–‡ä»¶å¤¹

    åŒ…å«é™æ€æ–‡ä»¶ï¼Œå¦‚ HTML æ–‡ä»¶ã€JavaScript æ–‡ä»¶å’Œ CSS æ–‡ä»¶ã€‚å¯ä»¥é€šè¿‡ Startup é…ç½®æ¥å¯ç”¨é™æ€æ–‡ä»¶æœåŠ¡ï¼š

        app.UseDefaultFiles();
        app.UseStaticFiles();

- appSettings.json

    åŒ…å«é…ç½®æ•°æ®ï¼Œå¦‚è¿æ¥å­—ç¬¦ä¸²ã€‚

- Program.cs

    åŒ…å«ç¨‹åºçš„å…¥å£ç‚¹ï¼Œæ„é€  .NET é€šç”¨ä¸»æœºæä¾› HTTP æœåŠ¡ã€‚

- Startup.cs

    åŒ…å«é…ç½®åº”ç”¨è¡Œä¸ºçš„ä»£ç ã€‚ ASP.NET Core ä¸­çš„åº”ç”¨å¯åŠ¨é…ç½®éƒ½æ˜¯åœ¨æ­¤è®¾ç½®ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥æ¿€æ´»è·¯ç”±ï¼ŒMVC/Blazor ç­‰ç­‰æ¡†æ¶æœåŠ¡ã€‚


æ²¡æœ‰æ‰“å¼€çƒ­åŠ è½½å¼€å‘ä½“éªŒå¹¶ä¸é‚£ä¹ˆå¥½ï¼Œçƒ­åŠ è½½æ˜¯åŸºæœ¬çš„å¼€å‘éœ€æ±‚ï¼Œä¿®æ”¹åè¦åœ¨æµè§ˆå™¨ä¸Šçœ‹åˆ°æ›´æ–°ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°ï¼Œä¸€æ˜¯ä½¿ç”¨ Razor Page çš„è¿è¡Œæ—¶ç¼–è¯‘æ¨¡å—ï¼Œå¦ä¸€ç§å°±æ˜¯ä½¿ç”¨ dotnet watch å¯åŠ¨å¼€å‘æ¨¡å¼ä¸‹çš„æ–‡ä»¶ç›‘è§†åŠŸèƒ½ï¼Œåªè¦æ–‡ä»¶æ”¹åŠ¨ï¼Œå°±è‡ªåŠ¨é‡æ–°ç¼–è¯‘ã€‚

è¦ä½¿ç”¨è¿è¡Œæ—¶æ–‡ä»¶ç¼–è¯‘ï¼Œå°±è¦é…ç½® ASP.NET Core ä¸­çš„ Razor æ–‡ä»¶ç¼–è¯‘åŠŸèƒ½ã€‚æˆ–è€…åˆ›å»º Razor Pages é¡¹ç›®æ¨¡æ¿æ—¶ä½¿ç”¨ -rrc æˆ– --razor-runtime-compilation æ¨¡æ¿é€‰é¡¹ï¼Œå®ƒä¼šè‡ªåŠ¨ä¿®æ”¹å¥½ LaunchSettings é…ç½®ï¼š

    dotnet new webapp --razor-runtime-compilation

åœ¨ç°æœ‰é¡¹ç›®ä¸­å¯ç”¨è¿è¡Œæ—¶ç¼–è¯‘ï¼Œè¦å®‰è£… Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation åŒ…ï¼š

    dotnet add package Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation --version 3.1.4

æ›´æ–°é¡¹ç›®çš„ Startup.ConfigureServices æ–¹æ³•ä»¥åŒ…å«å¯¹ AddRazorRuntimeCompilation çš„è°ƒç”¨ã€‚

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages()
            .AddRazorRuntimeCompilation();

        // code omitted for brevity
    }

å¦‚æœä»…åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨è¿è¡Œæ—¶ç¼–è¯‘ï¼Œæ·»åŠ è¿è¡Œæ—¶ç¼–è¯‘åŒ…åï¼Œä¿®æ”¹ LaunchSettings çš„ environmentVariables å¯åŠ¨è®¾ç½®ï¼Œå…¶å®ƒé…ç½®å¦‚ç›‘å¬ç«¯å£å¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼š

    "environmentVariables": {
      "ASPNETCORE_ENVIRONMENT": "Development",
      "ASPNETCORE_HOSTINGSTARTUPASSEMBLIES": "Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation"
    }


åœ¨ Startup.cs ä¸­è°ƒç”¨ AddRazorPages å’Œ MapRazorPages å¯ç”¨ Razor é¡µé¢ã€‚MapRazorPages è´Ÿè´£å»ºç«‹ Razor Pages ä¸è·¯ç”±çš„æ˜ å°„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶åœ¨ Pages æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ Razor é¡µé¢æ–‡ä»¶ã€‚URL æœªåŒ…å«é¡µé¢æ—¶ï¼ŒIndex ä¸ºé»˜è®¤é¡µé¢ã€‚

    public class Startup
    {
        ...
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddRazorPages();
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
        ...
            app.UseEndpoints(endpoints =>
            {
                endpoints.MapRazorPages();
            });
        }
    }

AddRasorPage æ–¹æ³•æ¿€æ´» MVC æ¡†æ¶ï¼Œä¼šè¿”å›ä¾èµ–æ³¨å…¥çš„ Microsoft.Extensions.DependencyInjection.MvcBuilder å¯¹è±¡ä»¥è¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚è·¯ç”±çš„é…ç½®ã€‚


ASP.NET Core æ¨¡æ¿é…ç½®ä¼šåˆ›å»ºä¸€ä¸ª .NET Core æ³›å‹ä¸»æœº HostBuilderã€‚

å¯åŠ¨ä¸»æœºæ—¶ï¼Œå®ƒå¯¹å®ƒåœ¨ DI å®¹å™¨ä¸­æ‰¾åˆ°çš„ IHostedService çš„æ¯ä¸ªå®ç°è°ƒç”¨ IHostedService.StartAsyncã€‚ åœ¨ web åº”ç”¨ä¸­ï¼Œå…¶ä¸­ä¸€ä¸ª IHostedService å®ç°æ˜¯å¯åŠ¨ HTTP æœåŠ¡å™¨å®ç°çš„ web æœåŠ¡ã€‚

`CreateDefaultBuilder` æ–¹æ³•ï¼š

- å°†å†…å®¹æ ¹ç›®å½•è®¾ç½®ä¸ºç”± GetCurrentDirectory è¿”å›çš„è·¯å¾„ã€‚
- é€šè¿‡ä»¥ä¸‹é¡¹åŠ è½½ä¸»æœºé…ç½®ï¼š
    - å‰ç¼€ä¸º DOTNET_ çš„ç¯å¢ƒå˜é‡ã€‚
    - å‘½ä»¤è¡Œå‚æ•°ã€‚
- é€šè¿‡ä»¥ä¸‹å¯¹è±¡åŠ è½½åº”ç”¨é…ç½®ï¼š
    - appsettings.json ã€‚
    - appsettings.{Environment}.json ã€‚
    - å¯†é’¥ç®¡ç†å™¨ å½“åº”ç”¨åœ¨ Development ç¯å¢ƒä¸­è¿è¡Œæ—¶ã€‚
    - ç¯å¢ƒå˜é‡ã€‚
    - å‘½ä»¤è¡Œå‚æ•°ã€‚
- æ·»åŠ ä»¥ä¸‹æ—¥å¿—è®°å½•æä¾›ç¨‹åºï¼š
    - æ§åˆ¶å°
    - è°ƒè¯•
    - EventSource
    - EventLogï¼ˆä»…å½“åœ¨ Windows ä¸Šè¿è¡Œæ—¶ï¼‰
- å½“ç¯å¢ƒä¸ºâ€œå¼€å‘â€æ—¶ï¼Œå¯ç”¨èŒƒå›´éªŒè¯å’Œä¾èµ–å…³ç³»éªŒè¯ã€‚

`ConfigureWebHostDefaults` æ–¹æ³•ï¼š

- ä»å‰ç¼€ä¸º ASPNETCORE_ çš„ç¯å¢ƒå˜é‡åŠ è½½ä¸»æœºé…ç½®ã€‚
- ä½¿ç”¨åº”ç”¨çš„æ‰˜ç®¡é…ç½®æä¾›ç¨‹åºå°† Kestrel æœåŠ¡å™¨è®¾ç½®ä¸º web æœåŠ¡å™¨å¹¶å¯¹å…¶è¿›è¡Œé…ç½®ã€‚ æœ‰å…³ Kestrel æœåŠ¡å™¨é»˜è®¤é€‰é¡¹ï¼Œè¯·å‚é˜… ASP.NET Core ä¸­çš„ Kestrel Web æœåŠ¡å™¨å®ç°ã€‚
- æ·»åŠ ä¸»æœºç­›é€‰ä¸­é—´ä»¶ã€‚
- å¦‚æœ ASPNETCORE_FORWARDEDHEADERS_ENABLED ç­‰äº trueï¼Œåˆ™æ·»åŠ è½¬æ¥å¤´ä¸­é—´ä»¶ã€‚
- æ”¯æŒ IIS é›†æˆã€‚ æœ‰å…³ IIS é»˜è®¤é€‰é¡¹ã€‚


åœ¨é»˜è®¤æ¨¡æ¿é…ç½® Program.csï¼Œæˆ–è€…ä» LaunchSettings.json è®¾ç½®ï¼š

    Host.CreateDefaultBuilder(args)
        .UseContentRoot("c:\\content-root")
        .UseEnvironment("Development")

        .UseShutdownTimeout(TimeSpan.FromSeconds(10))

        .ConfigureHostConfiguration(configHost =>
        {
            configHost.SetBasePath(Directory.GetCurrentDirectory());
            configHost.AddJsonFile("hostsettings.json", optional: true);
            configHost.AddEnvironmentVariables(prefix: "PREFIX_");
            configHost.AddCommandLine(args);
        });

    Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(webBuilder =>
        {
            webBuilder.UseStartup<Startup>()
                .ConfigureLogging(builder => builder.AddFile());
        });

    webBuilder.UseUrls("http://*:5000;http://localhost:5001;https://hostname:5002");
    webBuilder.UseWebRoot("public");
    webBuilder.UseStartup("StartupAssemblyName");
    webBuilder.UseStartup<Startup>();
    webBuilder.UseSetting("https_port", "8080");


## ==âš¡ Razor Page Basic
- [Razor Page Class](https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.mvc.razorpages.page?view=aspnetcore-3.1)
- [Razor PageModel Class](https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel?view=aspnetcore-3.1)
- [ASP.Net Core HttpContext Class](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpcontext?view=aspnetcore-3.1)
- [ASP.Net Core Controller Class](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.controller?view=aspnetcore-3.1)

æ¯ä¸ª Razor Page åŒ…å«è§†å›¾æ–‡ä»¶å’Œä»£ç æ–‡ä»¶ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ PageModel åŸºç±»ç”Ÿæˆ Razor Page é¡µé¢ã€‚ æŒ‰ç…§æƒ¯ä¾‹ï¼ŒPageModel ç±»æ–‡ä»¶çš„åç§°è¿½åŠ  .csï¼ŒåŸºæœ¬åä¸ Razor è§†å›¾é¡µé¢æ–‡ä»¶åç§°ç›¸åŒã€‚

Pages/Index.cshtml.cs é¡µé¢æ¨¡å‹ ï¼š

    using Microsoft.AspNetCore.Mvc.RazorPages;
    using Microsoft.Extensions.Logging;
    using System;

    namespace RazorPagesIntro.Pages
    {
        public class IndexModel : PageModel
        {
            public string Message { get; private set; } = "PageModel in C#";

            public void OnGet()
            {
                Message += $" Server time is { DateTime.Now }";
            }
        }
    }

Pages/Index.cshtml è§†å›¾æ–‡ä»¶ï¼š

    @page
    @using RazorPagesIntro.Pages
    @model IndexModel

    <h2>Separate page model</h2>
    <p>
        @Model.Message
    </p>

Razor Pages æ–‡ä»¶åæœ‰ .cshtml åç¼€ï¼Œå®ƒæœ€ç»ˆéƒ½ç»è¿‡ç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„ C# ç±»ï¼Œç»§æ‰¿ Microsoft.AspNetCore.Mvc.RazorPages.Pageï¼Œå¯ä»¥åœ¨ obj ç›®å½•ä¸‹æ£€æŸ¥ä¸ºè§†å›¾ç”Ÿæˆçš„ Razor C# ç±»ã€‚

Page å’Œ PageModel çš„å…³ç³»å°±åƒå…¶åå­—æš—ç¤ºé‚£æ ·ï¼Œåˆ†åˆ«å¯¹åº”äº† MVC æ¨¡å¼çš„ View å’Œ Modelã€‚è€Œ Page å¯¹è±¡è¦å¼•å¼•ç”¨ PageMode å°±é€šè¿‡ `@model IndexModel` æ¥æ³¨å…¥ï¼Œå®ƒä¼šç”Ÿæˆç›¸åº”çš„åˆå§‹åŒ–ä»£ç ï¼Œå…¶ä¸­æœ€æ˜äº†çš„å°±æ˜¯è¿™ä¸¤å¥ç±»å‹å£°æ˜ï¼Œè¿™ç§è¯­æ³•å¾ˆå¥‡æ€ªï¼Œä½†å®ƒä»¬éƒ½æ˜¯ç”¨æ¥å®šä¹‰åªè¯»å±æ€§çš„æ–¹å¼ï¼Œå³ä»…æä¾› get çš„å±æ€§ï¼š

    public global::Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary<IndexModel> ViewData => (global::Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary<IndexModel>)PageContext?.ViewData;
    public IndexModel Model => ViewData.Model;

æ‰€ä»¥å¯ä»¥æ³¨å…¥å…¶å®ƒå®šä¹‰å¥½çš„ PageModeï¼Œåœ¨è§†å›¾åé¢çš„ @Model.Message è®¿é—®å·²åŠ è½½çš„æ¨¡å‹ç±»å®ä¾‹æˆå‘˜ã€‚



å‰é¢çš„ä»£ç ä¸å…·æœ‰æ§åˆ¶å™¨å’Œè§†å›¾çš„ ASP.NET Core MVC åº”ç”¨ä¸­ä½¿ç”¨çš„ Razor è§†å›¾æ–‡ä»¶éå¸¸ç›¸ä¼¼ã€‚ ä¸åŒä¹‹å¤„åœ¨äº @page æŒ‡ä»¤ã€‚ @page ä½¿æ–‡ä»¶è½¬æ¢ä¸ºä¸€ä¸ª MVC æ“ä½œ ï¼Œè¿™æ„å‘³ç€å®ƒå°†ç›´æ¥å¤„ç†è¯·æ±‚ï¼Œè€Œæ— éœ€é€šè¿‡æ§åˆ¶å™¨å¤„ç†ã€‚ @page å¿…é¡»æ˜¯é¡µé¢ä¸Šçš„ç¬¬ä¸€ä¸ª Razor æŒ‡ä»¤, @page ä¼šå½±å“å…¶ä»– Razor æ„é€ çš„è¡Œä¸ºã€‚ 

Razor Component ç»„ä»¶æˆ– Razor Page å¯ä»¥é€šè¿‡å‘½ä»¤ç”Ÿæˆæ¨¡æ¿ï¼Œ-na ç»™ Razor Page æŒ‡å®šå‘½åç©ºé—´ï¼š

    dotnet new razorcomponent -o=. -n="View"
    dotnet new page -o=. -na="Razor.Pages" -n="Home"


Razor æ”¯æŒåœ¨ cshtml æ¨¡æ¿æ–‡ä»¶ä½¿ç”¨ @ ç¬¦å·æ¥ç¼–å†™ C# ä»£ç ã€‚ Razor ä¼šè´Ÿè´£è§£æ C# ä»£ç è¿˜æœ‰ Razor çš„åŠ©æ‰‹æ ‡ç­¾ï¼Œç”Ÿæˆå¯¹åº”çš„ HTML æ ‡ç­¾ã€‚å½“ @ ç¬¦å·åè·Ÿ Razor ä¿ç•™å…³é”®å­—æ—¶å¦‚ @ifï¼Œå®ƒä¼šè½¬æ¢ä¸º Razor ç‰¹å®šæ ‡è®°ï¼Œå¦åˆ™ä¼šè½¬æ¢ä¸ºçº¯ C#ã€‚è‹¥è¦å¯¹ Razor æ ‡è®°ä¸­çš„ @ ç¬¦å·è¿›è¡Œè½¬ä¹‰ï¼Œè¯·ä½¿ç”¨ @@ ç¬¦å·ã€‚


éšå¼ Razor è¡¨è¾¾å¼ä»¥ @ å¼€å¤´ï¼Œåè·Ÿ C# ä»£ç ï¼Œæ˜¾å¼ Razor è¡¨è¾¾å¼ç”± @ ç¬¦å·å’Œå¹³è¡¡åœ†æ‹¬å·ç»„æˆã€‚

    <p>@DateTime.Now</p>
    <p>@DateTime.IsLeapYear(2016)</p>
    <p>Last week this time: @(DateTime.Now - TimeSpan.FromDays(7))</p>

éšå¼è¡¨è¾¾å¼ä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œä½† C# await å…³é”®å­—é™¤å¤–ã€‚ å¦‚æœè¯¥ C# è¯­å¥å…·æœ‰æ˜ç¡®çš„ç»“æŸæ ‡è®°ï¼Œåˆ™å¯ä»¥æ··ç”¨ç©ºæ ¼ï¼š

    <p>@await DoSomething("hello", "world")</p>

éšå¼è¡¨è¾¾å¼ä¸èƒ½åŒ…å« C# æ³›å‹ï¼Œå› ä¸ºå°–æ‹¬å·å†…çš„å­—ç¬¦ä¼šè¢«è§£é‡Šä¸º HTML æ ‡è®°ã€‚ ä»¥ä¸‹æƒ³è¦ä½¿ç”¨æ³›å‹çš„ä»£ç æ— æ•ˆï¼š

    <p>@GenericMethod<int>()</p>

è®¡ç®—ç»“æœä¸ºå­—ç¬¦ä¸²çš„ C# è¡¨è¾¾å¼é‡‡ç”¨ HTML ç¼–ç ã€‚ è®¡ç®—ç»“æœä¸º IHtmlContent çš„ C# è¡¨è¾¾å¼ç›´æ¥é€šè¿‡ IHtmlContent.WriteTo å‘ˆç°ã€‚ è®¡ç®—ç»“æœä¸ä¸º IHtmlContent çš„ C# è¡¨è¾¾å¼é€šè¿‡ ToString è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨å‘ˆç°å‰è¿›è¡Œç¼–ç ã€‚

    @("<span>Hello World</span>")

è¯¥ä»£ç å‘ˆç°ä»¥ä¸‹ HTMLï¼š

    &lt;span&gt;Hello World&lt;/span&gt;

ä½¿ç”¨ HtmlHelper.Raw è¾“å‡ºä¸è¿›è¡Œç¼–ç ï¼Œä½†å‘ˆç°ä¸º HTML æ ‡è®°ã€‚å¯¹æœªç»å®¡æŸ¥çš„ç”¨æˆ·è¾“å…¥ä½¿ç”¨ HtmlHelper.Raw ä¼šå¸¦æ¥å®‰å…¨é£é™©ã€‚ ç”¨æˆ·è¾“å…¥å¯èƒ½åŒ…å«æ¶æ„çš„ JavaScript æˆ–å…¶ä»–æ”»å‡»ã€‚ 

    @Html.Raw("<span>Hello World</span>")

è¯¥ä»£ç å‘ˆç°ä»¥ä¸‹ HTMLï¼š

    <span>Hello World</span>

Razor ä»£ç å—ä»¥ @ å¼€å¤´ï¼Œå¹¶æ‹¬åœ¨ {} ä¸­ã€‚ ä»£ç å—å†…çš„ C# ä»£ç ä¸ä¼šå‘ˆç°ï¼Œè¿™ç‚¹ä¸è¡¨è¾¾å¼ä¸åŒã€‚ ä¸€ä¸ªè§†å›¾ä¸­çš„ä»£ç å—å’Œè¡¨è¾¾å¼å…±äº«ç›¸åŒçš„ä½œç”¨åŸŸå¹¶æŒ‰é¡ºåºè¿›è¡Œå®šä¹‰ã€‚ä»£ç å—ä¸­çš„é»˜è®¤è¯­è¨€ä¸º C#ï¼Œä¸è¿‡ï¼ŒRazor é¡µé¢å¯ä»¥éšå¼è½¬æ¢å› HTMLï¼š

    @{
        var inCSharp = true;
        <p>Now in HTML, was in C# @inCSharp</p>
    }

ç»†èŠ‚åœ¨ Razor æ¨¡æ¿æŒ‡ä»¤å‚è€ƒéƒ¨åˆ†ã€‚


Tag Helpers åŠ©æ‰‹æ ‡ç­¾å¾ˆåƒåŸç”Ÿçš„ HTML æ ‡ç­¾ï¼Œåªæ˜¯ Razor èµ‹äºˆåŠŸèƒ½åŒ–ï¼Œè·Ÿ ASP.Net Code MVC æ¡†æ¶ç»“åˆå¾—å¾ˆå¯†åˆ‡ã€‚

ä»¥é”šç‚¹æ ‡ç­¾ Anchor Tag Helper ä¸ºä¾‹ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹åŸºæœ¬çš„å±æ€§ï¼š

| å±æ€§    | è¯´æ˜    |
| :-----    | :-----    |
| asp-controller    | æ§åˆ¶å™¨çš„åç§°ï¼Œç”¨äºç”Ÿæˆ URL çš„æ§åˆ¶å™¨éƒ¨åˆ†ã€‚   |
| asp-action    | æ“ä½œæ–¹æ³•çš„åç§°ã€‚  |
| asp-area  | åŒºåŸŸåç§°ï¼Œç”¨äºç›®å½•åˆ†çº§ã€‚  |
| asp-page  | Razor Page çš„åç§°ã€‚   |
| asp-page-handler  | Razor Page å¤„ç†ç¨‹åºçš„åç§°ã€‚   |
| asp-route | æŒ‡å®šè·¯ç”±çš„åç§°ï¼Œç”¨äºåˆ›å»ºç›´æ¥é“¾æ¥åˆ°å‘½åè·¯ç”±çš„ URLã€‚   |
| asp-route-{value} | å•ä¸ª URL è·¯ç”±å€¼ã€‚ ä¾‹å¦‚ï¼Œasp-route-id="1234"ã€‚   |
| asp-all-route-data    | æ‰€æœ‰è·¯ç”±å€¼ã€‚æ”¯æŒåˆ›å»ºé”®å€¼å¯¹å­—å…¸ï¼Œ é”®æ˜¯å‚æ•°åç§°ï¼Œå€¼æ˜¯å‚æ•°å€¼ã€‚    |
| asp-fragment  | URL ç‰‡æ®µï¼Œå³åœ°å€ # å·åé¢çš„éƒ¨åˆ†ã€‚  |
| asp-protocol  | ç”¨äºåœ¨ URL ä¸­æŒ‡å®šåè®®ï¼ˆæ¯”å¦‚ httpsï¼‰ã€‚  |
| asp-host  | åœ¨ URL ä¸­æŒ‡å®šä¸»æœºåï¼Œå¦‚ asp-host="microsoft.com"ã€‚  |

é‚£ä¹ˆ HTML æ ‡ç­¾å†™æ³•çœ‹èµ·æ¥è·Ÿ Razor åŠ©æ‰‹æ ‡ç­¾æ˜¯ä¸€æ ·çš„ï¼Œé™¤äº†å±æ€§åŒºåˆ«ï¼š

    <a href="/Index.html">HTML TAG</a>

    <a asp-area="" asp-page="/form">Form</a>
    <a asp-area="" asp-controller="api" asp-action="hello" asp-route-id="1" asp-route-name="x">API</a>

asp-area ç”¨æ¥æŒ‡å®šåŒºåŸŸçº§çš„ Pages ç›®å½•ï¼Œæ¯”å¦‚æœ‰ä¸€å¥—é¡µé¢ï¼Œä½†éœ€è¦ä¸åŒçš„è¯­è¨€çš„å·®å¼‚åŒ–è¡¨è¾¾ï¼Œæ‡‚ä¹ˆå°±ä¼šåœ¨å¤šä¸ªä½œä¸ºè¯­è¨€ç®¡ç†çš„ç›®å½•ä¸‹æ”¾ç½® Pages é¡µé¢æ–‡ä»¶å¤¹ï¼Œè¿™æ—¶å°±å¯ä»¥é€šè¿‡ asp-area å±æ€§æ¥æŒ‡å®šé¡µé¢æ‰€åœ¨çš„åŒºåŸŸç›®å½•ã€‚

å¦å¤– controller å’Œ action æŒ‡å®šäº† MVC æ¡†æ¶ä¸­çš„æ§åˆ¶å™¨åŠå…¶å“åº”å¤„ç†çš„æ–¹æ³•ï¼Œåé¢ä¸¤ä¸ªå°±æ˜¯è·¯ç”±æ•°æ® asp-route-xxxã€‚asp-page å’Œ asp-page-handler æ˜¯å’Œæ§åˆ¶å™¨åŠ  action çš„æ–¹å¼ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯ä¸¤å¥—ä¸åŒçš„è·¯ç”±æ–¹å¼ï¼Œå®ƒä»¬æŒ‡å®šäº† Razor é¡µé¢å’Œå¤„ç†å‡½æ•°æ¥å“åº”è¿™ç§åŠ©æ‰‹æ ‡ç­¾ç”Ÿæˆçš„ URLã€‚

åŠ©æ‰‹æ ‡ç­¾ç”Ÿæˆçš„ HTML æ ‡ç­¾ï¼š

    <a url="/form">Form</a>
    <a href="/api/hello?id=1&name=x">API</a>

æ•°æ®å‚æ•°çš„å¤„ç†ç»†èŠ‚ï¼Œå‚è€ƒ ASP.NET Core åŠ©æ‰‹æ ‡ç­¾ Tag Helpersã€‚

HttpRequest.RouteValues è¿™ä¸ªå±æ€§ä¿å­˜çš„å°±æ˜¯å’Œè·¯ç”±æœ‰å…³çš„æ•°æ®ï¼ŒåŒ…æ‹¬åŠ©æ‰‹æ ‡ç­¾è®¾ç½®çš„ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š

- asp-area åŒºåŸŸç›®å½•
- asp-controller æ§åˆ¶å™¨
- asp-action åŠ¨ä½œ
- asp-page é¡µé¢
- asp-handler å¤„ç†å‡½æ•°

å‚è€ƒ MVC è·¯ç”±ã€‚

Razor é¡µé¢è·¯ç”±è‡ªå®šä¹‰è®¾ç½®çš„æ–¹å¼ï¼š

- ä½¿ç”¨é¡µé¢è·¯ç”±
- åº”ç”¨æ¨¡å‹æä¾›ç¨‹åºçº¦å®šæ¥æ§åˆ¶ Razor é¡µé¢åº”ç”¨ä¸­çš„é¡µé¢è·¯ç”±ã€å‘ç°å’Œå¤„ç†ã€‚
- éœ€è¦ä¸ºå„ä¸ªé¡µé¢é…ç½®è‡ªå®šä¹‰é¡µé¢è·¯ç”±æ—¶ï¼Œå¯ä½¿ç”¨ AddPageRoute çº¦å®šé…ç½®é¡µé¢è·¯ç”±ã€‚
- è‹¥è¦æŒ‡å®šé¡µé¢è·¯ç”±ã€æ·»åŠ è·¯ç”±æ®µæˆ–å‘è·¯ç”±æ·»åŠ å‚æ•°ï¼Œè¯·ä½¿ç”¨é¡µé¢çš„ @page æŒ‡ä»¤è‡ªå®šä¹‰è·¯ç”±ã€‚
- æœ‰äº›ä¿ç•™å­—ä¸èƒ½ç”¨ä½œè·¯ç”±æ®µæˆ–å‚æ•°åç§°ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…è·¯ç”±ï¼šä¿ç•™çš„è·¯ç”±åç§°ã€‚


ä½¿ç”¨ @page æŒ‡ä»¤è‡ªå®šä¹‰è·¯ç”±ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- æŒ‡å®šé¡µé¢çš„è‡ªå®šä¹‰è·¯ç”±ã€‚ ä¾‹å¦‚ @page "/Some/Other/Path"ã€‚
- å°†æ®µè¿½åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ã€‚ ä¾‹å¦‚ @page "item" å°† item æ®µæ·»åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ã€‚
- å°†å‚æ•°è¿½åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ã€‚ ä¾‹å¦‚ @page "{id}" é¡µé¢éœ€è¦ ID å‚æ•° idã€‚
- æ”¯æŒå¼€å¤´å¤„ä»¥æ³¢å½¢ç¬¦æŒ‡å®šçš„ç›¸å¯¹äºæ ¹ç›®å½•çš„è·¯å¾„ã€‚ ä¾‹å¦‚ï¼Œ`@page "~/Some/Other/Path"` å’Œ `@page "/Some/Other/Path"` ç›¸åŒã€‚

ä½¿ç”¨ asp-page æŒ‡å‘ Razor Page æ—¶ï¼Œç›´æ¥å¡«å†™ç›®å½•å³å¯ï¼ŒRazor ä¼šè‡ªåŠ¨æ‰¾åˆ° Index.cshtml é¡µé¢ã€‚ 

Razor Page æ¡†æ¶é€»è¾‘æ¯” MVC è¦æ›´æ¸…æ™°ï¼Œæ˜¯å› ä¸º Razor Page é€šè¿‡åœ¨åŠ©æ‰‹æ ‡ç­¾ä¸­ä½¿ç”¨ `asp-page-handler` æŒ‡å®šå¤„ç†å‡½æ•°ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨å¤šç§å¤„ç†å‡½æ•°æ¥å“åº”å¯¹åº”çš„è¡¨å•æäº¤åŠ¨ä½œæˆ–å“åº”é¡µé¢è¯·æ±‚ã€‚asp-page-handler æŒ‡å®šçš„å¤„ç†å‡½æ•°ä¼šé€šè¿‡ URL ä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸² `?handler=JoinList` å›ä¼ åˆ°æœåŠ¡å™¨ã€‚å¦‚æœä½ ä¸å–œæ¬¢è¿™ç§æ–¹å¼ï¼Œè¯·æ›´æ”¹è·¯ç”± `@page "{handler?}"`ï¼Œå°†å¤„ç†å‡½æ•°åç§°æ”¾åœ¨ URL çš„ PATH è·¯å¾„éƒ¨åˆ†ï¼Œåé¢çš„ ? è¡¨ç¤ºè·¯ç”±å‚æ•°ä¸ºå¯é€‰ï¼Œè¿™ç§è®¾ç½®å¯¹äºå‚æ•°ï¼Œæ¯”å¦‚ `{Name?}` æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚

    @page "{handler?}/{Name?}"
    @model FormModel
    @{
    }

    <html>
    <body>
        <div class="jumbotron bg-success text-white">
            <p> Enter your name: @Model.Name @Model.Age</p>
            <p> Model Class: @Model </p>
            <p asp-validation-summary="All"></p>
            <form method="POST">
                <p>Name: <input asp-for="Name" /></p>
                <p> Age: <input asp-for="Age" /></p>
                <input type="submit" asp-page-handler="JoinList" value="Join" />
                <input type="submit" asp-page-handler="JoinListUC" value="JOIN UC" />
            </form>
        </div>
    </body>
    </html>

Razor é¡µé¢çš„åŸºæœ¬å¤„ç†è¯·æ±‚çš„å‡½æ•°æ˜¯ On[Verb] æˆ– On[Verb]Async è¿™æ ·çš„æ ¼å¼å‘½åã€‚Verb å¯ä»¥å„ç§ HTTP è°“è¯ï¼Œæ¯”å¦‚å¸¸è§ Get/Post/Head/Option/Put/Delete ç­‰ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„ã€‚å¸¦ Async åç¼€çš„æ˜¯å®šä¹‰å¼‚æ­¥å¤„ç†å‡½æ•°æ—¶çš„ä¸€ç§çº¦å®šä¹ æƒ¯ï¼ŒåŒä¸€ä¸ªè°“è¯çš„æ–¹æ³•åªèƒ½ä½¿ç”¨æœ‰ Async åç¼€æˆ–æ²¡æœ‰åç¼€çš„å…¶ä¸­ä¸€ç§ï¼Œä¸èƒ½ä¸¤ç§åŒæ—¶å‡ºç°ã€‚

é¡µé¢ç‚¹å‡»ä¸¤ä¸ªæäº¤æŒ‰é’®å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼š

- OnPostJoinList å¯¹åº” URL ä¸º https://localhost:5001/form/JoinList
- OnPostJoinListUC å¯¹åº” URL ä¸º https://localhost:5001/form/JoinListUC

PageModel ç±»å‹ä»£ç å‚è€ƒå¦‚ä¸‹ï¼Œæ³¨æ„è¡¨å•ä½¿ç”¨ POST æ–¹æ³•æäº¤ã€‚å¦‚æœæ”¹ç”¨ GET æ–¹å¼ï¼Œå°±ä¼šæ‰§è¡Œ OnGetJoinList æˆ– OnGetJoinListUC æˆ–å¸¦ Async åç¼€çš„æ–¹æ³•ã€‚ä½†æ˜¯æ²¡æœ‰ç›¸åº”å®šä¹‰å°±ä¼šæ‰§è¡Œé»˜è®¤çš„ OnGet[Async] æ–¹æ³•ï¼Œæ²¡å…³ç³»ï¼Œä¹Ÿä¸ä¼šä»¥å‡ºé”™ï¼Œè€Œæ˜¯ç›´æ¥å¿½ç•¥ handler çš„å­˜åœ¨ã€‚ 

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components.Web;
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.RazorPages;
    using Microsoft.Extensions.Logging;

    public class MyModel {

        [BindProperty(SupportsGet = true)] 
        public string Name {get; set;} = "anonymous";

        [BindProperty] 
        public int Age {get; set;} = 18;

    }

    public class FormModel : PageModel
    {
        [BindProperty(SupportsGet = true)] 
        public string Name {get; set;} = "anonymous";

        [BindProperty]
        public int Age {get; set;} = 18;

        public void OnHead()
        {
            HttpContext.Response.Headers.Add("Head Test", "Handled by OnHead!");
        }

        public async Task<IActionResult> OnPostJoinListAsync()
        {
            Console.WriteLine($"OnPost JoinListAsync [IsValid: {ModelState.IsValid}]...");
            await Task.Delay(3000);

            if (ModelState.IsValid)
            {
                return RedirectToPage("/Home/Welcome");
            }
            return Page();
        }

        // public void OnPost()
        public void OnPostAsync()
        {
            HttpRequest req = HttpContext.Request;
            Console.WriteLine("OnPost [{0}|{1}|{2}] [Path: {3}] [QueryString: {4}]", 
                string.Join(",", req.RouteValues.Keys), req.Form["Age"], req.Query["Age"], req.Path, req.QueryString);
        }

        // public void OnGet()
        public void OnGetAsync()
        {
            HttpRequest req = HttpContext.Request;
            string testForm = req.HasFormContentType ? req.Form["Age"].ToString():"NO";
            Console.WriteLine("OnGet [{0}|{1}|{2}] [Path: {3}] [QueryString: {4}]", 
                string.Join(",", req.RouteValues.Keys), testForm, req.Query["Age"], req.Path, req.QueryString);
        }
    }


å’Œ MVC æ§åˆ¶å™¨ä¸­è¿”å› return View() çš„ä¸å†ï¼Œåœ¨ Razor ä¸­é»˜è®¤è¿”å› return Page()ï¼Œ Razor Page æ²¡æœ‰é‡è½½è¿™ä¸ªæ–¹æ³•ï¼Œç›¸æ¯” MVC æ§åˆ¶å™¨ï¼Œç¡®å®ç²¾ç®€å¤šäº†ã€‚ä½†æ˜¯åƒåˆ†éƒ¨è§†å›¾ã€è§†å›¾ç»„ä»¶è¿™äº›åŠŸéƒ½å…·å¤‡ï¼Œå‚è€ƒå¸ƒå±€ Layout å†…å®¹ï¼š

- Partial View é¡µé¢ç‰‡æ–­æ¸²æŸ“

    - Partial(String)   åˆ›å»º PartialViewResult æ¸²æŸ“åˆ†éƒ¨è§†å›¾ï¼›
    - Partial(String, Object)   åˆ›å»º PartialViewResult æ¸²æŸ“åˆ†éƒ¨è§†å›¾ï¼›

- View Comoponent è§†å›¾ç»„ä»¶æ¸²æŸ“

    - ViewComponent(String) åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶æ–‡ä»¶åæ¸²æŸ“ï¼›
    - ViewComponent(Type)   åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶ç±»å‹ï¼›
    - ViewComponent(String, Object) åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶æ–‡ä»¶ååŠå‚æ•°å¯¹è±¡ï¼›
    - ViewComponent(Type, Object)   åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶ç±»å‹å’Œå‚æ•°å¯¹è±¡ï¼›


## ==âš¡ Layout & UI Reuse é¡µé¢å¸ƒå±€ä¸é‡ç”¨
- [ASP.NET Core åç§æ–¹å¼æ‰©å±•ä½ çš„ Views](https://blog.51cto.com/zhanglida66/1921544)
- [View Components in ASP.â€‹NET 5](http://asp.net-hacker.rocks/2015/11/25/viewcomponents-aspnet5.html)
- [ä½¿ç”¨ Razor ç±»åº“é¡¹ç›®åˆ›å»ºå¯é‡ç”¨ UI](https://docs.microsoft.com/zh-cn/aspnet/core/razor-pages/ui-class?view=aspnetcore-3.1)
- [Partial View åˆ†éƒ¨è§†å›¾](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/partial?view=aspnetcore-3.1)
- [ASP.NET Core ä¸­çš„å¸ƒå±€](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/layout?view=aspnetcore-3.1)
- [ASP.NET Core MVC ä¸­çš„è§†å›¾](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/overview?view=aspnetcore-3.1)
- []()

ä»å¹³é¢è®¾è®¡ä¸Šæ¥è®²ï¼Œè§†å›¾çš„å¸ƒå±€å°±æ˜¯é¡µé¢çš„åŒºåŸŸåˆ’åˆ†è®¾è®¡ï¼Œæ¯”å¦‚é¡µé¢çš„èœå•æ ã€å†…å®¹ä¸»ä½“åŒºåŸŸç­‰ã€‚ä»ä»£ç å®ç°ä¸Šè®²ï¼Œå¸ƒå±€å°±æ˜¯é…åˆè®¾è®¡å®ç°çš„è§†å›¾é‡ç»„ã€‚å°†é¡µé¢ä¸åŒçš„åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„è§†å›¾æ–‡ä»¶ï¼Œå†é€šè¿‡é€»è¾‘é‡ç»„ç”Ÿæˆå®Œæ•´çš„é¡µé¢ï¼Œå‘ˆç°ç»™ç”¨æˆ·ã€‚

æ¯ä¸€ä¸ªè§†å›¾éƒ½æ˜¯ä½¿ç”¨ Layout å±æ€§æ¥æŒ‡å®šå®ƒçš„å¸ƒå±€ï¼Œå¦‚æœå¤šä¸ªè§†å›¾ä½¿ç”¨åŒä¸€ä¸ªå¸ƒå±€ï¼Œå°±ä¼šäº§ç”Ÿå†—ä½™ï¼Œå¹¶ä¸”å¾ˆéš¾ç»´æŠ¤ã€‚
ViewStart é¡µé¢å¯ç”¨æ¥æ¶ˆé™¤è¿™ç§å†—ä½™ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­çš„ä»£ç å…ˆäºåŒç›®å½•ä¸‹ä»»ä½•è§†å›¾ä»£ç çš„æ‰§è¡Œã€‚è¿™ä¸ªæ–‡ä»¶ä¹Ÿå¯ä»¥é€’å½’åœ°åº”ç”¨åˆ°ä»»ä½•è§†å›¾å­ç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡ä¸ªè§†å›¾éƒ½å¯ä»¥è®¾ç½®è‡ªå·±çš„ ViewImports & ViewStartã€‚

é¡¹ç›®æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„é¡µé¢å¯¹è±¡ ViewImports & ViewStartï¼Œåˆ†åˆ«ä½œä¸ºå¼•å…¥å‘½åç©ºé—´å’Œé¡µé¢èµ·ç‚¹ä½¿ç”¨ï¼Œåœ¨æ¸²æŸ“ä»»ä½•è§†å›¾æ—¶éƒ½ä¼šå…ˆè¡Œè½½å…¥ã€‚

é…ç½®å…¨å±€è§†å›¾å¯ä»¥åœ¨ `_ViewImports.cshtml` æ–‡ä»¶ä¸­ï¼Œæ¥é…ç½®ä½ å…¶ä»–è§†å›¾ä¸­ä½¿ç”¨çš„ä¸€äº›æ¯”è¾ƒå…¬ç”¨çš„ using å¼•ç”¨ï¼Œä¾èµ–æ³¨å…¥ç­‰ã€‚

MVC æˆ– Razor Page é¡¹ç›®æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„é¡µé¢å¯¹è±¡ MVC ViewImports & ViewStartï¼Œåˆ†åˆ«ä½œä¸ºå¼•å…¥å‘½åç©ºé—´å’Œé¡µé¢èµ·ç‚¹ä½¿ç”¨ï¼ŒMVC æ¡†æ¶åœ¨æ¸²æŸ“ä»»ä½•è§†å›¾æ—¶éƒ½ä¼šå…ˆè¡Œè½½å…¥ã€‚å¯¹äºä¸€ä¸ªè§†å›¾æ–‡ä»¶ï¼ŒåŒæ–‡ä»¶å¤¹ä¸‹çš„ `_ViewImports.cshtml` å’Œ `_ViewStart.cshtml` ä¼˜å…ˆäºä¸Šçº§ç›®å½•çš„åŠ è½½ã€‚åŒæ—¶ï¼ŒViewImports æ–‡ä»¶ä¸­çš„æ ‡ç­¾ä¸ä¼šè¢«è§£æè¾“å‡ºåˆ°é¡µé¢ã€‚

æ¯ä¸€ä¸ªè§†å›¾éƒ½æ˜¯ä½¿ç”¨ Layout å±æ€§æ¥æŒ‡å®šå®ƒçš„å¸ƒå±€ï¼Œå¦‚æœå¤šä¸ªè§†å›¾ä½¿ç”¨åŒä¸€ä¸ªå¸ƒå±€ï¼Œå°±ä¼šäº§ç”Ÿå†—ä½™ï¼Œå¹¶ä¸”å¾ˆéš¾ç»´æŠ¤ã€‚ ViewStart é¡µé¢å¯ç”¨æ¥æ¶ˆé™¤è¿™ç§å†—ä½™ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­çš„ä»£ç å…ˆäºåŒç›®å½•ä¸‹ä»»ä½•è§†å›¾ä»£ç çš„æ‰§è¡Œã€‚è¿™ä¸ªæ–‡ä»¶ä¹Ÿå¯ä»¥é€’å½’åœ°åº”ç”¨åˆ°ä»»ä½•è§†å›¾å­ç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡ä¸ªè§†å›¾éƒ½å¯ä»¥è®¾ç½®è‡ªå·±çš„ ViewImports & ViewStartã€‚

å› ä¸ºè¿™ä¸ªä»£ç å…ˆäºä»»ä½•è§†å›¾è¿è¡Œï¼Œæ‰€ä»¥ä¸€ä¸ªè§†å›¾å¯ä»¥é‡å†™ Layout å±æ€§çš„é»˜è®¤å€¼ï¼Œä»è€Œé‡æ–°é€‰æ‹©ä¸€ä¸ªä¸åŒçš„å¸ƒå±€ã€‚å¦‚æœä¸€ç»„è§†å›¾æ‹¥æœ‰å…±åŒçš„è®¾ç½®ï¼Œé‚£ä¹ˆ ViewStart æ–‡ä»¶å°±æœ‰äº†ç”¨æ­¦ä¹‹åœ°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨å®ƒé‡Œé¢å¯¹å…±åŒçš„è§†å›¾é…ç½®è¿›è¡Œç»Ÿä¸€è®¾ç½®ã€‚

æ³¨æ„ï¼Œè¦åœ¨å¸ƒå±€è§†å›¾ä¸­æ‰§è¡Œæ¸²æŸ“æ–¹æ³• @RenderBody()ï¼Œé€šå¸¸è¿˜ä¼šè®¿é—®è§†å›¾ä¸­è®¾ç½®çš„æ•°æ®é›† @ViewDataã€‚

å½“åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ ASP.NET é¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨ Views ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª `_ViewStart.cshtml` æ–‡ä»¶ï¼Œå®ƒæŒ‡å®šäº†ä¸€ä¸ªé»˜è®¤å¸ƒå±€ï¼Œä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ã€‚å±æ€§æ”¯æŒçœç•¥å†™æ³•ï¼Œä¼šè‡ªè¡Œåˆ° /Views/Shared ç›®å½•ä¸‹æŸ¥æ‰¾å¸ƒå±€é¡µï¼Œå¦‚æœåœ¨å½“å‰ç›®å½•ä¸‹æ²¡æœ‰ç›¸åº”çš„æ–‡ä»¶ï¼š

    @{
        Layout = "~/Views/Shared/_Layout.cshtml";
        Layout = "_Layout";
    }

åŠ è½½ä¸€ä¸ªè§†å›¾æ–‡ä»¶ï¼Œè‡³å°‘ä»¥ä¸‹ä¸‰ä¸ªç›®å½•ä¼šè¢«æœç´¢ï¼š

    - /Pages/_Layout.cshtml
    - /Pages/Shared/_Layout.cshtml
    - /Views/Shared/_Layout.cshtml

è¿™å’Œ ASP.NET MVC é¡¹ç›®çš„è§†å›¾åŠ è½½ä½ç½®æœ‰äº›å·®åˆ«ï¼š

    - /Views/controller/_Layout.cshtml
    - /Views/Shared/_Layout.cshtml
    - /Pages/Shared/_Layout.cshtml

ä¸€èˆ¬åœ¨ `_Layout.cshtml` æœ‰ä¸€ä¸ªæ–¹æ³•æ³•å« RenderBody()ï¼Œå®ƒå°±æ˜¯ç”¨æ¥æ¸²æŸ“è¯¦ç»†çš„è§†å›¾é¡µåˆ°æ¨¡æ¿å¸ƒå±€è§†å›¾ä¸­ï¼š

    @RenderBody()

åœ¨æ­¤æ–¹æ³•çš„ä½ç½®ï¼Œè¯¦æƒ…è§†å›¾å°±ä¼šè¢«æ¸²æŸ“åˆ°è¿™é‡Œã€‚


ä¾èµ–æ³¨å…¥ Dependency Injection è¿™ä¹Ÿæ˜¯ASP.NET Coreçš„æ–°ç‰¹æ€§ã€‚åœ¨æ‰©å±•ä½ çš„è§†å›¾çš„æ—¶å€™ï¼Œé€šè¿‡ @inject æŒ‡ä»¤ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§æ”¹è¿›ã€‚

å‡½æ•° @Functions æˆ– @code éƒ½å¯ä»¥åœ¨ä¸€ä¸ª ASP.NET MVC é¡¹ç›®ä¸­å®šä¹‰ä¸€äº›åŠŸèƒ½å‡½æ•°ï¼Œ@code ç”¨æ¥æ’å…¥ä»£ç å—æˆ–å®šä¹‰è§†å›¾ç±»çš„æˆå‘˜æ–¹æ³•ï¼š

    @functions
    {
        public string ReverseString(string input)
        {
            return String.Join("", input.Reverse());
        }
    }



### ===âœ’ Sections åŒºå—

æœ‰æ—¶å€™å­è§†å›¾ä¸­æƒ³åœ¨ä¸»è§†å›¾ä¸­æ˜¾ç¤ºä¸€éƒ¨åˆ† html ä»£ç ï¼Œæ¯”å¦‚ javascript ä»£ç æˆ–è€…æ˜¯ cssï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ Sectionsï¼Œ é€šå¸¸æƒ…å†µä¸‹åœ¨é¡µé¢çš„ç»“å°¾éƒ¨åˆ†ã€‚

åœ¨ä¸»è§†å›¾ä¸­ `_Layout.cshtml` å®šä¹‰ä¸€ä¸ª Javascripts Sectionï¼š

    @RenderSection("scripts", required: false)

æœ‰ä¸€ä¸ª required å‚æ•°æ¥å£°æ˜è¿™ä¸ª Section æ˜¯å¦å¿…é¡»çš„ï¼Œç„¶åä½ å°±å¯ä»¥åœ¨å­è§†å›¾ä¸­è¿™æ ·ä½¿ç”¨ï¼š

    @section scripts
    {
        <script>
            $(function() {
                // some more js code here;
            });
        </script>
    }

å¦‚æœä½ ä½¿ç”¨åµŒå¥—çš„å¸ƒå±€ï¼Œä½ å¯èƒ½éœ€è¦åµŒå¥—è¿™ä¸ªåŒºåŸŸã€‚æ„æ€å°±æ˜¯ä½ åœ¨Sectioné‡Œé¢åµŒå¥—è°ƒç”¨RenderSection():

    @section scripts
    {
        @RenderSection("scripts", required: false)
    }


### ===âœ’ Partial View å®šåˆ¶

Partial View é¡¾åæ€ä¹‰å°±æ˜¯ Html ä»£ç ç‰‡æ®µï¼Œå¯ä»¥ç”¨ Partial View æŠŠéƒ¨åˆ†çš„ HTML æˆ–æ˜¾ç¤ºé€»è¾‘åŒ…è£…èµ·æ¥ï¼Œæ–¹ä¾¿å¤ç”¨ã€‚

Partial View éœ€è¦æ”¾åœ¨ç‰¹å®šç›®å½•ä¸‹ï¼Œä»»ä½• Controlller ä¸‹çš„ Action æˆ– View éƒ½å¯ä»¥è½½å…¥ã€‚è¿è¡Œæ—¶å¯¹è§†å›¾æœç´¢è·¯å¾„å¦‚ä¸‹ï¼Œè§†å›¾ç»„ä»¶é»˜è®¤åç§°ä¸º Default.cshtmlï¼Œå¦‚æœæŒ‰åç§°ï¼ˆæ— æ–‡ä»¶æ‰©å±•åï¼‰å¼•ç”¨åˆ†éƒ¨è§†å›¾ï¼Œåˆ™æŒ‰æ‰€è¿°é¡ºåºæœç´¢ä»¥ä¸‹ä½ç½®ï¼š

- Razor Page é¡¹ç›®ï¼š

    - å½“å‰æ­£åœ¨æ‰§è¡Œé¡µé¢çš„æ–‡ä»¶å¤¹
    - è¯¥é¡µé¢æ–‡ä»¶å¤¹ä¸Šæ–¹çš„ç›®å½•å›¾
    - /Shared
    - /Pages/Shared
    - /Views/Shared

- MVC é¡¹ç›®ï¼š

    - /Areas/<Area-Name>/Views/<Controller-Name>
    - /Areas/<Area-Name>/Views/Shared
    - /Views/Shared
    - /Pages/Shared

å½“åˆ†éƒ¨è§†å›¾ä½äºä¸åŒçš„æ–‡ä»¶å¤¹ä¸­æ—¶ï¼Œå…è®¸ä½¿ç”¨å…·æœ‰ç›¸åŒæ–‡ä»¶åçš„ä¸åŒåˆ†éƒ¨è§†å›¾ã€‚

å½“æŒ‰åç§°ï¼ˆæ— æ–‡ä»¶æ‰©å±•åï¼‰å¼•ç”¨åˆ†éƒ¨è§†å›¾ä¸”åˆ†éƒ¨è§†å›¾å‡ºç°åœ¨è°ƒç”¨æ–¹æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸­æ—¶ï¼Œè°ƒç”¨æ–¹æ–‡ä»¶å¤¹ä¸­çš„åˆ†éƒ¨è§†å›¾ä¼šæä¾›åˆ†éƒ¨è§†å›¾ã€‚ å¦‚æœè°ƒç”¨æ–¹æ–‡ä»¶å¤¹ä¸­ä¸å­˜åœ¨åˆ†éƒ¨è§†å›¾ï¼Œåˆ™ä¼šä» Shared æ–‡ä»¶å¤¹ä¸­æä¾›å…±äº«åˆ†éƒ¨è§†å›¾æˆ–é»˜è®¤åˆ†éƒ¨è§†å›¾ã€‚

åˆ†éƒ¨è§†å›¾å¯ä»¥é“¾æ¥åˆ°åˆ†éƒ¨è§†å›¾ï¼Œå¦‚æœä¸æ˜¯ç”±è°ƒç”¨å½¢æˆå¾ªç¯å¼•ç”¨ï¼Œåˆ™å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªåˆ†éƒ¨è§†å›¾ã€‚ ç›¸å¯¹è·¯å¾„å§‹ç»ˆç›¸å¯¹äºå½“å‰æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äºæ–‡ä»¶çš„æ ¹è§†å›¾æˆ–çˆ¶è§†å›¾ã€‚

åˆ†éƒ¨åŠ©æ‰‹æ ‡ç­¾ä¼šå¼‚æ­¥å‘ˆç°å†…å®¹å¹¶ä½¿ç”¨ç±»ä¼¼ HTML çš„è¯­æ³•ï¼š

    <partial name="_PartialName" />
    <partial name="_PartialName.cshtml" />

å½“å­˜åœ¨æ–‡ä»¶æ‰©å±•åæ—¶ï¼ŒåŠ©æ‰‹æ ‡ç­¾ä¼šå¼•ç”¨åˆ†éƒ¨è§†å›¾ï¼Œè¯¥è§†å›¾å¿…é¡»ä¸è°ƒç”¨åˆ†éƒ¨è§†å›¾çš„æ ‡è®°æ–‡ä»¶ä½äºåŒä¸€æ–‡ä»¶å¤¹ä¸­ã€‚

ä»¥ä¸‹ç¤ºä¾‹ä»åº”ç”¨ç¨‹åºæ ¹ç›®å½•å¼•ç”¨åˆ†éƒ¨è§†å›¾ã€‚ ä»¥æ³¢å½¢ç¬¦æ–œæ æˆ–æ–œæ å¼€å¤´çš„è·¯å¾„æŒ‡ä»£åº”ç”¨ç¨‹åºæ ¹ç›®å½•ï¼ŒRazor Page æˆ– MVC ä¸­ä½¿ç”¨ï¼š

    <partial name="~/Views/Folder/_PartialName.cshtml" />
    <partial name="/Views/Folder/_PartialName.cshtml" />

ä»¥ä¸‹ç¤ºä¾‹å¼•ç”¨ä½¿ç”¨ç›¸å¯¹è·¯å¾„çš„åˆ†éƒ¨è§†å›¾ï¼š

    <partial name="../Account/_PartialName.cshtml" />


éœ€è¦ä»çˆ¶è§†å›¾ä¸­è·å–ç”¨æˆ·åˆ—è¡¨çš„æ•°æ®ï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨å®ƒçš„åœ°æ–¹ï¼Œé€šè¿‡ç›¸å…³æ–¹æ³•è¾“å‡ºï¼š

    @{ await Html.RenderPartialAsync("Users", Model.Users);}

å¦‚æœä½ çš„åˆ†éƒ¨è§†å›¾æ²¡æœ‰å®šä¹‰ç”¨æˆ·æ¨¡å‹ï¼Œä½ å°±ä¸éœ€è¦ä¼ ç¬¬äºŒä¸ªå‚æ•°ã€‚

    @Html.Partial("_Partial.cshtml", new ViewDataDictionary { { "VariableName", "some value" } })

    @{
        string valuePassedIn = this.ViewData.ContainsKey("VariableName") ? this.ViewData["VariableName"].ToString() : string.Empty;
    }

è¦å¼‚æ­¥ä½¿ç”¨ï¼Œæœ€ä½³åšæ³•æ˜¯ä½¿ç”¨ PartialAsync, è¿”å›åŒ…å«åœ¨ Task<TResult> ä¸­çš„ IHtmlContent ç±»å‹ã€‚ é€šè¿‡ @await å­—ç¬¦å‰ç¼€æ¥å¼•ç”¨è¯¥æ–¹æ³•ï¼š

    @await Html.PartialAsync("_PartialName")

å½“å­˜åœ¨æ–‡ä»¶æ‰©å±•åæ—¶ï¼ŒHTML å¸®åŠ©ç¨‹åºä¼šå¼•ç”¨åˆ†éƒ¨è§†å›¾ï¼Œè¯¥è§†å›¾å¿…é¡»ä¸è°ƒç”¨åˆ†éƒ¨è§†å›¾çš„æ ‡è®°æ–‡ä»¶ä½äºåŒä¸€æ–‡ä»¶å¤¹ä¸­ï¼š

    @await Html.PartialAsync("_PartialName.cshtml")



### ===âœ’ View Components è§†å›¾ç»„ä»¶

è§†å›¾ç»„ä»¶ ViewComponents æ˜¯ ASP.NET Core ä¸€ä¸ªç‰¹è‰²ï¼Œç±»ä¼¼äºä»¥å‰çš„ç”¨æˆ·æ§ä»¶ã€‚


æœ‰æ—¶å€™ä½ éœ€è¦åšä¸€äº›åˆ†éƒ¨è§†å›¾çš„äº‹æƒ…ï¼Œä½†æ˜¯åˆåŒ…å«ä¸€äº›ä¸šåŠ¡é€»è¾‘åœ¨é‡Œé¢ã€‚åœ¨è¿‡å»ï¼Œä½ å¯ä»¥ä½¿ç”¨ ChildAction æ¸²æŸ“ç»“æœåˆ°ä¸€ä¸ªè§†å›¾ä¸­ï¼Œä½†æ˜¯ï¼Œåœ¨ ASP.NET Core æ”¹è¿›äº†æ–°æ–¹å¼æ¥åšè¿™ä»¶äº‹æƒ…ã€‚å®ƒç±»ä¼¼äºåœ¨ MVC ä¸­çš„ä¸€ç§è¿·ä½ çš„ MVCï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬å¯ä»¥æœ‰è‡ªå·±çš„ Controllerï¼Œå’Œå•ä¸ªçš„ Action åŠ viewã€‚ViewComponents æ˜¯å®Œå…¨ç‹¬ç«‹äºä½ çš„å½“å‰è§†å›¾çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä½ å½“å‰çš„è§†å›¾ä¼ è¾“æ•°æ®ã€‚

    public class Top20TagsViewComponent : ViewComponent 
    { 
        private readonly ITagService _tagService; 

        public Top20TagsViewComponent(ITagService tagService) 
        { 
            _tagService = tagService; 
        } 

        public IViewComponentResult Invoke() 
        { 
             var tags = _tagService.LoadTop20Tags(); 
             var models = tags.Select( 
                new TagViewModel 
                { 
                    Id = tag.Id, 
                    Name = tag.Name 
                }); 
            return View(models); 
        } 
    }

ç•™æ„æ„é€ å‡½æ•°ä¸­çš„ TTagServiceï¼Œå®ƒä¼šç”±é»˜è®¤ IoC å®¹å™¨æ‰§è¡Œä¾èµ–æ³¨å…¥å¡«å……ï¼Œä¸ç”¨è‡ªå·±å»ç®¡ã€‚

ç„¶åï¼Œç»™è§†å›¾ç»„ä»¶ä¸€ä¸ªé…å¥—çš„æ¨¡æ¿æ–‡ä»¶ï¼Œä¿å­˜åœ¨ç‰¹å®šçš„ç›®å½•ä¸­ï¼š

    /Views/Shared/Components/
    /Shared/Components/Top20Tags/Default.cshtml

æ¨¡æ¿å†…å®¹å¦‚ä¸‹ï¼š

    @model IEnumerable<DotNetFn.ViewComponents.TagViewModel>

    @if (Model.Any()) 
    { 
        <ul> 
            @foreach (var tag in Tags) 
            { 
                <li> 
                    [@tag.Id] @tag.Name 
                </li> 
            } 
        </ul> 
    }

åœ¨å…¶å®ƒé¡µé¢ä¸­è°ƒç”¨å®ƒï¼Œæ¥æ¸²æŸ“ä¸€ä¸ª ViewComponents:

    @Component.Invoke("Top10Articles");

å¯ä»¥ç»™è§†å›¾ç»„ä»¶æ–‡ä»¶å¥½å¬çš„æ”¹åï¼Œè€Œä¸ä¸€å®šè¦ç”¨é»˜è®¤çš„åå­—ï¼Œå¯ä»¥åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨è§†å›¾æ–¹æ³•è°ƒç”¨ï¼Œè¿˜æœ‰ç»™ç»„ä»¶æ¨¡æ¿ä¼ é€æ•°æ®ï¼š

    return View("TheNicerName", models);


ç»„ä»¶ Invoke æ–¹æ³•è¿˜å¯ä»¥æ¥æ”¶å‚æ•°ï¼Œåœ¨ @Component.Invoke() è°ƒç”¨æ—¶ï¼Œå¸¦ä¸Šæ•°æ®å°±å¯ä»¥ï¼š

    public IViewComponentResult Invoke(int count)     
    { 
        var tags = _tagService.LoadTopTags().Take(count);     
        var models = tags.Select(tag => 
            new TagViewModel 
            { 
                Id = tag.Id, 
                Name = tag.Name 
            }); 
         return View(models); 
    } 

åƒè¿™æ ·è°ƒç”¨ï¼š

    @await Component.InvokeAsync("TopTags", 10);



### ===âœ’ Helpers åŠ©æ‰‹æ ‡ç­¾å®šåˆ¶


ä½¿ç”¨ HtmlHelpers å¯ä»¥åˆ›å»ºä½ è‡ªå·±çš„æ‰©å±•æ–¹æ³•æ¥æ‰©å±• Razor è¯­æ³•ï¼š

    public static class HtmlHelperExtensions
    {
        public static HtmlString MyOwnHtmlHelper(this HtmlHelper helper, string message)
        {
            return new HtmlString($"<span>{message}<span>");
        }
    }

åœ¨ä½ çš„è§†å›¾ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå¯é‡ç”¨çš„éƒ¨åˆ†æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå®ƒæ¯”åˆ†éƒ¨è§†å›¾å¤šåŒ…å«äº†ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚æ¯” HTMLHelpers æ‰©å±•æ›´å¥½çš„æ˜¯åŠ©æ‰‹æ ‡ç­¾ TagHelpersï¼Œä½†æ˜¯åœ¨æ‰©å±•ä½ è§†å›¾çš„æ—¶å€™ï¼ŒHTMLHelpers ä»ç„¶æœ‰å®ƒè‡ªå·±çš„ä¸€äº›é€‚ç”¨çš„åœ°æ–¹ã€‚


æ ‡ç­¾åŠ©æ‰‹ TagHelper è¿™æ˜¯ ASP.NET Core éå¸¸å¥½çš„ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚ç³»ç»Ÿè‡ªå¸¦çš„åŠ©æ‰‹æ ‡ç­¾åŸºæœ¬æ»¡è¶³å¤§é‡çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ˜¯å¯ä»¥æ‰©å±•è‡ªå·±å°åŠ©æ‰‹ï¼Œå®ƒçœ‹èµ·æ¥åƒä¸€ä¸ªåŸç”Ÿçš„HTMLæ ‡ç­¾ä¸€æ ·ã€‚ åœ¨ ASP.NET Core MV Cä¸­ä½ åº”è¯¥ä½¿ç”¨ TagHelpers æ¥æ›¿æ¢ HtmlHelpersï¼Œå› ä¸ºå®ƒä»¬æ›´åŠ çš„ç®€æ´å’Œå®¹æ˜“ä½¿ç”¨ã€‚å¦ä¸€ä¸ªå·¨å¤§çš„å¥½å¤„å°±æ˜¯ä¾èµ–æ³¨å…¥ï¼Œåœ¨ HtmlHelpers ä¸­æ˜¯ä½¿ç”¨ä¸äº†çš„ï¼Œå› ä¸º HtmlHelpers æ‰©å±•çš„éƒ½æ˜¯é™æ€å†…å®¹ã€‚ ä½† TagHelpers æ˜¯ä¸€ä¸ªå…¬å…±ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„åœ¨å®ƒçš„æ„é€ å‡½æ•°ä¸­æ³¨å…¥æœåŠ¡ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å°ç¤ºä¾‹ï¼Œæ¥å±•ç¤ºæ€ä¹ˆæ ·å®šä¹‰ä¸€ä¸ªTagHelperï¼š

    [TargetElement("hi")] 
    public class HelloTagHelper : TagHelper 
    { 
        public override void Process(TagHelperContext context, TagHelperOutput output) 
        { 
            output.TagName = "p"; 
            output.Attributes.Add("id", context.UniqueId); 

            output.PreContent.SetContent("Hello "); 
            output.PostContent.SetContent(string.Format(", time is now: {0}",  
                    DateTime.Now.ToString("HH:mm"))); 
        } 
    }

è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå«åš hi çš„æ ‡ç­¾ï¼Œå®ƒä»¥ HTML æ ‡è®°æ¥å‘ˆç°å½“å‰æ—¶é—´åˆ° p æ ‡ç­¾ï¼Œä½¿ç”¨å‚è€ƒ:

    <hi>John Smith</hi>

    <p>Hello John Smith, time is now: 18:55</p>

ASP.NET Core MVC å·²ç»é»˜è®¤æä¾›äº†å¾ˆå¤š TagHelpers æ¥æ›¿æ¢ä»¥å‰çš„ HtmlHelpersã€‚ä¾‹å¦‚ ActionLink å·²ç»è¢«æ–°çš„ TagHelper æ‰€æ›¿æ¢ï¼š

    @Html.ActionLink(â€œAbout meâ€, â€œAboutâ€, â€œHomeâ€)

æ–°çš„ TagHelper åƒè¿™æ ·æ¥åˆ›å»ºä¸€ä¸ª linkï¼š

    <a asp-controller=â€Homeâ€ asp-action=â€Aboutâ€>About me</a>

ä»¥ä¸Šä¸¤ç§æ–¹å¼æ¥åˆ›å»ºä¸€ä¸ªåŒæ ·çš„ a æ ‡ç­¾ï¼š

    <a href=â€/Home/Aboutâ€>About me</a>

å¯ä»¥çœ‹åˆ°ï¼ŒTagHelpers çœ‹èµ·æ¥æ›´åƒåŸç”Ÿçš„HTMLï¼Œä»–ä»¬åœ¨è§†å›¾ä¸­æ›´åŠ çš„ç›´è§‚ï¼Œæ›´é«˜çš„å¯è¯»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“ä½¿ç”¨ã€‚





## ==âš¡ Razor Page Filter é¡µé¢ç­›é€‰å™¨
-[Razor Page Filter é¡µé¢ç­›é€‰å™¨](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/filters?view=aspnetcore-3.1)

é€šè¿‡ä½¿ç”¨ ASP.NET Core ä¸­çš„ç­›é€‰å™¨ï¼Œå¯åœ¨è¯·æ±‚å¤„ç†ç®¡é“ä¸­çš„ç‰¹å®šé˜¶æ®µä¹‹å‰æˆ–ä¹‹åè¿è¡Œä»£ç ã€‚**
å†…ç½®ç­›é€‰å™¨å¤„ç†ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- æˆæƒï¼ˆé˜²æ­¢ç”¨æˆ·è®¿é—®æœªè·æˆæƒçš„èµ„æºï¼‰ã€‚
- å“åº”ç¼“å­˜ï¼ˆå¯¹è¯·æ±‚ç®¡é“è¿›è¡ŒçŸ­è·¯å‡ºè·¯ï¼Œä»¥ä¾¿è¿”å›ç¼“å­˜çš„å“åº”ï¼‰ã€‚

å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç­›é€‰å™¨ï¼Œç”¨äºå¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚ æ¨ªåˆ‡å…³æ³¨ç‚¹çš„ç¤ºä¾‹åŒ…æ‹¬é”™è¯¯å¤„ç†ã€ç¼“å­˜ã€é…ç½®ã€æˆæƒå’Œæ—¥å¿—è®°å½•ã€‚ ç­›é€‰å™¨å¯ä»¥é¿å…å¤åˆ¶ä»£ç ã€‚ ä¾‹å¦‚ï¼Œé”™è¯¯å¤„ç†å¼‚å¸¸ç­›é€‰å™¨å¯ä»¥åˆå¹¶é”™è¯¯å¤„ç†ã€‚

æœ¬æ–‡æ¡£é€‚ç”¨äº Razor Pagesã€API æ§åˆ¶å™¨å’Œå…·æœ‰è§†å›¾çš„æ§åˆ¶å™¨ã€‚ ç­›é€‰å™¨æ— æ³•ç›´æ¥ä¸ Razor ç»„ä»¶ä¸€èµ·ä½¿ç”¨ã€‚ ç­›é€‰å™¨åªèƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸‹é—´æ¥å½±å“ç»„ä»¶ï¼š

- è¯¥ç»„ä»¶åµŒå…¥åœ¨é¡µé¢æˆ–è§†å›¾ä¸­ã€‚
- é¡µé¢æˆ–æ§åˆ¶å™¨/è§†å›¾ä½¿ç”¨æ­¤ç­›é€‰å™¨ã€‚

æ¯ç§ç­›é€‰å™¨ç±»å‹éƒ½åœ¨ç­›é€‰å™¨ç®¡é“ä¸­çš„ä¸åŒé˜¶æ®µæ‰§è¡Œï¼š

- Authorization filters 

    æˆæƒç­›é€‰å™¨æœ€å…ˆè¿è¡Œï¼Œç”¨äºç¡®å®šæ˜¯å¦å·²é’ˆå¯¹è¯·æ±‚ä¸ºç”¨æˆ·æˆæƒã€‚ å¦‚æœè¯·æ±‚æœªè·æˆæƒï¼Œæˆæƒç­›é€‰å™¨å¯ä»¥è®©ç®¡é“çŸ­è·¯ã€‚

- Resource filters 

    èµ„æºç­›é€‰å™¨ï¼š

    - æˆæƒåè¿è¡Œã€‚
    - OnResourceExecuting åœ¨ç­›é€‰å™¨ç®¡é“çš„å…¶ä½™é˜¶æ®µä¹‹å‰è¿è¡Œä»£ç ã€‚ ä¾‹å¦‚ï¼ŒOnResourceExecuting åœ¨æ¨¡å‹ç»‘å®šä¹‹å‰è¿è¡Œä»£ç ã€‚
    - OnResourceExecuted åœ¨ç®¡é“çš„å…¶ä½™é˜¶æ®µå®Œæˆä¹‹åè¿è¡Œä»£ç ã€‚

- Action filters 

    æ“ä½œç­›é€‰å™¨ï¼š

    - åœ¨è°ƒç”¨æ“ä½œæ–¹æ³•ä¹‹å‰å’Œä¹‹åç«‹å³è¿è¡Œä»£ç ã€‚
    - å¯ä»¥æ›´æ”¹ä¼ é€’åˆ°æ“ä½œä¸­çš„å‚æ•°ã€‚
    - å¯ä»¥æ›´æ”¹ä»æ“ä½œè¿”å›çš„ç»“æœã€‚
    - ä¸å¯åœ¨ Razor Pages ä¸­ä½¿ç”¨ã€‚

- Exception filters 

    å¼‚å¸¸ç­›é€‰å™¨åœ¨å‘å“åº”æ­£æ–‡å†™å…¥ä»»ä½•å†…å®¹ä¹‹å‰ï¼Œå¯¹æœªç»å¤„ç†çš„å¼‚å¸¸åº”ç”¨å…¨å±€ç­–ç•¥ã€‚

- Result filters 

    ç»“æœç­›é€‰å™¨åœ¨æ‰§è¡Œæ“ä½œç»“æœä¹‹å‰å’Œä¹‹åç«‹å³è¿è¡Œä»£ç ã€‚ ä»…å½“æ“ä½œæ–¹æ³•æˆåŠŸæ‰§è¡Œæ—¶ï¼Œå®ƒä»¬æ‰ä¼šè¿è¡Œã€‚ å¯¹äºå¿…é¡»å›´ç»•è§†å›¾æˆ–æ ¼å¼åŒ–ç¨‹åºçš„æ‰§è¡Œçš„é€»è¾‘ï¼Œå®ƒä»¬å¾ˆæœ‰ç”¨ã€‚

Razor é¡µé¢ç­›é€‰å™¨ IPageFilter å’Œ IAsyncPageFilter å…è®¸ Razor Pages åœ¨è¿è¡Œ Razor é¡µé¢å¤„ç†ç¨‹åºçš„å‰åè¿è¡Œä»£ç ã€‚ Razor é¡µé¢ç­›é€‰å™¨ä¸ ASP.NET Core MVC æ“ä½œç­›é€‰å™¨ç±»ä¼¼ï¼Œä½†å®ƒä»¬ä¸èƒ½åº”ç”¨äºå•ä¸ªé¡µé¢å¤„ç†ç¨‹åºæ–¹æ³•ã€‚

Razor é¡µé¢ç­›é€‰å™¨ï¼š

- åœ¨é€‰æ‹©å¤„ç†ç¨‹åºæ–¹æ³•åä½†åœ¨æ¨¡å‹ç»‘å®šå‘ç”Ÿå‰è¿è¡Œä»£ç ã€‚
- åœ¨æ¨¡å‹ç»‘å®šå®Œæˆåï¼Œæ‰§è¡Œå¤„ç†ç¨‹åºæ–¹æ³•å‰è¿è¡Œä»£ç ã€‚
- åœ¨æ‰§è¡Œå¤„ç†ç¨‹åºæ–¹æ³•åè¿è¡Œä»£ç ã€‚
- å¯åœ¨é¡µé¢æˆ–å…¨å±€èŒƒå›´å†…å®ç°ã€‚
- æ— æ³•åº”ç”¨äºç‰¹å®šçš„é¡µé¢å¤„ç†ç¨‹åºæ–¹æ³•ã€‚
- å¯ä»¥ç”¨ä¾èµ–é¡¹æ³¨å…¥ (DI) å¡«å……æ„é€ å‡½æ•°ä¾èµ–é¡¹ã€‚ è¯·å‚é˜… ServiceFilterAttribute å’Œ TypeFilterAttributeã€‚

è™½ç„¶é¡µæ„é€ å‡½æ•°å’Œä¸­é—´ä»¶å…è®¸åœ¨å¤„ç†ç¨‹åºæ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œè‡ªå®šä¹‰ä»£ç ï¼Œä½†åªæœ‰ Razor é¡µé¢ç­›é€‰å™¨å…è®¸è®¿é—® HttpContext å’Œé¡µé¢ã€‚ ä¸­é—´ä»¶å¯ä»¥è®¿é—® HttpContextï¼Œä½†ä¸èƒ½è®¿é—®â€œé¡µé¢ä¸Šä¸‹æ–‡â€ã€‚ ç­›é€‰å™¨å…·æœ‰ FilterContext æ´¾ç”Ÿå‚æ•°ï¼Œè¯¥å‚æ•°æä¾›å¯¹ HttpContext çš„è®¿é—®æƒé™ã€‚

Razor é¡µé¢ç­›é€‰å™¨æä¾›çš„åŒæ­¥æ–¹æ³•/å¼‚æ­¥æ–¹æ³•å¯åœ¨å…¨å±€æˆ–é¡µé¢çº§åº”ç”¨ï¼š

åŒæ­¥æ–¹æ³•ï¼š

- OnPageHandlerSelected åœ¨é€‰æ‹©å¤„ç†ç¨‹åºæ–¹æ³•åï¼Œä½†åœ¨æ¨¡å‹ç»‘å®šå‘ç”Ÿä¹‹å‰è°ƒç”¨ã€‚
- OnPageHandlerExecuting    åœ¨æ¨¡å‹ç»‘å®šå®Œæˆåï¼Œæ‰§è¡Œå¤„ç†ç¨‹åºæ–¹æ³•ä¹‹å‰è°ƒç”¨ã€‚
- OnPageHandlerExecuted åœ¨æ‰§è¡Œå¤„ç†å™¨æ–¹æ³•åï¼Œç”Ÿæˆæ“ä½œç»“æœå‰è°ƒç”¨ã€‚

å¼‚æ­¥æ–¹æ³•ï¼š

- OnPageHandlerSelectionAsync   åœ¨é€‰æ‹©å¤„ç†ç¨‹åºæ–¹æ³•åï¼Œä½†åœ¨æ¨¡å‹ç»‘å®šå‘ç”Ÿå‰ï¼Œè¿›è¡Œå¼‚æ­¥è°ƒç”¨ã€‚
- OnPageHandlerExecutionAsync   åœ¨è°ƒç”¨å¤„ç†ç¨‹åºæ–¹æ³•å‰ï¼Œä½†åœ¨æ¨¡å‹ç»‘å®šç»“æŸåï¼Œè¿›è¡Œå¼‚æ­¥è°ƒç”¨ã€‚

ç­›é€‰å™¨æ¥å£çš„åŒæ­¥å’Œå¼‚æ­¥ç‰ˆæœ¬ä»»æ„å®ç°ä¸€ä¸ªï¼Œè€Œä¸æ˜¯åŒæ—¶å®ç° ã€‚ è¯¥æ¡†æ¶ä¼šå…ˆæŸ¥çœ‹ç­›é€‰å™¨æ˜¯å¦å®ç°äº†å¼‚æ­¥æ¥å£ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨è¯¥æ¥å£ã€‚ å¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨åŒæ­¥æ¥å£çš„æ–¹æ³•ã€‚ å¦‚æœä¸¤ä¸ªæ¥å£éƒ½å·²å®ç°ï¼Œåˆ™åªä¼šè°ƒç”¨å¼‚æ­¥æ–¹æ³•ã€‚ å¯¹é¡µé¢ä¸­çš„æ›¿ä»£åº”ç”¨ç›¸åŒçš„è§„åˆ™ï¼ŒåŒæ­¥æ›¿ä»£æˆ–å¼‚æ­¥æ›¿ä»£åªèƒ½ä»»é€‰å…¶ä¸€å®ç°ï¼Œä¸å¯äºŒè€…çš†é€‰ã€‚


å…¨å±€å®ç° Razor é¡µé¢ç­›é€‰å™¨ IAsyncPageFilterï¼š


    public class SampleAsyncPageFilter : IAsyncPageFilter
    {
        private readonly IConfiguration _config;

        public SampleAsyncPageFilter(IConfiguration config)
        {
            _config = config;
        }

        public Task OnPageHandlerSelectionAsync(PageHandlerSelectedContext context)
        {
            var key = _config["UserAgentID"];
            context.HttpContext.Request.Headers.TryGetValue("user-agent",
                                                            out StringValues value);
            ProcessUserAgent.Write(context.ActionDescriptor.DisplayName,
                                   "SampleAsyncPageFilter.OnPageHandlerSelectionAsync",
                                   value, key.ToString());

            return Task.CompletedTask;
        }

        public async Task OnPageHandlerExecutionAsync(PageHandlerExecutingContext context,
                                                      PageHandlerExecutionDelegate next)
        {
            // Do post work.
            await next.Invoke();
        }
    }

åœ¨å‰é¢çš„ä»£ç ä¸­ï¼ŒProcessUserAgent.Write æ˜¯ç”¨æˆ·æä¾›çš„ä¸ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ä¸€èµ·ä½¿ç”¨çš„ä»£ç ã€‚

ä»¥ä¸‹ä»£ç å¯ç”¨ Startup ç±»ä¸­çš„ SampleAsyncPageFilterï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages()
            .AddMvcOptions(options =>
            {
                options.Filters.Add(new SampleAsyncPageFilter(Configuration));
            });
    }

ä»¥ä¸‹ä»£ç è°ƒç”¨ AddFolderApplicationModelConventionï¼Œå°† SampleAsyncPageFilter ä»…åº”ç”¨äº /Movies ä¸­çš„é¡µé¢ ï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages(options =>
        {
            options.Conventions.AddFolderApplicationModelConvention(
                "/Movies",
                model => model.Filters.Add(new SampleAsyncPageFilter(Configuration)));
        });
    }

ä»¥ä¸‹ä»£ç å®ç°åŒæ­¥çš„ IPageFilterï¼š

    public class SamplePageFilter : IPageFilter
    {
        private readonly IConfiguration _config;

        public SamplePageFilter(IConfiguration config)
        {
            _config = config;
        }

        public void OnPageHandlerSelected(PageHandlerSelectedContext context)
        {
            var key = _config["UserAgentID"];
            context.HttpContext.Request.Headers.TryGetValue("user-agent", out StringValues value);
            ProcessUserAgent.Write(context.ActionDescriptor.DisplayName,
                                   "SamplePageFilter.OnPageHandlerSelected",
                                   value, key.ToString());
        }

        public void OnPageHandlerExecuting(PageHandlerExecutingContext context)
        {
            Debug.WriteLine("Global sync OnPageHandlerExecuting called.");
        }

        public void OnPageHandlerExecuted(PageHandlerExecutedContext context)
        {
            Debug.WriteLine("Global sync OnPageHandlerExecuted called.");
        }
    }

ä»¥ä¸‹ä»£ç å¯ç”¨ SamplePageFilterï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages()
            .AddMvcOptions(options =>
            {
                options.Filters.Add(new SamplePageFilter(Configuration));
            });
    }


é€šè¿‡é‡å†™ç­›é€‰å™¨æ–¹æ³•å®ç° Razor é¡µé¢ç­›é€‰å™¨ï¼Œå‚è€ƒä»¥ä¸‹ä»£ç æ›¿ä»£å¼‚æ­¥ Razor é¡µé¢ç­›é€‰å™¨ï¼š

    public class IndexModel : PageModel
    {
        private readonly IConfiguration _config;

        public IndexModel(IConfiguration config)
        {
            _config = config;
        }

        public override Task OnPageHandlerSelectionAsync(PageHandlerSelectedContext context)
        {
            Debug.WriteLine("/IndexModel OnPageHandlerSelectionAsync");
            return Task.CompletedTask;
        }

        public async override Task OnPageHandlerExecutionAsync(PageHandlerExecutingContext context, 
                                                               PageHandlerExecutionDelegate next)
        {
            var key = _config["UserAgentID"];
            context.HttpContext.Request.Headers.TryGetValue("user-agent", out StringValues value);
            ProcessUserAgent.Write(context.ActionDescriptor.DisplayName,
                                   "/IndexModel-OnPageHandlerExecutionAsync",
                                    value, key.ToString());

            await next.Invoke();
        }
    }


å®ç°ç­›é€‰å™¨å±æ€§
åŸºäºå±æ€§çš„å†…ç½®ç­›é€‰å™¨ OnResultExecutionAsync å¯ä»¥è¿›è¡Œå­ç±»åŒ–ã€‚ ä»¥ä¸‹ç­›é€‰å™¨å‘å“åº”æ·»åŠ æ ‡å¤´ï¼š

    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc.Filters;

    namespace PageFilter.Filters
    {
        public class AddHeaderAttribute  : ResultFilterAttribute
        {
            private readonly string _name;
            private readonly string _value;

            public AddHeaderAttribute (string name, string value)
            {
                _name = name;
                _value = value;
            }

            public override void OnResultExecuting(ResultExecutingContext context)
            {
                context.HttpContext.Response.Headers.Add(_name, new string[] { _value });
            }
        }
    }

ä»¥ä¸‹ä»£ç åº”ç”¨ AddHeader å±æ€§ï¼š

    using Microsoft.AspNetCore.Mvc.RazorPages;
    using PageFilter.Filters;

    namespace PageFilter.Movies
    {
        [AddHeader("Author", "Rick")]
        public class TestModel : PageModel
        {
            public void OnGet()
            {

            }
        }
    }

ä½¿ç”¨æµè§ˆå™¨å¼€å‘äººå‘˜å·¥å…·ç­‰å·¥å…·æ¥æ£€æŸ¥æ ‡å¤´ã€‚ åœ¨å“åº”æ ‡å¤´ä¸‹ï¼Œå°†æ˜¾ç¤º author: Rick ã€‚æœ‰å…³å°†ç­›é€‰å™¨ç®¡é“ä¸ç­›é€‰å™¨çŸ­è·¯çš„è¯´æ˜ï¼Œè¯·å‚é˜…å–æ¶ˆå’Œè®¾ç½®çŸ­è·¯ã€‚


æˆæƒç­›é€‰å™¨å±æ€§ [Authorize] å¯åº”ç”¨äº PageModelï¼Œå¯ä»¥è®¾ç½® string policy å‚æ•°ï¼š

    using Microsoft.AspNetCore.Authorization;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.RazorPages;

    namespace PageFilter.Pages
    {
        [Authorize]
        public class ModelWithAuthFilterModel : PageModel
        {
            public IActionResult OnGet() => Page();
        }
    }




## ==âš¡ Razor Form æ•°æ®ç»‘å®šç‰¹æ€§
- [Razor Page ä»‹ç»](https://docs.microsoft.com/zh-cn/aspnet/core/razor-pages/?view=aspnetcore-3.1)
- [ASP.NET Core ä¸­çš„ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/app-state?view=aspnetcore-3.1#tempdata)

å†æ¥çœ‹çœ‹ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ä¸€ç‚¹çš„è¡¨å•é¡µé¢ï¼š



é€è¿‡ PageModel æš´éœ²çš„ ViewData å’Œ TempData ä¸¤ä¸ªå­—å…¸å±æ€§ï¼Œç»“åˆ ViewDataAttribute å’Œ TempDataAttribute å±æ€§ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†å‰ç«¯é¡µé¢è¡¨å•å›ä¼ çš„æ•°æ®ç»‘å®šåˆ° PageModel çš„å±æ€§ä¸­ã€‚


é€è¿‡ ViewData ç‰¹æ€§ç»“åˆ ViewDataAttribute å±æ€§ç‰¹æ€§å°†æ•°æ®ä¼ é€’åˆ°é¡µé¢ï¼ŒPageModel ä¸­å…·æœ‰ `[ViewData]` ç‰¹æ€§çš„å±æ€§å°†ä» ViewDataDictionary ä¿å­˜å’ŒåŠ è½½æ•°æ®ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒAboutModel å°† [ViewData] ç‰¹æ€§åº”ç”¨äº Title å±æ€§ï¼š

    public class AboutModel : PageModel
    {
        [ViewData]
        public string Title { get; } = "About";

        public void OnGet()
        {
        }
    }

åœ¨é¡µé¢ä¸­ï¼Œä»¥æ¨¡å‹å±æ€§çš„å½¢å¼è®¿é—® Title å±æ€§ï¼š

    <h1>@Model.Title</h1>

åœ¨å¸ƒå±€ä¸­ï¼Œä» ViewData å­—å…¸è¯»å–æ ‡é¢˜ï¼š

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <title>@ViewData["Title"] - WebApplication</title>
        ...

ASP.NET Core å…¬å¼€ Razor Pages TempData æˆ–æ§åˆ¶å™¨ TempDataã€‚ åœ¨å¦ä¸€ä¸ªè¯·æ±‚è¯»å–æ•°æ®ä¹‹å‰ï¼Œæ­¤å±æ€§å°†è¯»å–æ­¤æ•°æ®ã€‚ Keep(String) å’Œ Peek(string) æ–¹æ³•å¯ç”¨äºæ£€æŸ¥æ•°æ®ï¼Œè€Œæ— éœ€åœ¨è¯·æ±‚ç»“æŸæ—¶åˆ é™¤ã€‚ Keep å°†æ ‡è®°å­—å…¸ä¸­çš„æ‰€æœ‰é¡¹ä»¥è¿›è¡Œä¿ç•™ã€‚

ä¸‹é¢çš„ä»£ç ä½¿ç”¨ TempData è®¾ç½® Message çš„å€¼ï¼š

    public class CreateDotModel : PageModel
    {
        private readonly AppDbContext _db;

        public CreateDotModel(AppDbContext db)
        {
            _db = db;
        }

        [TempData]
        public string Message { get; set; }

        [BindProperty]
        public Customer Customer { get; set; }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            _db.Customers.Add(Customer);
            await _db.SaveChangesAsync();
            Message = $"Customer {Customer.Name} added";
            return RedirectToPage("./Index");
        }
    }

Index.cshtml æ–‡ä»¶ä¸­çš„ä»¥ä¸‹æ ‡è®°ä½¿ç”¨ TempData æ˜¾ç¤º Message çš„å€¼ã€‚

    <h3>Msg: @Model.Message</h3>

Index.cshtml.cs é¡µé¢æ¨¡å‹å°† [TempData] å±æ€§åº”ç”¨åˆ° Message å±æ€§ ã€‚
    
    [TempData]
    public string Message { get; set; }


åŸºäº cookie çš„ TempData æä¾›ç¨‹åº CookieTempDataProvider æ˜¯é»˜è®¤ç”¨äºå­˜å‚¨ cookie ä¸­çš„ TempDataã€‚
ä½¿ç”¨ç”± Base64UrlTextEncoder ç¼–ç çš„ IDataProtector å¯¹ Cookie æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œç„¶åè¿›è¡Œåˆ†å—ã€‚ ç”±äºåŠ å¯†å’Œåˆ†å—ï¼Œæœ€å¤§ Cookie å¤§å°å°äº 4096 ä¸ªå­—èŠ‚ã€‚ æœªå‹ç¼© Cookie æ•°æ®ï¼Œå› ä¸ºå‹ç¼©åŠ å¯†çš„æ•°æ®ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜ï¼Œå¦‚ CRIME å’Œ BREACH æ”»å‡»ã€‚ 

å¤§å¤šæ•° Web å®¢æˆ·ç«¯ï¼ˆå¦‚ Web æµè§ˆå™¨ï¼‰é’ˆå¯¹æ¯ä¸ª Cookie çš„æœ€å¤§å¤§å°å’Œ Cookie æ€»æ•°å¼ºåˆ¶å®æ–½é™åˆ¶ã€‚ ä½¿ç”¨ Cookie TempData æä¾›ç¨‹åºæ—¶ï¼Œè¯·éªŒè¯åº”ç”¨æœªè¶…è¿‡è¿™äº›é™åˆ¶ã€‚ è€ƒè™‘æ•°æ®çš„æ€»å¤§å°ã€‚ è§£é‡ŠåŠ å¯†å’Œåˆ†å—å¯¼è‡´çš„ Cookie å¤§å°å¢åŠ ã€‚

é»˜è®¤æƒ…å†µä¸‹å¯ç”¨åŸºäº Cookie çš„ TempData æä¾›ç¨‹åºã€‚ è‹¥è¦å¯ç”¨åŸºäºä¼šè¯çš„ TempData æä¾›ç¨‹åºï¼Œè¯·é…ç½® Startup ä½¿ç”¨ç›¸åº”æ‰©å±•æ–¹æ³•ï¼Œè°ƒç”¨ AddSessionStateTempDataProviderï¼š

    services.AddControllersWithViews()
        .AddSessionStateTempDataProvider();
    services.AddRazorPages()
        .AddSessionStateTempDataProvider();

    app.UseSession();





## ==âš¡ Logging æ—¥å¿—

é»˜è®¤æä¾›æ—¥å¿—æœåŠ¡ï¼Œè®°å½• Information çº§åˆ«æ¶ˆæ¯ï¼Œåœ¨ Windows ç³»ç»Ÿçš„åº”ç”¨ç¨‹åºæ—¥å¿—ä¸Šå¯ä»¥æŸ¥çœ‹ã€‚

Trace -> Debug->  Information -> Warning->  Error->  Critical

æ—¥å¿—ç»„ä»¶æ‹“å±•

- æ–‡ä»¶æ–‡æœ¬æ—¥å¿— Huanent.Logging.File
- æ–‡ä»¶æ–‡æœ¬æ—¥å¿— UI æ’ä»¶ Huanent.Logging.File.UI
- è‡ªå®šä¹‰ä»‹è´¨æ—¥å¿— Huanent.Logging.Abstract

Microsoft.Extensions.Logging.File æ–‡ä»¶æ–‡æœ¬æ—¥å¿—åŸºç¡€ç±»
Microsoft.Extensions.Logging.File.UI æ–‡ä»¶æ–‡æœ¬æ—¥å¿— UI æ’ä»¶åŸºç¡€ç±»
Microsoft.Extensions.Logging.Abstract è‡ªå®šä¹‰ä»‹è´¨æ—¥å¿—


æŒ‰éœ€è¦å®‰è£…æ—¥å¿—æœåŠ¡åŒ…ï¼š

    dotnet add package Huanent.Logging.File
    dotnet add package Huanent.Logging.File.UI
    dotnet add package Huanent.Logging.Abstract


- é…ç½® File æ—¥å¿—

    åœ¨ Program.cs æ–‡ä»¶ä¸­æ·»åŠ ï¼š

         .UseStartup<Startup>()
             .ConfigureLogging(builder => builder.AddFile()) 

    appsettings.json æ–‡ä»¶æ·»åŠ  File èŠ‚ç‚¹ï¼Œå¦‚æœå¿½ç•¥ä¼šå°†æ‰€æœ‰ç±»åˆ«æ—¥å¿—éƒ½è¾“å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼š

          "Logging": {
            "LogLevel": {
              "Default": "Trace",
              "Microsoft": "Trace",
              "Microsoft.Hosting.Lifetime": "Trace"
            }
          },
          "File": {
            "LogLevel": {
              "Default": "Trace",
              "Microsoft": "Trace",
              "Microsoft.Hosting.Lifetime": "Trace"
            }
          },

- é…ç½® File UI æ’ä»¶

    ä¿®æ”¹ Startup.cs:

            services.AddLoggingFileUI();

            app.UseStaticFiles();
            app.UseMvc();

    å¯åŠ¨ç½‘ç«™ï¼Œè®¿é—®é¡µé¢ http://xxxxx:xx/logging å³å¯æ‰“å¼€é¡µé¢æŸ¥çœ‹æ—¥å¿—

- Abstract è‡ªå®šä¹‰ä»‹è´¨æ—¥å¿—

    å¯ä»¥é€šè¿‡å®ç° ILoggerWriter æ¥è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºä¿å­˜çš„ä»‹è´¨ã€‚
    æ³¨æ„ï¼MyLogWriter å¯¹è±¡åœ¨ DI å®¹å™¨ä¸­ä»¥ Singleton å•ä¾‹å½¢å¼å­˜åœ¨ï¼
    æ³¨æ„ï¼è¯·å‹¿åœ¨ MyLogWriter ä¸­è¿›è¡Œä¼šæ—¥å¿—è¾“å‡ºçš„æ“ä½œï¼Œé‚£å¯èƒ½ä¼šå¯¼è‡´å¾ªç¯é€’å½’ï¼Œæ ˆæº¢å‡ºï¼

        public class MyLogWriter : ILoggerWriter
        {
            public void WriteLog(LogLevel level, string message, string name, Exception exception, EventId eventId)
            {
                // åœ¨æ­¤å¤„è‡ªå®šä¹‰æ—¥å¿—çš„ä¿å­˜æ–¹å¼ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œäº‘ç­‰
            }
        }

    åœ¨Program.csæ–‡ä»¶ä¸­æ·»åŠ ï¼š

        .UseStartup<Startup>()
            .ConfigureLogging(builder => builder.AddAbstract<MyLogWriter>()) 

    é…ç½® appsettings.json æ–‡ä»¶ï¼Œæ·»åŠ  Abstract èŠ‚ç‚¹ï¼Œå¦‚æœå¿½ç•¥ä¼šå°†æ‰€æœ‰ç±»åˆ«æ—¥å¿—éƒ½è¾“å‡ºï¼š

        "Logging": {
            "IncludeScopes": false,
            "Debug": {
                "LogLevel": {
                    "Default": "Warning"
                }
            },
            "Console": {
                "LogLevel": {
                    "Default": "Warning"
                }
            },
            "Abstract": {
                "LogLevel": {
                    "Default": "Warning"
                }
            }
        }



## ==âš¡ Tag Helpers & HtmlHelper åŠ©æ‰‹æ ‡ç­¾
- https://docs.microsoft.com/en-us/aspnet/core/mvc/views/tag-helpers/built-in/?view=aspnetcore-3.1
- https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.rendering.ihtmlhelper-1?view=aspnetcore-3.1
- https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/working-with-forms?view=aspnetcore-3.1

åŠ©æ‰‹æ ‡ç­¾ä½¿æœåŠ¡å™¨ç«¯ä»£ç å‚ä¸ Razor é¡µé¢çš„åˆ›å»ºå’Œå‘ˆç° HTML å…ƒç´ ã€‚

åŠ©æ‰‹æ ‡ç­¾å°†å‡å°‘è§†å›¾ä¸­ Razor HTML å’Œ C# ä¹‹é—´çš„æ˜¾å¼è½¬æ¢ã€‚ åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒHTML æ ‡ç­¾ä¸ºç‰¹å®šåŠ©æ‰‹æ ‡ç­¾æä¾›äº†ä¸€ç§æ›¿ä»£æ–¹æ³•ï¼Œä½†åŠ©æ‰‹æ ‡ç­¾ä¸ä¼šæ›¿ä»£ HTML æ ‡ç­¾ï¼Œä¸”å¹¶éæ¯ä¸ª HTML æ ‡ç­¾éƒ½æœ‰å¯¹åº”çš„åŠ©æ‰‹æ ‡ç­¾ï¼Œè®¤è¯†åˆ°è¿™ç‚¹ä¹Ÿå¾ˆé‡è¦ã€‚


ä½¿ç”¨ HtmlHelper å’ŒåŠ©æ‰‹æ ‡ç­¾ä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨æ¥ç”Ÿæˆ HTML æ ‡ç­¾çš„å·¥å…·ï¼Œä½†æ˜¯åŠ©æ‰‹æ ‡ç­¾è®¾è®¡æ›´åˆç†ï¼Œæ¨èä½¿ç”¨ã€‚

@Html.Raw è¾“å‡ºä¸è¿›è¡Œç¼–ç ï¼Œä½†å‘ˆç°ä¸º HTML æ ‡è®°ã€‚

è­¦å‘Šï¼š å¯¹æœªç»å®¡æŸ¥çš„ç”¨æˆ·è¾“å…¥ä½¿ç”¨ HtmlHelper.Raw ä¼šå¸¦æ¥å®‰å…¨é£é™©ã€‚ ç”¨æˆ·è¾“å…¥å¯èƒ½åŒ…å«æ¶æ„çš„ JavaScript æˆ–å…¶ä»–æ”»å‡»ã€‚ å®¡æŸ¥ç”¨æˆ·è¾“å…¥æ¯”è¾ƒå›°éš¾ã€‚ åº”é¿å…å¯¹ç”¨æˆ·è¾“å…¥ä½¿ç”¨ HtmlHelper.Rawã€‚

    @Html.Raw("<span>Hello World</span>")

    <span>Hello World</span>

å‡è®¾æ¨¡å‹å®šä¹‰å¦‚ä¸‹ï¼Œä½¿ç”¨ @Html.DisplayNameFor ä¸ @Html.DisplayFor ç”Ÿæˆ HTML æ ‡ç­¾ï¼š

    [Table("View_Product")]
    [DisplayName("Course")]
    public partial class Courses
    {
        [DisplayName("Major Course")]   
        public bool IsMajor { get; set; }
        ...
    }   

é‚£ä¹ˆä»¥ä¸‹ HtmlHelper å’Œå¯¹åº” HTML æ ‡ç­¾ç”Ÿæˆå¦‚ä¸‹ï¼Œ@Html.DisplayFor ä¼šæ ¹æ®æ•°æ®ç±»å‹ç”Ÿæˆä¸åŒçš„ HTML æ ‡ç­¾ï¼š

    <th>@Html.DisplayNameFor(model => model.Courses[0].IsMajor)</th>

    <th>Major Course</th>

    @Html.DisplayFor(modelItem => model.Courses[0].IsMajor)

    <select class="tri-state list-box" disabled="disabled">
        <option selected="selected" value="">
            Not Set
        </option>
        <option value="true">
            True
        </option>
        <option value="false">
            False
        </option>
    </select>


åˆ—å¦‚ï¼Œä½¿ç”¨ LabelTagHelper åŠ©æ‰‹æ ‡ç­¾ï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰ä»·ï¼ŒRazor ä¼šå°†å®ƒä»¬è½¬æ¢æˆå¯¹åº”çš„ HTML æ ‡ç­¾è¾“å‡ºåˆ°å®¢æˆ·ç«¯ï¼š

    @Html.Label("FirstName", "First Name:", new {@class="caption"})

    <label class="caption" asp-for="FirstName"></label>

@ ç¬¦å·æŒ‡ç¤º Razor è§£æå™¨è¿™æ˜¯ä»£ç çš„å¼€å¤´ï¼Œæ¥ä¸‹æ¥çš„ä¸¤ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ç”¨äºè¡¨ç¤ºå±æ€§çš„åŒ¿åå¯¹è±¡ã€‚ ç”±äº class æ˜¯ C# ä¸­çš„ä¿ç•™å…³é”®å­—ï¼Œå› æ­¤è¦ä½¿ç”¨ @ ç¬¦å·å¼ºåˆ¶ C# å°† @class= è§£é‡Šä¸ºç¬¦å·ï¼ŒHTML æ ‡ç­¾å±æ€§åç§°ã€‚ 

HTML å‹å¥½çš„å¼€å‘ä½“éªŒå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒRazor ä½¿ç”¨åŠ©æ‰‹æ ‡ç­¾çš„æ ‡è®°çœ‹èµ·æ¥åƒæ ‡å‡† HTMLã€‚ ç†Ÿæ‚‰ HTML/CSS/JavaScript çš„å‰ç«¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Razor C# è¯­æ³•è¿›è¡Œç¼–è¾‘è€Œä¸ç”¨ç‰¹åˆ«å­¦ä¹ ã€‚

åŠ©æ‰‹æ ‡ç­¾ä½¿ç”¨ä»…åœ¨æœåŠ¡å™¨ä¸Šå¯ç”¨çš„ä¿¡æ¯ï¼Œå¯æé«˜ç”Ÿäº§åŠ›ï¼Œå¹¶èƒ½ç”Ÿæˆæ›´ç¨³å®šã€å¯é å’Œå¯ç»´æŠ¤çš„ä»£ç ã€‚

ä¾‹å¦‚ï¼Œè¿‡å»æ›´æ–°å›¾åƒæ—¶ï¼Œå¿…é¡»åœ¨æ›´æ”¹å›¾åƒæ—¶æ›´æ”¹å›¾åƒåç§°ã€‚ å‡ºäºæ€§èƒ½åŸå› ï¼Œè¦ä¸»åŠ¨ç¼“å­˜å›¾åƒï¼Œè€Œè‹¥ä¸æ›´æ”¹å›¾åƒçš„åç§°ï¼Œå®¢æˆ·ç«¯å°±å¯èƒ½è·å¾—è¿‡æ—¶çš„å‰¯æœ¬ã€‚ ä»¥å‰ï¼Œç¼–è¾‘å®Œå›¾åƒåï¼Œå¿…é¡»æ›´æ”¹åç§°ï¼Œè€Œä¸”éœ€è¦æ›´æ–° Web åº”ç”¨ä¸­å¯¹è¯¥å›¾åƒçš„æ¯ä¸ªå¼•ç”¨ã€‚å†…ç½® ImageTagHelper å¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ­¤æ“ä½œã€‚ ImageTagHelper å¯å°†ç‰ˆæœ¬å·è¿½åŠ åˆ°å›¾åƒåç§°ï¼Œè¿™æ ·æ¯å½“å›¾åƒå‡ºç°æ›´æ”¹æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šè‡ªåŠ¨ä¸ºè¯¥å›¾åƒç”Ÿæˆæ–°çš„å”¯ä¸€ç‰ˆæœ¬ã€‚ 

å¤§å¤šæ•°å†…ç½®åŠ©æ‰‹æ ‡ç­¾ä»¥æ ‡å‡† HTML å…ƒç´ ä¸ºç›®æ ‡ï¼Œä¸ºè¯¥å…ƒç´ æä¾›æœåŠ¡å™¨ç«¯å±æ€§ã€‚ ä¾‹å¦‚ï¼Œ`<input>` ç”¨äºåŒ…å« `asp-for` ç‰¹æ€§ï¼Œç»å¸¸ç”¨äºå¸¦æœ‰æ•°æ®æ¨¡å‹çš„è§†å›¾æ–‡ä»¶ä¸­ã€‚ æ­¤ç‰¹æ€§å°†æŒ‡å®šæ¨¡å‹å±æ€§çš„åç§°ï¼Œå¹¶æå–è‡³æ‰€å‘ˆç°çš„ HTMLã€‚ è¯·è€ƒè™‘ Razor Page å…·æœ‰ä»¥ä¸‹æ•°æ®æ¨¡å‹ï¼š

    public class Movie
    {
        public int ID { get; set; }
        public string Title { get; set; }
        public DateTime ReleaseDate { get; set; }
        public string Genre { get; set; }
        public decimal Price { get; set; }
    }

ä»¥ä¸‹ Razor æ ‡è®°ï¼š

    <label asp-for="Movie.Title"></label>

åˆ™ä¼šç”Ÿæˆä»¥ä¸‹ HTMLï¼š

    <label for="Movie_Title">Title</label>

é€šè¿‡ LabelTagHelper ä¸­çš„ For å±æ€§ï¼Œå¯ä½¿ç”¨ asp-for ç‰¹æ€§ã€‚


åŠ©æ‰‹æ ‡ç­¾æœ‰ä¸‰ä¸ªç›¸å…³æŒ‡ä»¤ï¼Œè¿˜æœ‰æ„Ÿå¹å·ç”¨äºä¸´æ—¶ç¦æ­¢åŠ©æ‰‹æ ‡ç­¾ã€‚

- @addTagHelper å‘è§†å›¾æä¾›åŠ©æ‰‹æ ‡ç­¾ã€‚
- @removeTagHelper  ä»è§†å›¾ä¸­åˆ é™¤ä»¥å‰æ·»åŠ çš„åŠ©æ‰‹æ ‡ç­¾ã€‚
- @tagHelperPrefix  æŒ‡å®šå‰ç¼€ä½¿ç”¨åŠ©æ‰‹æ ‡ç­¾ã€‚

é€šè¿‡åŠ©æ‰‹æ ‡ç­¾çš„å¼•ç”¨ç»Ÿä¸€è®¾ç½®åœ¨ `_ViewImports.cshtml` å…¬å…±æ¨¡æ¿æ–‡ä»¶ä¸­ã€‚

    @using AuthoringTagHelpers
    @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
    @addTagHelper *, AuthoringTagHelpers

é€€å‡ºå­—ç¬¦ ! å¯åœ¨å…ƒç´ çº§åˆ«ç¦ç”¨åŠ©æ‰‹æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼Œåœ¨ `<span>` ä¸­ç¦ç”¨ Email éªŒè¯ï¼š

    <!span asp-validation-for="Email" class="text-danger"></!span>

@tagHelperPrefix æŒ‡ä»¤å¯æŒ‡å®šä¸€ä¸ªæ ‡è®°å‰ç¼€å­—ç¬¦ä¸²ï¼Œä»¥å¯ç”¨åŠ©æ‰‹æ ‡ç­¾æ”¯æŒå¹¶é˜æ˜åŠ©æ‰‹æ ‡ç­¾ç”¨é€”ã€‚ ä¾‹å¦‚:

    @tagHelperPrefix th:

    <th:label for="Movie_Title">Title</th:label>


ä¸å…è®¸åœ¨å…ƒç´ çš„å±æ€§å¤–åŒºåŸŸä¸­å‡ºç° C#ï¼Œä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ç¬¬ä¸€è¡Œæ— æ•ˆï¼š

    <input asp-for="LastName" @(Model?.LicenseId == null ? "disabled" : string.Empty) />

    <input asp-for="LastName" disabled="@(Model?.LicenseId == null)" />


å†…ç½®åŠ©æ‰‹æ ‡ç­¾ï¼ŒBuilt-in ASP.NET Core Tag Helpers


### ===âœ’ Anchor Tag Helper

| å±æ€§    | è¯´æ˜    |
| :-----    | :-----    |
| asp-controller    | æ§åˆ¶å™¨çš„åç§°ï¼Œç”¨äºç”Ÿæˆ URL çš„æ§åˆ¶å™¨éƒ¨åˆ†ã€‚   |
| asp-action    | æ“ä½œæ–¹æ³•çš„åç§°ã€‚  |
| asp-area  | åŒºåŸŸåç§°ï¼Œç”¨äºç›®å½•åˆ†çº§ã€‚  |
| asp-page  | Razor Page çš„åç§°ã€‚   |
| asp-page-handler  | Razor Page å¤„ç†ç¨‹åºçš„åç§°ã€‚   |
| asp-route | æŒ‡å®šè·¯ç”±çš„åç§°ï¼Œç”¨äºåˆ›å»ºç›´æ¥é“¾æ¥åˆ°å‘½åè·¯ç”±çš„ URLã€‚   |
| asp-route-{value} | å•ä¸ª URL è·¯ç”±å€¼ã€‚ ä¾‹å¦‚ï¼Œasp-route-id="1234"ã€‚   |
| asp-all-route-data    | æ‰€æœ‰è·¯ç”±å€¼ã€‚æ”¯æŒåˆ›å»ºé”®å€¼å¯¹å­—å…¸ï¼Œ é”®æ˜¯å‚æ•°åç§°ï¼Œå€¼æ˜¯å‚æ•°å€¼ã€‚    |
| asp-fragment  | URL ç‰‡æ®µï¼Œå³åœ°å€ # å·åé¢çš„éƒ¨åˆ†ã€‚  |
| asp-protocol  | ç”¨äºåœ¨ URL ä¸­æŒ‡å®šåè®®ï¼ˆæ¯”å¦‚ httpsï¼‰ã€‚  |
| asp-host  | åœ¨ URL ä¸­æŒ‡å®šä¸»æœºåï¼Œå¦‚ asp-host="microsoft.com"ã€‚  |


éœ€è¦æ³¨æ„ï¼Œä»¥ä¸‹ä¸‰ç±»å±æ€§ä¸èƒ½åŒæ—¶å‡ºç°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸‰ç§å†²çªçš„è·¯ç”±è§„åˆ™ï¼š

- asp-route
- asp-controller, asp-action
- asp-page, asp-page-handler

ç¤ºä¾‹å‡ä½¿ç”¨ SpeakerControllerï¼š

    using Microsoft.AspNetCore.Mvc;
    using System.Collections.Generic;
    using System.Linq;

    public class SpeakerController : Controller
    {
        private List<Speaker> Speakers =
            new List<Speaker>
            {
                new Speaker {SpeakerId = 10},
                new Speaker {SpeakerId = 11},
                new Speaker {SpeakerId = 12}
            };

        [Route("Speaker/{id:int}")]
        public IActionResult Detail(int id) =>
            View(Speakers.FirstOrDefault(a => a.SpeakerId == id));

        [Route("/Speaker/Evaluations", 
               Name = "speakerevals")]
        public IActionResult Evaluations() => View();

        [Route("/Speaker/EvaluationsCurrent",
               Name = "speakerevalscurrent")]
        public IActionResult Evaluations(
            int speakerId,
            bool currentYear) => View();

        public IActionResult Index() => View(Speakers);
    }

    public class Speaker
    {
        public int SpeakerId { get; set; }
    }

asp-controller å±æ€§å¯åˆ†é…ç”¨äºç”Ÿæˆ URL çš„æ§åˆ¶å™¨éƒ¨åˆ†ï¼Œå¦‚æœæŒ‡å®šäº† asp-controller è€ŒæœªæŒ‡å®š asp-action å±æ€§ï¼Œåˆ™é»˜è®¤çš„ asp-action å€¼ä¸ºä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„è§†å›¾å…³è”çš„æ§åˆ¶å™¨æ“ä½œã€‚

    <a asp-controller="Speaker" asp-action="Index">All Speakers</a>

    <a href="/Speaker">All Speakers</a>

asp-action å±æ€§å€¼è¡¨ç¤ºç”Ÿæˆçš„ href å±æ€§ä¸­åŒ…å«çš„æ§åˆ¶å™¨æ“ä½œåç§°ã€‚ å¦‚æœæœªæŒ‡å®š asp-controller å±æ€§ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨è°ƒç”¨æ‰§è¡Œå½“å‰è§†å›¾çš„è§†å›¾ã€‚ å¦‚æœ asp-action å±æ€§å€¼ä¸º Indexï¼Œåˆ™ä¸å‘ URL è¿½åŠ ä»»ä½•æ“ä½œï¼Œä»è€Œå¯¼è‡´è°ƒç”¨é»˜è®¤çš„ Index æ“ä½œã€‚ asp-controller å¼•ç”¨çš„æ§åˆ¶å™¨ä¸­å¿…é¡»å­˜åœ¨æŒ‡å®šçš„ï¼ˆæˆ–é»˜è®¤çš„ï¼‰æ“ä½œã€‚

    <a asp-controller="Speaker" asp-action="Evaluations">Speaker Evaluations</a>

    <a href="/Speaker/Evaluations">Speaker Evaluations</a>

asp-route å±æ€§ç”¨äºåˆ›å»ºç›´æ¥é“¾æ¥åˆ°å‘½åè·¯ç”±çš„ URLã€‚ ä½¿ç”¨è·¯ç”±å±æ€§ï¼Œè·¯ç”±å¯ä»¥æŒ‰æ§åˆ¶å™¨ä¸­æ‰€å®šä¹‰çš„å‘½åè·¯ç”±å»ºç«‹æ˜ å°„å…³ç³»ï¼š

    [Route("/Speaker/Evaluations", Name="speakerevals")]
    public IActionResult Evaluations() => View();

åœ¨ç›¸åº”çš„åŠ©æ‰‹æ ‡ç­¾ asp-route å±æ€§å¼•ç”¨å‘½åè·¯ç”±ï¼Œå°±ä¼šç”ŸæˆæŒ‡å®šä¸Šé¢å®šä¹‰çš„å‘½åè·¯ç”±ï¼š

    <a asp-route="speakerevals">Speaker Evaluations</a>

    <a href="/Speaker/Evaluations">Speaker Evaluations</a>

å¦‚æœé™¤äº† asp-routeï¼Œè¿˜æŒ‡å®šäº† asp-controller æˆ– asp-actionï¼Œåˆ™å¯èƒ½ä¸ä¼šç”Ÿæˆé¢„æœŸçš„è·¯ç”±ã€‚ ä¸ºäº†é¿å…å‘ç”Ÿè·¯ç”±å†²çªï¼Œä¸åº”å°† asp-route ä¸ asp-controller å’Œ asp-action å±æ€§ç»“åˆä½¿ç”¨ã€‚


asp-page å’Œ asp-page-handler æ˜¯ç”¨äº Razor é¡µé¢çš„è·¯ç”±å±æ€§ï¼Œä½¿ç”¨å®ƒç”ŸæˆæŒ‡å‘ Razor Page çš„è·¯ç”±åœ°å€ã€‚ ä½¿ç”¨æ­£æ–œæ  / ä½œä¸ºå‰ç¼€ï¼Œå†è·Ÿç€é¡µé¢ï¼Œå¯åˆ›å»º URLã€‚

ä»¥ä¸‹ç¤ºä¾‹æŒ‡å‘ "ä¸ä¼šè€…Razor " é¡µï¼š

    <a asp-page="/Attendee">All Attendees</a>

    <a href="/Attendee">All Attendees</a>

asp-page ä¸ asp-routeã€asp-controllerã€asp-action ä¸‰è€…äº’æ–¥ï¼Œä½†æ˜¯ï¼Œasp-page å¯ä¸ asp-route-{value} å’Œ  asp-controller ç»“åˆä½¿ç”¨ä»¥æ§åˆ¶è·¯ç”±ï¼Œå¦‚ä»¥ä¸‹æ ‡è®°æ‰€ç¤ºï¼š

    <a asp-page="/Attendee" asp-route-attendeeid="10">View Attendee</a>

    <a href="/Attendee?attendeeid=10">View Attendee</a>

asp-page-handler è®¾ç½®ç”¨äºé“¾æ¥åˆ°ç‰¹å®šçš„é¡µå¤„ç†ç¨‹åº

    public void OnGetProfile(int attendeeId)
    {
        ViewData["AttendeeId"] = attendeeId;

        // code omitted for brevity
    }

å¦‚æœæ²¡æœ‰ç›¸åº”çš„é¡µé¢ï¼Œé‚£ä¹ˆæ ‡ç­¾ç”Ÿæˆæ—¶ href å±æ€§ä¸­å°±ä¼šåœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­åŒ…å« asp-page æŒ‡å®šçš„å€¼ï¼Œä¾‹å¦‚ï¼Œæ²¡æœ‰ Delete è¿™ä¸ªé¡µé¢ï¼Œæ ‡ç­¾è®¾ç½®å’Œç”Ÿæˆçš„ URL å¦‚ä¸‹ï¼š

    <a asp-page="/Delete">All Attendees</a>

    <a href="/Home?page=%2FDelete">All Attendees</a>

é¡µæ¨¡å‹çš„å…³è”æ ‡è®°é“¾æ¥åˆ° OnGetProfile é¡µå¤„ç†ç¨‹åºã€‚ æ³¨æ„ï¼Œasp-page-handler å±æ€§å€¼ä¸­çœç•¥äº†é¡µå¤„ç†ç¨‹åºæ–¹æ³•åç§°çš„ On<Verb> å‰ç¼€ã€‚ å¦‚æœæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿçœç•¥ Async åç¼€ã€‚

    <a asp-page="/Attendee"
       asp-page-handler="Profile"
       asp-route-attendeeid="12">Attendee Profile</a>

    <a href="/Attendee?attendeeid=12&handler=Profile">Attendee Profile</a>


asp-fragment å±æ€§å¯å®šä¹‰è¦è¿½åŠ åˆ° URL çš„ç‰‡æ®µï¼Œé“¾æ¥æ ‡ç­¾ä¼šæ·»åŠ å“ˆå¸Œå­—ç¬¦ (#)ã€‚ è¯·è€ƒè™‘ä»¥ä¸‹æ ‡è®°ï¼š

    <a asp-controller="Speaker"
       asp-action="Evaluations"
       asp-fragment="SpeakerEvaluations">Speaker Evaluations</a>

    <a href="/Speaker/Evaluations#SpeakerEvaluations">Speaker Evaluations</a>

ç”Ÿæˆå®¢æˆ·ç«¯åº”ç”¨æ—¶ï¼Œå“ˆå¸Œæ ‡è®°å¾ˆæœ‰ç”¨ã€‚ å®ƒä»¬å¯ç”¨äºåœ¨ JavaScript ä¸­è½»æ¾åœ°æ‰§è¡Œæ ‡è®°å’Œæœç´¢ç­‰æ“ä½œã€‚



å¯¹äºåŒºåŸŸç›®å½• asp-areaï¼Œè€ƒè™‘ä»¥ä¸‹è¿™æ ·çš„ç›®å½•ç»“æ„ï¼š

    + wwwroot
    + Areas
    |   - Sessions
    |       - Pagesé¡µ
    |           _Viewstart.cshtml
    |           Index.cshtml
    |           Index.cshtml.cs
    + Pages

è¦å»ºç«‹æŒ‡å‘ Index.cshtml é¡µé¢çš„æ ‡è®°ä¸ºï¼š

    <a asp-area="Sessions" asp-page="/Index">View Sessions</a>

    <a href="/Sessions">View Sessions</a>




asp-route-{value} å±æ€§å¯å®ç°é€šé…ç¬¦è·¯ç”±å‰ç¼€ï¼Œ {value} å ä½ç¬¦çš„æ‰€æœ‰å€¼éƒ½è§£é‡Šä¸ºæ½œåœ¨çš„è·¯ç”±å‚æ•°ã€‚ å¦‚æœæ‰¾ä¸åˆ°é»˜è®¤è·¯ç”±ï¼Œåˆ™å°†æ­¤è·¯ç”±å‰ç¼€ä½œä¸ºè¯·æ±‚å‚æ•°å’Œå€¼è¿½åŠ åˆ°ç”Ÿæˆçš„ href å±æ€§ã€‚ å¦åˆ™ï¼Œå°†åœ¨è·¯ç”±æ¨¡æ¿ä¸­æ›¿æ¢å®ƒã€‚
è€ƒè™‘ä»¥ä¸‹æ§åˆ¶å™¨æ“ä½œï¼š

    public IActionResult AnchorTagHelper(int id)
    {
        var speaker = new Speaker
        {
            SpeakerId = id
        };

        return View(speaker);
    }

åœ¨ Startup.Configure ä¸­å®šä¹‰ MapRoute é»˜è®¤è·¯ç”±æ¨¡æ¿ï¼Œæ·»åŠ ä¸Š `{id?}`ï¼š

    app.UseMvc(routes =>
    {
        // need route and attribute on controller: [Area("Blogs")]
        routes.MapRoute(
            name: "mvcAreaRoute",
            template: "{area:exists}/{controller=Home}/{action=Index}");

        // default route for non-areas
        routes.MapRoute(
            name: "default",
            template: "{controller=Home}/{action=Index}/{id?}");
    });

MVC è§†å›¾å°±å¯ä»¥ä½¿ç”¨ `asp-route-id` å‘è·¯ç”±æä¾›å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    @model Speaker
    <!DOCTYPE html>
    <html>
    <body>
        <a asp-controller="Speaker"
           asp-action="Detail"
           asp-route-id="@Model.SpeakerId">SpeakerId: @Model.SpeakerId</a>
    </body>
    </html>

é»˜è®¤è·¯ç”±çš„ `{id?}` å ä½ç¬¦å¾—ä»¥åŒ¹é…ï¼Œç”Ÿæˆçš„ URL ä¸­ id å‚æ•°å°±ä¸ä¼šä»¥æŸ¥è¯¢å­—ç¬¦ä¸²çš„å½¢å¼è¡¨è¾¾ï¼š

    <a href="/Speaker/Detail/12">SpeakerId: 12</a>

å¯¹äºå…¶å®ƒæ²¡æœ‰åœ¨è·¯ç”±é…ç½®çš„å‚æ•°ï¼Œæ¯”å¦‚ asp-route-speakeridï¼š

    <a asp-controller="Speaker"
       asp-action="Detail"
       asp-route-speakerid="@Model.SpeakerId">SpeakerId: @Model.SpeakerId</a>

ç”Ÿæˆä»¥ä¸‹ HTMLï¼Œå› ä¸ºè·¯ç”±è®¾ç½®ä¸­åŒ¹é…ä¸åˆ° speakerid è€Œç”Ÿæˆçš„å‚æ•°å°±ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²çš„å½¢å¼å‡ºç°ï¼š

    <a href="/Speaker/Detail?speakerid=12">SpeakerId: 12</a>

å¦‚æœ asp-controller æˆ– asp-action å‡æœªæŒ‡å®šï¼Œåˆ™ä¼šæ‰§è¡Œä¸ asp-route å±æ€§ä¸­ç›¸åŒçš„é»˜è®¤å¤„ç†ã€‚



asp-all-route-data å±æ€§æ”¯æŒåˆ›å»ºé”®å€¼å¯¹å­—å…¸ã€‚ é”®æ˜¯å‚æ•°åç§°ï¼Œå€¼æ˜¯å‚æ•°å€¼ã€‚
åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå°†å¯¹å­—å…¸è¿›è¡Œåˆå§‹åŒ–å¹¶ä¼ é€’ç»™è§†å›¾ã€‚ æˆ–è€…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡å‹ä¼ å…¥æ•°æ®ã€‚

    @{
        var parms = new Dictionary<string, string>
        {
            { "speakerId", "11" },
            { "currentYear", "true" }
        };
    }

    <a asp-route="speakerevalscurrent"
       asp-all-route-data="parms">Speaker Evaluations</a>

å‰é¢çš„ä»£ç ç”Ÿæˆä»¥ä¸‹ HTMLï¼š

    <a href="/Speaker/EvaluationsCurrent?speakerId=11&currentYear=true">Speaker Evaluations</a>

å¹³å±• asp-all-route-data å­—å…¸ï¼Œä»¥ç”Ÿæˆæ»¡è¶³é‡è½½ Evaluations æ“ä½œè¦æ±‚çš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼š

    [Route("/Speaker/EvaluationsCurrent", Name="speakerevalscurrent")]
    public IActionResult Evaluations(
        int speakerId,
        bool currentYear) => View();

å¦‚æœå­—å…¸ä¸­çš„ä»»ä½•é”®åŒ¹é…è·¯ç”±å‚æ•°ï¼Œåˆ™å°†æ ¹æ®éœ€è¦åœ¨è·¯ç”±ä¸­æ›¿æ¢è¿™äº›å€¼ã€‚ å…¶ä»–ä¸åŒ¹é…çš„å€¼ä½œä¸ºè¯·æ±‚å‚æ•°ç”Ÿæˆã€‚




- Cache Tag Helper

- Component Tag Helper

- Distributed Cache Tag Helper

- Environment Tag Helper

### ===âœ’ Form Tag Helper

è¡¨å•æ ‡è®°åŠ©æ‰‹ä¸º MVC æ§åˆ¶å™¨æ“ä½œæˆ–å‘½åè·¯ç”±ç”Ÿæˆ HTML è¡¨å•çš„ action ç‰¹æ€§å€¼ã€‚

ç”Ÿæˆéšè—çš„è¯·æ±‚éªŒè¯ä»¤ç‰Œï¼Œé˜²æ­¢è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ï¼Œåœ¨ HTTP Post æ“ä½œæ–¹æ³•ä¸­ä¸ [ValidateAntiForgeryToken] å±æ€§é…åˆä½¿ç”¨ã€‚

æä¾› asp-route-<Parameter Name> å±æ€§ï¼Œå…¶ä¸­ <Parameter Name> æ·»åŠ åˆ°è·¯ç”±å€¼ã€‚ Html.BeginForm å’Œ Html.BeginRouteForm çš„ routeValues å‚æ•°æä¾›ç±»ä¼¼çš„åŠŸèƒ½ã€‚

    <form asp-controller="Demo" asp-action="Register" method="post">
        <!-- Input and Submit elements -->
    </form>

ä¸Šè¿°è¡¨å•åŠ©æ‰‹æ ‡ç­¾ç”Ÿæˆä»¥ä¸‹ HTMLï¼š

    <form method="post" action="/Demo/Register">
        <!-- Input and Submit elements -->
        <input name="__RequestVerificationToken" type="hidden" value="<removed for brevity>">
    </form>

Form Action Tag Helper

| å±æ€§    | è¯´æ˜    |
| :---  | :---  |
| asp-controller    | æ§åˆ¶å™¨çš„åç§°ï¼Œç”¨äºç”Ÿæˆ URL çš„æ§åˆ¶å™¨éƒ¨åˆ†ã€‚   |
| asp-action    | æ“ä½œæ–¹æ³•çš„åç§°ã€‚  |
| asp-area  | åŒºåŸŸåç§°ï¼Œç”¨äºç›®å½•åˆ†çº§ã€‚  |
| asp-page  | Razor Page çš„åç§°ã€‚   |
| asp-page-handler  | Razor Page å¤„ç†ç¨‹åºçš„åç§°ã€‚   |
| asp-route | æŒ‡å®šè·¯ç”±çš„åç§°ï¼Œç”¨äºåˆ›å»ºç›´æ¥é“¾æ¥åˆ°å‘½åè·¯ç”±çš„ URLã€‚   |
| asp-route-{value} | å•ä¸ª URL è·¯ç”±å€¼ã€‚ ä¾‹å¦‚ï¼Œasp-route-id="1234"ã€‚   |
| asp-all-route-data    | æ‰€æœ‰è·¯ç”±å€¼ã€‚æ”¯æŒåˆ›å»ºé”®å€¼å¯¹å­—å…¸ï¼Œ é”®æ˜¯å‚æ•°åç§°ï¼Œå€¼æ˜¯å‚æ•°å€¼ã€‚    |
| asp-fragment  | URL ç‰‡æ®µï¼Œå³åœ°å€ # å·åé¢çš„éƒ¨åˆ†ã€‚  |


æäº¤åˆ°æ§åˆ¶å™¨ç¤ºä¾‹ï¼Œé€‰ä¸­è¾“å…¥æˆ–æŒ‰é’®æ—¶ï¼Œä¸‹é¢çš„æ ‡è®°å°†çª—ä½“æäº¤åˆ° HomeController çš„ Index æ“ä½œï¼š

    <form method="post">
        <button asp-controller="Home" asp-action="Index">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" asp-controller="Home" 
                                    asp-action="Index">
    </form>

ç”Ÿæˆ HTMLï¼š

    <form method="post">
        <button formaction="/Home">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" formaction="/Home">
    </form>
    æäº¤åˆ°é¡µç¤ºä¾‹

ä»¥ä¸‹æ ‡è®°å°†çª—ä½“æäº¤åˆ° About Razor Pageï¼š

    <form method="post">
        <button asp-page="About">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" asp-page="About">
    </form>

ç”Ÿæˆ HTMLï¼š

    <form method="post">
        <button formaction="/About">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" formaction="/About">
    </form>
    æäº¤åˆ°è·¯ç”±ç¤ºä¾‹


ä½¿ç”¨å‘½åè·¯ç”± asp-routeï¼Œè¯·è€ƒè™‘ä½¿ç”¨ /Home/Test ç»ˆç»“ç‚¹ï¼š

    public class HomeController : Controller
    {
        [Route("/Home/Test", Name = "Custom")]
        public string Test()
        {
            return "This is the test page";
        }
    }

ä»¥ä¸‹æ ‡è®°å°†çª—ä½“æäº¤åˆ° /Home/Test ç»ˆç»“ç‚¹ã€‚

    <form method="post">
        <button asp-route="Custom">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" asp-route="Custom">
    </form>

ç”Ÿæˆ HTMLï¼š

    <form method="post">
        <button formaction="/Home/Test">Click Me</button>
        <input type="image" src="..." alt="Or Click Me" formaction="/Home/Test">
    </form>


### ===âœ’ Image Tag Helper

è‹¥è¦æ¿€æ´»å›¾åƒæ ‡è®°åŠ©æ‰‹ï¼Œ`<img>` å…ƒç´ éœ€è¦æœ‰ src å±æ€§ï¼Œå¿…é¡»æŒ‡å‘æœåŠ¡å™¨ä¸Šçš„ç‰©ç†é™æ€æ–‡ä»¶ã€‚ å¦‚æœ src æ˜¯ä¸€ä¸ªè¿œç¨‹ URIï¼Œåˆ™ä¸ä¼šç”Ÿæˆç¼“å­˜ç ´åæŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ã€‚

å¦‚æœä½¿ç”¨ true å€¼å’Œ src å±æ€§æŒ‡å®š asp-append-versionï¼Œåˆ™ä¼šè°ƒç”¨å›¾åƒåŠ©æ‰‹æ ‡ç­¾ã€‚
ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨å›¾åƒåŠ©æ‰‹æ ‡ç­¾ï¼š

    <img src="~/images/asplogo.png" asp-append-version="true">

å¦‚æœç›®å½• /wwwroot/images/** ä¸­å­˜åœ¨é™æ€æ–‡ä»¶ï¼Œåˆ™ç”Ÿæˆçš„ html ä¸ä¸‹é¢ç±»ä¼¼ï¼ˆå“ˆå¸Œæœ‰æ‰€ä¸åŒï¼‰ï¼š

    <img src="/images/asplogo.png?v=Kl_dqr9NVtnMdsM2MUg4qthUnWZm5T1fCEimBPWDNgM">


### ===âœ’ Input Tag Helper

å°† HTML `<input>` å…ƒç´ ç»‘å®šåˆ° razor è§†å›¾ä¸­çš„æ¨¡å‹è¡¨è¾¾å¼ã€‚

    <input asp-for="<Expression Name>">

ä¸º asp-for å±æ€§ä¸­æŒ‡å®šçš„è¡¨è¾¾å¼åç§°ç”Ÿæˆ HTML å±æ€§ï¼ŒåŒ…æ‹¬ id å’Œ nameã€‚asp-for å±æ€§å€¼æ˜¯ ModelExpressionï¼Œå¹¶ä¸”æ˜¯ lambda è¡¨è¾¾å¼çš„å³ä¾§ã€‚ å› æ­¤ï¼Œasp-for="Property1" åœ¨ç”Ÿæˆçš„ä»£ç ä¸­å˜æˆ m => m.Property1ï¼Œè¿™ä¹Ÿæ˜¯æ— éœ€ä½¿ç”¨ Model å‰ç¼€çš„åŸå› ã€‚ @ å­—ç¬¦å¯ç”¨ä½œå†…è”è¡¨è¾¾å¼çš„å¼€å¤´ï¼Œå¹¶ç§»åˆ° m. å‰é¢ï¼š

    @{
      var joe = "Joe";
    }

    <input asp-for="@joe">

ç”Ÿæˆä»¥ä¸‹ HTMLï¼š

    <input type="text" id="joe" name="joe" value="Joe">

ä½¿ç”¨é›†åˆå±æ€§æ—¶ï¼Œasp-for="CollectionProperty[23].Member" åœ¨ i å…·æœ‰å€¼ 23 æ—¶ç”Ÿæˆä¸ asp-for="CollectionProperty[i].Member" ç›¸åŒçš„åç§°ã€‚

åœ¨ ASP.NET Core MVC è®¡ç®— ModelExpression çš„å€¼æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å¤šä¸ªæºï¼ŒåŒ…æ‹¬ ModelStateã€‚ ä»¥ `<input type="text" asp-for="@Name">` ä¸ºä¾‹ã€‚ è®¡ç®—å‡ºçš„ value å±æ€§æ˜¯ç¬¬ä¸€ä¸ªé null å€¼ï¼Œå±äºï¼š

- å¸¦æœ‰ Name é”®çš„ ModelState æ¡ç›®ã€‚
- Model.Name è¡¨è¾¾å¼çš„ç»“æœã€‚

Html.TextBoxã€Html.TextBoxForã€Html.Editor å’Œ Html.EditorFor ä¸åŠ©æ‰‹æ ‡ç­¾çš„åŠŸèƒ½å­˜åœ¨é‡å ã€‚ 

Html.TextBox å’Œ Html.TextBoxFor ä¸ä¼šè‡ªåŠ¨è®¾ç½® type å±æ€§ï¼Œè€ŒåŠ©æ‰‹æ ‡ç­¾ä¼šã€‚ 
Html.Editor å’Œ Html.EditorFor å¤„ç†é›†åˆã€å¤æ‚å¯¹è±¡å’Œæ¨¡æ¿ï¼Œè€ŒåŠ©æ‰‹æ ‡ç­¾ä¸ä¼šã€‚
åŠ©æ‰‹æ ‡ç­¾ã€Html.EditorFor å’Œ Html.TextBoxFor æ˜¯å¼ºç±»å‹ï¼ˆä½¿ç”¨ lambda è¡¨è¾¾å¼ï¼‰ï¼Œè€Œ Html.TextBox å’Œ Html.Editor ä¸æ˜¯ï¼ˆä½¿ç”¨è¡¨è¾¾å¼åç§°ï¼‰ã€‚

@Html.Editor() å’Œ @Html.EditorFor() åœ¨æ‰§è¡Œå…¶é»˜è®¤æ¨¡æ¿æ—¶ä½¿ç”¨åä¸º htmlAttributes çš„ç‰¹æ®Š ViewDataDictionary æ¡ç›®ã€‚ æ­¤è¡Œä¸ºå¯é€‰æ‹©ä½¿ç”¨ additionalViewData å‚æ•°å¢å¼ºã€‚ é”® htmlAttributes åŒºåˆ†å¤§å°å†™ã€‚ é”® htmlAttributes çš„å¤„ç†æ–¹å¼ä¸ä¼ é€’åˆ°åŠ©æ‰‹æ ‡ç­¾,ä¾‹å¦‚ @Html.TextBox() çš„ htmlAttributes å¯¹è±¡çš„å¤„ç†æ–¹å¼ç±»ä¼¼ã€‚

    @Html.EditorFor(model => model.YourProperty, 
      new { htmlAttributes = new { @class="myCssClass", style="Width:100px" } })


Input åŠ©æ‰‹æ ‡ç­¾æ ¹æ® .NET ç±»å‹è®¾ç½® HTML type å±æ€§ã€‚ ä¸‹è¡¨åˆ—å‡ºä¸€äº›å¸¸è§çš„ .NET ç±»å‹å’Œç”Ÿæˆçš„ HTML ç±»å‹ï¼ˆå¹¶æœªåˆ—å‡ºæ¯ä¸ª .NET ç±»å‹ï¼‰ã€‚

| .NET ç±»å‹   | è¾“å…¥ç±»å‹ |
| :-------- | :------ |
| Bool  | type="checkbox" |
| String    | type="text" |
| DateTime  | type="datetime-local" |
| Byte  | type="number" |
| Int   | type="number" |
| Singleã€Double | type="number" |

ä¸‹è¡¨æ˜¾ç¤ºåŠ©æ‰‹æ ‡ç­¾ä¼šæ˜ å°„åˆ°ç‰¹å®šè¾“å…¥ç±»å‹çš„ä¸€äº›å¸¸è§æ•°æ®æ³¨é‡Šå±æ€§ï¼ˆå¹¶æœªåˆ—å‡ºæ¯ä¸ªéªŒè¯å±æ€§ï¼‰ï¼š

| Attribute | è¾“å…¥ç±»å‹ |
| :-------- | :------ |
| [EmailAddress]    | type="email" |
| [Url] | type="url" |
| [HiddenInput] | type="hidden" |
| [Phone]   | type="tel" |
| [DataType(DataType.Password)] | type="password" |
| [DataType(DataType.Date)] | type="date" |
| [DataType(DataType.Time)] | type="time" |

ç¤ºä¾‹ï¼š

    using System.ComponentModel.DataAnnotations;

    namespace FormsTagHelper.ViewModels
    {
        public class RegisterViewModel
        {
            [Required]
            [EmailAddress]
            [Display(Name = "Email Address")]
            public string Email { get; set; }

            [Required]
            [DataType(DataType.Password)]
            public string Password { get; set; }
        }
    }

    @model RegisterViewModel

    <form asp-controller="Demo" asp-action="RegisterInput" method="post">
        Email:  <input asp-for="Email" /> <br />
        Password: <input asp-for="Password" /><br />
        <button type="submit">Register</button>
    </form>

ä¸Šè¿°ä»£ç ç”Ÿæˆä»¥ä¸‹ HTMLï¼š

    <form method="post" action="/Demo/RegisterInput">
        Email:
        <input type="email" data-val="true"
            data-val-email="The Email Address field is not a valid email address."
            data-val-required="The Email Address field is required."
            id="Email" name="Email" value=""><br>
        Password:
        <input type="password" data-val="true"
            data-val-required="The Password field is required."
            id="Password" name="Password"><br>
        <button type="submit">Register</button>
        <input name="__RequestVerificationToken" type="hidden" value="<removed for brevity>">
    </form>

åº”ç”¨äº Email å’Œ Password å±æ€§çš„æ•°æ®æ³¨é‡Šåœ¨æ¨¡å‹ä¸­ç”Ÿæˆå…ƒæ•°æ®ï¼ŒåŠ©æ‰‹æ ‡ç­¾ä½¿ç”¨æ¨¡å‹å…ƒæ•°æ®å¹¶ç”Ÿæˆ HTML5 data-val-* å±æ€§ï¼Œåº”ç”¨äºæ¨¡å‹éªŒè¯ã€‚ è¿™æ ·å¯ä»¥æä¾›éä»‹å…¥å¼ HTML5 å’Œ jQuery éªŒè¯ã€‚ ä¸å¼•äººæ³¨ç›®çš„ç‰¹æ€§æ ¼å¼ `data-val-rule="Error Message"`ï¼Œå…¶ä¸­ rule æ˜¯éªŒè¯è§„åˆ™çš„åç§°ï¼Œä¾‹å¦‚ data-val-requiredã€ data-val-email data-val-maxlengthã€ç­‰ã€‚å¦‚æœå±æ€§ä¸­æä¾›é”™è¯¯æ¶ˆæ¯ï¼Œåˆ™è¯¥æ¶ˆæ¯å°†æ˜¾ç¤ºä¸ºè¯¥data-val-ruleå±æ€§çš„å€¼ã€‚ è¿˜æœ‰è¡¨å• data-val-ruleName-argumentName="argumentValue" çš„å±æ€§ï¼Œè¿™äº›å±æ€§æä¾›æœ‰å…³è§„åˆ™çš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œdata-val-maxlength-max="1024"ã€‚


ä½¿ç”¨é›†åˆï¼Œä»¥ä¸‹åŒ…å« Colors æ•°ç»„çš„æ¨¡å‹ç¤ºä¾‹ï¼š

    public class Person
    {
        public List<string> Colors { get; set; }

        public int Age { get; set; }
    }

æ“ä½œæ–¹æ³•ï¼š

    public IActionResult Edit(int id, int colorIndex)
    {
        ViewData["Index"] = colorIndex;
        return View(GetPerson(id));
    }

ä»¥ä¸‹ Razor æ˜¾ç¤ºå¦‚ä½•è®¿é—®ç‰¹å®š Color å…ƒç´ ï¼š

    @model Person
    @{
        var index = (int)ViewData["index"];
    }

    <form asp-controller="ToDo" asp-action="Edit" method="post">
        @Html.EditorFor(m => m.Colors[index])
        <label asp-for="Age"></label>
        <input asp-for="Age" /><br />
        <button type="submit">Post</button>
    </form>





- Label Tag Helper

- Link Tag Helper

- Partial Tag Helper

- Script Tag Helper

- Select Tag Helper

- Textarea Tag Helper

- Validation Message Tag Helper

- Validation Summary Tag Helper


## ==âš¡ TagHelper è‡ªå®šä¹‰

æ¥ï¼Œæˆ‘ç»™å¤§å®¶è®²ä¸ªç¬‘è¯ï¼š

    TagHelper TagHelperComponent TagHelperComponentTagHelper 

ASP.Net å¼•å…¥çš„ TagHelper åŠ©æ‰‹æ ‡ç­¾æ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œæ¯” HtmlHelper æ˜¯ä¸åŒä¸€ä¸ªå¹´ä»£çš„ä¸œè¥¿ã€‚

ASP.NET Core 2 å¸¦æ¥çš„`TagHelperComponent` ç»„ä»¶æ˜¯åŠ¨æ€åœ°å‘ HTML ä¸­æ·»åŠ å†…å®¹æœ€å®Œç¾çš„é€‰æ‹©ã€‚ä¸ºäº†èƒ½åƒåŠ©æ‰‹æ ‡ç­¾ä¸€æ ·ä½¿ç”¨åŠ©æ‰‹æ ‡ç­¾ç»„ä»¶ï¼Œéœ€è¦é€šè¿‡ `TagHelperComponentTagHelper` æ¥å®ç°ï¼Œéƒ½çŸ¥é“ï¼Œè¿™ä¸ªå‘½åéå¸¸ä»¤äººå›°æƒ‘ã€‚

ASP.NET Core åœ¨ Microsoft.AspNetCore.Mvc.Razor.TagHelpers æä¾›äº†ä¸¤ä¸ªå†…ç½®åŠ©æ‰‹æ ‡ç­¾ç»„ä»¶ `TagHelperComponent` ï¼Œ å³ HeadTagHelper å’Œ BodyTagHelper æ¥å°†å†…å®¹æ’å…¥ `<head>` æˆ–  `<body>`ã€‚å¹¶ä¸”å¯åœ¨ MVC å’Œ Razor é¡µé¢ä¸­ä½¿ç”¨ï¼Œç»„ä»¶ä¸éœ€è¦åœ¨ `_ViewImports.cshtml` ä¸­æ³¨å†Œåº”ç”¨ã€‚

ç»§æ‰¿è‡ª `TagHelperComponentTagHelper` çš„ç±»å‹ä¹Ÿå°±æ˜¯ä¸€ä¸ª Tag Helperï¼Œä¸è¿‡å®ƒå°†æ‰§è¡Œä¸ä¹‹åŒ¹é…çš„ `TagHelperComponent`ç»„ä»¶ã€‚å®˜æ–¹æ–‡æ¡£åªæœ‰ä¸€å¥è¯´æ˜ï¼ŒæŒ‰æŒ‡å®šé¡ºåºå°† `TagHelperComponent` æ·»åŠ åˆ°ç»„ä»¶é›†åˆå¹¶åˆå§‹åŒ–ï¼š

    Initializes and processes the ITagHelperComponents added to the Components in the specified order.

æ ‡ç­¾ç»„ä»¶é‡‡ç”¨ Pascal å¤§å°å†™æ ¼å¼å°†ç±»å’Œå±æ€§åå°†è½¬æ¢ä¸ºå„è‡ªç›¸åº”çš„çŸ­æ¨ªçº¿è¿æ¥æ ¼å¼ã€‚ æ¯”å¦‚ï¼Œè¦ä½¿ç”¨ MailTo å±æ€§ï¼Œè¯·ä½¿ç”¨ `<email mail-to="value"/>` ç­‰æ•ˆé¡¹ã€‚

æœªæ˜¾å¼æ ‡è¯† [HtmlTargetElement] å±æ€§çš„åŠ©æ‰‹æ ‡ç­¾ï¼ŒæŒ‰ Pascal å¤§å°å†™æ ¼å¼è½¬æ¢ï¼ŒEmailToTagHelper å¯¹åº” `<email-to />`ï¼Œåç¼€ TagHelper æ˜¯å¯é€‰çš„ï¼Œåªè¦ç»§æ‰¿ TagHelper åŸºç±»å³å¯ ã€‚ ç‰¹æ€§ NormalOrSelfClosing å’Œ
WithoutEndTag åˆ†åˆ«æŒ‡æ˜ HTML çš„è‡ªé—­åˆï¼Œæˆ–æ— ç»ˆç»“æ ‡è®°ã€‚

    using System;
    using System.ComponentModel;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc.Razor.TagHelpers;
    using Microsoft.AspNetCore.Razor.TagHelpers;
    using Microsoft.Extensions.Logging;

    namespace AppWeb.TagHelpers
    {
        [HtmlTargetElement("me")] // <me asp-href="demo.css">Test Me</me>
        [EditorBrowsable(EditorBrowsableState.Never)]
        public class MyTagComponentTagHelper : TagHelperComponentTagHelper
        {
            public MyTagComponentTagHelper(
                ITagHelperComponentManager manager, 
                ILoggerFactory loggerFactory) : base(manager, loggerFactory) 
            {
                //...
            }

            public override async Task ProcessAsync(TagHelperContext context,
                                              TagHelperOutput output)
            {
                TagHelperContent childContent = await output.GetChildContentAsync();
             
                output.TagName = "b";
                var text = childContent.GetContent().ToUpper()+DateTime.Now.ToString(" ss-fff");
                output.Content.AppendHtml(text);
                Console.WriteLine("TagHelperComponentTagHelper....{0}", context.TagName);
            }
        }
        
        public class LinkStyleTagComponent : TagHelperComponent
        {
            private string _style = 
                @"<link rel=""stylesheet"" href=""@"" />";

            public override int Order => 1;

            public LinkStyleTagComponent()
            {
                // ...
            }

            public override async Task ProcessAsync(TagHelperContext context,
                                              TagHelperOutput output)
            {
                TagHelperContent childContent = await output.GetChildContentAsync();
             
                if (string.Equals(context.TagName, "head", // body or head
                    StringComparison.OrdinalIgnoreCase))
                {
                    var style = _style.Replace("@", "/css/demo.css");
                    output.PostContent.AppendHtml(style);
                }
                // Console.WriteLine("TagHelperComponent....{0}", context.TagName);
            }
        }

        // [HtmlTargetElement("email", TagStructure = TagStructure.NormalOrSelfClosing)]
        // [HtmlTargetElement("email", TagStructure = TagStructure.WithoutEndTag)] 
        [HtmlTargetElement("email")]
        public class EmailTagHelper : TagHelper
        {
            // passed by <email to="name@domain.com" />
            public string To { get; set; }

            public EmailTagHelper()
            {
                //...
            }

            public override void Process(TagHelperContext context, TagHelperOutput output)
            {
                output.TagName = "a";    // Replaces <email> with <a> tag

                string href = "mailto:"+To;
                output.Attributes.SetAttribute("href", href);
                // string inner = output.Content.GetContent();
                output.Content.SetContent($"<i>{To}</i>");
                output.TagMode = TagMode.StartTagAndEndTag; // SelfClosing or StartTagOnly
                // output.SuppressOutput();
            }

            public override async Task ProcessAsync(TagHelperContext context, TagHelperOutput output)
            {
                output.TagName = "a"; // Replaces <email> with <a> tag
                var childContent = await output.GetChildContentAsync();
                string content = childContent.GetContent();
                output.Attributes.SetAttribute("href", "mailto:" + To);
                output.Content.SetHtmlContent($"<b>{content}</b>");
                // foreach(var a in output.Attributes)
                // {
                //     Console.WriteLine("TagHelper {0}:{1}", a.Name, a.Value);
                // }
            }
        }

    }

å¦‚æœå¤šä¸ªè‡ªå®šä¹‰åŠ©æ‰‹æ ‡ç­¾å¤„ç†åŒä¸€ç§æ ‡ç­¾æ—¶ï¼Œå¯ä»¥é€šè¿‡ IsModified æ¥åˆ¤æ–­å†…å®¹æ˜¯å¦ç»è¿‡ä¿®æ”¹ï¼Œå¦‚æœæ˜¯åˆ™ä»è¾“å‡ºç¼“å†²åŒºè·å–å†…å®¹ï¼š

    var childContent = output.Content.IsModified ? output.Content.GetContent() : 
         (await output.GetChildContentAsync()).GetContent();

è¾“å‡ºæµå¯ç”¨çš„æ–¹æ³•ï¼š

    output.Attributes.RemoveAll("bold");
    output.PreContent.SetHtmlContent("<strong>"); åœ¨æœ¬ä½“å‰é™„åŠ 
    output.Content.SetHtmlContent("REPLACE"); æ›¿æ¢æœ¬ä½“
    output.PostContent.SetHtmlContent("</strong>"); åœ¨æœ¬ä½“åé™„åŠ 
    output.SuppressOutput();


æœ‰ä¸‰ç§æ–¹æ³•æ³¨å†ŒåŠ©æ‰‹ç»„ä»¶ï¼Œå¯ä»¥åœ¨ Startup ä¸­æ³¨å†Œç»„ä»¶æœåŠ¡ï¼š

    using System.ComponentModel;
    using Microsoft.AspNetCore.Razor.TagHelpers;
    using Microsoft.AspNetCore.Mvc.Razor.TagHelpers;

    services.AddTransient<ITagHelperComponentTagHelper, MyTagComponentTagHelper>();
    services.AddTransient<ITagHelperComponent, LinkStyleComponent>();

åœ¨ cshtml ä¸­æ³¨å†ŒåŠ©æ‰‹æ ‡ç­¾ï¼Œæˆ–è€…åœ¨ `_Imports.cshtml` æ–‡ä»¶ä¸­ï¼Œæ³¨æ„æ ¼å¼æŒ‡å®š * è¡¨ç¤ºå¼•å…¥åé¢ç¨‹åºé›†çš„æ‰€æœ‰åŠ©æ‰‹æ ‡ç­¾ï¼Œ**æ³¨æ„æ˜¯ç¨‹åºé›†ä¸æ˜¯å‘½åç©ºé—´ï¼Œæ³¨æ„ä¸è¦åœ¨ @addTagHelper æœ«å°¾åŠ åˆ†å·**ï¼š

    @using Microsoft.AspNetCore.Mvc.Razor.TagHelpers
    @inject ITagHelperComponentManager manager

    @addTagHelper *, AppWeb
    @addTagHelper AppWeb.TagHelpers.EmailTagHelper, AppWeb

    @{
        ViewData["Title"] = "Edit";

        manager.Components.Add(new LinkStyleComponent());
    }

åœ¨ PageMode ä¸­æ³¨å†ŒåŠ©æ‰‹æ ‡ç­¾ï¼š

    using System.ComponentModel;
    using Microsoft.AspNetCore.Mvc.Razor.TagHelpers;
    using Microsoft.AspNetCore.Razor.TagHelpers;
    using Microsoft.Extensions.Logging;

    private readonly ITagHelperComponentManager _tagHelperComponentManager;

    public EditModel(
        ITagHelperComponentManager tagHelperComponentManager,
        ILoggerFactory loggerFactory)
    {
        _tagHelperComponentManager = tagHelperComponentManager;
        _tagHelperComponentManager.Components.Add(new LinkStyleComponent());
    }


## ==âš¡ MVC Route è·¯ç”±
- [Razor Page é¡µé¢å’Œè·¯ç”±çº¦å®š](https://docs.microsoft.com/zh-cn/aspnet/core/razor-pages/razor-pages-conventions?view=aspnetcore-3.1)
- [Web Apps MVC Routing](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1)
- [MVC è·¯ç”±è®¾ç½®](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1)
- [ASP.Net Core Controller Class](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.controller?view=aspnetcore-3.1)
- [ASP.NET Core ä¸­çš„è·¯ç”±](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/routing?view=aspnetcore-3.1)


ASP.NET Core åº”ç”¨å¯ä»¥æ··åˆä½¿ç”¨ä¼ ç»Ÿè·¯ç”±å’Œå±æ€§è·¯ç”±ä¸¤ç§è·¯ç”±æ–¹å¼ï¼š

- Conventional routing é€šå¸¸å°†ä¼ ç»Ÿè·¯ç”±ç”¨äºä¸ºæµè§ˆå™¨å¤„ç† HTML é¡µé¢çš„æ§åˆ¶å™¨ã€‚
- Attribute routing å±æ€§è·¯ç”±ç”¨äºå¤„ç† REST API çš„æ§åˆ¶å™¨ã€‚

æ§åˆ¶å™¨çš„æ“ä½œ Action æ–¹æ³•æ—¢æ”¯æŒä¼ ç»Ÿè·¯ç”±ï¼Œä¹Ÿæ”¯æŒå±æ€§è·¯ç”±ã€‚ é€šè¿‡åœ¨æ§åˆ¶å™¨æˆ–æ“ä½œä¸Šæ”¾ç½®è·¯ç”±å¯å®ç°å±æ€§è·¯ç”±ã€‚ ä¸èƒ½é€šè¿‡ä¼ ç»Ÿè·¯ç”±è®¿é—®å®šä¹‰å±æ€§è·¯ç”±çš„æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚ 

Razor Pages è·¯ç”±å’Œ MVC æ§åˆ¶å™¨è·¯ç”±å…±äº«ä¸€ä¸ªå®ç°ï¼Œä»¥ä¸‹å…³é”®å­—ä¸ºä¿ç•™è·¯ç”±å‚æ•°åç§°ï¼Œè¿™äº›å…³é”®å­—ä¼šåœ¨è¯·æ±‚æ—¶åŒ¹é…å‡ºç°åœ¨ URL çš„ Path éƒ¨åˆ†ï¼Œæ¯”å¦‚ `/MyController/doAction/2`ï¼Œé‚£ä¹ˆåŒ¹é…çš„å†…å®¹å°±ä¿å­˜åœ¨ HttpRequest.RouteValues å±æ€§ä¸­ï¼Œé”®å€¼å¯¹ä¸­çš„ Key å°±æ˜¯ä»¥ä¸‹è¿™äº›å…³é”®å­—ï¼š

| å…³é”®å­—   | å¯¹åº”åŠ©æ‰‹æ ‡ç­¾å±æ€§ |
| :------   | :------ |
| action    | asp-action |
| area      | asp-area |
| controller| asp-controller |
| handler   | asp-handler |
| page      | asp-page |

URL ç”Ÿæˆä½¿ç”¨ç‰¹æ®Šå‚æ•°åç§°æ¥ç¡®å®š URL ç”Ÿæˆæ“ä½œæ˜¯æŒ‡ Razor é¡µé¢è¿˜æ˜¯å¼•ç”¨æ§åˆ¶å™¨ã€‚ä½¿ç”¨è¿™äº›å…³é”®å­—ä½œä¸ºå±æ€§è·¯ç”±çš„è·¯ç”±å‚æ•°æ˜¯ä¸€ä¸ªå¸¸è§é”™è¯¯ï¼Œè¿™æ ·åšä¼šå¯¼è‡´åœ¨ URL ç”Ÿæˆæ—¶å‡ºç°ä¸ä¸€è‡´çš„è¡Œä¸ºï¼Œå¦‚ä»¥ä¸‹ä½¿ç”¨ page ä½œä¸ºå‚æ•°å°±ä¼šå¯¼è‡´æ½œåœ¨é—®é¢˜ï¼š

    public class MyDemo2Controller : Controller
    {
        [Route("/articles/{page}")]
        public IActionResult ListArticles(int page)
        {
            return ControllerContext.MyDisplayRouteInfo(page);
        }
    }


### ===âœ’ Conventional routing ä¼ ç»Ÿè·¯ç”±

Startup.Configure ä½¿ç”¨ä¼ ç»Ÿè·¯ç”±æ—¶ï¼Œé€šå¸¸å…·æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ä»£ç ï¼š

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllerRoute(
            name: "default",
            pattern: "{controller=Home}/{action=Index}/{id?}");
    });

ä»¥ä¸‹ç®€ä¾¿æ–¹æ³•æ–¹æ³•ç­‰ä»·ï¼š

    endpoints.MapDefaultControllerRoute();
    endpoints.MapControllerRoute("default", "{controller=Home}/{action=Index}/{id?}");

å®ƒè¢«ç§°ä¸ºä¼ ç»Ÿè·¯ç”±ï¼Œå› ä¸ºå®ƒå»ºç«‹äº†ä¸€ä¸ª URL è·¯å¾„çº¦å®šï¼š

- ç¬¬ä¸€ä¸ªè·¯å¾„æ®µ {controller=Home} æ˜ å°„åˆ°æ§åˆ¶å™¨åç§°ï¼Œé»˜è®¤å€¼è¡¨ç¤º URL æ²¡æœ‰æŒ‡å®š Action æ—¶ä½¿ç”¨ Homeã€‚
- ç¬¬äºŒæ®µ {action=Index} æ˜ å°„åˆ°æ“ä½œåç§°ï¼Œé»˜è®¤å€¼è¡¨ç¤º URL æ²¡æœ‰æŒ‡å®š Action æ—¶ä½¿ç”¨ Indexã€‚
- ç¬¬ä¸‰æ®µ {id?} ç”¨äºå¯é€‰å‚æ•° id ã€‚é—®å·ä½¿ {id?} æˆä¸ºå¯é€‰çš„å‚æ•°ã€‚

ä½¿ç”¨æ­¤ default è·¯ç”±ï¼ŒURL è·¯å¾„æ˜ å°„ç¤ºèŒƒï¼š

- /Products/List æ˜ å°„åˆ° ProductsController.List æ“ä½œã€‚
- /Blog/Article/17 æ˜ å°„åˆ° BlogController.Article å’Œé€šå¸¸å°†å‚æ•°ç»‘å®š id ä¸º 17ã€‚

ä¼ ç»Ÿè·¯ç”±çš„æ˜ å°„ä»…åŸºäºæ§åˆ¶å™¨å’Œæ“ä½œåç§°ï¼Œä¸åŸºäºå‘½åç©ºé—´ã€æºæ–‡ä»¶ä½ç½®æˆ–æ–¹æ³•å‚æ•°ã€‚

é€šè¿‡ä½¿ç”¨ä¼ ç»Ÿè·¯ç”±å’Œé»˜è®¤è·¯ç”±ï¼Œå¯ä»¥åˆ›å»ºåº”ç”¨ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªæ“ä½œéƒ½æä¾›æ–°çš„ URL åŒ¹é…æ¨¡å¼ã€‚ å¯¹äºå…·æœ‰ CRUD - Create & Retrieve & Update & Delete æ ·å¼æ“ä½œçš„åº”ç”¨ï¼Œè·¨æ§åˆ¶å™¨çš„ url ä¿æŒä¸€è‡´æœ‰åŠ©äºç®€åŒ–ä»£ç ï¼Œä½¿ UI æ›´å…·å¯é¢„æµ‹æ€§ã€‚é»˜è®¤çš„ä¼ ç»Ÿè·¯ç”±æ˜¯è®¸å¤š web UI åº”ç”¨ç¨‹åºæ‰€éœ€çš„å”¯ä¸€è·¯ç”±æ¨¡æ¿ï¼Œå¯¹äºè¾ƒå¤§çš„ web UI åº”ç”¨ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™ä½¿ç”¨åŒºåŸŸçš„å…¶ä»–è·¯ç”±ã€‚

- MapControllerRoute
- MapDefaultControllerRoute
- MapAreaRoute
- MapAreaControllerRoute

MapControllerRoute å’Œ MapAreaRoute æ ¹æ®åœ¨ Startup ä¸­é…ç½®è°ƒç”¨çš„é¡ºåºï¼Œè‡ªåŠ¨å°† Order é¡ºåºå€¼åˆ†é…ç»™å…¶ç»ˆç»“ç‚¹ EndPointã€‚

ASP.NET Core 3.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸­çš„ç»ˆç»“ç‚¹æ²¡æœ‰è·¯ç”±çš„æ¦‚å¿µï¼Œä¸ä¸ºæ‰§è¡Œæ‰©å±•æ€§æä¾›æ’åºä¿è¯ï¼ŒåŒæ—¶å¤„ç†æ‰€æœ‰ç»ˆç»“ç‚¹ã€‚å¯ç”¨æ—¥å¿—è®°å½•ä»¥æŸ¥çœ‹å†…ç½®è·¯ç”±å®ç°ï¼ˆå¦‚ Routeï¼‰å¦‚ä½•åŒ¹é…è¯·æ±‚ã€‚

UseEndpoints é…ç½®ä¸­å¯ä»¥æ·»åŠ å¤šä¸ªä¼ ç»Ÿè·¯ç”±ï¼Œå¯æ·»åŠ ä¸“ç”¨äºç‰¹å®šæ“ä½œçš„ä¼ ç»Ÿè·¯ç”±ï¼Œä¾‹å¦‚ï¼š

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllerRoute(
            name: "blog",
            pattern: "blog/{*article}",
            defaults: new { controller = "Blog", action = "Article" });
        endpoints.MapControllerRoute(
            name: "default",
            pattern: "{controller=Home}/{action=Index}/{id?}");
    });

ä¸Šè¿°ä»£ç ä¸­çš„ blog è·¯ç”±æ˜¯ä¸“ç”¨çš„ä¼ ç»Ÿè·¯ç”±ï¼Œè¿™ç§°ä¸ºä¸“ç”¨çš„ä¼ ç»Ÿè·¯ç”±ï¼Œå› ä¸ºå®ƒä½¿ç”¨ä¼ ç»Ÿè·¯ç”±ï¼Œä¸“ç”¨äºç‰¹å®šçš„æ“ä½œã€‚æ›´å› ä¸º controller å’Œ action ä¸ä¼šä»¥å‚æ•°å½¢å¼å‡ºç°åœ¨è·¯ç”±æ¨¡æ¿ä¸­ã€‚å®ƒä»¬åªèƒ½å…·æœ‰é»˜è®¤å€¼ { controller = "Blog", action = "Article" } ã€‚

æ­¤è·¯ç”±å§‹ç»ˆæ˜ å°„åˆ°æ“ä½œ BlogController.Articleï¼Œ/Blogã€ /Blog/Article å’Œ /Blog/{any-string} æ˜¯å”¯ä¸€ä¸è·¯ç”±åŒ¹é…çš„ URL è·¯å¾„ã€‚

blog è·¯ç”±å…·æœ‰æ¯”é»˜è®¤è·¯ç”± default æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œå› ä¸ºå®ƒæ˜¯é¦–å…ˆæ·»åŠ çš„ã€‚

åœ¨ ASP.NET Core 3.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œè·¯ç”±ä¸ä¼šï¼š

- å®šä¹‰åä¸º route çš„æ¦‚å¿µã€‚ UseRouting å‘ä¸­é—´ä»¶ç®¡é“æ·»åŠ è·¯ç”±åŒ¹é…ã€‚ UseRouting ä¸­é—´ä»¶ä¼šæŸ¥çœ‹åº”ç”¨ä¸­å®šä¹‰çš„ç»ˆç»“ç‚¹é›†ï¼Œå¹¶æ ¹æ®è¯·æ±‚é€‰æ‹©æœ€ä½³çš„ç»ˆç»“ç‚¹åŒ¹é…ã€‚
- æä¾›å¯æ‰©å±•æ€§ï¼ˆå¦‚æˆ–ï¼‰çš„æ‰§è¡Œ IRouteConstraint é¡ºåº IActionConstraint ã€‚

åœ¨è§†å›¾æ¨¡æ¿æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨åŠ©æ‰‹æ ‡ç­¾æ¥ç”Ÿæˆ HTML é“¾æ¥æ ‡ç­¾ï¼š

    <a asp-area="" asp-controller="hello" asp-action="Edit">Edit</a>

éœ€è¦æ³¨æ„ï¼Œä»¥ä¸‹ä¸‰ç±»å±æ€§ä¸èƒ½åŒæ—¶å‡ºç°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸‰ç§å†²çªçš„è·¯ç”±è§„åˆ™ã€‚åŒæ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š asp-actionï¼Œé‚£ä¹ˆ URL ä¼šæ ¹æ®å½“å‰çš„ action ä½œä¸ºé»˜è®¤å€¼ï¼Œåœ¨ä½¿ç”¨ asp-route-[value] è®¾ç½®å‚æ•°åä¹Ÿä¼šå½±å“ URL çš„ç”Ÿæˆï¼Œæ ¹æ®æ§åˆ¶å™¨ä¸­æœ€åŒ¹é…çš„ action æ–¹æ³•æ¥è®¾ç½® ï¼š

- asp-route
- asp-controller, asp-action
- asp-page, asp-page-handler



### ===âœ’ Attribute Routine å±æ€§è·¯ç”±

REST Api åº”ä½¿ç”¨å±æ€§è·¯ç”±å°†ç”± ApiController ä¸­çš„æ“ä½œæ–¹æ³•æŒ‡å®šçš„ HTTP è°“è¯è¡¨ç¤ºã€‚
å±æ€§è·¯ç”±ä½¿ç”¨ä¸€ç»„å±æ€§å°†æ“ä½œç›´æ¥æ˜ å°„åˆ°è·¯ç”±æ¨¡æ¿ã€‚ ä¸‹é¢ StartUp.Configure ä¸­ MapControllers è°ƒç”¨ä»¥æ˜ å°„å±æ€§è·¯ç”±æ§åˆ¶å™¨ï¼Œè¿™æ˜¯ REST API çš„å…¸å‹é…ç½®ä»£ç ï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddControllers();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }

        app.UseHttpsRedirection();

        app.UseRouting();

        app.UseAuthorization();

        app.UseEndpoints(endpoints =>
        {
            endpoints.MapControllers(); // use [Route] attributes
        });
    }

ä¾‹å¦‚ HomeController åŒ¹é…ä¸€ç»„ä¸é»˜è®¤ä¼ ç»Ÿè·¯ç”± `{controller=Home}/{action=Index}/{id?}` åŒ¹é…çš„ Url ï¼Œè™½ç„¶ä¸å¼ºè°ƒç»Ÿä¸€å¤§å°å†™ï¼Œä½†ä¿æŒä¸€è‡´æ˜¯ä¸ªå¥½ä¹ æƒ¯ã€‚

    public class HomeController : Controller
    {
        [Route("")]
        [Route("Home")]
        [Route("Home/Index")]
        [Route("Home/Index/{id?}")]
        public IActionResult Index(int? id)
        {
            return ControllerContext.MyDisplayRouteInfo(id);
        }

        [Route("Home/About")]
        [Route("Home/About/{id?}")]
        public IActionResult MyAbout(int? id)
        {
            return ControllerContext.MyDisplayRouteInfo(id);
        }
    }

æ­¤ç¤ºä¾‹çªå‡ºæ˜¾ç¤ºäº†å±æ€§è·¯ç”±ä¸ä¼ ç»Ÿè·¯ç”±ä¹‹é—´çš„ä¸»è¦ç¼–ç¨‹åŒºåˆ«ã€‚ å±æ€§è·¯ç”±éœ€è¦æ›´å¤šè¾“å…¥æ‰èƒ½æŒ‡å®šè·¯ç”±ã€‚ ä¼ ç»Ÿçš„é»˜è®¤è·¯ç”±ä¼šæ›´ç®€æ´åœ°å¤„ç†è·¯ç”±ã€‚ ä½†æ˜¯ï¼Œç‰¹æ€§è·¯ç”±å…è®¸å’Œè¦æ±‚ç²¾ç¡®æ§åˆ¶å“ªäº›è·¯ç”±æ¨¡æ¿é€‚ç”¨äºæ¯ä¸ªæ“ä½œã€‚


åŠ©æ‰‹æ ‡ç­¾å±æ€§ asp-route ä½¿ç”¨å‘½åè·¯ç”±ï¼Œå¯ä»¥å’Œå¸¦æœ‰åŒåçš„å±æ€§è·¯ç”± action åŒ¹é…ï¼Œå¦‚ä¸‹ï¼Œå…·æœ‰åä¸º [Route(name="register")] å±æ€§è·¯ç”±çš„ Action æ–¹æ³•å¯å°†ä»¥ä¸‹æ ‡è®°ç”Ÿæˆçš„ URL åŒ¹é…ï¼š

    <form asp-route="register" method="post">
        <!-- Input and Submit elements -->
    </form>

åœ¨æ–°å»ºä½¿ç”¨ä¸ªäººç”¨æˆ·å¸æˆ·èº«ä»½éªŒè¯çš„ Web åº”ç”¨ï¼Œä¼šéœ€è¦åŒ…å« asp-route-returnurl å±æ€§ï¼š

    <form asp-controller="Account" asp-action="Login"
         asp-route-returnurl="@ViewData["ReturnUrl"]"
         method="post" class="form-horizontal" role="form">


ä½¿ç”¨å±æ€§è·¯ç”±æ—¶ï¼Œæ§åˆ¶å™¨å’Œæ“ä½œåç§°ä¸ä¼šå¯¹è·¯ç”±èµ·ä»»ä½•å½±å“ï¼Œæ¯”å¦‚ä¸Šé¢çš„ MyAbout æ“ä½œæ–¹æ³•è¿˜æ˜¯æŒ‰ç…§è·¯ç”±å±æ€§è®¾ç½®èµ·ä½œç”¨ï¼Œé™¤éä½¿ç”¨ä»¤ç‰Œæ›¿æ¢ã€‚

åœ¨å±æ€§è·¯ç”±ä¸­ä½¿ç”¨ä»¤ç‰Œæ›¿æ¢ï¼Œå¯ä»¥ç”¨æ§åˆ¶çš„ Action æ–¹æ³•åç§°æ›¿æ¢ç”Ÿæˆè·¯ç”±ï¼Œæ ‡è®°æ›¿æ¢å‘ç”Ÿåœ¨å±æ€§è·¯ç”±ç”Ÿæˆçš„æœ€åä¸€æ­¥ã€‚ 

ä¸ºæ–¹ä¾¿èµ·è§ï¼Œç‰¹æ€§è·¯ç”±æ”¯æŒä¸ºä¿ç•™è·¯ç”±å‚æ•°æ›¿æ¢æ ‡è®°ï¼Œæ–¹æ³•æ˜¯å°†ä»¤ç‰Œæ‹¬åœ¨ä»¥ä¸‹å…¶ä¸­ä¸€é¡¹ï¼š

- æ–¹æ‹¬å·ï¼š[]ï¼Œå¦‚æ§åˆ¶å™¨ä»¤ç‰Œ [action] ã€ [area] å’Œ [controller]
- å¤§æ‹¬å·ï¼š{}ï¼Œå¦‚å‚æ•°ä»¤ç‰Œ {id}

ä»¥ä¸‹ä»£ç ä¸­çš„ä»¤ç‰Œå°†æ›¿æ¢ä¸ºè‡ªå®šä¹‰è·¯ç”±çš„æ“ä½œæ–¹æ³•åç§°ã€åŒºåŸŸåç§°å’Œæ§åˆ¶å™¨åç§°ï¼š

    [Route("[controller]/[action]")]
    public class Products0Controller : Controller
    {
        [HttpGet]
        public IActionResult List()
        {
            return ControllerContext.MyDisplayRouteInfo();
        }


        [HttpGet("{id}")]
        public IActionResult Edit(int id)
        {
            return ControllerContext.MyDisplayRouteInfo(id);
        }
    }

å‰é¢çš„ç¤ºä¾‹ä¸ä¸‹é¢çš„ä»£ç å…·æœ‰ç›¸åŒçš„è¡Œä¸ºï¼š

    public class Products20Controller : Controller
    {
        [HttpGet("[controller]/[action]")]  // Matches '/Products20/List'
        public IActionResult List()
        {
            return ControllerContext.MyDisplayRouteInfo();
        }
    
        [HttpGet("[controller]/[action]/{id}")]   // Matches '/Products20/Edit/{id}'
        public IActionResult Edit(int id)
        {
            return ControllerContext.MyDisplayRouteInfo(id);
        }
    }

é€šå¸¸ HTTP è°“è¯å±æ€§ç”¨æ¥å®šä¹‰å‚æ•°æ˜ å°„ï¼Œè€Œä¸è®¾ç½®è·¯ç”±ï¼Œåˆ—å¦‚ä»¥ä¸‹ [HttpGet] æŒ‡å®šäº† [action] å°±ä¼šè®©è·¯ç”±éš¾ä»¥ç¢ç£¨ï¼Œå®ƒä¼šå’Œæ§åˆ¶å™¨ç±»å¯¹è±¡æˆ–æ§åˆ¶å™¨æ–¹æ³•è®¾ç½®çš„ [Route] è¿›è¡Œç»“åˆï¼š 

    [HttpGet("/[action]/{id}")]


åŒºåŸŸç›®å½•åˆ†ç»„ç®¡ç†æ˜¯ä¸€é¡¹ MVC åŠŸèƒ½ï¼Œç”¨äºå°†ç›¸å…³åŠŸèƒ½ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ç»„ç»„ç»‡åˆ°ä¸€ä¸ªç›®å½•ç»„ä¸­ï¼š

- æ§åˆ¶å™¨æ“ä½œçš„è·¯ç”±å‘½åç©ºé—´ã€‚
- è§†å›¾çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚

é€šè¿‡ä½¿ç”¨åŒºåŸŸï¼Œåº”ç”¨å¯ä»¥æœ‰å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„æ§åˆ¶å™¨ï¼Œåªè¦å®ƒä»¬å…·æœ‰ä¸åŒçš„åŒºåŸŸå³å¯ã€‚ é€šè¿‡å‘ controller å’Œ action æ·»åŠ å¦ä¸€ä¸ªè·¯ç”±å‚æ•° areaï¼Œå¯ä½¿ç”¨åŒºåŸŸä¸ºè·¯ç”±åˆ›å»ºå±‚æ¬¡ç»“æ„ã€‚ æœ¬éƒ¨åˆ†è®¨è®ºè·¯ç”±å¦‚ä½•ä¸åŒºåŸŸäº¤äº’ã€‚ æœ‰å…³å¦‚ä½•å°†åŒºåŸŸä¸è§†å›¾ç»“åˆä½¿ç”¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…åŒºåŸŸã€‚
ä¸‹é¢çš„ç¤ºä¾‹å°† MVC é…ç½®ä¸ºä½¿ç”¨é»˜è®¤ä¼ ç»Ÿè·¯ç”±ï¼Œå¹¶ä¸º area å‘½åçš„ area æŒ‡å®šè·¯ç”± Blog ï¼š

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapAreaControllerRoute("blog_route", "Blog",
            "Manage/{controller}/{action}/{id?}");
        endpoints.MapControllerRoute("default_route", "{controller}/{action}/{id?}");
    });

åœ¨å‰é¢çš„ä»£ç ä¸­ï¼Œ MapAreaControllerRoute å°†è°ƒç”¨æ¥åˆ›å»º "blog_route" ã€‚ ç¬¬äºŒä¸ªå‚æ•° "Blog" ä¸ºåŒºåŸŸåç§°ã€‚

å½“åŒ¹é… URL è·¯å¾„ï¼ˆå¦‚ /Manage/Users/AddUser ï¼‰æ—¶ï¼Œ "blog_route" è·¯ç”±å°†ç”Ÿæˆè·¯ç”±å€¼ { area = Blog, controller = Users, action = AddUser } ã€‚ areaè·¯ç”±å€¼ç”±çš„é»˜è®¤å€¼ç”Ÿæˆ area ã€‚ åˆ›å»ºçš„è·¯ç”± MapAreaControllerRoute ç­‰æ•ˆäºä»¥ä¸‹å†…å®¹ï¼š

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllerRoute("blog_route", "Manage/{controller}/{action}/{id?}",
            defaults: new { area = "Blog" }, constraints: new { area = "Blog" });
        endpoints.MapControllerRoute("default_route", "{controller}/{action}/{id?}");
    });



é»˜è®¤æƒ…å†µä¸‹ï¼ŒRazor é¡µé¢ä½äº /Pages ç›®å½•çš„æ ¹ä½ç½®, WithRazorPagesAtContentRoot ä»¥æŒ‡å®š Razor Pages ä½äºåº”ç”¨çš„å†…å®¹æ ¹ ContentRootPath ä¸­ã€‚é…ç½® WithRazorPagesRoot ä»¥æŒ‡å®š Razor é¡µé¢ä½äºåº”ç”¨ä¸­è‡ªå®šä¹‰æ ¹ç›®å½•ä½ç½®ï¼ˆæä¾›ç›¸å¯¹è·¯å¾„ï¼‰ï¼š

    public void ConfigureServices(IServiceCollection services)
    {            
        services.AddRazorPages()
            .AddRazorPagesOptions(options =>
            {
                options.Conventions.AuthorizeFolder("/MyPages/Admin");
            })
            .WithRazorPagesAtContentRoot();
            // .WithRazorPagesRoot("/path/to/razor/pages");
    }




å¤§å¤šæ•°åº”ç”¨ä¸éœ€è¦é€šè¿‡æ¨¡å‹çº¦å®šæ¥é…ç½®è·¯ç”±ï¼Œè¦é…ç½®é«˜çº§é€‰é¡¹ï¼Œè¯·ä½¿ç”¨æ‰©å±•æ–¹æ³• AddRazorPagesOptions æ·»åŠ  PagesOption é…ç½®ï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.
            .AddRazorPagesOptions(options =>
            {
                options.RootDirectory = "/MyPages";
                options.Conventions.AuthorizeFolder("/MyPages/Admin");
            });
    }

AddRazorPages() è¿”å› Microsoft.Extensions.DependencyInjection.IMvcBuilder å®ä¾‹ï¼Œé€šè¿‡å®ƒæ¥é…ç½® MVCã€‚


é€šè¿‡æ¨¡å‹çº¦å®šå°†è·¯ç”±æ¨¡æ¿å’Œæ ‡å¤´æ·»åŠ åˆ°åº”ç”¨çš„é¡µé¢ã€‚

- Conventions.Add
- IPageRouteModelConvention
- IPageApplicationModelConvention
- IPageHandlerModelConvention

é€šè¿‡é¡µé¢è·¯ç”±æ“ä½œçº¦å®šå°†è·¯ç”±æ¨¡æ¿æ·»åŠ åˆ°æŸä¸ªæ–‡ä»¶å¤¹ä¸­çš„é¡µé¢ä»¥åŠå•ä¸ªé¡µé¢ã€‚

- AddFolderRouteModelConvention
- AddPageRouteModelConvention
- AddPageRoute

é€šè¿‡é¡µé¢æ¨¡å‹æ“ä½œçº¦å®šå°†æ ‡å¤´æ·»åŠ åˆ°æŸä¸ªæ–‡ä»¶å¤¹ä¸­çš„å¤šä¸ªé¡µé¢ï¼Œå°†æ ‡å¤´æ·»åŠ åˆ°å•ä¸ªé¡µé¢ï¼Œä»¥åŠé…ç½®ç­›é€‰å™¨å·¥å‚ä»¥å°†æ ‡å¤´æ·»åŠ åˆ°åº”ç”¨çš„é¡µé¢ã€‚

- AddFolderApplicationModelConvention
- AddPageApplicationModelConvention
- ConfigureFilterï¼ˆç­›é€‰å™¨ç±»ã€Lambda è¡¨è¾¾å¼æˆ–ç­›é€‰å™¨å·¥å‚ï¼‰

ä½¿ç”¨ AddRazorPagesOptions æ‰©å±•æ–¹æ³•å‘ Startup æ·»åŠ å’Œé…ç½® Razor Pages çº¦å®šã€‚ 

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages()
            .AddRazorPagesOptions(options =>
            {
                options.Conventions.Add( ... );
                options.Conventions.AddFolderRouteModelConvention(
                    "/OtherPages", model => { ... });
                options.Conventions.AddPageRouteModelConvention(
                    "/About", model => { ... });
                options.Conventions.AddPageRoute(
                    "/Contact", "TheContactPage/{text?}");
                options.Conventions.AddFolderApplicationModelConvention(
                    "/OtherPages", model => { ... });
                options.Conventions.AddPageApplicationModelConvention(
                    "/About", model => { ... });
                options.Conventions.ConfigureFilter(model => { ... });
                options.Conventions.ConfigureFilter( ... );
            });
    }

æŒ‰ order çº¦å®šå»ºç«‹è·¯ç”±å¤„ç†ï¼š

- æŒ‰é¡ºåºå¤„ç†è·¯æŒ‰ order çš„å€¼ç”±å°åˆ°å¤§ï¼ˆ-1ã€0ã€1ã€2 â€¦ nï¼‰ã€‚
- å½“è·¯ç”±å…·æœ‰ç›¸åŒ Order æ—¶ï¼Œé¦–å…ˆåŒ¹é…æœ€å…·ä½“çš„è·¯ç”±ï¼Œç„¶ååŒ¹é…ä¸å¤ªå…·ä½“çš„è·¯ç”±ã€‚
- å½“å…·æœ‰ç›¸åŒ Order å’Œç›¸åŒæ•°é‡å‚æ•°çš„è·¯ç”±ä¸è¯·æ±‚ URL åŒ¹é…æ—¶ï¼Œä¼šæŒ‰æ·»åŠ åˆ° PageConventionCollection çš„é¡ºåºå¤„ç†è·¯ç”±ã€‚

å¦‚æœå¯èƒ½ï¼Œè¯·é¿å…ä¾èµ–äºå»ºç«‹çš„è·¯ç”±å¤„ç†é¡ºåºã€‚ é€šå¸¸ï¼Œè·¯ç”±ä¼šé€šè¿‡ URL åŒ¹é…é€‰æ‹©æ­£ç¡®è·¯ç”±ã€‚ å¦‚æœå¿…é¡»è®¾ç½®è·¯ç”± Order å±æ€§ä»¥ä¾¿æ­£ç¡®è·¯ç”±è¯·æ±‚ï¼Œåˆ™åº”ç”¨çš„è·¯ç”±æ–¹æ¡ˆå¯èƒ½ä¼šä½¿å®¢æˆ·ç«¯æ„Ÿåˆ°å›°æƒ‘å¹¶ä¸”éš¾ä»¥ç»´æŠ¤ã€‚ åº”è®¾æ³•ç®€åŒ–åº”ç”¨çš„è·¯ç”±æ–¹æ¡ˆã€‚ ç¤ºä¾‹åº”ç”¨éœ€è¦æ˜¾å¼è·¯ç”±å¤„ç†é¡ºåºä»¥ä½¿ç”¨å•ä¸ªåº”ç”¨æ¥æ¼”ç¤ºå‡ ä¸ªè·¯ç”±æ–¹æ¡ˆã€‚ ä½†æ˜¯ï¼Œåœ¨ç”Ÿäº§åº”ç”¨ä¸­åº”å°è¯•é¿å…è®¾ç½®è·¯ç”± Order çš„åšæ³•ã€‚




ä½¿ç”¨ AddPageRoute é…ç½®è·¯ç”±ï¼Œè¯¥è·¯ç”±æŒ‡å‘æŒ‡å®šé¡µé¢è·¯å¾„ä¸­çš„é¡µé¢ã€‚ ç”Ÿæˆçš„é¡µé¢é“¾æ¥ä½¿ç”¨æŒ‡å®šçš„è·¯ç”±ã€‚ AddPageRoute ä½¿ç”¨ AddPageRouteModelConvention å»ºç«‹è·¯ç”±ã€‚

ç¤ºä¾‹åº”ç”¨ä¸º Contact.cshtml åˆ›å»ºæŒ‡å‘ /TheContactPage çš„è·¯ç”±ï¼š

    options.Conventions.AddPageRoute("/Contact", "TheContactPage/{text?}");

è¿˜å¯åœ¨ /Contact ä¸­é€šè¿‡é»˜è®¤è·¯ç”±è®¿é—®é¡µé¢ã€‚

ç¤ºä¾‹åº”ç”¨é¡µé¢è‡ªå®šä¹‰è·¯ç”±å…è®¸ä½¿ç”¨å¯é€‰çš„ text è·¯ç”±æ®µ ({text?})ã€‚ è¯¥é¡µé¢è¿˜åœ¨å…¶ @page æŒ‡ä»¤ä¸­åŒ…å«æ­¤å¯é€‰æ®µï¼Œä»¥ä¾¿è®¿é—®è€…åœ¨ /Contact è·¯ç”±ä¸­è®¿é—®è¯¥é¡µé¢ï¼š

    @page "{text?}"
    @model ContactModel
    @{
        ViewData["Title"] = "Contact";
    }

    <h1>@ViewData["Title"]</h1>
    <h2>@Model.Message</h2>
    ...
    <p>@Model.RouteDataTextTemplateValue</p>



## ==âš¡ Sessions ä¼šè¯ç®¡ç†

HTTP æ˜¯æ— çŠ¶æ€çš„åè®®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTP è¯·æ±‚æ˜¯ä¸ä¿ç•™ç”¨æˆ·å€¼çš„ç‹¬ç«‹æ¶ˆæ¯ã€‚ åˆ©ç”¨ä¸åŒçš„å­˜å‚¨æœºåˆ¶ï¼Œå¯ä»¥ä¿ç•™ç”¨æˆ·åœ¨æ´»åŠ¨æœŸé—´çš„ä¼šè¯çŠ¶æ€ã€‚ 

    å­˜å‚¨æ–¹æ³•    å­˜å‚¨æœºåˆ¶
    Cookie  HTTP Cookieã€‚ å¯èƒ½åŒ…æ‹¬ä½¿ç”¨æœåŠ¡å™¨ç«¯åº”ç”¨ä»£ç å­˜å‚¨çš„æ•°æ®ã€‚
    Session State   HTTP Cookie å’ŒæœåŠ¡å™¨ç«¯åº”ç”¨ä»£ç 
    TempData    HTTP Cookie æˆ–ä¼šè¯çŠ¶æ€
    Query Strings   HTTP æŸ¥è¯¢å­—ç¬¦ä¸²
    Hidden Fields   HTTP çª—ä½“å­—æ®µ
    HttpContext.Items   æœåŠ¡å™¨ç«¯åº”ç”¨ä»£ç 
    Cache   æœåŠ¡å™¨ç«¯åº”ç”¨ä»£ç 

Cookie å­˜å‚¨æ‰€æœ‰è¯·æ±‚çš„æ•°æ®ã€‚ å› ä¸º Cookie æ˜¯éšæ¯ä¸ªè¯·æ±‚å‘é€çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„å¤§å°åº”è¯¥ä¿æŒåœ¨æœ€ä½é™åº¦ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œä»…æ ‡è¯†ç¬¦åº”å­˜å‚¨åœ¨ Cookie ä¸­ï¼Œè€Œæ•°æ®åˆ™ç”±åº”ç”¨å­˜å‚¨ã€‚ å¤§å¤šæ•°æµè§ˆå™¨ Cookie å¤§å°é™åˆ¶ä¸º 4096 ä¸ªå­—èŠ‚ã€‚ æ¯ä¸ªåŸŸä»…æœ‰æœ‰é™æ•°é‡çš„ Cookie å¯ç”¨ã€‚

ç”±äº Cookie æ˜“è¢«ç¯¡æ”¹ï¼Œå› æ­¤å®ƒä»¬å¿…é¡»ç”±æœåŠ¡å™¨è¿›è¡ŒéªŒè¯ã€‚ å®¢æˆ·ç«¯ä¸Šçš„ Cookie å¯èƒ½è¢«ç”¨æˆ·åˆ é™¤æˆ–è€…è¿‡æœŸã€‚ ä½†æ˜¯ï¼ŒCookie é€šå¸¸æ˜¯å®¢æˆ·ç«¯ä¸Šæœ€æŒä¹…çš„æ•°æ®æš‚ç•™å½¢å¼ã€‚

Cookie é€šå¸¸ç”¨äºä¸ªæ€§åŒ–è®¾ç½®ï¼Œå…¶ä¸­çš„å†…å®¹æ˜¯ä¸ºå·²çŸ¥ç”¨æˆ·å®šåˆ¶çš„ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»…æ ‡è¯†ç”¨æˆ·ï¼Œä½†ä¸å¯¹å…¶è¿›è¡Œèº«ä»½éªŒè¯ã€‚ Cookie å¯ä»¥å­˜å‚¨ç”¨æˆ·åã€å¸æˆ·åæˆ–å”¯ä¸€çš„ç”¨æˆ· IDï¼ˆä¾‹å¦‚ GUIDï¼‰ã€‚ Cookie å¯ç”¨äºè®¿é—®ç”¨æˆ·çš„ä¸ªæ€§åŒ–è®¾ç½®ï¼Œä¾‹å¦‚é¦–é€‰çš„ç½‘ç«™èƒŒæ™¯è‰²ã€‚

å‘å¸ƒ Cookie å’Œå¤„ç†éšç§é—®é¢˜æ—¶ï¼Œè¯·å‚é˜…æ¬§ç›Ÿä¸€èˆ¬æ•°æ®ä¿æŠ¤æ¡ä¾‹ (GDPR)ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ASP.NET Core ä¸­çš„ä¸€èˆ¬æ•°æ®ä¿æŠ¤æ¡ä¾‹ (GDPR) æ”¯æŒã€‚


ä¼šè¯çŠ¶æ€æ˜¯åœ¨ç”¨æˆ·æµè§ˆ Web åº”ç”¨æ—¶ç”¨æ¥å­˜å‚¨ç”¨æˆ·æ•°æ®çš„ ASP.NET Core æ–¹æ¡ˆã€‚ ä¼šè¯çŠ¶æ€ä½¿ç”¨åº”ç”¨ç»´æŠ¤çš„å­˜å‚¨æ¥ä¿å­˜å®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚çš„æ•°æ®ã€‚ ä¼šè¯æ•°æ®ç”±ç¼“å­˜æä¾›æ”¯æŒï¼Œå¹¶è¢«è§†ä¸ºä¸´æ—¶æ•°æ®ã€‚ ç«™ç‚¹åº”åœ¨æ²¡æœ‰ä¼šè¯æ•°æ®çš„æƒ…å†µä¸‹ç»§ç»­è¿è¡Œã€‚ å…³é”®åº”ç”¨ç¨‹åºæ•°æ®åº”å­˜å‚¨åœ¨ç”¨æˆ·æ•°æ®åº“ä¸­ï¼Œå¹¶ä»…ä½œä¸ºæ€§èƒ½ä¼˜åŒ–ç¼“å­˜åœ¨ä¼šè¯ä¸­ã€‚

SignalR åº”ç”¨ä¸æ”¯æŒä¼šè¯ï¼Œå› ä¸º SignalR ä¸­å¿ƒå¯èƒ½ç‹¬ç«‹äº HTTP ä¸Šä¸‹æ–‡æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼Œå½“ä¸­å¿ƒæ‰“å¼€çš„é•¿è½®è¯¢è¯·æ±‚è¶…å‡ºè¯·æ±‚çš„ HTTP ä¸Šä¸‹æ–‡çš„ç”Ÿå­˜æœŸæ—¶ï¼Œå¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚

ASP.NET Core é€šè¿‡å‘å®¢æˆ·ç«¯æä¾›åŒ…å«ä¼šè¯ ID çš„ Cookie æ¥ç»´æŠ¤ä¼šè¯çŠ¶æ€ã€‚ Cookie ä¼šè¯ IDï¼š

- ä¼šéšæ¯ä¸ªè¯·æ±‚å‘é€åˆ°åº”ç”¨ã€‚
- ç”±åº”ç”¨ç”¨äºæå–ä¼šè¯æ•°æ®ã€‚

ä¼šè¯çŠ¶æ€å…·æœ‰ä»¥ä¸‹è¡Œä¸ºï¼š

- ä¼šè¯ Cookie ç‰¹å®šäºæµè§ˆå™¨ã€‚ ä¼šè¯ä¸ä¼šè·¨æµè§ˆå™¨è¿›è¡Œå…±äº«ã€‚
- æµè§ˆå™¨ä¼šè¯ç»“æŸæ—¶åˆ é™¤ä¼šè¯ Cookieã€‚
- å¦‚æœæ”¶åˆ°è¿‡æœŸçš„ä¼šè¯ Cookieï¼Œåˆ™åˆ›å»ºä½¿ç”¨ç›¸åŒä¼šè¯ Cookie çš„æ–°ä¼šè¯ã€‚
- ä¸ä¼šä¿ç•™ç©ºä¼šè¯ã€‚ ä¼šè¯ä¸­å¿…é¡»è®¾ç½®äº†è‡³å°‘ä¸€ä¸ªå€¼ä»¥ä¿å­˜æ‰€æœ‰è¯·æ±‚çš„ä¼šè¯ã€‚ ä¼šè¯æœªä¿ç•™æ—¶ï¼Œä¸ºæ¯ä¸ªæ–°çš„è¯·æ±‚ç”Ÿæˆæ–°ä¼šè¯ IDã€‚
- åº”ç”¨åœ¨ä¸Šæ¬¡è¯·æ±‚åä¿ç•™ä¼šè¯çš„æ—¶é—´æœ‰é™ã€‚ åº”ç”¨è®¾ç½®ä¼šè¯è¶…æ—¶ï¼Œæˆ–è€…ä½¿ç”¨ 20 åˆ†é’Ÿçš„é»˜è®¤å€¼ã€‚ åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œä¼šè¯çŠ¶æ€é€‚åˆå­˜å‚¨ç”¨æˆ·æ•°æ®ï¼š
- ç‰¹å®šäºæŸä¸ªç‰¹å®šä¼šè¯ã€‚
- æ•°æ®ä¸éœ€è¦è·¨ä¼šè¯æ°¸ä¹…å­˜å‚¨ã€‚
- è°ƒç”¨ ISession.Clear å®ç°æˆ–è€…ä¼šè¯è¿‡æœŸæ—¶ï¼Œä¼šåˆ é™¤ä¼šè¯æ•°æ®ã€‚
- æ²¡æœ‰é»˜è®¤æœºåˆ¶å‘ŠçŸ¥å®¢æˆ·ç«¯æµè§ˆå™¨å·²å…³é—­æˆ–è€…å®¢æˆ·ç«¯ä¸Šçš„ä¼šè¯ Cookie è¢«åˆ é™¤æˆ–è¿‡æœŸçš„åº”ç”¨ä»£ç ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¯çŠ¶æ€ Cookie ä¸æ ‡è®°ä¸ºâ€œåŸºæœ¬â€ã€‚ é™¤éç«™ç‚¹è®¿é—®è€…å…è®¸è·Ÿè¸ªï¼Œå¦åˆ™ä¼šè¯çŠ¶æ€ä¸èµ·ä½œç”¨ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ASP.NET Core ä¸­çš„ä¸€èˆ¬æ•°æ®ä¿æŠ¤æ¡ä¾‹ï¼ˆGDPRï¼‰æ”¯æŒã€‚

è¯·å‹¿å°†æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨ä¼šè¯çŠ¶æ€ä¸­ã€‚ ç”¨æˆ·å¯èƒ½ä¸ä¼šå…³é—­æµè§ˆå™¨å¹¶æ¸…é™¤ä¼šè¯ Cookieã€‚ æŸäº›æµè§ˆå™¨ä¼šä¿ç•™æ‰€æœ‰æµè§ˆå™¨çª—å£ä¸­çš„æœ‰æ•ˆä¼šè¯ Cookieã€‚ ä¼šè¯å¯èƒ½ä¸é™äºå•ä¸ªç”¨æˆ·ã€‚ ä¸‹ä¸€ä¸ªç”¨æˆ·å¯èƒ½ç»§ç»­ä½¿ç”¨åŒä¸€ä¼šè¯ Cookie æµè§ˆåº”ç”¨ã€‚

å†…å­˜ä¸­ç¼“å­˜æä¾›ç¨‹åºåœ¨åº”ç”¨é©»ç•™çš„æœåŠ¡å™¨å†…å­˜ä¸­å­˜å‚¨ä¼šè¯æ•°æ®ã€‚ åœ¨æœåŠ¡å™¨åœºæ–¹æ¡ˆä¸­ï¼š

- ä½¿ç”¨ç²˜æ€§ä¼šè¯å°†æ¯ä¸ªä¼šè¯åŠ å…¥åˆ°å•ç‹¬æœåŠ¡å™¨ä¸Šçš„ç‰¹å®šåº”ç”¨å®ä¾‹ ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒAzure åº”ç”¨æœåŠ¡ä½¿ç”¨åº”ç”¨ç¨‹åºè¯·æ±‚è·¯ç”± (ARR) å¼ºåˆ¶å®æ–½ç²˜æ€§ä¼šè¯ã€‚ ç„¶è€Œï¼Œç²˜æ€§ä¼šè¯å¯èƒ½ä¼šå½±å“å¯ä¼¸ç¼©æ€§ï¼Œå¹¶ä½¿ Web åº”ç”¨æ›´æ–°å˜å¾—å¤æ‚ã€‚ æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Redis æˆ– SQL Server åˆ†å¸ƒå¼ç¼“å­˜ï¼Œå®ƒä»¬ä¸éœ€è¦ç²˜æ€§ä¼šè¯ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ASP.NET Core ä¸­çš„åˆ†å¸ƒå¼ç¼“å­˜ã€‚
- é€šè¿‡ IDataProtector åŠ å¯†ä¼šè¯ Cookieã€‚ å¿…é¡»æ­£ç¡®é…ç½®æ•°æ®ä¿æŠ¤ï¼Œä»¥åœ¨æ¯å°è®¡ç®—æœºä¸Šè¯»å–ä¼šè¯ Cookieã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ASP.NET Core æ•°æ®ä¿æŠ¤ å’Œå¯†é’¥å­˜å‚¨æä¾›ç¨‹åºã€‚


é…ç½®ä¼šè¯çŠ¶æ€ï¼ŒMicrosoft.AspNetCore.Session åŒ…ç”±æ¡†æ¶éšå¼åŒ…å«ï¼Œå®ƒæä¾›ç”¨äºç®¡ç†ä¼šè¯çŠ¶æ€çš„ä¸­é—´ä»¶ã€‚è‹¥è¦å¯ç”¨ä¼šè¯ä¸­é—´ä»¶ï¼ŒStartup å¿…é¡»åŒ…å«ï¼š

- ä»»ä¸€ IDistributedCache å®ç°å†…å­˜ç¼“å­˜ç”¨ä½œä¼šè¯åå¤‡å­˜å‚¨ã€‚
- å¯¹ ConfigureServices ä¸­ AddSession çš„è°ƒç”¨ã€‚
- å¯¹ Configure ä¸­ UseSession çš„è°ƒç”¨ã€‚

ä»¥ä¸‹ä»£ç æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ IDistributedCache çš„é»˜è®¤å†…å­˜ä¸­å®ç°è®¾ç½®å†…å­˜ä¸­ä¼šè¯æä¾›ç¨‹åºï¼š

    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddDistributedMemoryCache();

            services.AddSession(options =>
            {
                options.IdleTimeout = TimeSpan.FromSeconds(10);
                options.Cookie.HttpOnly = true;
                options.Cookie.IsEssential = true;
            });

            services.AddControllersWithViews();
            services.AddRazorPages();
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }
            else
            {
                app.UseExceptionHandler("/Home/Error");
                app.UseHsts();
            }

            app.UseHttpsRedirection();
            app.UseStaticFiles();

            app.UseRouting();

            app.UseAuthentication();
            app.UseAuthorization();

            app.UseSession();

            app.UseEndpoints(endpoints =>
            {
                endpoints.MapDefaultControllerRoute();
                endpoints.MapRazorPages();
            });
        }
    }

ä¸­é—´ä»¶çš„é¡ºåºå¾ˆé‡è¦ã€‚ åœ¨ UseRouting ä¹‹åå’Œ UseEndpoints ä¹‹å‰è°ƒç”¨ UseSessionã€‚ é…ç½®ä¼šè¯çŠ¶æ€åï¼ŒHttpContext.Session å¯ç”¨ï¼Œè°ƒç”¨ UseSession ä»¥å‰æ— æ³•è®¿é—® HttpContext.Sessionã€‚

åœ¨åº”ç”¨å·²ç»å¼€å§‹å†™å…¥åˆ°å“åº”æµä¹‹åï¼Œä¸èƒ½åˆ›å»ºæœ‰æ–°ä¼šè¯ Cookie çš„æ–°ä¼šè¯ã€‚ æ­¤å¼‚å¸¸è®°å½•åœ¨ Web æœåŠ¡å™¨æ—¥å¿—ä¸­ä½†ä¸æ˜¾ç¤ºåœ¨æµè§ˆå™¨ä¸­ã€‚


ä½¿ç”¨ HttpContext.Session ä» Razor Pages PageModel ç±»æˆ– MVC æ§åˆ¶å™¨ç±»è®¿é—®ä¼šè¯çŠ¶æ€ã€‚ æ­¤å±æ€§æ˜¯ ISession å®ç°ï¼Œæä¾›ç”¨äºè®¾ç½®å’Œæ£€ç´¢æ•´æ•°å’Œå­—ç¬¦ä¸²å€¼çš„è‹¥å¹²æ‰©å±•æ–¹æ³•ã€‚

ISession æ‰©å±•æ–¹æ³•ä½äº Microsoft.AspNetCore.Http å‘½åç©ºé—´ä¸­ï¼š

- Get(ISession, String)
- GetInt32(ISession, String)
- GetString(ISession, String)
- SetInt32(ISession, String, Int32)
- SetString(ISession, String, String)

ä»¥ä¸‹ç¤ºä¾‹åœ¨ Razor Pages é¡µä¸­æ£€ç´¢ IndexModel.SessionKeyName é”®çš„ä¼šè¯å€¼ï¼š

    @page
    @using Microsoft.AspNetCore.Http
    @model IndexModel

    ...

    Name: @HttpContext.Session.GetString(IndexModel.SessionKeyName)

ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•è®¾ç½®å’Œè·å–æ•´æ•°å’Œå­—ç¬¦ä¸²ï¼š


    public class IndexModel : PageModel
    {
        public const string SessionKeyName = "_Name";
        public const string SessionKeyAge = "_Age";
        const string SessionKeyTime = "_Time";

        public string SessionInfo_Name { get; private set; }
        public string SessionInfo_Age { get; private set; }

        public void OnGet()
        {
            // Requires: using Microsoft.AspNetCore.Http;
            if (string.IsNullOrEmpty(HttpContext.Session.GetString(SessionKeyName)))
            {
                HttpContext.Session.SetString(SessionKeyName, "The Doctor");
                HttpContext.Session.SetInt32(SessionKeyAge, 773);
            }

            var name = HttpContext.Session.GetString(SessionKeyName);
            var age = HttpContext.Session.GetInt32(SessionKeyAge);

å¿…é¡»å¯¹æ‰€æœ‰ä¼šè¯æ•°æ®è¿›è¡Œåºåˆ—åŒ–ä»¥å¯ç”¨åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆï¼Œå³ä½¿æ˜¯åœ¨ä½¿ç”¨å†…å­˜ä¸­ç¼“å­˜çš„æ—¶å€™ã€‚ å­—ç¬¦ä¸²å’Œæ•´æ•°åºåˆ—åŒ–ç¨‹åºç”± ISession çš„æ‰©å±•æ–¹æ³•æä¾›ã€‚ ç”¨æˆ·å¿…é¡»ä½¿ç”¨å¦ä¸€ç§æœºåˆ¶ï¼ˆä¾‹å¦‚ JSONï¼‰åºåˆ—åŒ–å¤æ‚ç±»å‹ã€‚

ä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹ä»£ç åºåˆ—åŒ–å¯¹è±¡ï¼š

    public static class SessionExtensions
    {
        public static void Set<T>(this ISession session, string key, T value)
        {
            session.SetString(key, JsonSerializer.Serialize(value));
        }

        public static T Get<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            return value == null ? default : JsonSerializer.Deserialize<T>(value);
        }
    }

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ SessionExtensions ç±»è®¾ç½®å’Œè·å–å¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼š

    // Requires SessionExtensions from sample download.
    if (HttpContext.Session.Get<DateTime>(SessionKeyTime) == default)
    {
        HttpContext.Session.Set<DateTime>(SessionKeyTime, currentTime);
    }


## ==âš¡ HttpContext æ•°æ®è®¿é—®
https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpcontext
https://gunnarpeipman.com/aspnet-core-request-body/
https://www.cnblogs.com/savorboard/p/aspnetcore-mvc-startup.html
https://www.cnblogs.com/savorboard/p/aspnetcore-mvc-routing-action.html
https://www.cnblogs.com/savorboard/p/aspnetcore-identity.html
https://blog.51cto.com/kiujyhgt/1916908


ASP.NET Core åº”ç”¨é€šè¿‡ IHttpContextAccessor æ¥å£åŠå…¶é»˜è®¤å®ç° HttpContextAccessor è®¿é—® HttpContextã€‚ åªæœ‰åœ¨éœ€è¦è®¿é—®æœåŠ¡å†…çš„ HttpContext æ—¶ï¼Œæ‰æœ‰å¿…è¦ä½¿ç”¨ IHttpContextAccessorã€‚

æ³¨æ„ï¼Œæœ‰ä¸¤ä¸ª HttpRequestï¼Œè¿™é‡ŒæŒ‡çš„æ—¶ ASP.Net Core å‘½åç©ºé—´ä¸‹çš„ï¼š

- System.Web.HttpRequest
- Microsoft.AspNetCore.Http.HttpRequest

HttpContext å½’å±äº ASP.NET Core APIï¼Œä¸æ˜¯ .Net Core APIï¼Œä½¿ç”¨å®˜æ–¹ API å‚è€ƒæ–‡æ¡£éœ€è¦æ³¨æ„ã€‚

ASP.NET MVC Web API æ§åˆ¶å™¨ä¸­ï¼ŒHttpRequest ç»è¿‡ä¸€æ•´å¥—é€»è¾‘é¢„å¤„ç†ï¼Œé¦–å…ˆæ˜¯ RouteContext è·¯ç”±å¤„ç†ï¼Œç„¶åå†æµå‘å…·ä½“çš„æ§åˆ¶å™¨ã€‚åœ¨æ§åˆ¶å™¨æ–¹æ³•æ‰§è¡Œå‰ï¼Œç»ç”±ä¾èµ–æ³¨å…¥çš„å‰æœŸå¯¹è±¡å°±å…ˆå¤„ç†å¥½æ•°æ®ï¼ŒåŒ¹é…å¥½æ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°åˆ—è¡¨å†è½¬é€è¿‡æ¥ã€‚

è¯•åˆ†æï¼Œå®¢æˆ·ç«¯å¾€æœåŠ¡å™¨å‘é€ä¸€æ¡ JSON ä¿¡æ¯ï¼ŒMVC é¦–å…ˆå¯ä»¥æ ¹æ® URL å’Œ è·¯ç”±è®¾ç½®åˆ¤æ–­æ‰€å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œä½†æ˜¯ï¼Œåœ¨æ§åˆ¶å™¨æ–¹æ³• Action æ‰§è¡Œå‰è¿˜éœ€è¦ç»è¿‡å…¶å®ƒ Filter å±‚å±‚è¿‡æ»¤ï¼ŒåŒ…æ‹¬ AuthorizationFilterã€ActionFilter ç­‰ï¼Œç„¶åå†æœ‰ ActionInvoker å»æ‰§è¡Œã€‚

æ§åˆ¶å™¨ä¸­ Action å‚æ•°å¯ä»¥é€šè¿‡ç‰¹æ€§ä¿®é¥°æ¥å®ç°æ•°æ®å¤„ç†ï¼š

- [FromQuery]   ä»æŸ¥è¯¢å­—ç¬¦ä¸²è·å–å€¼ã€‚
- [FromRoute]   ä»è·¯ç”±æ•°æ®ä¸­è·å–å€¼ã€‚
- [FromForm]    ä»å·²å‘å¸ƒçš„è¡¨å•å­—æ®µä¸­è·å–å€¼ã€‚
- [FromBody]    ä»è¯·æ±‚æ­£æ–‡ä¸­è·å–å€¼ã€‚
- [FromHeader]  ä» HTTP æ ‡å¤´ä¸­è·å–å€¼ã€‚

å‡å¦‚ä½¿ç”¨äº† `[FromBody]` ç‰¹æ€§ä¿®é¥°å‚æ•°åˆ—è¡¨ï¼Œé‚£ä¹ˆ Body æ•°æ®å°±ä¼šè¢«æ¶ˆè´¹æ‰ï¼Œæˆ–è€…é€šè¿‡å®šä¹‰ä¸­é—´ä»¶ï¼Œåœ¨æ•°æ®æ¶ˆè´¹å‰è¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥ç›´æ¥åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ Request.Body è¯»ä¸åˆ°æ•°æ®ï¼ŒPosition æˆ– Length å±æ€§ä¹Ÿä¸å¯ç”¨ï¼Œå¯ä»¥è¯•è¯• curl å‘é€æµ‹è¯•æ•°æ®ï¼Œå†ä¿®æ”¹å‚æ•°åˆ—è¡¨çš„ç‰¹æ€§ä¿®é¥°ï¼š

    curl -H "Content-Type:application/json" -d "{""Id"":""122"", ""Text"":""name"", ""Description"":""anything""}" -X POST "http://127.0.0.1:5001/api/item?Text=name&Description=xyz"

å¦å¤–ï¼Œæ ¹æ®ä½¿ç”¨çš„æ§åˆ¶å™¨ç±»å‹ä¸åŒï¼Œè¯»å–æ•°æ®çš„æ–¹å¼ä¹Ÿæœ‰å·®å¼‚ï¼š

- ApiController.Request è®¿é—® HttpRequestMessage.ReadAsStringAsync()ï¼›
- ControllerBase.Request è®¿é—® HttpRequest å¯¹è±¡ï¼›

ä»¥ä¸‹æ˜¯æ•°æ®è¯»å–å‚è€ƒï¼š

    var sr = new StreamReader(HttpContext.Request.Body);
    string body = await sr.ReadToEndAsync();

    Request.EnableBuffering();
    Request.Body.Seek(0, SeekOrigin.Begin);
    Request.Body.Position = 0;
    Request.Body.CopyToAsync(Console.OpenStandardOutput());

æ‰§è¡Œ ControllerBae.EnableBuffering æ–¹æ³•æ¿€æ´»å›è¯»ï¼Œ ASP.NET Core 2.0 æ—§ç‰ˆæœ¬æ˜¯ EnableRewind æ–¹æ³•ï¼š

    Request.EnableRewind();
    using (var reader = new StreamReader(Request.Body))
    {
        var body = reader.ReadToEnd();
        ...
        Request.Body.Seek(0, SeekOrigin.Begin);
        body = reader.ReadToEnd();
    }
 
åˆ©ç”¨ MemoryStream é‡å¤è¯»å–

    using (var mem = new MemoryStream())
    using (var reader = new StreamReader(mem))
    {
        Request.Body.CopyTo(mem);
        var body = reader.ReadToEnd();
        ...
        mem.Seek(0, SeekOrigin.Begin);
        body = reader.ReadToEnd();
    }


é€šè¿‡ Razor Pages ä½¿ç”¨ HttpContext
Razor Pages PageModel å…¬å¼€ HttpContext å±æ€§ï¼š

    public class AboutModel : PageModel
    {
        public string Message { get; set; }

        public void OnGet()
        {
            Message = HttpContext.Request.PathBase;
        }
    }

é€šè¿‡ Razor è§†å›¾ä½¿ç”¨ HttpContext
Razor è§†å›¾é€šè¿‡è§†å›¾ä¸Šçš„ RazorPage.Context å±æ€§ç›´æ¥å…¬å¼€ HttpContextã€‚ ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨ Windows èº«ä»½éªŒè¯æ£€ç´¢ Intranet åº”ç”¨ä¸­çš„å½“å‰ç”¨æˆ·åï¼š

    @{
        var username = Context.User.Identity.Name;
        
        ...
    }

é€šè¿‡æ§åˆ¶å™¨ä½¿ç”¨ HttpContext
æ§åˆ¶å™¨å…¬å¼€ ControllerBase.HttpContext å±æ€§ï¼š

    public class HomeController : Controller
    {
        public IActionResult About()
        {
            var pathBase = HttpContext.Request.PathBase;

            ...

            return View();
        }
    }

é€šè¿‡ä¸­é—´ä»¶ä½¿ç”¨ HttpContext
ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶ç»„ä»¶æ—¶ï¼ŒHttpContext ä¼ é€’åˆ° Invoke æˆ– InvokeAsync æ–¹æ³•ï¼Œåœ¨ä¸­é—´ä»¶é…ç½®åå¯ä¾›è®¿é—®ï¼š

    public class MyCustomMiddleware
    {
        public Task InvokeAsync(HttpContext context)
        {
            ...
        }
    }

é€šè¿‡è‡ªå®šä¹‰ç»„ä»¶ä½¿ç”¨ HttpContext
å¯¹äºéœ€è¦è®¿é—® HttpContext çš„å…¶ä»–æ¡†æ¶å’Œè‡ªå®šä¹‰ç»„ä»¶ï¼Œå»ºè®®ä½¿ç”¨å†…ç½®çš„ä¾èµ–é¡¹æ³¨å…¥å®¹å™¨æ¥æ³¨å†Œä¾èµ–é¡¹ã€‚ ä¾èµ–é¡¹æ³¨å…¥å®¹å™¨å‘ä»»æ„ç±»æä¾› IHttpContextAccessorï¼Œä»¥ä¾›ç±»åœ¨è‡ªå·±çš„æ„é€ å‡½æ•°ä¸­å°†å®ƒå£°æ˜ä¸ºä¾èµ–é¡¹ï¼š

    public void ConfigureServices(IServiceCollection services)
    {
         services.AddControllersWithViews();
         services.AddHttpContextAccessor();
         services.AddTransient<IUserRepository, UserRepository>();
    }

å¦‚ä¸‹ç¤ºä¾‹ä¸­ï¼ŒUserRepository å£°æ˜è‡ªå·±å¯¹ IHttpContextAccessor çš„ä¾èµ–ã€‚å½“ä¾èµ–é¡¹æ³¨å…¥å®¹å™¨è§£æä¾èµ–é“¾å¹¶åˆ›å»º UserRepository å®ä¾‹æ—¶ï¼Œå°±ä¼šæ³¨å…¥ä¾èµ–é¡¹ã€‚

    public class UserRepository : IUserRepository
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public UserRepository(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public void LogCurrentUser()
        {
            var username = _httpContextAccessor.HttpContext.User.Identity.Name;
            service.LogAccessRequest(username);
        }
    }


ä»åå°çº¿ç¨‹è®¿é—® HttpContext
HttpContext ä¸æ˜¯çº¿ç¨‹å®‰å…¨å‹ã€‚ åœ¨å¤„ç†è¯·æ±‚ä¹‹å¤–è¯»å–æˆ–å†™å…¥ HttpContext çš„å±æ€§å¯èƒ½ä¼šå¯¼è‡´ NullReferenceExceptionã€‚

å¦‚æœåº”ç”¨ç”Ÿæˆå¶å‘çš„ NullReferenceException é”™è¯¯ï¼Œè¯·è¯„å®¡å¯åŠ¨åå°å¤„ç†çš„éƒ¨åˆ†ä»£ç ï¼Œæˆ–è€…åœ¨è¯·æ±‚å®Œæˆåç»§ç»­å¤„ç†çš„éƒ¨åˆ†ä»£ç ã€‚ æŸ¥æ‰¾è¯¸å¦‚å°†æ§åˆ¶å™¨æ–¹æ³•å®šä¹‰ä¸º async void çš„é”™è¯¯ã€‚
è¦ä½¿ç”¨ HttpContext æ•°æ®å®‰å…¨åœ°æ‰§è¡Œåå°å·¥ä½œï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å¤åˆ¶æ‰€éœ€çš„æ•°æ®ã€‚
- å°†å¤åˆ¶çš„æ•°æ®ä¼ é€’ç»™åå°ä»»åŠ¡ã€‚

è¦é¿å…ä¸å®‰å…¨ä»£ç ï¼Œè¯·å‹¿å°† HttpContext ä¼ é€’ç»™æ‰§è¡Œåå°å·¥ä½œçš„æ–¹æ³•ã€‚ è€Œæ˜¯ä¼ é€’æ‰€éœ€è¦çš„æ•°æ®ã€‚ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œè°ƒç”¨ SendEmailCoreï¼Œå¼€å§‹å‘é€ç”µå­é‚®ä»¶ã€‚ å°† correlationId ä¼ é€’åˆ° SendEmailCoreï¼Œè€Œä¸æ˜¯ HttpContextã€‚ ä»£ç æ‰§è¡Œä¸ä¼šç­‰å¾… SendEmailCore å®Œæˆï¼š

    public class EmailController : Controller
    {
        public IActionResult SendEmail(string email)
        {
            var correlationId = HttpContext.Request.Headers["x-correlation-id"].ToString();

            _ = SendEmailCore(correlationId);

            return View();
        }

        private async Task SendEmailCore(string correlationId)
        {
            ...
        }
    }

Blazor å’Œå…±äº«çŠ¶æ€

Blazor æœåŠ¡å™¨åº”ç”¨ä½äºæœåŠ¡å™¨å†…å­˜ä¸­ã€‚ è¿™æ„å‘³ç€åŒä¸€è¿›ç¨‹ä¸­æ‰˜ç®¡äº†å¤šä¸ªåº”ç”¨ã€‚ å¯¹äºæ¯ä¸ªåº”ç”¨ä¼šè¯ï¼ŒBlazor ä¼šå¯åŠ¨å…·æœ‰å…¶è‡ªå·±çš„ DI å®¹å™¨ä½œç”¨åŸŸçš„çº¿è·¯ã€‚ è¿™æ„å‘³ç€ï¼Œæ¯ä¸ª Blazor ä¼šè¯çš„ä½œç”¨åŸŸå†…æœåŠ¡éƒ½æ˜¯å”¯ä¸€çš„ã€‚

æˆ‘ä»¬ä¸å»ºè®®åŒä¸€æœåŠ¡å™¨ä¸Šçš„åº”ç”¨å…±äº«ä½¿ç”¨å•ä¸€å®ä¾‹æœåŠ¡çš„çŠ¶æ€ï¼Œé™¤éé‡‡å–äº†æå…¶è°¨æ…çš„æªæ–½ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¸¦æ¥å®‰å…¨æ¼æ´ï¼Œå¦‚è·¨çº¿è·¯æ³„éœ²ç”¨æˆ·çŠ¶æ€ã€‚

å¦‚æœæœ‰çŠ¶æ€çš„å•ä¸€å®ä¾‹æœåŠ¡æ˜¯ä¸“é—¨ä¸º Blazor åº”ç”¨è®¾è®¡çš„ï¼Œåˆ™å¯ä»¥åœ¨è¯¥åº”ç”¨ä¸­ä½¿ç”¨è¿™äº›æœåŠ¡ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ç”¨æˆ·æ— æ³•æ§åˆ¶ä½¿ç”¨å“ªäº›ç¼“å­˜å¯†é’¥ï¼Œåˆ™å¯ä»¥å°†å†…å­˜ç¼“å­˜ç”¨ä½œå•ä¸€å®ä¾‹ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªå¯†é’¥æ¥è®¿é—®ç»™å®šçš„æ¡ç›®ã€‚

å¦å¤–ï¼Œå‡ºäºå®‰å…¨åŸå› ï¼Œä¸å¾—åœ¨ Blazor åº”ç”¨ä¸­ä½¿ç”¨ IHttpContextAccessorã€‚ Blazor åº”ç”¨åœ¨ ASP.NET Core ç®¡é“çš„ä¸Šä¸‹æ–‡ä¹‹å¤–è¿è¡Œï¼Œå¹¶ä¸”ä¸ä¿è¯ HttpContext åœ¨ IHttpContextAccessor å†…å¯ç”¨ï¼Œä¹Ÿä¸èƒ½ä¿è¯ä¿å­˜å¯åŠ¨ Blazor åº”ç”¨çš„ä¸Šä¸‹æ–‡ã€‚

è‹¥è¦å‘ Blazor åº”ç”¨ä¼ é€’è¯·æ±‚çŠ¶æ€ï¼Œå»ºè®®åœ¨åˆæ¬¡å‘ˆç°åº”ç”¨æ—¶é€šè¿‡ä¼ é€’åˆ°æ ¹ç»„ä»¶çš„å‚æ•°è¿›è¡Œä¼ é€’ï¼š

- ä½¿ç”¨è¦ä¼ é€’åˆ° Blazor åº”ç”¨çš„æ‰€æœ‰æ•°æ®å®šä¹‰ç±»ã€‚
- ä½¿ç”¨ç›®å‰å¯ç”¨çš„ HttpContext åœ¨ Razor é¡µä¸­å¡«å……è¯¥æ•°æ®ã€‚
- å°†æ•°æ®ä½œä¸ºä¼ é€’ç»™æ ¹ç»„ä»¶ï¼ˆåº”ç”¨ï¼‰çš„å‚æ•°ä¼ é€’ç»™ Blazor åº”ç”¨ã€‚
- åœ¨æ ¹ç»„ä»¶ä¸­å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºä¿å­˜å³å°†ä¼ é€’ç»™åº”ç”¨çš„æ•°æ®ã€‚
- åœ¨åº”ç”¨ä¸­ä½¿ç”¨ç”¨æˆ·ç‰¹å®šçš„æ•°æ®ï¼›æˆ–è€…ï¼Œå°†è¯¥æ•°æ®å¤åˆ¶åˆ° OnInitializedAsync ä¸­çš„ä½œç”¨åŸŸå†…çš„æœåŠ¡ï¼Œä»¥ä¾¿å¯ä»¥è·¨åº”ç”¨ä½¿ç”¨è¯¥æ•°æ®ã€‚


## ==âš¡ Middleware ä¸­é—´ä»¶

ä¸­é—´ä»¶æ˜¯ä¸€ç§è£…é…åˆ°åº”ç”¨ç®¡é“ä»¥å¤„ç†è¯·æ±‚å’Œå“åº”çš„è½¯ä»¶ã€‚ ASP.NET Core æä¾›äº†ä¸€ç»„ä¸°å¯Œçš„å†…ç½®ä¸­é—´ä»¶ç»„ä»¶ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦å†™å…¥è‡ªå®šä¹‰ä¸­é—´ä»¶ã€‚

ä¸­é—´ä»¶ Middleware æ˜¯ ASP.NET Core ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚æ‰€è°“ä¸­é—´ä»¶å°±æ˜¯åµŒå…¥åˆ°åº”ç”¨ç®¡é“ä¸­ç”¨äºå¤„ç†è¯·æ±‚å’Œå“åº”çš„ä¸€æ®µä»£ç ï¼Œå®¢æˆ·ç«¯è¯·æ±‚é€è¾¾æœåŠ¡å™¨åå°±è¿›å…¥ä¸€æ¡é•¿é•¿çš„å¤„ç†ç®¡é“ä¸­ï¼Œå¯ä»¥ç»™ç®¡é“æ³¨å†Œä¸­é—´ä»¶ä»¥å¤„ç†å®¢æˆ·çš„è¯·æ±‚ï¼Œå¤šä¸ªä¸­é—´é€šè¿‡ä¸€æ¡è°ƒç”¨é“¾ä¾æ¬¡æ‰§è¡Œï¼Œä»¥ä¸‹çš„ next æ–¹æ³•å°±æ˜¯ç”¨æ¥è°ƒç”¨ç®¡é“ä¸­å…¶å®ƒä¸­é—´ä»¶çš„æ–¹æ³•ã€‚

ä¸­é—´ä»¶åœ¨è¯·æ±‚å¤„ç†æµç¨‹ä¸­ä½“ç°ä¸º `IApplicationBuilder.Use(Func<RequestDelegate,RequestDelegate>)` ï¼Œ å³ä¸€ä¸ª Func æ³›å‹å§”æ‰˜å¯¹è±¡ï¼Œè¿™ä¸ªå§”æ‰˜å‡ºç°äº†ä¸¤ä¸ª RequestDelegate ä»£è¡¨ä¼ å…¥å§”æ‰˜æ–¹æ³•çš„å‚æ•°ï¼Œåªæœ‰æœ€åä¸€ä¸ªæ˜¯å§”æ‰˜å‡½æ•°çš„è¿”å›ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ Use æ–¹æ³•æ³¨å†Œçš„çš„æ˜¯ä¸€ä¸ªå§”æ‰˜å¯¹è±¡ï¼Œè¢«å§”æ‰˜çš„å‡½æ•°æ¥æ”¶ä¸€ä¸ª RequestDelegate ä½œä¸ºä¼ å…¥å‚æ•°ï¼ŒåŒæ—¶å®ƒåˆè¿”å›ä¸€ä¸ª RequestDelegate å¯¹è±¡ï¼š

    public delegate System.Threading.Tasks.Task RequestDelegate(HttpContext context);

æ ¹æ® Microsoft.AspNetCore.Http å®šä¹‰ï¼ŒRequestDelegate å§”æ‰˜çš„æ˜¯ä¼ å…¥ HttpContext ä¸”è¿”å› Task çš„å‡½æ•°,è¿™æ˜¯å¼‚æ­¥æ“ä½œçš„ä»»åŠ¡ï¼Œè¿™é‡Œæœ‰ç‚¹ç»•ã€‚é‡æ–°ç†ä¸€ä¸‹ï¼Œ `IApplicationBuilder.Use()` æ³¨å†Œä¸€ä¸ªå§”æ‰˜å¯¹è±¡ï¼Œè¿™ä¸ªå§”æ‰˜å¯¹è±¡çš„å…¥å‚å‡ºå‚éƒ½æ˜¯ `RequestDelegate` å§”æ‰˜å¯¹è±¡ã€‚

ä»¥ä¸‹å‚è€ƒä»£ç å±•ç¤ºäº†ä¸­é—´ä»¶çš„å§”æ‰˜å®ç°ï¼Œä½¿ç”¨å¼‚æ­¥ lambda ï¼Œå³ `new RequestDelegate(async (context) => {...})` å®ç° middleware è¿”å›çš„ RequestDelegate å§”æ‰˜å¯¹è±¡ã€‚åŒæ—¶ï¼Œapp.Use(middleware) æ¯”å¦ä¸€ä¸ªå§”ä¸­é—´ä»¶æ³¨å†Œè¦æ—©ï¼Œæœ‰ä¼˜å…ˆæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡ Headers.Append() æ–¹æ³•æ·»åŠ å“åº”å¤´æµ‹è¯•ã€‚ middler è¿™é‡Œå…ˆæ‰§è¡Œäº† `await next(context)` è¿™æ˜¯å› ä¸ºåé¢è¦å¾€ Response.Body å†™æ•°æ®ï¼Œä¸€æ—¦æ‰§è¡Œåé¢çš„ä¸­é—´ä»¶å°±ä¸èƒ½å†™å“åº”å¤´ä¿¡æ¯ï¼ŒåŒ…æ‹¬é»˜è®¤çš„ StatusCode éƒ½å†™ä¸äº†ã€‚å¯ä»¥æ³¨è§£æ‰ next() çš„æ‰§è¡Œï¼Œçœ‹çœ‹åé¢æ³¨å†Œçš„ä¸­é—´ä»¶æ˜¯å¦ä¼šæ‰§è¡Œï¼š


    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore; // WebHost
    using Microsoft.AspNetCore.Hosting; // IWebHost IHostBuilder
    using Microsoft.AspNetCore.Http; // Extension Methods: WriteAsync

    public class ASPNET
    {
        // IApplicationBuilder.Use( Func<RequestDelegate,RequestDelegate> )
        // public delegate Task RequestDelegate(HttpContext context);
        static Func<RequestDelegate,RequestDelegate> middleware = delegate (RequestDelegate next)
            {
                return new RequestDelegate(async (context) =>
                {
                    // Call the next delegate/middleware in the pipeline
                    await next(context);
                    context.Response.Headers.Append("Request-Delegate", DateTime.Now.ToString("hh:mm:ss ffff"));
                    if (!context.Request.Path.ToString().StartsWith("/welcome"))
                    {
                        await context.Response.WriteAsync(@"
                            <script>alert(""Now server will redirect to /welcome "");location=""/welcome"";</script>
                            ");
                        // context.Response.Redirect("/welcome/Hi!");
                    }
                    await context.Response.WriteAsync("<h1>Hello World!</h1>");
                });
            };

        public static void Main()
        {
            using (IWebHost host = WebHost.StartWith("http://localhost:8080", app => {

                app.Use(middleware);

                app.Use(next => async (context) =>
                {
                    await next(context);
                    context.Response.StatusCode = 200;
                    var cultureQuery = context.Request.Query["culture"];
                    Console.WriteLine($"culture test {cultureQuery}");
                    await context.Response.WriteAsync($"<p>Hi! {cultureQuery}</p>");
                });

                }))
            {
                Console.WriteLine("Use Ctrl-C to shut down the host...");
                host.WaitForShutdown();
            }
        }

    }

ä½¿ç”¨ curl å·¥å…·æµ‹è¯•ï¼Œä½¿ç”¨é€‰é¡¹ -I å•ç‹¬æ˜¾ç¤ºå“åº”å¤´ï¼Œ-i å“åº”å¤´åŠ å†…å®¹ï¼š

    curl -I http://localhost:8080/?culture=zh-CN
    curl -i http://localhost:8080/?culture=zh-CN
    curl http://localhost:8080/?culture=zh-CN

å°è¯•ä½¿ç”¨ MSBuild çš„ CSC ç¼–è¯‘å™¨ï¼Œéœ€è¦æŒ‡å®š ASP.Net Core å„ä¸ªä¾èµ–åŒ…ï¼Œæ²¡æ¡ using æŒ‡ä»¤åŸºæœ¬å¯¹åº”ä¸€ä¸ª DLL å¼•ç”¨ï¼š

    csc /lib:"C:\Program Files\dotnet\sdk\3.1.300"  /lib:"C:\Program Files\dotnet\sdk\3.1.300\Microsoft\Microsoft.NET.Build.Extensions\net471\lib" /lib:"C:\Program Files\dotnet\shared\Microsoft.NETCore.App\3.1.4" /lib:"C:\Program Files\dotnet\packs\Microsoft.AspNetCore.App.Ref\3.1.2\ref\netcoreapp3.1" /reference:Microsoft.AspNetCore.dll /reference:Microsoft.AspNetCore.Hosting.dll /reference:Microsoft.AspNetCore.Hosting.Abstractions.dll /reference:Microsoft.AspNetCore.Http.Abstractions.dll /reference:System.Runtime.dll /reference:System.Net.Http.dll coding.cs


é€šå¸¸ï¼Œä¸­é—´ä»¶å°è£…åœ¨ç±»ä¸­ï¼Œå¹¶ä¸”é€šè¿‡æ‰©å±•æ–¹æ³•å…¬å¼€ã€‚ è¯·è€ƒè™‘ä»¥ä¸‹ä¸­é—´ä»¶ç¤ºä¾‹ä»£ç ï¼Œç”¨äºæ¼”ç¤ºåˆ›å»ºä¸­é—´ä»¶ç»„ä»¶ï¼Œè¯¥ä¸­é—´ä»¶é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²è®¾ç½®å½“å‰è¯·æ±‚çš„åŒºåŸŸæ€§ï¼š

    using System.Globalization;
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Builder;

    public class Startup
    {
        public void Configure(IApplicationBuilder app)
        {
            app.Use(async (context, next) =>
            {
                var cultureQuery = context.Request.Query["culture"];
                if (!string.IsNullOrWhiteSpace(cultureQuery))
                {
                    var culture = new CultureInfo(cultureQuery);

                    CultureInfo.CurrentCulture = culture;
                    CultureInfo.CurrentUICulture = culture;
                }

                // Call the next delegate/middleware in the pipeline
                await next();
            });

            app.Run(async (context) =>
            {
                await context.Response.WriteAsync(
                    $"Hello {CultureInfo.CurrentCulture.DisplayName}");
            });

        }
    }

é€šè¿‡ URL ä¼ å…¥åŒºåŸŸæ€§æµ‹è¯•ä¸­é—´ä»¶ï¼š

    https://localhost:5001/?culture=no
    https://localhost:5001/?culture=es-ES
    https://localhost:5001/?culture=zh-CN

å°†ä¸Šé¢çš„ä¸­é—´ä»¶æ‰˜ç®¡ç¤ºä¾‹ä»£ç è½¬æ¢ä¸ºç±»å®ç°ï¼š

    using Microsoft.AspNetCore.Http;
    using System.Globalization;
    using System.Threading.Tasks;

    namespace Culture
    {
        public class RequestCultureMiddleware
        {
            private readonly RequestDelegate _next;

            public RequestCultureMiddleware(RequestDelegate next)
            {
                _next = next;
            }

            public async Task InvokeAsync(HttpContext context)
            {
                var cultureQuery = context.Request.Query["culture"];
                if (!string.IsNullOrWhiteSpace(cultureQuery))
                {
                    var culture = new CultureInfo(cultureQuery);

                    CultureInfo.CurrentCulture = culture;
                    CultureInfo.CurrentUICulture = culture;
                    context.Response.Redirect($"/lang/{cultureQuery}");

                }

                // Call the next delegate/middleware in the pipeline
                await _next(context);
            }
        }
    }

ä¸­é—´ä»¶ç±»å¿…é¡»åŒ…æ‹¬ï¼š

- å…·æœ‰ç±»å‹ä¸º RequestDelegate çš„å‚æ•°çš„å…¬å…±æ„é€ å‡½æ•°ã€‚
- åä¸º Invoke æˆ– InvokeAsync çš„å…¬å…±æ–¹æ³•ã€‚ æ­¤æ–¹æ³•å¿…é¡»ï¼š
    - è¿”å› Taskã€‚
    - æ¥å—ç±»å‹ HttpContext çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

æ„é€ å‡½æ•°å’Œ Invoke/InvokeAsync çš„å…¶ä»–å‚æ•°ç”±ä¾èµ–å…³ç³»æ³¨å…¥ (DI) å¡«å……ã€‚

ä¸­é—´ä»¶åº”é€šè¿‡åœ¨å…¶æ„é€ å‡½æ•°ä¸­å…¬å¼€å…¶ä¾èµ–é¡¹æ¥éµå¾ªæ˜¾å¼ä¾èµ–é¡¹åŸåˆ™ã€‚ åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºç”Ÿå­˜æœŸ æ„é€ ä¸€æ¬¡ä¸­é—´ä»¶ã€‚ å¦‚æœéœ€è¦ä¸è¯·æ±‚ä¸­çš„ä¸­é—´ä»¶å…±äº«æœåŠ¡ï¼Œè¯·å‚é˜…æŒ‰è¯·æ±‚ä¸­é—´ä»¶ä¾èµ–é¡¹éƒ¨åˆ†ã€‚

ä¸­é—´ä»¶ç»„ä»¶å¯é€šè¿‡æ„é€ å‡½æ•°å‚æ•°ä»ä¾èµ–å…³ç³»æ³¨å…¥ (DI) è§£æå…¶ä¾èµ–é¡¹ã€‚ UseMiddleware<T> ä¹Ÿå¯ç›´æ¥æ¥å—å…¶ä»–å‚æ•°ã€‚

ç”±äºä¸­é—´ä»¶æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶æ„é€ çš„ï¼Œè€Œä¸æ˜¯æŒ‰è¯·æ±‚æ„é€ çš„ï¼Œå› æ­¤åœ¨æ¯ä¸ªè¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œä¸­é—´ä»¶æ„é€ å‡½æ•°ä½¿ç”¨çš„èŒƒå›´å†… ç”Ÿå­˜æœŸæœåŠ¡ä¸ä¸å…¶ä»–ä¾èµ–å…³ç³»æ³¨å…¥ç±»å‹å…±äº«ã€‚ å¦‚æœå¿…é¡»åœ¨ä¸­é—´ä»¶å’Œå…¶ä»–ç±»å‹ä¹‹é—´å…±äº« IServiceScope ä½œç”¨åŸŸæœåŠ¡ï¼Œè¯·å°†è¿™äº›æœåŠ¡æ·»åŠ åˆ° Invoke æ–¹æ³•çš„ç­¾åã€‚ Invoke æ–¹æ³•å¯æ¥å—ç”±ä¾èµ–æ³¨å…¥å¡«å……çš„å…¶ä»–å‚æ•°ï¼š

    public class CustomMiddleware
    {
        private readonly RequestDelegate _next;

        public CustomMiddleware(RequestDelegate next)
        {
            _next = next;
        }

        // IMyScopedService is injected into Invoke
        public async Task Invoke(HttpContext httpContext, IMyScopedService svc)
        {
            svc.MyProperty = 1000;
            await _next(httpContext);
        }
    }

HttpContext å¯¹è±¡åŒ…å«äº†å½“å‰ HHTP è¯·æ±‚çš„åŒæ–¹çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸­é—´ä»¶å¯ä»¥é€šè¿‡æ§åˆ¶ `_next()` çš„è°ƒç”¨æ¥å†³å®š HTTP è¯·æ±‚çš„æµç¨‹ç»ˆæ­¢ä¸å¦ã€‚


ä»¥ä¸‹æ‰©å±•æ–¹æ³•é€šè¿‡ IApplicationBuilder å…¬å¼€ä¸­é—´ä»¶ï¼Œå‚è€ƒ C# æ‰©å±•æ–¹æ³•è¯­æ³•ï¼š

    using Microsoft.AspNetCore.Builder;

    namespace Culture
    {
        public static class RequestCultureMiddlewareExtensions
        {
            public static IApplicationBuilder UseRequestCulture(
                this IApplicationBuilder builder)
            {
                return builder.UseMiddleware<RequestCultureMiddleware>();
            }
        }
    }

ä»¥ä¸‹ä»£ç é€šè¿‡ Startup.Configure è°ƒç”¨ä¸­é—´ä»¶ï¼š


    public class Startup
    {
        public void Configure(IApplicationBuilder app)
        {
            app.UseRequestCulture();

            app.Run(async (context) =>
            {
                await context.Response.WriteAsync(
                    $"Hello {CultureInfo.CurrentCulture.DisplayName}");
            });
        }
    }


## ==âš¡ Model Binding æ¨¡å‹ç»‘å®š

æ§åˆ¶å™¨å’Œ Razor é¡µé¢å¤„ç†æ¥è‡ª HTTP è¯·æ±‚çš„æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œè·¯ç”±æ•°æ®å¯ä»¥æä¾›ä¸€ä¸ªè®°å½•é”®ï¼Œè€Œè¡¨å•åŸŸå¯ä»¥ä¸ºæ¨¡å‹çš„å±æ€§æä¾›ä¸€ä¸ªå€¼ã€‚ ç¼–å†™ä»£ç ä»¥æ£€ç´¢è¿™äº›å€¼ï¼Œå¹¶å°†å…¶ä»å­—ç¬¦ä¸²è½¬æ¢ä¸º .NET ç±»å‹ä¸ä»…ç¹çï¼Œè€Œä¸”è¿˜å®¹æ˜“å‡ºé”™ã€‚ æ¨¡å‹ç»‘å®šä¼šè‡ªåŠ¨åŒ–è¯¥è¿‡ç¨‹ã€‚ æ¨¡å‹ç»‘å®šç³»ç»Ÿï¼š

- ä»å„ç§æºï¼ˆå¦‚è·¯ç”±æ•°æ®ã€è¡¨å•åŸŸå’ŒæŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰ä¸­æ£€ç´¢æ•°æ®ã€‚
- åœ¨æ–¹æ³•å‚æ•°å’Œå…¬å…±å±æ€§Razorä¸­å‘æ§åˆ¶å™¨å’Œé¡µé¢æä¾›æ•°æ®ã€‚
- å°†å­—ç¬¦ä¸²æ•°æ®è½¬æ¢ä¸º .NET ç±»å‹ã€‚
- æ›´æ–°å¤æ‚ç±»å‹çš„å±æ€§ã€‚

ç¤ºä¾‹ï¼Œå‡è®¾ Model ç±»æœ‰ä»¥ä¸‹æ“ä½œæ–¹æ³•ï¼š

    [HttpGet("{id}")]
    public ActionResult<Pet> GetById(int id, bool dogsOnly)

å®ƒå°±å¯ä»¥å¤„ç†å¸¦æœ‰ä»¥ä¸‹ URL çš„è¯·æ±‚ï¼š

    http://contoso.com/api/pets/2?DogsOnly=true

åœ¨è·¯ç”±ç³»ç»Ÿé€‰æ‹©è¯¥æ“ä½œæ–¹æ³•ä¹‹åï¼Œæ¨¡å‹ç»‘å®šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

- æŸ¥æ‰¾ GetByID çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªåä¸º id çš„æ•´æ•°ã€‚
- æŸ¥æ‰¾ HTTP è¯·æ±‚ä¸­çš„å¯ç”¨æºï¼Œå¹¶åœ¨è·¯ç”±æ•°æ®ä¸­æŸ¥æ‰¾ id =â€œ2â€ã€‚
- å°†å­—ç¬¦ä¸²â€œ2â€è½¬æ¢ä¸ºæ•´æ•° 2ã€‚
- æŸ¥æ‰¾ GetByID çš„ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªåä¸º dogsOnly çš„å¸ƒå°”å€¼ã€‚
- æŸ¥æ‰¾æºï¼Œå¹¶åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾â€œDogsOnly=trueâ€ã€‚ åç§°åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™ã€‚
- å°†å­—ç¬¦ä¸²â€œtrueâ€è½¬æ¢ä¸ºå¸ƒå°”å€¼ trueã€‚

ç„¶åï¼Œè¯¥æ¡†æ¶ä¼šè°ƒç”¨ GetById æ–¹æ³•ï¼Œä¾èµ–æ³¨å…¥ä¸º id å‚æ•°ä¼ å…¥ 2ï¼Œå¹¶ä¸º dogsOnly å‚æ•°ä¼ å…¥ trueã€‚

åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ¨¡å‹ç»‘å®šç›®æ ‡æ˜¯ç®€å•ç±»å‹çš„æ–¹æ³•å‚æ•°ã€‚ ç›®æ ‡ä¹Ÿå¯ä»¥æ˜¯å¤æ‚ç±»å‹çš„å±æ€§ã€‚ æˆåŠŸç»‘å®šæ¯ä¸ªå±æ€§åï¼Œå°†å¯¹å±æ€§è¿›è¡Œæ¨¡å‹éªŒè¯ã€‚ æœ‰å…³ç»‘å®šåˆ°æ¨¡å‹çš„æ•°æ®ä»¥åŠä»»æ„ç»‘å®šæˆ–éªŒè¯é”™è¯¯çš„è®°å½•éƒ½å­˜å‚¨åœ¨ ControllerBase.ModelState æˆ– PageModel.ModelState ä¸­ã€‚ ä¸ºæŸ¥æ˜è¯¥è¿‡ç¨‹æ˜¯å¦å·²æˆåŠŸï¼Œåº”ç”¨ä¼šæ£€æŸ¥ ModelState.IsValid æ ‡å¿—ã€‚


æ¨¡å‹ç»‘å®šå°è¯•æŸ¥æ‰¾ä»¥ä¸‹ç±»å‹ç›®æ ‡çš„å€¼ï¼š

- å°†è¯·æ±‚è·¯ç”±åˆ°çš„æ§åˆ¶å™¨æ“ä½œæ–¹æ³•çš„å‚æ•°ã€‚
- è¯·æ±‚è·¯ç”±åˆ° Razor çš„é¡µå¤„ç†ç¨‹åºæ–¹æ³•çš„å‚æ•°ã€‚
- æ§åˆ¶å™¨æˆ– PageModel ç±»çš„å…¬å…±å±æ€§ï¼ˆè‹¥ç”±ç‰¹æ€§æŒ‡å®šï¼‰ã€‚

[BindProperty] å±æ€§

å¯åº”ç”¨äºæ§åˆ¶å™¨æˆ– PageModel ç±»çš„å…¬å…±å±æ€§ï¼Œä»è€Œä½¿æ¨¡å‹ç»‘å®šä»¥è¯¥å±æ€§ä¸ºç›®æ ‡ï¼š

    public class EditModel : InstructorsPageModel
    {
        [BindProperty]
        public Instructor Instructor { get; set; }

[BindProperties] å±æ€§
å¯åœ¨ ASP.NET Core 2.1 åŠæ›´é«˜ç‰ˆæœ¬ä¸­è·å¾—ã€‚ å¯åº”ç”¨äºæ§åˆ¶å™¨æˆ– PageModel ç±»ï¼Œä»¥ä½¿æ¨¡å‹ç»‘å®šä»¥è¯¥ç±»çš„æ‰€æœ‰å…¬å…±å±æ€§ä¸ºç›®æ ‡ï¼š

    [BindProperties(SupportsGet = true)]
    public class CreateModel : InstructorsPageModel
    {
        public Instructor Instructor { get; set; }

HTTP GET è¯·æ±‚çš„æ¨¡å‹ç»‘å®š
é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ç»‘å®š HTTP GET è¯·æ±‚çš„å±æ€§ã€‚ é€šå¸¸ï¼ŒGET è¯·æ±‚åªéœ€ä¸€ä¸ªè®°å½• ID å‚æ•°ã€‚ è®°å½• ID ç”¨äºæŸ¥æ‰¾æ•°æ®åº“ä¸­çš„é¡¹ã€‚ å› æ­¤ï¼Œæ— éœ€ç»‘å®šåŒ…å«æ¨¡å‹å®ä¾‹çš„å±æ€§ã€‚ åœ¨éœ€è¦å°†å±æ€§ç»‘å®šåˆ° GET è¯·æ±‚ä¸­çš„æ•°æ®çš„æƒ…å†µä¸‹ï¼Œè¯·å°† SupportsGet å±æ€§è®¾ç½®ä¸º trueï¼š

    [BindProperty(Name = "ai_user", SupportsGet = true)]
    public string ApplicationInsightsCookie { get; set; }


é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å‹ç»‘å®šä»¥é”®å€¼å¯¹çš„å½¢å¼ä» HTTP è¯·æ±‚ä¸­çš„ä»¥ä¸‹æºä¸­è·å–æ•°æ®ï¼š

- è¡¨å•åŸŸ
- è¯·æ±‚æ­£æ–‡ï¼ˆå¯¹äºå…·æœ‰ [ApiController] å±æ€§çš„æ§åˆ¶å™¨ã€‚ï¼‰
- è·¯ç”±æ•°æ®
- æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°
- ä¸Šä¼ çš„æ–‡ä»¶

å¯¹äºæ¯ä¸ªç›®æ ‡å‚æ•°æˆ–å±æ€§ï¼ŒæŒ‰ç…§ä¹‹å‰åˆ—è¡¨ä¸­æŒ‡ç¤ºçš„é¡ºåºæ‰«ææºã€‚ æœ‰å‡ ä¸ªä¾‹å¤–æƒ…å†µï¼š

- è·¯ç”±æ•°æ®å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å€¼ä»…ç”¨äºç®€å•ç±»å‹ã€‚
- ä¸Šä¼ çš„æ–‡ä»¶ä»…ç»‘å®šåˆ°å®ç° IFormFile æˆ– IEnumerable<IFormFile> çš„ç›®æ ‡ç±»å‹ã€‚

å¦‚æœé»˜è®¤æºä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ä¸‹åˆ—å±æ€§ä¹‹ä¸€æ¥æŒ‡å®šæºï¼š

- [FromQuery]   ä»æŸ¥è¯¢å­—ç¬¦ä¸²è·å–å€¼ã€‚
- [FromRoute]   ä»è·¯ç”±æ•°æ®ä¸­è·å–å€¼ã€‚
- [FromForm]    ä»å·²å‘å¸ƒçš„è¡¨å•å­—æ®µä¸­è·å–å€¼ã€‚
- [FromBody]    ä»è¯·æ±‚æ­£æ–‡ä¸­è·å–å€¼ã€‚
- [FromHeader]  ä» HTTP æ ‡å¤´ä¸­è·å–å€¼ã€‚

å‡å¦‚ä½¿ç”¨äº† `[FromBody]` ç‰¹æ€§ä¿®é¥°å‚æ•°åˆ—è¡¨ï¼Œé‚£ä¹ˆ Body æ•°æ®å°±ä¼šè¢«æ¶ˆè´¹æ‰ï¼Œæˆ–è€…é€šè¿‡å®šä¹‰ä¸­é—´ä»¶ï¼Œåœ¨æ•°æ®æ¶ˆè´¹å‰è¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥ç›´æ¥åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ Request.Body è¯»ä¸åˆ°æ•°æ®ï¼ŒPosition æˆ– Length å±æ€§ä¹Ÿä¸å¯ç”¨ã€‚


åˆ†åˆ«æ·»åŠ åˆ°æ¨¡å‹å±æ€§ï¼ˆè€Œä¸æ˜¯æ¨¡å‹ç±»ï¼‰ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š

    public class Instructor
    {
        public int ID { get; set; }

        [FromQuery(Name = "Note")]
        public string NoteFromQueryString { get; set; }

é€‰æ‹©æ€§åœ°åœ¨æ„é€ å‡½æ•°ä¸­æ¥å—æ¨¡å‹åç§°å€¼ã€‚ æä¾›æ­¤é€‰é¡¹çš„ç›®çš„æ˜¯åº”å¯¹å±æ€§åç§°ä¸è¯·æ±‚ä¸­çš„å€¼ä¸åŒ¹é…çš„æƒ…å†µã€‚ ä¾‹å¦‚ï¼Œè¯·æ±‚ä¸­çš„å€¼å¯èƒ½æ˜¯åç§°ä¸­å¸¦æœ‰è¿å­—ç¬¦çš„æ ‡å¤´ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š

    public void OnGet([FromHeader(Name = "Accept-Language")] string language)


å°† [FromBody] ç‰¹æ€§åº”ç”¨äºä¸€ä¸ªå‚æ•°ï¼Œä»¥ä¾¿ä»ä¸€ä¸ª HTTP è¯·æ±‚çš„æ­£æ–‡å¡«å……å…¶å±æ€§ã€‚ ASP.NET Core è¿è¡Œæ—¶å°†è¯»å–æ­£æ–‡çš„è´£ä»»å§”æ‰˜ç»™è¾“å…¥æ ¼å¼åŒ–ç¨‹åºã€‚ è¾“å…¥æ ¼å¼åŒ–ç¨‹åºçš„è§£é‡Šä½äºæœ¬æ–‡åé¢éƒ¨åˆ†ã€‚

å°† [FromBody] åº”ç”¨äºå¤æ‚ç±»å‹å‚æ•°æ—¶ï¼Œåº”ç”¨äºå…¶å±æ€§çš„ä»»ä½•ç»‘å®šæºå±æ€§éƒ½å°†è¢«å¿½ç•¥ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹ Create æ“ä½œæŒ‡å®šä»æ­£æ–‡å¡«å……å…¶ pet å‚æ•°ï¼š

    public ActionResult<Pet> Create([FromBody] Pet pet)

Pet ç±»æŒ‡å®šä»æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°å¡«å……å…¶ Breed å±æ€§ï¼š

    public class Pet
    {
        public string Name { get; set; }

        [FromQuery] // Attribute is ignored.
        public string Breed { get; set; }
    }

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼š

- [FromQuery] ç‰¹æ€§è¢«å¿½ç•¥ã€‚
- Breed å±æ€§æœªä»æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°è¿›è¡Œå¡«å……ã€‚

è¾“å…¥æ ¼å¼åŒ–ç¨‹åºåªè¯»å–æ­£æ–‡ï¼Œä¸äº†è§£ç»‘å®šæºç‰¹æ€§ã€‚ å¦‚æœåœ¨æ­£æ–‡ä¸­æ‰¾åˆ°åˆé€‚çš„å€¼ï¼Œåˆ™ä½¿ç”¨è¯¥å€¼å¡«å…… Breed å±æ€§ã€‚
ä¸è¦å°† [FromBody] åº”ç”¨äºæ¯ä¸ªæ“ä½œæ–¹æ³•çš„å¤šä¸ªå‚æ•°ã€‚ è¾“å…¥æ ¼å¼åŒ–ç¨‹åºè¯»å–è¯·æ±‚æµåï¼Œæ— æ³•å†æ¬¡è¯»å–è¯¥æµä»¥ç»‘å®šå…¶ä»– [FromBody] å‚æ•°ã€‚


æºæ•°æ®ç”±å€¼æä¾›ç¨‹åº Provider æä¾›ç»™æ¨¡å‹ç»‘å®šç³»ç»Ÿã€‚ ä½ å¯ä»¥ç¼–å†™å¹¶æ³¨å†Œè‡ªå®šä¹‰å€¼æä¾›ç¨‹åºï¼Œä»¥ä»å…¶ä»–æºä¸­è·å–ç”¨äºæ¨¡å‹ç»‘å®šçš„æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦æ¥è‡ª Cookie æˆ–ä¼šè¯çŠ¶æ€çš„æ•°æ®ã€‚ è¦ä»æ–°çš„æºä¸­è·å–æ•°æ®ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- åˆ›å»ºç”¨äºå®ç° IValueProvider çš„ç±»ã€‚
- åˆ›å»ºç”¨äºå®ç° IValueProviderFactory çš„ç±»ã€‚
- åœ¨ Startup.ConfigureServices ä¸­æ³¨å†Œå·¥å‚ç±»ã€‚

ç¤ºä¾‹åº”ç”¨åŒ…æ‹¬ä» Cookie ä¸­è·å–å€¼çš„ å€¼æä¾›ç¨‹åºå’Œå·¥å‚ç¤ºä¾‹ã€‚ ä»¥ä¸‹æ˜¯ Startup.ConfigureServices ä¸­çš„æ³¨å†Œä»£ç ï¼š

    services.AddRazorPages()
        .AddMvcOptions(options =>
    {
        options.ValueProviderFactories.Add(new CookieValueProviderFactory());
        options.ModelMetadataDetailsProviders.Add(
            new ExcludeBindingMetadataProvider(typeof(System.Version)));
        options.ModelMetadataDetailsProviders.Add(
            new SuppressChildValidationMetadataProvider(typeof(System.Guid)));
    })
    .AddXmlSerializerFormatters();

æ‰€ç¤ºä»£ç å°†è‡ªå®šä¹‰å€¼æä¾›ç¨‹åºç½®äºæ‰€æœ‰å†…ç½®å€¼æä¾›ç¨‹åºä¹‹åã€‚ è¦å°†å…¶ç½®äºåˆ—è¡¨ä¸­çš„é¦–ä½ï¼Œè¯·è°ƒç”¨ Insert(0, new CookieValueProviderFactory()) è€Œä¸æ˜¯ Addã€‚


å¯¹ä¸å­˜åœ¨æ¨¡å‹å±æ€§çš„æºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ¨¡å‹å±æ€§çš„å€¼ï¼Œåˆ™ä¸ä¼šåˆ›å»ºæ¨¡å‹çŠ¶æ€é”™è¯¯ã€‚ è¯¥å±æ€§è®¾ç½®ä¸º NULL æˆ–é»˜è®¤å€¼ï¼š

- å¯ä»¥ä¸º Null çš„ç®€å•ç±»å‹è®¾ç½®ä¸º nullã€‚
- ä¸å¯ä»¥ä¸º Null çš„å€¼ç±»å‹è®¾ç½®ä¸º default(T)ã€‚ ä¾‹å¦‚ï¼Œå‚æ•° int id è®¾ç½®ä¸º 0ã€‚
- å¯¹äºå¤æ‚ç±»å‹ï¼Œæ¨¡å‹ç»‘å®šä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ¥åˆ›å»ºå®ä¾‹ï¼Œè€Œä¸è®¾ç½®å±æ€§ã€‚
- æ•°ç»„è®¾ç½®ä¸º Array.Empty<T>()ï¼Œä½† byte[] æ•°ç»„è®¾ç½®ä¸º nullã€‚

å¦‚æœåœ¨æ¨¡å‹å±æ€§çš„çª—ä½“å­—æ®µä¸­æœªæ‰¾åˆ°ä»»ä½•å†…å®¹æ—¶æ¨¡å‹çŠ¶æ€åº”å¤±æ•ˆï¼Œè¯· [BindRequired] ä½¿ç”¨ç‰¹æ€§ã€‚

è¯·æ³¨æ„ï¼Œæ­¤ [BindRequired] è¡Œä¸ºé€‚ç”¨äºå‘å¸ƒçš„è¡¨å•æ•°æ®ä¸­çš„æ¨¡å‹ç»‘å®šï¼Œè€Œä¸é€‚ç”¨äºè¯·æ±‚æ­£æ–‡ä¸­çš„ JSON æˆ– XML æ•°æ®ã€‚ è¯·æ±‚æ­£æ–‡æ•°æ®ç”±è¾“å…¥æ ¼å¼åŒ–ç¨‹åºè¿›è¡Œå¤„ç†ã€‚


ç±»å‹è½¬æ¢é”™è¯¯ï¼Œå¦‚æœæ‰¾åˆ°æºï¼Œä½†æ— æ³•å°†å…¶è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼Œåˆ™æ¨¡å‹çŠ¶æ€å°†è¢«æ ‡è®°ä¸ºæ— æ•ˆã€‚ ç›®æ ‡å‚æ•°æˆ–å±æ€§è®¾ç½®ä¸º NULL æˆ–é»˜è®¤å€¼ï¼Œå¦‚ä¸Šä¸€éƒ¨åˆ†æ‰€è¿°ã€‚

åœ¨å…·æœ‰ [ApiController] å±æ€§çš„ API æ§åˆ¶å™¨ä¸­ï¼Œæ— æ•ˆçš„æ¨¡å‹çŠ¶æ€ä¼šå¯¼è‡´è‡ªåŠ¨ HTTP 400 å“åº”ã€‚
åœ¨Razoré¡µé¢ä¸­ï¼Œé‡æ–°æ˜¾ç¤ºé¡µé¢å¹¶æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼š

    public IActionResult OnPost()
    {
        if (!ModelState.IsValid)
        {
            return Page();
        }

        _instructorsInMemoryStore.Add(Instructor);
        return RedirectToPage("./Index");
    }

å®¢æˆ·ç«¯éªŒè¯å°†æ•è·å¤§å¤šæ•°æäº¤åˆ° Razor é¡µé¢çª—ä½“çš„é”™è¯¯æ•°æ®ã€‚ æ­¤éªŒè¯ä½¿å¾—å…ˆå‰çªå‡ºæ˜¾ç¤ºçš„ä»£ç éš¾ä»¥è¢«è§¦å‘ã€‚ 

å¦‚æœè¦åœ¨è¡¨å•åŸŸä¸­é‡æ–°æ˜¾ç¤ºé”™è¯¯æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘å°†æ¨¡å‹å±æ€§è®¾ç½®ä¸ºå­—ç¬¦ä¸²å¹¶æ‰‹åŠ¨æ‰§è¡Œæ•°æ®è½¬æ¢ã€‚ å¦‚æœä¸å¸Œæœ›å‘ç”Ÿç±»å‹è½¬æ¢é”™è¯¯å¯¼è‡´æ¨¡å‹çŠ¶æ€é”™è¯¯çš„æƒ…å†µï¼Œå»ºè®®ä½¿ç”¨ç›¸åŒçš„ç­–ç•¥ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ¨¡å‹å±æ€§è®¾ç½®ä¸ºå­—ç¬¦ä¸²ã€‚



## ==âš¡ validate éªŒè¯
- [ModelStateDictionary](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.modelbinding.modelstatedictionary?view=aspnetcore-3.1)
- [ASP.NET Core MVC å’Œ Razor æ¨¡å‹éªŒè¯](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/models/validation?view=aspnetcore-3.1)
- [DataAnnotations Sources Code](https://github.com/dotnet/runtime/tree/master/src/libraries/System.ComponentModel.Annotations/src/System/ComponentModel/DataAnnotations)
- [JQuery éªŒè¯æ–‡æ¡£](https://jqueryvalidation.org/documentation/)


DataAnnotations å‘½åç©ºé—´æä¾›ä¸€ç»„å†…ç½®éªŒè¯ç‰¹æ€§ï¼Œå¯é€šè¿‡å£°æ˜æ–¹å¼åº”ç”¨äºç±»æˆ–å±æ€§ã€‚ DataAnnotations è¿˜åŒ…å« [DataType] ç­‰æ ¼å¼ç‰¹æ€§ï¼Œæœ‰åŠ©äºæ ¼å¼è®¾ç½®ä½†ä¸æä¾›ä»»ä½•éªŒè¯ã€‚
è¯·è€ƒè™‘ Customer æ¨¡å‹ï¼š

    using System.ComponentModel.DataAnnotations;

    namespace RazorPagesContacts.Models
    {
        public class Customer
        {
            public int Id { get; set; }

            [Required, StringLength(10)]
            public string Name { get; set; }
        }
    }

ä½¿ç”¨ä»¥ä¸‹ Create.cshtml è§†å›¾æ–‡ä»¶ ï¼š

    @page
    @model RazorPagesContacts.Pages.Customers.CreateModel
    @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

    <p>Validation: customer name:</p>

    <form method="post">
        <div asp-validation-summary="ModelOnly"></div>
        <span asp-validation-for="Customer.Name"></span>
        Name:
        <input asp-for="Customer.Name" />
        <input type="submit" />
    </form>

    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.js"></script>

å®¢æˆ·ç«¯éªŒè¯å°†é˜»æ­¢æäº¤ï¼Œç›´åˆ°è¡¨å•å˜ä¸ºæœ‰æ•ˆä¸ºæ­¢ã€‚ jQuery Validate éªŒè¯è¦ä¹ˆæäº¤è¡¨å•è¦ä¹ˆæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚è¡¨å•ä¸Šå­˜åœ¨è¾“å…¥é”™è¯¯æ—¶ï¼Œå®¢æˆ·ç«¯éªŒè¯ä¼šé¿å…åˆ°æœåŠ¡å™¨çš„ä¸å¿…è¦å¾€è¿”ã€‚


æœåŠ¡å™¨ç«¯éªŒè¯ï¼š


    public async Task<IActionResult> OnPostAsync()
    {
        if (!ModelState.IsValid)
        {
            return Page();
        }

        if (!TryValidateModel(Movie, nameof(Movie)))
        {
            return Page();
        }

        _context.Movies.Add(Movie);
        await _context.SaveChangesAsync();

        return RedirectToPage("./Index");
    }



ä»¥ä¸‹æ˜¯ä¸€äº›å†…ç½®éªŒè¯ç‰¹æ€§ï¼š

- `[CreditCard]` éªŒè¯å±æ€§æ˜¯å¦å…·æœ‰ä¿¡ç”¨å¡æ ¼å¼ã€‚ éœ€è¦JQuery éªŒè¯å…¶ä»–æ–¹æ³•ã€‚
- `[Compare]` éªŒè¯æ¨¡å‹ä¸­çš„ä¸¤ä¸ªå±æ€§æ˜¯å¦åŒ¹é…ã€‚
- `[EmailAddress]` éªŒè¯å±æ€§æ˜¯å¦å…·æœ‰ç”µå­é‚®ä»¶æ ¼å¼ã€‚
- `[Phone]` éªŒè¯å±æ€§æ˜¯å¦å…·æœ‰ç”µè¯å·ç æ ¼å¼ã€‚
- `[Range]` éªŒè¯å±æ€§å€¼æ˜¯å¦åœ¨æŒ‡å®šçš„èŒƒå›´å†…ã€‚
- `[RegularExpression]` éªŒè¯å±æ€§å€¼æ˜¯å¦ä¸æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚
- `[Required]` éªŒè¯å­—æ®µæ˜¯å¦ä¸ä¸º nullã€‚
- `[StringLength]` éªŒè¯å­—ç¬¦ä¸²å±æ€§å€¼æ˜¯å¦ä¸è¶…è¿‡æŒ‡å®šé•¿åº¦é™åˆ¶ã€‚
- `[Url]` éªŒè¯å±æ€§æ˜¯å¦å…·æœ‰ URL æ ¼å¼ã€‚
- `[Remote]` é€šè¿‡åœ¨æœåŠ¡å™¨ä¸Šè°ƒç”¨æ“ä½œæ–¹æ³•æ¥éªŒè¯å®¢æˆ·ç«¯ä¸Šçš„è¾“å…¥ã€‚

é€šè¿‡éªŒè¯ç‰¹æ€§å¯ä»¥æŒ‡å®šè¦ä¸ºæ— æ•ˆè¾“å…¥æ˜¾ç¤ºçš„é”™è¯¯æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼š

    [StringLength(8, ErrorMessage = "Name length can't be more than 8.")]
    [StringLength(8, ErrorMessage = "{0} length must be between {2} and {1}.", MinimumLength = 6)]

åœ¨å†…éƒ¨ï¼Œç‰¹æ€§ä½¿ç”¨ç”¨äºå­—æ®µåçš„æŸä¸ªå ä½ç¬¦è°ƒç”¨ String.Formatï¼Œæœ‰æ—¶è¿˜ä½¿ç”¨é¢å¤–å ä½ç¬¦ã€‚ä¸Šè¿°ä»£ç åˆ›å»ºçš„é”™è¯¯æ¶ˆæ¯å®šä¹‰åç§°é•¿åº¦å¿…é¡»ä»‹äº 6 åˆ° 8 ä¹‹é—´ã€‚é”™è¯¯æ¶ˆæ¯å¦‚ä½•é€’ç»™ String.Format çš„å‚æ•°ï¼Œè¯·å‚é˜… DataAnnotations æºä»£ç ã€‚


éªŒè¯è§„åˆ™çš„ä½¿ç”¨ï¼š

    [StringLength(60, MinimumLength = 3)]
    [Required]
    public string Title { get; set; }

    [Display(Name = "Release Date")]
    [DataType(DataType.Date)]
    public DateTime ReleaseDate { get; set; }

    [Range(1, 100)]
    [DataType(DataType.Currency)]
    [Column(TypeName = "decimal(18, 2)")]
    public decimal Price { get; set; }

    [RegularExpression(@"^[A-Z]+[a-zA-Z""'\s-]*$")]
    [Required]
    [StringLength(30)]
    public string Genre { get; set; }

    [RegularExpression(@"^[A-Z]+[a-zA-Z0-9""'\s-]*$")]
    [StringLength(5)]
    [Required]
    public string Rating { get; set; }

éªŒè¯ç‰¹æ€§æŒ‡å®šè¦å¯¹åº”ç”¨è¿™äº›ç‰¹æ€§çš„æ¨¡å‹å±æ€§å¼ºåˆ¶æ‰§è¡Œçš„è¡Œä¸ºï¼š

- `Required` å’Œ MinimumLength ç‰¹æ€§è¡¨ç¤ºå±æ€§å¿…é¡»æœ‰å€¼ï¼›ä½†ç”¨æˆ·å¯è¾“å…¥ç©ºæ ¼æ¥æ»¡è¶³æ­¤éªŒè¯ã€‚
- `RegularExpression` æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ€§ï¼Œç”¨äºé™åˆ¶å¯è¾“å…¥çš„å­—ç¬¦ã€‚ 

    åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå³åˆ†ç±» Genre å±æ€§è¦æ±‚ï¼š
    
    - åªèƒ½ä½¿ç”¨å­—æ¯ã€‚
    - ç¬¬ä¸€ä¸ªå­—æ¯å¿…é¡»ä¸ºå¤§å†™ã€‚ ä¸å…è®¸ä½¿ç”¨ç©ºæ ¼ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ã€‚

    åˆ†çº§ Rating å±æ€§è¦æ±‚ï¼š

    - è¦æ±‚ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºå¤§å†™å­—æ¯ã€‚ 
    - å…è®¸åœ¨åç»­ç©ºæ ¼ä¸­ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦å’Œæ•°å­—ã€‚ ä¾‹å¦‚ PG-13 æ˜¯æœ‰æ•ˆåˆ†çº§ï¼Œä½†å¯¹äºåˆ†ç±»æ— æ•ˆã€‚

- `Range` ç‰¹æ€§é™åˆ¶åœ¨æŒ‡å®šèŒƒå›´å†…å–å€¼ã€‚
- `StringLength` ç‰¹æ€§ä½¿ä½ èƒ½å¤Ÿè®¾ç½®å­—ç¬¦ä¸²å±æ€§çš„æœ€å¤§é•¿åº¦ï¼Œä»¥åŠå¯é€‰çš„æœ€å°é•¿åº¦ã€‚
- æŒ‡å®šå€¼ç±»å‹ï¼Œå¦‚ decimalã€intã€floatã€DateTimeï¼Œå¯ä»¥ä¸éœ€è¦ [Required] ç‰¹æ€§ã€‚



DataType ç‰¹æ€§ä»…æä¾›ç›¸å…³æç¤ºæ¥å¸®åŠ©è§†å›¾å¼•æ“è®¾ç½®æ•°æ®æ ¼å¼ï¼Œ DataType ç‰¹æ€§ä¸æ˜¯éªŒè¯ç‰¹æ€§ã€‚ å¯ä¸º DataType.EmailAddress åˆ›å»º mailto: é“¾æ¥ã€‚ å¯åœ¨æ”¯æŒ HTML5 çš„æµè§ˆå™¨ä¸­ä¸º DataType.Date æä¾›æ—¥æœŸé€‰æ‹©å™¨ã€‚ DataType ç‰¹æ€§å‘å‡º HTML 5 data- ç‰¹æ€§ä¾›è§ˆå™¨ä½¿ç”¨ã€‚

DisplayFormat ç‰¹æ€§ç”¨äºæ˜¾å¼æŒ‡å®šæ—¥æœŸæ ¼å¼ï¼š

    [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
    public DateTime ReleaseDate { get; set; }

ApplyFormatInEditMode è®¾ç½®ç”¨äºæŒ‡å®šåœ¨æ˜¾ç¤ºå€¼è¿›è¡Œç¼–è¾‘æ—¶éœ€åº”ç”¨æ ¼å¼ã€‚ å¯èƒ½ä¸å¸Œæœ›æŸäº›å­—æ®µå…·æœ‰æ­¤è¡Œä¸ºã€‚ ä¾‹å¦‚ï¼Œåœ¨è´§å¸å€¼ä¸­ï¼Œå¯èƒ½ä¸å¸Œæœ›ç¼–è¾‘ UI ä¸­å­˜åœ¨è´§å¸ç¬¦å·ã€‚


æ³¨æ„ï¼šjQuery éªŒè¯ä¸é€‚ç”¨äº Range å±æ€§å’Œ DateTimeã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å°†å§‹ç»ˆæ˜¾ç¤ºå®¢æˆ·ç«¯éªŒè¯é”™è¯¯ï¼Œå³ä¾¿æ—¥æœŸåœ¨æŒ‡å®šçš„èŒƒå›´å†…ï¼š

    [Range(typeof(DateTime), "1/1/1966", "1/1/2020")]

é€šå¸¸ï¼Œåœ¨æ¨¡å‹ä¸­ç¼–è¯‘å›ºå®šæ—¥æœŸæ˜¯ä¸æ°å½“çš„ï¼Œå› æ­¤ä¸æ¨èä½¿ç”¨ Range ç‰¹æ€§å’Œ DateTimeã€‚

    [StringLength(60, MinimumLength = 3)]
    public string Title { get; set; }

    [Display(Name = "Release Date"), DataType(DataType.Date)]
    public DateTime ReleaseDate { get; set; }

    [RegularExpression(@"^[A-Z]+[a-zA-Z""'\s-]*$"), Required, StringLength(30)]
    public string Genre { get; set; }

    [Range(1, 100), DataType(DataType.Currency)]
    [Column(TypeName = "decimal(18, 2)")]
    public decimal Price { get; set; }

    [RegularExpression(@"^[A-Z]+[a-zA-Z0-9""'\s-]*$"), StringLength(5)]
    public string Rating { get; set; }


è®© ASP.NET Core å¼ºåˆ¶è‡ªåŠ¨æ‰§è¡ŒéªŒè¯è§„åˆ™æœ‰åŠ©äºæå‡ä½ çš„åº”ç”¨çš„å¯é æ€§ã€‚ åŒæ—¶å®ƒèƒ½ç¡®ä¿ä½ æ— æ³•å¿˜è®°éªŒè¯æŸäº›å†…å®¹ï¼Œå¹¶é˜²æ­¢ä½ æ— æ„ä¸­å°†é”™è¯¯æ•°æ®å¯¼å…¥æ•°æ®åº“ã€‚

åœ¨æµè§ˆå™¨ä¸­ç¦ç”¨ JavaScript åï¼Œæäº¤å‡ºé”™è¡¨å•å°†å‘å¸ƒåˆ°æœåŠ¡å™¨ï¼Œæäº¤åŒ…å«æ— æ•ˆæ•°æ®çš„è¡¨å•ã€‚å¯ä»¥ç¦ç”¨æµè§ˆå™¨æœ‰è„šæœ¬åŠŸèƒ½ï¼Œæˆ–åœ¨é¡µé¢çš„ OnPostAsync æ–¹æ³•ä¸­è®¾ç½®æ–­ç‚¹ä»¥æµ‹è¯•æœåŠ¡ç«¯éªŒè¯æ¨¡å‹çŠ¶æ€æ˜¯å¦æ— æ•ˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Fiddler ç­‰å·¥å…·ï¼š

    if (!ModelState.IsValid)
    {
        return Page();
    }

åœ¨åŠ©æ‰‹æ ‡ç­¾ä¸­ä½¿ç”¨ DataAnnotations ç‰¹æ€§å¹¶åœ¨å®¢æˆ·ç«¯ç”Ÿæˆ jQuery éªŒè¯æ‰€éœ€çš„ HTML ç‰¹æ€§ã€‚ éªŒè¯æ ‡è®°ç”¨äºæ˜¾ç¤ºéªŒè¯é”™è¯¯ã€‚

    <div asp-validation-summary="All"> validation? </div>
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="form-group">
        <label asp-for="Movie.Title" class="control-label"></label>
        <input asp-for="Movie.Title" class="form-control" />
        <span asp-validation-for="Movie.Title" class="text-danger"></span>
    </div>





## ==âš¡ Razor æ¨¡æ¿æŒ‡ä»¤å‚è€ƒ


- åŠ©æ‰‹æ ‡ç­¾æœ‰ä¸‰ä¸ªç›¸å…³æŒ‡ä»¤ã€‚

    @addTagHelper   å‘è§†å›¾æä¾›åŠ©æ‰‹æ ‡ç­¾ã€‚
    @removeTagHelper    ä»è§†å›¾ä¸­åˆ é™¤ä»¥å‰æ·»åŠ çš„åŠ©æ‰‹æ ‡ç­¾ã€‚
    @tagHelperPrefix    æŒ‡å®šæ ‡è®°å‰ç¼€ï¼Œä»¥å¯ç”¨åŠ©æ‰‹æ ‡ç­¾æ”¯æŒå¹¶é˜æ˜åŠ©æ‰‹æ ‡ç­¾çš„ç”¨æ³•ã€‚

- @code 

    @code å—å…è®¸ Razor ç»„ä»¶å°† C# æˆå‘˜ï¼ˆå­—æ®µã€å±æ€§å’Œæ–¹æ³•ï¼‰æ·»åŠ åˆ°ç»„ä»¶ã€‚åœ¨ Razor ç»„ä»¶ä¸­ï¼Œè¯·ä½¿ç”¨ @code è€Œä¸æ˜¯ @functions æ¥æ·»åŠ  C# æˆå‘˜ã€‚æ­¤æ–¹æ¡ˆä»…é€‚ç”¨äº Razor ç»„ä»¶ (.razor)ã€‚

- @using å¤åˆè¯­å¥

    åœ¨ C# ä¸­ï¼Œusing è¯­å¥ç”¨äºç¡®ä¿é‡Šæ”¾å¯¹è±¡ã€‚ åœ¨ Razor ä¸­ï¼Œå¯ä½¿ç”¨ç›¸åŒçš„æœºåˆ¶æ¥åˆ›å»ºåŒ…å«é™„åŠ å†…å®¹çš„ HTML æ ‡ç­¾ã€‚ 

        @using (Html.BeginForm())
        {
            <div>
                Email: <input type="email" id="Email" value="">
                <button>Register</button>
            </div>
        }

- @using å¼•å…¥å‘½åç©ºé—´

    ç”¨äºå‘è§†å›¾æ·»åŠ  C# using æŒ‡ä»¤ï¼Œå¦‚:

        @using System.IO
        @{
            var dir = Directory.GetCurrentDirectory();
        }
        <p>@dir</p>

- @tryã€catchã€finally å¼‚å¸¸å¤„ç†

        @try
        {
            throw new InvalidOperationException("You did something invalid.");
        }
        catch (Exception ex)
        {
            <p>The exception message: @ex.Message</p>
        }
        finally
        {
            <p>The finally statement.</p>
        }

- @lock ä½¿ç”¨ lock è¯­å¥æ¥ä¿æŠ¤å…³é”®èŠ‚ç‚¹

        @lock (SomeLock)
        {
            // Do critical section work
        }

- @functions 

    æŒ‡ä»¤å…è®¸å°† C# æˆå‘˜ï¼ˆå­—æ®µã€å±æ€§å’Œæ–¹æ³•ï¼‰æ·»åŠ åˆ°ç”Ÿæˆçš„ç±»ä¸­ã€‚åœ¨ Razor ç»„ä»¶ä¸­ï¼Œè¯·ä½¿ç”¨ @code è€Œä¸æ˜¯ @functions æ¥æ·»åŠ  C# æˆå‘˜ã€‚

        @functions {
            private void RenderName(string name)
            {
                <p>Name: <strong>@name</strong></p>
            }
        }

- @implements æŒ‡ä»¤ä¸ºç”Ÿæˆçš„ç±»å®ç°æ¥å£ã€‚

    ä»¥ä¸‹ç¤ºä¾‹å®ç° System.IDisposableï¼Œä»¥ä¾¿å¯ä»¥è°ƒç”¨ Dispose æ–¹æ³•ï¼š

        @implements IDisposable

        <h1>Example</h1>

        @functions {
            private bool _isDisposed;

            ...

            public void Dispose() => _isDisposed = true;
        }

- @inherits æŒ‡ä»¤å¯¹è§†å›¾ç»§æ‰¿çš„ç±»æä¾›å®Œå…¨æ§åˆ¶ã€‚

    @model å’Œ @inherits å¯åœ¨åŒä¸€è§†å›¾ä¸­ä½¿ç”¨ã€‚ @inherits å¯ä½äºè§†å›¾å¯¼å…¥çš„ `_ViewImports.cshtml` æ–‡ä»¶ä¸­ï¼š

        @inherits CustomRazorPage<TModel>

- @inject æŒ‡ä»¤å…è®¸ Razor é¡µé¢å°†æœåŠ¡ä»æœåŠ¡å®¹å™¨æ³¨å…¥åˆ°è§†å›¾ã€‚ 

- @layout æŒ‡ä»¤æŒ‡å®š Razor ç»„ä»¶çš„å¸ƒå±€ã€‚

    æ­¤æ–¹æ¡ˆä»…é€‚ç”¨äº Razor ç»„ä»¶ (.razor)ã€‚å¸ƒå±€ç»„ä»¶ç”¨äºé¿å…ä»£ç é‡å¤å’Œä¸ä¸€è‡´ã€‚
    
- @model æŒ‡ä»¤æŒ‡å®šä¼ é€’åˆ°è§†å›¾æˆ–é¡µé¢çš„æ¨¡å‹ç±»å‹

    æ­¤æ–¹æ¡ˆä»…é€‚ç”¨äº MVC è§†å›¾å’Œ Razor Pages (.cshtml)ã€‚@model æŒ‡ä»¤æŒ‡å®š Model å±æ€§çš„ç±»å‹ã€‚ è¯¥æŒ‡ä»¤å°† RazorPage<T> ä¸­çš„ T æŒ‡å®šä¸ºç”Ÿæˆçš„ç±»ï¼Œè§†å›¾ä¾¿æ´¾ç”Ÿè‡ªè¯¥ç±»ã€‚ å¦‚æœæœªæŒ‡å®š @model æŒ‡ä»¤ï¼Œåˆ™ Model å±æ€§çš„ç±»å‹ä¸º dynamicã€‚ 

- @model IndexModel åŠ è½½æ¨¡å—ç±»å®ä¾‹


- @namespace 

    æŒ‡ä»¤è®¾ç½®ç”Ÿæˆçš„ Razor é¡µé¢ã€MVC è§†å›¾æˆ– Razor ç»„ä»¶çš„è§†å›¾ç±»çš„å‘½åç©ºé—´ã€‚ä¸è®¾ç½®ï¼Œå¯èƒ½ä¼šä½¿ç”¨ `AspNetCore` ä½œä¸ºé»˜è®¤å€¼ã€‚


- @page 

    @page æŒ‡ä»¤å‡ºç°åœ¨ .cshtml æ–‡ä»¶ä¸­è¡¨ç¤ºè¯¥æ–‡ä»¶æ˜¯ Razor Pageã€‚
    @page æŒ‡ä»¤å‡ºç°åœ¨ Razor ç»„ä»¶ï¼Œè¡¨ç¤ºç›´æ¥ä½¿ç”¨ç»„ä»¶å¤„ç†è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±åŒ¹é…æ¨¡æ¿ã€‚ç¼–è¯‘å¸¦æœ‰ @page æŒ‡ä»¤çš„ .razor æ–‡ä»¶æ—¶ï¼Œå°†ä¸ºç”Ÿæˆçš„ç±»æä¾›æŒ‡å®šè·¯ç”±æ¨¡æ¿çš„ RouteAttributeã€‚
    
    æŒ‡å®šé¡µé¢çš„è‡ªå®šä¹‰è·¯ç”± @page "/Some/Other/Path"
    å°†æ®µè¿½åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ï¼Œå¦‚ @page "item" å°† item æ®µæ·»åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ã€‚
    å°†å‚æ•°è¿½åŠ åˆ°é¡µé¢çš„é»˜è®¤è·¯ç”±ã€‚ ä¾‹å¦‚ï¼Œ@page "{id}" é¡µé¢éœ€è¦ ID å‚æ•° idã€‚

    è¿˜å¯ä»¥æŒ‡å®šåŒ¹é…å‚æ•°çš„ç±»å‹ï¼Œå¦‚ @page "{id:int}" æŒ‡ä»¤ï¼Œå‘Šè¯‰é¡µé¢æ¥å—åŒ…å« int è·¯ç”±æ•°æ®çš„é¡µé¢è¯·æ±‚ã€‚ 

        @page "{id:int}"
        @page "{id:int?}"

    æ”¯æŒå¼€å¤´å¤„ä»¥æ³¢å½¢ç¬¦æŒ‡å®šçš„ç›¸å¯¹äºæ ¹ç›®å½•çš„è·¯å¾„ã€‚ ä¾‹å¦‚ï¼Œ`@page "~/Some/Other/Path"` å’Œ `@page "/Some/Other/Path"` ç›¸åŒã€‚

    å¦‚æœä½ ä¸å–œæ¬¢ URL ä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸² `?handler=JoinList`ï¼Œè¯·æ›´æ”¹è·¯ç”±ï¼Œå°†å¤„ç†ç¨‹åºåç§°æ”¾åœ¨ URL çš„è·¯å¾„éƒ¨åˆ†ã€‚ å¯ä»¥é€šè¿‡åœ¨ @page æŒ‡ä»¤åé¢æ·»åŠ ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„è·¯ç”±æ¨¡æ¿æ¥è‡ªå®šä¹‰è·¯ç”±ã€‚

        @page "{handler?}"
        
    å¯å°†å¤šä¸ªè·¯ç”±æ¨¡æ¿åº”ç”¨äºä¸€ä¸ªç»„ä»¶ã€‚ ä»¥ä¸‹ç»„ä»¶å“åº”å¯¹ /BlazorRoute å’Œ /DifferentBlazorRoute çš„è¯·æ±‚ï¼š

        @page "/BlazorRoute"
        @page "/DifferentBlazorRoute"

        <h1>Blazor routing</h1>

    åŒæ˜Ÿå· catch-all è¯­æ³•ç”¨äºæ•è·è·¨å¤šä¸ªæ–‡ä»¶å¤¹è¾¹ç•Œçš„è·¯å¾„ï¼Œ`@page "/{**path}"`ï¼Œè€Œæ— éœ€ç¼–ç æ­£æ–œæ ã€‚


- @section

    @section æ³¨å…¥åŒºå—æŒ‡ä»¤ï¼Œä¸ MVC å’Œ Razor Pages å¸ƒå±€ç»“åˆä½¿ç”¨ï¼Œå…è®¸è§†å›¾æˆ–é¡µé¢å°†å†…å®¹å‘ˆç°åœ¨ HTML é¡µé¢çš„ä¸åŒéƒ¨åˆ†ã€‚ æ­¤æ–¹æ¡ˆä»…é€‚ç”¨äº MVC è§†å›¾å’Œ Razor Pages (.cshtml)ã€‚

    ä¾‹å¦‚ï¼Œ ` _layout.cshtml` åœ¨éœ€è¦æ¸²æŸ“è¾“å‡ºçš„ä½ç½®è®¾ç½®ä¸€æ¡ @RenderSection æŒ‡ä»¤ï¼Œç„¶ååœ¨é¡µé¢ä¸­ï¼Œæ‰§è¡Œæƒ…å†µè®¾ç½®è¦æ¸²æŸ“è¾“å‡ºçš„å†…å®¹ï¼š

        @RenderSection("scripts", required: false)

        @section Scripts {
            @if (Model.CanEdit)
            {
                await Html.RenderPartialAsync("EditorScriptsPartial");
            }
        }

    æˆ–è€…ç›´æ¥è¾“å‡ºï¼Œä¸è¿›è¡Œå…¶å®ƒæ¡ä»¶åˆ¤æ–­ï¼š

        @section scripts
        {
            <script>
                $(function() {
                    // some more js code here;
                });
            </script>
        }

    ä½ å¯èƒ½éœ€è¦åµŒå¥—è¿™ä¸ªåŒºåŸŸï¼Œæ„æ€å°±æ˜¯åœ¨ @section é‡Œé¢åµŒå¥—è°ƒç”¨ @RenderSection():

        @section scripts
        {
            @RenderSection("scripts", required: false)
        }


- @RenderBody() åœ¨å¸ƒå±€è§†å›¾ä¸­æ‰§è¡Œæ¸²æŸ“æ–¹æ³•
- @RenderSection("Scripts", required: false) åœ¨å¸ƒå±€è§†å›¾ä¸­æ‰§è¡ŒåŒºå—æ¸²æŸ“æ–¹æ³•

- @attribute [Authorize] æŒ‡ä»¤å°†ç»™å®šçš„å±æ€§æ·»åŠ åˆ°ç”Ÿæˆçš„é¡µæˆ–è§†å›¾çš„ç±»ä¸­ã€‚
- @Html.ActionLink è°ƒç”¨å‡½æ•°ç”Ÿæˆé“¾æ¥

    æœ‰ä¸€äº›æ–¹æ³•ç”¨æ¥ç”Ÿæˆ HTML å…ƒç´ ï¼Œå½“ View è§£æçš„æ—¶å€™è¿™äº› C# ä»£ç ä¼šè¢«è§£ææˆ HTML å…ƒç´ ã€‚

    `<li>@Html.ActionLink("Go Home", "Index", "Home")</li>`
    `<li><a controller="Home" action="Index">Go Home</a></li>`

    ä»¥ä¸Šä¸¤è¡Œç­‰ä»·ï¼Œå‚è€ƒæ–‡æ¡£çš„é“¾æ¥åŠ©æ‰‹ç±» anchor-tag-helper äº†è§£å¦‚æœæ„é€  HTML é“¾æ¥æ ‡è®°ã€‚

- @if/@for/@switch/@while/@do/@dowhile/@foreach (var x in y) ç­‰æµç¨‹æ§åˆ¶ä»£ç å—

        @if (forecasts == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            @foreach (var forecast in forecasts)
            {
            ...
            }
        }

- ä»£ç å—

    ä¾‹å¦‚ï¼Œç»™æˆå‘˜åˆå§‹ä»£å—ï¼Œè®¾ç½®å¸ƒå±€æˆ–è§†å›¾æ•°æ®

        @{
            Layout = "_Layout";
            ViewData["Title"] = "Home Page";
        }

- æŒ‡ä»¤å±æ€§

    æŒ‡ä»¤ç‰¹æ€§é€šå¸¸ä¼šæ”¹å˜å…ƒç´ çš„åˆ†ææ–¹å¼ï¼Œæˆ–å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œæ­¤æ–¹æ¡ˆä»…é€‚ç”¨äº Razor ç»„ä»¶ (.razor)ã€‚

    - @attributes å…è®¸ç»„ä»¶å‘ˆç°æœªå£°æ˜çš„å±æ€§ã€‚
    - @bind å®ç°ç»„ä»¶ä¸­çš„æ•°æ®ç»‘å®šã€‚
    - @on{EVENT} ä¸º Razor ç»„ä»¶æä¾›äº‹ä»¶å¤„ç†åŠŸèƒ½ï¼Œæ¯”å¦‚ @onclickã€‚
    - @on{EVENT}:preventDefault ç¦æ­¢äº‹ä»¶çš„é»˜è®¤æ“ä½œã€‚
    - @on{EVENT}:stopPropagation åœæ­¢äº‹ä»¶çš„äº‹ä»¶ä¼ æ’­ã€‚
    - @key æŒ‡ä»¤å±æ€§ä½¿ç»„ä»¶æ¯”è¾ƒç®—æ³•ä¿è¯åŸºäºé”®çš„å€¼ä¿ç•™å…ƒç´ æˆ–ç»„ä»¶ã€‚
    - @ref ç»„ä»¶å¼•ç”¨ (@ref) æä¾›äº†ä¸€ç§å¼•ç”¨ç»„ä»¶å®ä¾‹çš„æ–¹æ³•ï¼Œä»¥ä¾¿å¯ä»¥å‘è¯¥å®ä¾‹å‘å‡ºå‘½ä»¤ã€‚
    - @typeparam æŒ‡ä»¤å£°æ˜ç”Ÿæˆçš„ç»„ä»¶ç±»çš„æ³›å‹ç±»å‹å‚æ•°ã€‚ 


å®Œæ•´çš„æŒ‡ä»¤å‚è€ƒ ASP.NET Core Documentation - Web Application - Razor syntax referenceã€‚


## ==âš¡ Data Bindding æ•°æ®ç»‘å®š

Razor ç»„ä»¶é€šè¿‡åä¸º @bind çš„ HTML å…ƒç´ ç‰¹æ€§æä¾›äº†æ•°æ®ç»‘å®šåŠŸèƒ½ï¼Œè¯¥ç‰¹æ€§å…·æœ‰å­—æ®µã€å±æ€§æˆ– Razor è¡¨è¾¾å¼å€¼ã€‚

ä¸‹é¢çš„ç¤ºä¾‹å°† CurrentValue å±æ€§ç»‘å®šåˆ°æ–‡æœ¬æ¡†çš„å€¼ï¼Œå½“æ–‡æœ¬æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œè¯¥å±æ€§çš„å€¼ä¼šæ›´æ–°ã€‚

å¯ä»¥ä½¿ç”¨ @bind:event æŒ‡å®š oninput äº‹ä»¶ï¼Œåœ¨æ–‡æœ¬æ¡†çš„å€¼æ›´æ”¹æ—¶æ¿€å‘æ›´æ–°ã€‚

æ•°æ®ç»‘å®šä½¿ç”¨ @bind:format å¤„ç† DateTime æ ¼å¼å­—ç¬¦ä¸²ã€‚ ç›®å‰æ— æ³•ä½¿ç”¨å…¶ä»–æ ¼å¼è¡¨è¾¾å¼ï¼Œå¦‚è´§å¸æˆ–æ•°å­—æ ¼å¼ã€‚

    <input @bind="CurrentValue" />
    <input @bind="CurrentValue" @bind:event="oninput" />

    @code {
        private string CurrentValue { get; set; }
    }

    <input @bind="StartDate" @bind:format="yyyy-MM-dd" />

    @code {
        [Parameter]
        public DateTime StartDate { get; set; } = new DateTime(2020, 1, 1);
    }

å°† @bind ä¸ CurrentValue å±æ€§ç»“åˆä½¿ç”¨åœ¨æœ¬è´¨ä¸Šç­‰æ•ˆäº @onchange å¤„ç†æ›´æ–°ï¼š

    <input value="@CurrentValue"
        @onchange="@((ChangeEventArgs __e) => CurrentValue = 
            __e.Value.ToString())" />
            
    @code {
        private string CurrentValue { get; set; }
    }

é€šè¿‡ @bind-{ATTRIBUTE}:event è¯­æ³•ä½¿ç”¨ @bind-{ATTRIBUTE} å¯ç»‘å®šé™¤ value ä¹‹å¤–çš„å…ƒç´ å±æ€§ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå½“ paragraphStyle å€¼æ›´æ”¹æ—¶ï¼Œæ®µè½çš„æ ·å¼ä¼šæ›´æ–°ï¼š

    @page "/binding-example"

    <p>
        <input type="text" @bind="paragraphStyle" />
    </p>

    <p @bind-style="paragraphStyle" @bind-style:event="onchange">
        Blazorify the app!
    </p>

    @code {
        private string paragraphStyle = "color:red";
    }

å¦‚æœç”¨æˆ·å‘æ•°æ®ç»‘å®šå…ƒç´ æä¾›æ— æ³•åˆ†æçš„å€¼ï¼Œåˆ™åœ¨è§¦å‘ç»‘å®šäº‹ä»¶æ—¶ï¼Œæ— æ³•åˆ†æçš„å€¼ä¼šè‡ªåŠ¨è¿˜åŸä¸ºä»¥å‰çš„å€¼ã€‚

    <input @bind="MyProperty" />

    @code {
        [Parameter]
        public int MyProperty { get; set; } = 123;
    }

ç”¨æˆ·åœ¨é¡µé¢ä¸­å°†è¯¥å…ƒç´ çš„å€¼æ›´æ–°ä¸º 123.45ï¼Œå¹¶æ›´æ”¹å…ƒç´ ç„¦ç‚¹ï¼Œå…ƒç´ çš„å€¼ä¼šè¿˜åŸä¸º 123ã€‚


åœ¨ç»„ä»¶çš„ç»‘å®šä¸­ï¼Œæ¶‰åŠå­çº§å’Œçˆ¶çº§ç»„ä»¶çš„å…³ç³»æ—¶ï¼Œä¼šæ¶‰åŠäº‹ä»¶çš„å¤„ç†ã€‚åœ¨å­ç»„ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ EventCallback å‘çˆ¶ç»„ä»¶å…¬å¼€ç»‘å®šæ•°æ®çš„æ›´æ”¹ã€‚ä½¿ç”¨ @bind-{PROPERTY} å¯ä»¥å°†å±æ€§å€¼ä»çˆ¶ç»„ä»¶å‘ä¸‹ç»‘å®šåˆ°å­ç»„ä»¶ã€‚

ä»¥ä¸‹å­ç»„ä»¶ ChildComponent å…·æœ‰ Year ç»„ä»¶å‚æ•°å’Œé…å¥—çš„ YearChanged å›è°ƒï¼š

    <h2>Child Component</h2>

    <p>Year: @Year</p>

    @code {
        [Parameter]
        public int Year { get; set; }

        [Parameter]
        public EventCallback<int> YearChanged { get; set; }
    }

ä»¥ä¸‹çˆ¶ç»„ä»¶ä½¿ç”¨ ChildComponent å¹¶å°† ParentYear å‚æ•°é€šè¿‡ @bind-Year ä»çˆ¶çº§ç»‘å®šåˆ°å­ç»„ä»¶ä¸Šçš„ Year å‚æ•°ã€‚

åˆ©ç”¨ onclick äº‹ä»¶ç”¨äºè§¦å‘çˆ¶ç»„ä»¶çš„ ChangeTheYear æ–¹æ³•æ¥æ›´æ–° ParentYearï¼Œç„¶åæŒ‰ @bind-Year ç»‘å®šå°†æ›´æ–°å€¼ä¼ é€’åˆ°å­ç»„ä»¶ï¼Œå­ç»„ä»¶è‡ªåŠ¨æ‰§è¡Œé…å¥—çš„ YearChanged æ›´æ–°å­ç»„ä»¶ã€‚

    @page "/ParentComponent"

    <h1>Parent Component</h1>

    <p>ParentYear: @ParentYear</p>

    <ChildComponent @bind-Year="ParentYear" />

    <button class="btn btn-primary" @onclick="ChangeTheYear">
        Change Year to 1986
    </button>

    @code {
        [Parameter]
        public int ParentYear { get; set; } = 1978;

        private void ChangeTheYear()
        {
            ParentYear = 1986;
        }
    }

Year å‚æ•°æ˜¯å¯ç»‘å®šçš„ï¼Œå› ä¸ºå®ƒå…·æœ‰ä¸ Year å‚æ•°ç±»å‹ç›¸åŒ¹é…çš„é…å¥— YearChanged äº‹ä»¶ã€‚æŒ‰ç…§çº¦å®šï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•åœ¨æœ¬è´¨ä¸Šç­‰æ•ˆï¼š

    <ChildComponent @bind-Year="ParentYear" />
    <ChildComponent @bind-Year="ParentYear" @bind-Year:event="YearChanged" />

é€šå¸¸ï¼Œå¯ä»¥é€šè¿‡åŒ…å« @bind-{PROPRETY}:event ç‰¹æ€§å°†å±æ€§ç»‘å®šåˆ°å¯¹åº”çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§å°†å±æ€§ MyProp ç»‘å®šåˆ° MyEventHandlerï¼š

    <MyComponent @bind-MyProp="MyValue" @bind-MyProp:event="MyEventHandler" />

ä½ éœ€è¦æ³¨æ„ç»„ä»¶åæ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦é€šè¿‡ using å¼•ç”¨çš„ç»„ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œæ£€æŸ¥ `_Imports.razor`ï¼Œé”™è¯¯å¯èƒ½å¯¼è‡´ Razor æ— æ³•æ¨æ–­ç»‘å®šçš„å±æ€§ã€‚



Blazor æä¾›äº†çº§è”å‚æ•°ç»„ä»¶ CascadingValue å’Œ CascadingParameter çº§è”å±æ€§æ³¨è§£å®ç°è·¨å¤šå±‚çº§çš„æ•°æ®ä¼ é€ã€‚CascadingValue ç”¨æ¥æ¿€æ´»çº§è”å‚æ•°ï¼Œç„¶ååœ¨å­çº§ä½¿ç”¨ CascadingParameter æ¥æ³¨è§£å±æ€§ä»¥è·å–çº§è”ä¼ é€çš„å‚æ•°ã€‚

å¯ä»¥é€šè¿‡å‚æ•° Name æŒ‡å®šä¼ é€’è¿‡ç¨‹ä½¿ç”¨çš„åç§°ï¼Œåœ¨ CascadingParameter æŒ‡å®šæ¥æ”¶å‚æ•°æ—¶ä½¿ç”¨ç›¸åŒçš„ Name å³å¯ä»¥è·å–åˆ°æ•°æ®ã€‚å½“ç„¶ Name æ˜¯å¯é€‰çš„å‚æ•°ï¼ŒCascadingParameter ä¹Ÿå¯ä»¥é€šè¿‡ç±»å‹æ¨å¯¼æ¥è·å–æ•°æ®ã€‚ç¤ºä¾‹ä¸­ï¼Œå¦‚æœ CascadingValue ä¸æŒ‡å®š Nameï¼Œé‚£ä¹ˆï¼ŒComponentA ä¸­ç”± Name è·å–æ•°æ®ã€‚

ä¸‹é¢ç¤ºä¾‹å®šä¹‰ä¸‰ä¸ªç»„ä»¶ï¼ŒComponentB åªä½œä¸ºè·¨å±‚å±•ç¤ºã€‚

    <!-- ComponentA.razor -->
    <div class="bg-white p-3" style="color: #000;">
        <h3>ComponentA</h3>
        <p @onclick="tick">Value: @Value</p>
        <p>Name: @Name</p>
    </div>

    @code {
        private void tick(){
            Name = DateTime.Now.Millisecond.ToString();
        }

        [CascadingParameter(Name = "Value")]
        string Value { get; set; }
        
        [CascadingParameter]
        string Name { get; set; }
    }


    <!-- ComponentB.razor -->
    <div class="bg-secondary jumbotron text-white">
        <h3>ComponentB</h3>
        <ComponentA />
    </div>


    <!-- ComponentC -->
    <div class="bg-primary alert alert-info text-white">

        <h3>ComponentC</h3>
        <p>Name: @_name</p>
        <CascadingValue Value="@_name" Name="Value">
            <ComponentB />
        </CascadingValue>

    </div>

    @code {
        private string _name = "Abo";
    }

çº§è”å‚æ•°åªèƒ½ç”±çˆ¶çº§å‘å­çº§ä¼ é€’æ•°æ®ï¼Œè¦ä»å­çº§å‘çˆ¶çº§ä¼ é€’æ•°æ®ï¼Œè¿˜æ˜¯è¦é€šè¿‡å›è°ƒå§”æ‰˜ã€‚åªéœ€è¦å°†è¯¥å›è°ƒä¹Ÿé€šè¿‡ CascadingValue ä¼ é€’å‡ºå»ï¼Œéœ€è¦å‘ä¸Šä¼ é€’æ•°æ®çš„å­çº§è´Ÿè´£è°ƒç”¨å³å¯ã€‚ä¼ é€’çš„æ–¹æ³•æœ‰å¤šç§ï¼Œä½†æ˜¯æ— è®ºå“ªç§éƒ½éœ€è¦åœ¨è°ƒç”¨çˆ¶ç»„ä»¶çš„ StateHasChanged æ¥å¼ºåˆ¶åˆ·æ–°ã€‚


æ­¤å¤–ï¼Œå¯ä»¥åˆ©ç”¨äº‹ä»¶è®¢é˜…æ¨¡å¼è®¾è®¡ä¸€ä¸ª EventBus æ¥è¿›è¡Œä¸­å¿ƒåŒ–çš„äº‹ä»¶é€šä¿¡ã€‚EventBus éœ€è¦å®ç°ä¸€ä¸ªæ³¨å†Œæ–¹æ³• Addï¼Œç”¨æ¥ç™»è®°é‚£äº›å¯¹æŸäº‹ä»¶æ„Ÿå…´çš„è®¢é˜…è€…æä¾›çš„äº‹ä»¶å§”æ‰˜ï¼Œé…å¥— Remove æ–¹æ³•ç”¨æ¥ç§»é™¤äº‹ä»¶å§”æ‰˜ã€‚EventBus è¿˜è¦å®ç°ä¸€ä¸ªåˆ†æ´¾æ–¹æ³• Dispatchï¼Œä¾›äº‹ä»¶å‘èµ·æ–¹åˆ†å‘äº‹ä»¶ã€‚è¿™é‡Œå®ç°äº†ä¸€ä¸ªç®€åŒ–ç‰ˆ EventBusï¼Œå¯¹æ¯ç§äº‹ä»¶åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè®¢é˜…è€…å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶æ´¾å‘ï¼Œåªä¿ç•™æœ€åæ³¨å†Œçš„äº‹ä»¶å§”æ‰˜æœ‰æ•ˆã€‚

    using System;
    using System.Collections.Generic;
    using System.Threading.Tasks;

    namespace AppWeb
    {

        public static class EventBus
        {
            private static Dictionary<string, Action<object>> _actions;

            public static Add(string event, Action<object> act)
            {
                Remove(event);
                _actions.Add(event, act);
            }

            public static bool Remove(string event)
            {
                if(_actions.ContainsKey(event))
                {
                    _actions.Remove(event);
                    return true;
                }
                return false;
            }

            public static void Dispatch(string event, object arg)
            {
                if(_actions.ContainsKey(event))
                {
                    var act = _actions[event];
                    act.Invoke(arg);
                }
            }
        }
    }


ä¸‹é¢ç»“åˆå¤šç§æ–¹æ³•æ¥å®ç°å­çº§åˆ°çˆ¶çº§çš„æ•°æ®ä¼ é€’ï¼Œä¿®æ”¹ ComponentA å’Œ ComponentC å³å¯ï¼š

    <!-- ComponentA.razor -->
    <div class="bg-white p-3" style="color: #000;">
        <h3>ComponentA</h3>
        <p>Name: @Name</p>
        <p>dp: @dp.value</p>
        <p class="btn btn-primary" @onclick="tick">@cb</p>
    </div>

    @code {

        private void tick(){
            Name = DateTime.Now.Second.ToString();

            EventBus.Dispatch("myevent", "EventBus" + Name);

            cb.Invoke("Callback" + Name);
            dp.StateHasChanged?.Invoke();
            
            System.Threading.Thread.Sleep(1000);
            dp.value = "DataPopup" + Name;
        }

        [CascadingParameter(Name="callback")]
        Action<string> cb {get; set;}

        [CascadingParameter]
        ComponentC.DataPopup dp {get; set;}
        
        [CascadingParameter]
        string Name { get; set; }
        
    }


    <!-- ComponentC -->
    <div class="bg-primary alert alert-info text-white">

        <h3>ComponentC</h3>
        <p>Name: @_name</p>
        <p>dp: @_dp.value</p>
        <CascadingValue Value="@_dp">
            <CascadingValue Value="@_callback" Name="callback">
            <CascadingValue Value="@_name">
                <ComponentB />
            </CascadingValue>
            </CascadingValue>
        </CascadingValue>

    </div>

    @code {
        private string _name = "Abo";
        private DataPopup _dp;
        private Action<object> _callback;

        public void _cb(object v)
        {
            _dp.value = v as string;
        }

        protected override void OnInitialized()
        {
            base.OnInitialized();
            _callback = _cb;
            EventBus.Add("myevent", _callback);
            // EventBus.Add("myevent", e => _name = e as string);
            // EventBus.Add("myevent", delegate(string e){ _cb(e); });
            _dp = new DataPopup(StateHasChanged);
        }

        public class DataPopup
        { 
            public Action StateHasChanged;
            public string value {get; set;}

            public DataPopup( Action shc )
            {
                StateHasChanged += shc;
            }
        }
    }

åœ¨ tick() æ–¹æ³•ä¸­ï¼Œè™½ç„¶æœ‰å¤šä¸ªé€”å¾„æ›´æ–°æ•°æ®ï¼Œä½†æ˜¯ç”±äºä»£ç çš„è¿è¡Œæ˜¯éœ€è¦æœåŠ¡ç«¯çš„ååŒï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨ Sleep å»¶æ—¶ï¼Œæœ€ç»ˆè·å–åˆ°çš„ä¹Ÿæ˜¯ DataPopup å¯¹è±¡ä¼ é€’çš„æ•°æ®ã€‚StateHasChanged çš„è°ƒç”¨é¡ºåºä¹Ÿæ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚




# =ğŸš© ASP.NET Core MVC å…¥é—¨
- [ASP.NET Core MVC å…¥é—¨](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-mvc-app/start-mvc?view=aspnetcore-3.1)
- [Entity Framework Core æ•°æ®å±‚æ¡†æ¶](https://docs.microsoft.com/en-us/ef/core/)
- [Microsoft.EntityFrameworkCore Namespace](https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.entityframeworkcore?view=efcore-2.1)

MVC - Model-View-Controller ä½“ç³»ç»“æ„æ¨¡å¼å°†åº”ç”¨åˆ†æˆ 3 ä¸ªä¸»è¦ç»„ä»¶ï¼Œæœ‰åŠ©äºåˆ›å»ºæ¯”ä¼ ç»Ÿå•ç‰‡åº”ç”¨æ›´æ˜“äºæµ‹è¯•å’Œæ›´æ–°çš„åº”ç”¨ã€‚ åŸºäº MVC çš„åº”ç”¨åŒ…å«ï¼š

- Model æ¨¡å‹ (M)

    è¡¨ç¤ºåº”ç”¨æ•°æ®çš„ç±»ã€‚ æ¨¡å‹ç±»ä½¿ç”¨éªŒè¯é€»è¾‘æ¥å¯¹è¯¥æ•°æ®å¼ºåˆ¶å®æ–½ä¸šåŠ¡è§„åˆ™ã€‚ é€šå¸¸ï¼Œæ¨¡å‹å¯¹è±¡æ£€ç´¢æ¨¡å‹çŠ¶æ€å¹¶å°†å…¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ æœ¬æ•™ç¨‹ä¸­ï¼ŒMovie æ¨¡å‹å°†ä»æ•°æ®åº“ä¸­æ£€ç´¢ç”µå½±æ•°æ®ï¼Œå¹¶å°†å…¶æä¾›ç»™è§†å›¾æˆ–å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚ æ›´æ–°åçš„æ•°æ®å°†å†™å…¥åˆ°æ•°æ®åº“ã€‚

- View è§†å›¾ (V) 

    è§†å›¾æ˜¯æ˜¾ç¤ºåº”ç”¨ç”¨æˆ·ç•Œé¢ (UI) çš„ç»„ä»¶ã€‚ æ­¤ UI é€šå¸¸ä¼šæ˜¾ç¤ºæ¨¡å‹æ•°æ®ã€‚

- Controller æ§åˆ¶å™¨ (C)

    å¤„ç†æµè§ˆå™¨è¯·æ±‚çš„ç±»ã€‚ å®ƒä»¬æ£€ç´¢æ¨¡å‹æ•°æ®å¹¶è°ƒç”¨è¿”å›å“åº”çš„è§†å›¾æ¨¡æ¿ã€‚ åœ¨ MVC åº”ç”¨ä¸­ï¼Œè§†å›¾ä»…æ˜¾ç¤ºä¿¡æ¯ï¼›æ§åˆ¶å™¨å¤„ç†å¹¶å“åº”ç”¨æˆ·è¾“å…¥å’Œäº¤äº’ã€‚ 

ä¾‹å¦‚ï¼Œæ§åˆ¶å™¨å¤„ç†è·¯ç”±æ•°æ®å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†è¿™äº›å€¼ä¼ é€’ç»™æ¨¡å‹ï¼Œè¯¥æ¨¡å‹å¯ä½¿ç”¨è¿™äº›å€¼æŸ¥è¯¢æ•°æ®åº“ã€‚

- `https://localhost:5001/Home/Privacy` å…·æœ‰ Home æ§åˆ¶å™¨çš„è·¯ç”±æ•°æ®ï¼ŒPrivacy ä¸º Home æ§åˆ¶å™¨ä¸Šè°ƒç”¨çš„æ“ä½œæ–¹æ³•ã€‚
- `https://localhost:5001/Movies/Edit/5` æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œç”¨äºé€šè¿‡ç”µå½±æ§åˆ¶å™¨ç¼–è¾‘ ID ä¸º 5 çš„ç”µå½±ã€‚ 
- `<a asp-controller="Home" asp-action="Welcome">Welcome</a>` æ„é€ æ§åˆ¶å™¨è§†å›¾ URL é“¾æ¥ã€‚
- `<a asp-controller="Home" asp-action="Welcome" asp-route-name="Rick">Welcome</a>`æºå¸¦å‚æ•°ï¼ŒURL ä¸º /Home/Welcome?name=Rickã€‚


MVC æ¨¡å¼å¯å¸®åŠ©åˆ›å»ºåˆ†éš”ä¸åŒåº”ç”¨ç‰¹æ€§ï¼ˆè¾“å…¥é€»è¾‘ã€ä¸šåŠ¡é€»è¾‘å’Œ UI é€»è¾‘ï¼‰çš„åº”ç”¨ï¼ŒåŒæ—¶è®©è¿™äº›å…ƒç´ ä¹‹é—´å®ç°æ¾æ•£è€¦åˆã€‚ è¯¥æ¨¡å¼å¯æŒ‡å®šåº”ç”¨ä¸­æ¯ç§é€»è¾‘çš„ä½ç½®ã€‚ UI é€»è¾‘ä½äºè§†å›¾ä¸­ã€‚ è¾“å…¥é€»è¾‘ä½äºæ§åˆ¶å™¨ä¸­ã€‚ ä¸šåŠ¡é€»è¾‘ä½äºæ¨¡å‹ä¸­ã€‚ è¿™ç§éš”ç¦»æœ‰åŠ©äºæ§åˆ¶æ„å»ºåº”ç”¨æ—¶çš„å¤æ‚ç¨‹åº¦ï¼Œå› ä¸ºå®ƒå¯ç”¨äºä¸€æ¬¡å¤„ç†ä¸€ä¸ªå®ç°ç‰¹æ€§ï¼Œè€Œä¸å½±å“å…¶ä»–ç‰¹æ€§çš„ä»£ç ã€‚ ä¾‹å¦‚ï¼Œå¤„ç†è§†å›¾ä»£ç æ—¶ä¸å¿…ä¾èµ–ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚


## ==âš¡ View & Controller
- [Web API åº”ç”¨å¼€å‘](https://docs.microsoft.com/zh-cn/aspnet/core/web-api/?view=aspnetcore-3.1)
- [Web Apps MVC Routing](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1)
- [ASP.Net Core HttpContext Class](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpcontext?view=aspnetcore-3.1)
- [ASP.Net Core Controller Class](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.controller?view=aspnetcore-3.1)
- [MVC è·¯ç”±è®¾ç½®](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1)

åˆ›å»º MVC åº”ç”¨:

    dotnet new mvc -o MvcMovie
    code -r MvcMovie

ä½¿ç”¨ VS Code æ‰“å¼€é¡¹ç›®ï¼Œæç¤ºå¯¹è¯æ¡†æ¶ä¼šè¯¢é—®æ˜¯å¦è¦ä¸ºé¡¹ç›®æ·»åŠ  build and debug é…ç½®ï¼Œé€‰æ‹© Yes ç”Ÿæˆ .vscode ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶æ–¹ä¾¿å¼€å‘æ‰§è¡Œ build/publish/watch ç­‰ä»»åŠ¡ã€‚

MVC é¡¹ç›®æœ‰å¯¹åº”çš„ç›®å½•ç»“æ„ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œä»¥åŠ MVC æ ¸å¿ƒè·¯é€»è¾‘çš„æ˜ å°„ï¼š

- Controllers å­˜æ”¾æ§åˆ¶å™¨çš„ç›®å½•ï¼›
- Models å­˜æ”¾æ¨¡å‹çš„ç›®å½•ï¼›
- Views å­˜æ”¾è§†å›¾çš„ç›®å½•ï¼›

MVC é¡¹ç›®çš„ Startup é…ç½®å…³é”®æœ‰ä¸¤ç‚¹ï¼ŒAddControllersWithViews æ¿€æ´» MVCï¼ŒMapControllerRoute é…ç½® MVC è·¯ç”±ï¼Œè¿™é‡Œé…ç½®ä¸€ä¸ªç›®æ ‡æŒ‡å‘ Home æ§åˆ¶å™¨çš„è·¯ç”±ï¼š

    public class Startup
    {
        ...
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllersWithViews();
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
        ...
            app.UseEndpoints(endpoints =>
            {
                endpoints.MapControllerRoute(
                    name: "default",
                    pattern: "{controller=Home}/{action=Index}/{id?}");
            });
        }
    }

ASP.Net Core ä¸­ï¼Œæ§åˆ¶å™¨æœ‰ä¸¤ç±»ï¼ŒControllerBase å’Œ Controllerã€‚ 

æ ¹æ®æƒ¯ä¾‹ï¼Œæ ‡å‡†æ§åˆ¶å™¨ç±»ï¼š

- é©»ç•™åœ¨é¡¹ç›®çš„ /Controllers æ–‡ä»¶å¤¹ä¸­ã€‚
- ç»§æ‰¿è‡ª Microsoft.AspNetCore.Mvc.Controllerã€‚

æ ‡å‡†æ§åˆ¶å™¨æ˜¯ä¸€ä¸ªå¯å®ä¾‹åŒ–çš„ç±»ï¼Œå…¶ä¸­ä¸‹åˆ—æ¡ä»¶è‡³å°‘æŸä¸€ä¸ªä¸º trueï¼š

- ç±»åç§°å¸¦æœ‰ Controller åç¼€ï¼Œæ–‡ä»¶åä¸ç”¨ã€‚
- è¯¥ç±»ç»§æ‰¿è‡ªå¸¦æœ‰ Controller åç¼€çš„ç±»ã€‚
- [Controller] ç‰¹æ€§åº”ç”¨äºè¯¥ç±»ã€‚

æ§åˆ¶å™¨ç±»ä¸å¯å«æœ‰å…³è”çš„ [NonController] å±æ€§ç‰¹æ€§ã€‚

åœ¨æŒ‡å®šäº† [ApiController] ç‰¹æ€§çš„æ§åˆ¶å™¨ï¼Œå³ RESTful API æ§åˆ¶å™¨ï¼Œä¹Ÿç§°ä¸º Web APIã€‚Web API ä¸­çš„æ§åˆ¶å™¨æ˜¯æ´¾ç”Ÿè‡ª ControllerBase çš„ç±»ã€‚ 

åœ¨ Startup ä¸­é€šè¿‡ endpoints.MapControllerRoute é…ç½®å¥½ MVC è·¯ç”±åï¼Œå°±å¯ä»¥å¼€å§‹æ§åˆ¶å™¨çš„è®¾è®¡ï¼š

    using System;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Extensions.Logging;

    namespace MvcMovie.Controllers
    {
        [Controller]
        public class HomeController : Controller
        {
            private readonly ILogger<HomeController> _logger;

            public HomeController(ILogger<HomeController> logger)
            {
                _logger = logger;
            }

            public IActionResult Index()
            {
                return View();
            }

            public IActionResult Privacy()
            {
                return View();
            }

            [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
            public IActionResult Error()
            {
                return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
            }

            // GET: /Home/Welcome/ 
            // Requires using System.Text.Encodings.Web;
            public string WelcomePlain(string name, int numTimes = 1)
            {
                return HtmlEncoder.Default.Encode($"Hello {name}, NumTimes is: {numTimes}");
            }

            public IActionResult Welcome(string name, int numTimes = 1)
            {
                ViewData["Message"] = "Hello " + name;
                ViewData["NumTimes"] = numTimes;

                return View();
            }
        }
    }


è¿™ä¸ªæ§åˆ¶å™¨ç±»ä½¿ç”¨äº†ä»¥ä¸‹ [Route] å±æ€§ç‰¹æ€§ï¼Œæ¥å®šä¹‰æ§åˆ¶çš„è·¯ç”±è·¯å¾„ã€‚

    [Route("[controller]")]

æ§åˆ¶å™¨ä¸Šçš„å…¬å…±æ–¹æ³•å‡ä¸º Action æ“ä½œï¼Œé™¤äº†é‚£äº›å¸¦æœ‰ `[NonAction]` å±æ€§ç‰¹æ€§çš„æ–¹æ³•ã€‚ æ“ä½œä¸Šçš„å‚æ•°ä¼šç»‘å®šåˆ°è¯·æ±‚æ•°æ®ï¼Œå¹¶ä½¿ç”¨æ¨¡å‹ç»‘å®šè¿›è¡ŒéªŒè¯ã€‚ æ‰€æœ‰æ¨¡å‹ç»‘å®šçš„å†…å®¹éƒ½ä¼šæ‰§è¡Œæ¨¡å‹éªŒè¯ã€‚ ModelState.IsValid å±æ€§å€¼æŒ‡ç¤ºæ¨¡å‹ç»‘å®šå’ŒéªŒè¯æ˜¯å¦æˆåŠŸã€‚


è§†å›¾æ–¹æ³•å¯ä»¥å®šä¹‰æ¥æ”¶å‚æ•°ï¼Œå‚æ•°ä¿¡æ¯ä» URL ä¼ é€’åˆ°æ§åˆ¶å™¨ã€‚ ä¾‹å¦‚ä»¥ä¸‹åŠ©æ‰‹æ ‡ç­¾æ„é€ å’Œç›¸åº” HTML æ ‡ç­¾é“¾æ¥ï¼š

    <a asp-area="" asp-controller="Home" asp-action="Welcome" asp-route-numtimes="4">Welcome</a>

    <a href="/Home/Welcome?name=Rick&numtimes=4">Welcome</a>

ä»¥ä¸Šä½¿ç”¨çš„åŠ©æ‰‹æ ‡ç­¾ç±» tag-helpersï¼Œå¯ä»¥åœ¨ ViewImports æ–‡ä»¶ä¸­æ‰¾åˆ°å¼•ç”¨ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨åŠ©æ‰‹æ ‡ç­¾æ¥å®šåˆ¶ HTML æ ‡è®°ï¼š

    @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

å¦‚æœæµè§ˆé¡µé¢æ—¶å‘ç°åŠ©æ‰‹æ ‡ç­¾å¹¶æ²¡æœ‰ç”Ÿæˆç›¸åº”çš„ HTML æ ‡ç­¾ï¼Œé‚£ä¹ˆå¯èƒ½å°±æ˜¯æ²¡æœ‰æ·»åŠ  tag-helpers çš„å¼•ç”¨ã€‚


æ§åˆ¶å™¨æ–¹æ³•ï¼Œå³ Action é€šå¸¸è¿”å› IActionResult æˆ– ActionResult æ´¾ç”Ÿç±»çš„æ§åˆ¶å™¨æ–¹æ³•ï¼Œé€šè¿‡æ§åˆ¶å™¨çš„ View æ–¹æ³•ï¼Œä»¥çº¦å®šçš„é…å¥—è§†å›¾è¾“å‡ºåˆ°å®¢æˆ·ç«¯ã€‚ä»¥ä¾¿ä¸‹å’Œæ§åˆ¶å™¨æ–¹æ³•åç§°å¯¹åº”çš„è§†å›¾æ–‡ä»¶å°±ä¼šè¢«åŠ è½½ï¼š

- /Views/Home/Index.cshtml
- /Views/Home/Privacy.cshtml
- /Views/Home/Error.cshtml
- /Views/Home/Welcome.cshtml


æ§åˆ¶å™¨æœ‰ä¸‰ç§äº‹ä»¶ï¼š

- OnActionExecuted  äº‹ä»¶ä¼šåœ¨ Action æ‰§è¡Œåè§¦å‘ï¼Œä¼ å…¥å‚æ•° ActionExecutedContextï¼›
- OnActionExecuting äº‹ä»¶ä¼šåœ¨ Action æ‰§è¡Œå‰è§¦å‘ï¼Œä¼ å…¥å‚æ•° ActionExecutingContextï¼›
- OnActionExecutionAsync    æ‰§è¡Œå‰äº‹ä»¶çš„å¼‚æ­¥æ–¹å¼ï¼Œå…¥å‚ ActionExecutingContext, ActionExecutionDelegateï¼›


ä»¥ä¸‹æ˜¯å¸¸ç”¨è¿”å›è§†å›¾å’Œå·²æ ¼å¼åŒ–çš„å“åº”ï¼Œå‚è€ƒé¡µé¢å¸ƒå±€ï¼š

- Json(Object)  åˆ›å»º JsonResultï¼Œå°†å‚æ•°å¯¹è±¡åºåˆ—åŒ–ä¸º JSONï¼›

- Partial View é¡µé¢ç‰‡æ–­æ¸²æŸ“

    - PartialView() åˆ›å»º PartialViewResult æ¸²æŸ“é¡µé¢çš„å…¶ä¸­éƒ¨åˆ†ï¼›
    - PartialView(String)   åˆ›å»º PartialViewResultï¼ŒæŒ‡å®šè§†å›¾æ–‡ä»¶åï¼›
    - PartialView(Object)   åˆ›å»º PartialViewResultï¼ŒæŒ‡å®šæ¨¡å‹æ•°æ®å‚æ•°ï¼›
    - PartialView(String, Object)   åˆ›å»º PartialViewResultï¼ŒæŒ‡å®šè§†å›¾æ–‡ä»¶åå’Œæ¨¡å‹æ•°æ®ï¼›

- View åŸºæœ¬è§†å›¾æ¸²æŸ“

    - View()    åˆ›å»º ViewResult ä»¥æ¸²æŸ“é¡µé¢ï¼›
    - View(Object)  åˆ›å»º ViewResultï¼ŒæŒ‡å®šæ¨¡å‹å¯¹è±¡æ¸²æŸ“é¡µé¢ï¼›
    - View(String)  åˆ›å»º ViewResultï¼ŒæŒ‡å®šè§†å›¾æ–‡ä»¶åï¼›
    - View(String, Object)  åˆ›å»º ViewResultï¼ŒæŒ‡å®šè§†å›¾æ–‡ä»¶åå’Œæ¨¡å‹å¯¹è±¡ï¼›

- View Comoponent è§†å›¾ç»„ä»¶æ¸²æŸ“

    - ViewComponent(String) åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶æ–‡ä»¶åæ¸²æŸ“ï¼›
    - ViewComponent(Type)   åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶ç±»å‹ï¼›
    - ViewComponent(String, Object) åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶æ–‡ä»¶ååŠå‚æ•°å¯¹è±¡ï¼›
    - ViewComponent(Type, Object)   åˆ›å»º ViewComponentResultï¼ŒæŒ‡å®šç»„ä»¶ç±»å‹å’Œå‚æ•°å¯¹è±¡ï¼›


å½“æ“ä½œè¿”å›å…¶å®ƒä»»ä½•æ•°æ®ç±»å‹æ—¶ï¼Œå°±ä¼šåº”ç”¨å†…å®¹åå•†ç»“æœæ ¼å¼åŒ–çš„å“åº”ã€‚æ¯”å¦‚æ–¹æ³•è¿”å›å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ç›´æ¥å°†å­—ç¬¦ä¸²è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿”å›å…¶å®ƒå¯¹è±¡æ—¶ï¼Œå°±ä¼šæ ¹æ®è¿›è¡Œå†…å®¹åå•† Content Negotiationï¼Œå³æ ¹æ® HTTP è¯·æ±‚å¤´çš„ Accept æ¥å†³å®šè¾“å‡ºï¼Œæ”¯æŒ application/json, text/json, text/plain ç­‰ï¼ŒASP.Net Core é»˜è®¤ä¸º JSONã€‚ 

æ§åˆ¶å™¨å®šä¹‰äº†å“åº”å„ç§ HTTP çŠ¶æ€çš„æ–¹æ³•ï¼Œå®ƒä»¬ä¼šè®¾ç½® HTTP å“åº”æ ‡å¤´çš„çŠ¶æ€ç ï¼Œè¿˜æœ‰å„ç§ç”¨äºé‡å®šå‘çš„æ–¹æ³•ã€‚ BadRequest å’Œ Ok ä»…åœ¨ä¼ é€’äº†å€¼çš„æ—¶å€™æ‰æ‰§è¡Œå†…å®¹åå•†ï¼Œåœ¨æ²¡æœ‰ä¼ é€’å€¼çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬å……å½“ HTTP çŠ¶æ€ç ç»“æœç±»å‹ã€‚ å¦ä¸€æ–¹é¢ï¼ŒCreatedAtRoute æ–¹æ³•å§‹ç»ˆæ‰§è¡Œå†…å®¹åå•†ï¼Œå› ä¸ºå®ƒçš„é‡è½½å‡è¦æ±‚ä¼ é€’ä¸€ä¸ªå€¼ã€‚

ä»¥ä¸‹éƒ¨åˆ†å‚è€ƒï¼š

    return NoContent(); // HTTP 204
    return Ok(value); // HTTP 200
    return NotFound(); // HTTP 404
    return BadRequest(ModelState); // HTTP 400
    return Redirect(url); // HTTP 302
    return LocalRedirect(localurl);
    return RedirectToPage(string, object);
    return RedirectToAction("Complete", new {id = 123});
    return CreatedAtRoute("routename", values, newobject); 


MVC çš„ è§†å›¾æ–‡ä»¶å’Œ Razor Page éƒ½æ˜¯ä½¿ç”¨ Razor è¯­æ³•çš„ï¼Œåªæ˜¯ @page æŒ‡ä»¤ä¼šå°†è§†å›¾è½¬åŒ–ä¸º Razor Page ç±»å‹ï¼Œæ‰€ä»¥åœ¨ MVC è§†å›¾ä¸­ä¸èƒ½ä½¿ç”¨ã€‚

    @page
    @model IndexModel
    @{
        ViewData["Title"] = "Home page";
    }


åœ¨è§†å›¾ä¸­ï¼Œä½¿ç”¨ ViewData å­—å…¸ä»æ§åˆ¶å™¨ä¼ é€’æ•°æ®ï¼Œä¼ é€’æ•°æ®çš„è§†å›¾æ¨¡å‹æ–¹æ³•é€šå¸¸æ¯” ViewData å­—å…¸æ–¹æ³•æ›´ä¸ºä¼˜å…ˆã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ä½•æ—¶ä½¿ç”¨ ViewBagã€ViewData æˆ– TempDataã€‚

- ViewData å­—å…¸å¯¹è±¡ï¼Œç»§æ‰¿è‡ª ViewDataDictionaryï¼Œå¦‚ ViewBag["Product"] = "something";
- ViewBag å°è£…äº† ViewDataï¼Œå…è®¸ä½¿ç”¨åŠ¨æ€å±æ€§ï¼Œå¦‚ ViewBag.Product = "something";
- TempData å­—å…¸å¯¹è±¡ï¼Œç”¨åœ¨ä¸´æ—¶è¿‡ç¨‹ï¼Œæ¯”å¦‚å½“å‰è¿™ä¸ªå¤šä¸ªè¯·æ±‚é—´ã€‚






### ===âœ’ API Controllers
- [MVC è·¯ç”±è®¾ç½®](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1)
- [Format Respose data](https://docs.microsoft.com/en-us/aspnet/core/web-api/advanced/formatting?view=aspnetcore-3.1)
- [ASP.NET Core Web API è‡ªå®šä¹‰æ ¼å¼åŒ–ç¨‹åº](https://docs.microsoft.com/zh-cn/aspnet/core/web-api/advanced/custom-formatters?view=aspnetcore-3.1)
- [Web API åº”ç”¨](https://docs.microsoft.com/zh-cn/aspnet/core/web-api/?view=aspnetcore-3.1#apicontroller-attribute)
- [ä½¿ç”¨ ASP.NET Core åˆ›å»º Web API](https://docs.microsoft.com/zh-cn/aspnet/core/web-api/?view=aspnetcore-3.1)


ä¸åŒçš„ç”¨é€”çš„æ§åˆ¶å™¨ç±»å¯ä»¥ç»§æ‰¿ä¸åŒçš„åŸºç±»ï¼Œæ ‡å‡†çš„ MVC æ§åˆ¶å•ç»§æ‰¿ Controller åŸºç±»ï¼Œè·å–è§†å›¾åŠæ•°æ®ä¼ é€’åŠŸèƒ½ã€‚

è€Œç”¨äº RESTful API çš„æ§åˆ¶å™¨ï¼Œå¯ä»¥ç»§æ‰¿æ›´ç²¾ç®€çš„ ControllerBase åŸºç±»ï¼Œå…¶è·¯ç”±æ³¨å†Œçš„æ–¹å¼ä½¿ç”¨å±æ€§ç‰¹æ€§è®¾ç½®ï¼Œå’Œæ ‡å‡†æ§åˆ¶å™¨æœ‰å·®åˆ«ã€‚

ä»¥ä¸‹æ˜¯ API ä¸­å¸¸ç”¨çš„å±æ€§ç‰¹æ€§ï¼š

| ç‰¹æ€§    | è¯´æ˜ |
| :---- | :--- |
| [ApiController]   | æŒ‡å®šæ§åˆ¶å™¨ä¸º API æ§åˆ¶è¡Œä¸ºï¼Œå¦‚ Model Binding æ¨¡å‹ç»‘å®šã€‚ |
| [Route]   | æŒ‡å®šæ§åˆ¶å™¨æˆ–æ“ä½œçš„ URL æ¨¡å¼ã€‚ |
| [Bind]    | æŒ‡å®šè¦åŒ…å«çš„å‰ç¼€å’Œå±æ€§ï¼Œä»¥è¿›è¡Œæ¨¡å‹ç»‘å®šã€‚ |
| [HttpGet] æ ‡è¯†æ”¯æŒ HTTP GET |æ“ä½œè°“è¯çš„æ“ä½œã€‚ |
| [Consumes]    | æŒ‡å®šæŸä¸ªæ“ä½œæ¥å—çš„æ•°æ®ç±»å‹ã€‚ |
| [Produces]    | æŒ‡å®šæŸä¸ªæ“ä½œè¿”å›çš„æ•°æ®ç±»å‹ã€‚ |
| [NonAction]   | æŒ‡å®šçš„æ§åˆ¶å™¨æ–¹æ³•ä¸å“åº” Action åŠ¨ä½œã€‚ |

åœ¨å¼€å‘æ§åˆ¶å™¨æ—¶ï¼Œä¼šéœ€è¦æµ‹è¯• API æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨å›¾å½¢åŒ–å·¥å…·ï¼Œå¦‚ Fiddler ä¹Ÿå¯ä»¥ä½¿ç”¨åƒ Curl è¿™æ ·çš„å‘½ä»¤è¡Œå·¥å…·ï¼š

    curl -i -H "Content-Type:application/json" -d "{""Id"":""122"", ""Text"":""name"", ""Description"":""anything""}" -X POST http://127.0.0.1:5001/api/item

[ApiController] å±æ€§å¯åº”ç”¨äºæ§åˆ¶å™¨ç±»ï¼Œä»¥å¯ç”¨ä¸‹è¿° API ç‰¹å®šçš„å›ºå®šè¡Œä¸ºï¼š

- å±æ€§è·¯ç”±è¦æ±‚

    ä¸èƒ½é€šè¿‡ Startup ä¸­çš„ UseEndpointsã€UseMvc æˆ– UseMvcWithDefaultRoute å®šä¹‰çš„ä¼ ç»Ÿè·¯ç”±è®¿é—®æ“ä½œã€‚

- è‡ªåŠ¨ HTTP 400 å“åº”

    ä½¿æ¨¡å‹éªŒè¯é”™è¯¯è‡ªåŠ¨è§¦å‘ HTTP 400 å“åº”ã€‚ASP.NET Core MVC ä½¿ç”¨ ModelStateInvalidFilter æ“ä½œç­›é€‰å™¨æ¥æ‰§è¡Œä¸Šè¿°æ£€æŸ¥ã€‚

- ç»‘å®šæºå‚æ•°æ¨ç†

    æ•°æ®æºç»‘å®šç‰¹æ€§å®šä¹‰å¯æ‰¾åˆ°æ“ä½œå‚æ•°å€¼çš„ä½ç½®ï¼Œï¼Œå‚è€ƒæ•°æ®ç»‘å®š Data Bindingã€‚

    | [FromBody]    | è¯·æ±‚æ­£æ–‡ |
    | :---------    | :------ |
    | [FromForm]    | è¯·æ±‚æ­£æ–‡ä¸­çš„è¡¨å•æ•°æ® |
    | [FromHeader]  | è¯·æ±‚æ ‡å¤´ |
    | [FromQuery]   | è¯·æ±‚æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•° |
    | [FromRoute]   | å½“å‰è¯·æ±‚ä¸­çš„è·¯ç”±æ•°æ® |
    | [FromServices]    | ä½œä¸ºæ“ä½œå‚æ•°æ’å…¥çš„è¯·æ±‚æœåŠ¡ |

- Multipart/form-data è¯·æ±‚æ¨ç†

    ä½¿ç”¨ FromFormattribute å±æ€§æ‰¹æ³¨æ“ä½œå‚æ•°æ—¶ï¼Œ[ApiController] å±æ€§åº”ç”¨æ¨ç†è§„åˆ™ã€‚ å°†æ¨æ–­ multipart/form-data è¯·æ±‚å†…å®¹ç±»å‹ã€‚

- é”™è¯¯çŠ¶æ€ä»£ç çš„é—®é¢˜è¯¦ç»†ä¿¡æ¯

    å½“å…¼å®¹æ€§ç‰ˆæœ¬ä¸º 2.2 æˆ–æ›´é«˜ç‰ˆæœ¬æ—¶ï¼ŒMVC ä¼šå°†é”™è¯¯ç»“æœï¼ˆçŠ¶æ€ä»£ç ä¸º 400 æˆ–æ›´é«˜çš„ç»“æœï¼‰è½¬æ¢ä¸ºçŠ¶æ€ä»£ç ä¸º ProblemDetails çš„ç»“æœã€‚ ProblemDetails ç±»å‹åŸºäº RFC 7807 è§„èŒƒï¼Œç”¨äºæä¾› HTTP å“åº”ä¸­è®¡ç®—æœºå¯è¯»çš„é”™è¯¯è¯¦ç»†ä¿¡æ¯ã€‚

ä½¿ç”¨ [Consumes] å±æ€§å®šä¹‰æ”¯æŒçš„è¯·æ±‚å†…å®¹ç±»å‹
é»˜è®¤æƒ…å†µä¸‹ï¼Œæ“ä½œæ”¯æŒæ‰€æœ‰å¯ç”¨çš„è¯·æ±‚å†…å®¹ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨é…ç½®ä¸ºåŒæ—¶æ”¯æŒ JSON å’Œ XML è¾“å…¥æ ¼å¼åŒ–ç¨‹åºï¼Œé‚£ä¹ˆæ“ä½œæ”¯æŒå¤šç§å†…å®¹ç±»å‹ï¼Œå…¶ä¸­åŒ…æ‹¬ application/json å’Œ application/xmlã€‚
ä½¿ç”¨ [Consumes] å±æ€§ï¼Œæ“ä½œå¯ä»¥é™åˆ¶æ”¯æŒçš„è¯·æ±‚å†…å®¹ç±»å‹ã€‚ å°† [Consumes] å±æ€§åº”ç”¨äºæ“ä½œæˆ–æ§åˆ¶å™¨ï¼ŒåŒæ—¶æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå†…å®¹ç±»å‹ï¼š

    [HttpPost]
    [Consumes("application/xml")]
    public IActionResult CreateProduct(Product product)

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒCreateProduct æ“ä½œæŒ‡å®šå†…å®¹ç±»å‹ application/xmlã€‚ è·¯ç”±åˆ°æ­¤æ“ä½œçš„è¯·æ±‚å¿…é¡»æŒ‡å®š application/xml çš„ Content-Type å¤´ã€‚ å¦‚æœè¯·æ±‚æœªæŒ‡å®š application/xml çš„ Content-Type å¤´ï¼Œä¼šç”Ÿæˆ 415 ä¸æ”¯æŒçš„åª’ä½“ç±»å‹å“åº”ã€‚


ä¸‹é¢æ˜¯ ControllerBase æä¾›çš„å¸¸ç”¨æ–¹æ³•ã€‚

| æ–¹æ³•    | è¯´æ˜ |
| :---- | :--- |
| BadRequest    | è¿”å› 400 çŠ¶æ€ä»£ç ã€‚ |
| NotFound  | è¿”å› 404 çŠ¶æ€ä»£ç ã€‚ |
| PhysicalFile  | è¿”å›æ–‡ä»¶ã€‚ |
| TryUpdateModelAsync   | è°ƒç”¨æ¨¡å‹ç»‘å®šã€‚ |
| TryValidateModel  | è°ƒç”¨æ¨¡å‹éªŒè¯ã€‚ |


è¦æ ‡è®°  RESTful API æ§åˆ¶å™¨ï¼Œå¯ä»¥ä½¿ç”¨ ApiControllerAttribute å±æ€§æ ‡è®°ï¼ŒRouteAttribute ç”¨æ¥è‡ªå®šä¹‰è·¯ç”±ï¼Œé‚£ä¹ˆ Hello æ§åˆ¶å™¨ç±»å¯¹åº”çš„è®¿é—® URL å°±æ˜¯ /api/hello:

    [Route("api/[controller]")]
    [ApiController]
    public class Hello : Controller
    {
        ...
    }

API çš„æ–¹æ³•è¿˜éœ€è¦å®šä¹‰ HTTP è°“è¯ï¼Œå³è¯·æ±‚æ–¹å¼çš„å±æ€§æ ‡è®°ï¼Œéƒ½æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œä¸€ä¸ªæ— å‚æ•°ï¼Œå¦ä¸€ä¸ªæ¥æ”¶ String å‚æ•°ä½œä¸ºè·¯ç”±æ¨¡æ¿ä»¥é…ç½® URL å‚æ•°ï¼Œå®ƒä»¬å®šä¹‰åœ¨ Microsoft.AspNetCore.Mvc å‘½åç©ºé—´ï¼š

    [HttpGet]
    [HttpGet("{id}")]
    [HttpPut("{id}")]
    [HttpPost]
    [HttpDelete("{id}")]
    [HttpHead]
    [HttpOptions]
    [HttpPatch]

åƒ {id} æˆ– {id}/{name?} è¿™æ ·çš„æ¨¡æ¿å‚æ•°ï¼Œå¯¹åº” URL åŒ¹é… `/api/hello/1?name=x` æˆ–è€… `/api/hello/1/x`ï¼Œä½†ä¸ä¼šåŒ¹é…åˆ° `/api/hello?id=1&name=x`ã€‚ä¹Ÿå°±æ˜¯è¯´åªåŒ¹é… URL ä¸­çš„ Path éƒ¨åˆ†ï¼Œè€Œä¸ç®¡é—®å·åçš„æŸ¥è¯¢å­—ç¬¦ä¸²å€¼ã€‚id å‚æ•°ä¸é»˜è®¤è·¯ç”±åŒ¹é…ï¼Œå› æ­¤ id æ·»åŠ åˆ°è·¯ç”±æ•°æ®ã€‚è¦å°† name å‚æ•°æ·»åŠ åˆ°è·¯ç”±æ•°æ®ï¼Œå°±ä¿®æ”¹ Statup ä¸­æ§åˆ¶å™¨è·¯ç”±æ˜ å°„å…³ç³»ï¼š

    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Hello}/{action=Index}/{id?}/{name?}");

å¯¹åº”çš„ anchor-tag-helperï¼š

    <a asp-area="" asp-controller="api" asp-action="hello" asp-route-id="1" asp-route-name="x">API</a>

    @Html.ActionLink("API", "hello", "api", new { id = 1, name = "x" })

@Html.ActionLink å®Œå…¨å‚æ•°ç­¾åå¦‚ä¸‹ï¼Œè¦ç”Ÿæˆä¸€ä¸ªæŒ‡å‘é™æ€é¡µé¢çš„åœ°å€ï¼Œä¸ä½¿ç”¨ asp- å³å¯ï¼Œä¹Ÿå¯ä»¥ç•™ç©º asp-actionï¼Œå°†é¡µé¢åœ°å€ä¼ å…¥ controllerï¼š

    @Html.ActionLink("linkText", "actionName", "controllerName", routeValues, htmlAttributes)

    <a class="nav-link text-dark" asp-area="" asp-controller="/index.html" asp-action="">static</a>
    <a class="nav-link text-dark" href="/index.html">contoso.com</a>


è¦å…è®¸å¤šä¸ª HTTP è°“è¯ç”¨äºæŸä¸ªæ“ä½œï¼Œæˆ–å…è®¸é™¤ GETã€PUTã€POSTã€DELETEã€HEADã€OPTIONS å’Œ PATCH ä»¥å¤–çš„ HTTP [AcceptVerbs] è°“è¯ï¼Œè¯·ä½¿ç”¨è¯¥å±æ€§ï¼Œè¯¥å±æ€§é‡‡ç”¨ HTTP è°“è¯çš„åˆ—è¡¨ã€‚

    public class ProductsController : ApiController
    {
        [AcceptVerbs("GET", "HEAD")]
        public Product FindProduct(id) { }

        // WebDAV method
        [AcceptVerbs("MKCOL")]
        public void MakeCollection() { }
    }

è¦é˜²æ­¢å°†æ–¹æ³•ä½œä¸ºæ“ä½œè°ƒç”¨ï¼Œè¯·ä½¿ç”¨å±æ€§æ ‡è®° `[NonAction]`ã€‚ è¿™å‘æ¡†æ¶å‘å‡ºä¿¡å·ï¼Œè¯´æ˜è¯¥æ–¹æ³•ä¸æ˜¯æ“ä½œï¼Œå³ä½¿å®ƒä»¥å…¶ä»–æ–¹å¼ä¸è·¯ç”±è§„åˆ™åŒ¹é…ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

æ³¨æ„ï¼Œä½¿ç”¨è·¯ç”±å±æ€§ç‰¹æ€§æ—¶ï¼Œåœ¨æ§åˆ¶å™¨å¯¹è±¡åŠæ–¹æ³•ä¸Šè®¾ç½®çš„å±æ€§è·¯ç”±ä¼šå åŠ ç”Ÿæˆæœ€ç»ˆçš„è·¯ç”±è§„åˆ™ï¼Œå¦‚ä¸‹ï¼š

    [Route("api/[controller]")]
    public class Hello : Controller
    {
        [Route("api/hello/edit", Name="api_edit")]
        [HttpGet("{id}")]
        public object GetUserDTO(int id, string name)

ä¸ºäº†çœ‹åˆ°æœ€åç”Ÿæˆçš„è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥åˆ©ç”¨è„šæ‰‹æ ‡ç­¾çš„ URL ç”ŸæˆåŠŸèƒ½ã€‚åº”ç”¨å¯ä»¥ä½¿ç”¨è·¯ç”± URL ç”ŸæˆåŠŸèƒ½æ¥ç”ŸæˆæŒ‡å‘æ“ä½œçš„ URL é“¾æ¥ã€‚ ç”Ÿæˆ URL å¯æ¶ˆé™¤ç¡¬ç¼–ç  URLï¼Œä½¿ä»£ç æ›´å¯é å’Œæ›´æ˜“äºç»´æŠ¤ã€‚ 

é€šè¿‡ç»™ asp-route æ¥æŒ‡å®šä¸€ä¸ªå‘½åè·¯ç”±ï¼Œå³ä¸Šé¢ä»£ç ä¸­æŒ‡å®šçš„ `Name="api_edit` è¿™ä¸ªè·¯ç”±åç§°ï¼ŒåŠ©æ‰‹æ ‡ç­¾åŠç”Ÿæˆçš„ HTML æ ‡ç­¾å¦‚ä¸‹ï¼š

    <a asp-area="" asp-route="api_edit">Edit</a> |

    <a href="/api/Hello/api/hello/edit"></a>


å‡å¦‚ï¼Œé…ç½®äº†ä»¥ä¸‹å¸¦æœ‰è‡ªå®šä¹‰å‰ç¼€çš„è·¯ç”±ï¼š

    [Route("api/[controller]")]

è¿™ç§è·¯ç”±ä¸€èˆ¬æ˜¯ä¸º API æ§åˆ¶å™¨ä½¿ç”¨çš„ï¼Œæ— æ³•é€šè¿‡ asp-controller å’Œ asp-action æˆ– asp-pageã€asp-handler æ¥ç”Ÿæˆå¯¹åº” URL çš„ã€‚API æ§åˆ¶å™¨ä¸­æ¿€æ´»äº†å±æ€§è·¯ç”±ï¼Œä¸€èˆ¬ä¹Ÿä¸åœ¨ URL æŒ‡å®š Actionï¼Œç›´æ¥é€šè¿‡æ§åˆ¶å™¨åç§°åŠ å‚æ•°åˆ—è¡¨åŒ¹é…ä¸€ä¸ªæ“ä½œï¼Œé€šè¿‡å±æ€§ç‰¹æ€§æŒ‡å®š HTTP è°“è¯ã€‚

ä½¿ç”¨å‘½åè·¯ç”± asp-route æ˜¯ä¸€ç§è§£å†³æ–¹æ³•ã€‚æˆ–è€…ä½¿ç”¨ HTML é“¾æ¥æ ‡ç­¾ï¼Œæ³¨æ„ä¸èƒ½ä½¿ç”¨ asp- å±æ€§ï¼Œä»¥å…æ¿€æ´» ASP.Net Core çš„åŠ©æ‰‹æ ‡ç­¾ã€‚

äºŒæ˜¯ä½¿ç”¨ URL ç”Ÿæˆï¼ŒIUrlHelper æ¥å£æ˜¯ MVC ç”¨äºç”Ÿæˆ URL è·¯ç”±çš„åŸºç¡€å…ƒç´ ï¼ŒIUrlHelper å®ä¾‹å¯é€šè¿‡æ§åˆ¶å™¨ã€è§†å›¾åŠè§†å›¾ç»„ä»¶ä¸­çš„ Url å±æ€§å¼•ç”¨ï¼Œå¦‚ä¸‹ï¼š

    // Generates /UrlGeneration/Destination
    var url = Url.Action("Destination");
    return ControllerContext.MyDisplayRouteInfo("", $" URL = {url}");

ä¸‰æ˜¯é€šè¿‡ asp-area åŒºåŸŸæœºåˆ¶ç»„ç»‡æ§åˆ¶å™¨ç›®å½•ç»“æ„ï¼Œä½¿ç”¨ä¸€ä¸ªç§°ä¸º api åŒºåŸŸæ¥è§£å†³


### ===âœ’ OpenAPI Documentation
- [Swagger/OpenAPI API è‡ªåŠ©æ–‡æ¡£](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/web-api-help-pages-using-swagger?view=aspnetcore-3.1)

ä½¿ç”¨ Web API æ—¶ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£å…¶å„ç§æ–¹æ³•å¯¹å¼€å‘äººå‘˜æ¥è¯´å¯èƒ½æ˜¯ä¸€é¡¹æŒ‘æˆ˜ã€‚ Swagger ç°åœ¨ä¹Ÿç§°ä¸º OpenAPIï¼Œè§£å†³äº†ä¸º Web API ç”Ÿæˆæœ‰ç”¨æ–‡æ¡£å’Œå¸®åŠ©é¡µçš„é—®é¢˜ã€‚ å®ƒå…·æœ‰è¯¸å¦‚äº¤äº’å¼æ–‡æ¡£ã€å®¢æˆ·ç«¯ SDK ç”Ÿæˆå’Œ API å¯å‘ç°æ€§ç­‰ä¼˜ç‚¹ã€‚

Swagger æ˜¯ä¸€ä¸ªä¸è¯­è¨€æ— å…³çš„è§„èŒƒï¼Œç”¨äºæè¿° REST APIã€‚ Swagger é¡¹ç›®å·²æèµ ç»™ OpenAPI è®¡åˆ’ï¼Œç°åœ¨å®ƒè¢«ç§°ä¸º OpenAPIã€‚ è¿™ä¸¤ä¸ªåç§°å¯äº’æ¢ä½¿ç”¨ï¼Œä½† OpenAPI æ›´å¸¸è§ã€‚ å®ƒå…è®¸è®¡ç®—æœºå’Œäººå‘˜äº†è§£æœåŠ¡çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€ç›´æ¥è®¿é—®å®ç°ï¼ˆæºä»£ç ã€ç½‘ç»œè®¿é—®ã€æ–‡æ¡£ï¼‰ã€‚ å…¶ä¸­ä¸€ä¸ªç›®æ ‡æ˜¯å°½é‡å‡å°‘è¿æ¥å–æ¶ˆå…³è”çš„æœåŠ¡æ‰€éœ€çš„å·¥ä½œé‡ï¼Œå¦ä¸€ä¸ªç›®æ ‡æ˜¯å‡å°‘å‡†ç¡®è®°å½•æœåŠ¡æ‰€éœ€çš„æ—¶é—´ã€‚

ä½¿ç”¨å¼€æºé¡¹ç›® Swashbuckle.AspNetCore æ­é… NSwag .NET Swagger å®ç°ï¼Œç”¨äºç”Ÿæˆ ASP.NET Core Web API çš„ Swagger æ–‡æ¡£ã€‚

NSwag æ˜¯å¦ä¸€ä¸ªç”¨äºç”Ÿæˆ Swagger æ–‡æ¡£å¹¶å°† Swagger UI æˆ– ReDoc é›†æˆåˆ° ASP.NET Core Web API ä¸­çš„å¼€æºé¡¹ç›®ã€‚ æ­¤å¤–ï¼ŒNSwag è¿˜æä¾›äº†ä¸º API ç”Ÿæˆ C# å’Œ TypeScript å®¢æˆ·ç«¯ä»£ç çš„æ–¹æ³•ã€‚

Swagger UI æä¾›äº†åŸºäº Web çš„ UIï¼Œå®ƒä½¿ç”¨ç”Ÿæˆçš„ Swagger è§„èŒƒæä¾›æœ‰å…³æœåŠ¡çš„ä¿¡æ¯ã€‚ Swashbuckle å’Œ NSwag å‡åŒ…å« Swagger UI çš„åµŒå…¥å¼ç‰ˆæœ¬ï¼Œå› æ­¤å¯ä½¿ç”¨ä¸­é—´ä»¶æ³¨å†Œè°ƒç”¨å°†è¯¥åµŒå…¥å¼ç‰ˆæœ¬æ‰˜ç®¡åœ¨ ASP.NET Core åº”ç”¨ä¸­ã€‚

æ§åˆ¶å™¨ä¸­çš„æ¯ä¸ªå…¬å…±æ“ä½œæ–¹æ³•éƒ½å¯ä»¥ä» UI ä¸­è¿›è¡Œæµ‹è¯•ã€‚ å•å‡»æ–¹æ³•åç§°å¯ä»¥å±•å¼€è¯¥éƒ¨åˆ†ã€‚ æ·»åŠ æ‰€æœ‰å¿…è¦çš„å‚æ•°ï¼Œç„¶åå•å‡»â€œè¯•è¯•çœ‹!â€ ã€‚

Swagger æµçš„æ ¸å¿ƒæ˜¯ Swagger è§„èŒƒï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯åä¸º swagger.json çš„æ–‡æ¡£ ã€‚ å®ƒç”± Swagger å·¥å…·é“¾ï¼ˆæˆ–å…¶ç¬¬ä¸‰æ–¹å®ç°ï¼‰æ ¹æ®ä½ çš„æœåŠ¡ç”Ÿæˆã€‚ å®ƒæè¿°äº† API çš„åŠŸèƒ½ä»¥åŠä½¿ç”¨ HTTP å¯¹å…¶è¿›è¡Œè®¿é—®çš„æ–¹å¼ã€‚ å®ƒé©±åŠ¨ Swagger UIï¼Œå¹¶ç”±å·¥å…·é“¾ç”¨æ¥å¯ç”¨å‘ç°å’Œå®¢æˆ·ç«¯ä»£ç ç”Ÿæˆã€‚ 



## ==âš¡ Database & Entity Framework Core
- [Entity Framework Core](https://docs.microsoft.com/zh-cn/ef/)
- [ASP.NET Core å’Œ Entity Framework 6 å…¥é—¨](https://docs.microsoft.com/zh-cn/aspnet/core/data/entity-framework-6?view=aspnetcore-3.1)
- [ASP.NET Core MVC with EF Core](https://docs.microsoft.com/zh-cn/aspnet/core/data/ef-mvc/?view=aspnetcore-3.1)
- [Razor Pages with EF Core](https://docs.microsoft.com/zh-cn/aspnet/core/data/ef-rp/intro?view=aspnetcore-3.1)
- []()

Entity Framework Core æ˜¯é€‚ç”¨äº .NET çš„æ–°å¼å¯¹è±¡æ•°æ®åº“æ˜ å°„å™¨ã€‚ å®ƒæ”¯æŒ LINQ æŸ¥è¯¢ã€æ›´æ”¹è·Ÿè¸ªã€æ›´æ–°å’Œæ¶æ„è¿ç§»ã€‚ EF Core é€‚ç”¨äºå¾ˆå¤šæ•°æ®åº“ï¼ŒåŒ…æ‹¬ SQL æ•°æ®åº“ï¼ˆæœ¬åœ°å’Œ Azureï¼‰ã€SQLiteã€MySQLã€PostgreSQL å’Œ Azure Cosmos DBã€‚

æ•°æ®åº“è¯»å–çš„æ•°æ®ä»¥æ•°æ®æ¨¡å‹å¯¹è±¡çš„æ–¹å¼å­˜åœ¨ï¼Œå³ MVC ä¸­ Model éƒ¨åˆ†ï¼ŒASP.NET Code ä½¿ç”¨è‡ªå¸¦çš„ Entity Framework Coreï¼Œ EF Core æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„ ORM - Object Relation Mapping æ¡†æ¶ã€‚åŒå…¶å®ƒ ORMï¼Œå¦‚ï¼ŒNHibernateï¼ŒHibernate ä¸€æ ·ï¼Œå¯ä»¥ç®€åŒ–éœ€è¦ç¼–å†™çš„æ•°æ®è®¿é—®ä»£ç ï¼Œå®ƒå¯ä»¥å°†å…³ç³»æ•°æ®è¡¨çš„è®°å½•æ˜ å°„ä¸ºå¯¹è±¡ã€‚

è‹¥è¦ä½¿ç”¨ Entity Framework 6ï¼Œåˆ™é¡¹ç›®å¿…é¡»é¢å‘ .NET Framework è¿›è¡Œç¼–è¯‘ï¼Œå› ä¸º EF6 ä¸æ”¯æŒ .NET Coreã€‚ å¦‚æœéœ€è¦è·¨å¹³å°åŠŸèƒ½ï¼Œéœ€å‡çº§åˆ° Entity Framework Coreã€‚

åœ¨ ASP.NET Core åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ EF6 çš„æ¨èæ–¹æ³•æ˜¯ï¼šå°† EF6 ä¸Šä¸‹æ–‡å’Œæ¨¡å‹ç±»æ”¾å…¥é¢å‘ .NET Framework çš„ç±»åº“é¡¹ç›®ä¸­ã€‚ æ·»åŠ å¯¹ ASP.NET Core é¡¹ç›®ä¸­çš„ç±»åº“çš„å¼•ç”¨ã€‚

EF6 å®ç°ä¸°å¯Œçš„ ORM åŠŸèƒ½ï¼ŒEF Core åˆ™å®Œå…¨è¿›è¡Œäº†é‡å†™ï¼ŒåŒ…å«è®¸å¤š EF6 æ²¡æœ‰çš„æ–°åŠŸèƒ½ï¼Œä½†è¿˜æ˜¯ç¼ºå°‘ EF6 ä¸­æœ€é«˜çº§çš„ä¸€äº›æ˜ å°„åŠŸèƒ½ã€‚

- ä¸ä¾èµ–äºä»»ä½• EF ç±»å‹çš„ POCO (Plain Old CLR Object) å®ä½“ç±»çš„æ˜ å°„
- è‡ªåŠ¨æ›´æ”¹è·Ÿè¸ª
- æ ‡è¯†è§£æå’Œå·¥ä½œå•å…ƒ
- é¢„å…ˆã€å»¶è¿Ÿå’Œæ˜¾å¼åŠ è½½
- ä½¿ç”¨ LINQï¼ˆè¯­è¨€é›†æˆæŸ¥è¯¢ï¼‰è½¬æ¢å¼ºç±»å‹æŸ¥è¯¢
- ä¸°å¯Œçš„æ˜ å°„åŠŸèƒ½ï¼Œå¯æ”¯æŒï¼š
    - ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šå’Œå¤šå¯¹å¤šå…³ç³»
    - ç»§æ‰¿ï¼ˆæ¯ä¸ªå±‚æ¬¡ç»“æ„ä¸€å¼ è¡¨ã€æ¯ä¸ªç±»å‹ä¸€å¼ è¡¨å’Œæ¯ä¸ªå…·ä½“ç±»ä¸€å¼ è¡¨ï¼‰
    - å¤æ‚ç±»å‹
    - å­˜å‚¨è¿‡ç¨‹
    - é€šè¿‡å¯è§†åŒ–è®¾è®¡å™¨åˆ›å»ºå®ä½“æ¨¡å‹ã€‚
- é€šè¿‡ç¼–å†™ä»£ç åˆ›å»ºå®ä½“æ¨¡å‹çš„â€œCode Firstâ€ä½“éªŒã€‚
- æ—¢å¯ä»ç°æœ‰æ•°æ®åº“ç”Ÿæˆæ¨¡å‹ï¼Œç„¶åæ‰‹åŠ¨ç¼–è¾‘ï¼Œä¹Ÿå¯ä»å¤´å¼€å§‹åˆ›å»ºæ¨¡å‹ï¼Œç„¶åç”¨äºç”Ÿæˆæ–°çš„æ•°æ®åº“ã€‚
- ä¸ .NET Framework åº”ç”¨ç¨‹åºæ¨¡å‹ï¼ˆåŒ…æ‹¬ ASP.NETï¼‰é›†æˆï¼Œå¹¶é€šè¿‡æ•°æ®ç»‘å®šä¸ WPF å’Œ WinForms é›†æˆã€‚
- åŸºäº ADO.NET çš„æ•°æ®åº“è¿æ¥å’Œå¯ç”¨äºè¿æ¥åˆ° SQL Serverã€Oracleã€MySQLã€SQLiteã€PostgreSQLã€DB2 ç­‰çš„ä¼—å¤šæä¾›ç¨‹åºã€‚

DbContext è¿™ä¸ªç±»æ˜¯ EF Code First çš„æ ¸å¿ƒï¼Œåœ¨é«˜å±‚æ¬¡ä¸Šæ˜¯æ•°æ®åº“æŠ½è±¡ã€‚æ•°æ®åº“åŒ…å«äº†è¡¨ï¼Œæ¯ä¸ªè¡¨åˆåŒ…å«äº†è¡Œå’Œåˆ—ã€‚DbContext æœ‰æ³›å‹é›†åˆå±æ€§ï¼Œæ¯ä¸ªå±æ€§çš„ç±»å‹æ˜¯ DbSet<TRowType>å¯¹åº”äºæ¯ä¸ªè¡¨ã€‚é›†åˆä¸­çš„æ¯ä¸ªå¯¹è±¡æŒ‡çš„æ˜¯ä¸€ä¸ªå®ä½“ï¼Œä»£è¡¨ç›¸åº”è¡¨ä¸­çš„ä¸€è¡Œã€‚

ä¸€æ—¦è¿™ä¸ªç»“æ„å¸ƒå±€å¥½äº†ï¼Œé‚£ä¹ˆä½ å°±èƒ½å¤Ÿé€šè¿‡LINQæŸ¥è¯¢æ¥æŸ¥è¯¢åº•å±‚çš„æ•°æ®åº“äº†ã€‚å¦‚æœä½ å°†ä¸€ä¸ªå…¨æ–°çš„ TRowType ç±»çš„å®ä¾‹æ·»åŠ åˆ°çˆ¶é›†åˆä¸­ï¼Œç„¶åä½¿ç”¨ DbContext API ä¿å­˜æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°çš„å¯¹è±¡å°±ä¼šå˜æˆç›¸åº”è¡¨ä¸­çš„ä¸€è¡Œï¼Œè¯¥å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼å°±ä¼šå˜æˆè¯¥è¡Œç›¸åº”çš„åˆ—å€¼ã€‚æ­¤å¤–ï¼ŒEF æœ‰èƒ½åŠ›è¡¨ç¤ºå…¶ä»–çš„æ•°æ®åº“å·¥ä»¶ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ã€‚æ•°æ®åº“ç»“æ„çš„è¿›åŒ–æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µï¼Œéšç€åº”ç”¨ç¨‹åºçš„å˜åŒ–ï¼Œä½ éœ€è¦æ·»åŠ åˆ—å’Œè¡¨ï¼ŒEF æ˜¯é€šè¿‡ Migration è¿ç§»åŠŸèƒ½æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚è¿™ä¸ªèƒ½åŠ›å…è®¸ä½ é€šè¿‡ C# ä»£ç æ›´æ”¹æ•°æ®åº“ç»“æ„ï¼Œé™¤äº†æ·»åŠ å’Œåˆ é™¤è¡¨å’Œåˆ—ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ ç´¢å¼•ã€‚Migration å¯ä»¥æ²¡æœ‰æ•°æ®æŸå¤±åœ°è¿›åŒ–æ•°æ®åº“æ¨¡å¼ã€‚ä½ å°†ä¼šçœ‹åˆ°ï¼ŒEF ä¼šæš´éœ²ä½ éœ€è¦ä½¿ç”¨ C# è®¿é—®çš„ä¸€åˆ‡æ•°æ®è€Œä¸éœ€è¦ç¼–å†™ SQLï¼Œå¹¶ä¸”åƒå¯¹å¾…ä½ æ•´ä¸ªåº”ç”¨ç¨‹åºä»£ç çš„ä¸€éƒ¨åˆ†æ¥å¯¹å¾…æ•°æ®åº“ã€‚

Entity Framework æ¶æ„æ„å»ºåœ¨ DAO.NET provider æ¶æ„ä¹‹ä¸Šã€‚å½“å¼€å‘è€…ä½¿ç”¨ C# åˆ›å»ºä¸€ä¸ª LINQ æŸ¥è¯¢æ—¶ï¼ŒEF æ¡†æ¶å¼•æ“ä¼šè¿æ¥ä¸€ä¸ª providerï¼Œå°†å®ƒè½¬æ¢æˆå®é™…çš„ SQL è¯­å¥ï¼Œæœ€åå‘å¾€æ•°æ®åº“æ‰§è¡Œã€‚ä»»ä½•ç»™å®šçš„ provider éƒ½æ˜¯è¿æ¥ Entity Framework å’Œä¸€ä¸ªç‰¹å®šçš„ RDBMS çš„æ¡¥æ¢ã€‚ä¸€æ—¦è¯¥ provider æ‰§è¡Œäº†æœ€ç»ˆçš„ SQL å‘½ä»¤ï¼Œç»“æœå°±è¢« EF å¯¹è±¡åŒ–åˆ° .NET å¯¹è±¡ä¸­ï¼ŒData reader å°±æ˜¯ä¸ºäº†è¿™ä¸ªç›®ã€‚ç†è§£ EF æ„å»ºäº ADO.NET ä¹‹ä¸Šéå¸¸é‡è¦ï¼Œå› æ­¤ï¼ŒEF ä¹Ÿä½¿ç”¨äº†è¯¸å¦‚ connectionï¼Œcommandï¼Œå’Œ data reader çš„æ¦‚å¿µã€‚

æ•°æ®æŒä¹…åŒ–ï¼Œä¹Ÿå°±æ˜¯æ’å…¥ï¼Œæ›´æ–°å’Œåˆ é™¤åŠŸèƒ½ï¼Œæ’å…¥æ—¶ï¼Œå¼€å‘è€…å°†ä¸€ä¸ªå®ä½“ç±»çš„å®ä¾‹æ·»åŠ åˆ°æ•°æ®åº“ä¸Šä¸‹æ–‡ä¸­ã€‚ç›¸ä¼¼åœ°ï¼Œä¹‹å‰æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­çš„å®ä¾‹è¢«æ ‡è®°ä¸º changed æˆ– deletedï¼Œå°±ä¼šäº§ç”Ÿå¯¹æ•°æ®åº“å³å°†æ‰§è¡Œæ›´æ–°å’Œåˆ é™¤çš„è¯­å¥ã€‚EF ä¼šæ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­çš„æ¯ä¸ªå¯¹è±¡ï¼Œå†æ¬¡ä½¿ç”¨ provider æ¥åˆ›å»º RDBMS ç‰¹å®šçš„ insert, update æˆ– delete å‘½ä»¤ã€‚

Entity Framework æ¦‚å¿µæ•°æ®æ¨¡å‹å’ŒæŒä¹…åŒ–ï¼Œé¦–å…ˆæ¥ç†è§£ EDM - Entity Data Model ä»¥åŠ EF å¦‚ä½•ä½¿ç”¨å®ƒç®¡ç†æ•°æ®åº“æ“ä½œï¼Œæ¦‚å¿µæ•°æ®æ¨¡å‹æ˜¯ EF çš„æ ¸å¿ƒã€‚è¦ä½¿ç”¨ EF å¿…é¡»åˆ›å»ºæ¦‚å¿µæ•°æ®æ¨¡å‹ã€‚EDM å®šä¹‰äº†æˆ‘ä»¬çš„æ¦‚å¿µæ¨¡å‹ç±»ï¼Œè¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠè¿™äº›æ¨¡å‹åˆ°æ•°æ®åº“æ¨¡å¼ä¹‹é—´çš„æ˜ å°„ã€‚

ä¸€æ—¦åˆ›å»ºäº† EDM å°±å¯ä»¥å¯¹æ¦‚å¿µæ¨¡å‹æ‰§è¡Œæ‰€æœ‰çš„ CRUD æ“ä½œï¼ŒEF ä¼šå°†æ‰€æœ‰çš„è¿™äº›å¯¹è±¡æŸ¥è¯¢ç¿»è¯‘æˆæ•°æ®åº“æŸ¥è¯¢ SQLã€‚ä¸€æ—¦è¿™äº›æŸ¥è¯¢æ‰§è¡Œäº†ï¼ŒEF å°±ä¼šå°†è¿”å›çš„ç»“æœè½¬æˆæ¦‚å¿µæ¨¡å‹å¯¹è±¡å®ä¾‹ã€‚EF ä¼šä½¿ç”¨å­˜å‚¨åœ¨ EDM ä¸­çš„æ˜ å°„ä¿¡æ¯æ¥æ‰§è¡Œå¯¹è±¡æŸ¥è¯¢åˆ° SQL æŸ¥è¯¢ï¼Œä»¥åŠç›¸å…³çš„æ•°æ®åˆ°æ¦‚å¿µæ¨¡å‹çš„ç¿»è¯‘ã€‚

ä¸€æ—¦æˆ‘åˆ›å»ºäº† EDMï¼Œæˆ‘å°±æœ‰äº†åº”ç”¨ç¨‹åºä¸­å¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰çš„å®ä½“ã€‚ç„¶è€Œï¼Œæˆ‘è¿˜éœ€è¦ä¸€ä¸ªä¸œè¥¿æ¥è®©æˆ‘åœ¨è¿™äº›å®ä½“ä¸Šæ‰§è¡Œå„ç§æ“ä½œã€‚å®ƒå°±æ˜¯ EF ä¸­çš„ ObjectContext ç±»ã€‚è¦æ‰§è¡Œ CRUD æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ ObjectContext ç±»ã€‚ 

ObjectContext ç±»æ˜¯ EF ä¸­çš„ä¸»è¦å¯¹è±¡ï¼Œå®ƒè´Ÿè´£ï¼š

- ç®¡ç†æ•°æ®åº“è¿æ¥
- æä¾›æ‰§è¡ŒCRUDæ“ä½œçš„æ”¯æŒ
- è¿½è¸ªæ¨¡å‹çš„æ›´æ”¹ï¼Œç›®çš„åœ¨äºåœ¨æ•°æ®åº“ä¸­æ›´æ–°æ¨¡å‹

å¯ä»¥ç†è§£æˆç®¡ç† EDM ä¸­æ‰€æœ‰å®ä½“çš„ä¸œè¥¿ï¼Œè®©æˆ‘ä»¬ä¸ºè¿™äº›å®ä½“æ‰§è¡Œæ‰€æœ‰çš„æ•°æ®åº“æ“ä½œã€‚å½“æˆ‘ä»¬æƒ³è¦ä¿å­˜ä¸€ä¸ªæ–°çš„æˆ–è€…æ›´æ”¹çš„å¯¹è±¡åˆ°æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨ ObjectContext ç±»ä¸­çš„ SaveChanges æ–¹æ³•ã€‚

Entity Framework åŸºæœ¬æœ‰äºŒç§å¼€å‘æ¨¡å¼ï¼š

- Database First

    æ•°æ®åº“é€†å‘å·¥ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç”¨äºå·²å­˜åœ¨æ•°æ®åº“æ¨¡å¼çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“ç»“æ„çš„é€†å‘å·¥ç¨‹ï¼Œé€šè¿‡æ•°æ®åº“ç»“æ„ç”Ÿæˆä»£ç ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒEDM - Entity Data Model å³å®ä½“æ•°æ®æ¨¡å‹å¯¹è±¡æ˜¯ä»æ•°æ®åº“æ¨¡å¼ä¸­ç”Ÿæˆçš„ï¼Œè¿™ç§æ–¹æ³•æœ€é€‚åˆäºä½¿ç”¨äº†å·²ç»å­˜åœ¨çš„æ•°æ®åº“çš„åº”ç”¨ã€‚

- Code First æˆ– Model First

    ç¼–å†™æ¨¡å‹ä»£ç å»ºç«‹ EDM æˆ–ä½¿ç”¨ Visual Studio æä¾›çš„ EDM å¯è§†åŒ–è®¾è®¡å™¨æ¥è®¾è®¡æ¨¡å‹ï¼Œä¾æ®è¿™äº›ç±»å®šä¹‰åˆ›å»ºæ•°æ®åº“ã€‚è¿™ç§æ–¹æ³•æœ€é€‚åˆäºé‚£äº›é«˜åº¦ä»¥é¢†åŸŸä¸ºä¸­å¿ƒå¹¶ä¸”é¢†åŸŸæ¨¡å‹ç±»åˆ›å»ºä¼˜å…ˆçš„åº”ç”¨ç¨‹åºã€‚è¿™é‡Œéœ€è¦çš„æ•°æ®åº“åªæ˜¯ä¸ºäº†è¿™äº›é¢†åŸŸæ¨¡å‹çš„æŒä¹…åŒ–æœºåˆ¶ã€‚


### ===âœ’ ASP.Net Codegenerator åŸºæ¶å·¥å…·

ä½¿ç”¨ dotnet aspnet-codegenerator è¿è¡Œ ASP.NET Core åŸºæ¶å¼•æ“ï¼Œæœ‰äº†è¿™ä¸ªå·¥å…·ï¼Œå®ƒåªéœ€è¦ä»å‘½ä»¤è¡Œæ­å»ºåŸºæ¶ï¼Œä¸å¿…ä½¿ç”¨ Visual Studio æ­å»ºåŸºæ¶ã€‚è¦ç”Ÿæˆæ•°æ®åº“ä¸Šä¸‹æ–‡ç±»å‹å®ç°éœ€è¦ä½¿ç”¨ EF CLI å·¥å…·ï¼Œå®‰è£…ç›¸åº”çš„ Design ç±»æ¥ç”Ÿæˆä»£ç ã€‚è¦ä½¿ç”¨æ•°æ®åº“ï¼Œè¿˜éœ€è¦å®‰è£…ç›¸åº”çš„æ•°æ®æ¥å£ï¼ŒInMemory æ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ²¡æœ‰æ•°æ®åº“æœåŠ¡å™¨æ—¶å¯ä»¥å®ƒç”¨æ¥åšæµ‹è¯•ç”¨ã€‚æ ¹æ®éœ€è¦å®‰è£…è¿™äº›æ•°æ®åº“å·¥å…·å’Œç±»åº“ï¼š

    dotnet tool install --global dotnet-ef

    dotnet add package Microsoft.EntityFrameworkCore.SQLite
    dotnet add package Microsoft.EntityFrameworkCore.SqlServer
    dotnet add package Microsoft.EntityFrameworkCore.InMemory

    dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
    dotnet add package Microsoft.EntityFrameworkCore.Design

    dotnet add package MySql.Data
    dotnet add package MySql.Data.EntityFrameworkCore
    dotnet add package MySql.Data.EntityFrameworkCore.Design

    dotnet tool install -g dotnet-aspnet-codegenerator
    dotnet tool update -g dotnet-aspnet-codegenerator

å‘½ä»¤ä½¿ç”¨ï¼š 

    dotnet ef migrations add InitialCreate
    dotnet ef database update

    dotnet aspnet-codegenerator [arguments] [-p|--project] [-n|--nuget-package-dir] [-c|--configuration] [-tfm|--target-framework] [-b|--build-base-path] [--no-build] 

    dotnet aspnet-codegenerator [-h|--help]

ä»¥ä¸‹æ˜¯å¯ç”¨çš„ç”Ÿæˆå™¨ï¼š

- area  æ­å»ºåŒºåŸŸçš„åŸºæ¶ï¼Œå³ç”ŸæˆæŒ‰åŒºåŸŸç»„ç»‡çš„ MVC ç›®å½•ç»“æ„ï¼Œå¯ä»¥å±æ€§æ ‡è®° [Area("xyz")] å°†æ§åˆ¶å™¨ä¸åŒºåŸŸå…³è”
- controller    æ­å»ºæ§åˆ¶å™¨çš„åŸºæ¶
- identity  æ­å»ºæ ‡è¯†çš„åŸºæ¶
- razorpage æ­å»º Razor Pages çš„åŸºæ¶
- view  æ­å»ºè§†å›¾çš„åŸºæ¶

ä½¿ç”¨ç”Ÿæˆå™¨æ¥åˆ›å»ºæ§åˆ¶å™¨æˆ– Razor Pageï¼Œæ³¨æ„ -m Model æŒ‡å®šçš„ç±»å¿…éœ€å·²ç»å­˜åœ¨ï¼Œè€Œ -dc DbContext ä¼šæ ¹æ®æŒ‡å®šçš„åç§°ç”Ÿæˆï¼š

    dotnet aspnet-codegenerator controller -name=Hello --model=MO --dataContext=DBC --layout=_Layout -async -api -sqlite -namespace=myWebApp
    dotnet aspnet-codegenerator razorpage MyEdit Edit -m Movie -dc RazorPagesMovieContext -outDir Pages/Movies


æ•°æ®æ¨¡å‹åŠç”Ÿæˆçš„çš„ DbContext ç±»å‚è€ƒï¼Œä»£ç é‡æ–°ç»„ç»‡æ”¾ä¸€èµ·ï¼Œä½¿ç”¨ Attribute å¯ä»¥ä¿®æ”¹æ˜ å°„å…³ç³»ï¼Œæ¯”å¦‚ [Table("users", Schema = "minispro")] æ˜ å°„æŒ‡å®šæ•°æ®åº“å’Œè¡¨ã€‚è€ƒè™‘åˆ°æ•°æ®è¡¨ä¸­ï¼Œå­˜åœ¨ null å­—æ®µï¼Œåœ¨ C# ä¸­éœ€è¦è®¾ç½® nullable å±æ€§ä»¥å…è¯»å–å‡ºé”™ï¼š

    using System;
    using Microsoft.EntityFrameworkCore;
    using System.ComponentModel.DataAnnotations;
    using System.ComponentModel.DataAnnotations.Schema;

    namespace myWebApp
    {
        // [Keyless]
        // [NotMapped]
        // [Table("users")]
        [Table("users", Schema = "minispro")]
        public class UserDTO
        {
            [Key]
            public int Id { get; set; }

            // [Column("user_id")]
            // [Column(TypeName = "varchar(200)")]
            // [Column(TypeName = "decimal(5, 2)")]
            // [DataType(DataType.Date)]
            // [Display(Name = "Release Date")]
            [NotMapped]
            public Guid id { get; set; }
            public string name { get; set; } = "";
            public string nickname { get; set; }
            public string email { get; set; }
            #nullable enable
            public string? nickname { get; set; }
            public int? level { get; set; }
            #nullable disable
            public DateTime created_at { get; set; }
        }

        public class UserDC : DbContext
        {
            public UserDC (DbContextOptions<UserDC> options)
                : base(options)
            {
            }

            public DbSet<UserDTO> UserDTO { get; set; }
        }

    }

DbContext ç±»è´Ÿè´£å®ç°æ•°æ®åº“è¯»å†™é€»è¾‘ï¼Œé¦–å…ˆï¼Œéœ€è¦åœ¨å…¶æ„é€ å‡½æ•°æˆ–äº‹ä»¶å‡½æ•°ä¸­å¤„ç†è¿æ¥ï¼š

    using System.Configuration;

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        string cons = ConfigurationManager.ConnectionStrings["BloggingDatabase"].ConnectionString;
        optionsBuilder.UseSqlServer(cons);
        // optionsBuilder.UseSqlite(cons);
        // optionsBuilder.UseMySQL(cons);
    }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<UserDTO>();
        modelBuilder.Query<YourModel>();
        modelBuilder.Query<YourModel>().FromSql()
    }


å¯ä»¥åœ¨ Startup ä¸­å°† DbContext é€šè¿‡ä¾èµ–æ³¨å…¥ä¸ºæœåŠ¡ï¼š

    services.AddDbContext<UserDC>();

è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨å®ä¾‹åŒ–æ§åˆ¶å™¨æ—¶ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å¡«åˆ°æ„é€ å‡½æ•°å‚æ•°ä¸­ï¼š

    public class Hello : Controller
    {
        private readonly UserDC _context;

        public Hello(UserDC context)
        {
            _context = context;
        }
    }


Universal Windows Platform (UWP) ç¨‹åºé€šå¸¸ä½¿ç”¨ Sqlite æ•°æ®åº“ï¼Œä¸€èˆ¬ç¡¬ç¼–ç è¿æ¥å­—ç¬¦ä¸²ï¼š

    var optionsBuilder = new DbContextOptionsBuilder<UserDC>();
    optionsBuilder.UseSqlite("Data Source=blog.db");
    // optionsBuilder.UseLoggerFactory(MyLoggerFactory) ;
    using (var context = new UserDC(optionsBuilder.Options))
    {
      // do stuff
    }


é…ç½®è¿æ¥å­—ç¬¦ä¸²åˆ° Web.config æˆ– App.configï¼Œæ ¹æ® ASP.NET æˆ– WinForms & WPF ç¨‹åºéœ€è¦ï¼š

    <?xml version="1.0" encoding="utf-8"?>
    <configuration>

      <connectionStrings>
        <add name="BloggingDatabase"
             connectionString="Server=(localdb)\mssqllocaldb;Database=Blogging;Trusted_Connection=True;" />
      </connectionStrings>
    </configuration>

ASP.NET Core ç¨‹åºå¯ä»¥é…ç½®è¿æ¥å­—ç¬¦ä¸²åˆ° appsettings.jsonï¼š

    {
      "ConnectionStrings": {
        "BloggingDatabase": "Server=(localdb)\\mssqllocaldb;Database=EFGetStarted.ConsoleApp.NewDb;Trusted_Connection=True;",
        "Sqlite": "Data Source=blog.db",
        "MySQL": "server=localhost;user=root;database=test;port=3306;password=****;SslMode=None"
      },
    }

é€šå¸¸åœ¨ Statup ä¸­ç”± Microsoft.Extensions.Configuration è¯»å–ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œè¯»å–é…ç½®æ–‡ä»¶ï¼š

    IConfiguration configuration = new ConfigurationBuilder()
        .SetBasePath(Environment.CurrentDirectory)
        .AddJsonFile("appsettings.json")
        // .AddXmlFile("config.xml");
        // .AddIniFile("appSettings.ini")
        .Build();

    string cons = Configuration.GetConnectionString("BloggingDatabase");



ç”Ÿæˆçš„æ§åˆ¶å™¨ Hello.csï¼š

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.EntityFrameworkCore;

    namespace myWebApp
    {
        [Route("api/[controller]")]
        [ApiController]
        public class Hello : ControllerBase
        {
            private readonly UserDC _context;

            public Hello(UserDC context)
            {
                _context = context;
            }

            // GET: api/Hello
            [HttpGet]
            public async Task<ActionResult<IEnumerable<UserDTO>>> GetUserDTO()
            {
                return await _context.UserDTO.ToListAsync();
            }

            // GET: api/Hello/5
            [HttpGet("{id}")]
            public async Task<ActionResult<UserDTO>> GetUserDTO(int id)
            {
                var userDTO = await _context.UserDTO.FindAsync(id);

                if (userDTO == null)
                {
                    return NotFound();
                }

                return userDTO;
            }

            // PUT: api/Hello/5
            // To protect from overposting attacks, enable the specific properties you want to bind to, for
            // more details, see https://go.microsoft.com/fwlink/?linkid=2123754.
            [HttpPut("{id}")]
            public async Task<IActionResult> PutUserDTO(int id, UserDTO userDTO)
            {
                if (id != userDTO.Id)
                {
                    return BadRequest();
                }

                _context.Entry(userDTO).State = EntityState.Modified;

                try
                {
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!UserDTOExists(id))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }

                return NoContent();
            }

            // POST: api/Hello
            // To protect from overposting attacks, enable the specific properties you want to bind to, for
            // more details, see https://go.microsoft.com/fwlink/?linkid=2123754.
            [HttpPost]
            public async Task<ActionResult<UserDTO>> PostUserDTO(UserDTO userDTO)
            {
                _context.UserDTO.Add(userDTO);
                await _context.SaveChangesAsync();

                return CreatedAtAction("GetUserDTO", new { id = userDTO.Id }, userDTO);
            }

            // DELETE: api/Hello/5
            [HttpDelete("{id}")]
            public async Task<ActionResult<UserDTO>> DeleteUserDTO(int id)
            {
                var userDTO = await _context.UserDTO.FindAsync(id);
                if (userDTO == null)
                {
                    return NotFound();
                }

                _context.UserDTO.Remove(userDTO);
                await _context.SaveChangesAsync();

                return userDTO;
            }

            private bool UserDTOExists(int id)
            {
                return _context.UserDTO.Any(e => e.Id == id);
            }
        }
    }


### ===âœ’ dotnet aspnet-codegenerator

    >dotnet aspnet-codegenerator


    Usage: aspnet-codegenerator [arguments] [options]

    Arguments:
      generator  Name of the generator. Check available generators below.

    Options:
      -p|--project             Path to .csproj file in the project.
      -n|--nuget-package-dir
      -c|--configuration       Configuration for the project (Possible values: Debug/ Release)
      -tfm|--target-framework  Target Framework to use. (Short folder name of the tfm. eg. net46)
      -b|--build-base-path
      --no-build

    Available generators:
      area      : Generates an MVC Area.
      controller: Generates a controller.
      identity  : Generates an MVC Area with controllers and
      razorpage : Generates RazorPage(s).
      view      : Generates a view.


ä¸‹è¡¨åˆ—å‡ºäº†å¯¹äº aspnet-codegenerator controller çš„é€‰é¡¹ï¼š

    >dotnet aspnet-codegenerator controller -h

    Generator Options:
      --controllerName|-name              : Name of the controller
      --useAsyncActions|-async            : Switch to indicate whether to generate async controller actions
      --noViews|-nv                       : Switch to indicate whether to generate CRUD views
      --restWithNoViews|-api              : Specify this switch to generate a Controller with REST style API, noViews is assumed and any view related options are ignored
      --readWriteActions|-actions         : Specify this switch to generate Controller with read/write actions when a Model class is not used
      --model|-m                          : Model class to use
      --dataContext|-dc                   : DbContext class to use
      --referenceScriptLibraries|-scripts : Switch to specify whether to reference script libraries in the generated views
      --layout|-l                         : Custom Layout page to use
      --useDefaultLayout|-udl             : Switch to specify that default layout should be used for the views
      --force|-f                          : Use this option to overwrite existing files
      --relativeFolderPath|-outDir        : Specify the relative output folder path from project where the file needs to be generated, if not specified, file will be generated in the project folder
      --controllerNamespace|-namespace    : Specify the name of the namespace to use for the generated controller
      --useSqlite|-sqlite                 : Flag to specify if DbContext should use SQLite instead of SQL Server.

Razor Page ç”Ÿæˆé€‰é¡¹ï¼š

    >dotnet aspnet-codegenerator razorpage -h

    Selected Code Generator: razorpage

    Generator Arguments:
      razorPageName : Name of the Razor Page
      templateName  : The template to use, supported view templates: 'Empty|Create|Edit|Delete|Details|List'

    Generator Options:
      --model|-m                          : Model class to use
      --dataContext|-dc                   : DbContext class to use
      --referenceScriptLibraries|-scripts : Switch to specify whether to reference script libraries in the generated views
      --layout|-l                         : Custom Layout page to use
      --useDefaultLayout|-udl             : Switch to specify that default layout should be used for the views
      --force|-f                          : Use this option to overwrite existing files
      --relativeFolderPath|-outDir        : Specify the relative output folder path from project where the file needs to be generated, if not specified, file will be generated in the project folder
      --namespaceName|-namespace          : Specify the name of the namespace to use for the generated PageModel
      --partialView|-partial              : Generate a partial view, other layout options (-l and -udl) are ignored if this is specified
      --noPageModel|-npm                  : Switch to not generate a PageModel class for Empty template
      --useSqlite|-sqlite                 : Flag to specify if DbContext should use SQLite instead of SQL Server.




### ===âœ’ Code First with EF Core
- [EF workflows](https://docs.microsoft.com/en-us/ef/ef6/modeling/)
- [Creating and configuring a model](https://docs.microsoft.com/en-us/ef/core/modeling/)
- [Getting Started with EF Core](https://docs.microsoft.com/en-us/ef/core/get-started/?tabs=netcore-cli)
- [Razor Pages with Entity Framework Core in ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/data/ef-rp/intro?view=aspnetcore-3.1)


åœ¨æ•°æ®åº“å…³ç³»æ¨¡å‹ ORM çš„è®¾è®¡ä¸­ï¼ŒCode First æ¨¡å¼ä¸­å¯ä»¥ç”±æ¨¡å‹ç”Ÿæˆæ•°æ®åº“ å³ Model Firstï¼Œä¹Ÿå¯ä»¥ç”±ç°æœ‰çš„æ•°æ®åº“ç”Ÿæˆä¸Šä¸‹æ–‡å’Œæ¨¡å‹ï¼Œå³ Database Firstã€‚è¦æ‰§è¡Œ Database First ä»»åŠ¡ï¼Œä»ç°æœ‰çš„æ•°æ®åº“é€†å‘ç”Ÿæˆä¸Šä¸‹æ–‡åŠæ¨¡å‹ï¼Œéœ€è¦é€šè¿‡ dotnet ef dbcontext scaffold åŸºæ¶å·¥å…·å®ç°ã€‚

Model First æ¨¡å¼å…ˆå®šä¹‰æ¨¡å‹ï¼Œå†ç”±æ¨¡å‹ç”Ÿæˆæ•°æ®åº“ç»“æ„ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- å®šä¹‰æ¨¡å‹å¯¹è±¡ï¼›
- è®¾ç½®ç›®æ ‡æ•°æ®åº“è¿æ¥ï¼Œéœ€è¦ä¸€ä¸ªå…¨æ–°çš„ç©ºæ•°æ®ï¼›
- EF CLI å‘½ä»¤æ—¶é€šè¿‡ EnsureCreated() æ–¹æ³•åˆ›å»ºæ•°æ®åº“ç»“æ„ï¼› 



åˆ›å»ºå­¦ç”Ÿå®ä½“, Models/Student.csï¼š

    using System;
    using System.Collections.Generic;

    namespace ContosoUniversity.Models
    {
        public class Student
        {
            public int ID { get; set; }
            public string LastName { get; set; }
            public string FirstMidName { get; set; }
            public DateTime EnrollmentDate { get; set; }

            public ICollection<Enrollment> Enrollments { get; set; }
        }
    }

ID å±æ€§æˆä¸ºæ­¤ç±»å¯¹åº”çš„æ•°æ®åº“è¡¨çš„ä¸»é”®åˆ—ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒEF Core å°†åä¸º ID æˆ– classnameID çš„å±æ€§è§†ä¸ºä¸»é”®ã€‚ å› æ­¤ï¼ŒStudent ç±»ä¸»é”®çš„å¦ä¸€ç§è‡ªåŠ¨è¯†åˆ«çš„åç§°æ˜¯ StudentIDã€‚

åœ¨æœ¬ä¾‹ä¸­ï¼ŒStudent å®ä½“çš„ Enrollments å±æ€§åŒ…å«ä¸è¯¥ Student ç›¸å…³çš„æ‰€æœ‰ Enrollment å®ä½“ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„ Student è¡Œæœ‰ä¸¤ä¸ªç›¸å…³çš„ Enrollment è¡Œï¼Œåˆ™ Enrollments å…³è”è¿™ä¸¤ä¸ª Enrollment å®ä½“ã€‚

åˆ›å»ºå…¥å­¦ç™»è®°å®ä½“, Models/Enrollment.csï¼š

    namespace ContosoUniversity.Models
    {
        public enum Grade
        {
            A, B, C, D, F
        }

        public class Enrollment
        {
            public int EnrollmentID { get; set; }
            public int CourseID { get; set; }
            public int StudentID { get; set; }
            public Grade? Grade { get; set; }

            public Course Course { get; set; }
            public Student Student { get; set; }
        }
    }

EnrollmentID å±æ€§ä¸ºä¸»é”®ï¼›æ­¤å®ä½“ä½¿ç”¨ classnameID æ¨¡å¼è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ IDã€‚ å¯¹äºç”Ÿäº§æ•°æ®æ¨¡å‹ï¼Œè¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å¼å¹¶ä¸€ç›´ä½¿ç”¨ï¼Œä»¥æ–¹ä¾¿æ—¥åç»Ÿä¸€ç®¡ç†ã€‚

Grade å±æ€§ä¸º enumã€‚ Grade å£°æ˜ç±»å‹åçš„?è¡¨ç¤º Grade å±æ€§å¯ä»¥ä¸º nullã€‚ è¯„çº§ä¸º null å’Œè¯„çº§ä¸ºé›¶æ˜¯æœ‰åŒºåˆ«çš„ â€” null æ„å‘³ç€è¯„çº§æœªçŸ¥æˆ–è€…å°šæœªåˆ†é…ã€‚å¦‚æœæ•°æ®åº“çš„å­—æ®µå¯ä»¥ä¸ºç©ºï¼Œå®ä½“å°±ä¸€å®šè¦è¿™æ ·è®¾ç½®ï¼Œå¦åˆ™æŸ¥è¯¢æ•°æ®è®°å½•å°±ä¼šå‡ºé”™ã€‚

å¦‚æœå±æ€§å‘½åä¸º `<navigation property name><primary key property name>`ï¼ŒEF Core ä¼šå°†å…¶è§†ä¸ºå¤–é”®ã€‚ ä¾‹å¦‚ï¼ŒStudentID æ˜¯ Student å¯¼èˆªå±æ€§çš„å¤–é”®ï¼Œå› ä¸º Student å®ä½“çš„ä¸»é”®ä¸º IDã€‚ è¿˜å¯ä»¥å°†å¤–é”®å±æ€§å‘½åä¸º `<primary key property name>`ã€‚ ä¾‹å¦‚ CourseIDï¼Œå› ä¸º Course å®ä½“çš„ä¸»é”®ä¸º CourseIDã€‚


åˆ›å»º Course å®ä½“ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»º Models/Course.csï¼š

    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations.Schema;

    namespace ContosoUniversity.Models
    {
        public class Course
        {
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public int CourseID { get; set; }
            public string Title { get; set; }
            public int Credits { get; set; }

            public ICollection<Enrollment> Enrollments { get; set; }
        }
    }

åº”ç”¨å¯ä»¥é€šè¿‡ DatabaseGenerated ç‰¹æ€§æŒ‡å®šä¸»é”®ï¼Œè€Œæ— éœ€é æ•°æ®åº“ç”Ÿæˆã€‚


**ç”Ÿæˆä»£ç åŠä¿®æ”¹é…ç½®**


æœ¬éƒ¨åˆ†ä½¿ç”¨ ASP.NET Core åŸºæ¶å·¥å…·ç”Ÿæˆ EF Core ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰æ–‡ä»¶ã€‚ ä¸Šä¸‹æ–‡æ˜¯ä¸ºç»™å®šæ•°æ®æ¨¡å‹åè°ƒå®ä½“æ¡†æ¶åŠŸèƒ½çš„ä¸»ç±»ã€‚ å®ƒæ´¾ç”Ÿè‡ª Microsoft.EntityFrameworkCore.DbContext ç±»ã€‚ç”Ÿæˆ Razor Page é¡µé¢ä»¥å¤„ç† Student å®ä½“çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤ (CRUD) æ“ä½œã€‚

å®‰è£…åŸºæ¶å·¥å…·ï¼Œé€‰ç”¨ SQLite åµŒå…¥å¼æ•°æ®åšæµ‹è¯•ï¼Œåˆ›å»º Pages/Students æ–‡ä»¶å¤¹ä»¥ä¿å­˜ç”Ÿæˆçš„ Razor Pageï¼š

    dotnet add package Microsoft.EntityFrameworkCore.SQLite
    dotnet add package Microsoft.EntityFrameworkCore.Design
    dotnet add package Microsoft.EntityFrameworkCore.Tools
    dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
    dotnet add package Microsoft.Extensions.Logging.Debug

    dotnet tool install --global dotnet-aspnet-codegenerator

    dotnet aspnet-codegenerator razorpage -m Student -dc ContosoUniversity.Data.SchoolContext -udl -outDir Pages\Students --referenceScriptLibraries --useSqlite

æ‰§è¡Œç”Ÿæˆ razorpage æ¨¡æ¿åä¼šåœ¨ Pages/Students æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä»¥ä¸‹ç³»åˆ— Razor é¡µé¢ï¼š

- Create.cshtml & Create.cshtml.cs
- Delete.cshtml & Delete.cshtml.cs
- Details.cshtml & Details.cshtml.cs
- Edit.cshtml & Edit.cshtml.cs
- Index.cshtml & Index.cshtml.cs
- Data/SchoolContext.cs ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰


æŒ‰ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹é…ç½®ï¼š

- åœ¨ Startup.cs ä¸­é€šè¿‡æ³¨å†Œä¸Šä¸‹æ–‡ä»¥å¯ç”¨ä¾èµ–é¡¹æ³¨å…¥

    é€šè¿‡è°ƒç”¨ DbContextOptions å¯¹è±¡ä¸­çš„ä¸€ä¸ªæ–¹æ³•å°†è¿æ¥å­—ç¬¦ä¸²åç§°ä¼ é€’åˆ°ä¸Šä¸‹æ–‡ã€‚ è¿›è¡Œæœ¬åœ°å¼€å‘æ—¶ï¼Œ ASP.NET Core é…ç½®ç³»ç»Ÿ åœ¨ appsettings.json æ–‡ä»¶ä¸­è¯»å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚

        services.AddDbContext<SchoolContext>(options =>
            options.UseSqlServer(Configuration.GetConnectionString("SchoolContext")));

    å¦‚æœéœ€è¦ä½¿ç”¨å…¶å®ƒé…ç½®è¯»å…¥æ–¹å¼ï¼Œä¹Ÿå¯ä½¿ç”¨ä»¥ä¸‹è¿™ç§æ–¹å¼ï¼š

        services.AddDbContext<SchoolContext>();

    ç„¶ååœ¨ SchoolContext ç±»çš„é…ç½®æ–¹æ³•ä¸­å¢åŠ é…ç½®è¯»å…¥å®šä¹‰ï¼Œä½†æ˜¯è¿™æ ·æ¯æ¬¡éƒ½ä¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¼šæœ‰è¾ƒå¤§çš„æ¶ˆè€—ï¼š

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            if (!optionsBuilder.IsConfigured)
            {
                IConfiguration Configuration = new ConfigurationBuilder()
                    .SetBasePath(Environment.CurrentDirectory)
                    .AddJsonFile("appSettings.json")
                    .Build();

                cons = Configuration.GetConnectionString("SchoolContext");
                optionsBuilder.UseSqlite(cons);
            }
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            OnModelCreatingPartial(modelBuilder);
        }

- å°†æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ·»åŠ åˆ° appsettings.json

        {
            "Logging": {
                "LogLevel": {
                    "Default": "Information",
                    "Microsoft": "Warning",
                    "Microsoft.Hosting.Lifetime": "Information"
                }
            },
            "AllowedHosts": "*",
            "ConnectionStrings": {
                "SchoolContext": "Data Source=CU.db"
            }
        }

    ä½¿ç”¨ SqlServer æˆ–è€… MySQL è¿æ¥å­—ç¬¦ä¸²ï¼š

        "SqlServer": "Server=(localdb)\\mssqllocaldb;Database=SchoolContext6;Trusted_Connection=True;MultipleActiveResultSets=true"
        "MySQL": "server=localhost;user=root;database=test;port=3306;password=****;SslMode=None"

    LocalDB æ˜¯è½»å‹ç‰ˆæœ¬ SQL Server Express æ•°æ®åº“å¼•æ“ï¼Œä¸“é—¨é’ˆå¯¹åº”ç”¨å¼€å‘ï¼Œè€Œéç”Ÿäº§ä½¿ç”¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒLocalDB ä¼šåœ¨ `C:/Users/<user>` ç›®å½•ä¸­åˆ›å»º .mdf æ–‡ä»¶ ã€‚


æ›´æ–°æ•°æ®åº“ä¸Šä¸‹æ–‡ç±»å®šä¹‰ï¼Œæ•°æ®åº“ä¸Šä¸‹æ–‡ç±»æ˜¯ä¸ºç»™å®šæ•°æ®æ¨¡å‹åè°ƒ EF Core åŠŸèƒ½çš„ä¸»ç±»ã€‚ ä¸Šä¸‹æ–‡æ´¾ç”Ÿè‡ª Microsoft.EntityFrameworkCore.DbContextã€‚ ä¸Šä¸‹æ–‡æŒ‡å®šæ•°æ®æ¨¡å‹ä¸­åŒ…å«å“ªäº›å®ä½“ã€‚ 

åœ¨æ­¤é¡¹ç›®ä¸­å°†æ•°æ®åº“ä¸Šä¸‹æ–‡ç±»å‘½åä¸º SchoolContextã€‚ ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›´æ–° SchoolContext.cs ï¼š

    using Microsoft.EntityFrameworkCore;
    using ContosoUniversity.Models;

    namespace ContosoUniversity.Data
    {
        public class SchoolContext : DbContext
        {
            public SchoolContext (DbContextOptions<SchoolContext> options)
                : base(options)
            {
            }

            public DbSet<Student> Students { get; set; }
            public DbSet<Enrollment> Enrollments { get; set; }
            public DbSet<Course> Courses { get; set; }

            protected override void OnModelCreating(ModelBuilder modelBuilder)
            {
                modelBuilder.Entity<Course>().ToTable("Course");
                modelBuilder.Entity<Enrollment>().ToTable("Enrollment");
                modelBuilder.Entity<Student>().ToTable("Student");
            }
        }
    }


DbContext æ‰§è¡Œæµç¨‹æœ‰ä¸‰ä¸ªé‡è¦æ—¶æœºï¼š

- æ„é€ å‡½æ•°æ‰§è¡Œæ—¶æœºï¼›
- æ¯æ¬¡å®ä¾‹åŒ–éƒ½æ‰§è¡Œçš„é…ç½®äº‹ä»¶ï¼ŒOnConfiguring(DbContextOptionsBuilder)
- åªåœ¨å¯èƒ½éœ€è¦æ„é€ æ•°æ®åº“ç»“æ„æ—¶æ‰§è¡Œçš„ OnModelCreating(ModelBuilder)

ä¸€å®šè¦æŒ‡å®šç©ºæ•°æ®ï¼Œå³ä½¿ç”¨æ•°æ®åº“æ— ä»»ä½•æ•°æ®è¡¨ä¹Ÿä¸è¡Œã€‚å¦‚æœæœ‰ä¸Šä¸‹æ–‡å…³è”çš„æ•°æ®åº“ï¼Œåˆ™ EnsureCreated æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ 

ä»£ç ä¸­ `DbSet` æ³›å‹ä¸ºæ¯ä¸ªå®ä½“é›†åˆ›å»º DbSet<TEntity> å±æ€§ã€‚ åœ¨ EF Core æœ¯è¯­ä¸­ï¼š

- å®ä½“ç±»å®šä¹‰å¯¹åº”è¡¨å®šä¹‰ã€‚
- å®ä½“é›†é€šå¸¸å¯¹åº”æ•°æ®åº“è¡¨ã€‚
- å®ä½“å¯¹åº”è¡¨ä¸­çš„è¡Œã€‚

ç”±äºå®ä½“é›†åŒ…å«å¤šä¸ªå®ä½“ï¼Œå› æ­¤ DBSet å±æ€§åº”ä¸ºå¤æ•°åç§°ã€‚ ç”±äºåŸºæ¶å·¥å…·åˆ›å»ºäº† Student DBSetï¼Œä¸ºå•æ•°å½¢å¼ï¼Œå»ºè®®åœ¨æ­¤æ­¥éª¤å°†ç”Ÿæˆä»£ç ä¸­çš„å•æ•°å½¢å¼æ›´æ”¹ä¸ºå¤æ•° Studentsã€‚

ä¸ºäº†ä½¿ Razor Pages ä»£ç ä¸æ–°çš„ DBSet åç§°ç›¸åŒ¹é…ï¼Œè¯·åœ¨æ•´ä¸ªé¡¹ç›®ä¸­è¿›è¡Œå…¨å±€æ›´æ”¹ï¼Œå°† `_context.Student` æ›´æ”¹ä¸º `_context.Students`ã€‚å…± 5 ä¸ªæ–‡ä»¶ 8 å¤„ä¿®æ”¹ã€‚



å¦‚æœæ²¡æœ‰æ•°æ®åº“ï¼Œè¯·æ›´æ–° Program.cs ä»¥åˆ›å»ºæ•°æ®åº“ï¼Œæ³¨æ„å¼•ç”¨ DependencyInjection ä¾èµ–æ³¨å…¥æ¨¡å—ï¼š

    using ContosoUniversity.Data;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.AspNetCore.Hosting;
    using Microsoft.Extensions.Hosting;
    using Microsoft.Extensions.Logging;
    using System;

    namespace ContosoUniversity
    {
        public class Program
        {
            public static void Main(string[] args)
            {
                var host = CreateHostBuilder(args).Build();
                CreateDbIfNotExists(host);
                host.Run();
            }

            private static void CreateDbIfNotExists(IHost host)
            {
                using (var scope = host.Services.CreateScope())
                {
                    var services = scope.ServiceProvider;

                    try
                    {
                        var context = services.GetRequiredService<SchoolContext>();
                        context.Database.EnsureCreated();
                    }
                    catch (Exception ex)
                    {
                        var logger = services.GetRequiredService<ILogger<Program>>();
                        logger.LogError(ex, "An error occurred creating the DB.");
                    }
                }
            }

            public static IHostBuilder CreateHostBuilder(string[] args) =>
                Host.CreateDefaultBuilder(args)
                    .ConfigureWebHostDefaults(webBuilder =>
                    {
                        webBuilder.UseStartup<Startup>();
                    });
        }
    }

å¦‚æœæœ‰ä¸Šä¸‹æ–‡å…³è”çš„æ•°æ®åº“ï¼Œåˆ™ EnsureCreated æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ å¦‚æœæ²¡æœ‰æ•°æ®åº“ï¼Œåˆ™å®ƒå°†åˆ›å»ºæ•°æ®åº“å’Œæ¶æ„ã€‚ EnsureCreated å¯ç”¨ä»¥ä¸‹å·¥ä½œæµæ¥å¤„ç†æ•°æ®æ¨¡å‹æ›´æ”¹ï¼š

- åˆ é™¤æ•°æ®åº“ã€‚ ä»»ä½•ç°æœ‰æ•°æ®ä¸¢å¤±ã€‚
- æ›´æ”¹æ•°æ®æ¨¡å‹ã€‚ ä¾‹å¦‚ï¼Œæ·»åŠ  EmailAddress å­—æ®µã€‚
- è¿è¡Œåº”ç”¨ã€‚
- æ’ EF æä¾›çš„ EnsureCreated åˆ›å»ºå…·æœ‰æ–°æ¶æ„çš„æ•°æ®åº“ã€‚

åœ¨æ— éœ€ä¿å­˜æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå½“æ¶æ„å¿«é€Ÿå‘å±•æ—¶ï¼Œæ­¤å·¥ä½œæµåœ¨æ—©æœŸå¼€å‘è¿‡ç¨‹ä¸­è¡¨ç°è‰¯å¥½ã€‚ å¦‚æœéœ€è¦ä¿å­˜å·²è¾“å…¥æ•°æ®åº“çš„æ•°æ®ï¼Œæƒ…å†µå°±æœ‰æ‰€ä¸åŒäº†ã€‚ å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œè¯·ä½¿ç”¨è¿ç§» Imigreationã€‚

æœ¬ç³»åˆ—æ•™ç¨‹çš„åç»­éƒ¨åˆ†å°†åˆ é™¤ EnsureCreated åˆ›å»ºçš„æ•°æ®åº“ï¼Œè½¬è€Œä½¿ç”¨è¿ç§»ã€‚ æ— æ³•ä½¿ç”¨è¿ç§»æ›´æ–° EnsureCreated åˆ›å»ºçš„æ•°æ®åº“ã€‚


**è®¾å®šæ•°æ®åº“ç§å­**

EnsureCreated æ–¹æ³•å°†åˆ›å»ºç©ºæ•°æ®åº“ã€‚ æœ¬èŠ‚æ·»åŠ ç”¨æµ‹è¯•æ•°æ®å¡«å……æ•°æ®åº“çš„ä»£ç ã€‚
ä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»º Data/DbInitializer.cs ï¼š

    using ContosoUniversity.Data;
    using ContosoUniversity.Models;
    using System;
    using System.Linq;

    namespace ContosoUniversity.Data
    {
        public static class DbInitializer
        {
            public static void Initialize(SchoolContext context)
            {
                context.Database.EnsureCreated();

                // Look for any students.
                if (context.Students.Any())
                {
                    return;   // DB has been seeded
                }

                var students = new Student[]
                {
                    new Student{FirstMidName="Carson",LastName="Alexander",EnrollmentDate=DateTime.Parse("2019-09-01")},
                    new Student{FirstMidName="Meredith",LastName="Alonso",EnrollmentDate=DateTime.Parse("2017-09-01")},
                    new Student{FirstMidName="Arturo",LastName="Anand",EnrollmentDate=DateTime.Parse("2018-09-01")},
                    new Student{FirstMidName="Gytis",LastName="Barzdukas",EnrollmentDate=DateTime.Parse("2017-09-01")},
                    new Student{FirstMidName="Yan",LastName="Li",EnrollmentDate=DateTime.Parse("2017-09-01")},
                    new Student{FirstMidName="Peggy",LastName="Justice",EnrollmentDate=DateTime.Parse("2016-09-01")},
                    new Student{FirstMidName="Laura",LastName="Norman",EnrollmentDate=DateTime.Parse("2018-09-01")},
                    new Student{FirstMidName="Nino",LastName="Olivetto",EnrollmentDate=DateTime.Parse("2019-09-01")}
                };

                context.Students.AddRange(students);
                context.SaveChanges();

                var courses = new Course[]
                {
                    new Course{CourseID=1050,Title="Chemistry",Credits=3},
                    new Course{CourseID=4022,Title="Microeconomics",Credits=3},
                    new Course{CourseID=4041,Title="Macroeconomics",Credits=3},
                    new Course{CourseID=1045,Title="Calculus",Credits=4},
                    new Course{CourseID=3141,Title="Trigonometry",Credits=4},
                    new Course{CourseID=2021,Title="Composition",Credits=3},
                    new Course{CourseID=2042,Title="Literature",Credits=4}
                };

                context.Courses.AddRange(courses);
                context.SaveChanges();

                var enrollments = new Enrollment[]
                {
                    new Enrollment{StudentID=1,CourseID=1050,Grade=Grade.A},
                    new Enrollment{StudentID=1,CourseID=4022,Grade=Grade.C},
                    new Enrollment{StudentID=1,CourseID=4041,Grade=Grade.B},
                    new Enrollment{StudentID=2,CourseID=1045,Grade=Grade.B},
                    new Enrollment{StudentID=2,CourseID=3141,Grade=Grade.F},
                    new Enrollment{StudentID=2,CourseID=2021,Grade=Grade.F},
                    new Enrollment{StudentID=3,CourseID=1050},
                    new Enrollment{StudentID=4,CourseID=1050},
                    new Enrollment{StudentID=4,CourseID=4022,Grade=Grade.F},
                    new Enrollment{StudentID=5,CourseID=4041,Grade=Grade.C},
                    new Enrollment{StudentID=6,CourseID=1045},
                    new Enrollment{StudentID=7,CourseID=3141,Grade=Grade.A},
                };

                context.Enrollments.AddRange(enrollments);
                context.SaveChanges();
            }
        }
    }

è¯¥ä»£ç ä¼šæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ä»»ä½•å­¦ç”Ÿã€‚ å¦‚æœä¸å­˜åœ¨å­¦ç”Ÿï¼Œå®ƒå°†å‘æ•°æ®åº“æ·»åŠ æµ‹è¯•æ•°æ®ã€‚ è¯¥ä»£ç ä½¿ç”¨æ•°ç»„åˆ›å»ºæµ‹è¯•æ•°æ®è€Œä¸æ˜¯ä½¿ç”¨ List<T> é›†åˆæ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ã€‚

åœ¨ Program.cs ä¸­ï¼Œå°† EnsureCreated è°ƒç”¨æ›¿æ¢ä¸º DbInitializer.Initialize è°ƒç”¨ ï¼š

    // context.Database.EnsureCreated();
    DbInitializer.Initialize(context);

å¦‚æœåº”ç”¨æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢åº”ç”¨ï¼Œç„¶ååˆ é™¤ CU.db æ–‡ä»¶ã€‚æˆ–ä½¿ç”¨ PowerShell å‘½ä»¤ Drop-Database åˆ é™¤ SqlServer æ•°æ®åº“ã€‚


**ä½¿ç”¨ CRUD æ“ä½œ**

    using (var db = new SchoolContext())
    {
        // Create
        Console.WriteLine("Inserting a new student");
        db.Add(new Student {
            FirstMidName="Carson",
            LastName="Alexander",
            EnrollmentDate=DateTime.Parse("2019-09-01")
            });
        db.SaveChanges();

        // Read
        Console.WriteLine("Querying for a student");
        var student = db.Students
            .OrderBy(b => b.ID)
            .First();

        // Update
        Console.WriteLine("Updating the student and adding a post");
        student.LastName = "Bob";
        student.Enrollments.Add(new Enrollment{StudentID=1,CourseID=1050,Grade=Grade.A})
        db.SaveChanges();

        // Delete
        Console.WriteLine("Delete the student");
        db.Remove(student);
        db.SaveChanges();
    }


æ’åº Linq è¯­æ³•ï¼š

    IQueryable<Student> studentsIQ = from s in db.Students select s;

    switch (sortOrder)
    {
        case "name_desc":
            studentsIQ = studentsIQ.OrderByDescending(s => s.LastName);
            break;
        case "Date":
            studentsIQ = studentsIQ.OrderBy(s => s.EnrollmentDate);
            break;
        case "date_desc":
            studentsIQ = studentsIQ.OrderByDescending(s => s.EnrollmentDate);
            break;
        default:
            studentsIQ = studentsIQ.OrderBy(s => s.LastName);
            break;
    }

    Students = await studentsIQ.AsNoTracking().ToListAsync();

IQueryable vs.IEnumerable

è¯¥ä»£ç å¯¹ IQueryable å¯¹è±¡è°ƒç”¨ OrderBy/Where æ–¹æ³•ï¼Œç­›é€‰åœ¨æœåŠ¡å™¨ä¸Šå¤„ç†ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯èƒ½ä¼šå¯¹å†…å­˜ä¸­çš„é›†åˆè°ƒç”¨ Where æ–¹æ³•ä½œä¸ºæ‰©å±•æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ SchoolContext.Students ä» EF Core DbSet æ›´æ”¹ä¸ºå¯è¿”å› IEnumerable é›†åˆçš„å­˜å‚¨åº“æ–¹æ³•ã€‚ ç»“æœé€šå¸¸æ˜¯ç›¸åŒçš„ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸åŒã€‚

å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œé€šå¸¸é¦–é€‰å¯¹ IQueryable è°ƒç”¨ Containsã€‚ æ•°æ®åº“æœåŠ¡å™¨åˆ©ç”¨ IQueryable å®Œæˆç­›é€‰ã€‚ å¦‚æœå…ˆåˆ›å»º IEnumerableï¼Œåˆ™å¿…é¡»ä»æ•°æ®åº“æœåŠ¡å™¨è¿”å›æ‰€æœ‰è¡Œã€‚



**ä½¿ç”¨å¼‚æ­¥ä»£ç **

å¼‚æ­¥ç¼–ç¨‹æ˜¯ ASP.NET Core å’Œ EF Core çš„é»˜è®¤æ¨¡å¼ã€‚

Web æœåŠ¡å™¨çš„å¯ç”¨çº¿ç¨‹æ˜¯æœ‰é™çš„ï¼Œè€Œåœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹çš„å¯èƒ½æ‰€æœ‰çº¿ç¨‹éƒ½è¢«å ç”¨ã€‚ å½“å‘ç”Ÿè¿™ç§æƒ…å†µçš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°±æ— æ³•å¤„ç†æ–°è¯·æ±‚ï¼Œç›´åˆ°çº¿ç¨‹è¢«é‡Šæ”¾ã€‚ ä½¿ç”¨åŒæ­¥ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹è¢«å ç”¨ä½†ä¸èƒ½æ‰§è¡Œä»»ä½•æ“ä½œçš„æƒ…å†µï¼Œå› ä¸ºå®ƒä»¬æ­£åœ¨ç­‰å¾… I/O å®Œæˆã€‚ ä½¿ç”¨å¼‚æ­¥ä»£ç æ—¶ï¼Œå½“è¿›ç¨‹æ­£åœ¨ç­‰å¾… I/O å®Œæˆï¼ŒæœåŠ¡å™¨å¯ä»¥å°†å…¶çº¿ç¨‹é‡Šæ”¾ç”¨äºå¤„ç†å…¶ä»–è¯·æ±‚ã€‚ å› æ­¤ï¼Œä½¿ç”¨å¼‚æ­¥ä»£ç å¯ä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œå¹¶ä¸”æœåŠ¡å™¨å¯ä»¥æ— å»¶è¿Ÿåœ°å¤„ç†æ›´å¤šæµé‡ã€‚

å¼‚æ­¥ä»£ç ä¼šåœ¨è¿è¡Œæ—¶å¼•å…¥å°‘é‡å¼€é”€ã€‚ æµé‡è¾ƒä½æ—¶ï¼Œå¯¹æ€§èƒ½çš„å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†æµé‡è¾ƒé«˜æ—¶ï¼Œæ½œåœ¨çš„æ€§èƒ½æ”¹å–„éå¸¸æ˜¾è‘—ã€‚
åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œasync å…³é”®å­—å’Œ Task<T> è¿”å›å€¼ï¼Œawait å…³é”®å­—å’Œ ToListAsync æ–¹æ³•è®©ä»£ç å¼‚æ­¥æ‰§è¡Œã€‚

    public async Task OnGetAsync()
    {
        Students = await _context.Students.ToListAsync();
    }

async å…³é”®å­—è®©ç¼–è¯‘å™¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- ä¸ºæ–¹æ³•ä¸»ä½“çš„å„éƒ¨åˆ†ç”Ÿæˆå›è°ƒã€‚
- åˆ›å»ºè¿”å›çš„ Task å¯¹è±¡ã€‚
- è¿”å›ç±»å‹ Task<T> è¡¨ç¤ºæ­£åœ¨è¿›è¡Œçš„å·¥ä½œã€‚
- await å…³é”®å­—è®©ç¼–è¯‘å™¨å°†è¯¥æ–¹æ³•æ‹†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ å…ˆä»¥å¼‚æ­¥æ–¹å¼ç»“æŸå·²å¯åŠ¨çš„æ“ä½œï¼Œå½“æ“ä½œå®Œæˆæ—¶æ³¨å…¥è°ƒç”¨ Callback æ–¹æ³•çš„åœ°æ–¹ã€‚
- ToListAsync æ˜¯ ToList æ‰©å±•æ–¹æ³•çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚

ç¼–å†™ä½¿ç”¨ EF Core çš„å¼‚æ­¥ä»£ç æ—¶éœ€è¦æ³¨æ„çš„ä¸€äº›äº‹é¡¹ï¼š

åªæœ‰å¯¼è‡´æŸ¥è¯¢æˆ–å‘é€æ•°æ®åº“å‘½ä»¤çš„è¯­å¥æ‰èƒ½ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œã€‚ è¿™åŒ…æ‹¬ ToListAsyncã€SingleOrDefaultAsyncã€FirstOrDefaultAsync å’Œ SaveChangesAsyncã€‚ ä¸åŒ…æ‹¬åªä¼šæ›´æ”¹ IQueryable çš„è¯­å¥ï¼Œä¾‹å¦‚ï¼š

    var students = context.Students.Where(s => s.LastName == "Davolio")

EF Core ä¸Šä¸‹æ–‡å¹¶éçº¿ç¨‹å®‰å…¨ï¼Œè¯·å‹¿å°è¯•å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ“ä½œã€‚
è‹¥è¦åˆ©ç”¨å¼‚æ­¥ä»£ç çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œè¯·éªŒè¯åœ¨è°ƒç”¨å‘æ•°æ®åº“å‘é€æŸ¥è¯¢çš„ EF Core æ–¹æ³•æ—¶ï¼Œåº“ç¨‹åºåŒ…ï¼ˆå¦‚ç”¨äºåˆ†é¡µï¼‰æ˜¯å¦ä½¿ç”¨å¼‚æ­¥ã€‚


### ===âœ’ Migration & EF CLI å‘½ä»¤è¡Œå·¥å…·
- [EF workflows](https://docs.microsoft.com/en-us/ef/ef6/modeling/)
- [Creating and configuring a model](https://docs.microsoft.com/en-us/ef/core/modeling/)
- [Getting Started with EF Core](https://docs.microsoft.com/en-us/ef/core/get-started/?tabs=netcore-cli)
- [Razor Pages with Entity Framework Core in ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/data/ef-rp/intro?view=aspnetcore-3.1)


ç”¨äº Entity Framework Core çš„å‘½ä»¤è¡Œæ¥å£ï¼ˆCLIï¼‰å·¥å…·æ‰§è¡Œè®¾è®¡å™¨å¼€å‘ä»»åŠ¡ã€‚ ä¾‹å¦‚ï¼Œä»–ä»¬åŸºäºç°æœ‰æ•°æ®åº“åˆ›å»ºè¿ç§»ã€åº”ç”¨è¿ç§»å’Œç”Ÿæˆæ¨¡å‹çš„ä»£ç ã€‚ EF CLI æ˜¯è·¨å¹³å° dotnet å‘½ä»¤çš„æ‰©å±•ï¼Œå®ƒæ˜¯.NET Core SDKçš„ä¸€éƒ¨åˆ†ã€‚ è¿™äº›å·¥å…·é€‚ç”¨äº .NET Core é¡¹ç›®ã€‚

ä½¿ç”¨ EF Migration è¿ç§»è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æ—¶ï¼ŒMigration å°†ï¼š

- æ ¹æ®å·²æœ‰çš„æ•°æ®æ¨¡å‹å®šä¹‰ç”Ÿæˆæ•°æ®åº“ç»“æ„ï¼Œéœ€è¦æŒ‡å®šç©ºæ•°æ®åº“ï¼Œå³æ¸…ç©ºæ•°æ®è¡¨ä¹Ÿä¸è¡Œï¼›
- å‘æ•°æ®åº“æ·»åŠ  `__EFMigrationsHistory` è¡¨æ ¼è®°å½•å„ä¸ªè¿ç§»å¯¹è±¡çš„ ID å’Œäº§å“ç‰ˆæœ¬å·ï¼Œç”¨ä»¥è·Ÿè¸ªæ•°æ®åº“çš„æ¶æ„æ˜¯å¦ä¸ä»ç”Ÿæˆå®ƒçš„æ¨¡å‹ç±»åŒæ­¥ã€‚
- å¦‚æœè¯¥æ¨¡å‹ç±»æœªä¸æ•°æ®åº“åŒæ­¥ï¼ŒEF å°†å¼•å‘å¼‚å¸¸ï¼Œæ‹’ç»æ‰§è¡Œæ“ä½œã€‚

ä¾‹å¦‚ï¼Œåº”ç”¨æ·»åŠ äº†æœ‰ä¸¤ä¸ªè¿ç§»ï¼š

| `MigrationId` | `ProductVersion` |
| :-----------  | :--------------- |
| 20200531105034_InitialCreate  | 3.1.4 |
| 20200531105213_upgrade_1.0    | 3.1.4 |

å¯¹åº”çš„è¿ç§»è®¾è®¡å™¨å®š 20200531105034_InitialCreate æˆ– 20200531105213_upgrade_10 çš„è®¾è®¡å™¨å®šä¹‰ Designer.cs å‚è€ƒå¦‚ä¸‹ï¼Œå®ƒåŒ…å«è¿ç§»åçš„æ•°æ®åº“ç»“æ„å¿«ç…§ï¼š

    [DbContext(typeof(SchoolContext))]
    [Migration("20200531105034_InitialCreate")]
    partial class InitialCreate
    {
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
            modelBuilder
                .HasAnnotation("ProductVersion", "3.1.4")
                .HasAnnotation("Relational:MaxIdentifierLength", 64);

å„è‡ªå®šä¹‰å‘ä¸Šè¿ç§» Up ã€å‘ä¸‹è¿ç§»æ–¹æ³• Down ï¼Œæ‰§è¡Œè¿ç§»æ—¶ `dotnet ef database update` å‘½ä»¤ä¾æ¬¡æ‰§è¡Œï¼š

    DbContext OnModelCreating(ModelBuilder)
    InitialCreate UP ...
    InitialCreate BuildTargetModel ...
    upgrade_10 UP ...
    upgrade_10 BuildTargetModel ...



å®‰è£… EF CLI å·¥å…·ï¼š

    dotnet tool install --global dotnet-ef

å¯é€‰é¢„å®‰è£…æ•°æ®ä¾›åº”æ¥å£æ¨¡å—ï¼š

    dotnet add package Microsoft.EntityFrameworkCore.SQLite
    dotnet add package Microsoft.EntityFrameworkCore.SqlServer
    dotnet add package Microsoft.EntityFrameworkCore.InMemory

    dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
    dotnet add package Microsoft.EntityFrameworkCore.Design

    dotnet add package MySql.Data
    dotnet add package MySql.Data.EntityFrameworkCore
    dotnet add package MySql.Data.EntityFrameworkCore.Design

    dotnet add package Pomelo.EntityFrameworkCore.MySql

æä¾›ä¸‰ç§åŠŸèƒ½ï¼Œæ•°æ®åº“ã€ä¸Šä¸‹æ–‡ã€è¿ç§»ç®¡ç†ï¼š

| å‘½ä»¤        | å­å‘½ä»¤ |
| :-------    | :------- |
| database    | drop update åˆ é™¤æˆ–æ›´æ–°æ•°æ®åº“ |
| dbcontext   | Commands to manage DbContext types. |
| migrations  | Commands to manage migrations. |

- dbcontext å­å‘½ä»¤

  - info      Gets information about a DbContext type.
  - list      Lists available DbContext types.
  - scaffold  Scaffolds a DbContext and entity types for a database.
  - script    Generates a SQL script from migrations.

- migrations å­å‘½ä»¤

  - add     Adds a new migration.
  - list    Lists available migrations.
  - remove  Removes the last migration.
  - script  Generates a SQL script from migrations.

æŸ¥è¯¢ä¸Šä¸‹æ–‡å¯¹è±¡ä¿¡æ¯ï¼š

    >dotnet ef dbcontext list --no-build
    AppWeb.Data.UserDC
    ContosoUniversity.Data.SchoolContext

    >dotnet ef dbcontext info -c SchoolContext --no-build
    Provider name: Microsoft.EntityFrameworkCore.Sqlite
    Database name: main
    Data source: CU.db
    Options: None

åŸºæ¶å‘½ä»¤ scaffold ä¸º DbContext æ•°æ®åº“çš„å’Œå®ä½“ç±»å‹ç”Ÿæˆä»£ç ï¼Œå³ Database First æ¨¡å¼ä¸‹çš„æ•°æ®åº“é€†å‘å·¥ç¨‹ã€‚ä½¿ç”¨ Sacffold-DbContext EF Core åŒ…ç®¡ç†å™¨æ§åˆ¶å°ï¼ˆPMCï¼‰å·¥å…·çš„å‘½ä»¤æˆ– dotnet ef dbcontext scaffold .net å‘½ä»¤è¡Œæ¥å£ï¼ˆCLIï¼‰å·¥å…·çš„å‘½ä»¤æ¥æ‰§è¡Œè¯¥å‘½ä»¤ã€‚

ä½¿æ­¤å‘½ä»¤ç”Ÿæˆå®ä½“ç±»å‹ï¼Œæ•°æ®åº“è¡¨å¿…é¡»å…·æœ‰ä¸»é”®ï¼Œ-t æˆ– --table æŒ‡å®šè¦æ„é€ çš„æ•°æ®è¡¨ï¼Œæ•°æ®åº“ä¾›åº”æ¥å£æŒ‡å®š Sqliteã€MySql ç­‰ã€‚

    dotnet ef dbcontext scaffold "Data Source=CU.db" Microsoft.EntityFrameworkCore.Sqlite -o Data\School --no-build
    
    dotnet ef dbcontext scaffold "Data Source=CU.db" Microsoft.EntityFrameworkCore.Sqlite -o Data\School -t Student -t Course --context-dir Data -c SchoolContext

    dotnet ef dbcontext scaffold -c ReverDBContext -o Data\reverse "server=localhost;user=root;database=school;port=3306;password=12345;SslMode=None" MySql.Data.EntityFrameworkCore --no-build

å¦‚æœæ•°æ®æŒ‰ä¸Šé¢å°èŠ‚ç”Ÿæˆçš„ç»“æ„ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ Data\School ç›®å½•ä¸‹ç”Ÿæˆ CUContext ä¸Šä¸‹æ–‡è¿˜ç”¨å¯¹åº”å„æ•°æ®è¡¨çš„æ¨¡å‹ï¼Œå‘½åç©ºé—´å’Œç›®å½•å±‚çº§å¯¹åº”ã€‚

ä¸ç”¨æ‹…å¿ƒç”Ÿæˆæ—¶ä¼šè¦†ç›–åŸæ–‡ä»¶ï¼Œé™¤éä½¿ç”¨ --force é€‰é¡¹ï¼


å½“æ•°æ®æœ‰æ•°æ®éœ€è¦ä¿ç•™æ—¶ï¼Œåˆè¦å¯¹æ•°æ®åº“ç»“æ„è¿›è¡Œä¿®æ­£ï¼Œå°±éœ€è¦ä½¿ç”¨è¿ç§»ï¼Œæ¯æ¬¡è¿ç§»ä½¿ç”¨çš„ SQL è„šæœ¬éƒ½ä¼šæœ‰å†å²è®°å½•ï¼Œä¿å­˜åœ¨ Migrations ç›®å½•ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå‘æ•°æ®åº“æ·»åŠ  `__EFMigrationsHistory` è¡¨æ ¼ç”¨ä»¥è·Ÿè¸ªæ•°æ®åº“çš„æ¶æ„ï¼Œå½“è¡¨æ ¼è®°å½•ä¸è¿ç§»å¯¹è±¡ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶ï¼Œå°±å½“å¼‚å¸¸å¤„ç†ï¼Œè€Œä¸æ‰§è¡Œè¿ç§»ã€‚

ä¿®æ”¹æ¨¡å‹å¯¹è±¡åï¼Œæ‰§è¡Œ migrations add ç”Ÿæˆè¿ç§» SQL è„šæœ¬ï¼Œå†ä½¿ç”¨æ•°æ®åº“æ›´æ–°å‘½ä»¤æ‰§è¡Œè¿ç§».åˆæ¬¡ç”Ÿæˆè¿ç§»å¯¹è±¡å«æœ‰åˆ›å»ºæ•°æ®è¡¨çš„åŠŸèƒ½ï¼Œå¦‚æœåˆ›å»ºåˆå§‹è¿ç§»æ—¶å·²å­˜åœ¨æ•°æ®åº“ï¼Œä½†æ­¤ä»£ç ä¸å¿…è¿è¡Œï¼Œå› ä¸ºæ•°æ®åº“å·²ä¸æ•°æ®åº“æ¨¡å‹ç›¸åŒ¹é…ã€‚

å°†åº”ç”¨éƒ¨ç½²åˆ°å…¶ä¸­å°šä¸å­˜åœ¨æ•°æ®åº“çš„å…¶ä»–ç¯å¢ƒæ—¶ï¼Œæ­¤ä»£ç å°†è¿è¡Œä»¥åˆ›å»ºæ•°æ®åº“ï¼Œå› æ­¤æœ€å¥½æå‰è¿›è¡Œæµ‹è¯•ã€‚ è¿™ä¹Ÿæ˜¯æå‰æ›´æ”¹è¿æ¥å­—ç¬¦ä¸²ä¸­æ•°æ®åº“çš„åç§°çš„åŸå› ï¼Œè¿™æ ·è¿ç§»æ‰èƒ½ä»å¤´åˆ›å»ºæ–°æ•°æ®åº“ã€‚

è¿ç§»åœ¨ Migrations/SchoolContextModelSnapshot.cs ä¸­åˆ›å»ºå½“å‰æ•°æ®åº“æ¶æ„çš„å¿«ç…§ ã€‚ æ·»åŠ è¿ç§»æ—¶ï¼ŒEF ä¼šé€šè¿‡å°†æ•°æ®æ¨¡å‹ä¸å¿«ç…§æ–‡ä»¶è¿›è¡Œå¯¹æ¯”æ¥ç¡®å®šå·²æ›´æ”¹çš„å†…å®¹ã€‚

åœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œå¯ä»¥ä½¿ç”¨ dotnet ef migrations remove å‘½ä»¤åˆ é™¤è¿ç§»ï¼Œå†ä¿®æ”¹æ¨¡å‹ï¼Œå¯ä»¥ç¡®ä¿æ­£ç¡®é‡ç½®å¿«ç…§ã€‚ å¦‚æœåˆ é™¤è¿ç§»å¤±è´¥ï¼Œä½¿ç”¨ dotnet ef migrations remove -v è·å–å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯ã€‚


    >dotnet ef migrations list -c SchoolContext --no-build
    No migrations were found.

    >dotnet ef migrations add -c SchoolContext InitialCreate --no-build
    Done. To undo this action, use 'ef migrations remove'

    >dotnet ef migrations list -c SchoolContext --no-build
    20200531010213_InitialCreate

    >dotnet ef migrations remove -c SchoolContext  --no-build
    Removing migration '20200531010213_InitialCreate'.
    Removing model snapshot.
    Done.

    >dotnet ef database update --no-build -c SchoolContext
    Done.

éœ€è¦æ³¨æ„ï¼Œå¦‚æœä»¥ --no-build æ–¹å¼æ‰§è¡Œï¼Œå¯èƒ½ä¼šå¯¼è‡´å·¥å…·æ— æ³•æ­£ç¡®è¯†åˆ«æ•°æ®åº“å’Œæ¨¡å‹å¯¹è±¡é—´çš„å·®å¼‚ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¤šæ¬¡æ·»åŠ åŒåçš„è¿ç§»å¯¹è±¡ï¼Œå¯¼è‡´å‘½åç©ºé—´å†²çªã€‚

æ¯æ¬¡æ·»åŠ çš„è¿ç§»å¯¹è±¡è‡³å°‘åŒ…å« Up å’Œ Down ä¸¤ä¸ªæ–¹æ³•ï¼Œå‘ä¸Šè¿ç§»å³æ›´æ–°æ•°æ®åº“ç»“æ„ï¼Œå‘ä¸‹è¿ç§»å³è¿˜åŸæœ¬æ¬¡å‘ä¸Šè¿ç§»å‰çš„æ•°æ®åº“ç»“æ„ï¼Œå³ migrations remove è¦æ‰§è¡Œçš„æ–¹æ³•ï¼š

    using Microsoft.EntityFrameworkCore.Migrations;

    namespace AppWeb.Migrations
    {
        public partial class major : Migration
        {
            protected override void Up(MigrationBuilder migrationBuilder)
            {
                migrationBuilder.DropColumn(
                    name: "IsMajor",
                    table: "Course");

                migrationBuilder.AddColumn<int>(
                    name: "IsMinor",
                    table: "Course",
                    nullable: false,
                    defaultValue: 0);
            }

            protected override void Down(MigrationBuilder migrationBuilder)
            {
                migrationBuilder.DropColumn(
                    name: "IsMinor",
                    table: "Course");

                migrationBuilder.AddColumn<int>(
                    name: "IsMajor",
                    table: "Course",
                    type: "INTEGER",
                    nullable: false,
                    defaultValue: 0);
            }
        }
    }

Dbcontext.Database.EnsureCreated() å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼Œä»¥åŠç›¸å…³çš„è¡¨ã€‚å¦‚æœæœ‰ä¸Šä¸‹æ–‡å…³è”çš„æ•°æ®åº“ï¼Œåˆ™ EnsureCreated æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ å¦‚æœæ²¡æœ‰æ•°æ®åº“ï¼Œåˆ™å®ƒå°†åˆ›å»ºæ•°æ®åº“å’Œæ¶æ„ã€‚ 

ä½¿ç”¨ Sqlite å¯ä»¥åœ¨åˆ é™¤æ•°æ®åº“æ–‡ä»¶åæ­£å¸¸æ‰§è¡Œï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ MySql æ•°æ®åº“æ—¶ï¼Œ**å³ä½¿è¡¨å·²ç»å…¨éƒ¨åˆ é™¤ï¼Œä½†æ˜¯æ•°æ®åº“è¿˜åœ¨ï¼Œè¿™æ—¶ä¹Ÿæ˜¯ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œçš„ã€‚**

EnsureCreated å¯ç”¨ä»¥ä¸‹å·¥ä½œæµæ¥å¤„ç†æ•°æ®æ¨¡å‹æ›´æ”¹ï¼š

- åˆ é™¤æ•°æ®åº“ã€‚ ä»»ä½•ç°æœ‰æ•°æ®ä¸¢å¤±ã€‚
- æ›´æ”¹æ•°æ®æ¨¡å‹ã€‚ ä¾‹å¦‚ï¼Œæ·»åŠ  EmailAddress å­—æ®µã€‚
- è¿è¡Œåº”ç”¨ã€‚
- æ’ EF æä¾›çš„ EnsureCreated åˆ›å»ºå…·æœ‰æ–°æ¶æ„çš„æ•°æ®åº“ã€‚

åœ¨æ•°æ®åº“å½•å…¥æœ‰æ•°æ®ï¼Œæƒ…å†µå°±æœ‰æ‰€ä¸åŒäº†ï¼Œè¿ç§» Imigreation å°±æ˜¯ä¸ºæ­¤å‡†å¤‡çš„ã€‚


å¦‚æœå·²å¯¹æ•°æ®åº“åº”ç”¨ä¸€ä¸ªè¿ç§»æˆ–å¤šä¸ªè¿ç§»ï¼Œä½†éœ€å°†å…¶å¤åŸï¼Œåˆ™å¯ä½¿ç”¨åŒä¸€å‘½ä»¤æ¥åº”ç”¨è¿ç§»ï¼Œå¹¶æŒ‡å®šå›é€€æ—¶çš„ç›®æ ‡è¿ç§»åç§°ã€‚LastGoodMigration æŒ‡å®šä¹‹å‰å·¥ä½œæ­£å¸¸çš„è¿ç§»å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ list å‘½ä»¤æŸ¥è¯¢æ—§çš„è¿ç§»ï¼Œå®Œæˆåï¼Œä¸ä¼šåˆ é™¤è¿ç§»å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯ EF Core å¯ä»¥åœ¨ä»»æ„è¿ç§»ä¸­åˆ‡æ¢ï¼Œè¿ç§»å›æ’¤æ“ä½œä¹Ÿæ˜¯é€šè¿‡æ­¤æ–¹æ³•ï¼š

    dotnet ef migrations list
    dotnet ef database update LastGoodMigration


SQL è„šæœ¬ç”Ÿæˆæ˜¯ä¸€å¾ˆé‡è¦çš„åŠŸèƒ½ï¼ŒæŒ‡å®šä½¿ç”¨å¼€å§‹çš„è¿ç§»ç‰ˆæœ¬ From å’Œç»“æŸè¿ç§»ç‰ˆæœ¬ To ï¼Œå¦¤å¯ä»¥ç”Ÿæˆæ–¹å¼å®ƒä»¬çš„å·®å¼‚åŒ– SQL æœ¬ã€‚å¦‚ï¼Œä¸‹é¢çš„ä¸¤ä¸ªè¿ç§»ï¼Œåªæ˜¯åšäº†ä¸€ä¸ªå­—æ®µçš„åˆ é™¤æ›´æ–°ï¼š

    >dotnet ef migrations script InitialCreate upgrade_1.0  -c SchoolContext --no-build
    SchoolContext.cs OnModelCreating
    upgrade_10 UP...
    upgrade_10 BuildTargetModel...
    ALTER TABLE `Course` DROP COLUMN `IsMajor`;

    INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
    VALUES ('20200531105213_upgrade_1.0', '3.1.4');


ç”Ÿæˆè¿ç§»åˆ°æœ€æ–°çŠ¶æ€ SQL è„šæœ¬ï¼š

    >dotnet ef migrations script --no-build -c SchoolContext
    CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
        "MigrationId" TEXT NOT NULL CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY,
        "ProductVersion" TEXT NOT NULL
    );

    CREATE TABLE "Course" (
        "CourseID" INTEGER NOT NULL CONSTRAINT "PK_Course" PRIMARY KEY,
        "Title" TEXT NULL,
        "Credits" INTEGER NOT NULL
    );
    ...
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20200531010213_InitialCreate', '3.1.4');

ç»è¿‡ç¼–è¯‘è¿è¡Œåï¼Œæ‰€æœ‰è¿ç§»å¯¹è±¡éƒ½ç¼–è¯‘åˆ° DLL åº“é‡Œä¿å­˜ï¼Œå¯ä»¥ä½¿ç”¨ --no-build ä¸€ç›´ä½¿ç”¨ï¼Œç›´åˆ°ä¸‹æ¬¡ä¿®æ”¹æˆ–åˆ é™¤è¿ç§»æ±‚å¯¹è±¡åå†æ¬¡ç¼–è¯‘ã€‚


# =ğŸš© SignalR å®æ—¶æ¶ˆæ¯æ¨é€åº”ç”¨
- https://docs.microsoft.com/en-us/aspnet/core/signalr/introduction?view=aspnetcore-2.2
- https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr?view=aspnetcore-3.1
- https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr-typescript-webpack?view=aspnetcore-3.1
- https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr-blazor-webassembly?view=aspnetcore-3.1
- https://docs.microsoft.com/zh-cn/aspnet/core/signalr/hubs?view=aspnetcore-3.1
- https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.signalr.client?view=aspnetcore-2.2


ASP.NET Core SignalR æ˜¯ä¸€ç§å¼€æ”¾æºä»£ç åº“ï¼Œå¯ç®€åŒ–å°†å®æ—¶ web åŠŸèƒ½æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚ å®æ—¶ web åŠŸèƒ½ä½¿æœåŠ¡å™¨ç«¯ä»£ç å¯ä»¥ç«‹å³å°†å†…å®¹æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚SignalR æä¾›ç”¨äºåˆ›å»ºæœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰çš„ APIã€‚ Rpc é€šè¿‡æœåŠ¡å™¨ç«¯ .NET Core ä»£ç ï¼Œä»å®¢æˆ·ç«¯è°ƒç”¨ JavaScript å‡½æ•°ã€‚

ä¸‹é¢æ˜¯çš„ SignalR æŸäº›åŠŸèƒ½ï¼š

- è‡ªåŠ¨å¤„ç†è¿æ¥ç®¡ç†ã€‚
- å°†æ¶ˆæ¯åŒæ—¶å‘é€åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚ ä¾‹å¦‚ï¼ŒèŠå¤©å®¤ã€‚
- å‘ç‰¹å®šå®¢æˆ·ç«¯æˆ–å®¢æˆ·ç«¯ç»„å‘é€æ¶ˆæ¯ã€‚
- å¯ç¼©æ”¾ä»¥å¤„ç†ä¸æ–­å¢åŠ çš„æµé‡ã€‚

SignalRæ”¯æŒä»¥ä¸‹ç”¨äºå¤„ç†å®æ—¶é€šä¿¡çš„æŠ€æœ¯ï¼ˆæŒ‰æ­£å¸¸å›é€€çš„é¡ºåºï¼‰ï¼š

- Websocket
- æœåŠ¡å™¨å‘é€çš„äº‹ä»¶
- é•¿è½®è¯¢
- SignalRè‡ªåŠ¨é€‰æ‹©æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åŠŸèƒ½å†…çš„æœ€ä½³ä¼ è¾“æ–¹æ³•ã€‚

è¦è·å– SignalR JavaScript å®¢æˆ·ç«¯ï¼Œè¯·é€šè¿‡ LibMan å®‰è£…ï¼Œåœ¨é›†æˆç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£… LibMan ä»¥åŠ SignalRï¼š

    dotnet tool install -g Microsoft.Web.LibraryManager.Cli
    libman install @microsoft/signalr@latest -p unpkg -d wwwroot/js/signalr --files dist/browser/signalr.js --files dist/browser/signalr.min.js

.Net Core å®ç°çš„ SignalR å®¢æˆ·ç«¯ï¼š

    dotnet add package Microsoft.AspNetCore.SignalR.Client --version 3.1.4


å…ˆé…ç½® SignalR æœåŠ¡å™¨ï¼Œä»¥å°† SignalR è¯·æ±‚ä¼ é€’åˆ° SignalR ä¸­å¿ƒã€‚å°†ä»¥ä¸‹ä»£ç ç‰‡æ–­æ·»åŠ åˆ° Startup.cs æ–‡ä»¶ï¼Œè¿™äº›æ›´æ”¹å°† SignalR æ·»åŠ åˆ° ASP.NET Core ä¾èµ–å…³ç³»æ³¨å…¥å’Œè·¯ç”±ç³»ç»Ÿï¼š

    using SignalRChat.Hubs;

    services.AddSignalR();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapRazorPages();
        endpoints.MapHub<ChatHub>("/chatHub");
    });


æ¥ä¸‹æ¥éœ€è¦å®ç°ä¸€ä¸ªæ¶ˆæ¯ä¸­å¿ƒç±»ä½œä¸ºå®¢æˆ·ç«¯ - æœåŠ¡å™¨é€šä¿¡çš„é«˜çº§ç®¡é“ï¼Œæ¥å¤„ç†æ¶ˆæ¯æ¨é€ã€‚æ—¢ç„¶æ˜¯å…¶äº WebSocket çš„æ¡†æ¶ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œé€»è¾‘åŸºæœ¬æ˜¯å’Œ Socket.io WebSocket æ¡†æ¶ä¸€è‡´ã€‚

å¯ä»¥åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­åˆ›å»º Hubs æ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾ä¸­å¿ƒç±»ï¼Œåœ¨ Hubs æ–‡ä»¶å¤¹ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»º ChatHub.cs æ–‡ä»¶ ï¼š

    using System;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.SignalR;

    namespace SignalRChat.Hubs
    {
        public class ChatHub : Hub
        {
            public async Task SendMessage(string user, string message)
            {
                await Clients.All.SendAsync("ReceiveMessage", user, message);
            }
        }
    }

ChatHub ç±»ç»§æ‰¿è‡ª SignalR Hub ç±»ã€‚ Hub ç±»ç®¡ç†è¿æ¥ã€ç»„å’Œæ¶ˆæ¯ã€‚å¯é€šè¿‡å·²è¿æ¥å®¢æˆ·ç«¯è°ƒç”¨ SendMessageï¼Œè¿™é‡Œä¼šå‘æ‰€æœ‰å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯å›æ˜¾æ¶ˆæ¯ã€‚ä¹Ÿå¯ä»¥æ ¹æ®ç”¨æˆ·ç»„ Clients.Group(name) æˆ–ç»™ç‰¹å®šç”¨æˆ·å‘é€æ¶ˆæ¯ Clients.User(user)ï¼Œåˆæˆ–è€…å‘ç»™å›è°ƒè€… Clients.Callerã€‚SignalR ä»£ç æ˜¯å¼‚æ­¥æ¨¡å¼ï¼Œå¯æä¾›æœ€å¤§çš„å¯ä¼¸ç¼©æ€§ã€‚

ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢ Pages\Index.cshtml ä¸­çš„å†…å®¹ ï¼š

    @page
        <div class="container">
            <div class="row">&nbsp;</div>
            <div class="row">
                <div class="col-2">User</div>
                <div class="col-4"><input type="text" id="userInput" /></div>
            </div>
            <div class="row">
                <div class="col-2">Message</div>
                <div class="col-4"><input type="text" id="messageInput" /></div>
            </div>
            <div class="row">&nbsp;</div>
            <div class="row">
                <div class="col-6">
                    <input type="button" id="sendButton" value="Send Message" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <hr />
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <ul id="messagesList"></ul>
            </div>
        </div>
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/chat.js"></script>

åœ¨ wwwroot/js æ–‡ä»¶å¤¹ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç åˆ›å»º chat.js æ–‡ä»¶ï¼Œç”¨äºå®¢æˆ·ç«¯è°ƒç”¨ SignalR æ‰§è¡Œ WebSocket é€šä¿¡åŠŸèƒ½ï¼Œå¹¶è¿æ¥åˆ°å‰é¢æ³¨å…¥çš„ /chatHub è·¯ç”±åœ°å€ä¸Šï¼š

    "use strict";

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    //Disable send button until connection is established
    document.getElementById("sendButton").disabled = true;

    connection.on("ReceiveMessage", function (user, message) {
        var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        var encodedMsg = user + " says " + msg;
        var li = document.createElement("li");
        li.textContent = encodedMsg;
        document.getElementById("messagesList").appendChild(li);
    });

    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
    }).catch(function (err) {
        return console.error(err.toString());
    });

    document.getElementById("sendButton").addEventListener("click", function (event) {
        var user = document.getElementById("userInput").value;
        var message = document.getElementById("messageInput").value;
        connection.invoke("SendMessage", user, message).catch(function (err) {
            return console.error(err.toString());
        });
        event.preventDefault();
    });


æ‰§è¡Œ dotnet watch run æµ‹è¯•ã€‚


## ==âš¡ SignalR with TypeScript 

è¦åœ¨ ASP.NET Core SignalR Web åº”ç”¨ä¸­ä½¿ç”¨ TypeScript ç¼–å†™å®¢æˆ·ç«¯ï¼Œéœ€è¦æ·»åŠ  TypeScript ç¼–è¯‘å™¨ Microsoft.TypeScript.MSBuildï¼Œå†ä½œä¸ºè¯¥åº”ç”¨çš„å®¢æˆ·ç«¯é…ç½®ä½¿ç”¨ Webpackï¼Œè¿™éœ€è¦ä½¿ç”¨åˆ° Node.js å¼€å‘ç¯å¢ƒã€‚

é…ç½®æ­¥éª¤ï¼š

- ASP.NET Core SignalR åº”ç”¨åŸºæ¶æ­å»º
- SignalR TypeScript å®¢æˆ·ç«¯é…ç½®
- Webpack é…ç½®ç”Ÿæˆç®¡é“
- SignalR æœåŠ¡å™¨é…ç½®
- å¯ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡

### ===âœ’ TypeScript å®¢æˆ·ç«¯é…ç½®

é¦–å…ˆï¼Œæ‰§è¡Œ dotnet new å‘½ä»¤åœ¨ SignalRWebPack ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªç©ºçš„ ASP.NET Core Web åº”ç”¨ã€‚å¦‚æœï¼Œä½¿ç”¨ Visual Studio Code å¼€å‘å·¥å…·ï¼Œcode å‘½ä»¤ä¼šæ‰“å¼€ SignalRWebPack æ–‡ä»¶å¤¹ã€‚å†æ·»åŠ  Microsoft.TypeScript.MSBuild åŒ…ï¼Œä»è€Œåœ¨é¡¹ç›®ä¸­å¯ç”¨ TypeScript ç¼–è¯‘ã€‚

    dotnet new web -o SignalRWebPack
    code -r SignalRWebPack

    dotnet add package Microsoft.TypeScript.MSBuild

æ¥ä¸‹æ¥ï¼Œé…ç½® Webpack å’Œ TypeScriptï¼Œæ¶‰åŠå†…å®¹è¾ƒå¤šï¼Œå› ä¸ºä½¿ç”¨åˆ°äº† Node.js å¼€å‘ç¯å¢ƒï¼Œè¿˜éœ€è¦ WebPack æ¨¡å—åŒ–å¼€å‘åŸºç¡€ã€‚è·Ÿç€ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼Œå°† JavaScript ç¯å¢ƒè½¬æ¢åˆ° TypeScriptã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­è¿è¡Œ npm å‘½ä»¤åˆå§‹åŒ–å·¥ç¨‹ï¼Œåˆ›å»º package.json é…ç½®æ–‡ä»¶ ï¼š

    npm init -y

å°†ä»¥ä¸‹ private å±æ€§æ·»åŠ åˆ° package.json æ–‡ä»¶å¹¶ä¿å­˜æ–‡ä»¶æ›´æ”¹ï¼Œå°† private å±æ€§è®¾ç½®ä¸º trueï¼Œé˜²æ­¢ä¸‹ä¸€æ­¥å‡ºç°åŒ…å®‰è£…è­¦å‘Šï¼š

    {
      "name": "SignalRWebPack",
      "version": "1.0.0",
      "private": true,
      "description": "",
      "main": "index.js",
      "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1"
      },
      "keywords": [],
      "author": "",
      "license": "ISC"
    }


å®‰è£…é¡¹ç›®æ‰€éœ€çš„ npm åŒ…ï¼Œæ³¨æ„ï¼Œä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    npm i -D -E clean-webpack-plugin@3.0.0 css-loader@3.4.2 html-webpack-plugin@3.2.0 mini-css-extract-plugin@0.9.0 ts-loader@6.2.1 typescript@3.7.5 webpack@4.41.5 webpack-cli@3.3.10

éœ€è¦æ³¨æ„çš„ä¸€äº›å‘½ä»¤ç»†èŠ‚ï¼Œæ¯ä¸ªåŒ…åç§°ä¸­ @ ç¬¦å·åæ˜¯ç‰ˆæœ¬å·ï¼Œnpm å®‰è£…è¿™äº›åŒ…çš„æŒ‡å®šç‰ˆæœ¬ã€‚
-E é€‰é¡¹ç¦ç”¨ npm å°†è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶èŒƒå›´è¿ç®—ç¬¦å†™åˆ° package.json çš„é»˜è®¤è¡Œä¸ºã€‚ ä¾‹å¦‚ï¼Œä½¿ç”¨ "webpack": "4.41.5" è€Œä¸æ˜¯ "webpack": "^4.41.5"ï¼Œè„±å­—ç¬¦å· ^ è¡¨ç¤ºæ¥å—æ­¤ç‰ˆæœ¬å·ä»¥ä¸Šçš„åŒ…ï¼Œæ­¤é€‰é¡¹é˜²æ­¢æ„å¤–å‡çº§åˆ°æ–°çš„åŒ…ç‰ˆæœ¬ã€‚-D é€‰é¡¹è¡¨ç¤ºä¾èµ–åŒ…å®‰è£…åï¼Œä¾èµ–ä¿¡æ¯è®°å½•åˆ°é…ç½®æ–‡ä»¶çš„ devDependencies ä¸­ï¼Œå³è¿™äº›åŒ…éƒ½æ˜¯å¼€å‘ä¾èµ–ï¼Œå‘å¸ƒæ—¶ä¸ä¼šè¢«æ‰“åŒ…è¾“å‡ºã€‚ å®‰è£…å¥½çš„åŒ…éƒ½ä¼šåœ¨ node_modules ç›®å½•ä¸‹ä¿å­˜ã€‚

å®¢æˆ·ç«¯è¿˜éœ€è¦å¼•å…¥ SignalRï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    npm i @microsoft/signalr @types/node

ä¸Šè¿°çš„ä»£ç ä¼šå®‰è£… SignalR TypeScript å®¢æˆ·ç«¯ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚@types/node æ˜¯ç”¨äº node.js çš„ TypeScript ç±»å‹å®šä¹‰ï¼Œæ”¯æŒ Node.js ç±»å‹çš„ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚


å°† package.json æ–‡ä»¶çš„ scripts å±æ€§æ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  ï¼š

    "scripts": {
      "start": "webpack --mode=development --watch",
      "release": "webpack --mode=production",
      "publish": "npm run release && dotnet publish -c Release"
    },

è¿™äº›è„šæœ¬è®¾ç½®ç›®çš„æ˜¯æ–¹ä¾¿æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚ï¼Œæ‰§è¡Œ npm run start å°±ä¼šæ‰§è¡Œå…¶è®¾ç½®çš„è„šæœ¬ï¼š

- start åœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰“åŒ…å®¢æˆ·ç«¯èµ„æºå¹¶è§‚å¯Ÿæ–‡ä»¶æ›´æ”¹ã€‚ --watch æ–‡ä»¶ç›‘è§†ç¨‹åºåœ¨æ¯æ¬¡é¡¹ç›®æ–‡ä»¶å‘ç”Ÿæ›´æ”¹æ—¶é‡æ–°ç”Ÿæˆã€‚ mode é€‰é¡¹å¯ç¦ç”¨ç”Ÿäº§ä¼˜åŒ–ï¼Œä»¥åŠ é€Ÿå¼€å‘æ•ˆç‡ã€‚
- release åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹æ‰“åŒ…å®¢æˆ·ç«¯èµ„æºã€‚
- publish è¿è¡Œ release è„šæœ¬ï¼Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹æ‰“åŒ…å®¢æˆ·ç«¯èµ„æºã€‚ å®ƒè°ƒç”¨ .NET Core CLI çš„ publish å‘½ä»¤å‘å¸ƒåº”ç”¨ã€‚

å†æ¥ä¸‹æ¥ï¼Œé…ç½® Webpackï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºåä¸º webpack.config.js çš„æ–‡ä»¶ï¼Œä½¿å…¶åŒ…å«ä»¥ä¸‹ä»£ç  ï¼š

    const path = require("path");
    const HtmlWebpackPlugin = require("html-webpack-plugin");
    const { CleanWebpackPlugin } = require("clean-webpack-plugin");
    const MiniCssExtractPlugin = require("mini-css-extract-plugin");
    module.exports = {
        entry: "./src/index.ts",
        output: {
            path: path.resolve(__dirname, "wwwroot"),
            filename: "[name].[chunkhash].js",
            publicPath: "/"
        },
        resolve: {
            extensions: [".js", ".ts"]
        },
        module: {
            rules: [
                {
                    test: /\.ts$/,
                    use: "ts-loader"
                },
                {
                    test: /\.css$/,
                    use: [MiniCssExtractPlugin.loader, "css-loader"]
                }
            ]
        },
        plugins: [
            new CleanWebpackPlugin(),
            new HtmlWebpackPlugin({
                template: "./src/index.html"
            }),
            new MiniCssExtractPlugin({
                filename: "css/[name].[chunkhash].css"
            })
        ]
    };

è¿™ä¸ªé…ç½®ä¼šæŒ‡å¯¼ Webpack ç¼–è¯‘æµç¨‹ï¼Œæ³¨æ„çš„ä¸€äº›é…ç½®ç»†èŠ‚ï¼š

- output å±æ€§æ›¿ä»£ dist çš„é»˜è®¤å€¼ï¼Œæ‰“åŒ…è¾“å‡ºåœ¨ wwwroot ç›®å½•ä¸­ã€‚
- resolve.extensions æ•°ç»„åŒ…å« .jsï¼Œä»¥ä¾¿å¯¼å…¥ SignalR å®¢æˆ·ç«¯ JavaScriptã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºæ–°çš„ src ç›®å½•ï¼Œä»¥å­˜å‚¨é¡¹ç›®çš„å®¢æˆ·ç«¯èµ„æºæ–‡ä»¶ï¼Œå¦‚æ ·å¼è¡¨æ–‡ä»¶ã€TS è„šæœ¬ç­‰ã€‚

åˆ›å»ºåŒ…å«ä»¥ä¸‹ JSON çš„ src/tsconfig.jsonï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶æŒ‡å¯¼ TypeScript ç¼–è¯‘è¾“å‡º ECMAScript 5 è§„èŒƒçš„ JavaScriptï¼š

    {
      "compilerOptions": {
        "target": "es5"
      }
    }

æ¥ä¸‹æ¥å°±å¯ä»¥åˆ›å»º TypeScript è„šæœ¬ï¼Œåˆ›å»ºåŒ…å«ä»¥ä¸‹ä»£ç çš„ src/index.tsï¼š

    import "./css/main.css";

    const divMessages: HTMLDivElement = document.querySelector("#divMessages");
    const tbMessage: HTMLInputElement = document.querySelector("#tbMessage");
    const btnSend: HTMLButtonElement = document.querySelector("#btnSend");
    const username = new Date().getTime();

    tbMessage.addEventListener("keyup", (e: KeyboardEvent) => {
        if (e.key === "Enter") {
            send();
        }
    });

    btnSend.addEventListener("click", send);

    function send() {
        console.log("send()");
    }

å‰é¢çš„ TypeScript æ£€ç´¢å¯¹ DOM å…ƒç´ çš„å¼•ç”¨å¹¶é™„åŠ ä¸¤ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼š

- keyup ç”¨æˆ·åœ¨ tbMessage æ–‡æœ¬æ¡†ä¸­é”®å…¥æ—¶è§¦å‘æ­¤äº‹ä»¶ã€‚ ç”¨æˆ·æŒ‰ Enter æ—¶è°ƒç”¨ send å‡½æ•° ã€‚
- click ç”¨æˆ·å•å‡»å‘é€æŒ‰é’®æ—¶è§¦å‘æ­¤äº‹ä»¶ï¼Œè°ƒç”¨ send å‡½æ•°ã€‚

ç›¸åº”åœ°åˆ›å»ºåŒ…å«ä»¥ä¸‹æ ‡è®°çš„ src/index.html ã€‚

    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8" />
        <title>ASP.NET Core SignalR</title>
    </head>
    <body>
        <div id="divMessages" class="messages">
        </div>
        <div class="input-zone">
            <label id="lblMessage" for="tbMessage">Message:</label>
            <input id="tbMessage" class="input-zone-input" type="text" />
            <button id="btnSend">Send</button>
        </div>
    </body>
    </html>


åˆ›å»ºåŒ…å«ä»¥ä¸‹ CSS çš„ src/css/main.css ï¼š

    *, *::before, *::after {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 0;
    }

    .input-zone {
        align-items: center;
        display: flex;
        flex-direction: row;
        margin: 10px;
    }

    .input-zone-input {
        flex: 1;
        margin-right: 10px;
    }

    .message-author {
        font-weight: bold;
    }

    .messages {
        border: 1px solid #000;
        margin: 10px;
        max-height: 300px;
        min-height: 300px;
        overflow-y: auto;
        padding: 5px;
    }

åˆ°æ­¤ï¼ŒTypeScript çš„ç¯å¢ƒé…ç½®å®Œæˆã€‚æ¥ä¸‹æ¥çš„å·¥ä½œå°±æ˜¯ SignalR çš„ä½¿ç”¨ä¸è®¾ç½®ã€‚


**è­¦å‘Š** Webpack æ‰“åŒ…è¾“å‡ºæ—¶ï¼Œclean-webpack-plugin æ’ä»¶ä¼šæ¸…ç©ºç›®å½•ï¼Œå¯ä»¥ç¦ç”¨æ­¤æ’ä»¶ã€‚

æˆ–è€…ï¼ŒåŸæœ‰ wwwroot ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶ç§»åŠ¨åˆ° static ç›®å½•ä¸‹ï¼Œé…ç½® copy-webpack-plugin æ’ä»¶ï¼Œæ‰“åŒ…æ—¶è‡ªåŠ¨å¤åˆ¶ä¸€ä»½åˆ° wwwroot ç›®å½•ã€‚

    const CopyPlugin = require('copy-webpack-plugin');

    plugins: [
        new CopyPlugin(
        [{
            from: path.resolve(__dirname, "staic"), 
            to: path.resolve(__dirname, "wwwroot"),
            force:true
        }]),
    ],

å¯ä»¥å°† SignalR JavaScript å®¢æˆ·ç«¯é…ç½®æˆç‹¬ç«‹å¼•å…¥ HTML é¡µé¢ï¼Œä¿®æ”¹ webpack.config.jsï¼Œæ³¨æ„é”®å€¼å¯¹ä¸­ï¼ŒKey ä¸ºåŒ…åï¼Œåé¢çš„å€¼è¡¨ç¤ºå‰ç«¯é¡µé¢å¼•å…¥ä½¿ç”¨çš„å¯¹è±¡å¼•ç”¨åï¼š

    externals: [
        {"@microsoft/signalr":"signalR" },
    ],

ä½¿ç”¨ npm ä¸‹è½½å¥½ SignalR å®¢æˆ·ç«¯ï¼Œæˆ–è€…é€šè¿‡ LibMan å®‰è£…ï¼Œåœ¨é›†æˆç»ˆç«¯ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£… LibMan ä»¥åŠ SignalRï¼š

    dotnet tool install -g Microsoft.Web.LibraryManager.Cli
    libman install @microsoft/signalr@latest -p unpkg -d wwwroot/lib/signalr --files dist/browser/signalr.js --files dist/browser/signalr.min.js


### ===âœ’ SignalR æœåŠ¡å™¨é…ç½®

ä¸ºäº†ä½¿ç”¨å‰é¢ç¼–è¾‘å¥½çš„é™æ€æ–‡ä»¶ï¼Œéœ€è¦åœ¨ Startup.Configure ä¸­æ·»åŠ å¯¹ UseDefaultFiles å’Œ UseStaticFiles çš„è°ƒç”¨ã€‚åœ¨ Startup.Configure çš„æœ«å°¾ï¼Œæ·»åŠ  /hub è·¯ç”±æ˜ å°„åˆ° ChatHub ä¸­å¿ƒ ã€‚å†åœ¨ Startup.ConfigureServices ä¸­è°ƒç”¨ AddSignalRï¼Œå¹¶åœ¨ Startup.cs æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ä»¥ä¸‹ using è¯­å¥æ¥è§£æ ChatHub æ‰€åœ¨çš„å‘½åç©ºé—´ï¼š

    using SignalRWebPack.Hubs;
    
    ...

    public void ConfigureServices(IServiceCollection services)
    {
        ...
        services.AddSignalR();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }
        
        app.UseRouting();
        app.UseDefaultFiles();
        app.UseStaticFiles();
        
        app.UseEndpoints(endpoints =>
        {
            endpoints.MapRazorPages();
            endpoints.MapHub<ChatHub>("/hub");
        });
            
    }

ä¸Šè¿°ä»£ç  UseDefaultFiles å…è®¸æœåŠ¡å™¨æŸ¥æ‰¾å’Œå¤„ç† index.html æ–‡ä»¶ï¼Œ æ— è®ºç”¨æˆ·è¾“å…¥å®Œæ•´ URL è¿˜æ˜¯ Web åº”ç”¨çš„æ ¹ URLï¼Œéƒ½ä¼šæä¾›è¯¥æ–‡ä»¶ã€‚è¿™æ ·å°±ä¸ä¼šä½¿ç”¨é»˜è®¤çš„ endpoints.MapRazorPages() åŠ è½½ Razor Pageã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºåä¸º Hubs çš„æ–°ç›®å½•ï¼Œä»¥å­˜å‚¨ SignalR ä¸­å¿ƒï¼Œåˆ›å»ºåŒ…å«ä»¥ä¸‹ä»£ç çš„ä¸­å¿ƒ Hubs/ChatHub.cs ï¼š

    using Microsoft.AspNetCore.SignalR;
    using System.Threading.Tasks;

    namespace SignalRWebPack.Hubs
    {
        public class ChatHub : Hub
        {
            public async Task SendMessage(string user, string message)
            {
                Console.WriteLine($"SendMessage {user} {message}");
                await Clients.All.SendAsync("ReceiveMessage", user, message);
                // await Clients.Caller.SendAsync("ReceiveMessage", user, message);
            }
        }
    }

ç„¶åä¿®æ”¹ src/index.ts æ–‡ä»¶ä»£ç ï¼Œä½¿ç”¨ SignalR ä¼ è¾“æ¶ˆæ¯ï¼š

    import "./css/main.css";
    import * as signalR from "@microsoft/signalr";

    const divMessages: HTMLDivElement = document.querySelector("#divMessages");
    const tbMessage: HTMLInputElement = document.querySelector("#tbMessage");
    const btnSend: HTMLButtonElement = document.querySelector("#btnSend");
    const username = new Date().getTime();

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/hub")
        .build();

    connection.on("ReceiveMessage", (username: string, message: string) => {
        let messages = document.createElement("div");

        messages.innerHTML =
            `<div class="message-author">${username}</div><div>${message}</div>`;

        divMessages.appendChild(messages);
        divMessages.scrollTop = divMessages.scrollHeight;
    });

    connection.start().catch(err => document.write(err));

    tbMessage.addEventListener("keyup", (e: KeyboardEvent) => {
        if (e.key === "Enter") {
            send();
        }
    });

    btnSend.addEventListener("click", send);

    function send() {
        connection.send("SendMessage", username, tbMessage.value)
            .then(() => tbMessage.value = "");
    }

å‰é¢çš„ä»£ç æ”¯æŒä»æœåŠ¡å™¨æ¥æ”¶æ¶ˆæ¯ã€‚ HubConnectionBuilder ç±»åˆ›å»ºæ–°çš„ç”Ÿæˆå™¨ï¼Œç”¨äºé…ç½®æœåŠ¡å™¨è¿æ¥ã€‚ withUrl å‡½æ•°é…ç½®ä¸­å¿ƒ URLã€‚

SignalR å¯ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ¶ˆæ¯äº¤æ¢ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ç‰¹å®šçš„åç§°ã€‚ ä¾‹å¦‚ï¼Œåä¸º `messageReceived` çš„æ¶ˆæ¯å¯ä»¥è¿è¡Œè´Ÿè´£åœ¨æ¶ˆæ¯åŒºåŸŸæ˜¾ç¤ºæ–°æ¶ˆæ¯çš„é€»è¾‘ã€‚ å¯ä»¥é€šè¿‡ on å‡½æ•°å®Œæˆå¯¹ç‰¹å®šæ¶ˆæ¯çš„ä¾¦å¬ã€‚ å¯ä»¥ä¾¦å¬ä»»æ„æ•°é‡çš„æ¶ˆæ¯åç§°ã€‚ æ³¨æ„å‚æ•°ç±»å‹åŒ¹é…ï¼Œæ¶ˆæ¯åç§°æ”¶å‘å¯¹åº”ï¼Œå¦åˆ™æ¥æ”¶ä¸åˆ°æ¶ˆæ¯ã€‚

è¿˜å¯ä»¥å°†å‚æ•°ä¼ é€’åˆ°æ¶ˆæ¯ï¼Œä¾‹å¦‚æ‰€æ¥æ”¶æ¶ˆæ¯çš„ä½œè€…å§“åå’Œå†…å®¹ã€‚ å®¢æˆ·ç«¯æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯åï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ div å…ƒç´ å¹¶åœ¨å…¶ innerHTML å±æ€§ä¸­æ˜¾ç¤ºä½œè€…å§“åå’Œæ¶ˆæ¯å†…å®¹ã€‚ å®ƒæ·»åŠ åˆ°æ˜¾ç¤ºæ¶ˆæ¯çš„ä¸»è¦ div å…ƒç´ ã€‚

å®¢æˆ·ç«¯å¯ä»¥æ¥æ”¶æ¶ˆæ¯åï¼Œé€šè¿‡ send ç»™æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚ é€šè¿‡ WebSockets è¿æ¥å‘é€æ¶ˆæ¯éœ€è¦è°ƒç”¨ send æ–¹æ³•ã€‚ è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¶ˆæ¯åç§°ï¼Œåè·Ÿæ¶ˆæ¯æ•°æ®åŒ…å«çš„å…¶ä»–å‚æ•°ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä¸€æ¡æ ‡è¯†ä¸º `SendMessage` çš„æ¶ˆæ¯å·²å‘é€åˆ°æœåŠ¡å™¨ã€‚ è¯¥æ¶ˆæ¯åŒ…å«ç”¨æˆ·åå’Œæ–‡æœ¬æ¡†ä¸­çš„ç”¨æˆ·è¾“å…¥ã€‚ å¦‚æœå‘é€æˆåŠŸï¼Œä¼šæ¸…ç©ºæ–‡æœ¬æ¡†ã€‚

å®¢æˆ·ç«¯æ¶ˆæ¯å°†é€šè¿‡è·¯ç”±è¿›å…¥ ChatHub.NewMessageï¼ŒæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯åï¼Œå‰é¢çš„ä»£ç ä¼šå°†è¿™äº›æ¶ˆæ¯æ’­å‘åˆ°æ‰€æœ‰è¿æ¥çš„ç”¨æˆ·ã€‚ æ²¡æœ‰å¿…è¦ä½¿ç”¨æ³›å‹ on æ–¹æ³•æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ã€‚ ä½¿ç”¨ä»¥æ¶ˆæ¯åç§°å‘½åçš„æ–¹æ³•å°±å¯ä»¥äº†ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒTypeScript å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ ‡è¯†ä¸º `SendMessage` çš„æ¶ˆæ¯ã€‚å®¢æˆ·ç«¯æ¶ˆæ¯å°†é€šè¿‡è·¯ç”±è¿›å…¥ ChatHub.SendMessage æ–¹æ³•ï¼Œéœ€è¦å‘å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œåœ¨ Clients.All ä¸Šè°ƒç”¨ SendAsync æ–¹æ³•ä¼šå°†æ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰è¿æ¥åˆ°ä¸­å¿ƒçš„å®¢æˆ·ç«¯ã€‚

ç»™æŒ‡å®šå®¢æˆ·ç«¯ï¼Œå¦‚å½“å‰å›è°ƒç”¨æˆ· Clients.Caller æˆ–ç”¨æˆ·ç»„ Clients.Group(name) æˆ–ç»™ç‰¹å®šç”¨æˆ·å‘é€æ¶ˆæ¯ Clients.User(user)ã€‚


æœ€åï¼Œæ‰“åŒ…é¡¹ç›®ï¼Œæˆ–æ‰§è¡Œæµ‹è¯•ã€‚

    npm run dev

é€šè¿‡åœ¨é¡¹ç›®æ ¹ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥ release æ¨¡å¼è¿è¡Œ Webpack æ‰“åŒ…é¡¹ç›®ï¼š

    npm run release

Webpack å®Œæˆäº†ä»¥ä¸‹ä»»åŠ¡ï¼š

- æ¸…é™¤äº† wwwroot ç›®å½•çš„å†…å®¹ ã€‚
- å°† TypeScript è½¬æ¢ä¸º JavaScriptï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºâ€œè½¬è¯‘â€ ã€‚
- ç ´åç”Ÿæˆçš„ JavaScript ä»¥é™ä½æ–‡ä»¶å¤§å°ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºç¼©å° ã€‚
- å°†å·²å¤„ç†çš„ JavaScriptã€CSS å’Œ HTML æ–‡ä»¶ä» src å¤åˆ¶åˆ° wwwroot ç›®å½• ã€‚
- å°†ä»¥ä¸‹å…ƒç´ æ³¨å…¥ wwwroot/index.html æ–‡ä»¶ ï¼š

    ä¸€ä¸ªå¼•ç”¨ `wwwroot/main.<hash>.css` æ–‡ä»¶çš„ `<link>` æ ‡è®°ã€‚ æ­¤æ ‡è®°ç´§æŒ¨ç€ `</head>` ç»“æŸæ ‡è®°ä¹‹å‰ã€‚
    ä¸€ä¸ªå¼•ç”¨`wwwroot/main.<hash>.js` æ–‡ä»¶çš„ `<script>` æ ‡è®°ã€‚ æ­¤æ ‡è®°ç´§æŒ¨ç€ `</body>` ç»“æŸæ ‡è®°ä¹‹å‰ã€‚

é€šè¿‡åœ¨é¡¹ç›®æ ¹ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå’Œè¿è¡Œåº”ç”¨ï¼š

    dotnet run

Web æœåŠ¡å™¨å¯åŠ¨åº”ç”¨å¹¶åœ¨ localhost ä¸Šæä¾›ã€‚æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨ï¼Œè½¬åˆ°æœåŠ¡åœ°å€ï¼Œæ£€æŸ¥æœåŠ¡æä¾› wwwroot/index.html æ–‡ä»¶ ã€‚ 

é€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨ï¼Œåœ¨æ¶ˆæ¯æ–‡æœ¬æ¡†ä¸­é”®å…¥ä»»æ„å†…å®¹ï¼Œç„¶åå•å‡»å‘é€æŒ‰é’®ï¼Œä¸¤ä¸ªé¡µé¢ä¸Šç«‹å³æ˜¾ç¤ºå”¯ä¸€çš„ç”¨æˆ·åå’Œæ¶ˆæ¯ã€‚




# =ğŸš© Blazor äº¤äº’å¼å®¢æˆ·ç«¯æ¡†æ¶
- https://docs.microsoft.com/en-us/aspnet/core/blazor/?view=aspnetcore-3.1
- https://github.com/AdrienTorris/awesome-blazor
- https://developer.mozilla.org/zh-CN/docs/Web/Manifest


ç»„ä»¶åŒ–çš„ Blazor æ¡†æ¶ç»“åˆ WebAssembly å°±å¯ä»¥ç”¨ C# æ¥å®ç°äº¤äº’å¼å®¢æˆ·ç«¯ Web UIï¼Œå®ƒåŸºäº SignalR å³ WebSocket æŠ€æœ¯å®ç°æ¶ˆæ¯æ¨é€ï¼Œé«˜æ•ˆè·¨å¹³å°ã€‚ç»„ä»¶åŒ–è¿™å¾ˆå®¹æ˜“è”æƒ³åˆ° React/Angular/Vue è¿™äº›ç»„ä»¶åŒ–çš„å‰ç«¯æ¡†æ¶ï¼Œå› ä¸ºå®ƒä»¬çœŸçš„å¾ˆå¤šç±»ä¼¼ã€‚

Blazor æ˜¯ä¸€ä¸ªä½¿ç”¨ .NET ç”Ÿæˆäº¤äº’å¼å®¢æˆ·ç«¯ Web UI çš„æ¡†æ¶ï¼š

- ä½¿ç”¨ C# ä»£æ›¿ JavaScript æ¥åˆ›å»ºä¸°å¯Œçš„äº¤äº’å¼ UIã€‚
- å…±äº«ä½¿ç”¨ .NET ç¼–å†™çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åº”ç”¨é€»è¾‘ã€‚
- å°† UI å‘ˆç°ä¸º HTML å’Œ CSSï¼Œä»¥æ”¯æŒä¼—å¤šæµè§ˆå™¨ï¼Œå…¶ä¸­åŒ…æ‹¬ç§»åŠ¨æµè§ˆå™¨ã€‚
- ä¸æ–°å¼æ‰˜ç®¡å¹³å°ï¼ˆå¦‚ Dockerï¼‰é›†æˆã€‚

ä½¿ç”¨ .NET è¿›è¡Œå®¢æˆ·ç«¯ Web å¼€å‘å¯æä¾›ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- ä½¿ç”¨ C# ä»£æ›¿ JavaScript æ¥ç¼–å†™ä»£ç ã€‚
- åˆ©ç”¨ç°æœ‰çš„ .NET åº“ç”Ÿæ€ç³»ç»Ÿã€‚
- åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´å…±äº«åº”ç”¨é€»è¾‘ã€‚
- å—ç›Šäº .NET çš„æ€§èƒ½ã€å¯é æ€§å’Œå®‰å…¨æ€§ã€‚
- å§‹ç»ˆé«˜æ•ˆæ”¯æŒ Windowsã€Linux å’Œ macOS ä¸Šçš„ Visual Studioã€‚
- ä»¥ä¸€ç»„ç¨³å®šã€åŠŸèƒ½ä¸°å¯Œä¸”æ˜“ç”¨çš„é€šç”¨è¯­è¨€ã€æ¡†æ¶å’Œå·¥å…·ä¸ºåŸºç¡€æ¥è¿›è¡Œç”Ÿæˆã€‚


Blazor ä½¿ç”¨ Razor ç»„ä»¶ï¼ŒRazor æ˜¯ä¸€ç§è¯­æ³•ï¼Œç”¨äºå°† HTML æ ‡è®°ä¸ä¸“ä¸ºæé«˜å¼€å‘äººå‘˜å·¥ä½œæ•ˆç‡è€Œè®¾è®¡çš„ C# ä»£ç ç»“åˆåœ¨ä¸€èµ·ã€‚

Blazor WebAssembly æ˜¯ä¸€ä¸ªå•é¡µåº”ç”¨æ¡†æ¶ï¼Œå¯ç”¨å®ƒé€šè¿‡ .NET ç”Ÿæˆäº¤äº’å¼å®¢æˆ·ç«¯ Web åº”ç”¨ã€‚ Blazor WebAssembly ä½¿ç”¨å¼€æ”¾çš„ Web æ ‡å‡†ï¼Œé€‚ç”¨äºç§»åŠ¨æµè§ˆå™¨ç­‰å„ç§æ–°å¼ Web æµè§ˆå™¨ã€‚é€šè¿‡ WebAssemblyï¼Œå¯åœ¨ Web æµè§ˆå™¨å†…è¿è¡Œ .NET ä»£ç ã€‚ WebAssembly æ˜¯é’ˆå¯¹å¿«é€Ÿä¸‹è½½å’Œæœ€å¤§æ‰§è¡Œé€Ÿåº¦ä¼˜åŒ–çš„å‹ç¼©å­—èŠ‚ç æ ¼å¼ã€‚

Blazor Server å°†ç»„ä»¶å‘ˆç°é€»è¾‘ä» UI æ›´æ–°çš„åº”ç”¨æ–¹å¼ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ Blazor æœåŠ¡å™¨åœ¨ ASP.NET Core åº”ç”¨ä¸­æ·»åŠ äº†å¯¹åœ¨æœåŠ¡å™¨ä¸Šæ‰˜ç®¡ Razor ç»„ä»¶çš„æ”¯æŒã€‚ å¯é€šè¿‡ SignalR è¿æ¥å¤„ç† UI æ›´æ–°ã€‚è¿è¡Œæ—¶å¤„ç†ä»æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ UI äº‹ä»¶ï¼Œå¹¶åœ¨è¿è¡Œç»„ä»¶åï¼Œå°†æœåŠ¡å™¨å‘é€çš„ UI æ›´æ–°é‡æ–°åº”ç”¨åˆ°æµè§ˆå™¨ã€‚
Blazor æœåŠ¡å™¨ç”¨äºä¸æµè§ˆå™¨é€šä¿¡çš„è¿æ¥è¿˜ç”¨äºå¤„ç† JavaScript äº’æ“ä½œè°ƒç”¨ã€‚

å¯¹äºéœ€è¦ç¬¬ä¸‰æ–¹ JavaScript åº“å’Œè®¿é—®æµè§ˆå™¨ API çš„åº”ç”¨ï¼Œç»„ä»¶ä¸ JavaScript è¿›è¡Œäº’æ“ä½œã€‚ ç»„ä»¶èƒ½å¤Ÿä½¿ç”¨ JavaScript èƒ½å¤Ÿä½¿ç”¨çš„ä»»ä½•åº“æˆ– APIã€‚ C# ä»£ç å¯ä»¥è°ƒç”¨åˆ° JavaScript ä»£ç ï¼Œè€Œ JavaScript ä»£ç å¯ä»¥è°ƒç”¨åˆ° C# ä»£ç ã€‚ 

- åœ¨ ASP.NET Core Blazor ä¸­ä» .NET æ–¹æ³•è°ƒç”¨ JavaScript å‡½æ•°
- ä» ASP.NET Core Blazor ä¸­çš„ JavaScript å‡½æ•°è°ƒç”¨ .NET æ–¹æ³•


è‹¥è¦è·å¾— Blazor Server ä½“éªŒï¼Œè¯·åœ¨å‘½ä»¤è¡Œç•Œé¢ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    dotnet new blazorserver -o blazorServerWebApp
    cd blazorServerWebApp
    dotnet run

è‹¥è¦è·å¾— Blazor WebAssembly ä½“éªŒï¼Œè¯·åœ¨å‘½ä»¤è¡Œç•Œé¢ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    dotnet new blazorwasm -o blazorWasmWebApp
    cd blazorWasmWebApp
    dotnet run

è‹¥è¦è·å¾— Blazor WebAssembly PWA ä½“éªŒï¼Œè¯·åœ¨å‘½ä»¤è¡Œç•Œé¢ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    dotnet new blazorwasm -o MyNewProject --pwa


æ¸è¿›å¼ Web åº”ç”¨ (PWA) æ˜¯ä¸€ç§å•é¡µåº”ç”¨ç¨‹åº (SPA)ï¼Œå®ƒä½¿ç”¨æ–°å¼æµè§ˆå™¨ API å’ŒåŠŸèƒ½ä»¥è¡¨ç°å¾—å¦‚æ¡Œé¢åº”ç”¨ã€‚ Blazor WebAssembly æ˜¯åŸºäºæ ‡å‡†çš„å®¢æˆ·ç«¯ Web åº”ç”¨å¹³å°ï¼Œå› æ­¤å®ƒå¯ä»¥ä½¿ç”¨ä»»ä½•æµè§ˆå™¨ APIï¼ŒåŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½æ‰€éœ€çš„ PWA APIï¼š

- è„±æœºå·¥ä½œå¹¶å³æ—¶åŠ è½½ï¼ˆä¸å—ç½‘ç»œé€Ÿåº¦å½±å“ï¼‰ã€‚
- åœ¨è‡ªå·±çš„åº”ç”¨çª—å£ä¸­è¿è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨æµè§ˆå™¨çª—å£ä¸­è¿è¡Œã€‚
- ä»ä¸»æœºæ“ä½œç³»ç»Ÿçš„å¼€å§‹èœå•ã€æ‰©å±•åæˆ–ä¸»å±å¹•å¯åŠ¨ã€‚
- ä»åç«¯æœåŠ¡å™¨æ¥æ”¶æ¨é€é€šçŸ¥ï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰åœ¨ä½¿ç”¨è¯¥åº”ç”¨ã€‚
- åœ¨åå°è‡ªåŠ¨æ›´æ–°ã€‚

ä½¿ç”¨æ¸è¿›å¼ä¸€è¯æ¥æè¿°æ­¤ç±»åº”ç”¨çš„åŸå› å¦‚ä¸‹ ï¼š

- ç”¨æˆ·å¯èƒ½å…ˆæ˜¯åœ¨å…¶ç½‘ç»œæµè§ˆå™¨ä¸­å‘ç°åº”ç”¨å¹¶ä½¿ç”¨å®ƒï¼Œå°±åƒä»»ä½•å…¶ä»–å•é¡µåº”ç”¨ç¨‹åºä¸€æ ·ã€‚
- è¿‡äº†ä¸€æ®µæ—¶é—´åï¼Œç”¨æˆ·è¿›è€Œå°†å…¶å®‰è£…åˆ°æ“ä½œç³»ç»Ÿä¸­å¹¶å¯ç”¨æ¨é€é€šçŸ¥ã€‚

è®¿é—®ä½¿ç”¨ PWA æ¨¡æ¿åˆ›å»ºçš„åº”ç”¨æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©å°†åº”ç”¨å®‰è£…åˆ°å…¶ OS çš„å¼€å§‹èœå•ã€æ‰©å±•åæˆ–ä¸»å±å¹•ã€‚ æ­¤é€‰é¡¹çš„æ˜¾ç¤ºæ–¹å¼å–å†³äºç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå’Œåº”ç”¨éƒ¨ä»¶æ¸…å• (manifest) è®¾ç½®ã€‚ ä½¿ç”¨åŸºäºæ¡Œé¢ Chromium çš„æµè§ˆå™¨ï¼ˆå¦‚ Edge æˆ– Chromeï¼‰æ—¶ï¼ŒURL æ ä¸­ä¼šå‡ºç°æ·»åŠ æŒ‰é’® ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ PWA æ¨¡æ¿é€‰é¡¹åˆ›å»ºçš„åº”ç”¨æ”¯æŒè„±æœºè¿è¡Œã€‚ ç”¨æˆ·é¦–æ¬¡è®¿é—®è¯¥åº”ç”¨æ—¶éœ€è¦è”æœºè®¿é—®ã€‚ æµè§ˆå™¨ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶ç¼“å­˜è„±æœºæ“ä½œæ‰€éœ€çš„æ‰€æœ‰èµ„æºã€‚


Blazor Server ä¸ Blazor WebAssembly è¿™ä¸¤ä¸ª Blazor æ‰˜ç®¡æ¨¡å‹åº”ç”¨çš„ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«ï¼Œåœ¨äºæœåŠ¡ä¼ é€çš„æ•°æ®é€šè¿‡ SignalR å³ WebSocket ä¼ è¾“ï¼ŒåŒ…æ‹¬ UI çš„æ›´æ–°ã€‚å¯ä»¥çœ‹ä½œæ˜¯ ASP.NET Core SignalR å’Œ Blazor WebAssembly çš„ç»“åˆã€‚

é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Blazor WebAssembly é¢„è§ˆç‰ˆæ¨¡æ¿ï¼š

    dotnet new -i Microsoft.AspNetCore.Components.WebAssembly.Templates::3.2.0-rc1.20223.4


Blazor æ˜¯ä¸€ç§ Web æ¡†æ¶ï¼Œä¸“ç”¨äºåœ¨åŸºäº WebAssembly çš„ .NET è¿è¡Œæ—¶ (Blazor WebAssembly) ä¸Šçš„æµè§ˆå™¨ä¸­è¿è¡Œå®¢æˆ·ç«¯ï¼Œæˆ–åœ¨ ASP.NET Coreï¼ˆBlazor æœåŠ¡å™¨ï¼‰ä¸­è¿è¡ŒæœåŠ¡å™¨ç«¯ ã€‚ å¯¹äºä»»æ„æ‰˜ç®¡æ¨¡å‹ï¼Œåº”ç”¨å’Œç»„ä»¶æ¨¡å‹éƒ½ç›¸åŒ ã€‚

Blazor WebAssembly æ¨¡æ¿åŒ…æ‹¬ blazor.webassembly.js è„šæœ¬ï¼Œå¯å¤„ç†ä»¥ä¸‹ä»»åŠ¡ï¼š

- ä¸‹è½½ .NET è¿è¡Œæ—¶ã€åº”ç”¨å’Œåº”ç”¨ä¾èµ–é¡¹ã€‚
- åˆå§‹åŒ–è¿è¡Œåº”ç”¨çš„è¿è¡Œæ—¶ã€‚

Blazor WebAssembly æ‰˜ç®¡æ¨¡å‹å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- æ²¡æœ‰ .NET æœåŠ¡å™¨ç«¯ä¾èµ–é¡¹ã€‚ åº”ç”¨ä¸‹è½½åˆ°å®¢æˆ·ç«¯åå³å¯æ­£å¸¸è¿è¡Œã€‚
- å¯å……åˆ†åˆ©ç”¨å®¢æˆ·ç«¯èµ„æºå’ŒåŠŸèƒ½ã€‚
- å·¥ä½œå¯ä»æœåŠ¡å™¨è½¬ç§»åˆ°å®¢æˆ·ç«¯ã€‚
- æ— éœ€ ASP.NET Core Web æœåŠ¡å™¨å³å¯æ‰˜ç®¡åº”ç”¨ã€‚ æ— æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆå¯è¡Œï¼ˆä¾‹å¦‚é€šè¿‡ CDN ä¸ºåº”ç”¨æä¾›æœåŠ¡çš„æ–¹æ¡ˆï¼‰ã€‚

Blazor WebAssembly æ‰˜ç®¡å…·æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š

- åº”ç”¨ä»…å¯ä½¿ç”¨æµè§ˆå™¨åŠŸèƒ½ã€‚
- éœ€è¦å¯ç”¨çš„å®¢æˆ·ç«¯ç¡¬ä»¶å’Œè½¯ä»¶ï¼ˆä¾‹å¦‚ WebAssembly æ”¯æŒï¼‰ã€‚
- ä¸‹è½½é¡¹å¤§å°è¾ƒå¤§ï¼Œåº”ç”¨åŠ è½½è€—æ—¶è¾ƒé•¿ã€‚
- .NET è¿è¡Œæ—¶å’Œå·¥å…·æ”¯æŒä¸å¤Ÿå®Œå–„ã€‚ ä¾‹å¦‚ï¼Œ.NET Standard æ”¯æŒå’Œè°ƒè¯•æ–¹é¢å­˜åœ¨é™åˆ¶ã€‚


Blazor Server æ‰˜ç®¡æ¨¡å‹å¯ä» ASP.NET Core åº”ç”¨ä¸­åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œåº”ç”¨ã€‚ UI æ›´æ–°ã€äº‹ä»¶å¤„ç†å’Œ JavaScript è°ƒç”¨æ˜¯é€šè¿‡ SignalR è¿æ¥è¿›è¡Œå¤„ç†ã€‚æµè§ˆå™¨é€šè¿‡ SignalR å®ç°çš„ WebSocket è¿æ¥ä¸æœåŠ¡å™¨ä¸Šçš„åº”ç”¨è¿›è¡Œäº¤äº’ï¼Œè¯¥åº”ç”¨æ‰˜ç®¡åœ¨ ASP.NET Core åº”ç”¨å†…éƒ¨ã€‚ASP.NET Core åº”ç”¨ä¼šæ‰˜ç®¡ Blazor æœåŠ¡å™¨åº”ç”¨ï¼Œå¹¶åœ¨è¿æ¥å®¢æˆ·ç«¯çš„ä½ç½®åˆ›å»º SignalR ç»ˆç»“ç‚¹ã€‚

ASP.NET Core åº”ç”¨ä¼šå¼•ç”¨åº”ç”¨çš„ Startup ç±»ä»¥æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

- æœåŠ¡å™¨ç«¯æœåŠ¡ã€‚
- ç”¨äºè¯·æ±‚å¤„ç†ç®¡é“çš„åº”ç”¨ã€‚
- blazor.server.js è„šæœ¬ä¼šå»ºç«‹å®¢æˆ·ç«¯è¿æ¥ã€‚ åº”ç”¨è´Ÿè´£æ ¹æ®éœ€è¦ä¿å­˜å’Œè¿˜åŸåº”ç”¨çŠ¶æ€ï¼ˆä¾‹å¦‚åœ¨ç½‘ç»œè¿æ¥ä¸¢å¤±æ—¶ï¼‰ã€‚ - blazor.server.js è„šæœ¬ç”± ASP.NET Core å…±äº«æ¡†æ¶ä¸­çš„åµŒå…¥èµ„æºæä¾›ã€‚

Blazor Server æ‰˜ç®¡æ¨¡å‹å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- ä¸‹è½½é¡¹å¤§å°æ˜æ˜¾å°äº Blazor WebAssembly åº”ç”¨ï¼Œä¸”åº”ç”¨åŠ è½½é€Ÿåº¦å¿«å¾—å¤šã€‚
- åº”ç”¨å¯å……åˆ†åˆ©ç”¨æœåŠ¡å™¨åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½¿ç”¨ä»»ä½•ä¸ .NET Core å…¼å®¹çš„ APIã€‚
- æœåŠ¡å™¨ä¸Šçš„ .NET Core ç”¨äºè¿è¡Œåº”ç”¨ï¼Œå› æ­¤è°ƒè¯•ç­‰ç°æœ‰ .NET å·¥å…·å¯æŒ‰é¢„æœŸæ­£å¸¸å·¥ä½œã€‚
- æ”¯æŒç˜¦å®¢æˆ·ç«¯ã€‚ ä¾‹å¦‚ï¼ŒBlazor æœåŠ¡å™¨åº”ç”¨é€‚ç”¨äºä¸æ”¯æŒ WebAssembly çš„æµè§ˆå™¨ä»¥åŠèµ„æºå—é™çš„è®¾å¤‡ã€‚
- åº”ç”¨çš„ .NET/C# ä»£ç åº“ï¼ˆå…¶ä¸­åŒ…æ‹¬åº”ç”¨çš„ç»„ä»¶ä»£ç ï¼‰ä¸é€‚ç”¨äºå®¢æˆ·ç«¯ã€‚

Blazor æœåŠ¡å™¨æ‰˜ç®¡å…·æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š

- é€šå¸¸å»¶è¿Ÿè¾ƒé«˜ã€‚ æ¯æ¬¡ç”¨æˆ·äº¤äº’éƒ½æ¶‰åŠåˆ°ç½‘ç»œè·ƒç‚¹ã€‚
- ä¸æ”¯æŒè„±æœºå·¥ä½œã€‚ å¦‚æœå®¢æˆ·ç«¯è¿æ¥å¤±è´¥ï¼Œåº”ç”¨ä¼šåœæ­¢å·¥ä½œã€‚
- å¦‚æœå…·æœ‰å¤šåç”¨æˆ·ï¼Œåˆ™åº”ç”¨æ‰©ç¼©æ€§å­˜åœ¨æŒ‘æˆ˜ã€‚ æœåŠ¡å™¨å¿…é¡»ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥å¹¶å¤„ç†å®¢æˆ·ç«¯çŠ¶æ€ã€‚
- éœ€è¦ ASP.NET Core æœåŠ¡å™¨ä¸ºåº”ç”¨æä¾›æœåŠ¡ã€‚ æ— æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆä¸å¯è¡Œï¼ˆä¾‹å¦‚é€šè¿‡ CDN ä¸ºåº”ç”¨æä¾›æœåŠ¡çš„æ–¹æ¡ˆï¼‰ã€‚

ç†è§£ Blazor æœåŠ¡å™¨åº”ç”¨çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œäº†è§£å…¶ä¸ä½¿ç”¨ Razor è§†å›¾æˆ– Razor Pages åœ¨ ASP.NET Core åº”ç”¨ä¸­å‘ˆç° UI çš„æƒ¯ç”¨æ¨¡å‹ä¹‹é—´çš„å·®å¼‚ã€‚ è¿™ä¸¤ç§æ¨¡å‹éƒ½ä½¿ç”¨ Razor è¯­è¨€æè¿° HTML å†…å®¹ï¼Œä½†ä¸¤è€…åœ¨æ ‡è®°çš„å‘ˆç°æ–¹å¼ä¸Šå·®åˆ«æ˜¾è‘—ã€‚

å‘ˆç° Razor é¡µé¢æˆ–è§†å›¾æ—¶ï¼Œæ¯è¡Œ Razor ä»£ç éƒ½ä»¥æ–‡æœ¬å½¢å¼å‘å‡º HTMLã€‚ å‘ˆç°åï¼ŒæœåŠ¡å™¨ä¼šä¸¢å¼ƒé¡µé¢æˆ–è§†å›¾å®ä¾‹ï¼ŒåŒ…æ‹¬ç”Ÿæˆçš„ä»»ä½•çŠ¶æ€ã€‚ å‡ºç°å¦ä¸€ä¸ªå¯¹è¯¥é¡µé¢çš„è¯·æ±‚æ—¶ï¼Œä¾‹å¦‚ï¼ŒæœåŠ¡å™¨éªŒè¯å¤±è´¥å¹¶æ˜¾ç¤ºéªŒè¯æ‘˜è¦æ—¶ï¼š

- æ•´ä¸ªé¡µé¢å°†å†æ¬¡é‡æ–°å‘ˆç°ä¸º HTML æ–‡æœ¬ã€‚
- é¡µé¢ä¼šå‘é€åˆ°å®¢æˆ·ç«¯ã€‚

Blazor åº”ç”¨ç”± UI çš„å¯é‡ç”¨å…ƒç´ ç»„æˆï¼Œè¿™äº›å…ƒç´ ç§°ä¸ºç»„ä»¶ ã€‚ ç»„ä»¶åŒ…å« C# ä»£ç ã€æ ‡è®°å’Œå…¶ä»–æˆåˆ†ã€‚ å‘ˆç°ç»„ä»¶æ—¶ï¼ŒBlazor ä¼šç”Ÿæˆæ‰€å«ç»„ä»¶çš„å›¾ï¼Œç±»ä¼¼äº HTML æˆ– XML æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)ã€‚ æ­¤å›¾åŒ…å«å±æ€§å’Œå­—æ®µä¸­ä¿å­˜çš„ç»„ä»¶çŠ¶æ€ã€‚ Blazor ä¼šè¯„ä¼°ç»„ä»¶å›¾ï¼Œç”ŸæˆäºŒè¿›åˆ¶å½¢å¼çš„æ ‡è®°ã€‚ äºŒè¿›åˆ¶æ ¼å¼å¯ä»¥è½¬æ¢ä¸º HTML æ–‡æœ¬ï¼Œå¯ç”¨äºåœ¨å®šæœŸå‘ˆç°æœŸé—´é«˜æ•ˆæ›´æ–°æ ‡è®°ã€‚

é¢„å‘ˆç° Prerendering ä¼šä½¿åº”ç”¨å¯¹ç”¨æˆ·çš„å“åº”æ›´åŠ è¿…é€Ÿã€‚åº”ç”¨è¯·æ±‚çš„ Razor ç»„ä»¶åœ¨æœåŠ¡å™¨ä¸Šç¼–è¯‘ä¸ºé™æ€ HTMLï¼Œç„¶åå‘é€åˆ°å®¢æˆ·ç«¯å¹¶å‘ˆç°ç»™ç”¨æˆ·ã€‚ å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´å»ºç«‹è¿æ¥åï¼Œç»„ä»¶çš„é™æ€é¢„å‘ˆç°å…ƒç´ ä¼šæ›¿æ¢ä¸ºäº¤äº’å¼å…ƒç´ ã€‚ 

Blazor ä¸­çš„ UI æ›´æ–°ç”±ä»¥ä¸‹å†…å®¹è§¦å‘ï¼š

- ç”¨æˆ·äº¤äº’ï¼Œä¾‹å¦‚é€‰ä¸­æŒ‰é’®ã€‚
- åº”ç”¨è§¦å‘å™¨ï¼Œä¾‹å¦‚è®¡æ—¶å™¨ã€‚

è§†å›¾å‘ˆç°éœ€è¦ç»è¿‡ UI diffï¼ˆå·®å¼‚ï¼‰è®¡ç®—ï¼Œå·®å¼‚æ˜¯æ›´æ–°å®¢æˆ·ç«¯ä¸Šçš„ UI æ‰€éœ€çš„æœ€å°ä¸€ç»„ DOM ä¿®æ”¹ã€‚ å·®å¼‚ä»¥äºŒè¿›åˆ¶æ ¼å¼å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œå¹¶ç”±æµè§ˆå™¨åº”ç”¨ã€‚

ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä¸Šé€€å‡ºç»„ä»¶ä¹‹åï¼Œç»„ä»¶ä¼šè¢«ä¸¢å¼ƒã€‚ ç”¨æˆ·ä¸ç»„ä»¶äº¤äº’æ—¶ï¼Œç»„ä»¶çš„çŠ¶æ€ï¼ˆæœåŠ¡ã€èµ„æºï¼‰å¿…é¡»ä¿å­˜åœ¨æœåŠ¡å™¨çš„å†…å­˜ä¸­ã€‚ ç”±äºæœåŠ¡å™¨å¯èƒ½åŒæ—¶ä¿å­˜å¤šä¸ªç»„ä»¶çš„çŠ¶æ€ï¼Œå› æ­¤å¿…é¡»è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜ã€‚

Blazor Server apps é‡‡ç”¨æœ‰çŠ¶æ€æ•°æ®å¤„ç†æ¨¡å‹ï¼Œå…¶ä¸­æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¿æŒé•¿æœŸçš„å…³ç³»ã€‚ æŒä¹…çŠ¶æ€ç”±çº¿è·¯ç»´æŠ¤ï¼Œçº¿è·¯å¯ä»¥è·¨ä¹Ÿå¯èƒ½é•¿æœŸç”Ÿå­˜æœŸçš„è¿æ¥ã€‚

å½“ç”¨æˆ·è®¿é—® Blazor æœåŠ¡å™¨ç«™ç‚¹æ—¶ï¼ŒæœåŠ¡å™¨å°†åœ¨æœåŠ¡å™¨çš„å†…å­˜ä¸­åˆ›å»ºçº¿è·¯ã€‚ çº¿è·¯å‘æµè§ˆå™¨æŒ‡ç¤ºè¦å‘ˆç°çš„å†…å®¹å¹¶å“åº”äº‹ä»¶ï¼Œä¾‹å¦‚å½“ç”¨æˆ·åœ¨ UI ä¸­é€‰æ‹©ä¸€ä¸ªæŒ‰é’®æ—¶ã€‚ è‹¥è¦æ‰§è¡Œè¿™äº›æ“ä½œï¼Œçº¿è·¯ä¼šåœ¨ç”¨æˆ·çš„æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¸Šçš„ .NET æ–¹æ³•ä¸­è°ƒç”¨ JavaScript å‡½æ•°ã€‚ è¿™ç§åŸºäº JavaScript çš„åŒå‘äº¤äº’ç§°ä¸ºjavascript äº’æ“ä½œï¼ˆJS äº’æ“ä½œï¼‰ã€‚

ç”±äºåœ¨ Internet ä¸Šè¿›è¡Œ JS äº’æ“ä½œï¼Œå¹¶ä¸”å®¢æˆ·ç«¯ä½¿ç”¨è¿œç¨‹æµè§ˆå™¨ï¼ŒBlazor Server apps å…±äº«å¤§å¤šæ•° web åº”ç”¨å®‰å…¨é—®é¢˜ã€‚


## ==âš¡ Blazor é¡¹ç›®ç»“æ„

Blazor é¡¹ç›®æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ„æˆäº†åŸºäº Blazor æ¨¡æ¿ç”Ÿæˆçš„ Blazor åº”ç”¨ï¼š

- Program.cs æ˜¯åº”ç”¨çš„å…¥å£ç‚¹

    è®¾ç½® ASP.NET Core ä¸»æœº Blazor Server æˆ– Blazor WebAssembly ä¸»æœºã€‚

    è¯¥æ–‡ä»¶ä¸­çš„ä»£ç å¯¹äºé€šè¿‡ Blazor WebAssembly æ¨¡æ¿åˆ›å»ºçš„åº”ç”¨æ˜¯å”¯ä¸€çš„ï¼Œä¸å« Startupã€‚æ ¹ç»„ä»¶ App.razor è¢«æŒ‡å®šä¸º Add æ–¹æ³•çš„ app DOM å…ƒç´ ã€‚

- Startup.cs åŒ…å« Blazor Server åº”ç”¨çš„å¯åŠ¨é€»è¾‘

    Startup ç±»å®šä¹‰ä¸¤ä¸ªæ–¹æ³•ï¼ŒConfigureServices é…ç½®åº”ç”¨çš„ ä¾èµ–é¡¹æ³¨å…¥ (DI) æœåŠ¡ã€‚ åœ¨ Blazor Server åº”ç”¨ä¸­ï¼Œé€šè¿‡è°ƒç”¨ AddServerSideBlazor æ·»åŠ æœåŠ¡ã€‚

    å¦ä¸€ä¸ªæ–¹æ³• Configure é…ç½®åº”ç”¨çš„è¯·æ±‚å¤„ç†ç®¡é“ï¼Œè°ƒç”¨ MapBlazorHub å¯ä»¥ä¸ºä¸æµè§ˆå™¨çš„å®æ—¶è¿æ¥è®¾ç½®ç»ˆç»“ç‚¹ã€‚ ä½¿ç”¨ SignalR åˆ›å»ºè¿æ¥ï¼Œè¯¥æ¡†æ¶ç”¨äºå‘åº”ç”¨æ·»åŠ å®æ—¶ Web åŠŸèƒ½ã€‚è°ƒç”¨ `MapFallbackToPage("_Host")` ä»¥è®¾ç½®åº”ç”¨çš„æ ¹é¡µé¢ï¼Œ`Pages/_Host.cshtml` ï¼Œå®ƒæŒ‡å®šæ ¹ App ç»„ä»¶ (App.razor) çš„å‘ˆç°ä½ç½®å¹¶å¯ç”¨å¯¼èˆªã€‚æ ¹é¡µé¢åŠ è½½ `blazor.server.js` JavaScript æ–‡ä»¶ï¼Œç”¨äºåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹å®æ—¶ SignalR è¿æ¥ã€‚

- wwwroot/index.html ä¸º Blazor WebAssembly é¡¹ç›®çš„ HTML æ ¹é¡µé¢

    æœ€åˆè¯·æ±‚åº”ç”¨çš„ä»»ä½•é¡µé¢æ—¶ï¼Œéƒ½ä¼šå‘ˆç°æ­¤é¡µé¢å¹¶åœ¨å“åº”ä¸­è¿”å›ï¼Œæ­¤é¡µé¢æŒ‡å®šæ ¹ App ç»„ä»¶çš„å‘ˆç°ä½ç½®ã€‚ App ç»„ä»¶ (App.razor) åœ¨ Startup.Configure ä¸­æŒ‡å®šä¸º AddComponent æ–¹æ³•çš„ app DOM å…ƒç´ ã€‚

    æ­¤é¡µé¢ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½æ˜¯åŠ è½½ `blazor.webassembly.js` JavaScript æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨äºä¸‹è½½ .NET è¿è¡Œæ—¶ã€åº”ç”¨å’Œåº”ç”¨ä¾èµ–é¡¹ï¼Œåˆå§‹åŒ–è¿è¡Œæ—¶ä»¥è¿è¡Œåº”ç”¨ã€‚

- `App.razor` åº”ç”¨çš„ app æ ¹ç»„ä»¶

    å®ƒä½¿ç”¨ Router ç»„ä»¶è®¾ç½®å®¢æˆ·ç«¯è·¯ç”±ï¼Œè·¯ç”±ç»„ä»¶ä¼šæˆªè·æµè§ˆå™¨å¯¼èˆªå¹¶å‘ˆç°ä¸è¯·æ±‚çš„åœ°å€åŒ¹é…çš„é¡µé¢ã€‚åœ¨è·¯ç”±è§†å›¾ RouteView æˆ– LayoutView è®¾ç½®äº†é»˜è®¤çš„å¸ƒå±€ç»„ä»¶ `Shared/MainLayout.razor`ï¼Œå¸ƒå±€ç»„ä»¶é…ç½®äº†é¡µé¢çš„åŸºæœ¬éª¨æ¶ï¼Œä¸»è¦æ˜¯å¯¼èˆªèœå• `NavMenu.razor`ã€‚

- Pages æ–‡ä»¶å¤¹

    åŒ…å«æ„æˆ Blazor åº”ç”¨çš„å¯è·¯ç”±ç»„ä»¶/é¡µé¢ (.razor) å’Œ Blazor Server åº”ç”¨çš„æ ¹ Razor é¡µé¢ã€‚ æ¯ä¸ªé¡µé¢çš„è·¯ç”±éƒ½æ˜¯ä½¿ç”¨ @page æŒ‡ä»¤æŒ‡å®šçš„ã€‚ 

- Shared æ–‡ä»¶å¤¹

    åŒ…å«åº”ç”¨ä½¿ç”¨çš„å…¶ä»– UI ç»„ä»¶ ( .razor)ï¼ŒMainLayout (MainLayout.razor) ä¸ºåº”ç”¨çš„å¸ƒå±€ç»„ä»¶ã€‚NavMenu (NavMenu.razor) å®ç°ä¾§æ å¯¼èˆªã€‚ åŒ…æ‹¬ NavLink ç»„ä»¶ (NavLink)ï¼Œè¯¥ç»„ä»¶å¯å‘å…¶ä»– Razor ç»„ä»¶å‘ˆç°å¯¼èˆªé“¾æ¥ã€‚ NavLink ç»„ä»¶ä¼šåœ¨ç³»ç»ŸåŠ è½½å…¶ç»„ä»¶æ—¶è‡ªåŠ¨æŒ‡ç¤ºé€‰å®šçŠ¶æ€ï¼Œè¿™æœ‰åŠ©äºç”¨æˆ·äº†è§£å½“å‰æ˜¾ç¤ºçš„ç»„ä»¶ã€‚

    Razor Page æˆ– ASP.Net Core MVC é¡¹ç›®çš„ Shared ç›®å½•åœ¨ Views æˆ– Pages ç›®å½•ä¸‹ã€‚

- `_Imports.razor` åŒ…æ‹¬è¦åŒ…å«åœ¨åº”ç”¨ç»„ä»¶ (.razor) ä¸­çš„å¸¸è§ Razor æŒ‡ä»¤ï¼Œä¾‹å¦‚ç”¨äºå‘½åç©ºé—´çš„ @using æŒ‡ä»¤ ã€‚

- Data æ–‡ä»¶å¤¹åŒ…å« Blazor Server é¡¹ç›®ä½¿ç”¨çš„ WeatherForecast ç±»å’Œ WeatherForecastService çš„å®ç°ï¼Œå®ƒä»¬å‘åº”ç”¨çš„ FetchData ç»„ä»¶æä¾›ç¤ºä¾‹å¤©æ°”æ•°æ®æœåŠ¡ã€‚

- wwwroot åº”ç”¨çš„ Web æ ¹ç›®å½•æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«åº”ç”¨çš„å…¬å…±é™æ€èµ„æºã€‚
- appsettings.json ä¸º Blazor Server åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œä¿å­˜æ•°æ®è¿æ¥ä¿¡æ¯ã€‚


Blazor Server å…¥å£ Program.csï¼š

    using System;
    using System.Collections.Generic;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore;
    using Microsoft.AspNetCore.Hosting;
    using Microsoft.Extensions.Configuration;
    using Microsoft.Extensions.Hosting;
    using Microsoft.Extensions.Logging;

    namespace blazorServerWebApp
    {
        public class Program
        {
            public static void Main(string[] args)
            {
                CreateHostBuilder(args).Build().Run();
            }

            public static IHostBuilder CreateHostBuilder(string[] args) =>
                Host.CreateDefaultBuilder(args)
                    .ConfigureWebHostDefaults(webBuilder =>
                    {
                        webBuilder.UseStartup<Startup>();
                    });
        }
    }

Blazor WebAssembly åªå…¥å£ Program.cs æ²¡æœ‰ Startup é…ç½®ï¼Œä¸»è¦å·®åˆ«åœ¨ä½¿ç”¨ Host ç±»å‹æ˜¯ WebAssemblyHostï¼š

    using System;
    using System.Net.Http;
    using System.Collections.Generic;
    using System.Threading.Tasks;
    using System.Text;
    using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
    using Microsoft.Extensions.Configuration;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Logging;

    namespace blazorWasmWebApp
    {
        public class Program
        {
            public static async Task Main(string[] args)
            {
                var builder = WebAssemblyHostBuilder.CreateDefault(args);
                builder.RootComponents.Add<App>("app");

                builder.Services.AddTransient(sp => new HttpClient { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });

                await builder.Build().RunAsync();
            }
        }
    }

Blazor Server å’Œ Razor Page é¡¹ç›®çš„å·®åˆ«åœ¨ Statups.cs ä¸­çš„é…ç½®ä¸­è°ƒç”¨ `AddServerSideBlazor()` å’Œ `MapBlazorHub()`ï¼Œ`MapFallbackToPage("/_Host")`ï¼Œå¼•ç”¨äº† Microsoft.AspNetCore.Componentsï¼š

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Builder;
    using Microsoft.AspNetCore.Components;
    using Microsoft.AspNetCore.Hosting;
    using Microsoft.AspNetCore.HttpsPolicy;
    using Microsoft.Extensions.Configuration;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Hosting;
    using blazorServerWebApp.Data;

    namespace blazorServerWebApp
    {
        public class Startup
        {
            public Startup(IConfiguration configuration)
            {
                Configuration = configuration;
            }

            public IConfiguration Configuration { get; }

            // This method gets called by the runtime. Use this method to add services to the container.
            // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940
            public void ConfigureServices(IServiceCollection services)
            {
                services.AddRazorPages();  // for Razor Page
                services.AddServerSideBlazor();
                services.AddSingleton<WeatherForecastService>();
            }

            // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
            public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
            {
                if (env.IsDevelopment())
                {
                    app.UseDeveloperExceptionPage();
                }
                else
                {
                    app.UseExceptionHandler("/Error");
                    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
                    app.UseHsts();
                }

                app.UseHttpsRedirection();
                app.UseStaticFiles();

                app.UseRouting();

                app.UseEndpoints(endpoints =>
                {
                    endpoints.MapRazorPages();  // for Razor Page
                    endpoints.MapBlazorHub();
                    endpoints.MapFallbackToPage("/_Host");
                });
            }
        }
    }


æ ¹é¡µé¢ `Pages/_Host.cshtml`:

    @page "/"
    @namespace blazorServerWebApp.Pages
    @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
    @{
        Layout = null;
    }

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>blazorServerWebApp</title>
        <base href="~/" />
        <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
        <link href="css/site.css" rel="stylesheet" />
    </head>
    <body>
        <app>
            <component type="typeof(App)" render-mode="ServerPrerendered" />
        </app>

        <div id="blazor-error-ui">
            <environment include="Staging,Production">
                An error has occurred. This application may no longer respond until reloaded.
            </environment>
            <environment include="Development">
                An unhandled exception has occurred. See browser dev tools for details.
            </environment>
            <a href="" class="reload">Reload</a>
            <a class="dismiss">ğŸ—™</a>
        </div>

        <script src="_framework/blazor.server.js"></script>
    </body>
    </html>


æ ¹ç»„ä»¶ `App.razor`:

    <Router AppAssembly="@typeof(Program).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
        </Found>
        <NotFound>
            <LayoutView Layout="@typeof(MainLayout)">
                <p>Sorry, there's nothing at this address.</p>
            </LayoutView>
        </NotFound>
    </Router>


Blazor Server å’Œ Razor Page ç¨‹åºæœ‰ä¸€è‡´çš„å…¥å£ Program.csã€‚ Blazor Server çš„ç¨‹åºç»“æ„å’Œæ™®é€šçš„ ASP.NET Core Web App ç»“æ„å¾ˆç›¸ä¼¼ï¼Œé…ç½®å¥½åï¼ŒäºŒè€…å¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­å¹¶å­˜ã€‚æ³¨æ„ï¼ŒRazor ç»„ä»¶éœ€è¦åœ¨ Blazor ä¸­è§£æï¼Œä¸èƒ½åœ¨ Razor Page ä½¿ç”¨ Razor ç»„ä»¶ï¼Œè¿™çœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚

äºŒè€…å¹¶å­˜é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯è·¯ç”±è®¾ç½®ï¼ŒäºŒè€…é»˜è®¤çš„é¦–é¡µä¸åŒï¼Œåœ¨è®¿é—®æ—¶å°±æœ‰åŒä¸€ä¸ªè·¯ç”±å¯¹åº”å¤šä¸ªè§†å›¾çš„å†²çªï¼š

- `Pages/_Host.cshtml` Blazor Home
- `Pages/Index.cshtml` Razor Page Home

æˆ–ç»™ Index.cshtml æ”¹åï¼Œæˆ–è€…ä¿®æ”¹ `Pages/_Host.cshtml` çš„ @page "/" æŒ‡ä»¤ï¼Œä¸ä½¿ç”¨ä¸»é¡µçš„è·¯ç”±åŒ¹é…ã€‚


## ==âš¡ Razor Component ç»„ä»¶ 
https://docs.microsoft.com/zh-cn/aspnet/core/blazor/lifecycle?view=aspnetcore-3.1

Razor Component æˆ– Page å¯ä»¥é€šè¿‡å‘½ä»¤ç”Ÿæˆæ¨¡æ¿ï¼Œ-na ç»™ Razor Page æŒ‡å®šå‘½åç©ºé—´ï¼š

    dotnet new razorcomponent -o=. -n="View"
    dotnet new page -o=. -na="Razor.Pages" -n="Home"

Razor ç»„ä»¶å®ä¾‹ Counter.razorï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼ Vue çš„å•æ–‡ä»¶ç»„ä»¶çš„å®ç°ï¼Œå¯ä»¥åœ¨å…¶å®ƒç»„ä»¶ä¸­ä½¿ç”¨ï¼Œåƒè¿™æ · `<Counter />`ï¼š

    @page "/counter"

    <h1>Counter</h1>

    <p>Current count: @currentCount</p>

    <button class="btn btn-primary" @onclick="IncrementCount">Click me</button>

    @code {
        private int currentCount = 0;

        [Parameter]
        public int IncrementAmount { get; set; } = 1;

        private void IncrementCount()
        {
            currentCount += IncrementAmount;
        }
    }

- æ·»åŠ äº†ä¸€ä¸ªå…¬å…±å±æ€§ IncrementAmount å¹¶ç›¸è®¾ç½® [Parameter] ç‰¹æ€§ã€‚
- æˆå‘˜ IncrementCount æ–¹æ³•å¢åŠ  currentCount çš„å€¼ã€‚
- å®šä¹‰ Parameter å…¬å…±å±æ€§å¯ä»¥è¿™æ ·ä½¿ç”¨ `<Counter IncrementAmount="2" />`ã€‚
- @currentCount æˆ– @onclick ç”¨æ¥ç»‘å®šå±æ€§æ•°æ®åˆ°è§†å›¾ï¼Œç»‘å®šäº‹ä»¶åˆ°ç»„ä»¶ã€‚

ä½¿ç”¨ HTML å®šä¹‰ Counter ç»„ä»¶çš„ UIï¼ŒåŠ¨æ€å‘ˆç°é€»è¾‘ï¼Œä¾‹å¦‚ï¼Œå¾ªç¯ã€æ¡ä»¶ã€è¡¨è¾¾å¼ï¼Œä½¿ç”¨åä¸º Razor çš„åµŒå…¥å¼ C# è¯­æ³•æ·»åŠ çš„ã€‚ HTML æ ‡è®°å’Œ C# å‘ˆç°é€»è¾‘åœ¨æ„å»ºæ—¶è½¬æ¢ä¸ºç»„ä»¶ç±»ï¼Œç”Ÿæˆçš„ .NET ç±»çš„åç§°ä¸æ–‡ä»¶ååŒ¹é…ã€‚

@code è¡¨ç¤ºç»„ä»¶ç±»æˆå‘˜ä»£ç å—ï¼Œå¯ä»¥æŒ‡å®šç»„ä»¶çŠ¶æ€ï¼Œå±æ€§ã€å­—æ®µï¼Œå’Œæ–¹æ³•ç”¨äºå¤„ç†äº‹ä»¶æˆ–å®šä¹‰å…¶ä»–ç»„ä»¶é€»è¾‘ã€‚ ç„¶åï¼Œå¯ä»¥å°†è¿™äº›æˆå‘˜ç”¨ä½œç»„ä»¶å‘ˆç°é€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç”¨äºå¤„ç†äº‹ä»¶ã€‚

æ–‡ä»¶é¡¶éƒ¨çš„ @page æŒ‡ä»¤æŒ‡å®š Counter ç»„ä»¶æ˜¯è·¯ç”±ç»ˆç»“ç‚¹ï¼ŒCounter ç»„ä»¶å¤„ç†å‘é€åˆ° /counter çš„è¯·æ±‚ã€‚ å¦‚æœæ²¡æœ‰ @page æŒ‡ä»¤ï¼Œç»„ä»¶å°†æ— æ³•å¤„ç†è·¯ç”±çš„è¯·æ±‚ï¼Œä½†è¯¥ç»„ä»¶ä»å¯ä»¥è¢«å…¶ä»–ç»„ä»¶ä½¿ç”¨ã€‚

å•å‡»é€‰ä¸­ buton æŒ‰é’®æ—¶ï¼š

- è°ƒç”¨ Counter ç»„ä»¶çš„å·²æ³¨å†Œ onclick å¤„ç†ç¨‹åº IncrementCount æ–¹æ³•ã€‚
- Counter ç»„ä»¶é‡æ–°ç”Ÿæˆå…¶å‘ˆç°æ ‘ã€‚
- å°†æ–°çš„å‘ˆç°æ ‘ä¸å‰ä¸€ä¸ªå‘ˆç°æ ‘è¿›è¡Œæ¯”è¾ƒã€‚
- ä»…åº”ç”¨å¯¹æ–‡æ¡£å¯¹è±¡æ¨¡å‹ DOM çš„ä¿®æ”¹ã€‚ æ˜¾ç¤ºçš„è®¡æ•°å°†ä¼šæ›´æ–°ã€‚


Razor ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸ React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç±»ä¼¼ï¼Œä¹Ÿåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šåˆå§‹åŒ–é˜¶æ®µã€è¿è¡Œä¸­é˜¶æ®µå’Œé”€æ¯é˜¶æ®µï¼š

Blazor ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸»è¦åŒ…æ‹¬ï¼š

- è®¾ç½®å‚æ•°å‰         SetParametersAsync
- åˆå§‹åŒ–               OnInitialized / OnInitializedAsync
- è®¾ç½®å‚æ•°å         OnParametersSet / OnParametersSetAsync
- ç»„ä»¶æ¸²æŸ“å‘ˆç°å       OnAfterRender / OnAfterRenderAsync
- åˆ¤æ–­æ˜¯å¦æ¸²æŸ“ç»„ä»¶  ShouldRender / ShouldRenderAsync
- ç»„ä»¶åˆ é™¤å‰         Dispose
- é€šçŸ¥ç»„ä»¶çŠ¶æ€å·²æ›´æ”¹ StateHasChanged

åœ¨æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­ï¼Œæœ‰ä»¥ä¸‹éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

- å‰ 5 ç§æ–¹æ³•çš„å£°æ˜éƒ½æ˜¯ virtualï¼Œé™¤ SetParametersAsync ä¸º public å¤–ï¼Œå…¶ä»–çš„éƒ½æ˜¯ protectedã€‚
- OnAfterRender/OnAfterRenderAsync æ–¹æ³•æœ‰ä¸€ä¸ª bool ç±»å‹çš„å½¢å‚ firstRender ç”¨äºæŒ‡ç¤ºæ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ã€‚
- åŒæ­¥æ–¹æ³•æ€»æ˜¯å…ˆäºå¼‚æ­¥æ–¹æ³•æ‰§è¡Œã€‚
- Dispose å‡½æ•°éœ€è¦é€šè¿‡ä½¿ç”¨ @implements æŒ‡ä»¤å®ç° IDisposable æ¥å£æ¥å®ç°ã€‚
- StateHasChanged æ— æ³•è¢«é‡å†™ï¼Œå¯ä»¥è¢«æ˜¾ç¤ºè°ƒç”¨ï¼Œä»¥ä¾¿å¼ºåˆ¶å®ç°ç»„ä»¶åˆ·æ–°ï¼Œå¦‚æœ ShouldRender è¿”å› trueï¼Œå¹¶ä¸” Blazor è®¤ä¸ºéœ€è¦åˆ·æ–°æ—¶ï¼›å½“ç»„ä»¶çŠ¶æ€æ›´æ”¹æ—¶ä¸å¿…æ˜¾ç¤ºè°ƒç”¨æ­¤å‡½æ•°ï¼Œä¹Ÿå¯å¯¼è‡´ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼Œå¦‚æœ ShouldRender è¿”å› trueã€‚å› ä¸ºå…¶å·²ç»åœ¨ ComponentBase å†…éƒ¨çš„å¤„ç†è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–è®¾ç½®å‚æ•°æ—¶ã€è®¾ç½®å‚æ•°åå’Œ DOM äº‹ä»¶å¤„ç†ç­‰ã€‚

åœ¨å‘ˆç°ç»„ä»¶ä¹‹å‰ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­æ‰§è¡Œçš„å¼‚æ­¥æ“ä½œå¯èƒ½å°šæœªå®Œæˆã€‚ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ—¶ï¼Œå¯¹è±¡å¯èƒ½ä¸º null æˆ–æœªå®Œå…¨å¡«å……æ•°æ®ã€‚ æä¾›å‘ˆç°é€»è¾‘ä»¥ç¡®è®¤å¯¹è±¡å·²åˆå§‹åŒ–ã€‚ å¯¹è±¡ä¸º null æ—¶ï¼Œå‘ˆç°å ä½ç¬¦ UI å…ƒç´ ï¼ˆä¾‹å¦‚ï¼ŒåŠ è½½æ¶ˆæ¯ï¼‰ã€‚

åœ¨ Blazor æ¨¡æ¿çš„ FetchData ç»„ä»¶ä¸­ï¼Œæ›¿ä»£ OnInitializedAsync ä»¥å¼‚æ­¥æ¥æ”¶é¢„æµ‹æ•°æ® (forecasts)ã€‚ å½“ forecasts ä¸º null æ—¶ï¼Œå°†å‘ç”¨æˆ·æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯ã€‚ OnInitializedAsync è¿”å›çš„ Task å®Œæˆåï¼Œè¯¥ç»„ä»¶ä»¥æ›´æ–°åçš„çŠ¶æ€é‡æ–°å‘ˆç°ã€‚

å¦‚æœç»„ä»¶å®ç° IDisposableï¼Œåˆ™åœ¨ä» UI ä¸­åˆ é™¤è¯¥ç»„ä»¶æ—¶è°ƒç”¨ Dispose æ–¹æ³•ã€‚ ä»¥ä¸‹ç»„ä»¶ä½¿ç”¨ @implements IDisposable å’Œ Dispose æ–¹æ³•ï¼š

    @using System
    @implements IDisposable

    ...

    @code {

        private EventHandler<FieldChangedEventArgs> fieldChanged;

        protected override void OnInitialized()
        {
            editContext.OnFieldChanged += fieldChanged;
        }

        public void Dispose()
        {
            editContext.OnFieldChanged -= fieldChanged;
            ...
        }
    }

ä¸æ”¯æŒåœ¨ Dispose ä¸­è°ƒç”¨ StateHasChangedã€‚ StateHasChanged å¯èƒ½åœ¨æ‹†é™¤å‘ˆç°å™¨æ—¶è°ƒç”¨ï¼Œå› æ­¤ä¸æ”¯æŒåœ¨æ­¤æ—¶è¯·æ±‚ UI æ›´æ–°ã€‚


åœ¨ Blazor Server åº”ç”¨ä¸­ï¼Œå½“ RenderMode ä¸º ServerPrerendered æ—¶ï¼Œç»„ä»¶æœ€åˆä½œä¸ºé¡µé¢çš„ä¸€éƒ¨åˆ†é™æ€å‘ˆç°ã€‚ æµè§ˆå™¨é‡æ–°å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥åï¼Œå°†å†æ¬¡å‘ˆç°ç»„ä»¶ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶ç°åœ¨ä¸ºäº¤äº’å¼ã€‚ å¦‚æœå­˜åœ¨ç”¨äºåˆå§‹åŒ–ç»„ä»¶çš„ OnInitialized{Async} ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œåˆ™è¯¥æ–¹æ³•æ‰§è¡Œä¸¤æ¬¡ï¼š

- åœ¨é™æ€é¢„å‘ˆç°ç»„ä»¶æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
- åœ¨å»ºç«‹æœåŠ¡å™¨è¿æ¥åæ‰§è¡Œä¸€æ¬¡ã€‚

åœ¨æœ€ç»ˆå‘ˆç°ç»„ä»¶æ—¶ï¼Œè¿™å¯èƒ½å¯¼è‡´ UI ä¸­æ˜¾ç¤ºçš„æ•°æ®å‘ç”Ÿæ˜æ˜¾å˜åŒ–ã€‚è‹¥è¦é¿å… Blazor Server åº”ç”¨ä¸­å‡ºç°åŒé‡å‘ˆç°ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- ä¼ é€’ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œè¯¥æ ‡è¯†ç¬¦å¯ç”¨äºåœ¨é¢„å‘ˆç°æœŸé—´ç¼“å­˜çŠ¶æ€å¹¶åœ¨åº”ç”¨é‡å¯åæ£€ç´¢çŠ¶æ€ã€‚
- åœ¨é¢„å‘ˆç°æœŸé—´ä½¿ç”¨è¯¥æ ‡è¯†ç¬¦ä¿å­˜ç»„ä»¶çŠ¶æ€ã€‚
- é¢„å‘ˆç°åä½¿ç”¨è¯¥æ ‡è¯†ç¬¦æ£€ç´¢ç¼“å­˜çš„çŠ¶æ€ã€‚

ä»¥ä¸‹ä»£ç æ¼”ç¤ºåŸºäºæ¨¡æ¿çš„ Blazor Server åº”ç”¨ä¸­æ›´æ–°åçš„ WeatherForecastServiceï¼Œå…¶é¿å…äº†åŒé‡å‘ˆç°ï¼š

    public class WeatherForecastService
    {
        private static readonly string[] summaries = new[]
        {
            "Freezing", "Bracing", "Chilly", "Cool", "Mild",
            "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
        };
        
        public WeatherForecastService(IMemoryCache memoryCache)
        {
            MemoryCache = memoryCache;
        }
        
        public IMemoryCache MemoryCache { get; }

        public Task<WeatherForecast[]> GetForecastAsync(DateTime startDate)
        {
            return MemoryCache.GetOrCreateAsync(startDate, async e =>
            {
                e.SetOptions(new MemoryCacheEntryOptions
                {
                    AbsoluteExpirationRelativeToNow = 
                        TimeSpan.FromSeconds(30)
                });

                var rng = new Random();

                await Task.Delay(TimeSpan.FromSeconds(10));

                return Enumerable.Range(1, 5).Select(index => new WeatherForecast
                {
                    Date = startDate.AddDays(index),
                    TemperatureC = rng.Next(-20, 55),
                    Summary = summaries[rng.Next(summaries.Length)]
                }).ToArray();
            });
        }
    }



åœ¨ Blazor Server åº”ç”¨è¿›è¡Œé¢„å‘ˆç°æ—¶ï¼Œç”±äºå°šæœªå»ºç«‹ä¸æµè§ˆå™¨çš„è¿æ¥ï¼Œå› æ­¤æ— æ³•æ‰§è¡Œè°ƒç”¨ JavaScript ç­‰ç‰¹å®šæ“ä½œã€‚ é¢„å‘ˆç°æ—¶ï¼Œç»„ä»¶å¯èƒ½éœ€è¦è¿›è¡Œä¸åŒçš„å‘ˆç°ã€‚

è¦å°† JavaScript äº’æ“ä½œè°ƒç”¨å»¶è¿Ÿåˆ°ä¸æµè§ˆå™¨å»ºç«‹è¿æ¥ä¹‹åï¼Œå¯ä½¿ç”¨ OnAfterRenderAsync ç»„ä»¶ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚ ä»…åœ¨å®Œæˆå‘ˆç°åº”ç”¨å¹¶ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥åï¼Œæ‰ä¼šè°ƒç”¨æ­¤äº‹ä»¶ã€‚

    @using Microsoft.JSInterop
    @inject IJSRuntime JSRuntime

    <div @ref="divElement">Text during render</div>

    @code {
        private ElementReference divElement;

        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender)
            {
                await JSRuntime.InvokeVoidAsync(
                    "setElementText", divElement, "Text after render");
            }
        }
    }

å¯¹äºä¸Šè¿°ç¤ºä¾‹ä»£ç ï¼Œè¯·åœ¨è§†å›¾ HEAD å…ƒç´ ä¸­æä¾›ä¸€ä¸ª setElementText JavaScript å‡½æ•° ã€‚ è¯¥å‡½æ•°é€šè¿‡ IJSRuntime.InvokeVoidAsync è¿›è¡Œè°ƒç”¨ï¼Œä¸è¿”å›å€¼ï¼š

    <script>
      window.setElementText = (element, text) => element.innerText = text;
    </script>

è­¦å‘Šï¼Œä¸Šè¿°ç¤ºä¾‹ç›´æ¥ä¿®æ”¹æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)ï¼Œä»¥ä¾¿ä»…ä¾›æ¼”ç¤ºæ‰€ç”¨ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ JavaScript ç›´æ¥ä¿®æ”¹ DOMï¼Œå› ä¸º JavaScript å¯èƒ½ä¼šå¹²æ‰° Blazor çš„æ›´æ”¹è·Ÿè¸ªã€‚

ä»¥ä¸‹ç»„ä»¶å±•ç¤ºäº†å¦‚ä½•ä»¥ä¸€ç§ä¸é¢„å‘ˆç°å…¼å®¹çš„æ–¹å¼å°† JavaScript äº’æ“ä½œç”¨ä½œç»„ä»¶åˆå§‹åŒ–é€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚ è¯¥ç»„ä»¶æ˜¾ç¤ºå¯ä» OnAfterRenderAsync å†…éƒ¨è§¦å‘å‘ˆç°æ›´æ–°ã€‚ å¼€å‘äººå‘˜å¿…é¡»é¿å…åœ¨æ­¤åœºæ™¯ä¸­åˆ›å»ºæ— é™å¾ªç¯ã€‚

å¦‚æœè°ƒç”¨ JSRuntime.InvokeAsyncï¼Œåˆ™ ElementRef ä»…åœ¨ OnAfterRenderAsync ä¸­ä½¿ç”¨ï¼Œè€Œä¸åœ¨ä»»ä½•æ›´æ—©çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­ä½¿ç”¨ï¼Œå› ä¸ºå‘ˆç°ç»„ä»¶åæ‰ä¼šæœ‰ JavaScript å…ƒç´ ã€‚

ä¼šè°ƒç”¨ StateHasChangedï¼Œä½¿ç”¨ä» JavaScript äº’æ“ä½œè°ƒç”¨ä¸­è·å–çš„æ–°çŠ¶æ€é‡æ–°å‘ˆç°è¯¥ç»„ä»¶ã€‚ æ­¤ä»£ç ä¸ä¼šåˆ›å»ºæ— é™å¾ªç¯ï¼Œå› ä¸ºä»…åœ¨ infoFromJs ä¸º null æ—¶æ‰è°ƒç”¨ StateHasChangedã€‚

    @page "/prerendered-interop"
    @using Microsoft.AspNetCore.Components
    @using Microsoft.JSInterop
    @inject IJSRuntime JSRuntime

    <p>
        Get value via JS interop call:
        <strong id="val-get-by-interop">@(infoFromJs ?? "No value yet")</strong>
    </p>

    Set value via JS interop call:
    <div id="val-set-by-interop" @ref="divElement"></div>

    @code {
        private string infoFromJs;
        private ElementReference divElement;

        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender && infoFromJs == null)
            {
                infoFromJs = await JSRuntime.InvokeAsync<string>(
                    "setElementText", divElement, "Hello from interop call!");

                StateHasChanged();
            }
        }
    }
    
å¯¹äºä¸Šè¿°ç¤ºä¾‹ä»£ç ï¼Œè¯·åœ¨è§†å›¾ä¸­ç›¸åº”æä¾›ä¸€ä¸ª setElementText JavaScript å‡½æ•° è¯¥å‡½æ•°é€šè¿‡ IJSRuntime.InvokeAsync è¿›è¡Œè°ƒç”¨ï¼Œä¼šè¿”å›å€¼ï¼š

    <script>
      window.setElementText = (element, text) => {
        element.innerText = text;
        return text;
      };
    </script>



ç»„ä»¶é€šå¸¸ä¼šæ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„åå°å·¥ä½œï¼Œå¦‚è¿›è¡Œç½‘ç»œè°ƒç”¨ (HttpClient) ä»¥åŠä¸æ•°æ®åº“äº¤äº’ã€‚ åœ¨å‡ ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½åœæ­¢åå°å·¥ä½œä»¥èŠ‚çœç³»ç»Ÿèµ„æºã€‚ ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·ç¦»å¼€ç»„ä»¶æ—¶ï¼Œåå°å¼‚æ­¥æ“ä½œä¸ä¼šè‡ªåŠ¨åœæ­¢ã€‚

åå°å·¥ä½œé¡¹å¯èƒ½éœ€è¦å–æ¶ˆçš„å…¶ä»–åŸå› åŒ…æ‹¬ï¼š

- æ­£åœ¨æ‰§è¡Œçš„åå°ä»»åŠ¡ç”±é”™è¯¯çš„è¾“å…¥æ•°æ®æˆ–å¤„ç†å‚æ•°å¯åŠ¨ã€‚
- æ­£åœ¨æ‰§è¡Œçš„ä¸€ç»„åå°å·¥ä½œé¡¹å¿…é¡»æ›¿æ¢ä¸ºä¸€ç»„æ–°çš„å·¥ä½œé¡¹ã€‚
- å¿…é¡»æ›´æ”¹å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚
- å¿…é¡»å…³é—­åº”ç”¨æ‰èƒ½å°†å…¶é‡æ–°éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚
- æœåŠ¡å™¨èµ„æºå—åˆ°é™åˆ¶ï¼Œéœ€è¦é‡æ–°è®¡åˆ’åå°å·¥ä½œé¡¹ã€‚

è¦åœ¨ç»„ä»¶ä¸­å®ç°å¯å–æ¶ˆçš„åå°å·¥ä½œæ¨¡å¼ï¼š

- ä½¿ç”¨ CancellationTokenSource å’Œ CancellationTokenã€‚
- åœ¨é‡Šæ”¾ç»„ä»¶æ—¶ï¼Œä»¥åŠéœ€è¦éšæ—¶é€šè¿‡æ‰‹åŠ¨å–æ¶ˆæ ‡è®°è¿›è¡Œå–æ¶ˆæ—¶ï¼Œè¯·è°ƒç”¨ CancellationTokenSource.Cancel ä»¥æŒ‡ç¤ºåº”å–æ¶ˆåå°å·¥ä½œã€‚
- å¼‚æ­¥è°ƒç”¨è¿”å›åï¼Œå¯¹è¯¥æ ‡è®°è°ƒç”¨ ThrowIfCancellationRequestedã€‚

å¦‚ä¸‹ç¤ºä¾‹ä¸­ï¼š

await Task.Delay(5000, cts.Token); è¡¨ç¤ºé•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥åå°å·¥ä½œã€‚

BackgroundResourceMethod è¡¨ç¤ºå¦‚æœåœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰é‡Šæ”¾ Resourceï¼Œåˆ™ä¸åº”å¯åŠ¨çš„é•¿æ—¶é—´è¿è¡Œçš„åå°æ–¹æ³•ã€‚
razor


    @implements IDisposable
    @using System.Threading

    <button @onclick="LongRunningWork">Trigger long running work</button>

    @code {
        private Resource resource = new Resource();
        private CancellationTokenSource cts = new CancellationTokenSource();

        protected async Task LongRunningWork()
        {
            await Task.Delay(5000, cts.Token);

            cts.Token.ThrowIfCancellationRequested();
            resource.BackgroundResourceMethod();
        }

        public void Dispose()
        {
            cts.Cancel();
            cts.Dispose();
            resource.Dispose();
        }

        private class Resource : IDisposable
        {
            private bool disposed;

            public void BackgroundResourceMethod()
            {
                if (disposed)
                {
                    throw new ObjectDisposedException(nameof(Resource));
                }
                
                ...
            }
            
            public void Dispose()
            {
                disposed = true;
            }
        }
    }



## ==âš¡ Blazor Events äº‹ä»¶å¤„ç†

Razor ç»„ä»¶æä¾›äº‹ä»¶å¤„ç†åŠŸèƒ½ã€‚ å¯¹äºå…·æœ‰å§”æ‰˜ç±»å‹å€¼ä¸”åä¸º @on{EVENT}ï¼ˆä¾‹å¦‚ @onclickï¼‰çš„ HTML å…ƒç´ ç‰¹æ€§ï¼ŒRazor ç»„ä»¶å°†è¯¥ç‰¹æ€§çš„å€¼è§†ä¸ºäº‹ä»¶å¤„ç†ç¨‹åºã€‚

- @on{EVENT} ä¸º Razor ç»„ä»¶æä¾›äº‹ä»¶å¤„ç†åŠŸèƒ½ã€‚
- @on{EVENT}:preventDefault ç¦æ­¢äº‹ä»¶çš„é»˜è®¤æ“ä½œã€‚
- @on{EVENT}:stopPropagation åœæ­¢äº‹ä»¶çš„äº‹ä»¶ä¼ æ’­ã€‚

åœ¨ UI ä¸­é€‰æ‹©è¯¥æŒ‰é’®æ—¶ï¼Œä»¥ä¸‹ä»£ç è°ƒç”¨ UpdateHeading æ–¹æ³•ï¼š

    <button class="btn btn-primary" @onclick="UpdateHeading">
        Update heading
    </button>

    @code {
        private void UpdateHeading(MouseEventArgs e)
        {
            ...
        }
    }

UI ä¸­çš„è¯¥å¤é€‰æ¡†æ›´æ”¹æ—¶ï¼Œä»¥ä¸‹ä»£ç è°ƒç”¨ CheckChanged æ–¹æ³•ï¼š

    <input type="checkbox" class="form-check-input" @onchange="CheckChanged" />

    @code {
        private void CheckChanged()
        {
            ...
        }
    }

äº‹ä»¶å¤„ç†ç¨‹åºä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥å¤„ç†ç¨‹åºï¼Œå¹¶è¿”å› Taskã€‚ æ— éœ€æ‰‹åŠ¨è°ƒç”¨ StateHasChangedã€‚ å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå®ƒä»¬å°†è¢«è®°å½•ä¸‹æ¥ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œé€‰æ‹©è¯¥æŒ‰é’®æ—¶ï¼Œå¼‚æ­¥è°ƒç”¨ UpdateHeadingï¼š

    <button class="btn btn-primary" @onclick="UpdateHeading">
        Update heading
    </button>

    @code {
        private async Task UpdateHeading(MouseEventArgs e)
        {
            ...
        }
    }




ä½¿ç”¨ `@on{EVENT}:preventDefault` æŒ‡ä»¤å±æ€§å¯é˜»æ­¢äº‹ä»¶çš„é»˜è®¤æ“ä½œã€‚

åœ¨è¾“å…¥è®¾å¤‡ä¸Šé€‰æ‹©æŸä¸ªé”®å¹¶ä¸”å…ƒç´ ç„¦ç‚¹ä½äºæŸä¸ªæ–‡æœ¬æ¡†ä¸Šæ—¶ï¼Œæµè§ˆå™¨é€šå¸¸åœ¨è¯¥æ–‡æœ¬æ¡†ä¸­æ˜¾ç¤ºè¯¥é”®çš„å­—ç¬¦ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œé€šè¿‡æŒ‡å®š `@onkeypress:preventDefault` æŒ‡ä»¤å±æ€§æ¥é˜»æ­¢é»˜è®¤è¡Œä¸ºã€‚

ä»¥ä¸‹æŒ‰é”®è®¡æ•°å™¨ï¼Œé€šè¿‡ç¦æ­¢ `<input>` çš„é»˜è®¤è¡Œä¸ºï¼Œä½¿å¾—æŒ‰ä¸‹çš„å­—ç¬¦ä¸ä¼šè¢«æ•è·åˆ°å…ƒç´ ä¸­æ˜¾ç¤ºï¼Œå¦åˆ™å…ƒç´ æ•æ‰åˆ°è¾“å…¥çš„å­—ç¬¦ï¼Œç„¶å KeyHandler æ›´ç´¯è®¡æ¬¡æ•°å†æ¬¡æ˜¾ç¤ºï¼Œå°±ä¼šå‡ºç°æ•°å­—å’Œå­—ç¬¦çš„äº¤æ›¿æ˜¾ç¤ºï¼š

    <input value="@count" @onkeypress="KeyHandler" @onkeypress:preventDefault />

    @code {
        private int count = 0;

        private void KeyHandler(KeyboardEventArgs e)
        {
            if (e.Key == "=")
            {
                count++;
            }
        }
    }

æŒ‡å®šæ²¡æœ‰å€¼çš„ @on{EVENT}:preventDefault å±æ€§ç­‰åŒäº @on{EVENT}:preventDefault="true"ã€‚
å±æ€§çš„å€¼ä¹Ÿå¯ä»¥ï¼Œ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒshouldPreventDefault æ˜¯è®¾ç½®ä¸º true æˆ– false çš„ bool å­—æ®µï¼š

    <input @onkeypress:preventDefault="shouldPreventDefault" />


ä½¿ç”¨ @on{EVENT}:stopPropagation æŒ‡ä»¤å±æ€§æ¥åœæ­¢äº‹ä»¶ä¼ æ’­ã€‚HTML çš„äº‹ä»¶æœ‰æ•æ‰å’Œå†’æ³¡ä¸¤ä¸ªæµç¨‹ï¼š

- Events Capture åœ¨å…ƒç´ å„æ³¨å†Œçš„äº‹ä»¶æ•æ‰å¤„ç†å‡½æ•°ä¸­ï¼Œçˆ¶çº§å…ƒç´ ä¼˜å…ˆå­çº§è·å¾—äº‹ä»¶å¤„ç†æƒï¼›
- Events Popagation åœ¨å…ƒç´ å„æ³¨å†Œçš„ä¾¦å¬å¤„ç†å‡½æ•°ä¸­ï¼Œå­çº§å…ƒç´ ä¼˜å…ˆçˆ¶çº§è·å¾—äº‹ä»¶å¤„ç†æƒï¼›
- å½“äº‹ä»¶å¤„ç†å‡½æ•°é«˜ç­‰ stop popagation åŠ¨ä½œï¼Œé‚£åç»­çš„å…¶å®ƒäº‹ä»¶å¤„ç†å‡½æ•°å°†ä¸å†æ‰§è¡Œã€‚

åœ¨ä¸‹ä¾‹ä¸­ï¼Œé€‰ä¸­å¤é€‰æ¡†å¯é˜»æ­¢ç¬¬äºŒä¸ªå­çº§ `<div>` ä¸­çš„å•å‡»äº‹ä»¶ä¼ æ’­åˆ°çˆ¶çº§ `<div>`ï¼š


    <label>
        <input @bind="stopPropagation" type="checkbox" />
        Stop Propagation
    </label>

    <div @onclick="OnSelectParentDiv">
        <h3>Parent div</h3>

        <div @onclick="OnSelectChildDiv">
            Child div that doesn't stop propagation when selected.
        </div>

        <div @onclick="OnSelectChildDiv" @onclick:stopPropagation="stopPropagation">
            Child div that stops propagation when selected.
        </div>
    </div>

    @code {
        private bool stopPropagation = false;

        private void OnSelectParentDiv() => 
            Console.WriteLine($"The parent div was selected. {DateTime.Now}");
        private void OnSelectChildDiv() => 
            Console.WriteLine($"A child div was selected. {DateTime.Now}");
    }



äº‹ä»¶å¤„ç†å™¨è¿˜å¯ä»¥ä½¿ç”¨ Lambda è¡¨è¾¾å¼ï¼š

    <button @onclick="@(e => Console.WriteLine("Hello, world!"))">Say hello</button>

åœ¨ Lambda è¡¨è¾¾å¼ä¸­å¯ä»¥ä½¿ç”¨é€šè¿‡æœ¬åœ°å˜é‡æ•è·çš„ for å¾ªç¯ä¸­çš„å¾ªç¯å˜é‡ (i) ã€‚ ç›´æ¥åœ¨ Lambda è¡¨è¾¾å¼å°†ä½¿ç”¨ for çš„å¾ªç¯å˜é‡ï¼Œå¯¼è‡´æ‰€æœ‰ Lambda ä¸­çš„ i å€¼ç›¸åŒã€‚ å§‹ç»ˆåœ¨æœ¬åœ°å˜é‡ä¸­æ•è·å…¶å€¼ï¼ˆåœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ä¸º buttonNumberï¼‰ï¼Œç„¶åä½¿ç”¨å®ƒã€‚

ç¤ºä¾‹åˆ›å»ºäº†ä¸‰ä¸ªæŒ‰é’®ï¼Œåœ¨ UI ä¸­é€‰ä¸­è¿™äº›æŒ‰é’®æ—¶ï¼Œæ¯ä¸ªæŒ‰é’®éƒ½è°ƒç”¨ UpdateHeading ä¼ é€’äº‹ä»¶å‚æ•° (MouseEventArgs) å’Œå…¶æŒ‰é’®ç¼–å· (buttonNumber)ï¼š

    <SurveyPrompt Title="How is Blazor working for you?" Content="@message" />

    @for (var i = 1; i < 4; i++)
    {
        var buttonNumber = i;

        <button class="btn btn-primary"
                @onclick="@(e => UpdateHeading(e, buttonNumber))">
            Button #@i
        </button>
    }

    @code {
        private string message = "Select a button to learn its position.";

        private void UpdateHeading(MouseEventArgs e, int buttonNumber)
        {
            message = $"You selected Button #{buttonNumber} at " +
                $"mouse position: {e.ClientX} X {e.ClientY}.";
        }
    }


EventCallback é€‚ç”¨äºåµŒå¥—ç»„ä»¶çš„ä¸€ä¸ªå¸¸è§åœºæ™¯ï¼Œå¸Œæœ›åœ¨å­ç»„ä»¶äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œçˆ¶ç»„ä»¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚å½“å­ç»„ä»¶ä¸­å‘ç”Ÿ onclick äº‹ä»¶æ—¶ã€‚ è‹¥è¦è·¨ç»„ä»¶å…¬å¼€äº‹ä»¶ï¼Œè¯·ä½¿ç”¨ EventCallbackï¼Œçˆ¶ç»„ä»¶å¯å‘å­ç»„ä»¶çš„ EventCallback åˆ†é…å›è°ƒæ–¹æ³•ã€‚

è¿™å¯ä»¥è§£å†³å­ç»„ä»¶å‘çˆ¶ç»„ä»¶ä¼ é€’æ•°æ®ï¼Œå‚è€ƒ Data Bindding æ•°æ®ç»‘å®šã€‚

ç¤ºä¾‹åº”ç”¨ ChildComponent.razor æ¼”ç¤ºå¦‚ä½•è®¾ç½®æŒ‰é’®çš„ onclick å¤„ç†ç¨‹åºä»¥ä¾› ParentComponent æ¥æ”¶ EventCallback å§”æ‰˜ã€‚ EventCallback æ˜¯ç”¨ MouseEventArgs ç±»å‹ï¼Œè¿™é€‚ç”¨äºæ¥è‡ªé¼ æ ‡ç­‰å¤–å›´è®¾å¤‡çš„ onclick äº‹ä»¶ï¼š

    <div class="panel panel-default">
        <div class="panel-heading">@Title</div>
        <div class="panel-body">@ChildContent</div>

        <button class="btn btn-primary" @onclick="OnClickCallback">
            Trigger a Parent component method
        </button>
    </div>

    @code {
        [Parameter]
        public string Title { get; set; }

        [Parameter]
        public RenderFragment ChildContent { get; set; }

        [Parameter]
        public EventCallback<MouseEventArgs> OnClickCallback { get; set; }
    }

ParentComponent å°†å­çº§çš„ OnClickCallback å§”æ‰˜ ShowMessage æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚å½“å­çº§è§¦å‘ onclick äº‹ä»¶å³è°ƒç”¨ ParentComponent çš„ ShowMessage æ–¹æ³•å¤„ç†ï¼ŒmessageText å¾—åˆ°æ›´æ–°å¹¶æ˜¾ç¤º

    @page "/ParentComponent"

    <h1>Parent-child example</h1>

    <ChildComponent Title="Panel Title from Parent"
                    OnClickCallback="@ShowMessage">
        Content of the child component is supplied
        by the parent component.
    </ChildComponent>

    <p><b>@messageText</b></p>

    @code {
        private string messageText;

        private void ShowMessage(MouseEventArgs e)
        {
            messageText = $"Blaze a new trail with Blazor! ({e.ScreenX}, {e.ScreenY})";
        }
    }

å›è°ƒæ–¹æ³• (ShowMessage) ä¸­ä¸éœ€è¦å¯¹ StateHasChanged çš„è°ƒç”¨ã€‚ è‡ªåŠ¨è°ƒç”¨ StateHasChanged ä»¥é‡æ–°å‘ˆç° ParentComponentï¼Œå°±åƒå­äº‹ä»¶è§¦å‘ç»„ä»¶é‡æ–°å‘ˆç°äºåœ¨å­çº§ä¸­æ‰§è¡Œçš„äº‹ä»¶å¤„ç†ç¨‹åºä¸­ä¸€æ ·ã€‚

EventCallback å’Œ EventCallback<T> å…è®¸å¼‚æ­¥å§”æ‰˜ã€‚EventCallback ä¸ºå¼±ç±»å‹ï¼Œå…è®¸ä»»ä½•å‚æ•°ç±»å‹ã€‚ EventCallback<T> ä¸ºå¼ºç±»å‹ï¼Œéœ€è¦æŒ‡å®šçš„å‚æ•°ç±»å‹ï¼Œèƒ½å‘ç”¨æˆ·æä¾›æ›´å¥½çš„ç»„ä»¶é”™è¯¯åé¦ˆã€‚ ä¸å…¶ä»– UI äº‹ä»¶å¤„ç†ç¨‹åºç±»ä¼¼ï¼ŒæŒ‡å®šäº‹ä»¶å‚æ•°æ˜¯å¯é€‰æ“ä½œã€‚

    <ChildComponent 
        OnClickCallback="@(async () => { await Task.Yield(); messageText = "Blaze It!"; })" />

åœ¨å­çº§çš„ onclick ä¸­ä½¿ç”¨ InvokeAsync è°ƒç”¨ EventCallback æˆ– EventCallback<T> å¹¶ç­‰å¾… Taskï¼š

    await callback.InvokeAsync(arg);



å¯¹äºæŸäº›äº‹ä»¶ï¼Œå…è®¸ä½¿ç”¨äº‹ä»¶å‚æ•°ç±»å‹å®šä¹‰åœ¨ Microsoft.AspNetCore.Components.Webã€‚ ä»…å½“æ–¹æ³•ä¸­ä½¿ç”¨äº†äº‹ä»¶ç±»å‹æ—¶ï¼Œæ‰éœ€è¦åœ¨æ–¹æ³•è°ƒç”¨ä¸­æŒ‡å®šè¯¥äº‹ä»¶ç±»å‹ã€‚æ”¯æŒçš„ EventArgs ç±»å‹ï¼Œäº‹ä»¶åˆ†ç±»åŠç›¸å…³çš„ DOM äº‹ä»¶å’Œè¯´æ˜ï¼š

- å‰ªè´´æ¿   ClipboardEventArgs

    oncut, oncopy, onpaste

- æ‹–åŠ¨    DragEventArgs

    ondrag, ondragstart, ondragenter, ondragleave, ondragover, ondrop, ondragend

    DataTransfer å’Œ DataTransferItem ä¿ç•™æ‹–åŠ¨çš„é¡¹æ•°æ®ã€‚

- é”™è¯¯    ErrorEventArgs  onerror

- ä¸€èˆ¬äº‹ä»¶  EventArgs

    å¸¸è§„
    onactivateã€onbeforeactivateã€onbeforedeactivateã€ondeactivateã€onendedã€onfullscreenchangeã€onfullscreenerrorã€onloadeddataã€onloadedmetadataã€onpointerlockchangeã€onpointerlockerrorã€onreadystatechangeã€onscroll

    å‰ªè´´æ¿
    onbeforecut, onbeforecopy, onbeforepaste

    è¾“å…¥
    oninvalid, onreset, onselect, onselectionchange, onselectstart, onsubmit

    ä»‹è´¨
    oncanplayã€oncanplaythroughã€oncuechangeã€ondurationchangeã€onemptiedã€onpauseã€onplayã€onplayingã€onratechangeã€onseekedã€onseekingã€onstalledã€onstopã€onsuspendã€ontimeupdateã€onvolumechangeã€onwaiting

- ç„¦ç‚¹    FocusEventArgs  

    onfocus, onblur, onfocusin, onfocusout

    ä¸åŒ…å«å¯¹ relatedTarget çš„æ”¯æŒã€‚

- è¾“å…¥    ChangeEventArgs

    onchangeï¼Œoninput

- é”®ç›˜    KeyboardEventArgs

    onkeydown, onkeypress, onkeyup

- é¼ æ ‡    MouseEventArgs

    onclick, oncontextmenu, ondblclick, onmousedown, onmouseup, onmouseover, onmousemove, onmouseout

- é¼ æ ‡æŒ‡é’ˆ  PointerEventArgs    

    onpointerdown, onpointerup, onpointercancel, onpointermove, onpointerover, onpointerout, onpointerenter, onpointerleave, ongotpointercapture, onlostpointercapture

- é¼ æ ‡æ»šè½®  WheelEventArgs  

    onwheelï¼Œonmousewheel

- è¿›åº¦    ProgressEventArgs   

    onabort, onload, onloadend, onloadstart, onprogress, ontimeout

- è§¦æ§    TouchEventArgs  

    ontouchstart, ontouchend, ontouchmove, ontouchenter, ontouchleave, ontouchcancel

    TouchPoint è¡¨ç¤ºè§¦æ§æ•æ„Ÿå‹è®¾å¤‡ä¸Šçš„å•ä¸ªæ¥è§¦ç‚¹ã€‚



## ==âš¡ State Management çŠ¶æ€ç®¡ç†
https://docs.microsoft.com/zh-cn/aspnet/core/blazor/state-management?view=aspnetcore-3.1

Blazor æœåŠ¡å™¨æ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨æ¡†æ¶ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ç”¨ä¿æŒä¸æœåŠ¡å™¨çš„æŒç»­è¿æ¥ã€‚ ç”¨æˆ·çš„çŠ¶æ€ä¿ç•™åœ¨çº¿è·¯ä¸­çš„æœåŠ¡å™¨å†…å­˜ä¸­ ã€‚

ä¸ºç”¨æˆ·çº¿è·¯ä¿ç•™çš„çŠ¶æ€ç¤ºä¾‹åŒ…æ‹¬ï¼š

- å‘ˆç°çš„ UI â€” ç»„ä»¶å®ä¾‹çš„å±‚æ¬¡ç»“æ„åŠå…¶æœ€æ–°çš„å‘ˆç°è¾“å‡ºã€‚
- ç»„ä»¶å®ä¾‹ä¸­çš„ä»»ä½•å­—æ®µå’Œå±æ€§çš„å€¼ã€‚
- åœ¨çº¿è·¯èŒƒå›´å†…çš„ä¾èµ–å…³ç³»æ³¨å…¥ (DI) æœåŠ¡å®ä¾‹ä¸­ä¿ç•™çš„æ•°æ®ã€‚

æœ¬æ–‡ä»‹ç» Blazor æœåŠ¡å™¨åº”ç”¨ä¸­çš„çŠ¶æ€æš‚ç•™ã€‚ Blazor WebAssembly åº”ç”¨å¯ä»¥åˆ©ç”¨æµè§ˆå™¨ä¸­çš„å®¢æˆ·ç«¯çŠ¶æ€æš‚ç•™ï¼Œä½†éœ€è¦è‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆæˆ–ç¬¬ä¸‰æ–¹åŒ…ï¼ˆè¿™äº›å¹¶ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ï¼‰ã€‚

Blazor çº¿è·¯

å¦‚æœç”¨æˆ·é‡åˆ°æš‚æ—¶çš„ç½‘ç»œè¿æ¥ä¸¢å¤±é—®é¢˜ï¼ŒBlazor ä¼šå°è¯•å°†ç”¨æˆ·é‡æ–°è¿æ¥åˆ°å…¶åŸå§‹çº¿è·¯ï¼Œä»¥ä¾¿ç”¨æˆ·ç»§ç»­ä½¿ç”¨è¯¥åº”ç”¨ã€‚ ä½†æ˜¯ï¼Œå°†ç”¨æˆ·é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨å†…å­˜ä¸­çš„åŸå§‹ç”µè·¯å¹¶éæ€»æ˜¯èƒ½å¤Ÿå®ç°çš„ï¼š

- æœåŠ¡å™¨ä¸èƒ½æ°¸ä¹…ä¿ç•™æ–­å¼€è¿æ¥çš„çº¿è·¯ã€‚ è¶…æ—¶åæˆ–åœ¨æœåŠ¡å™¨é¢ä¸´å†…å­˜å‹åŠ›æ—¶ï¼ŒæœåŠ¡å™¨å¿…é¡»é‡Šæ”¾æ–­å¼€è¿æ¥çš„çº¿è·¯ã€‚

- åœ¨å¤šæœåŠ¡å™¨ã€è´Ÿè½½å‡è¡¡çš„éƒ¨ç½²ç¯å¢ƒä¸­ï¼Œä»»ä½•æœåŠ¡å™¨å¤„ç†è¯·æ±‚åœ¨ä»»ä½•ç»™å®šæ—¶é—´éƒ½å¯èƒ½å˜å¾—ä¸å¯ç”¨ã€‚ ä¸å†éœ€è¦å•ä¸ªæœåŠ¡å™¨å¤„ç†æ•´ä¸ªè¯·æ±‚é‡æ—¶ï¼Œå®ƒå¯èƒ½ä¼šå¤±è´¥æˆ–è¢«è‡ªåŠ¨åˆ é™¤ã€‚ å½“ç”¨æˆ·å°è¯•é‡æ–°è¿æ¥æ—¶ï¼ŒåŸå§‹æœåŠ¡å™¨å¯èƒ½ä¸å¯ç”¨ã€‚

- ç”¨æˆ·å¯èƒ½ä¼šå…³é—­å¹¶é‡æ–°æ‰“å¼€å…¶æµè§ˆå™¨æˆ–é‡è½½é¡µé¢ï¼Œè¿™ä¼šåˆ é™¤æµè§ˆå™¨å†…å­˜ä¸­ä¿ç•™çš„æ‰€æœ‰çŠ¶æ€ã€‚ ä¾‹å¦‚ï¼Œé€šè¿‡ JavaScript äº’æ“ä½œè°ƒç”¨è®¾ç½®çš„å€¼å°†ä¸¢å¤±ã€‚

å½“æ— æ³•å°†ç”¨æˆ·é‡æ–°è¿æ¥åˆ°å…¶åŸå§‹çº¿è·¯æ—¶ï¼Œç”¨æˆ·å°†æ”¶åˆ°ä¸€ä¸ªå…·æœ‰ç©ºçŠ¶æ€çš„æ–°çº¿è·¯ã€‚ è¿™ç­‰æ•ˆäºå…³é—­å¹¶é‡æ–°æ‰“å¼€æ¡Œé¢åº”ç”¨ã€‚


Blazor è·¨çº¿è·¯ä¿ç•™çŠ¶æ€

åœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œéœ€è¦è·¨çº¿è·¯ä¿ç•™çŠ¶æ€ã€‚ å¦‚æœå‡ºç°ä»¥ä¸‹æƒ…å†µï¼Œåº”ç”¨å¯ä»¥ä¸ºç”¨æˆ·ä¿ç•™é‡è¦æ•°æ®ï¼š

- Web æœåŠ¡å™¨ä¸å¯ç”¨ã€‚
- ç”¨æˆ·çš„æµè§ˆå™¨è¢«å¼ºåˆ¶ä½¿ç”¨æ–°çš„ Web æœåŠ¡å™¨å¯åŠ¨æ–°çº¿è·¯ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œè·¨çº¿è·¯ä¿æŒçŠ¶æ€é€‚ç”¨äºç”¨æˆ·ä¸»åŠ¨åˆ›å»ºæ•°æ®ï¼Œè€Œä¸æ˜¯ç®€å•åœ°è¯»å–å·²å­˜åœ¨çš„æ•°æ®çš„åº”ç”¨åœºæ™¯ã€‚

è‹¥è¦åœ¨å•ä¸ªç”µè·¯ä¹‹å¤–ä¿ç•™çŠ¶æ€ï¼Œè¯·å‹¿åªæ˜¯å°†æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨çš„å†…å­˜ä¸­ ã€‚ åº”ç”¨å¿…é¡»å°†æ•°æ®ä¿ç•™åˆ°å…¶ä»–å­˜å‚¨ä½ç½®ã€‚ çŠ¶æ€æš‚ç•™å¹¶éæ˜¯è‡ªåŠ¨è¿›è¡Œçš„ â€” å¿…é¡»åœ¨å¼€å‘åº”ç”¨æ—¶é‡‡å–æªæ–½æ¥å®ç°æœ‰çŠ¶æ€çš„æ•°æ®æš‚ç•™ã€‚

é€šå¸¸ï¼Œåªæœ‰ç”¨æˆ·æŠ•å…¥äº†å¤§é‡ç²¾åŠ›æ‰€åˆ›å»ºçš„é«˜ä»·å€¼çŠ¶æ€æ‰éœ€è¦æ•°æ®æš‚ç•™ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œä¿ç•™çŠ¶æ€å¯ä»¥èŠ‚çœæ—¶é—´æˆ–æœ‰åŠ©äºå•†ä¸šæ´»åŠ¨ï¼š

- å¤šæ­¥éª¤ Web çª—ä½“ â€“ åœ¨ä¸€ä¸ªå¤šæ­¥éª¤è¿›ç¨‹ä¸­ï¼Œå¦‚æœç”¨æˆ·çš„çŠ¶æ€ä¸¢å¤±ï¼Œåˆ™éœ€ä¸ºå¤šä¸ªå·²å®Œæˆæ­¥éª¤é‡æ–°è¾“å…¥æ•°æ®ï¼Œè€Œè¿™éå¸¸è€—æ—¶ã€‚ å¦‚æœç”¨æˆ·ç¦»å¼€å¤šæ­¥éª¤çª—ä½“å¹¶åœ¨ç¨åè¿”å›ï¼Œåœ¨è¿™ç§åº”ç”¨åœºæ™¯ä¸‹ï¼Œç”¨æˆ·å°†å¤±å»çŠ¶æ€ã€‚

- è´­ç‰©è½¦ â€“ ä»£è¡¨æ½œåœ¨æ”¶å…¥çš„åº”ç”¨çš„æ‰€æœ‰å…·æœ‰é‡è¦å•†ä¸šä»·å€¼çš„ç»„ä»¶éƒ½å¯è¿›è¡Œç»´æŠ¤ã€‚ å¦‚æœç”¨æˆ·ä¸¢å¤±äº†å…¶çŠ¶æ€ï¼Œè¿›è€Œä¸¢å¤±äº†å…¶è´­ç‰©è½¦ï¼Œåˆ™åœ¨ä»–ä»¬ç¨åè¿”å›ç«™ç‚¹æ—¶å¯è´­ä¹°è¾ƒå°‘çš„äº§å“æˆ–æœåŠ¡ã€‚

é€šå¸¸ä¸éœ€è¦ä¿ç•™æ˜“äºé‡æ–°åˆ›å»ºçš„çŠ¶æ€ï¼Œä¾‹å¦‚åœ¨ç™»å½•å¯¹è¯æ¡†ä¸­è¾“å…¥çš„å°šæœªæäº¤çš„ç”¨æˆ·åã€‚


æœ‰ä¸‰ä¸ªå¸¸è§ä½ç½®ç”¨äºä¿ç•™ Blazor æœåŠ¡å™¨åº”ç”¨ä¸­çš„çŠ¶æ€ã€‚ æ¯ç§æ–¹æ³•åˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œä¸”æœ‰ä¸åŒçš„æ³¨æ„äº‹é¡¹ï¼š

- æ•°æ®åº“ä¸­çš„æœåŠ¡å™¨ç«¯
- URL
- æµè§ˆå™¨ä¸­çš„å®¢æˆ·ç«¯

å¯¹äºæ°¸ä¹…æ•°æ®æš‚ç•™æˆ–å¿…é¡»è·¨å¤šä¸ªç”¨æˆ·æˆ–è®¾å¤‡çš„ä»»ä½•æ•°æ®ï¼Œç‹¬ç«‹çš„æœåŠ¡å™¨ç«¯æ•°æ®åº“å‡ ä¹è‚¯å®šæ˜¯æœ€ä½³é€‰æ‹©ã€‚ é€‰é¡¹åŒ…æ‹¬ï¼š

- å…³ç³» SQL æ•°æ®åº“
- é”®å€¼å­˜å‚¨
- Blob å­˜å‚¨
- è¡¨å­˜å‚¨

å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“åï¼Œç”¨æˆ·å¯ä»¥éšæ—¶å¯åŠ¨æ–°çº¿è·¯ã€‚ ç”¨æˆ·æ•°æ®ä¼šä¿ç•™ä¸”åœ¨ä»»ä½•æ–°çº¿è·¯ä¸­å¯ç”¨ã€‚

å¯¹äºç”¨æˆ·æ­£åœ¨ä¸»åŠ¨åˆ›å»ºçš„æš‚æ—¶æ€§æ•°æ®ï¼Œé€šç”¨åå¤‡å­˜å‚¨æ˜¯æµè§ˆå™¨çš„ localStorage å’Œ sessionStorage é›†åˆã€‚ å¦‚æœæ”¾å¼ƒè¯¥çº¿è·¯ï¼Œåˆ™åº”ç”¨æ— éœ€ç®¡ç†æˆ–æ¸…é™¤å­˜å‚¨çš„çŠ¶æ€ã€‚ä¸æœåŠ¡å™¨ç«¯å­˜å‚¨ç›¸æ¯”ï¼Œè¿™æ˜¯ä¸€é¡¹ä¼˜åŠ¿ã€‚
 å¤‡æ³¨

æœ¬èŠ‚ä¸­çš„â€œå®¢æˆ·ç«¯â€æ˜¯æŒ‡æµè§ˆå™¨ä¸­çš„å®¢æˆ·ç«¯æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯ BlazorWebAssembly æ‰˜ç®¡æ¨¡å‹ã€‚ localStorage å’Œ sessionStorage å¯ç”¨äº Blazor WebAssembly åº”ç”¨ï¼Œä½†åªèƒ½é€šè¿‡ç¼–å†™è‡ªå®šä¹‰ä»£ç æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œä½¿ç”¨ã€‚

localStorage çš„åº”ç”¨èŒƒå›´é™å®šä¸ºç”¨æˆ·çš„æµè§ˆå™¨ã€‚ å¦‚æœç”¨æˆ·é‡è½½é¡µé¢æˆ–å…³é—­å¹¶é‡æ–°æ‰“å¼€æµè§ˆå™¨ï¼Œåˆ™çŠ¶æ€ä¿æŒä¸å˜ã€‚ å¦‚æœç”¨æˆ·æ‰“å¼€å¤šä¸ªæµè§ˆå™¨é€‰é¡¹å¡ï¼Œåˆ™çŠ¶æ€è·¨é€‰é¡¹å¡å…±äº«ã€‚ æ•°æ®ä¿ç•™åœ¨ localStorage ä¸­ï¼Œç›´åˆ°è¢«æ˜¾å¼æ¸…é™¤ä¸ºæ­¢ã€‚

sessionStorage çš„åº”ç”¨èŒƒå›´é™å®šä¸ºç”¨æˆ·çš„æµè§ˆå™¨é€‰é¡¹å¡ã€‚å¦‚æœç”¨æˆ·é‡è½½è¯¥é€‰é¡¹å¡ï¼Œåˆ™çŠ¶æ€ä¿æŒä¸å˜ã€‚ å¦‚æœç”¨æˆ·å…³é—­è¯¥é€‰é¡¹å¡æˆ–è¯¥æµè§ˆå™¨ï¼Œåˆ™çŠ¶æ€ä¸¢å¤±ã€‚ å¦‚æœç”¨æˆ·æ‰“å¼€å¤šä¸ªæµè§ˆå™¨é€‰é¡¹å¡ï¼Œåˆ™æ¯ä¸ªé€‰é¡¹å¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®ç‰ˆæœ¬ã€‚

é€šå¸¸ï¼ŒsessionStorage ä½¿ç”¨èµ·æ¥æ›´å®‰å…¨ã€‚ sessionStorage é¿å…äº†ç”¨æˆ·æ‰“å¼€å¤šä¸ªé€‰é¡¹å¡å¹¶é‡åˆ°ä»¥ä¸‹é—®é¢˜çš„é£é™©ï¼š

- è·¨é€‰é¡¹å¡çš„çŠ¶æ€å­˜å‚¨ä¸­å‡ºç° bugã€‚
- ä¸€ä¸ªé€‰é¡¹å¡è¦†ç›–å…¶ä»–é€‰é¡¹å¡çš„çŠ¶æ€æ—¶å‡ºç°æ··ä¹±è¡Œä¸ºã€‚

å¦‚æœåº”ç”¨å¿…é¡»åœ¨å…³é—­å’Œé‡æ–°æ‰“å¼€æµè§ˆå™¨æœŸé—´ä¿æŒçŠ¶æ€ï¼Œåˆ™ localStorage æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

ä½¿ç”¨æµè§ˆå™¨å­˜å‚¨æ—¶çš„æ³¨æ„äº‹é¡¹ï¼š

- ä¸ä½¿ç”¨æœåŠ¡å™¨ç«¯æ•°æ®åº“ç±»ä¼¼ï¼ŒåŠ è½½å’Œä¿å­˜æ•°æ®éƒ½æ˜¯å¼‚æ­¥çš„ã€‚
- ä¸æœåŠ¡å™¨ç«¯æ•°æ®åº“ä¸åŒï¼Œåœ¨é¢„å‘ˆç°æœŸé—´ï¼Œå­˜å‚¨ä¸å¯ç”¨ï¼Œå› ä¸ºåœ¨é¢„å‘ˆç°é˜¶æ®µï¼Œè¯·æ±‚çš„é¡µé¢åœ¨æµè§ˆå™¨ä¸­ä¸å­˜åœ¨ã€‚
- ä¿ç•™çŠ¶æ€çš„ä½ç½®å¯¹äº Blazor æœåŠ¡å™¨åº”ç”¨ï¼ŒæŒä¹…å­˜å‚¨å‡ åƒå­—èŠ‚çš„æ•°æ®æ˜¯åˆç†çš„ã€‚ è¶…å‡ºå‡ åƒå­—èŠ‚åï¼Œä½ å°±é¡»è€ƒè™‘æ€§èƒ½å½±å“ï¼Œå› ä¸ºæ•°æ®æ˜¯è·¨ç½‘ç»œåŠ è½½å’Œä¿å­˜çš„ã€‚
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æˆ–ç¯¡æ”¹æ•°æ®ã€‚ ASP.NET Core æ•°æ®ä¿æŠ¤å¯ä»¥é™ä½é£é™©ã€‚


Microsoft.AspNetCore.ProtectedBrowserStorage å°±æ˜¯ä¸€ä¸ªä¸º localStorage å’Œ sessionStorage æä¾›æ•°æ®ä¿æŠ¤çš„ NuGet å®éªŒæ€§åŒ…ï¼Œç›®å‰ä¸é€‚åˆç”¨äºç”Ÿäº§ã€‚

åœ¨ Blazor æœåŠ¡å™¨åº”ç”¨é¡¹ç›®ä¸­å®‰è£… Microsoft.AspNetCore.ProtectedBrowserStorage åŒ…ï¼š

    dotnet add package Microsoft.AspNetCore.ProtectedBrowserStorage

åœ¨é¡¶çº§ HTMLï¼ˆä¾‹å¦‚ï¼Œåœ¨é»˜è®¤é¡¹ç›®æ¨¡æ¿ä¸­çš„ `Pages/_Host.cshtml` æ–‡ä»¶ä¸­ï¼‰ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹æ ‡è®° ï¼š

    <script src="_content/Microsoft.AspNetCore.ProtectedBrowserStorage/protectedBrowserStorage.js"></script>

åœ¨ Startup.ConfigureServices æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ AddProtectedBrowserStorage ä»¥å°† localStorage å’Œ sessionStorage æœåŠ¡æ·»åŠ åˆ°æœåŠ¡é›†åˆï¼š

    services.AddProtectedBrowserStorage();

ä¿å­˜å’ŒåŠ è½½ç»„ä»¶ä¸­çš„æ•°æ®ï¼Œåœ¨éœ€è¦å°†æ•°æ®åŠ è½½æˆ–ä¿å­˜åˆ°æµè§ˆå™¨å­˜å‚¨çš„ä»»ä½•ç»„ä»¶ä¸­ï¼Œä½¿ç”¨ @inject æ³¨å…¥ä»¥ä¸‹ä»»æ„ä¸€é¡¹çš„å®ä¾‹ï¼š

    ProtectedLocalStorage
    ProtectedSessionStorage

æ­¤é€‰æ‹©å–å†³äºä½ è¦ä½¿ç”¨çš„åå¤‡å­˜å‚¨ã€‚ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ sessionStorageï¼š

    @using Microsoft.AspNetCore.ProtectedBrowserStorage
    @inject ProtectedSessionStorage ProtectedSessionStore

å¯å°† @using è¯­å¥æ”¾ç½®åœ¨ `_Imports.razor` æ–‡ä»¶è€Œä¸æ˜¯ç»„ä»¶ä¸­ ã€‚ ä½¿ç”¨ `_Imports.razor` æ–‡ä»¶å¯ä½¿å‘½åç©ºé—´å¯ç”¨äºåº”ç”¨çš„è¾ƒå¤§éƒ¨åˆ†æˆ–æ•´ä¸ªåº”ç”¨ ã€‚

è‹¥è¦åœ¨é¡¹ç›®æ¨¡æ¿çš„ Counter ç»„ä»¶ä¸­ä¿ç•™ currentCount å€¼ï¼Œè¯·ä¿®æ”¹ IncrementCount æ–¹æ³•ä»¥ä½¿ç”¨ ProtectedSessionStore.SetAsyncï¼š

    private async Task IncrementCount()
    {
        currentCount++;
        await ProtectedSessionStore.SetAsync("count", currentCount);
    }

åœ¨æ›´å¤§ã€æ›´çœŸå®çš„åº”ç”¨ä¸­ï¼Œå­˜å‚¨å•ä¸ªå­—æ®µæ˜¯ä¸å¤ªå¯èƒ½å‡ºç°çš„æƒ…å†µã€‚ åº”ç”¨æ›´æœ‰å¯èƒ½å­˜å‚¨åŒ…å«å¤æ‚çŠ¶æ€çš„æ•´ä¸ªæ¨¡å‹å¯¹è±¡ã€‚ ProtectedSessionStore è‡ªåŠ¨ä¸²è¡ŒåŒ–å’Œååºåˆ—åŒ– JSON æ•°æ®ã€‚

åœ¨å‰é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼ŒcurrentCount æ•°æ®å­˜å‚¨ä¸ºç”¨æˆ·æµè§ˆå™¨ä¸­çš„ sessionStorage['count']ã€‚ æ•°æ®ä¸ä¼šä»¥çº¯æ–‡æœ¬å½¢å¼å­˜å‚¨ï¼Œè€Œæ˜¯ä½¿ç”¨ ASP.NET Core çš„æ•°æ®ä¿æŠ¤è¿›è¡Œä¿æŠ¤ã€‚ å¦‚æœåœ¨æµè§ˆå™¨çš„å¼€å‘äººå‘˜æ§åˆ¶å°ä¸­è¯„ä¼°äº† sessionStorage['count']ï¼Œåˆ™å¯ä»¥æŸ¥çœ‹åŠ å¯†çš„æ•°æ®ã€‚

è‹¥è¦åœ¨ç”¨æˆ·ç¨åè¿”å›åˆ° Counter ç»„ä»¶æ—¶ï¼ˆåŒ…æ‹¬ä»–ä»¬ä½äºå…¨æ–°çº¿è·¯ä¸Šæ—¶ï¼‰æ¢å¤ currentCount æ•°æ®ï¼Œè¯·ä½¿ç”¨ ProtectedSessionStore.GetAsyncï¼š

    protected override async Task OnInitializedAsync()
    {
        currentCount = await ProtectedSessionStore.GetAsync<int>("count");
    }

å¦‚æœç»„ä»¶çš„å‚æ•°åŒ…æ‹¬å¯¼èˆªçŠ¶æ€ï¼Œè¯·è°ƒç”¨ ProtectedSessionStore.GetAsync å¹¶å°†ç»“æœåˆ†é…ç»™ OnParametersSetAsyncï¼Œè€Œä¸æ˜¯ OnInitializedAsyncã€‚ OnInitializedAsync ä»…åœ¨é¦–æ¬¡å®ä¾‹åŒ–ç»„ä»¶æ—¶è°ƒç”¨ä¸€æ¬¡ã€‚ å¦‚æœç”¨æˆ·å¯¼èˆªåˆ°ä¸åŒçš„ URLï¼Œè€Œä»ç„¶åœç•™åœ¨ç›¸åŒçš„é¡µé¢ä¸Šï¼Œåˆ™ OnInitializedAsync ä¹‹åä¸ä¼šå†æ¬¡è°ƒç”¨ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ASP.NET Core Blazor ç”Ÿå‘½å‘¨æœŸã€‚

 è­¦å‘Š

æœ¬èŠ‚ä¸­çš„ç¤ºä¾‹ä»…åœ¨æœåŠ¡å™¨æœªå¯ç”¨é¢„å‘ˆç°çš„æƒ…å†µä¸‹æœ‰æ•ˆã€‚ å¯ç”¨é¢„å‘ˆç°åï¼Œå°†ç”Ÿæˆå¦‚ä¸‹é”™è¯¯ï¼š
æ­¤æ—¶æ— æ³•å‘å‡º JavaScript äº’æ“ä½œè°ƒç”¨ã€‚ è¿™æ˜¯å› ä¸ºè¯¥ç»„ä»¶å·²é¢„å‘ˆç°ã€‚
ç¦ç”¨é¢„å‘ˆç°æˆ–æ·»åŠ å…¶ä»–ä»£ç ä»¥å¤„ç†é¢„å‘ˆç°ã€‚ è‹¥è¦äº†è§£æœ‰å…³ç¼–å†™å¯å¤„ç†é¢„å‘ˆç°çš„ä»£ç çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å¤„ç†é¢„å‘ˆç°ä¸€èŠ‚ã€‚



## ==âš¡ Dependence Injection ä¾èµ–æ³¨å…¥æœåŠ¡
- [ä¾èµ–æ³¨å…¥ - æ§åˆ¶å™¨](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/dependency-injection?view=aspnetcore-3.1)
- [ä¾èµ–æ³¨å…¥ - è§†å›¾](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/dependency-injection?view=aspnetcore-3.1)

å¦‚æœä½¿ç”¨çš„æ˜¯ Blazor Server åº”ç”¨ï¼ŒæœåŠ¡å¯ä»¥åœ¨ Startup.ConfigureServices ä¸­æ³¨å†Œä¸ºå•ä¸€å®ä¾‹ã€‚ å¯é€šè¿‡ä¾èµ–å…³ç³»æ³¨å…¥ (DI) åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä½¿ç”¨æœåŠ¡çš„å®ä¾‹ï¼š

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRazorPages();
        services.AddServerSideBlazor();
        services.AddSingleton<WeatherForecastService>();
    }

æœåŠ¡ç±»å‹ WeatherForecastService ä»¥åŠæ•°æ®æ¨¡å‹ç±» WeatherForecast å®šä¹‰å¦‚ä¸‹ï¼ŒæœåŠ¡ç±»å®šä¹‰ GetForecastAsync æ–¹æ³•æ¥ç”Ÿæˆéšæœºå¤©æ°”é¢„æµ‹æ•°æ®ï¼š

    using System;
    using System.Linq;
    using System.Threading.Tasks;

    namespace blazorServerWebApp.Data
    {
        public class WeatherForecast
        {
            public DateTime Date { get; set; }
            public int TemperatureC { get; set; }
            public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
            public string Summary { get; set; }
        }

        public class WeatherForecastService
        {
            private static readonly string[] Summaries = new[]
            {
                "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
            };

            public Task<WeatherForecast[]> GetForecastAsync(DateTime startDate)
            {
                var rng = new Random();
                return Task.FromResult(Enumerable.Range(1, 5).Select(index => new WeatherForecast
                {
                    Date = startDate.AddDays(index),
                    TemperatureC = rng.Next(-20, 55),
                    Summary = Summaries[rng.Next(Summaries.Length)]
                }).ToArray());
            }
        }
    }

ä½¿ç”¨ @inject æŒ‡ä»¤å°†æœåŠ¡çš„å®ä¾‹æ³¨å…¥åˆ°ç»„ä»¶ä¸­ï¼Œç„¶åç»„ä»¶å°±å¯ä»¥ä½¿ç”¨å·²ç»æ³¨å…¥çš„æœåŠ¡ã€‚è¿™é‡Œçš„æœåŠ¡å®ä¾‹ ForecastService ç”¨æ¥æ£€ç´¢ WeatherForecast å¯¹è±¡çš„æ•°ç»„ï¼š

    @using blazorServerWebApp.Data
    @inject WeatherForecastService ForecastService

    ...

    @if (forecasts == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Temp. (C)</th>
                    <th>Temp. (F)</th>
                    <th>Summary</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var forecast in forecasts)
                {
                    <tr>
                        <td>@forecast.Date.ToShortDateString()</td>
                        <td>@forecast.TemperatureC</td>
                        <td>@forecast.TemperatureF</td>
                        <td>@forecast.Summary</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @code {
        private WeatherForecast[] forecasts;

        protected override async Task OnInitializedAsync()
        {
            forecasts = await ForecastService.GetForecastAsync(DateTime.Now);
        }
    }

æœåŠ¡ä¼ é€çš„æ•°æ®å°†é€šè¿‡ SignalR å³ WebSocket ä¼ è¾“ï¼Œè¿™æ˜¯ Blazor Server ä¸ Blazor WebAssembly ä¸¤ç§åº”ç”¨çš„æœ€å¤§åŒºåˆ«ã€‚


å¦‚æœä½¿ç”¨çš„æ˜¯ Blazor WebAssembly åº”ç”¨ï¼Œåˆ™æ³¨å…¥ HttpClient å®ä¾‹ï¼Œé€šè¿‡å®ƒæä¾›çš„ GetFromJsonAsync æ–¹æ³•ä»¥ GET æ–¹å¼è·å–æœåŠ¡ç«¯çš„ weather.json æ–‡ä»¶ï¼Œå¹¶å°† JSON å¯¹è±¡è½¬æ¢ä¸º WeatherForecast å¯¹è±¡ä»¥æä¾›å¤©æ°”é¢„æµ‹æ•°æ®ï¼Œç„¶åä½¿ç”¨ @foreach å¾ªç¯å°†æ•°æ®æ¸²æŸ“åˆ°è§†å›¾ä¸Šï¼š

    @inject HttpClient Http

    ...

    @code {
        private WeatherForecast[] forecasts;

        protected override async Task OnInitializedAsync()
        {
            forecasts = await Http.GetFromJsonAsync<WeatherForecast[]>("sample-data/weather.json");
        }

        public class WeatherForecast
        {
            public DateTime Date { get; set; }
            public int TemperatureC { get; set; }
            public string Summary { get; set; }
            public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
        }
    }

åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦æä¾›å¯ä»¥ç”Ÿæˆä»¥ä¸‹ JSON æ ¼å¼çš„ Web APIï¼š

    [
      { "date": "2018-05-06", "temperatureC": 1, "summary": "Freezing" },
      { "date": "2018-05-07", "temperatureC": 14, "summary": "Bracing" },
      { "date": "2018-05-08", "temperatureC": -13, "summary": "Freezing" },
      { "date": "2018-05-09", "temperatureC": -16, "summary": "Balmy" },
      { "date": "2018-05-10", "temperatureC": -2, "summary": "Chilly" }
    ]



## ==âš¡ MySQL æ•°æ®åº“ä¸­é—´å±‚
- https://docs.automapper.org/en/stable/index.html
- https://dev.mysql.com/doc/dev/connector-net/8.0/html/connector-net-reference.htm
- https://docs.microsoft.com/zh-cn/ef/

æ•°æ®åº“çš„è¯»å†™ï¼Œå¸¸ç”¨ä¸­é—´å±‚å°è£…ä»¥æ–¹ä¾¿æ•´ä¸ªé¡¹ç›®çš„æ•°æ®è¯»å†™é€»è¾‘çš„å®ç°ã€‚

ASP.NET Core å†…ç½® Entity Framework Core æ¥å¤„ç†æ•°æ®åº“ã€‚ EF Core æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„ (ORM) æ¡†æ¶ï¼Œå¯ä»¥ç®€åŒ–éœ€è¦ç¼–å†™çš„æ•°æ®è®¿é—®ä»£ç ã€‚

åœ¨è¿œå¤çš„ Windows ç¼–ç¨‹ä¸­ï¼Œæ•°æ®è®¿é—®æ˜¯ DAO - Data Access Object æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å½“äºç›´æ¥ä½¿ç”¨æ•°æ®åº“ API æ¥è¯»å†™æ•°æ®ï¼Œè¿™å®Œå…¨è·Ÿä¸ä¸Šç°ä»£çš„ç¼–ç¨‹æ¨¡å¼ã€‚ä¸€ä¸ªè§£å†³æ•°æ®åº“ä¸­é—´å±‚çš„æµè¡Œæ–¹æ³•å°±æ˜¯ï¼Œä½¿ç”¨ MO - Model Object å’Œ DTO - Data Transfer Objectï¼Œé€šè¿‡æ˜ å°„å°†å…³ç³»æ•°æ®è¡¨çš„è®°å½•è½¬æ¢æˆç¨‹åºä¸­çš„å¯¹è±¡ã€‚MO ç”¨æ¥è¡¨ç¤ºä»æ•°æ®åº“ä¸­è¯»å–çš„æ•°æ®ï¼Œè€Œ DTO ç”¨æ¥è¡¨ç¤ºåœ¨ç½‘ç»œä¸Šæ‰€ä¼ è¾“çš„æ•°æ®ã€‚

å¦‚æœè¦ä½¿ç”¨ä¾èµ–æ³¨å…¥ä½¿ç”¨æ•°æ®æœåŠ¡ï¼Œé»˜è®¤çš„ Web åº”ç”¨ä½¿ç”¨ Microsoft.Extensions.DependencyInjection åšä¾èµ–æ³¨å…¥ï¼ŒStartup ä¸­ä½¿ç”¨åˆ°çš„ IServiceCollection å°±æ˜¯ä¾èµ–æ³¨å…¥å®¹å™¨æ¥å£ï¼Œé€šè¿‡å®ƒæ¥æ³¨å…¥å„ç§æ¨¡å—ã€‚

AutoMapper å¯ä»¥ä½œä¸ºå¯¹è±¡æ˜ å°„å™¨ï¼Œå°†ä¸€ç§ç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„å¯¹è±¡ï¼Œç»§æ‰¿è‡ª DependencyInjectionã€‚å®ƒæä¾›äº†æ˜ å°„è§„åˆ™åŠæ“ä½œæ–¹æ³•ï¼Œä½¿æˆ‘ä»¬ä¸ç”¨è¿‡å¤šé…ç½®å°±å¯ä»¥æ˜ å°„ä¸¤ä¸ªç±», å¯ä»¥å¸®æˆ‘ä»¬å…äºç¼–å†™æ— èŠçš„æ˜ å°„ä»£ç ï¼Œåœ¨ä»£ç å±‚ä¸å±‚ä¹‹é—´éš”ç¦»æ¨¡å‹ä¸Šéå¸¸æœ‰ç”¨ã€‚

Entity Framework Core æ˜¯é€‚ç”¨äº .NET çš„æ–°å¼å¯¹è±¡æ•°æ®åº“æ˜ å°„å™¨ã€‚ å®ƒæ”¯æŒ LINQ æŸ¥è¯¢ã€æ›´æ”¹è·Ÿè¸ªã€æ›´æ–°å’Œæ¶æ„è¿ç§»ã€‚ EF Core é€‚ç”¨äºå¾ˆå¤šæ•°æ®åº“ï¼ŒåŒ…æ‹¬ SQL æ•°æ®åº“ï¼ˆæœ¬åœ°å’Œ Azureï¼‰ã€SQLiteã€MySQLã€PostgreSQL å’Œ Azure Cosmos DBã€‚

è¿™é‡Œä½¿ç”¨ MySql.Data è®¿é—® MySql æ•°æ®åº“ï¼Œé¦–å…ˆå‘é¡¹ç›®æ·»åŠ  NuGet åŒ…å¼•ç”¨ï¼Œå®Œæˆå csproj é¡¹ç›®æ–‡ä»¶å°±ä¼šåŒ…å« MySql.Data åŒ…çš„å¼•ç”¨ï¼Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŒ‰éœ€ä½¿ç”¨ï¼š

    dotnet add package MySql.Data --version 8.0.20

    dotnet add package Microsoft.Extensions.DependencyInjection --version 3.1.4
    dotnet add package AutoMapper.Extensions.Microsoft.DependencyInjection --version 7.0.0

ç„¶åä¿®æ”¹ä½ çš„ appsettings.json æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªè”æ¥å­—ç¬¦ä¸² ConnectionStrings è®¾ç½®ï¼š

    "ConnectionStrings": {
        "DefaultConnection": "server=127.0.0.1;userid=root;password=123456;database=dbname;"
    },

ç›¸åº”ä¿®æ”¹ Startup ä¸­çš„ ConfigureServices ä»¥ä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²ï¼Œå¹¶å°†åé¢è¦å®ç°çš„æ•°æ®ä¸Šä¸‹æ–‡å¯¹è±¡æ³¨å…¥ä½œä¸ºæ•°æ®æœåŠ¡ï¼š

    string cons = Configuration.GetConnectionString("DefaultConnection");
    services.Add(new ServiceDescriptor(typeof(UserContext), new UserContext(cons)));

åœ¨ç±»æ–‡ä»¶ä¸­å¼•ç”¨ç›¸åº”ç±»ç©ºé—´ï¼Œå¼€å§‹ç¼–å†™ä»£ç ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡æœåŠ¡ç±» UserContext ä»¥æ£€ç´¢æˆ–å†™å…¥æ•°æ®ï¼Œè¿™é‡ŒåªåšæŸ¥è¯¢ç¤ºä¾‹ã€‚è¿™é‡Œä½œä¸ºå†…åµŒç±» UserDTO æ ¹æ®æ•°æ®è¡¨å®šä¹‰äº†ç›¸åº”çš„æˆå‘˜ï¼Œå…¶ä¸­ ID ä½œä¸ºé™„åŠ æˆå‘˜ä¿å­˜ä¸€ä¸ª System.Guid æ ‡å¿—ï¼š

    using System;
    using System.Collections.Generic;
    using System.Text;
    using MySql.Data.MySqlClient;

    namespace myWebApp
    {

        public class UserDTO
        {
            public Guid ID { get; set; }
            public int id { get; set; }
            public string name { get; set; } = "";
            public string nickname { get; set; }
            public string email { get; set; }
            public int level { get; set; }
            public DateTime created_at { get; set; }
        }

        public class UserContext
        {
            public string ConnectionString { get; set; }
            public UserContext(string connectionString)
            {
                this.ConnectionString = connectionString;
            }

            private MySqlConnection GetConnection()
            {
                return new MySqlConnection(ConnectionString);
            }

            public List<UserDTO> GetAllUsers()
            {
                List<UserDTO> list = new List<UserDTO>();
                using (MySqlConnection msconnection = GetConnection())
                {
                    try {
                        msconnection.Open();
                    }catch{
                        Console.WriteLine("Error to connect database...");
                        return list;
                    }
                    MySqlCommand mscommand = new MySqlCommand("select id,name,nickname,email,level,created_at from users", msconnection);
                    using (MySqlDataReader reader = mscommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            list.Add(new UserDTO()
                            {
                                ID = Guid.NewGuid(),
                                id = reader.IsDBNull(reader.GetOrdinal("id"))? -1: reader.GetInt32("id"),
                                name = reader.IsDBNull(reader.GetOrdinal("name"))? null: reader.GetString("name"),
                                nickname = reader.IsDBNull(reader.GetOrdinal("nickname"))? null: reader.GetString("nickname"),
                                email = reader.IsDBNull(reader.GetOrdinal("email"))? null: reader.GetString("email"),
                                level = reader.IsDBNull(reader.GetOrdinal("level"))? -1: reader.GetInt32("level"),
                                created_at = reader.IsDBNull(reader.GetOrdinal("created_at"))? new DateTime(): reader.GetDateTime("created_at")
                            });
                        }
                    }
                }
                return list;
            }
        }

    }


ä¿®æ”¹è§†å›¾ç±» Index.cshtml.cs é€šè¿‡ HttpContext è·å–å‰é¢æ³¨å…¥çš„æ•°æ®æœåŠ¡æ¨¡å—ï¼Œå¹¶é€šè¿‡ data å¯¼å‡ºæ•°æ®ä¾›è§†å›¾æ¨¡æ¿ä½¿ç”¨ï¼š

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.RazorPages;
    using Microsoft.Extensions.Logging;
    using myWebApp;

    namespace myWebApp.Pages
    {
        public class IndexModel : PageModel
        {
            private readonly ILogger<IndexModel> _logger;

            [BindProperty]
            public List<UserDTO> data { get; set; }

            public IndexModel(ILogger<IndexModel> logger)
            {
                _logger = logger;
            }

            public void OnGet()
            {
                UserContext uc = HttpContext.RequestServices.GetService(typeof(UserContext)) as UserContext;
                data = uc.GetAllUsers();
                Console.WriteLine($"OnGet {data.Count} {data[0]}...");
            }
        }
    }


ä¿®æ”¹è§†å›¾æ¨¡æ¿ Index.cshtml ä»¥æ¸²æŸ“æ•°æ®ï¼Œé»˜è®¤çš„ Web åº”ç”¨ä½¿ç”¨äº† Bootstrap å‰ç«¯æ¡†æ¶ï¼Œå¯ä»¥è®¾ç½®è¡¨æ ¼çš„ç¾åŒ–æ ·å¼ï¼š

    @page
    @model IndexModel
    @{
        ViewData["Title"] = "Home page";
    }

    <div class="text-center">
        <h1 class="display-4">Welcome</h1>
        <p>Learn about <a href="https://docs.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
        <div class="jumbotron">

    <table class="table table-striped table-hover table-condensed">
        <tbody>
        @foreach (var item in Model.data) {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.nickname)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.email)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.level)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.created_at)
                </td>
                <td>
                    <a asp-page="./Edit" asp-route-id="@item.ID" asp-route-n="@item.name">Edit</a> |
                    <a asp-page="./Details" asp-route-id="@item.ID" asp-route-n="@item.name">Details</a> |
                    <a asp-page="./Delete" asp-route-id="@item.ID" asp-route-n="@item.name">Delete</a>
                </td>
            </tr>
        }
        </tbody>
    </table>

        </div>
    </div>


å…¶å®ƒåŠŸèƒ½é¡µé¢ Razor Page éª¨æ¶å¯ä»¥é€šè¿‡å‘½ä»¤æ·»åŠ ï¼š

    dotnet new page -o=Pages -na="Razor.Pages" -n="Edit"
    dotnet new page -o=Pages -na="Razor.Pages" -n="Details"
    dotnet new page -o=Pages -na="Razor.Pages" -n="Delete"




# =ğŸš© C# Language Specification
- [C# Guide](https://github.com/dotnet/docs/blob/main/docs/csharp)
- [C# Language Design](https://github.com/dotnet/csharplang)
- [C# Language Specification](https://github.com/dotnet/csharpstandard)
- [C# 8.0 draft specification](https://github.com/dotnet/csharpstandard/tree/draft-v8/standard)
- [C# 6.0 draft specification](https://github.com/dotnet/csharpstandard/tree/standard-v6/standard)

C# 6.0 draft specification

- [ Â§1](scope.md)  Scope
- [ Â§2](normative-references.md)  Normative references
- [ Â§3](terms-and-definitions.md)  Terms and definitions
- [ Â§4](general-description.md)  General description
- [ Â§5](conformance.md)  Conformance
- [ Â§6](lexical-structure.md)  Lexical structure
- [ Â§7](basic-concepts.md)  Basic concepts
- [ Â§8](types.md)  Types
- [ Â§9](variables.md)  Variables
- [Â§10](conversions.md)  Conversions
- [Â§11](expressions.md)  Expressions
- [Â§12](statements.md)  Statements
- [Â§13](namespaces.md)  Namespaces
- [Â§14](classes.md)  Classes
- [Â§15](structs.md)  Structs
- [Â§16](arrays.md)  Arrays
- [Â§17](interfaces.md)  Interfaces
- [Â§18](enums.md)  Enums
- [Â§19](delegates.md)  Delegates
- [Â§20](exceptions.md)  Exceptions
- [Â§21](attributes.md)  Attributes
- [Â§22](unsafe-code.md)  Unsafe code
- [ Â§A](grammar.md)  Grammar
- [ Â§B](portability-issues.md)  Portability issues
- [ Â§C](standard-library.md)  Standard library
- [ Â§D](documentation-comments.md)  Documentation comments
- [ Â§E](bibliography.md)  Bibliography



# =ğŸš© C# Features è¯­è¨€ç‰¹æ€§
- [C# Documentation](https://github.com/dotnet/docs/tree/main/docs/csharp)
- [C# Documentation](https://learn.microsoft.com/en-us/dotnet/csharp/)
- [C# language reference](https://github.com/dotnet/docs/blob/main/docs/csharp/language-reference/index.md)
- [C# language reference](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/)
- [The .NET Compiler Platform - Roslyn](https://github.com/dotnet/roslyn)
- [MSBuild](https://docs.microsoft.com/zh-cn/visualstudio/msbuild/msbuild)
- [HTTP/3 Support in .Net 6](https://devblogs.microsoft.com/dotnet/http-3-support-in-dotnet-6/)
- dotnet-docs\docs\csharp\whats-new\csharp-version-history.md


C# language specification:

| Version  |                      Description                       |
|----------|--------------------------------------------------------|
| C# 7.0 + | Not currently available                                |
| C# 6.0   | C# Language Specification Version 6 - Unofficial Draft |
| C# 5.0   | Standard ECMA-334 5th Edition                          |
| C# 3.0   | C# Language Specification Version 3.0                  |
| C# 2.0   | Standard ECMA-334 4th Edition                          |
| C# 1.2   | C# Language Specification Version 1.2                  |
| C# 1.0   | C# Language Specification Version 1.0                  |

Minimum SDK version needed to support all language features:

| C# version |                            Minimum SDK version                             |
|------------|----------------------------------------------------------------------------|
| C# 10      | Visual Studio/Build Tools 2022, or .NET 6 SDK                              |
| C# 9.0     | Visual Studio/Build Tools 2019, v16.8, or .NET 5 SDK                       |
| C# 8.0     | Visual Studio/Build Tools 2019, v16.3, or .NET Core 3.0 SDK                |
| C# 7.3     | Visual Studio/Build Tools 2017, v15.7                                      |
| C# 7.2     | Visual Studio/Build Tools 2017, v15.5                                      |
| C# 7.1     | Visual Studio/Build Tools 2017, v15.3                                      |
| C# 7.0     | Visual Studio/Build Tools 2017                                             |
| C# 6       | Visual Studio/Build Tools 2015                                             |
| C# 5       | Visual Studio/Build Tools 2012 or bundled .NET Framework 4.5 compiler      |
| C# 4       | Visual Studio/Build Tools 2010 or bundled .NET Framework 4.0 compiler      |
| C# 3       | Visual Studio/Build Tools 2008 or bundled .NET Framework 3.5 compiler      |
| C# 2       | Visual Studio/Build Tools 2005 or bundled .NET Framework 2.0 compiler      |
| C# 1.0/1.2 | Visual Studio/Build Tools .NET 2002 or bundled .NET Framework 1.0 compiler |


å„ä¸ª .NET ç‰ˆæœ¬é»˜è®¤çš„ C# è¯­è¨€ç‰ˆæœ¬å…³ç³»ï¼Œä»¥åŠå„ç‰ˆæœ¬çš„ç‰¹æ€§ï¼š

| C# Ver. |     .NET Version     |    Date    |                 Features                 |
|---------|----------------------|------------|------------------------------------------|
| C# 1.0  | .NET Framework 1.0   | 2002-02-13 | å§”æ‰˜ã€äº‹ä»¶                                |
| C# 1.1  | .NET Framework 1.1   | 2003-04-24 | APMï¼ˆå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼‰                       |
| C# 2.0  | .NET Framework 2.0   | 2005-11-07 | æ³›å‹ã€åŒ¿åæ–¹æ³•ã€è¿­ä»£å™¨ã€å¯ç©ºç±»å‹             |
|---------|----------------------|------------|-----------------------------------------|
| C# 3.0  | .NET Framework 3.0   | 2007-11-06 | éšå¼ç±»å‹                                 |
|         | .NET Framework 3.5   | 2007-11-19 | å¯¹è±¡é›†åˆåˆå§‹åŒ–ã€è‡ªåŠ¨å®ç°å±æ€§ã€åŒ¿åç±»å‹ã€æ‰©å±•æ–¹æ³•ã€æŸ¥è¯¢è¡¨è¾¾å¼ã€Lambda è¡¨è¾¾å¼ã€ è¡¨è¾¾å¼æ ‘ã€åˆ†éƒ¨ç±»å’Œæ–¹æ³•ã€Linq|
|---------|----------------------|------------|-----------------------------------------|
| C# 4.0  | .NET Framework 4.0   | 2010-04-12 | åŠ¨æ€ç»‘å®šã€å‘½åå’Œå¯é€‰å‚æ•°ã€æ³›å‹çš„åå˜å’Œé€†å˜ã€äº’æ“ä½œæ€§|
| C# 5.0  | .NET Framework 4.5   | 2012-08-15 | asyncã€awaitã€Caller Information         |
|---------|----------------------|------------|-----------------------------------------|
| C# 6.0  | .NET Framework 4.6   | 2015-07-20 | é™æ€å¯¼å…¥ã€C# 6 ä¸­çš„æ–°å¢åŠŸèƒ½               |
|         | .NET Core 1.0        | 2016-06-27 |                                         |
|---------|----------------------|------------|-----------------------------------------|
| C# 7.0  | .NET Framework 4.6.2 | 2016-08-02 | å…ƒç»„ã€C# 7.0 ä¸­çš„æ–°å¢åŠŸèƒ½                 |
|---------|----------------------|------------|-----------------------------------------|
| C# 7.1  | .NET Framework 4.7   | 2017-04-05 |                                         |
|         | .NET Core 2.0        | 2016-08-14 | .NET Core 2.0 çš„æ–°å¢åŠŸèƒ½                 |
|---------|----------------------|------------|-----------------------------------------|
| C# 7.2  | .NET Framework 4.7.1 | 2017-10-17 |                                         |
|---------|----------------------|------------|-----------------------------------------|
| C# 7.3  | .NET Framework 4.7.2 | 2018-04-30 |                                         |
|         | .NET Core 2.1        | 2018-05-30 | .NET Core 2.1 çš„æ–°å¢åŠŸèƒ½                 |
|         | .NET Core 2.2        | 2018-12-04 | .NET Core 2.2 çš„æ–°å¢åŠŸèƒ½                 |
|---------|----------------------|------------|-----------------------------------------|
| C# 8.0  | .NET Framework 4.8   | 2019-04-18 | C# 8.0 ä¸­çš„æ–°å¢åŠŸèƒ½                      |
|         | .NET Core 3.0        | 2019-09-23 | .NET Core 3.0 çš„æ–°å¢åŠŸèƒ½                 |
|         | .NET Core 3.1        | 2019-12-03 | .NET Core 3.1 çš„æ–°å¢åŠŸèƒ½                 |
|---------|----------------------|------------|-----------------------------------------|
| C# 9.0  | .NET 5               | 2020-09-04 | C# 9.0 ä¸­çš„æ–°å¢åŠŸèƒ½                      |
|         | .NET 5               | 2020-10-13 | What's new in .NET 5                    |
|---------|----------------------|------------|-----------------------------------------|
| C# 10.0 | .NET 6               | 2021-11-09 | C# 10 C# 10.0 ä¸­çš„æ–°å¢åŠŸèƒ½               |

The compiler determines a default based on these rules:

| Target framework | version | C# version default |
|------------------|---------|--------------------|
| .NET             | 6.x     | C# 10              |
| .NET             | 5.x     | C# 9.0             |
| .NET Core        | 3.x     | C# 8.0             |
| .NET Core        | 2.x     | C# 7.3             |
| .NET Standard    | 2.1     | C# 8.0             |
| .NET Standard    | 2.0     | C# 7.3             |
| .NET Standard    | 1.x     | C# 7.3             |
| .NET Framework   | all     | C# 7.3             |

.NET 5 æ˜¯ç»§ 3.1 ä¹‹å .NET Core çš„ä¸‹ä¸€ä¸ªä¸»è¦ç‰ˆæœ¬ã€‚ æ–°ç‰ˆæœ¬å‘½ååˆ é™¤ Core å­—æ ·å‡ºäºä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

- è·³è¿‡äº†ç‰ˆæœ¬ç¼–å· 4.xï¼Œä»¥é¿å…ä¸ .NET Framework 4.x æ··æ·†ã€‚
- ä»åç§°ä¸­åˆ é™¤äº†â€œCoreâ€ï¼Œæ˜¯ä¸ºäº†å¼ºè°ƒè¿™æ˜¯ .NET æœªæ¥çš„ä¸»è¦å®ç°ã€‚

ä¸ .NET Core æˆ– .NET Framework ç›¸æ¯”ï¼Œ.NET 5 ä¼šæ”¯æŒç±»å‹æ›´å¤šçš„åº”ç”¨å’Œå¹³å°ã€‚

ASP.NET Core 5.0 è™½ä»¥ .NET 5 ä¸ºåŸºç¡€ï¼Œä½†ä¿ç•™äº†åç§°â€œCoreâ€ä»¥é¿å…ä¸ ASP.NET MVC 5 æ··æ·†ã€‚ åŒç†ï¼ŒEntity Framework Core 5.0 ä¿ç•™äº†åç§°â€œCoreâ€ï¼Œä»¥é¿å…ä¸ Entity Framework 5 å’Œ Entity Framework 6 æ··æ·†ã€‚


C# ç‰ˆæœ¬ç‰¹æ€§è¿›åŒ–

- C# 8.0 å¢å¼ºåŠŸèƒ½

    https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-8

    - Readonly æˆå‘˜
    - é»˜è®¤æ¥å£æ–¹æ³•
    - æ¨¡å¼åŒ¹é…å¢å¼ºåŠŸèƒ½ï¼š
        - Switch è¡¨è¾¾å¼
        - å±æ€§æ¨¡å¼
        - å…ƒç»„æ¨¡å¼
        - ä½ç½®æ¨¡å¼
    - Using å£°æ˜
    - é™æ€æœ¬åœ°å‡½æ•°
    - å¯å¤„ç½®çš„ ref ç»“æ„
    - å¯ä¸ºç©ºå¼•ç”¨ç±»å‹
    - å¼‚æ­¥æµ
    - å¼‚æ­¥å¯é‡Šæ”¾
    - ç´¢å¼•å’ŒèŒƒå›´
    - Null åˆå¹¶èµ‹å€¼
    - éæ‰˜ç®¡æ„é€ ç±»å‹
    - åµŒå¥—è¡¨è¾¾å¼ä¸­çš„ Stackalloc
    - å†…æ’é€å­—å­—ç¬¦ä¸²çš„å¢å¼ºåŠŸèƒ½

     .NET Core 3.x å’Œ .NET Standard 2.1 æ”¯æŒ C# 8.0 ã€‚

    æ–°å¢çš„åŒ¹é…æ¨¡å¼ Pattern matching æ˜¯ä¸ºäº†ç®€åŒ–åµŒå¥— if-else ç»“æ„çš„ï¼š

        static decimal GetTicket_Pattern(string sex, int age, string area)
        {
            return (sex, age, area) switch
            {
                ("ç”·", < 20, "å®‰å¾½") => 2000,
                ("ç”·", < 40, "ä¸Šæµ·") => 4000,
                ("ç”·", _, _) => 3000,
                ("å¥³", < 20, "å®‰å¾½") => 2500,
                ("å¥³", < 60, "å®‰å¾½") => 1500,
                _ => 0
            };
        }
    
    æ¯”å¦‚è¦æŸ¥çœ‹ä¸Šæµ·å°äº 20 å²ç”·æ€§çš„æ•°æ®ï¼Œä¸Šé¢çš„ switch ä¼šè‡ªåŠ¨æ‰§è¡ŒåŒ¹é…æ¨¡å¼æŸ¥æ‰¾æ•°æ®ã€‚å®ƒç›¸åº”ç”Ÿæˆçš„ä¹Ÿæ˜¯ if-else è¯­å¥ï¼Œåªä¸è¿‡åŒ¹é…æ¨¡å¼è§’åŒ–äº†å†™æ³•ã€‚

- C# 7.0 æ–°åŠŸèƒ½

    https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-7

    - out å˜é‡ å¯ä»¥å†…è”ä½œä¸ºå‚æ•°å£°æ˜åˆ°ä½¿ç”¨è¿™äº›å‚æ•°çš„æ–¹æ³•ä¸­ã€‚
    - Tuple å…ƒç»„ å¯ä»¥åˆ›å»ºåŒ…å«å¤šä¸ªå…¬å…±å­—æ®µçš„è½»é‡çº§æœªå‘½åç±»å‹ã€‚ ç¼–è¯‘å™¨å’Œ IDE å·¥å…·å¯ç†è§£è¿™äº›ç±»å‹çš„è¯­ä¹‰ã€‚
    - å¼ƒå…ƒ æŒ‡åœ¨ä¸å…³å¿ƒæ‰€èµ‹äºˆçš„å€¼æ—¶ï¼Œèµ‹å€¼ä¸­ä½¿ç”¨çš„ä¸´æ—¶åªå†™å˜é‡ã€‚ åœ¨å¯¹å…ƒç»„å’Œç”¨æˆ·å®šä¹‰ç±»å‹è¿›è¡Œè§£æ„ï¼Œä»¥åŠåœ¨ä½¿ç”¨ out å‚æ•°è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå®ƒä»¬çš„ä½œç”¨æœ€å¤§ã€‚
    - æ¨¡å¼åŒ¹é… å¯ä»¥åŸºäºä»»æ„ç±»å‹å’Œè¿™äº›ç±»å‹çš„æˆå‘˜çš„å€¼åˆ›å»ºåˆ†æ”¯é€»è¾‘ã€‚
    - ref å±€éƒ¨å˜é‡å’Œè¿”å›ç»“æœ æ–¹æ³•å±€éƒ¨å‚æ•°å’Œè¿”å›å€¼å¯ä»¥æ˜¯å¯¹å…¶ä»–å­˜å‚¨çš„å¼•ç”¨ã€‚
    - æœ¬åœ°å‡½æ•° å¯ä»¥å°†å‡½æ•°åµŒå¥—åœ¨å…¶ä»–å‡½æ•°å†…ï¼Œä»¥é™åˆ¶å…¶èŒƒå›´å’Œå¯è§æ€§ã€‚
    - æ›´å¤šçš„ expression-bodied æˆå‘˜ å¯ä½¿ç”¨è¡¨è¾¾å¼åˆ›ä½œçš„æˆå‘˜åˆ—è¡¨æœ‰æ‰€å¢é•¿ã€‚
    - throw è¡¨è¾¾å¼ å¯ä»¥åœ¨ä¹‹å‰å› ä¸º throw æ˜¯è¯­å¥è€Œä¸è¢«å…è®¸çš„ä»£ç æ„é€ ä¸­å¼•å‘å¼‚å¸¸ã€‚
    - é€šç”¨çš„å¼‚æ­¥è¿”å›ç±»å‹ ä½¿ç”¨ async ä¿®é¥°ç¬¦å£°æ˜çš„æ–¹æ³•å¯ä»¥è¿”å›é™¤ Task å’Œ Task<T> ä»¥å¤–çš„å…¶ä»–ç±»å‹ã€‚
    - æ•°å­—æ–‡æœ¬è¯­æ³•æ”¹è¿› æ–°ä»¤ç‰Œå¯æé«˜æ•°å€¼å¸¸é‡çš„å¯è¯»æ€§ã€‚

- C# 6.0 ç‰ˆæœ¬åŒ…å«è®¸å¤šå¯æé«˜å¼€å‘äººå‘˜å·¥ä½œæ•ˆç‡çš„åŠŸèƒ½

    https://docs.microsoft.com/zh-cn/dotnet/csharp/whats-new/csharp-6

    C# 6.0 ç‰ˆæœ¬åŒ…å«è®¸å¤šå¯æé«˜å¼€å‘äººå‘˜å·¥ä½œæ•ˆç‡çš„åŠŸèƒ½ã€‚ è¿™äº›åŠŸèƒ½çš„æ€»ä½“æ•ˆæœæ˜¯è®©ä½ ç¼–å†™çš„ä»£ç æ›´ç®€æ´ã€æ›´å…·å¯è¯»æ€§ã€‚ è¯¥è¯­æ³•ä¸åƒè®¸å¤šå¸¸è§åšæ³•é‚£æ ·ç¹çã€‚ å¯ä»¥æ›´è½»æ¾åœ°çœ‹å‡ºè®¾è®¡æ„å›¾ã€‚ å¥½å¥½äº†è§£è¿™äº›åŠŸèƒ½å¯ä»¥å¸®åŠ©ä½ æé«˜ç”Ÿäº§åŠ›ï¼Œç¼–å†™æ›´å…·å¯è¯»æ€§çš„ä»£ç ã€‚ ä½ å¯ä»¥æ›´ä¸“æ³¨äºåŠŸèƒ½ï¼Œè€Œä¸æ˜¯è¯­è¨€çš„æ„é€ ã€‚

    - Compiler-as-a-service (Roslyn)
    - Import of static type members into namespace æ”¯æŒä»…å¯¼å…¥ç±»ä¸­çš„é™æ€æˆå‘˜
    - Exception filters å¼‚å¸¸è¿‡æ»¤å™¨
    - Await in catch/finally blocks æ”¯æŒåœ¨catch/finallyè¯­å¥å—ä½¿ç”¨awaitè¯­å¥
    - Auto property initializers è‡ªåŠ¨å±æ€§åˆå§‹åŒ–
    - Default values for getter-only properties è®¾ç½®åªè¯»å±æ€§çš„é»˜è®¤å€¼
    - Expression-bodied members æ”¯æŒä»¥è¡¨è¾¾å¼ä¸ºä¸»ä½“çš„æˆå‘˜æ–¹æ³•å’Œåªè¯»å±æ€§
    - Null propagator (null-conditional operator, succinct null checking) Nullæ¡ä»¶æ“ä½œç¬¦
    - String interpolation å­—ç¬¦ä¸²æ’å€¼ï¼Œäº§ç”Ÿç‰¹å®šæ ¼å¼å­—ç¬¦ä¸²çš„æ–°æ–¹æ³•
    - nameof operator nameofæ“ä½œç¬¦ï¼Œè¿”å›æ–¹æ³•ã€å±æ€§ã€å˜é‡çš„åç§°
    - åªè¯»è‡ªåŠ¨å±æ€§
    - è‡ªåŠ¨å±æ€§åˆå§‹åŒ–è¡¨è¾¾å¼
    - Expression-bodied å‡½æ•°æˆå‘˜
    - using static
    - Null æ¡ä»¶è¿ç®—ç¬¦
    - å­—ç¬¦ä¸²å†…æ’
    - å¼‚å¸¸ç­›é€‰å™¨
    - nameof è¡¨è¾¾å¼
    - Catch å’Œ Finally å—ä¸­çš„ Await
    - ä½¿ç”¨ç´¢å¼•å™¨åˆå§‹åŒ–å…³è”é›†åˆ
    - é›†åˆåˆå§‹å€¼è®¾å®šé¡¹ä¸­çš„æ‰©å±• Add æ–¹æ³•
    - æ”¹è¿›äº†é‡è½½è§£æ
    - Dictionary initializer å­—å…¸åˆå§‹åŒ–


- C# 3.0 ç‰¹æ€§ (VS 2008)

    - Implicitly typed local variables  æœ¬åœ° var ç±»å‹æ¨ç†
    - Object and collection initializers    å¯¹è±¡å’Œé›†åˆåˆå§‹åŒ–å™¨
    - Auto-Implemented properties   è‡ªåŠ¨å±æ€§ï¼Œè‡ªåŠ¨ç”Ÿæˆå±æ€§æ–¹æ³•ï¼Œå£°æ˜æ›´ç®€æ´
    - Anonymous types   åŒ¿åç±»å‹
    - Extension methods æ‰©å±•æ–¹æ³•
    - Query expressions æŸ¥è¯¢è¡¨è¾¾å¼ï¼Œè¯­è¨€é›†æˆæŸ¥è¯¢ (LINQ)
    - Lambda expression Lambdaè¡¨è¾¾å¼
    - Expression trees  è¡¨è¾¾å¼æ ‘ï¼Œä»¥æ ‘å½¢æ•°æ®ç»“æ„è¡¨ç¤ºä»£ç ï¼Œæ˜¯ä¸€ç§æ–°æ•°æ®ç±»å‹
    - Partial methods   éƒ¨åˆ†æ–¹æ³•


- C# 2 ç‰¹æ€§ (VS 2005)

    - Generics  æ³›å‹
    - Partial types åˆ†éƒ¨ç±»å‹ï¼Œå¯ä»¥å°†ç±»ã€ç»“æ„ã€æ¥å£ç­‰ç±»å‹å®šä¹‰æ‹†åˆ†åˆ°å¤šä¸ªæ–‡ä»¶ä¸­
    - Anonymous methods åŒ¿åæ–¹æ³•
    - iterators è¿­ä»£å™¨
    - Nullable types    å¯ä»¥ä¸ºNullçš„ç±»å‹ï¼Œè¯¥ç±»å¯ä»¥æ˜¯å…¶å®ƒå€¼æˆ–è€…null
    - Getter/Setter separate accessibility  å±æ€§è®¿é—®æ§åˆ¶
    - Method group conversions (delegates)  æ–¹æ³•ç»„è½¬æ¢ï¼Œå¯ä»¥å°†å£°æ˜å§”æ‰˜ä»£è¡¨ä¸€ç»„æ–¹æ³•ï¼Œéšå¼è°ƒç”¨
    - Covariance and contravariance for delegates and interfaces    å§”æ‰˜ã€æ¥å£çš„åå˜å’Œé€†å˜
    - Static classes    é™æ€ç±»
    - Delegate inference    å§”æ‰˜æ¨æ–­ï¼Œå…è®¸å°†æ–¹æ³•åç›´æ¥èµ‹ç»™å§”æ‰˜å˜é‡


- C# 1.0 ç‰¹æ€§

    Visual Studio .NET 2002 ä¸€èµ·å‘å¸ƒçš„ C# 1.0 éå¸¸åƒ Javaã€‚ åœ¨ ECMA åˆ¶å®šçš„è®¾è®¡ç›®æ ‡ä¸­ï¼Œå®ƒæ—¨åœ¨æˆä¸ºä¸€ç§â€œç®€å•ã€ç°ä»£ã€é¢å‘å¯¹è±¡çš„å¸¸è§„ç”¨é€”è¯­è¨€â€ã€‚ å½“æ—¶ï¼Œå®ƒå’Œ Java ç±»ä¼¼ï¼Œè¯´æ˜å·²ç»å®ç°äº†ä¸Šè¿°æ—©æœŸè®¾è®¡ç›®æ ‡ã€‚

    - Classes   é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ”¯æŒç±»ç±»å‹
    - Structs   ç»“æ„
    - Interfaces    æ¥å£
    - Events    äº‹ä»¶
    - Properties    å±æ€§ï¼Œç±»çš„æˆå‘˜ï¼Œæä¾›è®¿é—®å­—æ®µçš„çµæ´»æ–¹æ³•
    - Delegates å§”æ‰˜,ä¸€ç§å¼•ç”¨ç±»å‹ï¼Œè¡¨ç¤ºå¯¹å…·æœ‰ç‰¹å®šå‚æ•°åˆ—è¡¨å’Œè¿”å›ç±»å‹çš„æ–¹æ³•çš„å¼•ç”¨
    - Expressions,Statements,Operators  è¡¨è¾¾å¼ã€è¯­å¥ã€æ“ä½œç¬¦
    - Attributes    ç‰¹æ€§ï¼Œä¸ºç¨‹åºä»£ç æ·»åŠ å…ƒæ•°æ®æˆ–å£°æ˜æ€§ä¿¡æ¯ï¼Œè¿è¡Œæ—¶ï¼Œé€šè¿‡åå°„å¯ä»¥è®¿é—®ç‰¹æ€§ä¿¡æ¯
    - Literals  å­—é¢å€¼ï¼ˆæˆ–ç†è§£ä¸ºå¸¸é‡å€¼ï¼‰ï¼ŒåŒºåˆ«å¸¸é‡ï¼Œå¸¸é‡æ˜¯å’Œå˜é‡ç›¸å¯¹çš„

ç‰ˆæœ¬å†å²æ–‡æ¡£å¯ä»¥åœ¨ GitHub ä¸Šçš„ dotnet/roslyn å­˜å‚¨åº“ä¸Šæ‰¾åˆ°è¯¦ç»†çš„è¯­è¨€åŠŸèƒ½çŠ¶æ€ï¼ŒåŒ…æ‹¬è€ƒè™‘åœ¨å³å°†å‘å¸ƒçš„ç‰ˆæœ¬ä¸­æ·»åŠ çš„åŠŸèƒ½ã€‚


## ==âš¡ C# Keywords
- https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords
- https://github.com/dotnet/docs/blob/main/docs/csharp/language-reference/keywords/index.md
- dotnet-docs\docs\csharp\language-reference\keywords\index.md

Keywords are predefined, reserved identifiers that have special meanings to the compiler. They cannot be used as identifiers in your program unless they include `@` as a prefix. For example, `@if` is a valid identifier, but `if` is not because `if` is a keyword.

The first table in this topic lists keywords that are reserved identifiers in any part of a C# program. The second table in this topic lists the contextual keywords in C#. Contextual keywords have special meaning only in a limited program context and can be used as identifiers outside that context. Generally, as new keywords are added to the C# language, they are added as contextual keywords in order to avoid breaking programs written in earlier versions.

:::row:::
    :::column:::
        [abstract](keywords/abstract.md)  
        [as](../operators/type-testing-and-cast.md#as-operator)  
        [base](keywords/base.md)  
        [bool](../builtin-types/bool.md)  
        [break](../statements/jump-statements.md#the-break-statement)  
        [byte](../builtin-types/integral-numeric-types.md)  
        [case](../statements/selection-statements.md#the-switch-statement)  
        [catch](keywords/try-catch.md)  
        [char](../builtin-types/char.md)  
        [checked](keywords/checked.md)  
        [class](keywords/class.md)  
        [const](keywords/const.md)  
        [continue](../statements/jump-statements.md#the-continue-statement)  
        [decimal](../builtin-types/floating-point-numeric-types.md)  
        [default](keywords/default.md)  
        [delegate](../builtin-types/reference-types.md)  
        [do](../statements/iteration-statements.md#the-do-statement)  
        [double](../builtin-types/floating-point-numeric-types.md)  
        [else](../statements/selection-statements.md#the-if-statement)  
        [enum](../builtin-types/enum.md)  
    :::column-end:::
    :::column:::
        [event](keywords/event.md)  
        [explicit](../operators/user-defined-conversion-operators.md)  
        [extern](keywords/extern.md)  
        [false](../builtin-types/bool.md)  
        [finally](keywords/try-finally.md)  
        [fixed](keywords/fixed-statement.md)  
        [float](../builtin-types/floating-point-numeric-types.md)  
        [for](../statements/iteration-statements.md#the-for-statement)  
        [foreach](../statements/iteration-statements.md#the-foreach-statement)  
        [goto](../statements/jump-statements.md#the-goto-statement)  
        [if](../statements/selection-statements.md#the-if-statement)  
        [implicit](../operators/user-defined-conversion-operators.md)  
        [in](keywords/in.md)  
        [int](../builtin-types/integral-numeric-types.md)  
        [interface](keywords/interface.md)  
        [internal](keywords/internal.md)  
        [is](../operators/is.md)  
        [lock](../statements/lock.md)  
        [long](../builtin-types/integral-numeric-types.md)  
    :::column-end:::
    :::column:::
        [namespace](keywords/namespace.md)  
        [new](../operators/new-operator.md)  
        [null](keywords/null.md)  
        [object](../builtin-types/reference-types.md)  
        [operator](../operators/operator-overloading.md)  
        [out](keywords/out.md)  
        [override](keywords/override.md)  
        [params](keywords/params.md)  
        [private](keywords/private.md)  
        [protected](keywords/protected.md)  
        [public](keywords/public.md)  
        [readonly](keywords/readonly.md)  
        [ref](keywords/ref.md)  
        [return](../statements/jump-statements.md#the-return-statement)  
        [sbyte](../builtin-types/integral-numeric-types.md)  
        [sealed](keywords/sealed.md)  
        [short](../builtin-types/integral-numeric-types.md)  
        [sizeof](../operators/sizeof.md)  
        [stackalloc](../operators/stackalloc.md)  
    :::column-end:::
    :::column:::
        [static](keywords/static.md)  
        [string](../builtin-types/reference-types.md)  
        [struct](../builtin-types/struct.md)  
        [switch](../operators/switch-expression.md)  
        [this](keywords/this.md)  
        [throw](keywords/throw.md)  
        [true](../builtin-types/bool.md)  
        [try](keywords/try-catch.md)  
        [typeof](../operators/type-testing-and-cast.md#typeof-operator)  
        [uint](../builtin-types/integral-numeric-types.md)  
        [ulong](../builtin-types/integral-numeric-types.md)  
        [unchecked](keywords/unchecked.md)  
        [unsafe](keywords/unsafe.md)  
        [ushort](../builtin-types/integral-numeric-types.md)  
        [using](keywords/using.md)  
        [virtual](keywords/virtual.md)  
        [void](../builtin-types/void.md)  
        [volatile](keywords/volatile.md)  
        [while](../statements/iteration-statements.md#the-while-statement)  
    :::column-end:::
:::row-end:::

Contextual keywords

A contextual keyword is used to provide a specific meaning in the code, but it is not a reserved word in C#. Some contextual keywords, such as `partial` and `where`, have special meanings in two or more contexts.

:::row:::
    :::column:::
        [add](keywords/add.md)  
        [and](../operators/patterns.md#logical-patterns)  
        [alias](keywords/extern-alias.md)  
        [ascending](keywords/ascending.md)  
        [args](../../fundamentals/program-structure/top-level-statements.md#args)  
        [async](keywords/async.md)  
        [await](../operators/await.md)  
        [by](keywords/by.md)  
        [descending](keywords/descending.md)  
        [dynamic](../builtin-types/reference-types.md)  
        [equals](keywords/equals.md)  
        [from](keywords/from-clause.md)  
    :::column-end:::
    :::column:::
        [get](keywords/get.md)  
        [global](../operators/namespace-alias-qualifier.md)  
        [group](keywords/group-clause.md)  
        [init](keywords/init.md)  
        [into](keywords/into.md)  
        [join](keywords/join-clause.md)  
        [let](keywords/let-clause.md)  
        [managed (keywords/function pointer calling convention)](../unsafe-code.md#function-pointers)  
        [nameof](../operators/nameof.md)  
        [nint](../builtin-types/nint-nuint.md)  
        [not](../operators/patterns.md#logical-patterns)  
    :::column-end:::
    :::column:::
        [notnull](../../programming-guide/generics/constraints-on-type-parameters.md#notnull-constraint)  
        [nuint](../builtin-types/nint-nuint.md)  
        [on](keywords/on.md)  
        [or](../operators/patterns.md#logical-patterns)  
        [orderby](keywords/orderby-clause.md)  
        [partial (/type)](keywords/partial-type.md)  
        [partial (/method)](keywords/partial-method.md)  
        [record](../../fundamentals/types/records.md)  
        [remove](keywords/remove.md)  
        [select](keywords/select-clause.md)  
    :::column-end:::
    :::column:::
        [set](keywords/set.md)  
        [unmanaged (/function pointer calling convention)](../unsafe-code.md#function-pointers)  
        [unmanaged (/generic type constraint)](../../programming-guide/generics/constraints-on-type-parameters.md#unmanaged-constraint)  
        [value](keywords/value.md)  
        [var](keywords/var.md)  
        [when (filter condition)](keywords/when.md)  
        [where (generic type constraint)](keywords/where-generic-type-constraint.md)  
        [where (query clause)](keywords/where-clause.md)  
        [with](../operators/with-expression.md)  
        [yield](keywords/yield.md)  
    :::column-end:::
:::row-end:::


## ==âš¡ Pattern Matching
- [Tutorial: Build algorithms with pattern matching](fundamentals/tutorials/pattern-matching.md)
- [Pattern matching overview - C# guide](fundamentals/functional/pattern-matching.md)
- [Patterns - C# reference](language-reference/operators/patterns.md)

*Pattern matching* is a technique where you test an expression to determine if it has certain characteristics. C# pattern matching provides more concise syntax for testing expressions and taking action when an expression matches.

    # Pattern matching overview
    - Null checks
    - Type tests
    - Compare discrete values
    - Relational patterns
    - Multiple inputs

C# introduced pattern matching in C# 7.0. Since then, each major C# version extends pattern matching capabilities. The following C# expressions and statements support pattern matching:

- [`is` expression](operators/is.md)
- `switch` [statement](../statements/selection-statements.md#the-switch-statement)
- `switch` [expression](operators/switch-expression.md) (introduced in C# 8.0)

In those constructs, you can match an input expression against any of the following patterns:

- [Declaration pattern](operators/patterns.md#declaration-and-type-patterns): 
   to check the run-time type of an expression and, if a match succeeds, assign an expression result to a declared variable. Introduced in C# 7.0.
     
- [Type pattern](operators/patterns.md#declaration-and-type-patterns): 
   to check the run-time type of an expression. Introduced in C# 9.0.
     
- [Constant pattern](operators/patterns.md#constant-pattern): 
   to test if an expression result equals a specified constant. Introduced in C# 7.0.
     
- [Relational patterns](operators/patterns.md#relational-patterns): 
   to compare an expression result with a specified constant. Introduced in C# 9.0.
     
- [Logical patterns](operators/patterns.md#logical-patterns): 
   to test if an expression matches a logical combination of patterns. Introduced in C# 9.0.
     
- [Property pattern](operators/patterns.md#property-pattern): 
   to test if an expression's properties or fields match nested patterns. Introduced in C# 8.0.
     
- [Positional pattern](operators/patterns.md#positional-pattern): 
   to deconstruct an expression result and test if the resulting values match nested patterns. Introduced in C# 8.0.
     
- [`var` pattern](operators/patterns.md#var-pattern): 
   to match any expression and assign its result to a declared variable. Introduced in C# 7.0.
     
- [Discard pattern](operators/patterns.md#discard-pattern): 
   to match any expression. Introduced in C# 8.0.
     

[Logical](operators/patterns.md#logical-patterns), [property](operators/patterns.md#property-pattern), and [positional](operators/patterns.md#positional-pattern) patterns are *recursive* patterns. That is, they can contain *nested* patterns.

For the example of how to use those patterns to build a data-driven algorithm, see [Tutorial: Use pattern matching to build type-driven and data-driven algorithms](../../fundamentals/tutorials/pattern-matching.md).

```sh
# dotnet-docs\docs\csharp\fundamentals\tutorials\pattern-matching.md
:::code language="csharp" source="start/toll-calculator/ExternalSystems.cs":::
:::code language="csharp" source="finished/toll-calculator/TollCalculator.cs" ID="IsWeekDay":::
:::code language="csharp" source="finished/toll-calculator/TollCalculator.cs" ID="GetTimeBand":::
:::code language="csharp" source="finished/toll-calculator/TollCalculator.cs" ID="TuplePatternOne":::
:::code language="csharp" source="finished/toll-calculator/TollCalculator.cs" id="FinalTuplePattern":::
# dotnet-docs\docs\csharp\language-reference\operators\patterns.md
:::code language="csharp" source="DeclarationAndTypePatterns.cs" id="BasicExample":::
:::code language="csharp" source="DeclarationAndTypePatterns.cs" id="ReferenceConversion":::
:::code language="csharp" source="DeclarationAndTypePatterns.cs" id="NullableAndUnboxing":::
:::code language="csharp" source="DeclarationAndTypePatterns.cs" id="DiscardVariable":::
:::code language="csharp" source="DeclarationAndTypePatterns.cs" id="TypePattern":::
:::code language="csharp" source="ConstantPattern.cs" id="BasicExample":::
:::code language="csharp" source="ConstantPattern.cs" id="NullCheck":::
:::code language="csharp" source="ConstantPattern.cs" id="NonNullCheck":::
:::code language="csharp" source="RelationalPatterns.cs" id="BasicExample":::
:::code language="csharp" source="RelationalPatterns.cs" id="WithCombinators":::
:::code language="csharp" source="LogicalPatterns.cs" id="NotPattern":::
:::code language="csharp" source="LogicalPatterns.cs" id="AndPattern":::
:::code language="csharp" source="LogicalPatterns.cs" id="OrPattern":::
:::code language="csharp" source="LogicalPatterns.cs" id="WithParentheses":::
:::code language="csharp" source="PropertyPattern.cs" id="BasicExample":::
:::code language="csharp" source="PropertyPattern.cs" id="WithTypeCheck":::
:::code language="csharp" source="PropertyPattern.cs" id="RecursivePropertyPattern":::
:::code language="csharp" source="PropertyPattern.cs" id="ExtendedPropertyPattern":::
:::code language="csharp" source="PositionalPattern.cs" id="BasicExample":::
:::code language="csharp" source="PositionalPattern.cs" id="MatchTuple":::
:::code language="csharp" source="PositionalPattern.cs" id="UseIdentifiers":::
:::code language="csharp" source="PositionalPattern.cs" id="WithTypeCheck":::
:::code language="csharp" source="PositionalPattern.cs" id="WithPropertyPattern":::
:::code language="csharp" source="PositionalPattern.cs" id="CompletePositionalPattern":::
:::code language="csharp" source="VarPattern.cs" id="KeepInterimResult":::
:::code language="csharp" source="VarPattern.cs" id="WithCaseGuards":::
:::code language="csharp" source="DiscardPattern.cs" id="BasicExample":::
:::code language="csharp" source="LogicalPatterns.cs" id="ChangedPrecedence":::
# dotnet-docs\docs\csharp\fundamentals\functional\pattern-matching.md
:::code language="csharp" source="Program.cs" ID="NullableCheck":::
:::code language="csharp" source="Program.cs" ID="NullReferenceCheck":::
:::code language="csharp" source="Program.cs" ID="MidPoint":::
:::code language="csharp" source="Simulation.cs" ID="PerformOperation":::
:::code language="csharp" source="Simulation.cs" ID="PerformStringOperation":::
:::code language="csharp" source="Simulation.cs" ID="RelationalPattern":::
:::code language="csharp" source="Simulation.cs" ID="RelationalPattern2":::
:::code language="csharp" source="OrderProcessor.cs" ID="OrderRecord":::
:::code language="csharp" source="OrderProcessor.cs" ID="PropertyPattern":::
:::code language="csharp" source="OrderProcessor.cs" ID="DeconstructPattern":::
```


## ==âš¡ Datatypes ç±»å‹ç³»ç»Ÿ
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/value-types
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/language-specification/types

Two main categories of C# types

- Value types å€¼ç±»å‹æ•°æ®ä¿®æ”¹ä¸å½±å“åŸå§‹å˜é‡ï¼Œæ¯ä¸ªå˜é‡éƒ½å…·æœ‰å…¶è‡ªå·±çš„æ•°æ®å‰¯æœ¬ï¼›
- Reference types é€šè¿‡å‡½æ•°ä¼ é€’çš„å¼•ç”¨ç±»å‹ä¿®æ”¹ä¼šå½±å“åŸå§‹å˜é‡ï¼Œä½¿ç”¨åŒä¸€ä»½æ•°æ®ï¼›

ç®—ä¸ŠæŒ‡é’ˆç±»å‹ï¼Œå°±æœ‰ä¸‰å¤§ç±»å‹ã€‚å¯¹äºå€¼ç±»å‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ inã€ref å’Œ out å‚æ•°å…³é”®å­—è¿›è¡Œä¿®é¥°ï¼Œè¿™ç§ç”¨æ³•çš„å˜é‡é™¤å¤–ã€‚

### ===âœ’ Value Types

å€¼ç±»å‹çš„çº¦æŸæ¡ä»¶ï¼š

- a *structure type*, which encapsulates data and related functionality
- an *enumeration type*, which is defined by a set of named constants and represents a choice or a combination of choices
- A *nullable value* type `T?` represents all values of its underlying value type `T` and an additional null value. You cannot assign `null` to a variable of a value type, unless it's a nullable value type.

You can use the struct constraint to specify that a type parameter is a non-nullable value type. Both structure and enumeration types satisfy the struct constraint. 

Beginning with C# 7.3, you can use *System.Enum* in a base class constraint (that is known as the enum constraint) to specify that a type parameter is an enumeration type.

ä»¥ä¸‹è¿™äº›éƒ½æ˜¯å€¼ç±»å‹ï¼š

- Integral numeric types
- nint and nuint native integer types
- Floating-point numeric types
- bool
- char
- Enumeration types
- Structure types
- Tuple types
- Nullable value types

C# æä¾›ä»¥ä¸‹å†…ç½®çš„å€¼ç±»å‹ï¼Œä¹Ÿæ˜¯ simple typesï¼š

- Integral numeric types
- Floating-point numeric types
- bool that represents a Boolean value
- char that represents a Unicode UTF-16 character

æ‰€æœ‰ç®€å•ç±»å‹éƒ½æ˜¯æœ‰ä»¥ä¸‹ç‰¹å¾çš„ç»“æ„ä½“ç±»å‹ï¼š

- You can use literals to provide a value of a simple type. For example, 'A' is a literal of the type *char* and *2001* is a literal of the type *int*.
- You can declare constants of the simple types with the *const* keyword. It's not possible to have constants of other structure types.
- Constant expressions, whose operands are all constants of the simple types, are evaluated at compile time.

Beginning with C# 7.0, C# supports value tuples. A value tuple is a value type, but not a simple type.

æ¼”ç¤ºå€¼ç±»å‹çš„æ‹·è´èµ‹å€¼ï¼Œä¸å¼•ç”¨ç±»å‹çš„å‡½æ•°å‚æ•°ä¼ é€’ï¼š

```C#,ignore
using System;

public struct MutablePoint
{
    public int X;
    public int Y;

    public MutablePoint(int x, int y) => (X, Y) = (x, y);

    public override string ToString() => $"({X}, {Y})";
}

public class Program
{
    public static void Main()
    {
        var p1 = new MutablePoint(1, 2);
        var p2 = p1; // Copy value to a new instance
        p2.Y = 200;
        Console.WriteLine($"{nameof(p1)} after {nameof(p2)} is modified: {p1}");
        Console.WriteLine($"{nameof(p2)}: {p2}");

        MutateAndDisplay(p2); // Pass by reference
        Console.WriteLine($"{nameof(p2)} after passing to a method: {p2}");
    }

    private static void MutateAndDisplay(MutablePoint p)
    {
        p.X = 100;
        Console.WriteLine($"Point mutated in a method: {p}");
    }
}
```

ä»¥ä¸Šä»£ç éœ€è¦ C# 7.0 ç¼–è¯‘ï¼Œä½¿ç”¨åŠŸèƒ½æ¶‰åŠï¼š

- C# 6.0 å­—ç¬¦ä¸²æ’å€¼åŠŸèƒ½ï¼Œå¦‚ $"Point mutated in a method: {p}"ï¼›
- C# 6.0 expression-bodied æ–¹æ³•ï¼Œå¦‚ ToString() => $"({X}, {Y})";
- C# 7.0 Tuple å…ƒç»„åŠŸèƒ½ï¼Œå¦‚ (X, Y) = (x, y)ï¼›
- C# 7.0 è¡¨è¾¾å¼ä¸»ä½“æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œå¦‚ ctor. (...) => ...ï¼›

æœŸå¾…è¾“å‡ºï¼š

    p1 after p2 is modified: (1, 2)
    p2: (1, 200)
    Point mutated in a method: (100, 200)
    p2 after passing to a method: (1, 200)

If a value type contains a data member of a reference type, only the reference to the instance of the reference type is copied when a value-type instance is copied. Both the copy and original value-type instance have access to the same reference-type instance. 

å¦‚æœ Value Type çš„æ•°æ®æˆå‘˜å«æœ‰å¼•ç”¨ç±»å‹ï¼Œåœ¨å¤åˆ¶æ—¶ï¼Œä¿æŒå¼•ç”¨åŸå§‹çš„å¼•ç”¨å®ä¾‹ã€‚

ä»¥ä¸‹æ¼”ç¤ºå¼•ç”¨ç±»å‹ tags æ˜¯å¦‚ä½•è¢« n1 n2 ä¸¤ä¸ªå˜é‡è®¿é—®çš„ï¼š

```C#,ignore
using System;
using System.Collections.Generic;

public struct TaggedInteger
{
    public int Number;
    private List<string> tags;

    public TaggedInteger(int n)
    {
        Number = n;
        tags = new List<string>();
    }

    public void AddTag(string tag) => tags.Add(tag);

    public override string ToString() => $"{Number} [{string.Join(", ", tags)}]";
}

public class Program
{
    public static void Main()
    {
        var n1 = new TaggedInteger(0);
        n1.AddTag("A");
        Console.WriteLine(n1);  // output: 0 [A]

        var n2 = n1;
        n2.Number = 7;
        n2.AddTag("B");

        Console.WriteLine(n1);  // output: 0 [A, B]
        Console.WriteLine(n2);  // output: 7 [A, B]
    }
}
```

æœŸå¾…è¾“å‡ºï¼š

    0 [A]
    0 [A, B]
    7 [A, B]

ä»¥ä¸Šä»£ç éœ€è¦ C# 6.0 ç¼–è¯‘ï¼Œä½¿ç”¨åŠŸèƒ½æ¶‰åŠï¼š

- C# 6.0 å­—ç¬¦ä¸²å†…æ’å€¼åŠŸèƒ½ï¼Œå¦‚ï¼š $"{Number}"
- C# 6.0 expression-bodied æ–¹æ³•ï¼Œå¦‚ï¼š AddTag(string tag) => tags.Add(tag);
- C# 2.0 æ³›å‹ï¼Œå¦‚ï¼š List<string>

### ===âœ’ Reference Types
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/reference-types

There are two kinds of types in C#: *reference types* and *value types*. Variables of *reference types* store references to their data (objects), while variables of *value types* directly contain their data. With *reference types*, two variables can reference the same object; therefore, operations on one variable can affect the object referenced by the other variable. With value types, each variable has its own copy of the data, and it is not possible for operations on one variable to affect the other (except in the case of in, ref and out parameter variables; see in, ref and out parameter modifier).

*Boxing* and *unboxing* is an important concept in C#. C# Type System contains three data types: 

- Value Types (int, char, etc), 
- Reference Types (object) 
- Pointer Types

Basically it convert a Value Type to a Reference Type, and vice versa. *Boxing* and *Unboxing* enables a unified view of the type system in which a value of any type can be treated as an object.

The following keywords are used to declare reference types:

- class
- interface
- delegate
- record

C# also provides the following built-in reference types:

- dynamic
- object
- string

The following table lists the C# built-in reference types:

| C# type keyword |   .NET type   |
|-----------------|---------------|
| object          | System.Object |
| string          | System.String |
| dynamic         | System.Object |

The declaration of a delegate type is similar to a method signature. It has a return value and any number of parameters of any type:

```C#
public delegate void MessageDelegate(string message);
public delegate int AnotherDelegate(MyType m, long num);
```

In .NET, *System.Action* and *System.Func* types provide generic definitions for many common delegates. You likely don't need to define new custom delegate types. Instead, you can create instantiations of the provided generic types.

A delegate is a reference type that can be used to encapsulate a named or an anonymous method. Delegates are similar to function pointers in C++; however, delegates are type-safe and secure. For applications of delegates, see Delegates and Generic Delegates. Delegates are the basis for Events. A delegate can be instantiated by associating it either with a named or anonymous method.

Beginning with C# 9, you can declare function pointers, which use similar syntax. A function pointer uses the calli instruction instead of instantiating a delegate type and calling the virtual Invoke method.


The *dynamic type* indicates that use of the variable and references to its members bypass compile-time type checking. Instead, these operations are resolved at run time. The *dynamic type* simplifies access to COM APIs such as the Office Automation APIs, to dynamic APIs such as IronPython libraries, and to the HTML Document Object Model (DOM).

Type dynamic behaves like type object in most circumstances. In particular, any non-null expression can be converted to the *dynamic type*. The *dynamic type* differs from object in that operations that contain expressions of type dynamic are not resolved or type checked by the compiler. The compiler packages together information about the operation, and that information is later used to evaluate the operation at run time. As part of the process, variables of type dynamic are compiled into variables of type object. Therefore, type dynamic exists only at compile time, not at run time.

The following example contrasts a variable of type dynamic to a variable of type object. To verify the type of each variable at compile time, place the mouse pointer over *dyn* or *obj* in the WriteLine statements. Copy the following code into an editor where IntelliSense is available. IntelliSense shows *dynamic* for *dyn* and *object* for *obj*.

```C#,ignore
class Program
{
    static void Main(string[] args)
    {
        dynamic dyn = 1;
        object obj = 1;
        dyn = dyn + 1; // OK, Runtime type checking: int + int
        obj = obj + 1; // Error, Compile time type checking: object + int

        System.Console.WriteLine(dyn.GetType());
        System.Console.WriteLine(obj.GetType());
    }
}
```


Beginning with C# 9, you use the record keyword to define a reference type that provides built-in functionality for encapsulating data. You can create record types with immutable properties by using positional parameters or standard property syntax:

```C#,ignore
public record Person(string FirstName, string LastName);

public record Person
{
    public string FirstName { get; init; } = default!;
    public string LastName { get; init; } = default!;
};

// You can also create record types with mutable properties and fields:
public record Person
{
    public string FirstName { get; set; } = default!;
    public string LastName { get; set; } = default!;
};
```

Classes are declared using the keyword class, as shown in the following example:

```C#,ignore
class TestClass
{
    // Methods, properties, fields, events, delegates
    // and nested classes go here.
}
```

Only single inheritance is allowed in C#. In other words, a class can inherit implementation from one base class only. However, a class can implement more than one interface. The following table shows examples of class inheritance and interface implementation:

Inheritance Example

- None    *class ClassA { }*
- Single  *class DerivedClass : BaseClass { }*
- None, implements two interfaces *class ImplClass : IFace1, IFace2 { }*
- Single, implements one interface    *class ImplDerivedClass : BaseClass, IFace1 { }*


An *interface* defines a contract. Any class or struct that implements that contract must provide an implementation of the members defined in the *interface*. Beginning with C# 8.0, an *interface* may define a default implementation for members. It may also define static members in order to provide a single implementation for common functionality.



### ===âœ’ Datatype keywords
- C# Keywords https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/

å…³äºç±»å‹æœ‰å‡ ä¸ªç‰¹æ®ŠçŸ¥è¯†ç‚¹ï¼š

- *void* æ— ç±»å‹ï¼Œå¯¹åº” .Net System.Voidï¼›
- *var* è‡ªåŠ¨å˜é‡ç±»å‹æ¨å¯¼ï¼›
- Built-in types å†…å»ºç±»å‹ï¼›
- Unmanaged types éæ‰˜ç®¡ç±»å‹ï¼›
- Default values ç±»å‹çš„é»˜è®¤å€¼ä¸é»˜è®¤å€¼è¿ç®—ç¬¦ï¼›

The *void* keyword represents the absence of a type. You use it as the return type of a method that doesn't return a value.

You can also use *void* as a referent type to declare a pointer to an unknown type.

You cannot use void as the type of a variable.

```C#,ignore
public static void Display(IEnumerable<int> numbers)
{
    if (numbers is null)
    {
        return;
    }

    Console.WriteLine(string.Join(" ", numbers));
}
```

ä» C# 3.0 å¼€å§‹ï¼Œåœ¨æ–¹æ³•èŒƒå›´å†…å£°æ˜çš„å˜é‡å¯ä»¥å…·æœ‰éšå¼ç±»å‹ varã€‚ éšå¼ç±»å‹æœ¬åœ°å˜é‡ä¸ºå¼ºç±»å‹ï¼Œå°±åƒç”¨æˆ·å·²ç»è‡ªè¡Œå£°æ˜è¯¥ç±»å‹ï¼Œä½†ç¼–è¯‘å™¨å†³å®šç±»å‹ä¸€æ ·ã€‚

Beginning with C# 3.0, variables that are declared at method scope can have an implicit "type" *var*. An implicitly typed local variable is *strongly typed* just as if you had declared the type yourself, but the compiler determines the type. 

The following two declarations of i are functionally equivalent:

```C#
var i = 10; // Implicitly typed.
int i = 10; // Explicitly typed.
```


ä½¿ç”¨éšå¼ç±»å‹å£°æ˜é€šå¸¸äºæ„é€ å™¨è°ƒç”¨è¡¨è¾¾å¼ï¼Œä»¥èŠ‚çœä¸å¿…è¦çš„é‡å¤è¾“å…¥ï¼š

```C#
var xs = new List<int>();

// C# 9.0, target-typed new expression
List<int> xs = new();
List<int>? ys = new();
```

ä»¥ä¸‹ç»“åˆ System.Linq æŸ¥è¯¢è¯­è¨€æ¼”ç¤º var å…³é”®å­—çš„ä½¿ç”¨ï¼š

```C#
// Example #1: var is optional when
// the select clause specifies a string
string[] words = { "apple", "strawberry", "grape", "peach", "banana" };
var wordQuery = from word in words
                where word[0] == 'g'
                select word;

// Because each element in the sequence is a string,
// not an anonymous type, var is optional here also.
foreach (string s in wordQuery)
{
    Console.WriteLine(s);
}

// Example #2: var is required because
// the select clause specifies an anonymous type
var custQuery = from cust in customers
                where cust.City == "Phoenix"
                select new { cust.Name, cust.Phone };

// var must be used because each item
// in the sequence is an anonymous type
foreach (var item in custQuery)
{
    Console.WriteLine("Name={0}, Phone={1}", item.Name, item.Phone);
}
```

The following table shows the default values of C# types:

|                   Type                   |             Default value             |
|------------------------------------------|---------------------------------------|
| Any reference type                       | null                                  |
| Any built-in integral numeric type       | 0 (zero)                              |
| Any built-in floating-point numeric type | 0 (zero)                              |
| bool                                     | false                                 |
| char                                     | '\0' (U+0000)                         |
| enum                                     | (E)0, where E is the enum identifier. |

ç»“æ„ä½“é»˜è®¤å€¼é™¤äº†å¼•ç”¨ç±»å‹ä¸º nullï¼Œå…¶å®ƒå€¼ç±»å‹å­—æ®µæŒ‰ä¸Šè¡¨é»˜è®¤å€¼å¤„ç†ã€‚

Any *nullable value type*: An instance for which the *HasValue* property is *false* and the Value property is *undefined*. That default value is also known as the *null* value of a nullable value type.

```C#
// C# 2.0 use default operator
int a = default(int);
// C# 7.1 use the default literal to initialize
int a = default; 
```

C# è¯­è¨€çš„å†…å»ºç±»å‹çš„å€¼ç±»å‹ã€å¼•ç”¨ç±»å‹éƒ½ä½¿ç”¨å°å†™åç§°ï¼Œå’Œ .Net çš„ç±»å‹ç³»ç»Ÿæœ‰ç­‰ä»·çš„å¯¹åº”å…³ç³»ã€‚

The following table lists the C# built-in value types:

| C# type keyword |                Size               |   .NET type    |
|-----------------|-----------------------------------|----------------|
| bool            | 8 bit                             | System.Boolean |
| char            | 16 bit Unicode UTF-16             | System.Char    |
| byte            | Unsigned 8-bit integer            | System.Byte    |
| sbyte           | Signed 8-bit integer              | System.SByte   |
| int             | Signed 32-bit integer             | System.Int32   |
| uint            | Unsigned 32-bit integer           | System.UInt32  |
| nint            | Signed 32-bit or 64-bit integer   | System.IntPtr  |
| nuint           | Unsigned 32-bit or 64-bit integer | System.UIntPtr |
| long            | Signed 64-bit integer             | System.Int64   |
| ulong           | Unsigned 64-bit integer           | System.UInt64  |
| short           | Signed 16-bit integer             | System.Int16   |
| ushort          | Unsigned 16-bit integer           | System.UInt16  |

C# supports the following predefined floating-point types:

| C# type |       Approximate range        |   Precision   |   Size   |   .NET type    |
|---------|--------------------------------|---------------|----------|----------------|
| float   | Â±1.5 x 10âˆ’45 to Â±3.4 x 1038    | ~6-9 digits   | 4 bytes  | System.Single  |
| double  | Â±5.0 Ã— 10âˆ’324 to Â±1.7 Ã— 10308  | ~15-17 digits | 8 bytes  | System.Double  |
| decimal | Â±1.0 x 10-28 to Â±7.9228 x 1028 | 28-29 digits  | 16 bytes | System.Decimal |

The following table lists the C# built-in reference types:

| C# type keyword |   .NET type   |
|-----------------|---------------|
| object          | System.Object |
| string          | System.String |
| dynamic         | System.Object |

For example, the following declarations declare variables of the same type:

```C#
int a = 123;
System.Int32 b = 123;
```

The *nint* and *nuint* types are native-sized integers. They are represented internally by the indicated .NET types, but in each case the keyword and the .NET type are not interchangeable. The compiler provides operations and conversions for *nint* and *nuint* as integer types that it doesn't provide for the pointer types *System.IntPtr* and *System.UIntPtr*.


C# ç¼–è¯‘å™¨ç¼–è¯‘æºä»£ç çš„ç®€åŒ–è¿‡ç¨‹ï¼š

- å…ˆä¼šè½¬æ¢ä¸º CLI - Common Intermediate Languageï¼›
- å†é€šè¿‡å…¬å…±è¯­è¨€åº“ CLR - Common Language Runtime è½¬æ¢ä¸ºæœºå™¨ç ï¼ˆJITï¼‰ï¼›

è¿™é‡Œæ¶‰åŠæ‰˜ç®¡çš„æ¦‚å¿µï¼Œæ‰˜ç®¡ä»£ç æ˜¯åœ¨å…¬å…±è¯­è¨€è¿è¡Œåº“ä¸­è¿è¡Œçš„ä»£ç ï¼Œç”± CLR ç›´æ¥æ§åˆ¶ï¼Œæä¾›æ‰˜ç®¡ä»£ç æ‰§è¡Œæ—¶æ‰€éœ€è¦çš„å„ç§æœåŠ¡ï¼Œå¦‚åƒåœ¾å›æ”¶ã€ç±»å‹æ£€æŸ¥ã€å®‰å…¨æ”¯æŒç­‰ã€‚

éæ‰˜ç®¡ä»£ç ç›¸å¯¹äºæ‰˜ç®¡ä»£ç è€Œè¨€ï¼Œå…¶å®é™…ä¸Šæ˜¯è®¡ç®—æœºæ“çºµç³»ç»Ÿå¯è¯†åˆ«çš„æœºå™¨ç ã€‚éæ‰˜ç®¡ä»£ç ï¼ˆæœºå™¨ç ï¼‰çš„æ‰§è¡Œç”±æ“ä½œç³»ç»Ÿæ¥æ§åˆ¶ï¼Œå…¶åœ¨æ‰§è¡Œæ—¶ä¹Ÿéœ€è¦å„ç§æœåŠ¡ï¼Œå¦‚åƒåœ¾å›æ”¶ã€ç±»å‹æ£€æŸ¥ã€å®‰å…¨æ”¯æŒç­‰ã€‚ç”±äºæ²¡æœ‰åƒå…¬å…±è¯­è¨€è¿è¡Œåº“è¿™æ ·çš„ä¸œè¥¿ä¼šè‡ªåŠ¨ç»™ä½ æä¾›æœåŠ¡ï¼Œæ‰€ä»¥ä½ éœ€è¦è‡ªå·±æä¾›è¿™äº›æœåŠ¡ï¼Œä¹Ÿå°±è¯´ä½ è¦å†™é¢å¤–çš„ä»£ç æ¥å®ç°åƒåœ¾å›æ”¶ç­‰åŠŸèƒ½ã€‚

éæ‰˜ç®¡ç±»å‹æ˜¯ä»¥ä¸‹å€¼ç±»å‹æˆ–å…·æœ‰ä»¥ä¸‹ç‰¹å¾çš„ç±»å‹ï¼š

- sbyte, byte, short, ushort, int, uint, long, ulong, char, float, double, decimal, or bool
- Any *enum* type
- Any *pointer* type
- Any user-defined *struct* type that contains fields of unmanaged types only and, in C# 7.3 and earlier, is not a constructed type (a type that includes at least one type argument)

- ä»»ä½•ç”¨æˆ·å®šä¹‰çš„ struct ç±»å‹ï¼ŒåªåŒ…å«éæ‰˜ç®¡ç±»å‹çš„å­—æ®µï¼Œå¹¶ä¸”åœ¨ C# 7.3 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œä¸æ˜¯æ„é€ ç±»å‹ï¼ˆåŒ…å«è‡³å°‘ä¸€ä¸ªç±»å‹å‚æ•°çš„ç±»å‹ï¼‰

Beginning with C# 7.3, you can use the *unmanaged constraint* to specify that a type parameter is a non-pointer, non-nullable unmanaged type.

```C#,ignore
unsafe public static byte[] ToByteArray<T>(this T argument) where T : unmanaged
{
    var size = sizeof(T);
    var result = new Byte[size];
    Byte* p = (byte*)&argument;
    for (var i = 0; i < size; i++)
        result[i] = *p++;
    return result;
}
```

Beginning with C# 8.0, a constructed struct type that contains fields of *unmanaged* types only is also unmanaged, as the following example shows:

```C#,ignore
using System;

public struct Coords<T>
{
    public T X;
    public T Y;
}

public class UnmanagedTypes
{
    public static void Main()
    {
        DisplaySize<Coords<int>>();
        DisplaySize<Coords<double>>();
    }

    private unsafe static void DisplaySize<T>() where T : unmanaged
    {
        Console.WriteLine($"{typeof(T)} is unmanaged and its size is {sizeof(T)} bytes");
    }
}
// Output:
// Coords`1[System.Int32] is unmanaged and its size is 8 bytes
// Coords`1[System.Double] is unmanaged and its size is 16 bytes
```


## ===âœ’ Enum æšä¸¾ç±»å‹
- [Enumeration types - C# reference](language-reference/builtin-types/enum.md)
- [Enumeration comparison operators - C# Specificaton](standard/expressions.md)
- [Enum - C# Specification](standard\enums.md)
- [Enum Design](dotnet-docs\docs\standard\design-guidelines\enum.md)
- https://josipmisko.com/posts/string-enums-in-c-sharp-everything-you-need-to-know
- coreclr-3.1.24\src\System.Private.CoreLib\shared\System\Enum.cs

æšä¸¾ç±»å‹ Enums æ˜¯ç”±åŸºäºæ•´å‹æ•°å€¼ç±»å‹çš„ä¸€ç»„å‘½åå¸¸é‡å®šä¹‰çš„å€¼ç±»å‹ï¼Œåˆ†ä¸º simple enums & flag enums ä¸¤ç±»ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæšä¸¾æˆå‘˜çš„å…³è”å¸¸æ•°å€¼ä¸ºç±»å‹ intï¼›å®ƒä»¬ä»é›¶å¼€å§‹ï¼Œå¹¶æŒ‰å®šä¹‰æ–‡æœ¬é¡ºåºé€’å¢ 1ã€‚ å¯ä»¥æ˜¾å¼æŒ‡å®šä»»ä½•å…¶ä»–æ•´æ•°æ•°å€¼ç±»å‹ä½œä¸ºæšä¸¾ç±»å‹çš„åŸºç¡€ç±»å‹ï¼Œè¿˜å¯ä»¥æ˜¾å¼æŒ‡å®šå…³è”çš„å¸¸æ•°å€¼ã€‚

æšä¸¾ç±»å‹ä¸»è¦ç”¨é€”æ˜¯ç®¡ç†å¤§é‡é‡å¤ä½¿ç”¨çš„å€¼ï¼Œå½“ç„¶è¿™ç§éœ€è¦è¿˜å¯ä»¥ä½¿ç”¨ static readonly vs constï¼Œå®ƒä»¬ä¸¤è€…æœ‰äº›å·®åˆ«ã€‚ä½¿ç”¨ AspNetCore "HttpMethods" æºä»£ç ä¸­çš„æ³¨è§£å¯ä»¥è§£æå®ƒä»¬çš„å·®å¼‚ï¼šä½¿ç”¨ static readonly å¯ä»¥é¿å…åœ¨å¤šä¸ªç¨‹åºé›†ä¸­å¤åˆ¶æ•°æ®ï¼Œä»¥ä¿è¯å®ƒä»¬å¼•ç”¨åŒä¸€ä¸ªåŸå§‹å®ç°ï¼Œè¿™åœ¨è¿›è¡Œ ReferenceEquals æ—¶éå¸¸å¿…è¦ã€‚

    // We are intentionally using 'static readonly' here instead of 'const'.
    // 'const' values would be embedded in to each assembly that used them
    // and each consuming assembly would have a different 'string' instance.
    // Using .'static readonly' means that all consumers get thee exact same
    // 'string' instance, which means the 'ReferenceEquals' checks below work
    // and allow us to optimize comparisons when these constants are used.
    
    // Please do NOT change these to 'const'
    public static readonly string Connect = "CONNECT";
    public static readonly string Delete = "DELETE";

ä»¥ä¸Šè¿™ç§é™æ€åªè¯»æˆå‘˜ç”¨æ³•å¾ˆå¥½åœ°è§£å†³äº†â€œå­—ç¬¦ä¸²æšä¸¾â€ç±»å‹çš„ç”¨æ³•ï¼Œå½“ç„¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ *Attribute* æ¥å®ç°å­—ç¬¦ä¸²æšä¸¾ã€‚

ä¸èƒ½ä½¿ç”¨ enum å®šä¹‰ä½¿ç”¨å­—ç¬¦ä¸²å€¼çš„æšä¸¾ï¼Œä½†å¯ä»¥ä½¿ç”¨ *char* å› ä¸ºå®ƒæ˜¯æ•°å€¼ã€‚

ä¸èƒ½åœ¨æšä¸¾ç±»å‹çš„å®šä¹‰å†…å®šä¹‰æ–¹æ³•ã€‚ è‹¥è¦å‘æšä¸¾ç±»å‹æ·»åŠ æ–¹æ³•åŠŸèƒ½ï¼Œè¯·åˆ›å»º Extension Methodsã€‚

æšä¸¾ç±»å‹ E çš„é»˜è®¤å€¼æ˜¯ç”±è¡¨è¾¾å¼ (E)0 ç”Ÿæˆçš„å€¼ï¼Œå³ä½¿é›¶æ²¡æœ‰ç›¸åº”çš„æšä¸¾æˆå‘˜ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

æšä¸¾ç±»å‹åŸºæœ¬å®šä¹‰ï¼š

```C#,ignore
// default member type: int
enum Season
{
    Spring,
    Summer,
    Autumn,
    Winter
}

enum ErrorCode : ushort
{
    None = 0,
    Unknown = 1,
    ConnectionLost = 100,
    OutlierReading = 200
}
```


ä½¿ç”¨ä½åŸŸç±»å‹çš„æšä¸¾ï¼š

å¦‚æœå¸Œæœ›æšä¸¾ç±»å‹è¡¨ç¤ºé€‰é¡¹ç»„åˆï¼Œè¯·ä¸ºè¿™äº›é€‰é¡¹å®šä¹‰æšä¸¾æˆå‘˜ï¼Œä»¥ä¾¿å•ä¸ªé€‰é¡¹æˆä¸ºä½å­—æ®µã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›æšä¸¾æˆå‘˜çš„å…³è”å€¼åº”è¯¥æ˜¯ 2 çš„å¹‚ã€‚ ç„¶åï¼Œå¯ä»¥ä½¿ç”¨æŒ‰ä½é€»è¾‘è¿ç®—ç¬¦åˆå¹¶é€‰é¡¹æˆ–äº¤å‰ç»„åˆé€‰é¡¹ã€‚ è‹¥è¦æŒ‡ç¤ºæšä¸¾ç±»å‹å£°æ˜ä½å­—æ®µï¼Œè¯·å¯¹å…¶åº”ç”¨ Flags å±æ€§ã€‚ å¦‚ä¸‹é¢çš„ç¤ºä¾‹æ‰€ç¤ºï¼Œè¿˜å¯ä»¥åœ¨æšä¸¾ç±»å‹çš„å®šä¹‰ä¸­åŒ…å«ä¸€äº›å…¸å‹ç»„åˆã€‚

```C#,ignore
using System;

[Flags]
public enum Days
{
    None      = 0b_0000_0000,  // 0
    Monday    = 0b_0000_0001,  // 1
    Tuesday   = 0b_0000_0010,  // 2
    Wednesday = 0b_0000_0100,  // 4
    Thursday  = 0b_0000_1000,  // 8
    Friday    = 0b_0001_0000,  // 16
    Saturday  = 0b_0010_0000,  // 32
    Sunday    = 0b_0100_0000,  // 64
    Weekend   = Saturday | Sunday
}

public class FlagsEnumExample
{
    public static void Main()
    {
        Days meetingDays = Days.Monday | Days.Wednesday | Days.Friday;
        Console.WriteLine(meetingDays);
        // Output:
        // Monday, Wednesday, Friday

        Days workingFromHomeDays = Days.Thursday | Days.Friday;
        Console.WriteLine($"Join a meeting by phone on {meetingDays & workingFromHomeDays}");
        // Output:
        // Join a meeting by phone on Friday

        bool isMeetingOnTuesday = (meetingDays & Days.Tuesday) == Days.Tuesday;
        Console.WriteLine($"Is there a meeting on Tuesday: {isMeetingOnTuesday}");
        // Output:
        // Is there a meeting on Tuesday: False

        var a = (Days)37;
        Console.WriteLine(a);
        // Output:
        // Monday, Wednesday, Saturday
    }
}
```

ä» C# 7.3 å¼€å§‹ï¼Œä½ å¯ä»¥åœ¨æ³›å‹ä¸­ä½¿ç”¨ System.Enum ä½œä¸ºåŸºç±»çº¦æŸä¸­ï¼Œç§°ä¸ºæšä¸¾çº¦æŸï¼Œä»¥æŒ‡å®šæ³›å‹ç±»å‹å‚æ•°ä¸ºæšä¸¾ç±»å‹ã€‚

System.Enum ç±»å‹æ˜¯æ‰€æœ‰æšä¸¾ç±»å‹çš„æŠ½è±¡åŸºç±»ï¼Œå®ƒæä¾›å¤šç§æ–¹æ³•æ¥è·å–æœ‰å…³æšä¸¾ç±»å‹åŠå…¶å€¼çš„ä¿¡æ¯ã€‚

- [using the enum constraint](snippets/GenericWhereConstraints.cs#18)
- [enum definition](snippets/GenericWhereConstraints.cs#19)
- [using the enum constrained method](snippets/GenericWhereConstraints.cs#20)
- [enum conversions](snippets/shared/EnumType.cs#Conversions)

å¯¹äºä»»ä½•æšä¸¾ç±»å‹ï¼Œæšä¸¾ç±»å‹ä¸å…¶åŸºç¡€æ•´å‹ç±»å‹ä¹‹é—´å­˜åœ¨æ˜¾å¼è½¬æ¢ï¼Œå¦‚ *(Days)37* å°†æ•´å½¢è½¬æ¢ä¸ºæšä¸¾ç±»å‹ã€‚ å¦‚æœå°†æšä¸¾å€¼è½¬æ¢ä¸ºå…¶åŸºç¡€ç±»å‹ï¼Œåˆ™ç»“æœä¸ºæšä¸¾æˆå‘˜çš„å…³è”æ•´æ•°å€¼ã€‚

ä½¿ç”¨ Enum.IsDefined() æ–¹æ³•æ¥ç¡®å®šæšä¸¾ç±»å‹æ˜¯å¦åŒ…å«å…·æœ‰ç‰¹å®šå…³è”å€¼çš„æšä¸¾æˆå‘˜ã€‚

ä»¥ä¸‹ç¤ºèŒƒï¼Œé€šè¿‡æ‰©å±•æ–¹æ³•æ¥å®ç°æšä¸¾ç±»å‹åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢ï¼š

```C#,ignore
using System;
using MyExtensionMethods;

public enum Color { Red='R', Green='G', Blue='B' }

// Extension Method
namespace MyExtensionMethods
{
    public static class MyExtensions
    {
        // C# 8.0 Features - Pattern matching
        public static string ToString(this Color c) => c switch 
        {
            0           => "<Color:0 >",
            Color.Red   => "<Color:Red >",
            Color.Green => "<Color:Green >",
            Color.Blue  => "<Color:Blue >",
            _           => "<Color:Unknow >",
        };
    }
}

class Test
{
    static void Main()
    {
        Color color;
        if (!Enum.TryParse<Color>("R", out color))
        {
            Console.WriteLine("Enum.TryParse fail will got a ZERO:");
        }
        Log(color);
        Log((Color)Enum.Parse(typeof(Color),"Green"));
        Log(Color.Blue);
    }

    static void Log(Color it)
    {
        Console.WriteLine("color: {0}", it.ToString());
    }
}
```

æœŸå¾…è¾“å‡ºï¼š

    Enum.TryParse fail will got a ZERO:
    color: 0
    color: Green
    color: Blue


## ===âœ’ Nullable T? å¯ç©ºå€¼ç±»å‹
- https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/nullable-reference-types
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/nullable-value-types
- https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/types/boxing-and-unboxing

å¯ç©ºå€¼ç±»å‹åˆ†ä¸ºå€¼ç±»å‹ã€å¼•ç”¨ç±»å‹ã€‚

Nullable reference types are available beginning with C# 8.0, in code that has opted in to a nullable aware context. Nullable reference types, the null static analysis warnings, and the null-forgiving operator are optional language features. All are turned off by default. A nullable context is controlled at the project level using build settings, or in code using pragmas.

é€šè¿‡æ³¨è§£æ¿€æ´» nullableï¼š

    #nullable disable
    #nullable enabled
    #nullable restore

å¯ç©ºç±»å‹å…è®¸åŒ…å« null å€¼ï¼Œè¿™å¯¹å¤„ç†æ•°æ®åº“ä¸­åŒ…å«å¯é€‰å­—æ®µä»¥åŠå¾ˆå¤šæ–¹é¢éƒ½æœ‰å¾ˆå¤§å¸®åŠ©ã€‚

```C#
string? name;
name!.Length; // null-forgiving operator !

double? pi = 3.14;
char? letter = 'a';

int m2 = 10;
int? m = m2;

bool? flag = null;

// An array of a nullable value type:
int?[] arr = new int?[10];
```

Beginning with C# 7.0, you can use the *is* operator with a type pattern to both examine an instance of a nullable value type for null and retrieve a value of an underlying type:

```C#
int? a = 42;
// if (a.HasValue) ... a.Value
// if (a != null) ... a.Value
if (a is int valueOfA) 
{
    Console.WriteLine($"a is {valueOfA}");
}
else
{
    Console.WriteLine("a does not have a value");
}
```

You always can use the following read-only properties to examine and get a value of a nullable value type variable:

- `Nullable<T>.HasValue` indicates whether an instance of a nullable value type has a value of its underlying type.
- `Nullable<T>.Value` gets the value of an underlying type if *HasValue* is *true*. If *HasValue* is *false*, the Value property throws an *InvalidOperationException*.

Use the *null-coalescing operator ??* to do that (you can also use the `Nullable<T>.GetValueOrDefault(T)` method for the same purpose):

C# 2.0 æä¾›ä¸€ä¸ªæ–°æ“ä½œç¬¦ ?? ç”¨æ¥åˆå¹¶ç©ºå€¼ã€‚

```C#
var result = a;
if(a == null)
{
    result = "XYZ";
}

// ç­‰ä»·ä»£ç 
result = a?? "XYZ";
```


C# 6.0 æä¾›ç”¨äºåœ¨æ‰§è¡Œæˆå‘˜è®¿é—® ?. æˆ–ç´¢å¼• ?[] æ“ä½œä¹‹å‰ï¼Œæµ‹è¯•æ˜¯å¦å­˜åœ¨ NULLã€‚ è¿™äº›è¿ç®—ç¬¦å¯å¸®åŠ©ç¼–å†™æ›´å°‘çš„ä»£ç æ¥å¤„ç† null æ£€æŸ¥ï¼Œå°¤å…¶æ˜¯å¯¹äºä¸‹é™åˆ°æ•°æ®ç»“æ„ã€‚

```C#
int? count = customers?[0]?.Orders?.Count(); 
// null if customers, the first customer, or Orders is null
```

Boxing and unboxing

An instance of a nullable value type *T?* is boxed as follows:

- If *HasValue* returns false, the null reference is produced.
- If *HasValue* returns true, the corresponding value of the underlying value type *T* is boxed, not the instance of `Nullable<T>`.

You can unbox a boxed value of a value type *T* to the corresponding nullable value type *T?*, as the following example shows:

```C#
int a = 41;
object aBoxed = a;
int? aNullable = (int?)aBoxed;
Console.WriteLine($"Value of aNullable: {aNullable}");

object aNullableBoxed = aNullable;
if (aNullableBoxed is int valueOfA)
{
    Console.WriteLine($"aNullableBoxed is boxed int: {valueOfA}");
}
// Output:
// Value of aNullable: 41
// aNullableBoxed is boxed int: 41
```

Boxing is the process of converting a value type to the type object or to any interface type implemented by this value type. When the common language runtime (CLR) boxes a value type, it wraps the value inside a System.Object instance and stores it on the managed heap. Unboxing extracts the value type from the object. Boxing is implicit; unboxing is explicit. The concept of boxing and unboxing underlies the C# unified view of the type system in which a value of any type can be treated as an object.

æ‹†ç®±å’Œè£…ç®±ï¼Œç®€å•ä¸€ç‚¹è®²ï¼Œå°±æ˜¯ä» primitive è½¬æ¢åˆ° wrapper classï¼Œä¾‹å¦‚ int ç±»å‹åˆ° Integer ç±»å‹å°±æ˜¯è£…ç®±ï¼Œè€Œ Integer ç±»å‹åˆ° int ç±»å‹åˆ™æ˜¯æ‹†ç®±ã€‚



## ===âœ’ Tuples vs. ValueTuple å…ƒç»„
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/value-tuples

å…ƒç»„æ˜¯ C# 7.0 å¼•å…¥çš„ä¾¿åˆ©ç±»å‹ï¼Œå¯ä»¥å°†ä¸åŒç±»å‹è¿›è¡Œç»„åˆï¼Œå¹¶ä¸”ä½¿ç”¨å­—æ®µå Item åŠ åŸºäº 1 çš„åºå·è¿›è¡Œè®¿é—®ï¼Œä¹Ÿåªå¯ä»¥æŒ‡å®š Tuple field namesï¼š

```C#
(double, int) t1 = (4.5, 3);
Console.WriteLine($"Tuple with elements {t1.Item1} and {t1.Item2}.");
// Output:
// Tuple with elements 4.5 and 3.

(double Sum, int Count) t2 = (4.5, 3);
Console.WriteLine($"Sum of {t2.Count} elements is {t2.Sum}.");
// Output:
// Sum of 3 elements is 4.5.

// Tuple initialization expression
var t = (Sum: 4.5, Count: 3);
Console.WriteLine($"Sum of {t.Count} elements is {t.Sum}.");

// the definition of a tuple type
(double Sum, int Count) d = (4.5, 3);
Console.WriteLine($"Sum of {d.Count} elements is {d.Sum}.");

// C# 7.1 inferred tuple initialization expression
var sum = 4.5;
var count = 3;
var t = (sum, count);
Console.WriteLine($"Sum of {t.count} elements is {t.sum}.");
```

You cannot define methods in a tuple type, but you can use the methods provided by .NET, as the following example shows:

```C#
(double, int) t = (4.5, 3);
Console.WriteLine(t.ToString());
Console.WriteLine($"Hash code of {t} is {t.GetHashCode()}.");
// Output:
// (4.5, 3)
// Hash code of (4.5, 3) is 718460086.
```

Beginning with C# 7.3, tuple types support equality operators *==* and *!=*. 

Tuple types are value types; tuple elements are public fields. That makes tuples mutable value types.

One of the most common use cases of tuples is as a method return type. That is, instead of defining *out method parameters*, you can group method results in a tuple return type, as the following example shows:

```C#
var xs = new[] { 4, 7, 9 };
var limits = FindMinMax(xs);
Console.WriteLine($"Limits of [{string.Join(" ", xs)}] are {limits.min} and {limits.max}");
// Output:
// Limits of [4 7 9] are 4 and 9

var ys = new[] { -9, 0, 67, 100 };
var (minimum, maximum) = FindMinMax(ys);
Console.WriteLine($"Limits of [{string.Join(" ", ys)}] are {minimum} and {maximum}");
// Output:
// Limits of [-9 0 67 100] are -9 and 100

(int min, int max) FindMinMax(int[] input)
{
    if (input is null || input.Length == 0)
    {
        throw new ArgumentException("Cannot find minimum and maximum of a null or empty array.");
    }

    var min = int.MaxValue;
    var max = int.MinValue;
    foreach (var i in input)
    {
        if (i < min)
        {
            min = i;
        }
        if (i > max)
        {
            max = i;
        }
    }
    return (min, max);
}
```

C# supports assignment between tuple types that satisfy both of the following conditions:

- both tuple types have the same number of elements
- for each tuple position, the type of the right-hand tuple element is the same as or implicitly convertible to the type of the corresponding left-hand tuple element

Tuple element values are assigned following the order of tuple elements. The names of tuple fields are ignored and not assigned, as the following example shows:

```C#
(int, double) t1 = (17, 3.14);
(double First, double Second) t2 = (0.0, 1.0);
t2 = t1;
Console.WriteLine($"{nameof(t2)}: {t2.First} and {t2.Second}");
// Output:
// t2: 17 and 3.14

(double A, double B) t3 = (2.0, 3.0);
t3 = t2;
Console.WriteLine($"{nameof(t3)}: {t3.A} and {t3.B}");
// Output:
// t3: 17 and 3.14

// ğŸ‘‰ Explicitly declare the type of each variable inside parentheses
var t = ("post office", 3.6);
(string destination, double distance) = t;
Console.WriteLine($"Distance to {destination} is {distance} kilometers.");
// Output:
// Distance to post office is 3.6 kilometers.

// ğŸ‘‰ Use the var keyword outside the parentheses
var t = ("post office", 3.6);
var (destination, distance) = t;
Console.WriteLine($"Distance to {destination} is {distance} kilometers.");
// Output:
// Distance to post office is 3.6 kilometers.

// ğŸ‘‰ Use existing variables
var destination = string.Empty;
var distance = 0.0;

var t = ("post office", 3.6);
(destination, distance) = t;
Console.WriteLine($"Distance to {destination} is {distance} kilometers.");
// Output:
// Distance to post office is 3.6 kilometers.
```

å…ƒç»„ç±»å‹å¯¹åº”çš„æ˜¯ä¸¤ç§ç»“æ„ï¼š System.ValueTuple æ˜¯å€¼ç±»å‹(ç»“æ„ä½“)ï¼Œè€Œ System.Tuple æ˜¯å¼•ç”¨ç±»å‹ ( class )ã€‚

C# tuples, which are backed by *System.ValueTuple* types, are different from tuples that are represented by *System.Tuple* types. The main differences are as follows:

- *System.ValueTuple* types are value types. *System.Tuple* types are reference types.
- *System.ValueTuple* types are mutable. *System.Tuple* types are immutable.
- Data members of *System.ValueTuple* types are fields. Data members of *System.Tuple* types are properties.


åœ¨ C# 7 ä¹‹å‰ï¼Œä½¿ç”¨å…ƒç»„ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚å®ƒä»¬ä½¿ç”¨é»˜è®¤çš„å­—æ®µåç§° Itemï¼Œå¹¶ä¸”è¯¥è¯­è¨€æ²¡æœ‰åƒå¤§å¤šæ•°å…¶ä»–è¯­è¨€(Pythonã€Scala)é‚£æ ·ä¸ºå®ƒä»¬æä¾›è¯­æ³•ç³–ã€‚

```C#
// System.ValueTuple usage
var tuple = ValueTuple.Create(123, "abc");
(int foo, string bar) = tuple;

// System.Tuple usage
var tuple = Tuple.Create(123, "abc");
(int foo, string bar) = tuple;
```

åœ¨å¤§éƒ¨åˆ†æ”¯æŒ Tuple çš„è¯­è¨€ä¸­ï¼Œå¸¸å¸¸è¡¨ç¤ºæˆå‘˜æ•°ç›®ç¡®å®šï¼Œæ¯ä¸ªæˆå‘˜ç±»å‹ä¹Ÿç¡®å®šçš„ç»“æ„ã€‚å¸¸å¸¸ç”¨äºè¡¨ç¤ºå‡½æ•°çš„å¤šä¸ªè¿”å›å€¼æˆ–è€…æŸ¥è¯¢çš„ç»“æœç­‰ï¼Œæˆ–è€…é¿å…ä¸ºä¸€äº›ç®€å•çš„ç»“æ„æˆ–å¯¹è±¡è€Œå»æ–°å»ºä¸€ä¸ªç±»ã€‚Tuple åº”å½“æ˜¯å¼ºç±»å‹çš„ï¼Œå³æ‰€æœ‰æˆå‘˜çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶ç¡®å®šã€‚Tuple å¯ä»¥çœ‹ä½œä¸ç”¨äº‹å…ˆå£°æ˜çš„ç»“æ„ä½“ï¼Œå¯ä»¥æ ¹æ®æ‰€ä½¿ç”¨çš„åœºåˆçµæ´»åœ°åˆ›å»ºã€‚

åˆ›å»ºå…ƒç»„å„ç§æ–¹å¼ï¼š

```C#
var ValueTuple = (1, 2);                           // ä½¿ç”¨è¯­æ³•ç³–åˆ›å»ºå…ƒç»„ ValueTuple
var ValueTuple2 = ValueTuple.Create(1, 2);         // ä½¿ç”¨é™æ€æ–¹æ³• Create åˆ›å»ºå…ƒç»„
var ValueTuple3 = new ValueTuple<int, int>(1, 2);  // ä½¿ç”¨ new è¿ç®—ç¬¦åˆ›å»ºå…ƒç»„
var tuple = new Tuple<int,int>(1,2);                // åˆ›å»ºå…ƒç»„ç±»å®ä¾‹
(string Alpha, string Beta) namedLetters = ("a", "b"); // å‘½åå…ƒç»„
var msg = new { a = "XYZ", b = new int[]{1, 2, 3}, c = new {s = "ABC"} }; // anonymous type
var msg = new Tuple<String, int[], Tuple<String, int>>("XYZ", new int[]{1, 2, 3}, Tuple.Create("ABC", 123));
```

åˆ©ç”¨ Tuple é™æ€æ–¹æ³•æ„å»ºå…ƒç»„ï¼Œæœ€å¤šæ”¯æŒå…«ä¸ªå…ƒç´ ï¼Œå¦‚æœæˆå‘˜è¶…è¿‡ï¼Œå¯ä»¥å°†ç¬¬ 8 ä¸ªæˆå‘˜å½“æˆä¸€ä¸ªå…ƒç»„ï¼Œé€šè¿‡å…ƒç¥–çš„åµŒå¥—å»å®Œæˆã€‚

å®šä¹‰å…ƒç»„æ—¶ï¼Œæ¯å­é¡¹é»˜è®¤å‘½åä¸º Item1ã€Item2ã€Item3 ç­‰ï¼ŒC# 7ã€‚0 å¼•å…¥ ValueTuple æ”¯æŒè‡ªå®šä¹‰ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•å®šåˆ¶ Tupleï¼š

- é€šè¿‡æ‰©å±•æ–¹æ³•å®ç°ï¼Œåªæ˜¯æ­¤æ—¶ä¸å†æ˜¯å±æ€§ï¼Œå˜æˆäº†æ–¹æ³•ã€‚å¯ä»¥å®šä¹‰å¤šä¸ªæ‰©å±•æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥æŒ‰åç§°æ£€ç´¢ï¼›
- è‡ªå®šä¹‰ç±»ï¼Œå°è£… Tuple æä¾›å›ºåŒ–å±æ€§è¯»å–å­—æ®µï¼›
- è‡ªå®šä¹‰ dynamic ç±»ï¼Œå°è£… Tuple æä¾›åŠ¨æ€å±æ€§æˆ–å›ºåŒ–å±æ€§è¯»å–å­—æ®µï¼›
- æ´¾ç”Ÿ Tuple ç±»ï¼Œæä¾›å›ºåŒ–å±æ€§è¯»å–å­—æ®µï¼›

å–å€¼ï¼š

    var unnamed = (1, 2);
    var named = (first: 1, second: 2);
    var tuple1 = new Tuple<int, int, int, int, int, int,  List<int>>(1, 1, 1, 1, 1,  1, new List<int>() { 2, 3 });
    var tuple2 = new Tuple<int, int, int, int, int, int, int, Tuple<int, int>>(1, 1, 1, 1, 1, 1, 1, new Tuple<int,int>(2,3));
    var u = unnamed.Item1;
    ar o = named.first;
    var k = tuple1.Item7[0]; 
    var l = tuple2.Rest.Item2; 

ä½œä¸ºæ–¹æ³•è¿”å›å€¼

    private static Tuple<int,int>  testTuple()
    {
        int i = 0;
        int j = 1;
        return new Tuple<int, int>(i, j);
    }

C# 7.3 æä¾› == å’Œ != æ¯”è¾ƒè¿ç®—ï¼Œä»¥åŠç›¸ç­‰çš„å¯ç©ºå…ƒç»„æå‡è½¬æ¢ï¼š

```C#
var left = (a: 5, b: 10);
var right = (a: 5, b: 10);
Console.WriteLine(left == right);  // displays 'true'

var left = (a: 5, b: 10);
var right = (a: 5, b: 10);
(int a, int b)? nullableTuple = right;
Console.WriteLine(left == nullableTuple);  // Also true
```


## ==âš¡ try-catch å¼‚å¸¸å¤„ç†

æœ€ç®€å•å†™æ³• 

    try{
        Console.ReadKey();
    } catch {} // InvalidOperationException


try-catchï¼Œä½¿ç”¨ when æ¡ä»¶åˆ¤æ–­ï¼Œthrow å†æŠ›å‡º

    object o2 = null;
    try
    {
        int i2 = (int)o2;   // Error
    }

    catch (ArgumentException e) when (e.ParamName == "â€¦")
    {
    }

    catch (IOException e)
    {
        // Extract some information from this exception, and then
        // re-throw it to the parent method.
        if (e.Source != null)
            Console.WriteLine("IOException source: {0}", e.Source);
        throw;
    }

    catch (InvalidCastException e)
    {
        // Perform some action here, and then throw a new exception.
        throw new YourCustomException("Put your error message here.", e);
    }

try-finally

    public class ThrowTestA
    {
        static void Main()
        {
            int i = 123;
            string s = "Some string";
            object obj = s;

            try
            {
                // Invalid conversion; obj contains a string, not a numeric type.
                i = (int)obj;

                // The following statement is not run.
                Console.WriteLine("WriteLine at the end of the try block.");
            }
            finally
            {
                Console.WriteLine("\nExecution of the finally block after an unhandled\n" +
                    "error depends on how the exception unwind operation is triggered.");
                Console.WriteLine("i = {0}", i);
            }
        }
        // Output:
        // Unhandled Exception: System.InvalidCastException: Specified cast is not valid.
        //
        // Execution of the finally block after an unhandled
        // error depends on how the exception unwind operation is triggered.
        // i = 123
    }

try-catch-finally

    public class EHClass
    {
        void ReadFile(int index)
        {
            // To run this code, substitute a valid path from your local machine
            string path = @"c:\users\public\test.txt";
            System.IO.StreamReader file = new System.IO.StreamReader(path);
            char[] buffer = new char[10];
            try
            {
                file.ReadBlock(buffer, index, buffer.Length);
            }
            catch (System.IO.IOException e)
            {
                Console.WriteLine("Error reading from {0}. Message = {1}", path, e.Message);
            }

            finally
            {
                if (file != null)
                {
                    file.Close();
                }
            }
            // Do something with buffer...
        }
    }


try and Asyncï¼š

    public async Task DoSomethingAsync()
    {
        Task<string> theTask = DelayAsync();

        try
        {
            string result = await theTask;
            Debug.WriteLine("Result: " + result);
        }
        catch (Exception ex)
        {
            Debug.WriteLine("Exception Message: " + ex.Message);
        }
        Debug.WriteLine("Task IsCanceled: " + theTask.IsCanceled);
        Debug.WriteLine("Task IsFaulted:  " + theTask.IsFaulted);
        if (theTask.Exception != null)
        {
            Debug.WriteLine("Task Exception Message: "
                + theTask.Exception.Message);
            Debug.WriteLine("Task Inner Exception Message: "
                + theTask.Exception.InnerException.Message);
        }
    }

    private async Task<string> DelayAsync()
    {
        await Task.Delay(100);

        // Uncomment each of the following lines to
        // demonstrate exception handling.

        //throw new OperationCanceledException("canceled");
        //throw new Exception("Something happened.");
        return "Done";
    }

    // Output when no exception is thrown in the awaited method:
    //   Result: Done
    //   Task IsCanceled: False
    //   Task IsFaulted:  False

    // Output when an Exception is thrown in the awaited method:
    //   Exception Message: Something happened.
    //   Task IsCanceled: False
    //   Task IsFaulted:  True
    //   Task Exception Message: One or more errors occurred.
    //   Task Inner Exception Message: Something happened.

    // Output when a OperationCanceledException or TaskCanceledException
    // is thrown in the awaited method:
    //   Exception Message: canceled
    //   Task IsCanceled: True
    //   Task IsFaulted:  False

Task.WhenAll example

    public async Task DoMultipleAsync()
    {
        Task theTask1 = ExcAsync(info: "First Task");
        Task theTask2 = ExcAsync(info: "Second Task");
        Task theTask3 = ExcAsync(info: "Third Task");

        Task allTasks = Task.WhenAll(theTask1, theTask2, theTask3);

        try
        {
            await allTasks;
        }
        catch (Exception ex)
        {
            Debug.WriteLine("Exception: " + ex.Message);
            Debug.WriteLine("Task IsFaulted: " + allTasks.IsFaulted);
            foreach (var inEx in allTasks.Exception.InnerExceptions)
            {
                Debug.WriteLine("Task Inner Exception: " + inEx.Message);
            }
        }
    }

    private async Task ExcAsync(string info)
    {
        await Task.Delay(100);

        throw new Exception("Error-" + info);
    }

    // Output:
    //   Exception: Error-First Task
    //   Task IsFaulted: True
    //   Task Inner Exception: Error-First Task
    //   Task Inner Exception: Error-Second Task
    //   Task Inner Exception: Error-Third Task



## ==âš¡ checked & unchecked

checked å…³é”®å­—ç”¨äºå¯¹æ•´å‹ç±»å‹ç®—æœ¯è¿ç®—å’Œè½¬æ¢æ˜¾å¼å¯ç”¨æº¢å‡ºæ£€æŸ¥ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè¡¨è¾¾å¼ä»…åŒ…å«å¸¸é‡å€¼ï¼Œä¸”äº§ç”Ÿçš„å€¼åœ¨ç›®æ ‡ç±»å‹èŒƒå›´ä¹‹å¤–ï¼Œåˆ™ä¼šå¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ã€‚ 

å¦‚æœè¡¨è¾¾å¼åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡é‡å€¼ï¼Œåˆ™ç¼–è¯‘å™¨æ£€æµ‹ä¸åˆ°æº¢å‡ºã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œè®¡ç®—èµ‹ç»™ i2 çš„è¡¨è¾¾å¼ä¸ä¼šå¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ã€‚

    // The following example causes compiler error CS0220 
    // because 2147483647 is the maximum value for integers.
    //int i1 = 2147483647 + 10;

    int ten = 10;
    int i2 = 2147483647 + ten;

    Console.WriteLine(i2);
    // 2,147,483,647 + 10 = -2,147,483,639


å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨é€‰é¡¹ã€ç¯å¢ƒé…ç½®æˆ–ä½¿ç”¨ checked å…³é”®å­—æ¥å¯ç”¨æº¢å‡ºæ£€æŸ¥ã€‚ ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ checked è¡¨è¾¾å¼æˆ– checked å—ï¼Œåœ¨è¿è¡Œæ—¶æ£€æµ‹ç”±å‰é¢çš„æ±‚å’Œè®¡ç®—å¯¼è‡´çš„æº¢å‡ºã€‚ 

    // If the previous sum is attempted in a checked environment, an
    // OverflowException error is raised.

    // Checked expression.
    Console.WriteLine(checked(2147483647 + ten));

    // Checked block.
    checked
    {
        int i3 = 2147483647 + ten;
        Console.WriteLine(i3);
    }

å¯ä»¥ä½¿ç”¨ unchecked å…³é”®å­—é˜»æ­¢æº¢å‡ºæ£€æŸ¥ã€‚

ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ checked å¯ç”¨è¿è¡Œæ—¶æº¢å‡ºæ£€æŸ¥ã€‚


    class OverFlowTest
    {
        // Set maxIntValue to the maximum value for integers.
        static int maxIntValue = 2147483647;

        // Using a checked expression.
        static int CheckedMethod()
        {
            int z = 0;
            try
            {
                // The following line raises an exception because it is checked.
                z = checked(maxIntValue + 10);
            }
            catch (System.OverflowException e)
            {
                // The following line displays information about the error.
                Console.WriteLine("CHECKED and CAUGHT:  " + e.ToString());
            }
            // The value of z is still 0.
            return z;
        }

        // Using an unchecked expression.
        static int UncheckedMethod()
        {
            int z = 0;
            try
            {
                // The following calculation is unchecked and will not
                // raise an exception.
                z = maxIntValue + 10;
            }
            catch (System.OverflowException e)
            {
                // The following line will not be executed.
                Console.WriteLine("UNCHECKED and CAUGHT:  " + e.ToString());
            }
            // Because of the undetected overflow, the sum of 2147483647 + 10 is
            // returned as -2147483639.
            return z;
        }

        static void Main()
        {
            Console.WriteLine("\nCHECKED output value is: {0}",
                              CheckedMethod());
            Console.WriteLine("UNCHECKED output value is: {0}",
                              UncheckedMethod());
        }
    }


## ==âš¡ String Format & Interpolation å­—ç¬¦ä¸²æ ¼å¼ä¸æ’å€¼
- https://docs.microsoft.com/zh-cn/dotnet/csharp/tutorials/exploration/interpolated-strings-local
- https://docs.microsoft.com/en-us/dotnet/api/system.string#methods

C# Special Characters

    @, the verbatim identifier character.
    $, the interpolated string character.

C# 6.0 æ”¯æŒå­—ç¬¦ä¸²æ’å€¼

    using System;
    using System.Collections.Generic;

    public class Example
    {
        public static void Main()
        {

            var name = "h";
            Console.WriteLine("Hello " + name +"!");
            Console.WriteLine($"Hello {name}!");
            Console.WriteLine($"Hello {name.ToUpper()}!");

            var titles = new Dictionary<string, string>()
            {
                ["Doyle, Arthur Conan"] = "Hound of the Baskervilles, The",
                ["London, Jack"] = "Call of the Wild, The",
                ["Shakespeare, William"] = "Tempest, The"
            };

            Console.WriteLine("Author and Title List");
            Console.WriteLine();
            Console.WriteLine($"|{"Author",-25}|{"Title",30}|");
            foreach (var title in titles)
                Console.WriteLine($"|{title.Key,-25}|{title.Value,30}|");
        }
    }

åˆ›å»ºè€…å§“åé‡‡ç”¨å·¦å¯¹é½æ–¹å¼ï¼Œå…¶æ‰€å†™æ ‡é¢˜é‡‡ç”¨å³å¯¹é½æ–¹å¼ã€‚ é€šè¿‡åœ¨å†…æ’è¡¨è¾¾å¼åé¢æ·»åŠ ä¸€ä¸ªé€—å·ï¼ˆâ€œ,â€ï¼‰å¹¶æŒ‡å®šâ€œæœ€å°â€ å­—æ®µå®½åº¦æ¥æŒ‡å®šå¯¹é½æ–¹å¼ã€‚ å¦‚æœæŒ‡å®šçš„å€¼æ˜¯æ­£æ•°ï¼Œåˆ™è¯¥å­—æ®µä¸ºå³å¯¹é½ã€‚ å¦‚æœå®ƒä¸ºè´Ÿæ•°ï¼Œåˆ™è¯¥å­—æ®µä¸ºå·¦å¯¹é½ã€‚

    using System;

    public class TipCalculator
    {
        private const double tipRate = 0.18;
        public static void Main(string[] args)
        {
            double billTotal;
            if (args.Length == 0 || ! Double.TryParse(args[0], out billTotal))
            {
                Console.WriteLine("usage: TIPCALC total");
                return;
            }
            double tip = billTotal * tipRate;
            Console.WriteLine();
            Console.WriteLine($"Bill total:\t{billTotal,8:c}");
            Console.WriteLine($"Tip total/rate:\t{tip,8:c} ({tipRate:p1})");
            Console.WriteLine(("").PadRight(24, '-'));
            Console.WriteLine($"Grand total:\t{billTotal + tip,8:c}");
        }
    }

    /*
    >tipcalc 52.23

    Bill total:       $52.23
    Tip total/rate:    $9.40 (18.0 %)
    ------------------------
    Grand total:      $61.63
    */

æ ¼å¼è®¾ç½®æœ‰ä¸¤ä¸ªä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ•°æ®æ¥æºï¼Œå®½åº¦å’Œå·¦å³å¯¹é½ï¼Œæ•°æ®ç±»å‹å’Œå°æ•°ç‚¹ä½æ•°ï¼Œæ ¼å¼ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚ä»¥ `"{0,-16:C4}"` ä¸ºä¾‹ï¼Œç¬¬ä¸€ä¸ª 0 è¡¨æ•°æ®æ¥æºè‡ªç´§è·Ÿæ ¼å¼å­—ç¬¦ä¸²åçš„å˜é‡ï¼Œå†åé¢ä¸€ä¸ªå˜é‡å‚æ•°å°±æ˜¯ `{1}` ç­‰ç­‰ã€‚ç„¶åï¼Œæ˜¯é€—å·åé¢æŒ‡å®šçš„å®½åº¦ 16 ä¸ªå­—ç¬¦å’Œè´Ÿå·æŒ‡å®šå·¦å¯¹é½ï¼Œé»˜è®¤ä¸ä½¿ç”¨è´Ÿå·å³å¯¹é½ï¼Œåªè¦å®½åº¦è¶³å¤Ÿã€‚æœ€åæ˜¯å†’å·åé¢æŒ‡å®šçš„æ•°æ®ç±»å‹ C - Currency è´§å¸ï¼ŒE - Scientific ç§‘å­¦è®¡æ•°æ³•ã€‚æ•°æ®ç±»å‹åé¢çš„æ•°å­—æŒ‡å®šå°æ•°ç‚¹åçš„ä½æ•°ï¼Œé»˜è®¤ä¸º 2 ä½å°æ•°ã€‚å¯¹äºä¸åŒçš„æ•°æ®æ¥æºï¼Œæ¯”å¦‚ D è¡¨ç¤ºåè¿›åˆ¶æ•°å€¼æ ¼å¼ï¼Œæˆ–è€…è¡¨ç¤ºæ—¥æœŸçš„é•¿æ ¼å¼ã€‚

    decimal price = 169.32m;
    string[] format = new string[]{
        "{0,16}", "{0,16}", "{0:C4}", "{0:C2}", 
        "{0,16:C4}", "{0,16:C2}", "{0,-16:C4}", "{0,-16:C2}",
        "{0,16:E4}", "{0,16:E2}", "{0,-16:E4}", "{0,-16:E2}"
        };
    Console.WriteLine(string.Join("\n", format), price);
    
    string guidString = "ba748d5c-ae5f-4cca-84e5-1ac5291c38cb";
    string[] gf = new string[]{"D", "d", "N", "n", "P", "p", "B", "b", "X", "x"};
    gf.Count(f => {
            try{
                Console.WriteLine("GUID[{0}]: {1}", f, Guid.ParseExact(guidString, f)); // D & d
            } catch{}
            return true;
        });

è¾“å‡ºæ•ˆæœï¼š

              169.32
              169.32
    ï¿¥169.3200
    ï¿¥169.32
           ï¿¥169.3200
             ï¿¥169.32
    ï¿¥169.3200       
    ï¿¥169.32         
         1.6932E+002
           1.69E+002
    1.6932E+002     
    1.69E+002       
    GUID[D]: ba748d5c-ae5f-4cca-84e5-1ac5291c38cb
    GUID[d]: ba748d5c-ae5f-4cca-84e5-1ac5291c38cb



è‹¥è¦é€å­—è§£é‡Šè½¬ä¹‰åºåˆ—ï¼Œå¯ä½¿ç”¨é€å­—å­—ç¬¦ä¸²æ–‡æœ¬ã€‚ å†…æ’é€å­—å­—ç¬¦ä¸²ä»¥ $ å­—ç¬¦å¼€å¤´ï¼Œåè·Ÿ @ å­—ç¬¦ã€‚ ä» C# 8.0 å¼€å§‹ï¼Œå¯ä»¥æŒ‰ä»»æ„é¡ºåºä½¿ç”¨ $ å’Œ @ æ ‡è®°ï¼š$@"..." å’Œ @$"..." å‡ä¸ºæœ‰æ•ˆçš„å†…æ’é€å­—å­—ç¬¦ä¸²ã€‚

    var xs = new int[] { 1, 2, 7, 9 };
    var ys = new int[] { 7, 9, 12 };
    Console.WriteLine($"Find the intersection of the {{{string.Join(", ",xs)}}} and {{{string.Join(", ",ys)}}} sets.");

    var userName = "Jane";
    var stringWithEscapes = $"C:\\Users\\{userName}\\Documents";
    var verbatimInterpolated = $@"C:\Users\{userName}\Documents";
    Console.WriteLine(stringWithEscapes);
    Console.WriteLine(verbatimInterpolated);

    // Expected output:
    // Find the intersection of the {1, 2, 7, 9} and {7, 9, 12} sets.
    // C:\Users\Jane\Documents
    // C:\Users\Jane\Documents

å› ä¸ºå†’å· (:) åœ¨å…·æœ‰å†…æ’è¡¨è¾¾å¼çš„é¡¹ä¸­å…·æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œåœ¨å†…æ’è¡¨è¾¾å¼ä¸­ä½¿ç”¨ä¸‰å…ƒæ¡ä»¶è¿ç®—ç¬¦ ?: è¯·å°†è¡¨è¾¾å¼æ”¾åœ¨æ‹¬å·å†…ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

    var rand = new Random();
    for (int i = 0; i < 7; i++)
    {
        Console.WriteLine($"Coin flip: {(rand.NextDouble() < 0.5 ? "heads" : "tails")}");
    }

æ ¼å¼åŒ–å­—ç¬¦å’Œ Console.WriteLine(format, args....) æ–¹æ³•ä½¿ç”¨çš„ç›¸åŒï¼š

    using System;
    class Sample
    {
        enum Color {Yellow = 1, Blue, Green};
        static DateTime thisDate = DateTime.Now;

        public static void Main()
        {
            Console.Clear();

            // Format a negative integer or floating-point number in various ways.
            Console.WriteLine("Standard Numeric Format Specifiers");
            Console.WriteLine(
                "(C) Currency: . . . . . . . . {0:C}\n" +
                "(D) Decimal:. . . . . . . . . {0:D}\n" +
                "(E) Scientific: . . . . . . . {1:E}\n" +
                "(F) Fixed point:. . . . . . . {1:F}\n" +
                "(G) General:. . . . . . . . . {0:G}\n" +
                "    (default):. . . . . . . . {0} (default = 'G')\n" +
                "(N) Number: . . . . . . . . . {0:N}\n" +
                "(P) Percent:. . . . . . . . . {1:P}\n" +
                "(R) Round-trip: . . . . . . . {1:R}\n" +
                "(X) Hexadecimal:. . . . . . . {0:X}\n",
                -123, -123.45f);

            // Format the current date in various ways.
            Console.WriteLine("Standard DateTime Format Specifiers");
            Console.WriteLine(
                "(d) Short date: . . . . . . . {0:d}\n" +
                "(D) Long date:. . . . . . . . {0:D}\n" +
                "(t) Short time: . . . . . . . {0:t}\n" +
                "(T) Long time:. . . . . . . . {0:T}\n" +
                "(f) Full date/short time: . . {0:f}\n" +
                "(F) Full date/long time:. . . {0:F}\n" +
                "(g) General date/short time:. {0:g}\n" +
                "(G) General date/long time: . {0:G}\n" +
                "    (default):. . . . . . . . {0} (default = 'G')\n" +
                "(M) Month:. . . . . . . . . . {0:M}\n" +
                "(R) RFC1123:. . . . . . . . . {0:R}\n" +
                "(s) Sortable: . . . . . . . . {0:s}\n" +
                "(u) Universal sortable: . . . {0:u} (invariant)\n" +
                "(U) Universal full date/time: {0:U}\n" +
                "(Y) Year: . . . . . . . . . . {0:Y}\n",
                thisDate);

            // Format a Color enumeration value in various ways.
            Console.WriteLine("Standard Enumeration Format Specifiers");
            Console.WriteLine(
                "(G) General:. . . . . . . . . {0:G}\n" +
                "    (default):. . . . . . . . {0} (default = 'G')\n" +
                "(F) Flags:. . . . . . . . . . {0:F} (flags or integer)\n" +
                "(D) Decimal number: . . . . . {0:D}\n" +
                "(X) Hexadecimal:. . . . . . . {0:X}\n",
                Color.Green);
        }
    }

This code example produces the following results:

    Standard Numeric Format Specifiers
    (C) Currency: . . . . . . . . ($123.00)
    (D) Decimal:. . . . . . . . . -123
    (E) Scientific: . . . . . . . -1.234500E+002
    (F) Fixed point:. . . . . . . -123.45
    (G) General:. . . . . . . . . -123
        (default):. . . . . . . . -123 (default = 'G')
    (N) Number: . . . . . . . . . -123.00
    (P) Percent:. . . . . . . . . -12,345.00 %
    (R) Round-trip: . . . . . . . -123.45
    (X) Hexadecimal:. . . . . . . FFFFFF85

    Standard DateTime Format Specifiers
    (d) Short date: . . . . . . . 6/26/2004
    (D) Long date:. . . . . . . . Saturday, June 26, 2004
    (t) Short time: . . . . . . . 8:11 PM
    (T) Long time:. . . . . . . . 8:11:04 PM
    (f) Full date/short time: . . Saturday, June 26, 2004 8:11 PM
    (F) Full date/long time:. . . Saturday, June 26, 2004 8:11:04 PM
    (g) General date/short time:. 6/26/2004 8:11 PM
    (G) General date/long time: . 6/26/2004 8:11:04 PM
        (default):. . . . . . . . 6/26/2004 8:11:04 PM (default = 'G')
    (M) Month:. . . . . . . . . . June 26
    (R) RFC1123:. . . . . . . . . Sat, 26 Jun 2004 20:11:04 GMT
    (s) Sortable: . . . . . . . . 2004-06-26T20:11:04
    (u) Universal sortable: . . . 2004-06-26 20:11:04Z (invariant)
    (U) Universal full date/time: Sunday, June 27, 2004 3:11:04 AM
    (Y) Year: . . . . . . . . . . June, 2004

    Standard Enumeration Format Specifiers
    (G) General:. . . . . . . . . Green
        (default):. . . . . . . . Green (default = 'G')
    (F) Flags:. . . . . . . . . . Green (flags or integer)
    (D) Decimal number: . . . . . 3
    (X) Hexadecimal:. . . . . . . 00000003

å­—ç¬¦ä¸²ç±»æä¾›å¾ˆå¤šæœ‰ç”¨çš„å¤„ç†å‡½æ•°ï¼Œå¦‚ StartsWith/ EndsWith/ Equals/ IndexOf/ LastIndexOf ç­‰ã€‚


## ==âš¡ Numbers int/float/decimal
https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/value-types

int ç±»å‹è¡¨ç¤ºæ•´æ•°ï¼Œå¦‚æœè¿ç®—ç”Ÿæˆçš„å€¼è¶…è¿‡è¿™äº›é™å€¼ï¼Œåˆ™ä¼šå‡ºç°ä¸‹æº¢æˆ–æº¢å‡ºçš„æƒ…å†µã€‚ ç­”æ¡ˆä¼¼ä¹æ˜¯ä»ä¸€ä¸ªé™å€¼å¾ªç¯è¦†ç›–åˆ°å¦ä¸€ä¸ªé™å€¼çš„èŒƒå›´ã€‚


    int max = int.MaxValue;
    int min = int.MinValue;
    Console.WriteLine($"The range of integers is {min} to {max}");

    int what = max + 3;
    Console.WriteLine($"An example of overflow: {what + 2}");

è¾“å‡ºï¼š

    The range of integers is -2147483648 to 2147483647
    An example of overflow: -2147483644

å¦‚æœ int ç±»å‹æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œè¿˜ä¼šç”¨åˆ°é™å€¼å’Œç²¾åº¦ä¸åŒçš„æ•°å­—ç±»å‹ã€‚

double åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œæµ®ç‚¹æ•°å¯ç”¨äºè¡¨ç¤ºæ•°é‡çº§å¯èƒ½éå¸¸å¤§æˆ–éå¸¸å°çš„éæ•´æ•°ã€‚ åŒç²¾åº¦æ˜¯ä¸€ä¸ªç›¸å¯¹æœ¯è¯­ï¼Œæè¿°ç”¨äºå­˜å‚¨å€¼çš„äºŒè¿›åˆ¶æ•°ä½æ•°ã€‚ åŒç²¾åº¦æ•°å­—çš„äºŒè¿›åˆ¶æ•°ä½æ•°æ˜¯å•ç²¾åº¦ float çš„ä¸¤å€ã€‚ åœ¨æ–°å¼è®¡ç®—æœºä¸Šï¼Œä½¿ç”¨åŒç²¾åº¦æ•°å­—æ¯”ä½¿ç”¨å•ç²¾åº¦æ•°å­—æ›´ä¸ºå¸¸è§ã€‚ 


æ‰“å°å‡ºæ¥çš„è¿™äº›å€¼ç”¨ç§‘å­¦è®°æ•°æ³•è¡¨ç¤ºã€‚ E å·¦ä¾§ä¸ºæœ‰æ•ˆæ•°å­—ã€‚ å³ä¾§ä¸ºæ˜¯ 10 çš„ n æ¬¡å¹‚ã€‚ä¸æ•°å­¦ä¸Šçš„åè¿›åˆ¶æ•°å­—ä¸€æ ·ï¼ŒC# ä¸­çš„åŒç²¾åº¦å€¼å¯èƒ½ä¼šæœ‰å››èˆäº”å…¥è¯¯å·®ã€‚ è¯•è¿è¡Œä»¥ä¸‹ä»£ç ï¼š

    double max = double.MaxValue;
    double min = double.MinValue;
    Console.WriteLine($"The range of double is {min} to {max}");
    double third = 1.0 / 3.0;
    Console.WriteLine(third);

è¾“å‡ºï¼š

    The range of double is -1.7976931348623157E+308 to 1.7976931348623157E+308
    0.3333333333333333


decimal ç±»å‹çš„èŒƒå›´è¾ƒå°ï¼Œä½†ç²¾åº¦é«˜äº doubleã€‚

    decimal min = decimal.MinValue;
    decimal max = decimal.MaxValue;
    Console.WriteLine($"The range of the decimal type is {min} to {max}");

    double a = 1.0;
    double b = 3.0;
    Console.WriteLine(a / b);

    decimal c = 1.0M;
    decimal d = 3.0M;
    Console.WriteLine(c / d);

è¾“å‡ºï¼š

    The range of the decimal type is -79228162514264337593543950335 to 79228162514264337593543950335
    0.3333333333333333
    0.3333333333333333333333333333

- æ•°å­—ä¸­çš„ M åç¼€æŒ‡æ˜äº†å¸¸æ•°åº”å¦‚ä½•ä½¿ç”¨ decimal ç±»å‹ã€‚
- å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨åè¿›åˆ¶ç±»å‹æ‰§è¡Œæ•°å­¦è¿ç®—æ—¶ï¼Œåè¿›åˆ¶å°æ•°ç‚¹å³ä¾§çš„æ•°å­—æ›´å¤šã€‚
- æ•°å­—ä¸­çš„ M åç¼€æŒ‡æ˜äº†å¸¸æ•°åº”å¦‚ä½•ä½¿ç”¨ decimal ç±»å‹ã€‚ å¦åˆ™ï¼Œç¼–è¯‘å™¨å‡å®šä¸º double ç±»å‹ã€‚


æç¤ºï¼š.NET åŒ…å« PI å¸¸æ•° Math.PIï¼Œå¯ç”¨äºç›¸åº”çš„å€¼è®¡ç®—ã€‚ ä¸ System.Math ç±»å‹ä¸­å£°æ˜çš„æ‰€æœ‰å¸¸é‡ä¸€æ ·ï¼ŒMath.PI ä¹Ÿæ˜¯ double å€¼ã€‚

C# æ”¯æŒä»¥ä¸‹é¢„å®šä¹‰æ•´å‹ç±»å‹ï¼š

    System.SByte    sbyte      -128 ~ 127   8 ä½å¸¦ç¬¦å·æ•´æ•°
    System.Byte     byte          0 ~ 255   æ— ç¬¦å·çš„ 8 ä½æ•´æ•°
    System.Int16    short   -32,768 ~ 32,767    æœ‰ç¬¦å· 16 ä½æ•´æ•°
    System.UInt16   ushort        0 ~ 65,535    æ— ç¬¦å· 16 ä½æ•´æ•°
    System.Int32    int     -2,147,483,648 ~ 2,147,483,647  å¸¦ç¬¦å·çš„ 32 ä½æ•´æ•°
    System.UInt32   uint          0 ~ 4,294,967,295 æ— ç¬¦å·çš„ 32 ä½æ•´æ•°
    System.Int64    long    -9,223,372,036,854,775,808 ~ 9,223,372,036,854,775,807  64 ä½å¸¦ç¬¦å·æ•´æ•°
    System.UInt64   ulong         0 ~ 18,446,744,073,709,551,615    æ— ç¬¦å· 64 ä½æ•´æ•°

C# æ”¯æŒä»¥ä¸‹é¢„å®šä¹‰æµ®ç‚¹ç±»å‹ï¼š

    System.Single   float   Â±1.5 x 10âˆ’45 ~ Â±3.4 x 1038  å¤§çº¦ 6-9 ä½æ•°å­—  4 ä¸ªå­—èŠ‚
    System.Double   double  Â±5.0 Ã— 10âˆ’324 ~ Â±1.7 Ã— 10308    å¤§çº¦ 15-17 ä½æ•°å­—    8 ä¸ªå­—èŠ‚
    System.Decimal  decimal Â±1.0 x 10-28 ~ Â±7.9228 x 1028   28-29 ä½ 16 ä¸ªå­—èŠ‚

ä¸‹è¡¨æ˜¾ç¤ºå†…ç½®æ•°å€¼ç±»å‹ä¹‹é—´çš„é¢„å®šä¹‰éšå¼è½¬æ¢ï¼š

    sbyte   -> shortã€intã€longã€floatã€double æˆ– decimal
    byte    -> shortã€ushortã€intã€uintã€longã€ulongã€floatã€double æˆ– decimal
    short   -> intã€longã€floatã€double æˆ– decimal
    ushort  -> intã€uintã€longã€ulongã€floatã€double æˆ– decimalã€‚
    int     -> longã€floatã€double æˆ– decimal
    uint    -> longã€ulongã€floatã€double æˆ– decimal
    long    -> floatã€double æˆ– decimal
    ulong   -> floatã€double æˆ– decimal
    float   -> double


## ==âš¡ char & string
https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/char
https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/strings/
https://docs.microsoft.com/zh-cn/dotnet/standard/base-types/regular-expressions


char ç±»å‹å…³é”®å­—æ˜¯ .NET System.Char ç»“æ„ç±»å‹çš„åˆ«åï¼Œå®ƒè¡¨ç¤º Unicode UTF-16 å­—ç¬¦ã€‚char ç±»å‹çš„é»˜è®¤å€¼ä¸º \0ï¼Œå³ U+0000ã€‚å­—ç¬¦ä¸²ç±»å‹å°†æ–‡æœ¬è¡¨ç¤ºä¸º char å€¼çš„åºåˆ—ã€‚

    char    U+0000 åˆ° U+FFFF 16 ä½    System.Char

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŒ‡å®š char å€¼ï¼š

- å­—ç¬¦æ–‡æœ¬ã€‚
- Unicode è½¬ä¹‰åºåˆ—ï¼Œå®ƒæ˜¯ \u åè·Ÿå­—ç¬¦ä»£ç çš„åå…­è¿›åˆ¶è¡¨ç¤ºå½¢å¼ï¼ˆå››ä¸ªç¬¦å·ï¼‰ã€‚
- åå…­è¿›åˆ¶è½¬ä¹‰åºåˆ—ï¼Œå®ƒæ˜¯ \x åè·Ÿå­—ç¬¦ä»£ç çš„åå…­è¿›åˆ¶è¡¨ç¤ºå½¢å¼ã€‚

ä¾‹å¦‚ï¼š

    var chars = new[]
    {
        'j',
        '\u006A',
        '\x006A',
        (char)106,
    };
    Console.WriteLine(string.Join(" ", chars));  // output: j j j j

å­—ç¬¦ä¸²æ˜¯å€¼ä¸ºæ–‡æœ¬çš„ String ç±»å‹å¯¹è±¡ã€‚ æ–‡æœ¬åœ¨å†…éƒ¨å­˜å‚¨ä¸º Char å¯¹è±¡çš„ä¾åºåªè¯»é›†åˆã€‚ åœ¨ C# å­—ç¬¦ä¸²æœ«å°¾æ²¡æœ‰ null ç»ˆæ­¢å­—ç¬¦ï¼›å› æ­¤ï¼Œä¸€ä¸ª C# å­—ç¬¦ä¸²å¯ä»¥åŒ…å«ä»»ä½•æ•°é‡çš„åµŒå…¥çš„ null å­—ç¬¦ ('\0')ã€‚ å­—ç¬¦ä¸²çš„ Length å±æ€§è¡¨ç¤ºå…¶åŒ…å«çš„ Char å¯¹è±¡æ•°é‡ï¼Œè€Œé Unicode å­—ç¬¦æ•°ã€‚ è‹¥è¦è®¿é—®å­—ç¬¦ä¸²ä¸­çš„å„ä¸ª Unicode ç ä½ï¼Œè¯·ä½¿ç”¨ StringInfo å¯¹è±¡ã€‚

å­—ç¬¦ä¸²å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒä»¬åœ¨åˆ›å»ºåæ— æ³•æ›´æ”¹ã€‚ çœ‹èµ·æ¥æ˜¯åœ¨ä¿®æ”¹å­—ç¬¦ä¸²çš„æ‰€æœ‰ String æ–¹æ³•å’Œ C# è¿ç®—ç¬¦å®é™…ä¸Šéƒ½æ˜¯åœ¨æ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ä¸­è¿”å›ç»“æœã€‚

å½“å­—ç¬¦ä¸²æ–‡æœ¬åŒ…å«åæ–œæ å­—ç¬¦ï¼ˆä¾‹å¦‚åœ¨æ–‡ä»¶è·¯å¾„ä¸­ï¼‰æ—¶ï¼Œå‡ºäºä¾¿æ·æ€§å’Œæ›´å¼ºçš„å¯è¯»æ€§çš„è€ƒè™‘ï¼Œä½¿ç”¨é€å­—å­—ç¬¦ä¸²ã€‚ ç”±äºé€å­—å­—ç¬¦ä¸²å°†æ–°çš„è¡Œå­—ç¬¦ä½œä¸ºå­—ç¬¦ä¸²æ–‡æœ¬çš„ä¸€éƒ¨åˆ†ä¿ç•™ï¼Œå› æ­¤å¯å°†å…¶ç”¨äºåˆå§‹åŒ–å¤šè¡Œå­—ç¬¦ä¸²ã€‚ ä½¿ç”¨åŒå¼•å·åœ¨é€å­—å­—ç¬¦ä¸²å†…éƒ¨åµŒå…¥å¼•å·ã€‚ ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºé€å­—å­—ç¬¦ä¸²çš„ä¸€äº›å¸¸è§ç”¨æ³•ï¼š

    string filePath = @"C:\Users\scoleridge\Documents\";
    //Output: C:\Users\scoleridge\Documents\

    string text = @"My pensive SARA ! thy soft cheek reclined
        Thus on mine arm, most soothing sweet it is
        To sit beside our Cot,...";
    /* Output:
    My pensive SARA ! thy soft cheek reclined
       Thus on mine arm, most soothing sweet it is
       To sit beside our Cot,...
    */

    string quote = @"Her name was ""Sara.""";
    //Output: Her name was "Sara."

å­—ç¬¦ä¸²è½¬ä¹‰åºåˆ—

    è½¬ä¹‰åºåˆ—    å­—ç¬¦åç§°    Unicode ç¼–ç 
    \'  å•å¼•å· 0x0027
    \"  åŒå¼•å· 0x0022
    \\  åæ–œæ  0x005C
    \0  null    0x0000
    \a  è­¦æŠ¥  0x0007
    \b  Backspace   0x0008
    \f  æ¢é¡µ  0x000C
    \n  æ¢è¡Œ  0x000A
    \r  å›è½¦  0x000D
    \t  æ°´å¹³åˆ¶è¡¨ç¬¦   0x0009
    \v  å‚ç›´åˆ¶è¡¨ç¬¦   0x000B
    \u  Unicode è½¬ä¹‰åºåˆ— (UTF-16)   \uHHHHï¼ˆèŒƒå›´ï¼š0000 - FFFFï¼›ç¤ºä¾‹ï¼š\u00E7 =â€œÃ§â€ï¼‰
    \U  Unicode è½¬ä¹‰åºåˆ— (UTF-32)   \U00HHHHHHï¼ˆèŒƒå›´ï¼š000000 - 10FFFFï¼›ç¤ºä¾‹ï¼š\U0001F47D =â€œğŸ‘½â€)
    \x  é™¤é•¿åº¦å¯å˜å¤–ï¼ŒUnicode è½¬ä¹‰åºåˆ—ä¸â€œ\uâ€ç±»ä¼¼  \xH[H][H][H]ï¼ˆèŒƒå›´ï¼š0 - FFFFï¼›ç¤ºä¾‹ï¼š\x00E7ã€\x0E7 æˆ– \xE7 =â€œÃ§â€ï¼‰

String.Split æ–¹æ³•é€šè¿‡åŸºäºä¸€ä¸ªæˆ–å¤šä¸ªåˆ†éš”ç¬¦ï¼Œä¹Ÿå¯ä»¥å¯é‡‡ç”¨å­—ç¬¦ä¸²æ•°ç»„æ¥æ‹†åˆ†è¾“å…¥å­—ç¬¦ä¸²ï¼Œä»»ä½•åˆ†éš”ç¬¦çš„è¿ç»­å®ä¾‹éƒ½ä¼šåœ¨è¾“å‡ºæ•°ç»„ä¸­ç”Ÿæˆç©ºå­—ç¬¦ä¸²ã€‚

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ç©ºæ ¼ã€é€—å·ã€å¥ç‚¹ã€å†’å·å’Œåˆ¶è¡¨ç¬¦ï¼Œæ‰€æœ‰å†…å®¹å‡åœ¨åŒ…å«è¿™äº›åˆ†éš”å­—ç¬¦çš„æ•°ç»„ä¸­ä¼ é€’åˆ° Splitã€‚

    char[] delimiterChars = { ' ', ',', '.', ':', '\t' };

    string text = "one\ttwo three:four,five six seven";
    System.Console.WriteLine($"Original text: '{text}'");

    string[] words = text.Split(delimiterChars);
    System.Console.WriteLine($"{words.Length} words in text:");

    foreach (var word in words)
    {
        System.Console.WriteLine($"<{word}>");
    }

    string str = @"var ng = new Range( 1,6);
    Console.WriteLine(Range.EndAt(2));
    Console.WriteLine(ng.GetOffsetAndLength(3));
    Console.WriteLine(Range.StartAt(2));";
    Console.WriteLine(string.Join("\n", (str.Split(new string[]{"Console"}, StringSplitOptions.None))));
    
    StringSplitOptions.None
    StringSplitOptions.RemoveEmptyEntries

è‹¥è¦è¿æ¥å­—ç¬¦ä¸²å˜é‡ï¼Œå¯ä½¿ç”¨ + æˆ– += è¿ç®—ç¬¦ã€å­—ç¬¦ä¸²å†…æ’æˆ– String.Formatã€String.Concatã€String.Joinã€StringBuilder.Append æ–¹æ³•ã€‚ + è¿ç®—ç¬¦æ˜“äºä½¿ç”¨ï¼Œæœ‰åˆ©äºäº§ç”Ÿç›´è§‚ä»£ç ã€‚ 

å¦ä¸€ä¸ªå­—ç¬¦ä¸²è¿æ¥æ–¹æ³•ä¸º String.Formatã€‚ æ­¤æ–¹æ³•éå¸¸é€‚ç”¨äºä»å°‘é‡ç»„ä»¶å­—ç¬¦ä¸²ç”Ÿæˆå­—ç¬¦ä¸²çš„æƒ…å†µã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å°†å­—ç¬¦ä¸²åˆå¹¶åœ¨å¾ªç¯ä¸­ï¼Œæ­¤æ—¶ä¸çŸ¥é“è¦åˆå¹¶çš„æºå­—ç¬¦ä¸²çš„æ•°é‡ï¼Œè€Œä¸”æºå­—ç¬¦ä¸²çš„å®é™…æ•°é‡å¯èƒ½å¾ˆå¤§ã€‚ StringBuilder ç±»ä¸“é—¨ç”¨äºæ­¤ç±»æ–¹æ¡ˆã€‚ ä»¥ä¸‹ä»£ç ä½¿ç”¨ StringBuilder ç±»çš„ Append æ–¹æ³•ä¸²è”å­—ç¬¦ä¸²ã€‚

è¿˜å¯ä½¿ç”¨ String.Concat æ–¹æ³•è”æ¥é›†åˆä¸­çš„å­—ç¬¦ä¸²ã€‚ å¦‚æœæºå­—ç¬¦ä¸²åº”ä½¿ç”¨åˆ†éš”ç¬¦åˆ†éš”ï¼Œè¯·ä½¿ç”¨ String.Join æ–¹æ³•ã€‚

    string[] words = { "The", "quick", "brown", "fox", "jumps", "over", "the", "lazy", "dog." };

    var unreadablePhrase = string.Concat(words);
    System.Console.WriteLine(unreadablePhrase);

    var readablePhrase = string.Join(" ", words);
    System.Console.WriteLine(readablePhrase);


åˆ©ç”¨ DateTime æä¾›çš„ Parse å’Œ TryParse æ–¹æ³•å¯è½¬æ¢æ—¥æœŸå’Œæ—¶é—´çš„å¤šä¸ªå¸¸è§è¡¨ç¤ºæ–¹æ³•ã€‚ ParseExact å’Œ TryParseExact æ–¹æ³•å¯è½¬æ¢ç¬¦åˆæ—¥æœŸå’Œæ—¶é—´æ ¼å¼å­—ç¬¦ä¸²æŒ‡å®šçš„æ¨¡å¼çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ 

    CultureInfo MyCultureInfo = new CultureInfo("de-DE");
    string MyString = "12 Juni 2008";
    DateTime MyDateTime = DateTime.Parse(MyString, MyCultureInfo);
    Console.WriteLine(MyDateTime);
    // The example displays the following output:
    //       6/12/2008 12:00:00 AM


    CultureInfo MyCultureInfo = new CultureInfo("en-US");
    string[] MyString = { " Friday, April 10, 2009", "Friday, April 10, 2009" };
    foreach (string dateString in MyString)
    {
        try
        {
            DateTime MyDateTime = DateTime.ParseExact(dateString, "D", MyCultureInfo);
            Console.WriteLine(MyDateTime);
        }
        catch (FormatException)
        {
            Console.WriteLine("Unable to parse '{0}'", dateString);
        }
    }
    // The example displays the following output:
    //       Unable to parse ' Friday, April 10, 2009'
    //       4/10/2009 12:00:00 AM


ä¿®æ”¹å•ä¸ªå­—ç¬¦

    var source = "source";
    char[] chars = source.ToCharArray();
    chars[0] = 'S';

.NET Core æä¾›äº†ä¸€ç§ String.Create æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ä½ å¯ä»¥é€šè¿‡å›è°ƒä»¥ç¼–ç¨‹æ–¹å¼å¡«å……å­—ç¬¦ä¸²çš„å­—ç¬¦å†…å®¹ï¼ŒåŒæ—¶é¿å…ä¸­é—´çš„ä¸´æ—¶å­—ç¬¦ä¸²åˆ†é…ã€‚

    // constructing a string from a char array, prefix it with some additional characters
    char[] chars = { 'a', 'b', 'c', 'd', '\0' };
    int length = chars.Length + 2;
    string result = String.Create (length, chars, (Span<char> strContent, char[] charArray) =>
    {
        strContent[0] = '0';
        strContent[1] = '1';
        for (int i = 0; i < charArray.Length; i++)
        {
            strContent[i + 2] = charArray[i];
        }
    });

    Console.WriteLine(result);

.NET æä¾›å­—ç¬¦ä¸²æ–¹æ³•ï¼š

    "source".Replace("our", "we")   æ›¿æ¢æ–‡æœ¬
    "source".Trim/TrimStart/TrimEnd()   å»é™¤ç©ºæ ¼
    "source".Remove(start, length)  åˆ é™¤æ–‡æœ¬

    "source".IndexOf/LastIndexOf("ur")  æŸ¥æ‰¾å­—ç¬¦ä¸²ä½ç½®

    String.Compare  æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å€¼ã€‚ è¿”å›ä¸€ä¸ªæ•´æ•°å€¼ã€‚
    String.CompareOrdinal   æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å€¼è€Œä¸è€ƒè™‘æœ¬åœ°åŒºåŸŸæ€§ã€‚ è¿”å›ä¸€ä¸ªæ•´æ•°å€¼ã€‚
    String.CompareTo    æ¯”è¾ƒå½“å‰å­—ç¬¦ä¸²å¯¹è±¡å’Œå¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ è¿”å›ä¸€ä¸ªæ•´æ•°å€¼ã€‚
    String.StartsWith   ç¡®å®šå­—ç¬¦ä¸²æ˜¯å¦ä»¥ä¼ é€’å­—çš„ç¬¦ä¸²å¼€å¤´ã€‚ è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
    String.EndsWith ç¡®å®šå­—ç¬¦ä¸²æ˜¯å¦ä»¥ä¼ é€’çš„å­—ç¬¦ä¸²ç»“å°¾ã€‚ è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
    String.Equals   ç¡®å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒã€‚ è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
    String.IndexOf  è¿”å›å­—ç¬¦æˆ–å­—ç¬¦ä¸²çš„ç´¢å¼•ä½ç½®ï¼Œä»æ­£åœ¨æ£€æŸ¥çš„å­—ç¬¦ä¸²çš„å¼€å¤´å¼€å§‹ã€‚ è¿”å›ä¸€ä¸ªæ•´æ•°å€¼ã€‚
    String.LastIndexOf  è¿”å›å­—ç¬¦æˆ–å­—ç¬¦ä¸²çš„ç´¢å¼•ä½ç½®ï¼Œä»æ­£åœ¨æ£€æŸ¥çš„å­—ç¬¦ä¸²çš„ç»“å°¾å¼€å§‹ã€‚ è¿”å›ä¸€ä¸ªæ•´æ•°å€¼ã€‚


ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å­—ç¬¦ä¸²

    using System;
    using System.Text.RegularExpressions;

    public class Example
    {
       public static void Main()
       {
          string pattern = "(Mr\\.? |Mrs\\.? |Miss |Ms\\.? )";
          string[] names = { "Mr. Henry Hunt", "Ms. Sara Samuels",
                             "Abraham Adams", "Ms. Nicole Norris" };
          foreach (string name in names)
             Console.WriteLine(Regex.Replace(name, pattern, String.Empty));
       }
    }
    // The example displays the following output:
    //    Henry Hunt
    //    Sara Samuels
    //    Abraham Adams
    //    Nicole Norris


    string[] sentences =
    {
        "Put the water over there.",
        "They're quite thirsty.",
        "Their water bottles broke."
    };

    string sPattern = "the(ir)?\\s";

    foreach (string s in sentences)
    {
        Console.Write($"{s,24}");

        if (System.Text.RegularExpressions.Regex.IsMatch(s, sPattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase))
        {
            Console.WriteLine($"  (match for '{sPattern}' found)");
        }
        else
        {
            Console.WriteLine();
        }
    }


## ==âš¡ Array æ•°ç»„
https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/arrays/

åœ¨ C# ä¸­ï¼Œæ•°ç»„å®é™…ä¸Šæ˜¯å¯¹è±¡ï¼Œè€Œä¸åªæ˜¯å¦‚åœ¨ C å’Œ C++ ä¸­çš„è¿ç»­å†…å­˜çš„å¯å¯»å€åŒºåŸŸã€‚ Array æ˜¯æ‰€æœ‰æ•°ç»„ç±»å‹çš„æŠ½è±¡åŸºç±»å‹ã€‚ å¯ä»¥ä½¿ç”¨ Array å…·æœ‰çš„å±æ€§å’Œå…¶ä»–ç±»æˆå‘˜ã€‚ ä¾‹å¦‚ï¼Œä½¿ç”¨ Length å±æ€§æ¥è·å–æ•°ç»„çš„é•¿åº¦ã€‚

ArrayList å¤§å°ä¼šæ ¹æ®éœ€è¦åŠ¨æ€å¢åŠ çš„æ•°ç»„ï¼Œç”±äº ArrayList å­˜åœ¨ç±»å‹ä¸å®‰å…¨ã€è£…ç®±æ‹†ç®±æŸè€—æ€§èƒ½ï¼Œä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªå‡ºäºå…¼å®¹ç›®çš„ä¿ç•™çš„ç±»å‹ã€‚ä½¿ç”¨ `List<T>` å¼ºç±»å‹æ³›å‹å®ç°çš„åˆ—è¡¨å¯¹è±¡æ›¿ä»£ã€‚

é€šè¿‡ new è¿ç®—ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨æ•°ç»„åˆå§‹å€¼è®¾å®šé¡¹ï¼ˆåœ¨åˆ†éš”ç¬¦ { å’Œ } å†…ç¼–å†™çš„è¡¨è¾¾å¼åˆ—è¡¨ï¼‰æŒ‡å®šæ•°ç»„å…ƒç´ çš„åˆå§‹å€¼ã€‚ ä»¥ä¸‹ç¤ºä¾‹åˆ†é… int[]ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºåŒ…å«ä¸‰ä¸ªå…ƒç´ ã€‚ä¹Ÿå¯ä»¥è‡ªåŠ¨æ¨æ–­é•¿åº¦ï¼š

    int[] a = {1, 2, 3};

    int[] a = new int[] {1, 2, 3};


ä»¥ä¸‹ç¤ºä¾‹åˆ†åˆ«åˆ†é…ä¸€ç»´ã€äºŒç»´ã€ä¸‰ç»´æ•°ç»„ã€‚

    int[] a1 = new int[10];
    int[,] a2 = new int[10, 5];
    int[,,] a3 = new int[10, 5, 2];
    Console.WriteLine(a2[0,1]);

æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ int[] ç±»å‹ï¼Œå¹¶ä¸”åˆå§‹å€¼å‡ä¸º nullã€‚ åé¢çš„ä»£ç è¡Œå°†è¿™ä¸‰ä¸ªå…ƒç´ åˆå§‹åŒ–ä¸ºå¼•ç”¨é•¿åº¦ä¸åŒçš„å„ä¸ªæ•°ç»„å®ä¾‹ã€‚

    int[][] a = new int[3][];
    a[0] = new int[10];
    a[1] = new int[5];
    a[2] = new int[20];
    Console.WriteLine(messages[0]);

    int[][] b =
    {
        new int[] {1},
        new int[] {1,2},
        new int[] {1,2,5,10}
    };

å½¢å¦‚ int[][] è¿™æ ·çš„å«åšäº¤é”™æ•°ç»„ Jagged Arrayï¼Œè€Œ int[,] è¿™ç§ä¸­æ‹¬å·å¸¦é€—å·çš„çŸ©å½¢æ•°ç»„ Rectangular Arrayï¼Œåˆç§°å¤šç»´æ•°ç»„ï¼Œå…ƒç´ é•¿åº¦ç»Ÿä¸€ï¼Œè®¿é—®æ—¶éœ€è¦æŒ‡å®šå®Œæ•´çš„ç´¢å¼•ä¸‹æ ‡ï¼Œé…åˆ GetLength() è·å–å„ç»´é•¿åº¦ä¿¡æ¯ã€‚

å¯¹äºå•ç»´æ•°ç»„ï¼Œforeach è¯­å¥ä»¥é€’å¢ç´¢å¼•é¡ºåºå¤„ç†å…ƒç´ ï¼ˆä»ç´¢å¼• 0 å¼€å§‹å¹¶ä»¥ç´¢å¼• Length - 1 ç»“æŸï¼‰ï¼š

    int[] numbers = { 4, 5, 6, 1, 2, 3, -2, -1, 0 };
    foreach (int i in numbers)
    {
        System.Console.Write("{0} ", i);
    }
    // Output: 4 5 6 1 2 3 -2 -1 0

å¯¹äºå¤šç»´æ•°ç»„ï¼Œéå†å…ƒç´ çš„æ–¹å¼ä¸ºï¼šé¦–å…ˆå¢åŠ æœ€å³è¾¹ç»´åº¦çš„ç´¢å¼•ï¼Œç„¶åæ˜¯å®ƒå·¦è¾¹çš„ä¸€ä¸ªç»´åº¦ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå‘å·¦éå†å…ƒç´ ï¼š

    int[,] numbers2D = new int[3, 2] { { 9, 99 }, { 3, 33 }, { 5, 55 } };
    // Or use the short form:
    // int[,] numbers2D = { { 9, 99 }, { 3, 33 }, { 5, 55 } };

    foreach (int i in numbers2D)
    {
        System.Console.Write("{0} ", i);
    }
    // Output: 9 99 3 33 5 55

ä½¿ç”¨åµŒå¥—çš„ for å¾ªç¯å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å¤„ç†æ•°ç»„å…ƒç´ çš„é¡ºåºã€‚

å¯ä»¥åˆ›å»ºéšå¼ç±»å‹åŒ–çš„æ•°ç»„ï¼Œå…¶ä¸­æ•°ç»„å®ä¾‹çš„ç±»å‹é€šè¿‡æ•°ç»„åˆå§‹å€¼è®¾å®šé¡¹ä¸­æŒ‡å®šçš„å…ƒç´ æ¥æ¨æ–­ã€‚ é’ˆå¯¹éšå¼ç±»å‹åŒ–å˜é‡çš„ä»»ä½•è§„åˆ™ä¹Ÿé€‚ç”¨äºéšå¼ç±»å‹åŒ–æ•°ç»„ã€‚

    var a = new[] { 1, 10, 100, 1000 }; // int[]
    var b = new[] { "hello", null, "world" }; // string[]

    // single-dimension jagged array
    var c = new[]
    {
        new[]{1,2,3,4},
        new[]{5,6,7,8}
    };

    // jagged array of strings
    var d = new[]
    {
        new[]{"Luca", "Mads", "Luke", "Dinesh"},
        new[]{"Karen", "Suma", "Frances"}
    };


## ==âš¡ Range
- https://docs.microsoft.com/zh-cn/dotnet/api/system.range?view=net-6.0
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/ranges

C# 8.0 è¯­æ³•ä¸Šæ”¯æŒ Range è¡¨è¾¾ï¼š

    int[] someArray = new int[5] { 1, 2, 3, 4, 5 };
    int[] subArray1 = someArray[0..2];               // { 1, 2 }
    int[] subArray2 = someArray[1..^0];              // { 2, 3, 4, 5 }

^0 è¡¨ç¤º Array.Length - 0ã€‚

æ­¤åŠŸèƒ½ä¸æä¾›ä¸¤ä¸ªæ–°çš„è¿ç®—ç¬¦ï¼Œå®ƒä»¬å…è®¸æ„é€  .NET Core 3.0 æˆ– .NET Standard 2.1 æä¾›çš„ System.Index å’Œ System.Range å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬åœ¨è¿è¡Œæ—¶ç´¢å¼•/åˆ‡ç‰‡é›†åˆã€‚

æ„é€ å™¨å¯æŒ‡å®šå¼€å§‹ã€ç»“æŸå€¼ï¼š

    Range(Index, Index) 

æœ‰ä¸‰ä¸ªå±æ€§ï¼Œç”¨æ¥è·å–å­é›†ï¼Œè¿”å› Range å¯¹è±¡ï¼Œé™¤äº† Endï¼š

| All   | è·å– Range æ‰€æœ‰å€¼ |    
| End   | è·å–æŒ‡å®šç»“æŸä½åçš„ç´¢å¼•å¯¹è±¡ |   
| Start | è·å–æŒ‡å®šèµ·ç‚¹åˆ°ç»“æŸçš„å€¼|

æ–¹æ³•ï¼š

| EndAt(Index)  | è·å–æŒ‡å®šç»“æŸå€¼çš„é›†åˆ |
| StartAt(Index)    | è·å–æŒ‡å®šå¼€å§‹å€¼çš„é›†åˆ |
| Equals(Object)    | ä¸å¦ä¸€ä¸ªå¯¹è±¡é‡Œå¾·æ¯”è¾ƒæ˜¯å¦ç›¸åŒ |
| Equals(Range) | ä¸å¦ä¸€ä¸ª Range å¯¹è±¡é‡Œå¾·æ¯”è¾ƒæ˜¯å¦ç›¸åŒ |
| GetHashCode() | è·å–å½“å‰å®ä¾‹çš„ Hash å€¼ |
| GetOffsetAndLength(Int32) | è¿”å› ValueTuple<Int32,Int32>ï¼Œ Calculates the start offset and length of the range object using a collection length. |
| ToString()    | å°† Range è½¬æ¢æˆå­—ç¬¦ä¸²è¡¨è¾¾ |

ç¤ºä¾‹ï¼š

```C#
using System;

class Demo
{
    static void Main(){
        var ng = new Range( 1,6);
        Console.WriteLine(Range.EndAt(2));
        Console.WriteLine(Range.StartAt(2));
        Console.WriteLine(ng.Equals(new int[]{1,2,3,4,5,6}));
        Console.WriteLine(ng.Equals(new int[]{1,2,3,4,5,6}));
        Console.WriteLine(ng.GetHashCode().ToString("X"));
        ValueTuple<int, int> vt = ng.GetOffsetAndLength(-30);
        Console.WriteLine(vt);
    }
}
```


è¾“å‡ºï¼š

    0..2
    2..^0
    False
    False
    8439A85A
    (1, 5)



## ==âš¡ Collections é›†åˆ
https://docs.microsoft.com/zh-cn/dotnet/api/system.collections.generic

System.Collections.Generic å‘½åç©ºé—´åŒ…å«å®šä¹‰æ³›å‹é›†åˆçš„æ¥å£å’Œç±»ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨æ³›å‹é›†åˆæ¥åˆ›å»ºå¼ºç±»å‹é›†åˆï¼Œè¿™ç§é›†åˆèƒ½æä¾›æ¯”éæ³›å‹å¼ºç±»å‹é›†åˆæ›´å¥½çš„ç±»å‹å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚

    using System;
    using System.Collections.Generic;

    namespace csdemo
    {
        class Program
        {
            static void Main(string[] args)
            {
                var names = new List<string> { "Felipe", "Emillia" };
                foreach (var name in names)
                {
                    Console.WriteLine($"Hello {name.ToUpper()}!");
                }

                var messages = new Dictionary<int, string>
                {
                    // æ—©æœŸç‰ˆæœ¬çš„ C#
                    // {302, "Page moved, but left a forwarding address."},
                    // {404, "Page not Found"},
                    // {500, "The web server can't come out to play today."}

                    // C# 6.0 ä½¿ç”¨ç´¢å¼•å™¨åˆå§‹åŒ–å…³è”é›†åˆ
                    [302] = "Page moved, but left a forwarding address.",
                    [404] = "Page not Found",
                    [500] = "The web server can't come out to play today."
                };
                Console.WriteLine(messages[404]);
            }
        }
    }

ä¾‹ï¼ŒåŒ¿åå¯¹è±¡å­—å…¸ï¼š

    var o404 = new {code = 404};
    var o302 = new {code = 302};
    var o500 = new {code = 500};
    var messages = new Dictionary<object, string>
    {
        {o404, "Page not Found"},
        {o302, "Page moved, but left a forwarding address."},
        {o500, "The web server can't come out to play today."}
    };
    Console.WriteLine(messages[o404]);

ArrayList å¤§å°ä¼šæ ¹æ®éœ€è¦åŠ¨æ€å¢åŠ çš„æ•°ç»„ï¼Œç”±äº ArrayList ä¿å­˜ object ç±»å‹ï¼Œå€¼ç±»å‹ä¸ object ç±»å‹è¿›è¡Œè½¬æ¢çš„è¿‡ç¨‹å°±ä¼šäº§ç”Ÿæ‹†ç®±è£…ç®±ï¼Œå­˜åœ¨ç±»å‹ä¸å®‰å…¨ã€è£…ç®±æ‹†ç®±æŸè€—æ€§èƒ½ï¼Œä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªå‡ºäºå…¼å®¹ç›®çš„ä¿ç•™çš„ç±»å‹ã€‚ä½¿ç”¨ `List<T>` å¼ºç±»å‹æ³›å‹å®ç°çš„åˆ—è¡¨å¯¹è±¡æ›¿ä»£ã€‚

æœ‰äº›äººå–œæ¬¢ç”¨ArrayListæ˜¯å› ä¸ºå¯¹å­˜å‚¨å¯¹è±¡çš„ç±»å‹æ²¡æœ‰è¦æ±‚ï¼Œç”¨èµ·æ¥æ–¹ä¾¿ï¼Œä¼´éšè€Œæ¥çš„å°±æ˜¯ç±»å‹çš„ä¸å®‰å…¨ï¼Œè¿™åœ¨é™æ€è¯­è¨€ä¸­æ˜¯ä¸å¯å–çš„ã€‚

æ•°ç»„çš„å®¹é‡æ˜¯å›ºå®šçš„ï¼Œæ‚¨åªèƒ½ä¸€æ¬¡è·å–æˆ–è®¾ç½®ä¸€ä¸ªå…ƒç´ çš„å€¼ï¼Œè€Œ ArrayList æˆ– List çš„å®¹é‡å¯æ ¹æ®éœ€è¦è‡ªåŠ¨æ‰©å……ã€ä¿®æ”¹ã€åˆ é™¤æˆ–æ’å…¥æ•°æ®ã€‚

æ•°ç»„å¯ä»¥å…·æœ‰å¤šä¸ªç»´åº¦ï¼Œè€Œ ArrayList æˆ– List å§‹ç»ˆåªå…·æœ‰ä¸€ä¸ªç»´åº¦ï¼Œä½†å¯ä»¥è½»æ¾åˆ›å»ºæ•°ç»„åˆ—è¡¨æˆ–åˆ—è¡¨çš„åˆ—è¡¨ã€‚é™¤ Object å¤–çš„ç‰¹å®šç±»å‹çš„æ•°ç»„ çš„æ€§èƒ½ä¼˜äº ArrayList çš„æ€§èƒ½ã€‚ è¿™æ˜¯å› ä¸º ArrayList çš„å…ƒç´ å±äº Object ç±»å‹ï¼›æ‰€ä»¥åœ¨å­˜å‚¨æˆ–æ£€ç´¢å€¼ç±»å‹æ—¶é€šå¸¸å‘ç”Ÿè£…ç®±å’Œå–æ¶ˆè£…ç®±æ“ä½œã€‚ä¸è¿‡ï¼Œåœ¨ä¸éœ€è¦é‡æ–°åˆ†é…æ—¶ï¼Œå³åœ¨éœ€è¦æ‰©å®¹é‡æ—¶ï¼ŒList çš„æ€§èƒ½ä¸åŒç±»å‹çš„æ•°ç»„ååˆ†ç›¸è¿‘ã€‚

åœ¨å†³å®šä½¿ç”¨ List è¿˜æ˜¯ä½¿ç”¨ ArrayList ç±»æ—¶ï¼Œè®°ä½ List ç±»åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ‰§è¡Œå¾—æ›´å¥½å¹¶ä¸”æ˜¯ç±»å‹å®‰å…¨çš„ã€‚å¦‚æœå¯¹ List ç±»çš„ç±»å‹ T ä½¿ç”¨å¼•ç”¨ç±»å‹ï¼Œåˆ™ä¸¤ä¸ªç±»çš„è¡Œä¸ºæ˜¯å®Œå…¨ç›¸åŒçš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¯¹ç±»å‹ T ä½¿ç”¨å€¼ç±»å‹ï¼Œåˆ™éœ€è¦è€ƒè™‘å®ç°å’Œè£…ç®±é—®é¢˜ã€‚



## ==âš¡ Control Flow æµç¨‹æ§åˆ¶
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/statements/iteration-statements
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/statements/selection-statements
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/statements/jump-statements

The following statements repeatedly execute a statement or a block of statements:

- The *for* statement: executes its body while a specified Boolean expression evaluates to true.
- The *foreach* statement: enumerates the elements of a collection and executes its body for each element of the collection.
- The *do* statement: conditionally executes its body one or more times.
- The *while* statement: conditionally executes its body zero or more times.

At any point within the body of an iteration statement, you can break out of the loop by using the break statement, or step to the next iteration in the loop by using the continue statement.

The following statements unconditionally transfer control:

- The *break* statement: terminates the closest enclosing iteration statement or switch statement.
- The *continue* statement: starts a new iteration of the closest enclosing iteration statement.
- The *return* statement: terminates execution of the function in which it appears and returns control to the caller.
- The *goto* statement: transfers control to a statement that is marked by a label.

For information about the throw statement that throws an exception and unconditionally transfers control as well, see throw.

```C#
for (int i = 0; i < 3; i++)
{
    Console.Write(i);
}

var fibNumbers = new List<int> { 0, 1, 1, 2, 3, 5, 8, 13 };
foreach (int element in fibNumbers)
{
    Console.Write($"{element} ");
}

// C# 8.0, you can use the await foreach
await foreach (var item in GenerateSequenceAsync())
{
    Console.WriteLine(item);
}

int n = 0;
do
{
    Console.Write(n);
    n++;
} while (n < 5);

while (n < 10)
{
    Console.Write(n);
    n++;
}
```

## ===âœ’ Switch & if

```C#
DisplayCharacter('f');  // Output: A lowercase letter: f
DisplayCharacter('R');  // Output: An uppercase letter: R
DisplayCharacter('8');  // Output: A digit: 8
DisplayCharacter(',');  // Output: Not alphanumeric character: ,

void DisplayCharacter(char ch)
{
    if (char.IsUpper(ch))
    {
        Console.WriteLine($"An uppercase letter: {ch}");
    }
    else if (char.IsLower(ch))
    {
        Console.WriteLine($"A lowercase letter: {ch}");
    }
    else if (char.IsDigit(ch))
    {
        Console.WriteLine($"A digit: {ch}");
    }
    else
    {
        Console.WriteLine($"Not alphanumeric character: {ch}");
    }
}
```

In an expression context, you can use the conditional operator *?:* to evaluate one of the two expressions based on the value of a Boolean expression.

```C#
DisplayMeasurement(-4);  // Output: Measured value is -4; too low.
DisplayMeasurement(5);  // Output: Measured value is 5.
DisplayMeasurement(30);  // Output: Measured value is 30; too high.
DisplayMeasurement(double.NaN);  // Output: Failed measurement.

void DisplayMeasurement(double measurement)
{
    switch (measurement)
    {
        case < 0.0:
            Console.WriteLine($"Measured value is {measurement}; too low.");
            break;

        case > 15.0:
            Console.WriteLine($"Measured value is {measurement}; too high.");
            break;

        case double.NaN:
            Console.WriteLine("Failed measurement.");
            break;

        default:
            Console.WriteLine($"Measured value is {measurement}.");
            break;
    }
}
```

At the preceding example, the switch statement uses the following patterns:

- A relational pattern (available in C# 9.0 and later): to compare an expression result with a constant.
- A constant pattern (available in C# 7.0 and later): to test if an expression result equals a constant.


## ===âœ’ foreach-in æšä¸¾å¾ªç¯
- [`System.Collections.IEnumerable`](https://docs.microsoft.com/en-us/dotnet/api/system.collections.ienumerable)
- [`System.Collections.Generic.IEnumerable<T>`](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.ienumerable-1)
- [`System.Collections.Generic.IAsyncEnumerable<T>`](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.iasyncenumerable-1)


æ”¯æŒæšä¸¾æ“ä½œçš„æ•°æ®ç±»å‹åœ¨ C# ä¸­æ˜¯æœ€å¸¸è§çš„ï¼Œæ‰€æœ‰æ•°ç»„éƒ½æ˜¯æœ€åŸºæœ¬çš„æšä¸¾æ•°æ®ç±»å‹ï¼š

```C#
var fibNumbers = new List<int> { 0, 1, 1, 2, 3, 5, 8, 13 };
int count = 0;
foreach (int element in fibNumbers)
{
    count++;
    Console.WriteLine($"Element #{count}: {element}");
}
Console.WriteLine($"Number of elements: {count}");
```


The next example uses the foreach statement with an instance of the System.Span<T> type, which doesn't implement any interfaces:

```C#
public class IterateSpanExample
{
    public static void Main()
    {
        Span<int> numbers = new int[] { 3, 14, 15, 92, 6 };
        foreach (int number in numbers)
        {
            Console.Write($"{number} ");
        }
        Console.WriteLine();
    }
}
```

ä½¿ç”¨ ref å…³é”®å­—å¼•ç”¨è¢«æšä¸¾çš„æ¡ç›®ï¼š

```C#
Span<int> storage = stackalloc int[10];
int num = 0;
foreach (ref int item in storage)
{
    item = num++;
}

foreach (ref readonly var item in storage)
{
    Console.Write($"{item} ");
}
// Output:
// 0 1 2 3 4 5 6 7 8 9
```

C# 8.0 æ–°å¢ä½¿ç”¨ await è¿›è¡Œå¼‚æ­¥æšä¸¾ï¼š

    await foreach (var item in GenerateSequenceAsync())
    {
        Console.WriteLine(item);
    }


æšä¸¾æ•°æ®çš„å¾ªç¯ä¸­ï¼ŒC# foreach ä¸æ”¯æŒè¯­æ³•è·å–ç´¢å¼• indexï¼Œåªèƒ½é€šè¿‡å…¶å®ƒæ–¹å¼è·å–ï¼š

```C#
int i = 0;
foreach (var item in arr)
{
    i++;
}

foreach (var item in arr)
{
    int index = arr.indexOf(item); //  Array.IndexOf()
}
```


## ==âš¡ type cast

### ===âœ’ byte to String

    string  str    = System.Text.Encoding.UTF8.GetString(bytes);
    byte[] decBytes = System.Text.Encoding.UTF8.GetBytes(str);

è¿˜å¯ä»¥ç”¨å…¶å®ƒç¼–ç ï¼š

System.Text.Encoding.Default
System.Text.Encoding.ASCII

System.Text.Encoding.UTF8.GetString(bytes).TrimEnd('\0') ç»™å­—ç¬¦ä¸²åŠ ä¸Šç»“æŸæ ‡è¯†ã€‚

    string    str    = BitConverter.ToString(bytes); 
    String[] tempArr = str.Split('-');
    byte[]   decBytes = new byte[tempArr.Length];
    for (int i = 0; i < tempArr.Length; i++)
    {
        decBytes[i] = Convert.ToByte(tempArr[i], 16);
    }

ç»™å­—ç¬¦ä¸²åŠ ä¸Š '-' è¿å­—ç¬¦ï¼Œå¹¶ä¸”æ²¡æœ‰å‡½æ•°è½¬æ¢å›å»ã€‚æ‰€ä»¥éœ€è¦æ‰‹åŠ¨è½¬æ¢ä¸ºbytesã€‚

    string str      = Convert.ToBase64String(bytes); 
    byte[] decBytes = Convert.FromBase64String(str);

è¿™ç§æ–¹æ³•ç®€å•æ˜äº†ï¼Œæ³¨æ„ï¼Œè½¬æ¢å‡ºæ¥çš„ string ä½œä¸º URL åœ°å€çš„è¯ï¼Œéœ€è¦è¿›è¡Œ encodeã€‚

    string  str    = HttpServerUtility.UrlTokenEncode(bytes); 
    byte[] decBytes = HttpServerUtility.UrlTokenDecode(str);

è¿™ç§æ–¹æ³•ä¼šè‡ªåŠ¨ç¼–ç  URL åœ°å€çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¯ä»¥ç›´æ¥å½“åš URL åœ°å€ä½¿ç”¨ï¼Œä¾èµ– System.Web åº“ã€‚


## ==âš¡ delegate å§”æ‰˜
- https://docs.microsoft.com/dotnet/csharp/language-reference/operators/delegate-operator
- https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/delegates/

delegate æ˜¯ä¸€ç§å¯ç”¨äºå°è£…å‘½åæ–¹æ³•æˆ–åŒ¿åæ–¹æ³•çš„å¼•ç”¨ç±»å‹ã€‚ å§”æ‰˜ç±»ä¼¼äº C++ ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼›ä½†æ˜¯ï¼Œä¸ C å‡½æ•°æŒ‡é’ˆä¸åŒçš„æ˜¯ï¼Œå§”æ‰˜æ˜¯é¢å‘å¯¹è±¡çš„ã€ç±»å‹å®‰å…¨çš„å’Œå¯é çš„ï¼Œå§”æ‰˜æ˜¯å®‰å…¨å°è£…æ–¹æ³•çš„ç±»å‹ã€‚ 

å§”æ‰˜å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š

- å§”æ‰˜ç±»ä¼¼äº C++ å‡½æ•°æŒ‡é’ˆï¼Œä½†å§”æ‰˜å®Œå…¨é¢å‘å¯¹è±¡ï¼Œä¸åƒ C++ æŒ‡é’ˆä¼šè®°ä½å‡½æ•°ï¼Œå§”æ‰˜ä¼šåŒæ—¶å°è£…å¯¹è±¡å®ä¾‹å’Œæ–¹æ³•ã€‚
- å§”æ‰˜å…è®¸å°†æ–¹æ³•ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ã€‚
- å§”æ‰˜å¯ç”¨äºå®šä¹‰å›è°ƒæ–¹æ³•ã€‚
- å§”æ‰˜å¯ä»¥é“¾æ¥åœ¨ä¸€èµ·ï¼›ä¾‹å¦‚ï¼Œå¯ä»¥å¯¹ä¸€ä¸ªäº‹ä»¶è°ƒç”¨å¤šä¸ªæ–¹æ³•ã€‚
- æ–¹æ³•ä¸å¿…ä¸å§”æ‰˜ç±»å‹å®Œå…¨åŒ¹é…ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ä½¿ç”¨å§”æ‰˜ä¸­çš„å˜ä½“ã€‚
- C# 2.0 ç‰ˆå¼•å…¥äº†åŒ¿åæ–¹æ³•çš„æ¦‚å¿µï¼Œå¯ä»¥å°†ä»£ç å—ä½œä¸ºå‚æ•°ï¼ˆè€Œä¸æ˜¯å•ç‹¬å®šä¹‰çš„æ–¹æ³•ï¼‰è¿›è¡Œä¼ é€’ã€‚ 
- C# 3.0 å¼•å…¥äº† Lambda è¡¨è¾¾å¼ï¼Œåˆ©ç”¨å®ƒä»¬å¯ä»¥æ›´ç®€ç»ƒåœ°ç¼–å†™å†…è”ä»£ç å—ã€‚
- åŒ¿åæ–¹æ³•å’Œ Lambda è¡¨è¾¾å¼ï¼ˆåœ¨æŸäº›ä¸Šä¸‹æ–‡ä¸­ï¼‰éƒ½å¯ç¼–è¯‘ä¸ºå§”æ‰˜ç±»å‹ï¼Œè¿™äº›åŠŸèƒ½ç°åœ¨ç»Ÿç§°ä¸ºåŒ¿åå‡½æ•°ã€‚

å§”æ‰˜å¯¹è±¡é€šå¸¸é€šè¿‡æä¾›å§”æ‰˜å°†å°è£…çš„æ–¹æ³•çš„åç§°æˆ–ä½¿ç”¨åŒ¿åå‡½æ•°æ„é€ ã€‚ å¯¹å§”æ‰˜è¿›è¡Œå®ä¾‹åŒ–åï¼Œå§”æ‰˜ä¼šå°†å¯¹å…¶è¿›è¡Œçš„æ–¹æ³•è°ƒç”¨ä¼ é€’åˆ°è¯¥æ–¹æ³•ã€‚ è°ƒç”¨æ–¹ä¼ é€’åˆ°å§”æ‰˜çš„å‚æ•°å°†ä¼ é€’åˆ°è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”å§”æ‰˜ä¼šå°†æ–¹æ³•çš„è¿”å›å€¼ï¼ˆå¦‚æœæœ‰ï¼‰è¿”å›åˆ°è°ƒç”¨æ–¹ã€‚ è¿™è¢«ç§°ä¸ºè°ƒç”¨å§”æ‰˜ã€‚ å®ä¾‹åŒ–çš„å§”æ‰˜å¯ä»¥æŒ‰å°è£…çš„æ–¹æ³•æœ¬èº«è¿›è¡Œè°ƒç”¨ã€‚ ä¾‹å¦‚:

    public delegate void Del(string message);

    // Create a method for a delegate.
    public static void DelegateMethod(string message)
    {
        Console.WriteLine(message);
    }

    // Instantiate the delegate.
    Del handler = DelegateMethod;

    // Call the delegate.
    handler("Hello World");

å§”æ‰˜å¯ä»¥ä¸å‘½åæ–¹æ³•ç›¸å…³è”ï¼Œä½¿ç”¨å‘½åæ–¹æ³•å®ä¾‹åŒ–å§”æ‰˜æ—¶ï¼Œè¯¥æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ ä½¿ç”¨å‘½åæ–¹æ³•æ„é€ çš„å§”æ‰˜å¯ä»¥å°è£…é™æ€æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ã€‚ å‘½åæ–¹æ³•æ˜¯åœ¨æ—©æœŸç‰ˆæœ¬çš„ C# ä¸­å®ä¾‹åŒ–å§”æ‰˜çš„å”¯ä¸€æ–¹å¼ã€‚ å¦‚æœåˆ›å»ºæ–°æ–¹æ³•ä¼šé€ æˆå¤šä½™å¼€é”€ï¼ŒC# å…è®¸ä½ å®ä¾‹åŒ–å§”æ‰˜å¹¶ç«‹å³æŒ‡å®šè°ƒç”¨å§”æ‰˜æ—¶å§”æ‰˜å°†å¤„ç†çš„ä»£ç å—ã€‚ ä»£ç å—å¯åŒ…å« Lambda è¡¨è¾¾å¼æˆ–åŒ¿åæ–¹æ³•ã€‚

åˆå¹¶å§”æ‰˜ï¼Œä¹Ÿå«å¤šæ’­å§”æ‰˜ Multicast Delegateï¼Œå¸¸ç”¨äºäº‹ä»¶å¤„ç†å‡½æ•°çš„å¤„ç†ã€‚å§”æ‰˜å¯¹è±¡é€šè¿‡ä½¿ç”¨ + è¿ç®—ç¬¦å°†å¤šä¸ªå¯¹è±¡åˆ†é…åˆ°ä¸€ä¸ªå§”æ‰˜å®ä¾‹ã€‚ å¤šæ’­å§”æ‰˜åŒ…å«å·²åˆ†é…å§”æ‰˜åˆ—è¡¨ï¼Œæ­¤å¤šæ’­å§”æ‰˜è¢«è°ƒç”¨æ—¶ä¼šä¾æ¬¡è°ƒç”¨åˆ—è¡¨ä¸­çš„å§”æ‰˜ï¼Œä»…å¯åˆå¹¶ç±»å‹ç›¸åŒçš„å§”æ‰˜ã€‚- è¿ç®—ç¬¦å¯ç”¨äºä»å¤šæ’­å§”æ‰˜ä¸­åˆ é™¤ç»„ä»¶å§”æ‰˜ã€‚

ç¤ºä¾‹ï¼š

    using System;

    public class Demo
    {
        // Declare a delegate.
        delegate void Del(int x);

        // Define named method.
        void DoWork(int k) { 
            Console.WriteLine("{0} {1}", this, k); 
        }

        static void DoWorkStatic(int k) { 
            Console.WriteLine("{0} {1}", "static", k); 
        }

        public static void Main()
        {
            // Instantiate the delegate using the method as a parameter.
            Del d = new Demo().DoWork;
            d(123);

            // Create an instance of the delegate.
            Del d2 = new Del(Demo.DoWorkStatic);
            d2(456);

            // C# 2.0 provides a simpler way to declare an instance of Del.
            Del d3 = Demo.DoWorkStatic;

            // C# 2.0+ Instantiate Del by using an anonymous method.
            Del d4 = delegate(int k) { Console.WriteLine($"Notification for anonymous: {k}"); };

            // C# 3.0+ Instantiate Del by using a lambda expression.
            Del d5 = k =>  { Console.WriteLine($"Notification for lambda: {k}"); };

            Del MulticastDelegate = d + d2 + d3 + d2 + d4 + d5;
            MulticastDelegate -= d2; // remove d2
            MulticastDelegate -= d2; // remove d3
            MulticastDelegate -= d2; // remove d2
            MulticastDelegate -= d2; // remove nomore
            MulticastDelegate(789);
        }
    }

åœ¨ .NET ä¸­ï¼ŒSystem.Action å’Œ System.Func ç±»å‹ä¸ºè®¸å¤šå¸¸è§å§”æ‰˜æä¾›æ³›å‹å®šä¹‰ã€‚ å¯èƒ½ä¸éœ€è¦å®šä¹‰æ–°çš„è‡ªå®šä¹‰å§”æ‰˜ç±»å‹ã€‚ ç›¸åï¼Œå¯ä»¥åˆ›å»ºæä¾›çš„æ³›å‹ç±»å‹çš„å®ä¾‹åŒ–ã€‚

ä½¿ç”¨ Action å§”æ‰˜ä»¥å‚æ•°çš„å½¢å¼ä¼ é€’æ–¹æ³•ï¼Œè€Œæ— éœ€æ˜¾å¼å£°æ˜è‡ªå®šä¹‰å§”æ‰˜ã€‚ å°è£…çš„æ–¹æ³•å¿…é¡»å¯¹åº”äºç”±æ­¤å§”æ‰˜å®šä¹‰çš„æ–¹æ³•ç­¾åã€‚ è¿™æ„å‘³ç€å°è£…çš„æ–¹æ³•å¿…é¡»æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”ä¸èƒ½æœ‰è¿”å›å€¼ã€‚ä½¿ç”¨å…¶å®ƒé‡è½½çš„ Action å§”æ‰˜ï¼Œå¦‚ Action<T> å§”æ‰˜ï¼Œå¯ä»¥å°è£…å®šä¹‰ä½¿ç”¨å•ä¸ªå‚æ•°å°è£…æ–¹æ³•çš„å§”æ‰˜ã€‚

    Action<string> write = delegate(string s) { Console.WriteLine(s); };


delegate è¿ç®—ç¬¦åˆ›å»ºä¸€ä¸ªå¯ä»¥è½¬æ¢ä¸ºå§”æ‰˜ç±»å‹çš„åŒ¿åæ–¹æ³•ï¼Œå’Œ Action ä¸€æ ·ï¼ŒFunc æ³›å‹æ˜¯å†…ç½®çš„å§”æ‰˜ç±»å‹ï¼š

    Func<int, int, int> sum = delegate (int a, int b) { return a + b; };
    Console.WriteLine(sum(3, 4));  // output: 7

ä» C# 3 å¼€å§‹ï¼Œlambda è¡¨è¾¾å¼æä¾›äº†ä¸€ç§æ›´ç®€æ´å’Œå¯Œæœ‰è¡¨ç°åŠ›çš„æ–¹å¼æ¥åˆ›å»ºåŒ¿åå‡½æ•°ã€‚ ä½¿ç”¨ => è¿ç®—ç¬¦æ„é€  lambda è¡¨è¾¾å¼ï¼š

    Func<int, int, int> sum = (a, b) => a + b;
    Console.WriteLine(sum(3, 4));  // output: 7

æ³¨æ„ System.Func æ³›å‹å‚æ•°ä¸­æœ€åä¸€ä¸ªä¸ºå§”æ‰˜å‡½æ•°çš„è¿”å›ç±»å‹ï¼š

    System.Func<TResult>
    System.Func<T,TResult>
    System.Func<T1,T2,TResult>
    System.Func<T1,T2,T3,TResult>
    System.Func<T1,T2,T3...T16,TResult>

ä½¿ç”¨ delegate è¿ç®—ç¬¦æ—¶ï¼Œå¯ä»¥çœç•¥å‚æ•°åˆ—è¡¨ã€‚ å¦‚æœè¿™æ ·åšï¼Œå¯ä»¥å°†åˆ›å»ºçš„åŒ¿åæ–¹æ³•è½¬æ¢ä¸ºå…·æœ‰ä»»ä½•å‚æ•°åˆ—è¡¨çš„å§”æ‰˜ç±»å‹ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š

    Action greet = delegate { Console.WriteLine("Hello!"); };
    greet();

    Action<int, double> introduce = delegate { Console.WriteLine("This is world!"); };
    introduce(42, 2.7);

    // Output:
    // Hello!
    // This is world!

è¿™æ˜¯ lambda è¡¨è¾¾å¼ä¸æ”¯æŒçš„åŒ¿åæ–¹æ³•çš„å”¯ä¸€åŠŸèƒ½ã€‚ åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œlambda è¡¨è¾¾å¼æ˜¯ç¼–å†™å†…è”ä»£ç çš„é¦–é€‰æ–¹æ³•ã€‚

è¿˜å¯ä»¥ä½¿ç”¨ delegate å…³é”®å­—å£°æ˜å§”æ‰˜ç±»å‹ã€‚ å§”æ‰˜ç±»å‹çš„å£°æ˜ä¸æ–¹æ³•ç­¾åç›¸ä¼¼ï¼Œ å®ƒæœ‰ä¸€ä¸ªè¿”å›å€¼å’Œä»»æ„æ•°ç›®ä»»æ„ç±»å‹çš„å‚æ•°ï¼š

    public delegate void MessageDelegate(string message);
    public delegate int AnotherDelegate(MyType m, long num);


ä¸‹é¢çš„ç¤ºä¾‹ï¼Œå®šä¹‰äº†ä¸€ä¸ªå§”æ‰˜ç±»å‹ ShowValueï¼Œç„¶åé€šè¿‡å®ä¾‹åŒ– ShowValue æˆ– Action å§”æ‰˜æ¥è°ƒç”¨è¢«å§”æ‰˜çš„æ–¹æ³•ã€‚ä½¿ç”¨ Action å¯ä»¥ç®€åŒ–ä»£ç ï¼Œè€Œä¸ç”¨æ˜¾å¼å®šä¹‰ä¸€ä¸ªæ–°å§”æ‰˜å¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªå‘½åæ–¹æ³•ã€‚å§”æ‰˜æ–¹æ³•æœ‰ Action å®ä¾‹åŒ–ï¼ŒåŒ¿åæ–¹å¼ï¼Œlambda è¡¨è¾¾å¼æ–¹å¼ã€‚

    using System;
    using System.Windows.Forms;

    public delegate void ShowValue();

    public class Name
    {
       private string instanceName;

       public Name(string name)
       {
          this.instanceName = name;
       }

       public void DisplayToConsole()
       {
          Console.WriteLine(this.instanceName);
       }

       public void DisplayToWindow()
       {
          MessageBox.Show(this.instanceName);
       }
    }

    public class testTestDelegate
    {
       public static void Main()
       {

          Name testName = new Name("Koani");
          ShowValue delegateShow = testName.DisplayToWindow;
          delegateShow();

          Action anonymousSHow = delegate() { testName.DisplayToWindow();} ;
          anonymousSHow();

          Action lambdaShow = () => testName.DisplayToWindow();
          lambdaShow();

          Action actionShow = testName.DisplayToWindow;
          actionShow.Invoke();
       }
    }


## ==âš¡  Generic åå˜æ€§å’Œé€†å˜æ€§
https://zhuanlan.zhihu.com/p/143054881

åœ¨ C# 4.0 ä¸­å¼•å…¥äº†æ³›å‹çš„åå˜å’Œé€†å˜æ€§ï¼Œæ³›å‹çš„ä¸‰ä¸ªç‰¹æ€§ï¼š

- ä¸å˜æ€§ invariance
- åå˜æ€§ covariance æ˜¯æŒ‡æ–¹èƒ½ä»å§”æ‰˜çš„è¿”å›ç±»å‹æ´¾ç”Ÿä¸€ä¸ªç±»å‹ä½œä¸ºæ–¹æ³•è¿”å›ç±»å‹ã€‚
- é€†å˜æ€§ contravariance æ˜¯æŒ‡æ–¹æ³•å‚æ•°å¯ä»¥æ˜¯å§”æ‰˜çš„å‚æ•°ç±»å‹çš„åŸºç±»ã€‚

ç¤ºä¾‹ï¼š

    delegate Object MyCallback(FileStream s);
    string SomeMethod(Stream s){
        ...
    };

ä¾‹å­ï¼ŒSomeMethod å¯ä»¥ç»‘å®š MyCallBack å§”æ‰˜ï¼Œç¬¦å·åå˜æ€§å’Œé€†å˜æ€§ã€‚å› ä¸ºå…¶è¿”å›ç±»å‹ string æ´¾ç”Ÿè‡ª Object å³å§”æ‰˜è¿”å›ç±»å‹ï¼Œè¿™ç§åå˜æ€§æ˜¯å…è®¸çš„ã€‚å…¶å‚æ•°ç±»å‹ Stream çš„åŸºç±»æ˜¯ FileStream å³å§”æ‰˜çš„å‚æ•°ç±»å‹ï¼Œè¿™ç§é€†å˜æ€§æ˜¯å…è®¸çš„ã€‚

æ³¨æ„ï¼šåªæœ‰å¼•ç”¨ç±»å‹æ‰æ”¯æŒåå˜æ€§ä¸é€†å˜æ€§ï¼Œå€¼ç±»å‹æˆ– void ä¸æ”¯æŒã€‚æ‰€ä»¥ä¸èƒ½æŠŠä¸‹é¢çš„æ–¹æ³•ç»‘å®šåˆ° MyCallBack å§”æ‰˜ï¼š

    int SomeOtherMethod(Stream s);

è™½ç„¶ SomeOtherMethod çš„è¿”å›ç±»å‹ int æ´¾ç”Ÿè‡ª MyCallback çš„è¿”å›ç±»å‹ Objectï¼Œä½†è¿™ç§å½¢å¼çš„åå˜æ€§æ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸º int æ˜¯å€¼ç±»å‹ã€‚æ˜¾ç„¶ï¼Œå€¼ç±»å‹å’Œ void ä¹‹æ‰€ä»¥ä¸æ”¯æŒï¼Œæ˜¯å› ä¸ºå®ƒä»¬çš„å­˜å‚¨ç»“æ„æ˜¯å˜åŒ–çš„ï¼Œè€Œå¼•ç”¨ç±»å‹çš„å­˜å‚¨ç»“æ„å§‹ç»ˆæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚



## ==âš¡ Generics & List æ³›å‹
- https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/generics/
- []()

æ³›å‹ç±»å’Œæ³›å‹æ–¹æ³•å…¼å…·å¯é‡ç”¨æ€§ã€ç±»å‹å®‰å…¨æ€§å’Œæ•ˆç‡ï¼Œè¿™æ˜¯éæ³›å‹ç±»å’Œéæ³›å‹æ–¹æ³•æ— æ³•å®ç°çš„ã€‚ æ³›å‹é€šå¸¸ä¸é›†åˆä»¥åŠä½œç”¨äºé›†åˆçš„æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚ `System.Collections.Generic` å‘½åç©ºé—´åŒ…å«å‡ ä¸ªåŸºäºæ³›å‹çš„é›†åˆç±»ã€‚ éæ³›å‹é›†åˆï¼Œå¦‚ ArrayList ä¸å»ºè®®ä½¿ç”¨ï¼Œå¹¶ä¸”ä¿ç•™ç”¨äºå…¼å®¹æ€§ç›®çš„ã€‚

- ä½¿ç”¨æ³›å‹ç±»å‹å¯ä»¥æœ€å¤§é™åº¦åœ°é‡ç”¨ä»£ç ã€ä¿æŠ¤ç±»å‹å®‰å…¨æ€§ä»¥åŠæé«˜æ€§èƒ½ã€‚
- æ³›å‹æœ€å¸¸è§çš„ç”¨é€”æ˜¯åˆ›å»ºé›†åˆç±»ã€‚
- `System.Collections.Generic` å‘½åç©ºé—´ä¸­åŒ…å«å‡ ä¸ªæ–°çš„æ³›å‹é›†åˆç±»ã€‚ åº”å°½å¯èƒ½ä½¿ç”¨è¿™äº›ç±»æ¥ä»£æ›¿æŸäº›ç±»ï¼Œå¦‚ `System.Collections.ArrayList`ã€‚
- å¯ä»¥åˆ›å»ºè‡ªå·±çš„æ³›å‹æ¥å£ã€æ³›å‹ç±»ã€æ³›å‹æ–¹æ³•ã€æ³›å‹äº‹ä»¶å’Œæ³›å‹å§”æ‰˜ã€‚
- å¯ä»¥å¯¹æ³›å‹ç±»è¿›è¡Œçº¦æŸä»¥è®¿é—®ç‰¹å®šæ•°æ®ç±»å‹çš„æ–¹æ³•ã€‚
- åœ¨æ³›å‹æ•°æ®ç±»å‹ä¸­æ‰€ç”¨ç±»å‹çš„ä¿¡æ¯å¯åœ¨è¿è¡Œæ—¶é€šè¿‡ä½¿ç”¨åå°„æ¥è·å–ã€‚


ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æ³›å‹ç±»å‹å’Œæ³›å‹æ–¹æ³•ï¼Œä»¥æä¾›è‡ªå·±çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œè®¾è®¡ç±»å‹å®‰å…¨çš„é«˜æ•ˆæ¨¡å¼ã€‚ 

    // Declare the generic class.
    public class GenericList<T>
    {
        public void Add(T input) {
            // do nothing...
        }
    }
    class TestGenericList
    {
        private class ExampleClass { }
        static void Main()
        {
            // Declare a list of type int.
            GenericList<int> list1 = new GenericList<int>();
            list1.Add(1);

            // Declare a list of type string.
            GenericList<string> list2 = new GenericList<string>();
            list2.Add("");

            // Declare a list of type ExampleClass.
            GenericList<ExampleClass> list3 = new GenericList<ExampleClass>();
            list3.Add(new ExampleClass());
        }
    }

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æ³›å‹ç±»å‹å’Œæ³›å‹æ–¹æ³•ï¼Œä»¥æä¾›è‡ªå·±çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œè®¾è®¡ç±»å‹å®‰å…¨çš„é«˜æ•ˆæ¨¡å¼ã€‚

ä»¥ä¸‹ä»£ç ç¤ºä¾‹æ¼”ç¤ºäº†å‡ºäºæ¼”ç¤ºç›®çš„çš„ç®€å•æ³›å‹é“¾æ¥åˆ—è¡¨ç±»ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ä½¿ç”¨ .NET Framework ç±»åº“æä¾›çš„ List<T> ç±»ï¼Œè€Œä¸æ˜¯è‡ªè¡Œåˆ›å»ºç±»ã€‚ å…¶ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

- åœ¨ AddHead æ–¹æ³•ä¸­ T ä½œä¸ºæ–¹æ³•å‚æ•°çš„ç±»å‹ã€‚
- æ³›å‹ T åœ¨åµŒå¥—ç±»ä¸­ä½œé“¾è¡¨æ•°æ®ç»“æ„ä¸­èŠ‚ç‚¹çš„ Node çš„ Data å±æ€§ç±»å‹ã€‚
- æ³›å‹ T åœ¨åµŒå¥—ç±»ä¸­ç§æœ‰æˆå‘˜ data çš„ç±»å‹ã€‚

è¯·æ³¨æ„ï¼ŒT å¯ç”¨äº Node åµŒå¥—ç±»ã€‚ å¦‚æœä½¿ç”¨å…·ä½“ç±»å‹å®ä¾‹åŒ– GenericList<T>ï¼Œä¾‹å¦‚ï¼Œ`GenericList<int>`ï¼Œåˆ™æ‰€æœ‰ T éƒ½å°†æ›¿æ¢ä¸º intã€‚

    // type parameter T in angle brackets
    public class GenericList<T>
    {
        // The nested class is also generic on T.
        private class Node
        {
            // T used in non-generic constructor.
            public Node(T t)
            {
                next = null;
                data = t;
            }

            private Node next;
            public Node Next
            {
                get { return next; }
                set { next = value; }
            }

            // T as private member data type.
            private T data;

            // T as return type of property.
            public T Data
            {
                get { return data; }
                set { data = value; }
            }
        }

        private Node head;

        // constructor
        public GenericList()
        {
            head = null;
        }

        // T as method parameter type:
        public void AddHead(T t)
        {
            Node n = new Node(t);
            n.Next = head;
            head = n;
        }

        public IEnumerator<T> GetEnumerator()
        {
            Node current = head;

            while (current != null)
            {
                yield return current.Data;
                current = current.Next;
            }
        }
    }




## ==âš¡ PreProcessor pragma æŒ‡ä»¤
-[Recommended tags for documentation comments](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/xmldoc/recommended-tags-for-documentation-comments)
-[C# preprocessor directives](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives)

pragma disable ç¦ç”¨äº†ä¸æ„Ÿå…´è¶£çš„ç‰¹åˆ«è­¦å‘Šï¼Œpragma restore ä¸ªæ¢å¤äº†å®ƒã€‚

ç¦ç”¨å°½å¯èƒ½å°çš„ä¸€æ®µä»£ç çš„è­¦å‘Šæ˜¯ä¸€ä¸ªè‰¯å¥½çš„åšæ³•ï¼Œä»¥ä¾¿ä½ ä¸ä¼šé”™è¿‡ä»»ä½•çœŸæ­£åº”è¯¥ä¿®å¤çš„é”™è¯¯ã€‚

å¦‚æœä½ æƒ³åœ¨å•ç‹¬ä¸€è¡Œä¸Šç¦ç”¨æˆ–æ¢å¤å¤šä¸ªè­¦å‘Šï¼Œé‚£ä¹ˆåªéœ€ç”¨é€—å·åˆ†éš”å¤šä¸ªè­¦å‘Šç¼–å·ã€‚å¦‚æœä½ æ²¡æœ‰æŒ‡å®šä»»ä½•è­¦å‘Šç¼–å·ï¼Œå°†ä¸€æ¬¡æ€§ç¦ç”¨æˆ–æ¢å¤æ‰€æœ‰è­¦å‘Šâ€”â€”ä¸è¿‡æ— è®ºä»å“ªä¸ªæ–¹é¢æƒ³è¿™éƒ½æ˜¯ä¸ªåä¸»æ„

        class Program
        {
            static void Main(string[] args)
            {

            }
        }
        public class FieldUsedOnlyByReflection
        {
    #pragma warning disable 0169
            int x;
    #pragma warning restore 0169


## ==âš¡ Namespace & Using Alias å‘½åç©ºé—´åˆ«å
- https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/namespaces/

namespace å…³é”®å­—ç”¨äºå£°æ˜åŒ…å«ä¸€ç»„ç›¸å…³å¯¹è±¡çš„ä½œç”¨åŸŸã€‚ å¯ä»¥ä½¿ç”¨å‘½åç©ºé—´æ¥ç»„ç»‡ä»£ç å…ƒç´ å¹¶åˆ›å»ºå…¨å±€å”¯ä¸€ç±»å‹ã€‚

    namespace SomeNameSpace
    {
        public class MyClass
        {
            static void Main()
            {
                Nested.NestedNameSpaceClass.SayHello();
            }
        }

        // a nested namespace
        namespace Nested
        {
            public class NestedNameSpaceClass
            {
                public static void SayHello()
                {
                    Console.WriteLine("Hello");
                }
            }
        }
    }

using æŒ‡ä»¤æœ‰ä¸‰ç§ç”¨é€”ï¼š

å…è®¸åœ¨å‘½åç©ºé—´ä¸­ä½¿ç”¨ç±»å‹ï¼Œè¿™æ ·æ— éœ€åœ¨è¯¥å‘½åç©ºé—´ä¸­é™å®šæŸä¸ªç±»å‹çš„ä½¿ç”¨ï¼š

    using System.Text;

using static å…è®¸è®¿é—®ç±»å‹çš„é™æ€æˆå‘˜å’ŒåµŒå¥—ç±»å‹ï¼Œè€Œæ— éœ€é™å®šä½¿ç”¨ç±»å‹åç§°è¿›è¡Œè®¿é—®ã€‚

    using static System.Console;
    using static System.Math;

    class Program
    {
        static void Main()
        {
            WriteLine(Sqrt(3*3 + 4*4));
        }
    }

ä¸ºå‘½åç©ºé—´æˆ–ç±»å‹åˆ›å»ºåˆ«åã€‚ è¿™ç§°ä¸º using åˆ«åæŒ‡ä»¤ã€‚

    using Project = PC.MyCompany.Project;


å‘½åç©ºé—´åˆ«åç”¨æ³• ALIAS::CLASSï¼š

    using WinForm = System.Windows.Forms;

    namespace Test01
    {
        class WinForm { }
        class Program
        {
            static void Main(string[] args)
            {
                Console.WriteLine(typeof(WinForm::Button));
                Console.ReadKey();
            }
        }
    }

å…¨å±€å‘½åç©ºé—´åˆ«å global::CLASS

    using System;

    class Configuration { }

    namespace Test01
    {
        class Configuration { }
        class Program
        {
            static void Main(string[] args)
            {
                Console.WriteLine(typeof(Configuration)); // Test01.Configuration
                Console.WriteLine(typeof(global::Configuration)); // Configuration
                Console.WriteLine(typeof(global::Test01.Configuration)); // Test01.Configuration
                Console.ReadKey();
            }
        }
    }


è‹¥è¦å¼•ç”¨å…·æœ‰ç›¸åŒçš„å®Œå…¨é™å®šç±»å‹åç§°çš„ä¸¤ä¸ªç¨‹åºé›†ï¼Œå¿…é¡»åœ¨å‘½ä»¤æç¤ºç¬¦å¤„æŒ‡å®šåˆ«åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    /r:GridV1=grid.dll

    /r:GridV2=grid20.dll

è¿™å°†åˆ›å»ºå¤–éƒ¨åˆ«å GridV1 å’Œ GridV2ã€‚ è‹¥è¦ä»ç¨‹åºä¸­ä½¿ç”¨è¿™äº›åˆ«åï¼Œè¯·é€šè¿‡ä½¿ç”¨ extern å…³é”®å­—å¼•ç”¨å®ƒä»¬ã€‚ ä¾‹å¦‚:

    extern alias GridV1;

    extern alias GridV2;

GridV1::Grid æ˜¯ grid.dll ä¸­çš„ç½‘æ ¼æ§ä»¶ï¼ŒGridV2::Grid æ˜¯ grid20.dll ä¸­çš„ç½‘æ ¼æ§ä»¶ã€‚


## ==âš¡ Implementing the Singleton Pattern in C# - C# in Depth
- http://csharpindepth.com/Articles/General/Singleton.aspx#performance
- https://www.cnblogs.com/xtxk110/p/12884937.html

C# in Depth æ­¤ä¹¦ä¸­å¹¶æ²¡æœ‰å…³äºå•ä¾‹æ¨¡å¼çš„å†…å®¹ï¼Œåªæ˜¯ç½‘ç«™ä¸Šçš„æ–‡ç«  Implementing the Singleton Pattern in C#

è¨€å¤–ä¹‹æ„ï¼šæ€»ä¹‹ä¸€å¥è¯´ï¼ŒC# æ˜¯æœ€å¥½çš„ï¼

å•ä¾‹æ¨¡å¼æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­æœ€ç€åçš„æ¨¡å¼ä¹‹ä¸€ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œå•ä¾‹æ˜¯ä¸€ä¸ªåªå…è®¸åˆ›å»ºè‡ªèº«çš„å•ä¸ªå®ä¾‹çš„ç±»ï¼Œå¹¶ä¸”é€šå¸¸å¯ä»¥ç®€å•åœ°è®¿é—®è¯¥å®ä¾‹ã€‚


ç¬¬å…­ç‰ˆ - ä½¿ç”¨ .NET 4 çš„ Lazy ç±»å‹

.NET 4 æˆ–æ›´é«˜ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ System.Lazy ç±»å‹ä½¿æƒ°æ€§å˜å¾—éå¸¸ç®€å•ã€‚æ‚¨éœ€è¦åšçš„å°±æ˜¯å°†å§”æ‰˜ä¼ é€’ç»™è°ƒç”¨Singletonã€€æ„é€ å‡½æ•°çš„æ„é€ å‡½æ•°â€”â€”ä½¿ç”¨ã€€lambdaã€€è¡¨è¾¾å¼æœ€å®¹æ˜“åšåˆ°è¿™ä¸€ç‚¹ã€‚

```c#
public sealed class Singleton
{
    private static readonly Lazy<Singleton> lazy =
        new Lazy<Singleton>(() => new Singleton());
    
    public static Singleton Instance { get { return lazy.Value; } }

    private Singleton() { }
}
```

å®ƒå¾ˆç®€å•ï¼Œè€Œä¸”æ€§èƒ½å¾ˆå¥½ã€‚å®ƒè¿˜å…è®¸æ‚¨æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨ã€€IsValueCreated å±æ€§åˆ›å»ºå®ä¾‹ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚

ä¸Šé¢çš„ä»£ç éšå¼åœ°å°† LazyThreadSafetyMode.ExecutionAndPublication ç”¨ä½œ Lazy<Singleton> çš„çº¿ç¨‹å®‰å…¨æ¨¡å¼ã€‚


ç¬¬äº”ç‰ˆ - å®Œå…¨æ‡’æƒ°çš„å®ä¾‹åŒ–

```c#
public sealed class Singleton
{
    private Singleton() { }

    public static Singleton Instance { get { return Nested.instance; } }
        
    private class Nested
    {
        // Tell compiler NOT to Use BeforeFieldInit
        static Nested() { }

        internal static readonly Singleton instance = new Singleton();
    }
}
```

åœ¨è¿™é‡Œï¼Œå®ä¾‹åŒ–æ˜¯ç”±å¯¹åµŒå¥—ç±»çš„é™æ€æˆå‘˜çš„ç¬¬ä¸€æ¬¡å¼•ç”¨è§¦å‘çš„ï¼Œè¯¥å¼•ç”¨åªå‘ç”Ÿåœ¨å®ä¾‹åŒ–æ—¶ã€‚è¿™æ„å‘³ç€å®ç°æ˜¯å®Œå…¨æ‡’æƒ°çš„ï¼Œä½†æ˜¯å…·æœ‰å‰é¢å®ç°çš„æ‰€æœ‰æ€§èƒ½ä¼˜åŠ¿ã€‚è¯·æ³¨æ„ï¼Œå°½ç®¡åµŒå¥—ç±»å¯ä»¥è®¿é—®å°é—­ç±»çš„ç§æœ‰æˆå‘˜ï¼Œä½†åä¹‹åˆ™ä¸ç„¶ï¼Œå› æ­¤éœ€è¦åœ¨æ­¤å¤„å®ä¾‹åŒ–ä¸ºå†…éƒ¨æˆå‘˜ã€‚ä¸è¿‡ï¼Œè¿™ä¸ä¼šå¼•èµ·ä»»ä½•å…¶ä»–é—®é¢˜ï¼Œå› ä¸ºç±»æœ¬èº«æ˜¯ç§æœ‰çš„ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿å®ä¾‹åŒ–å˜å¾—æ‡’æƒ°ï¼Œä»£ç è¦ç¨å¾®å¤æ‚ä¸€äº›ã€‚


ç¬¬å››ç‰ˆ - ä¸å¤ªæ‡’ï¼Œä¸ä½¿ç”¨é”ä¸”çº¿ç¨‹å®‰å…¨

```c#
public sealed class Singleton
{
    private static readonly Singleton instance = new Singleton();

    // Tell compiler NOT to Use BeforeFieldInit
    static Singleton() { }

    private Singleton() { }

    public static Singleton Instance
    {
        get
        {
            return instance;
        }
    }
}
```


è¿™å®é™…ä¸Šéå¸¸ç®€å•ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒæœ‰å¤šæ‡’æƒ°ï¼Ÿ C# ä¸­çš„é™æ€æ„é€ å‡½æ•°ä»…åœ¨åˆ›å»ºç±»çš„å®ä¾‹æˆ–å¼•ç”¨é™æ€æˆå‘˜æ—¶æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ª AppDomain åªæ‰§è¡Œä¸€æ¬¡ã€‚

ç¬¬ä¸‰ç‰ˆ - ç³Ÿç³•çš„åŒé‡æ£€æŸ¥é”å®šå°è¯•çº¿ç¨‹å®‰å…¨

```c#
public sealed class Singleton
{
    private static Singleton instance = null;
    private static readonly object padlock = new object();

    Singleton()
    {
    }

    public static Singleton Instance
    {
        get
        {
            if (instance == null)
            {
                lock (padlock)
                {
                    if (instance == null)
                    {
                        instance = new Singleton();
                    }
                }
            }
            return instance;
        }
    }
}
```


è¯¥å®ç°å°è¯•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œä¸å¿…æ¯æ¬¡éƒ½å–å‡ºé”ã€‚ä¸å¹¸çš„æ˜¯ç³Ÿç³•çš„å®ç°ï¼Œç¼ºç‚¹å¤šã€‚

å®ƒåœ¨ Java ä¸­ä¸èµ·ä½œç”¨ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„äº‹æƒ…ï¼Œä½†æ˜¯å¦‚æœæ‚¨éœ€è¦ Java ä¸­çš„å•ä¾‹æ¨¡å¼ï¼Œè¿™åº”è¯¥è¦çŸ¥é“ï¼ŒC# ç¨‹åºå‘˜ä¹Ÿå¯èƒ½æ˜¯ Java ç¨‹åºå‘˜ã€‚Java å†…å­˜æ¨¡å‹æ— æ³•ç¡®ä¿æ„é€ å‡½æ•°åœ¨æ–°å¯¹è±¡çš„å¼•ç”¨åˆ†é…ç»™å®ä¾‹ä¹‹å‰å®Œæˆã€‚Java å†…å­˜æ¨¡å‹ç»å†äº† 1.5 ç‰ˆæœ¬çš„é‡æ–°æ”¹è¿›ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰ volatile å˜é‡ï¼ˆå¦‚åœ¨Cï¼ƒä¸­ï¼‰çš„æƒ…å†µä¸‹ï¼ŒåŒé‡æ£€æŸ¥é”å®šä»ç„¶ä¼šè¢«ç ´åã€‚

ç¬¬äºŒç‰ˆ â€”â€” ç®€å•çš„çº¿ç¨‹å®‰å…¨

```c#
public sealed class Singleton
{
    private static Singleton instance = null;
    private static readonly object padlock = new object();

    Singleton() { }

    public static Singleton Instance
    {
        get
        {
            lock (padlock)
            {
                if (instance == null)
                {
                    instance = new Singleton();
                }
                return instance;
            }
        }
    }
}
```


æ­¤å®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚çº¿ç¨‹å–æ¶ˆå¯¹å…±äº«å¯¹è±¡çš„é”å®šï¼Œç„¶ååœ¨åˆ›å»ºå®ä¾‹ä¹‹å‰æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºå®ä¾‹ã€‚è¿™ä¼šè§£å†³å†…å­˜å±éšœé—®é¢˜ï¼Œé”å®šç¡®ä¿åœ¨è·å–é”ä¹‹åé€»è¾‘ä¸Šå‘ç”Ÿæ‰€æœ‰è¯»å–ï¼Œå¹¶ä¸”è§£é”ç¡®ä¿åœ¨é”å®šé‡Šæ”¾ä¹‹å‰é€»è¾‘ä¸Šå‘ç”Ÿæ‰€æœ‰å†™å…¥ã€‚

lock readonly object ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹å°†åˆ›å»ºå®ä¾‹ï¼Œä»…é™äºä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®é”å®šä»£ç ï¼Œå½“ç¬¬äºŒä¸ªçº¿ç¨‹è¿›å…¥å®ƒæ—¶ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å°†åˆ›å»ºå®ä¾‹ï¼Œå› æ­¤è¡¨è¾¾å¼å°†è®¡ç®—ä¸º falseã€‚

ä¸å¹¸çš„æ˜¯ï¼Œæ¯æ¬¡è¯·æ±‚å®ä¾‹æ—¶éƒ½ä¼šè·å¾—é”å®šï¼Œå› æ­¤æ€§èƒ½ä¼šå—åˆ°å½±å“ã€‚

ç¬¬ä¸€ç‰ˆ â€”â€” éçº¿ç¨‹å®‰å…¨çš„ï¼ˆä¸å»ºè®®ï¼‰

```c#
// ç³Ÿç³•çš„ä»£ç ï¼ä¸è¦ä½¿ç”¨ï¼
public  sealed  class  Singleton 
{ 
    private  static  Singleton instance = null ; 

    private  Singleton() { }

    public  static  Singleton Instance 
    { 
        get 
        { 
            if (instance == null)
            { 
                instance =  new  Singleton(); 
            } 
            return  instance; 
        } 
    } 
}
```


ä¸¤ä¸ªä¸åŒçš„çº¿ç¨‹éƒ½å¯ä»¥åœ¨ (instance==null) æ¡ä»¶ä¸­å¾—åˆ° trueï¼Œç„¶åä¸¤ä¸ªéƒ½åˆ›å»ºå®ä¾‹ï¼Œè¿™è¿åäº†å•ä¾‹æ¨¡å¼ã€‚å®é™…ä¸Šï¼Œåœ¨è®¡ç®—è¡¨è¾¾å¼ä¹‹å‰å¯èƒ½å·²ç»åˆ›å»ºäº†å®ä¾‹ï¼Œä½†æ˜¯å†…å­˜æ¨¡å‹ä¸ä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹åˆ°å®ä¾‹çš„æ–°å€¼ï¼Œé™¤éå·²ç»ä¼ é€’äº†åˆé€‚çš„å†…å­˜å±éšœï¼ˆäº’æ–¥é”ï¼‰ã€‚


## ==âš¡ static contructor & BeforeFieldInit

CLR - Common Language Runtime è¿è¡Œæ—¶ç›¸å½“äºä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œç›¸å½“äº JVMã€‚

IL - Intermidiate Language ä¸­é—´è¯­è¨€ï¼ŒC# å…ˆç¼–è¯‘æˆä¸­é—´è¯­è¨€å†åœ¨ CLR ä¸Šé¢æ‰§è¡Œã€‚

å½“æ³›å‹ç±»æ²¡æœ‰é™æ€æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œåœ¨ C# çš„ IL ä¸­è¯¥ç±»ä¼šè¢«æ ‡è®°ä¸º BeforeFieldInitï¼Œå³ä¸ªé™æ€æˆå‘˜ä¼šåœ¨å­—æ®µåˆå§‹åŒ–å‰å°†æ‰§è¡Œï¼Œå…ˆäºå…¥å£å‡½æ•°æ‰§è¡Œï¼Œè¿™ä¸ªæ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨å®Œæˆçš„ã€‚

åªè¦å®šä¹‰äº†é™æ€å‡½æ•°ï¼Œå³ä½¿æ˜¯ä¸åšä»»ä½•åŠ¨ä½œçš„ç©ºå‡½æ•°ï¼Œé‚£ä¹ˆå€™é™æ€åˆå§‹åŒ–å‘ç”Ÿåœ¨ä½¿ç”¨å‰æœŸï¼š

```C#
using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;

public static class StaticDemo<T>
{
    public static readonly DateTime Time = GetNow();
    private static DateTime GetNow()
    {
        Console.WriteLine("GetNow execute!");
        return DateTime.Now;
    }
    // Tell compiler NOT to Use BeforeFieldInit
    static StaticDemo(){}
}

class Program
{
    static void Main(string[] args)
    {

        Console.WriteLine("Main execute!");
        Console.WriteLine("stage 1: {0:mm:ss.fff}ms", StaticDemo<int>.Time);
        Thread.Sleep(1000);
        Console.WriteLine("stage 2: {0:mm:ss.fff}ms", StaticDemo<string>.Time);
        Console.WriteLine("stage 3: {0:mm:ss.fff}ms", StaticDemo<int>.Time);
        Console.WriteLine("stage 4: {0:mm:ss.fff}ms", StaticDemo<string>.Time);
        // Console.ReadLine();
    }
}
```


è¾“å‡ºï¼š

    Main execute!
    GetNow execute!
    stage 1: 35:05.524ms
    GetNow execute!
    stage 2: 35:06.526ms
    stage 1: 35:05.524ms
    stage 2: 35:06.526ms

åœ¨é¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œä¸å®šä¹‰é™æ€æ„é€ å‡½æ•°ï¼Œå³ BeforeFieldInit ä¼šæé«˜æ€§èƒ½ï¼Œå› ä¸ºé¢„å¤„ç†äº†ã€‚

C# ä¸­çš„é™æ€æ„é€ å‡½æ•°ä»…åœ¨åˆ›å»ºç±»çš„å®ä¾‹æˆ–å¼•ç”¨é™æ€æˆå‘˜æ—¶æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ª AppDomain åªæ‰§è¡Œä¸€æ¬¡ã€‚



## ==âš¡ Class & Interface ç±»ä¸æ¥å£
- [å¯å¼•ç”¨çš„æ•°æ®ç±»å‹](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/reference-types)
- [ç±»å’Œç»“æ„](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/classes-and-structs/)
- [è®¿é—®ä¿®é¥°ç¬¦ - C# å…³é”®å­—](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/access-modifiers)
- [C# Interface](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/interfaces/)

C# ä¸­æœ‰ä¸¤ç§ç±»å‹ï¼šå¼•ç”¨ç±»å‹å’Œå€¼ç±»å‹ã€‚ å¼•ç”¨ç±»å‹çš„å˜é‡å­˜å‚¨å¯¹å…¶æ•°æ®ï¼ˆå¯¹è±¡ï¼‰çš„å¼•ç”¨ï¼Œè€Œå€¼ç±»å‹çš„å˜é‡ç›´æ¥åŒ…å«å…¶æ•°æ®ã€‚ å¯¹äºå¼•ç”¨ç±»å‹ï¼Œä¸¤ç§å˜é‡å¯å¼•ç”¨åŒä¸€å¯¹è±¡ï¼›å› æ­¤ï¼Œå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œçš„æ“ä½œä¼šå½±å“å¦ä¸€ä¸ªå˜é‡æ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚ å¯¹äºå€¼ç±»å‹ï¼Œæ¯ä¸ªå˜é‡éƒ½å…·æœ‰å…¶è‡ªå·±çš„æ•°æ®å‰¯æœ¬ï¼Œå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œçš„æ“ä½œä¸ä¼šå½±å“å¦ä¸€ä¸ªå˜é‡ï¼Œinã€ref å’Œ out å‚æ•°å˜é‡é™¤å¤–ã€‚

.NET ç±»å‹ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç±»å‹é™¤äº†å¯ä»¥é€šè¿‡å•ä¸€ç»§æ‰¿è¿›è¡Œç»§æ‰¿ä¹‹å¤–ï¼Œè¿˜å¯ä»¥éšå¼ç»§æ‰¿è‡ª Object æˆ–å…¶æ´¾ç”Ÿçš„ç±»å‹ã€‚ Object çš„å¸¸ç”¨åŠŸèƒ½å¯ç”¨äºä»»ä½•ç±»å‹ï¼Œæ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª System.Object ç±»ã€‚

å’Œç±»ä¸åŒï¼Œç»“æ„æ˜¯å€¼ç±»å‹ï¼Œç»“æ„éƒ½ç»§æ‰¿è‡ª System.ValueType ç±»ã€‚ åˆ›å»ºç»“æ„æ—¶ï¼Œå‘å…¶åˆ†é…ç»“æ„çš„å˜é‡ä¿ç•™ç»“æ„çš„å®é™…æ•°æ®ã€‚ç»“æ„åœ¨æ ˆä¸Šåˆ†é…å†…å®¹ï¼ŒEnum æšä¸¾ç±»å‹ä¸æ˜¯ã€‚ å°†ç»“æ„åˆ†é…ç»™æ–°å˜é‡æ—¶ï¼Œä¼šå¤åˆ¶ç»“æ„ã€‚ å› æ­¤ï¼Œæ–°å˜é‡å’ŒåŸå§‹å˜é‡åŒ…å«ç›¸åŒæ•°æ®çš„å‰¯æœ¬ï¼ˆå…±ä¸¤ä¸ªï¼‰ã€‚ å¯¹ä¸€ä¸ªå‰¯æœ¬æ‰€åšçš„æ›´æ”¹ä¸ä¼šå½±å“å¦ä¸€ä¸ªå‰¯æœ¬ã€‚

ç±»å’Œç»“æ„æ˜¯ .NET Framework é€šç”¨ç±»å‹ç³»ç»Ÿçš„ä¸¤ç§åŸºæœ¬æ„é€ ã€‚ æ¯ç§æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­å°è£…äº†åŒå±ä¸€ä¸ªé€»è¾‘å•å…ƒçš„ä¸€ç»„æ•°æ®å’Œè¡Œä¸ºã€‚ æ•°æ®å’Œè¡Œä¸ºæ˜¯ç±»æˆ–ç»“æ„çš„æˆå‘˜ï¼ŒåŒ…æ‹¬æ–¹æ³•ã€å±æ€§å’Œäº‹ä»¶ç­‰ã€‚



ä¸‹åˆ—å…³é”®å­—ç”¨äºå£°æ˜å¼•ç”¨ç±»å‹ï¼š

- class
- interface
- delegate

C# ä¹Ÿæä¾›äº†ä¸‹åˆ—å†…ç½®å¼•ç”¨ç±»å‹ï¼š

- dynamic
- object
- string

ä½¿ç”¨ class å…³é”®å­—å£°æ˜ç±»ï¼Œå¦‚ä¸‹ä¾‹ä¸­æ‰€ç¤ºï¼š

```C#,ignore
    using System;
    using System.Linq;
    using System.Collections.Generic;

    namespace Demo
    {
        public static class Program
        {
            public static void Main()
            {
                var test = new TestClass("ABC");
                test.Quadruple = 2;
                // test.Pi = 2; // Not Allow assign readonly property
                // var t = test._title; // Not Allow to access to protected
            }
        }

        interface IBasic
        {
            double Pi {get;}
            void Log();
            void Log(int level);
            // write definition for an interface from C# 8.0
        }

        abstract class Basic: IBasic {

            // fields members
            protected internal int _count = 1; // private protected | C# 7.2
            protected string _title = string.Empty; 

            // readonly fields members
            readonly double _pi = 3.14159265358; 

            // readonly property members
            public double Pi => this._pi; // implementation of IBasic

            // normal property members
            public int Quadruple { 
                get {
                    return this._count * 4;
                }
                set {
                    Console.WriteLine("Not Allow to change to {0}, keep {1}", value, this.Quadruple);
                }
            } 

            public Basic(string t){
                _title = t;
                Console.WriteLine($"Basic(t={t})");
            }

             // implementation of IBasic
            public virtual void Log(){
                Console.WriteLine($"Log _title({this._title})");
            }

            public abstract void Log(int level);
        }

        class TestClass: Basic
        {
            public TestClass(string t): base(t)
            {
                this._title = "Test";
                base.Log();
                this.Log();
            }

            public override void Log()
            {
                Console.WriteLine($"Log[New] _title is {this._title}");
            }
            
            public override void Log(int level){
                Console.WriteLine($"Log LEVEL[{level}] _title is {this._title}");
            }

            // Methods, properties, fields, events, delegates
            // and nested classes go here.
            public sealed class nestedClass : TestClass
            {
                public  nestedClass(string t): base(t){

                }
            }
        }

        // class NotAllowToExtendsSealedClass: TestClass.nestedClass {}

    }
```


åœ¨ C# ä¸­ä»…å…è®¸å•ä¸€ç»§æ‰¿ï¼Œä½†æ˜¯ï¼Œä¸€ä¸ªç±»å¯å®ç°å¤šä¸ªæ¥å£ã€‚

ç›´æ¥åœ¨å‘½åç©ºé—´ä¸­å£°æ˜çš„ã€æœªåµŒå¥—åœ¨å…¶å®ƒç±»ä¸­çš„ç±»ï¼Œå¯ä»¥æ˜¯å…¬å…±æˆ–å†…éƒ¨ï¼Œ é»˜è®¤æƒ…å†µä¸‹ç±»ä¸º internalã€‚

ä¸€ä¸ªç±»å¯åŒ…å«ä¸‹åˆ—æˆå‘˜çš„å£°æ˜ï¼š

- æ„é€ å‡½æ•° Constructors
- å¸¸é‡ Constants
- å­—æ®µ Fields
- ç»ˆç»“å™¨ Finalizers
- æ–¹æ³• Methods
- å±æ€§ Properties
- ç´¢å¼•å™¨ Indexers
- è¿ç®—ç¬¦ Operators
- äº‹ä»¶ Events
- å§”æ‰˜ Delegates
- ç±» Classes
- æ¥å£ Interfaces
- ç»“æ„ç±»å‹ Structure types
- æšä¸¾ç±»å‹ Enumeration types

é™æ€æ„é€ å™¨ static constructor æ˜¯å®ç°å¯¹ä¸€ä¸ªç±»è¿›è¡Œåˆå§‹åŒ–çš„æ–¹æ³•æˆå‘˜ï¼Œ å®ƒä¸€èˆ¬ç”¨äºå¯¹é™æ€æ•°æ®çš„åˆå§‹åŒ–ï¼Œé™æ€æ„é€ å‡½æ•°ä¸èƒ½æœ‰å‚æ•°ï¼Œä¸èƒ½æœ‰ä¿®é¥°ç¬¦è€Œä¸”ä¸èƒ½è¢«è°ƒç”¨ï¼Œéšç€ç±»åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚åœ¨ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”å…ˆäºä»»ä½•ç±»çš„é™æ€æˆå‘˜è¢«å¼•ç”¨ä¹‹å‰ï¼Œé™æ€æˆå‘˜åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œæˆ–è€…è¯´ç¼–è¯‘å™¨ä¼šå°†é™æ€æˆå‘˜åˆå§‹åŒ–è¯­å¥è½¬æ¢æˆèµ‹å€¼è¯­å¥æ”¾åœ¨é™æ€æ„é€ å™¨æ‰§è¡Œçš„æœ€å¼€å§‹ã€‚

    class Program
        {
            static void Main(string[] args)
            {
                Demo p1 = new Demo();
                Console.ReadKey();
            }
        }
        class Demo
        {
            static Demo()
            {
                Console.WriteLine("Static Constructor...â€œ);
            }
            public Demo()
            {
                Console.WriteLine("Demo()...");
            }
        }


ç±»æˆ–ç»“æ„å¯ä»¥åµŒå¥—åœ¨å¦ä¸€ç±»æˆ–ç»“æ„ä¸­ã€‚å¦‚æœä¸æ–¹ä¾¿æˆ–æ²¡æœ‰å¿…è¦åˆ›å»ºå·²å‘½åçš„ç±»ï¼Œå¯ä»¥ä½¿ç”¨åŒ¿åç±»å‹ã€‚

    var anonArray = new[] { new { name = "apple", diam = 4 }, new { name = "grape", diam = 1 }};

    public class Outer
    {
        // protected method:
        protected void Pedal() { }
    
        class nested
        {
            int wheels;
        }
    }

ç±»æˆå‘˜åŒ…æ‹¬åµŒå¥—çš„ç±»ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å„ç§è®¿é—®çº§åˆ«ï¼Œé»˜è®¤æƒ…å†µä¸‹æˆå‘˜ä¸º privateã€‚æ‰€æœ‰ç±»å‹å’Œç±»å‹æˆå‘˜éƒ½å…·æœ‰å¯è®¿é—®æ€§çº§åˆ«ï¼Œå¯ä»¥æ§åˆ¶æ˜¯å¦å¯ä»¥ä»ä½ çš„ç¨‹åºé›†æˆ–å…¶ä»–ç¨‹åºé›†ä¸­çš„å…¶ä»–ä»£ç ä¸­ä½¿ç”¨å®ƒä»¬ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è®¿é—®ä¿®é¥°ç¬¦åœ¨è¿›è¡Œå£°æ˜æ—¶æŒ‡å®šç±»å‹æˆ–æˆå‘˜çš„å¯è®¿é—®æ€§ï¼š

| å¯è®¿é—®æ€§çº§åˆ«    | æ³¨è§£ |
| :---------    | :--------- |
| public    | åŒä¸€ç¨‹åºé›†ä¸­çš„ä»»ä½•å…¶ä»–ä»£ç æˆ–å¼•ç”¨è¯¥ç¨‹åºé›†çš„å…¶ä»–ç¨‹åºé›†éƒ½å¯ä»¥è®¿é—®è¯¥ç±»å‹æˆ–æˆå‘˜ã€‚ |
| private   | åªæœ‰åŒä¸€ class æˆ– struct ä¸­çš„ä»£ç å¯ä»¥è®¿é—®è¯¥ç±»å‹æˆ–æˆå‘˜ã€‚ |
| protected | åªæœ‰åŒä¸€ class æˆ–è€…ä»è¯¥ class æ´¾ç”Ÿçš„ class ä¸­çš„ä»£ç å¯ä»¥è®¿é—®è¯¥ç±»å‹æˆ–æˆå‘˜ã€‚ |
| internal  | åŒä¸€ç¨‹åºé›†ä¸­çš„ä»»ä½•ä»£ç éƒ½å¯ä»¥è®¿é—®è¯¥ç±»å‹æˆ–æˆå‘˜ï¼Œä½†å…¶ä»–ç¨‹åºé›†ä¸­çš„ä»£ç ä¸å¯ä»¥ã€‚ |
| protected internal    | è¯¥ç±»å‹æˆ–æˆå‘˜å¯ç”±å¯¹å…¶è¿›è¡Œå£°æ˜çš„ç¨‹åºé›†æˆ–å¦ä¸€ç¨‹åºé›†ä¸­çš„æ´¾ç”Ÿ class ä¸­çš„ä»»ä½•ä»£ç è®¿é—®ã€‚ |
| private protected | C# 7.2 å¯ç”¨ã€‚åªæœ‰åœ¨å…¶å£°æ˜ç¨‹åºé›†å†…ï¼Œé€šè¿‡ç›¸åŒ class ä¸­çš„ä»£ç æˆ–æ´¾ç”Ÿè‡ªè¯¥ class çš„ç±»å‹ï¼Œæ‰èƒ½è®¿é—®ç±»å‹æˆ–æˆå‘˜ã€‚ |

ä½œä¸ºå…¶ä»–ç±»å‹çš„æˆå‘˜çš„åµŒå¥—ç±»å‹å¯ä»¥å…·æœ‰å¦‚ä¸‹è¡¨æ‰€ç¤ºçš„å£°æ˜çš„å¯è®¿é—®æ€§ï¼š

ä½¿ç”¨ abstract å…³é”®å­—å¯ä»¥åˆ›å»ºä¸å®Œæ•´ä¸”å¿…é¡»åœ¨æ´¾ç”Ÿç±»ä¸­å®ç°çš„ç±»å’Œ class æˆå‘˜ã€‚

ä½¿ç”¨ sealed å…³é”®å­—å¯é˜»æ­¢å…¶ä»–ç±»ç»§æ‰¿è‡ªè¯¥ç±»ï¼Œå¯ä»¥é˜²æ­¢ç»§æ‰¿ä»¥å‰æ ‡è®°ä¸º virtual çš„ç±»æˆ–æŸäº›ç±»æˆå‘˜ã€‚

ä½¿ç”¨ static ä¿®é¥°ç¬¦å¯å£°æ˜å±äºç±»å‹æœ¬èº«è€Œä¸æ˜¯å±äºç‰¹å®šå¯¹è±¡çš„é™æ€æˆå‘˜ã€‚ static ä¿®é¥°ç¬¦å¯ç”¨äºå£°æ˜ static ç±»ã€‚ åœ¨ç±»ã€æ¥å£å’Œç»“æ„ä¸­ï¼Œå¯ä»¥å°† static ä¿®é¥°ç¬¦æ·»åŠ åˆ°å­—æ®µã€æ–¹æ³•ã€å±æ€§ã€è¿ç®—ç¬¦ã€äº‹ä»¶å’Œæ„é€ å‡½æ•°ã€‚ static ä¿®é¥°ç¬¦ä¸èƒ½ç”¨äºç´¢å¼•å™¨æˆ–ç»ˆç»“å™¨ã€‚ 

éé™æ€ç±»å¯ä»¥åŒ…å«é™æ€æ–¹æ³•ã€å­—æ®µã€å±æ€§æˆ–äº‹ä»¶ã€‚ å³ä½¿æœªåˆ›å»ºç±»çš„ä»»ä½•å®ä¾‹ï¼Œä¹Ÿå¯å¯¹ç±»è°ƒç”¨é™æ€æˆå‘˜ã€‚


é»˜è®¤æˆå‘˜å¯è®¿é—®æ€§ï¼š

| æˆå‘˜        | é»˜è®¤æˆå‘˜å¯è®¿é—®æ€§  | å…è®¸çš„æˆå‘˜çš„å£°æ˜çš„å¯è®¿é—®æ€§ |
| :---------| :-------------    | :--------- |
| enum      | public            | æ—  |
| class     | private           | public /protected /internal /private /protected internal /private protected |
| interface | public            | æ—  |
| struct    | private /public /internal /private |

åµŒå¥—ç±»å‹çš„å¯è®¿é—®æ€§ä¾èµ–äºå®ƒçš„å¯è®¿é—®åŸŸï¼Œè¯¥åŸŸæ˜¯ç”±å·²å£°æ˜çš„æˆå‘˜å¯è®¿é—®æ€§å’Œç›´æ¥åŒ…å«ç±»å‹çš„å¯è®¿é—®åŸŸè¿™äºŒè€…å…±åŒç¡®å®šçš„ã€‚ ä½†æ˜¯ï¼ŒåµŒå¥—ç±»å‹çš„å¯è®¿é—®åŸŸä¸èƒ½è¶…å‡ºåŒ…å«ç±»å‹çš„å¯è®¿é—®åŸŸã€‚


å¤šæ€æ€§å¸¸è¢«è§†ä¸ºè‡ªå°è£…å’Œç»§æ‰¿ä¹‹åï¼Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹çš„ç¬¬ä¸‰ä¸ªæ”¯æŸ±ã€‚ Polymorphismï¼ˆå¤šæ€æ€§ï¼‰æ˜¯ä¸€ä¸ªå¸Œè…Šè¯ï¼ŒæŒ‡â€œå¤šç§å½¢æ€â€ï¼Œå¤šæ€æ€§å…·æœ‰ä¸¤ä¸ªæˆªç„¶ä¸åŒçš„æ–¹é¢ï¼š

- åœ¨è¿è¡Œæ—¶ï¼Œåœ¨æ–¹æ³•å‚æ•°å’Œé›†åˆæˆ–æ•°ç»„ç­‰ä½ç½®ï¼Œæ´¾ç”Ÿç±»çš„å¯¹è±¡å¯ä»¥ä½œä¸ºåŸºç±»çš„å¯¹è±¡å¤„ç†ã€‚ åœ¨å‡ºç°æ­¤å¤šå½¢æ€§æ—¶ï¼Œè¯¥å¯¹è±¡çš„å£°æ˜ç±»å‹ä¸å†ä¸è¿è¡Œæ—¶ç±»å‹ç›¸åŒã€‚

- åŸºç±»å¯ä»¥å®šä¹‰å¹¶å®ç°è™šæ–¹æ³•ï¼Œæ´¾ç”Ÿç±»å¯ä»¥é‡å†™è¿™äº›æ–¹æ³•ï¼Œå³æ´¾ç”Ÿç±»æä¾›è‡ªå·±çš„å®šä¹‰å’Œå®ç° ã€‚ åœ¨è¿è¡Œæ—¶ï¼Œå®¢æˆ·ç«¯ä»£ç è°ƒç”¨è¯¥æ–¹æ³•ï¼ŒCLR æŸ¥æ‰¾å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹ï¼Œå¹¶è°ƒç”¨è™šæ–¹æ³•çš„é‡å†™æ–¹æ³•ã€‚ ä½ å¯ä»¥åœ¨æºä»£ç ä¸­è°ƒç”¨åŸºç±»çš„æ–¹æ³•ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•çš„æ´¾ç”Ÿç±»ç‰ˆæœ¬ã€‚

è™šæ–¹æ³• virtual å…è®¸ä½ ä»¥ç»Ÿä¸€æ–¹å¼å¤„ç†å¤šç»„ç›¸å…³çš„å¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œå‡å®šä½ æœ‰ä¸€ä¸ªç»˜å›¾åº”ç”¨ç¨‹åºï¼Œå…è®¸ç”¨æˆ·åœ¨ç»˜å›¾å›¾é¢ä¸Šåˆ›å»ºå„ç§å½¢çŠ¶ã€‚ ä½ åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“ç”¨æˆ·å°†åˆ›å»ºå“ªäº›ç‰¹å®šç±»å‹çš„å½¢çŠ¶ã€‚

ä½¿ç”¨å¤šæ€æ€§è§£å†³è¿™ä¸€é—®é¢˜ï¼š

- åˆ›å»ºä¸€ä¸ªç±»å±‚æ¬¡ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªç‰¹å®šå½¢çŠ¶ç±»å‡æ´¾ç”Ÿè‡ªä¸€ä¸ªå…¬å…±åŸºç±»ã€‚
- ä½¿ç”¨è™šæ–¹æ³•é€šè¿‡å¯¹åŸºç±»æ–¹æ³•çš„å•ä¸ªè°ƒç”¨æ¥è°ƒç”¨ä»»ä½•æ´¾ç”Ÿç±»ä¸Šçš„ç›¸åº”æ–¹æ³•ã€‚

ä½¿ç”¨æ¥å£è§£å†³è¿™ä¸€é—®é¢˜ï¼š

- åˆ›å»ºä¸€ä¸ªåŸºç¡€æ¥å£ï¼Œå®šä¹‰ä¸å…·ä½“å½¢çŠ¶æ— å…³çš„ç»˜ç”»æ–¹æ³•ã€‚
- ä¸ºå…·ä½“çš„å½¢çŠ¶å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¹¶å®ç°åŸºç¡€æ¥å£ã€‚
- é€šè¿‡æ¥å£å®ä¾‹è°ƒç”¨ç»˜ç”»æ–¹æ³•ã€‚

ç¤ºä¾‹ï¼š

    using System;
    using System.Linq;
    using System.Collections.Generic;

    namespace Demo
    {
        public static class Program
        {
            public static void Main()
            {
                var shapes = new List<Shape>
                {
                    new Rectangle(),
                    new Triangle(),
                    new Circle()
                };

                // Polymorphism at work #2: the virtual method Draw is
                // invoked on each of the derived classes, not the base class.
                foreach (var shape in shapes)
                {
                    shape.Draw();
                }
            }
        }

        public class Shape
        {
            public int X { get; private set; }
            public int Y { get; private set; }

            public virtual void Draw(string type = "Shape")
            {
                // string interpolation require C# 6.0
                Console.WriteLine($"Drawing a {type} at ({X},{Y})");
            }
        }

        public class Circle : Shape
        {
            public override void Draw(string type)
            {
                base.Draw(this.GetType().Name);
            }
        }
        public class Rectangle : Shape
        {
            public override void Draw(string type)
            {
                base.Draw(this.GetType().Name);
            }
        }
        public class Triangle : Shape
        {
            public override void Draw(string type)
            {
                base.Draw(this.GetType().Name);
            }
        }

    }



### ===âœ’ Extension Methods æ‰©å±•æ–¹æ³•
- [Extension Methods - C# Programming Guide](programming-guide/classes-and-structs/extension-methods.md)
- [Extension Methods - Framework Design Guidelines](standard/design-guidelines/extension-methods.md)

é€šå¸¸ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å‘ç°æœ‰ç±»å‹æ·»åŠ æ–¹æ³•ï¼š

- ä¿®æ”¹è¯¥ç±»å‹çš„æºä»£ç ã€‚ å½“ç„¶ï¼Œå¦‚æœå¹¶ä¸æ‹¥æœ‰è¯¥ç±»å‹çš„æºä»£ç ï¼Œåˆ™æ— æ³•æ‰§è¡Œè¯¥æ“ä½œã€‚ å¹¶ä¸”ï¼Œå¦‚æœè¿˜æ·»åŠ ä»»ä½•ä¸“ç”¨æ•°æ®å­—æ®µæ¥æ”¯æŒè¯¥æ–¹æ³•ï¼Œè¿™ä¼šæˆä¸ºä¸€é¡¹é‡å¤§æ›´æ”¹ã€‚
- åœ¨æ´¾ç”Ÿç±»ä¸­å®šä¹‰æ–°æ–¹æ³•ã€‚ æ— æ³•ä½¿ç”¨å…¶ä»–ç±»å‹ï¼ˆå¦‚ç»“æ„å’Œæšä¸¾ï¼‰çš„ç»§æ‰¿æ¥é€šè¿‡æ­¤æ–¹å¼æ·»åŠ æ–¹æ³•ã€‚ ä¹Ÿä¸èƒ½ä½¿ç”¨æ­¤æ–¹å¼å‘å°é—­ç±»â€œæ·»åŠ â€æ–¹æ³•ã€‚

ä½¿ç”¨æ‰©å±•æ–¹æ³• Extension Methods ä¹Ÿå¯å‘ç°æœ‰ C# ç±»å‹æ·»åŠ æ–¹æ³•ï¼Œè€Œæ— éœ€ä¿®æ”¹ç±»å‹æœ¬èº«æˆ–åœ¨ç»§æ‰¿çš„ç±»å‹ä¸­å®ç°æ–°æ–¹æ³•ã€‚ æ‰©å±•æ–¹æ³•ä¹Ÿæ— éœ€é©»ç•™åœ¨ä¸å…¶æ‰©å±•çš„ç±»å‹ç›¸åŒçš„ç¨‹åºé›†ä¸­ï¼Œè¦æŠŠæ‰©å±•æ–¹æ³•å½“ä½œæ˜¯å®šä¹‰çš„ç±»å‹æˆå‘˜ä¸€æ ·è°ƒç”¨ã€‚


ä¸ºäº†ç†è§£å‘½åç©ºé—´å¼•å…¥ C# æ‰©å±•æ–¹æ³•çš„ä½œç”¨ï¼Œå¯ä»¥å…ˆå°† System.Linq æ³¨è§£ï¼Œç¼–è¯‘å°±ä¼šå‘ç°ï¼Œnumbers æ•°æ®æ ¹æœ¬æ²¡æœ‰ Select æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ˜¯ System.Linq æ‰©å±•æ•°ç»„å¾—æ¥çš„æ–¹æ³•ï¼Œåªæœ‰å¼•å…¥å‘½åç©ºé—´åæ‰å¯ä»¥ä½¿ç”¨ï¼š

```C#
using System;
using System.Linq;

class Example
{
    public static void Main()
    {
        int[] numbers = new int[]{2, 2, 3, 4, 5};
        var a = numbers.Select( i => new string('*', i));
        Console.WriteLine(string.Join(",",a));
    }
}
```

ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºä¸º System.String ç±»å®šä¹‰çš„ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼š

- æ‰©å±•æ–¹æ³•å¿…é¡»åœ¨éåµŒå¥—çš„ã€éæ³›å‹é™æ€ç±»ä¸­å®šä¹‰ï¼›
- æ‰©å±•æ–¹æ³•åŠæ‰©å±•ç±»å¼€å¿…é¡»å£°æ˜ä¸º public staticï¼Œæ‰€ä»¥åªèƒ½ç»™ public çš„ç±»å‹å®šä¹‰æ‰©å±•æ–¹æ³•ï¼›
- æ‰©å±•æ–¹æ³•å‚æ•°åˆ—è¡¨ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æœ‰ *this* å…³é”®å­—ï¼Œè¿˜æœ‰ *using* å¼•å…¥æ‰©å±•å‘½åç©ºé—´ï¼š

```C#
namespace ExtensionMethods
{
    public static class MyExtensions
    {
        public static int WordCount(this String str)
        {
            return str.Split(new char[] { ' ', '.', '?' },
                             StringSplitOptions.RemoveEmptyEntries).Length;
        }
    }
}
```


å¯ä½¿ç”¨æ­¤ WordCount æŒ‡ä»¤å°† using æ‰©å±•æ–¹æ³•ç½®äºèŒƒå›´ä¸­ï¼š

    using ExtensionMethods;

è€Œä¸”ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ä»åº”ç”¨ç¨‹åºä¸­è°ƒç”¨è¯¥æ‰©å±•æ–¹æ³•ï¼š

    string s = "Hello Extension Methods";
    int i = s.WordCount();

å¦ä¸€ä¸ªä¾‹å­ï¼Œè¾“å‡º `ABC -> ####ABC`ï¼Œæ³¨æ„åŸæ¥çš„å­—ç¬¦ä¸² test å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå°½ç®¡ç»™ it èµ‹å€¼äº†ï¼Œä½†æ˜¯åŸå­—ç¬¦ä¸²å˜é‡ä¸ä¼šæ”¹å˜çš„ï¼Œèµ‹å€¼åçš„å­—ç¬¦ä¸²ä¸æ˜¯åŸæ¥çš„ test è€Œæ˜¯å†…å­˜ä¸­çš„å¦ä¸€ä¸ªåœ°å€çš„å­—ç¬¦ä¸²ã€‚

```C#
using System;
using ExtensionsDemo;

public class Demo
{
    public static void Main()
    {
        string test = "ABC";
        string n = test.PaddingLeft('#', 4);
        Console.WriteLine($"{test} -> {n}");
    }
}

namespace ExtensionsDemo
{
    public static class Demo
    {
        public static string PaddingLeft(this string it, char tpl, int len)
        {
            it = new String(tpl, len) + it;
            return it;
        }
    }
}
```


### ===âœ’ Overload Override Hidden


C# ä¸­ä¸‰ä¸ªåŸºç¡€æ¦‚å¿µï¼š

- å­ç±»çš„æ–¹æ³•ä¸åŸºç±»æ–¹æ³•åŒåä¸”åŒæ ·çš„å‚æ•°åˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨ new é™å®šæ˜¾å¼éšè—åŸºç±»æ–¹æ³•ï¼›
- åŸºç±»æ–¹æ³•ä½¿ç”¨ virtual ä¿®é¥°ï¼Œå­ç±»å¯ä»¥é‡å†™ overrideï¼›
- æ–¹æ³•åŒåæ—¶ï¼Œä½†å‚æ•°åˆ—è¡¨æœ‰å·®åˆ«å³æ–¹æ³•çš„é‡è½½ overloadï¼›

åŸºç±» Root æœ‰ä¸¤ä¸ªåŒåçš„ Log æ–¹æ³•ï¼Œä½†æ˜¯å‚æ•°ä¸ä¸€æ ·ï¼Œæ˜¯æ–¹æ³•é‡è½½ Overloadï¼Œæ‰§è¡Œæ—¶æ ¹æ®ä¼ å…¥å‚æ•°è°ƒç”¨ã€‚é‡è½½çš„æ–¹æ³•å¯åˆ†åˆ«å‡ºç°åœ¨åŸºç±»å’Œå­ç±»ä¸Šï¼Œå¹¶ä¸ä¸€å®šåŒåœ¨å­ç±»æˆ–åŸºç±»ä¸Šå®šä¹‰ã€‚æ³¨æ„ï¼Œæ–¹æ³•è¿”å›ç±»å‹å¹¶ä¸åœ¨åˆ†åˆ«æ¡ä»¶ä¸­ã€‚

åŸºç±»å…¶ä¸­ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨äº† virtual å£°æ˜è¡¨ç¤ºåœ¨å­ç±»ä¸­å¯ä»¥è¢«é‡å†™ overrideã€‚

è€ŒåŸºç±»çš„å¦ä¸€ä¸ª Log(string msg) æ–¹æ³•æ²¡æœ‰ virtual ä¿®é¥°ï¼Œè¡¨ç¤ºå®ƒä¸å¯ä»¥è¢«é‡å†™ã€‚ä½†æ˜¯å­ç±»åˆå®šä¹‰äº†ä¸€ä¸ªåŒååŒå‚æ•°çš„æ–¹æ³•ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨éœ€è¦æ˜¾å¼å£°æ˜ä»¥æ˜ç¡®å®ƒçš„æ„ä¹‰ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–°çš„æ–¹æ³•å°±éœ€è¦å‰ç¼€ new å…³é”®å­—ä¿®é¥°ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆå°±å¯èƒ½åå­—é”™äº†ï¼Œç¼–è¯‘å™¨ç»™å‡º CS0108 è­¦å‘Šä¿¡æ¯å°±æ˜¯æé†’ä½œç”¨ã€‚å¿½ç•¥è­¦å‘Šï¼Œè¿è¡Œç¨‹åºç›¸å½“äºç¼–è¯‘å™¨è‡ªè¡Œæ·»åŠ  new å‰ç¼€ä¿®é¥°ã€‚

é‡å†™å’Œéšè—çš„åŒºåˆ«åœ¨äºï¼Œé‡å†™æ˜¯ç”¨å­ç±»çš„æ–¹æ³•æ›¿ä»£åŸºç±»çš„æ–¹æ³•ï¼Œè€Œéšè—æ˜¯åœ¨å­ç±»ä¸­éšè—åŸºç±»çš„æ–¹æ³•ï¼ŒåŸºç±»çš„æ–¹æ³•è¿˜å­˜åœ¨å¯ä»¥é€šè¿‡åŸºç±»è°ƒç”¨ã€‚

ç¤ºä¾‹ä»£ç ï¼šÂ·

```C#
using System;

public class Root
{
    public virtual void Log(int msg)
    {
        Console.WriteLine("  Root Log[integer] {0}", msg);
    }
    public void Log(string msg)
    {
        Console.WriteLine("  Root Log[string] {0}", msg);
    }
}
 
public class Ramous : Root
{
    public override void Log(int msg)
    {
        Console.WriteLine("Ramous Log...");
    }
    public new void Log(string msg)
    {
        Console.WriteLine("Ramous Log[string] {0}", msg);
    }
}

public class Example
{

    public static void Main()
    {
        Ramous ram = new Ramous();
        Root rot = ram;
        ram.Log(1);
        rot.Log(1);
        ram.Log("1");
        rot.Log("1");
    }
}
```

è¾“å‡ºï¼š

    Ramous Log...
    Ramous Log...
    Ramous Log[string] 1
      Root Log[string] 1






## ==âš¡ JSON å¤„ç†
- [.NET JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–](https://docs.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json-overview)

System.Text.Json å‘½åç©ºé—´æä¾›ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ– JavaScript å¯¹è±¡è¡¨ç¤ºæ³• (JSON) çš„åŠŸèƒ½ã€‚è¯¥åº“æ˜¯ä½œä¸º .NET Core 3.0 å…±äº«æ¡†æ¶çš„ä¸€éƒ¨åˆ†å†…ç½®çš„ã€‚

    using System;
    using System.Linq;
    using System.Text.Json;
    using System.Text.Json.Serialization;
    using System.Collections.Generic;

    public class FlagsEnumExample
    {
        public static void Main()
        {

            // JObject staff = new JObject();
            //         staff.Add(new JProperty("Name", "Newtonsoft.Json"));
            //         staff.Add(new JProperty("Age", 33));
            //         staff.Add(new JProperty("Department", "Personnel Department"));
            //         staff.Add(new JProperty("Leader", new JObject(new JProperty("Name", "Tom"), new JProperty("Age", 44), new JProperty("Department", "Personnel Department"))));
            //         Console.WriteLine(staff.ToString());

            // int[,] msg = new int[2,3]{{1, 2, 3},{4, 5, 6}}; // Rectangular Array Is Not Supported
            // int[][] msg = new int[][]{new int[]{1, 2, 3}, new int[]{4, 5, 6}}; // Array OK
            // var msg = (a: "xyz", b: new int[3]{1, 2, 3} ); // to be {}
            // (String a, int[] b) msg = ("XYZ", new int[]{1, 2, 3}); // this named tuple to be {}
            // var msg = new ValueTuple<String, int[]>("XYZ", new int[]{1, 2, 3}); // to be {}
            // var msg = new Tuple<String, int[], Tuple<String, int>>("XYZ", new int[]{1, 2, 3}, Tuple.Create("ABC", 123)); // OK! {"Item1": "XYZ"...}
            var msg = new { a = "XYZ", b = new int[]{1, 2, 3}, c = new {s = "ABC", k = 123} }; // anonymous type OK! {"a": "XYZ"...}
            
            byte[] jsonUtf8Bytes;
            var options = new JsonSerializerOptions
            {
                WriteIndented = true
            };

            jsonUtf8Bytes = JsonSerializer.SerializeToUtf8Bytes(msg, options);
            Console.WriteLine(System.Text.Encoding.UTF8.GetString(jsonUtf8Bytes));


            var utf8Reader = new Utf8JsonReader(jsonUtf8Bytes);
            var myjson = JsonSerializer.Deserialize<MyJSON>(ref utf8Reader);
            // Console.WriteLine("{0}, {1}, {2}.", myjson.a, myjson.b, myjson.c);
            Console.WriteLine($"{myjson.a}, {myjson.b}, {myjson.c.s}.");
        }

        public class MyJSON
        {
            public string a { get; set; }
            public int[] b { get; set; }
            public inner c { get; set; }

            public class inner
            {
                public string s { get; set; }
                public int k { get; set; }
            }
        }
        
    }



åº“è¿˜æä¾›äº†ç”¨äºå¤„ç†å†…å­˜ä¸­æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM) çš„ç±»ã€‚ æ­¤åŠŸèƒ½å…è®¸å¯¹ JSON æ–‡ä»¶æˆ–å­—ç¬¦ä¸²ä¸­çš„å…ƒç´ è¿›è¡Œéšæœºåªè¯»è®¿é—®ã€‚

åº“çš„è®¾è®¡å¼ºè°ƒå¯¹å¹¿æ³›çš„åŠŸèƒ½é›†å®ç°é«˜æ€§èƒ½å’Œä½å†…å­˜åˆ†é…ã€‚ å†…ç½®çš„ UTF-8 æ”¯æŒå¯ä¼˜åŒ–è¯»å†™ä»¥ UTF-8 ç¼–ç çš„ JSON æ–‡æœ¬çš„è¿‡ç¨‹ï¼ŒUTF-8 ç¼–ç æ˜¯é’ˆå¯¹ Web ä¸Šçš„æ•°æ®å’Œç£ç›˜ä¸Šçš„æ–‡ä»¶çš„æœ€æ™®éçš„ç¼–ç æ–¹å¼ã€‚

Newtonsoft.Json å¯ä»¥è¿ç§»åˆ° System.Text.Jsonã€‚å¦‚æœä¹‹å‰é¡¹ç›®ä½¿ç”¨çš„æ˜¯ Newtonsoft.Json, å‡çº§å»ºè®®ç»§ç»­ä½¿ç”¨ Newtonsoft.Json, å¦‚æœæ˜¯æ–°é¡¹ç›®æˆ–è€…æƒ³å°‘ä¸ªä¸‰æ–¹ä¾èµ–, å¯ä»¥è¯•è¯• System.Text.Json, æ¯•ç«Ÿæ›´è½»é‡æ€§èƒ½æ›´å¥½ã€‚ä¸ JTokenï¼ˆå¦‚ JObjectã€JArrayï¼‰ç›¸æ¯”çš„ JsonDocument å’Œ JsonElement

System.Text.Json å‘½åç©ºé—´åŒ…å«æ‰€æœ‰å…¥å£ç‚¹å’Œä¸»è¦ç±»å‹ã€‚ System.Text.Json.Serialization å‘½åç©ºé—´åŒ…å«ç”¨äºé«˜çº§æ–¹æ¡ˆçš„ç‰¹æ€§å’Œ APIï¼Œä»¥åŠç‰¹å®šäºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è‡ªå®šä¹‰ã€‚

System.Text.Json.JsonDocument æä¾›ä»ç°æœ‰ JSON æœ‰æ•ˆè´Ÿè½½åˆ†æå’Œç”Ÿæˆåªè¯» æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM) çš„åŠŸèƒ½ã€‚ DOM æä¾›å¯¹ JSON æœ‰æ•ˆè´Ÿè½½ä¸­çš„æ•°æ®çš„éšæœºè®¿é—®ã€‚ å¯ä»¥é€šè¿‡ JsonElement ç±»å‹è®¿é—®æ„æˆæœ‰æ•ˆè´Ÿè½½çš„ JSON å…ƒç´ ã€‚ JsonElement ç±»å‹æä¾›ç”¨äºå°† JSON æ–‡æœ¬è½¬æ¢ä¸ºå¸¸è§ .NET ç±»å‹çš„ APIã€‚ JsonDocument å…¬å¼€äº† RootElement å±æ€§ã€‚

å¤§å¤šæ•°åºåˆ—åŒ–ç¤ºä¾‹ä»£ç å°† JsonSerializerOptions.WriteIndented è®¾ç½®ä¸º trueï¼Œä»¥ JSON è¿›è¡Œä¼˜è´¨æ‰“å°ï¼ˆåŒ…å«ç¼©è¿›å’Œç©ºæ ¼ï¼Œä»¥æé«˜å¯è¯»æ€§ï¼‰ã€‚ å¯¹äºç”Ÿäº§ç”¨é€”ï¼Œé€šå¸¸å¯¹äºæ­¤è®¾ç½®ä¼šæ¥å—é»˜è®¤å€¼ falseã€‚

Utf8JsonReaderã€Utf8JsonWriter å’Œ JsonDocument

System.Text.Json.Utf8JsonReader æ˜¯é¢å‘ UTF-8 ç¼–ç  JSON æ–‡æœ¬çš„ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½åˆ†é…çš„åªè¿›è¯»å–å™¨ï¼Œä» ReadOnlySpan<byte> æˆ– ReadOnlySequence<byte> è¯»å–ä¿¡æ¯ã€‚ Utf8JsonReader æ˜¯ä¸€ç§ä½çº§ç±»å‹ï¼Œå¯ç”¨äºç”Ÿæˆè‡ªå®šä¹‰åˆ†æå™¨å’Œååºåˆ—åŒ–ç¨‹åºã€‚ JsonSerializer.Deserialize æ–¹æ³•åœ¨åå°ä½¿ç”¨ Utf8JsonReaderã€‚

System.Text.Json.Utf8JsonWriter æ˜¯ä¸€ç§é«˜æ€§èƒ½æ–¹å¼ï¼Œä»å¸¸è§ .NET ç±»å‹ï¼ˆä¾‹å¦‚ï¼ŒStringã€Int32 å’Œ DateTimeï¼‰ç¼–å†™ UTF-8 ç¼–ç çš„ JSON æ–‡æœ¬ã€‚ è¯¥ç¼–å†™å™¨æ˜¯ä¸€ç§ä½çº§ç±»å‹ï¼Œå¯ç”¨äºç”Ÿæˆè‡ªå®šä¹‰åºåˆ—åŒ–ç¨‹åºã€‚ JsonSerializer.Serialize æ–¹æ³•åœ¨åå°ä½¿ç”¨ Utf8JsonWriterã€‚

System.Text.Json.JsonDocument æä¾›ä½¿ç”¨ Utf8JsonReader ç”Ÿæˆåªè¯»æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM) çš„åŠŸèƒ½ã€‚ DOM æä¾›å¯¹ JSON æœ‰æ•ˆè´Ÿè½½ä¸­çš„æ•°æ®çš„éšæœºè®¿é—®ã€‚ å¯ä»¥é€šè¿‡ JsonElement ç±»å‹è®¿é—®æ„æˆæœ‰æ•ˆè´Ÿè½½çš„ JSON å…ƒç´ ã€‚ JsonElement ç±»å‹æä¾›æ•°ç»„å’Œå¯¹è±¡æšä¸¾å™¨ï¼Œä»¥åŠç”¨äºå°† JSON æ–‡æœ¬è½¬æ¢ä¸ºå¸¸è§ .NET ç±»å‹çš„ APIã€‚ JsonDocument å…¬å¼€äº† RootElement å±æ€§ã€‚


ååºåˆ—åŒ–ï¼Œè¯»å…¥ JSONï¼š

    jsonString = File.ReadAllText(fileName);
    usertype = JsonSerializer.Deserialize<UserType>(jsonString);

è‹¥è¦ä½¿ç”¨å¼‚æ­¥ä»£ç ä»æ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–ï¼Œè¯·è°ƒç”¨ DeserializeAsync æ–¹æ³•ï¼š

    using (FileStream fs = File.OpenRead(fileName))
    {
        usertype = await JsonSerializer.DeserializeAsync<UserType>(fs);
    }

è‹¥è¦ä» UTF-8 è¿›è¡Œååºåˆ—åŒ–ï¼Œè¯·è°ƒç”¨é‡‡ç”¨ Utf8JsonReader æˆ– ReadOnlySpan<byte> çš„ JsonSerializer.Deserialize é‡è½½ï¼Œå¦‚ä¸‹é¢çš„ç¤ºä¾‹ä¸­æ‰€ç¤ºã€‚ è¿™äº›ç¤ºä¾‹å‡è®¾ JSON å¤„äºåä¸º jsonUtf8Bytes çš„å­—èŠ‚æ•°ç»„ä¸­ã€‚

    var readOnlySpan = new ReadOnlySpan<byte>(jsonUtf8Bytes);
    usertype = JsonSerializer.Deserialize<UserType>(readOnlySpan);

    var utf8Reader = new Utf8JsonReader(jsonUtf8Bytes);
    usertype = JsonSerializer.Deserialize<UserType>(ref utf8Reader);


JsonDocument å¤„ç† JSON æ•°æ®ï¼š

    double sum = 0;
    int count = 0;

    using (JsonDocument document = JsonDocument.Parse(jsonString))
    {
        JsonElement root = document.RootElement;
        JsonElement studentsElement = root.GetProperty("Students");
        foreach (JsonElement student in studentsElement.EnumerateArray())
        {
            if (student.TryGetProperty("Grade", out JsonElement gradeElement))
            {
                sum += gradeElement.GetDouble();
            }
            else
            {
                sum += 70;
            }
            count++;
        }
    }

    double average = sum / count;
    Console.WriteLine($"Average grade : {average}");

é€šè¿‡ JsonDocument å†™å…¥ JSONï¼š

    string jsonString = File.ReadAllText(inputFileName);

    var writerOptions = new JsonWriterOptions
    {
        Indented = true
    };

    var documentOptions = new JsonDocumentOptions
    {
        CommentHandling = JsonCommentHandling.Skip
    };

    using FileStream fs = File.Create(outputFileName);
    using var writer = new Utf8JsonWriter(fs, options: writerOptions);
    using JsonDocument document = JsonDocument.Parse(jsonString, documentOptions);

    JsonElement root = document.RootElement;

    if (root.ValueKind == JsonValueKind.Object)
    {
        writer.WriteStartObject();
    }
    else
    {
        return;
    }

    foreach (JsonProperty property in root.EnumerateObject())
    {
        property.WriteTo(writer);
    }

    writer.WriteEndObject();

    writer.Flush();

å‰é¢çš„ä»£ç ï¼š
è¯»å– JSON æ–‡ä»¶ï¼Œå°†æ•°æ®åŠ è½½åˆ° JsonDocument ä¸­ï¼Œå¹¶å°†æ ¼å¼åŒ–ï¼ˆè¿›è¡Œäº†ä¼˜è´¨æ‰“å°çš„ï¼‰JSON å†™å…¥æ–‡ä»¶ã€‚
ä½¿ç”¨ JsonDocumentOptions å¯æŒ‡å®šå…è®¸ä½†ä¼šå¿½ç•¥è¾“å…¥ JSON ä¸­çš„æ³¨é‡Šã€‚
å®Œæˆåï¼Œå¯¹ç¼–å†™å™¨è°ƒç”¨ Flushã€‚ ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯è®©ç¼–å†™å™¨åœ¨é‡Šæ”¾æ—¶è‡ªåŠ¨åˆ·æ–°

JSON æ•°æ®ï¼š

    {
      "Class Name": "Science",
      "Teacher\u0027s Name": "Jane",
      "Semester": "2019-01-01",
      "Students": [
        {
          "Name": "John",
          "Grade": 94.3
        },
        {
          "Name": "James",
          "Grade": 81.0
        },
        {
          "Name": "Julia",
          "Grade": 91.9
        },
        {
          "Name": "Jessica",
          "Grade": 72.4
        },
        {
          "Name": "Johnathan"
        }
      ],
      "Final": true
    }


## ==âš¡ Lambda è¡¨è¾¾å¼

lambda è¡¨è¾¾å¼å¯ä»¥ç†è§£ä¸ºå†…åµŒåŒ¿åå‡½æ•°ï¼Œlambda è¿ç®—ç¬¦ => å°†å·¦ä¾§çš„è¾“å…¥å‚æ•°ä¸å³ä¾§çš„ lambda ä¸»ä½“åˆ†å¼€ã€‚

=> ä»¤ç‰Œæ”¯æŒä¸¤ç§å½¢å¼ï¼šä½œä¸º lambda è¿ç®—ç¬¦ã€ä½œä¸ºæˆå‘˜åç§°çš„åˆ†éš”ç¬¦å’Œè¡¨è¾¾å¼ä¸»ä½“å®šä¹‰ä¸­çš„æˆå‘˜å®ç°ã€‚


    var list = new [] { "aa", "bb", "ac" };
    var result = Array.FindAll(list, s => (s.IndexOf("a") > -1));
    foreach (var v in result)
    Console.WriteLine(v);

ä½¿ç”¨ Lambda è¡¨è¾¾å¼å®šä¹‰åŒ¿åå‡½æ•°ï¼š

    class Program
    {
        static void Main(string[] args)
        {
            var names = GetFullName();
            Console.WriteLine($"{names.First} {names.Middle} {names.Last}");
        }

        static (string First, string Middle, string Last) GetFullName() => ("Alen", "Bob", "Robin");
    }

ä»¥ä¸ŠåŒ¿åå‡½æ•°ç¼–è¯‘åå¾—åˆ°çš„ç»“æœä¼šæ·»åŠ  TupleElementNamesAttribute ä½œä¸ºå…ƒç»„æˆå‘˜çš„åç§°æ˜ å°„ï¼Œæœ¬è´¨ä¾ç„¶æ˜¯å€ŸåŠ©æ³›å‹ç±»å‹æ¥å®ç°çš„ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ç¼–è¯‘å™¨å¯¹æ–°è¯­æ³•å½¢å¼çš„æ”¯æŒã€‚

    [TupleElementNames(new string[]
    {
            "First",
            "Middle",
            "Last"
    })]
    private static ValueTuple<string, string, string> GetFullName()
    {
        return new ValueTuple<string, string, string>("Alen", "Bob", "Robin");
    }



## ==âš¡ LINQ è¯­è¨€é›†æˆæŸ¥è¯¢
- [æŸ¥è¯¢è¡¨è¾¾å¼åŸºç¡€](https://docs.microsoft.com/zh-cn/dotnet/csharp/linq/query-expression-basics)
- [è¯­è¨€é›†æˆæŸ¥è¯¢ LINQ](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/linq/)
- [æŸ¥è¯¢å…³é”®å­—](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/query-keywords)
- [System.Linq å‘½åç©ºé—´](https://docs.microsoft.com/zh-cn/dotnet/api/system.linq)
- [`IEnumerable<T>`](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.ienumerable-1)
- [`IQueryable<T>`](https://docs.microsoft.com/en-us/dotnet/api/system.linq.iqueryable-1)
- [`IGrouping<TKey,TElement>`](https://docs.microsoft.com/en-us/dotnet/api/system.linq.igrouping-2)

è¯­è¨€é›†æˆæŸ¥è¯¢ LINQ - Language Integrated Query æ˜¯ä¸€ç³»åˆ—æŸ¥è¯¢åŠŸèƒ½é›†æˆåˆ° C# è¯­è¨€çš„æŠ€æœ¯ç»Ÿç§°ã€‚ä»æŠ€æœ¯è§’åº¦è€Œè¨€ï¼ŒLINQ å®šä¹‰äº†å¤§çº¦ 40 ä¸ªæŸ¥è¯¢æ“ä½œç¬¦ï¼Œå¦‚ select/from/in/where/order by ç­‰ï¼Œä½¿ç”¨è¿™äº›æ“ä½œç¬¦å¯ä»¥ç¼–å†™æŸ¥è¯¢è¯­å¥ã€‚ç†Ÿæ‚‰ SQL æ•°æ®æŸ¥è¯¢è¯­è¨€å°±æ›´å®¹æ˜“ç†è§£ä»€ä¹ˆæ˜¯ LINQï¼Œä¸è¿‡ï¼Œè¿™äº›æŸ¥è¯¢è¿˜å¯ä»¥åŸºäºå¾ˆå¤šç±»å‹çš„æ•°æ®ï¼Œæ¯ä¸ªæ•°æ®ç±»å‹éƒ½éœ€è¦ä¸€ä¸ªå•ç‹¬çš„ LINQ ç±»å‹ã€‚

åŒ¿åç±»å‹ Anonymous type æ˜¯ C# 3.0 æ–°å¢çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ä¸å…·ç±»å‹çš„æ–¹å¼åˆ›å»ºæ–°çš„æ•°æ®ç»“æ„ï¼Œè€ŒçœŸæ­£çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶æœŸï¼Œç”± C# Compiler è‡ªåŠ¨äº§ç”Ÿï¼Œå¹¶å†™å…¥ç¼–è¯‘ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œå®ƒå¯ä»¥è®©å¼€å‘äººå‘˜èƒ½å¤Ÿå¾ˆç®€å•åˆ©ç”¨åŒ¿åç±»å‹åˆ›å»ºå¯¹è±¡ï¼ŒLINQ ä¸­çš„ select æŒ‡ä»¤å³æ˜¯åˆ©ç”¨è¿™ç§ç‰¹æ€§æ¥åˆ›å»ºå›ä¼ å¯¹è±¡ã€‚

æ•°æ®æŸ¥è¯¢å†æ¥éƒ½è¡¨ç¤ºä¸ºç®€å•çš„å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥æˆ– IntelliSense æ”¯æŒã€‚ æ­¤å¤–ï¼Œéœ€è¦é’ˆå¯¹æ¯ç§ç±»å‹çš„æ•°æ®æºäº†è§£ä¸åŒçš„æŸ¥è¯¢è¯­è¨€ï¼šSQL æ•°æ®åº“ã€XML æ–‡æ¡£ã€å„ç§ Web æœåŠ¡ç­‰ã€‚ å€ŸåŠ© LINQï¼ŒæŸ¥è¯¢æˆä¸ºäº†æœ€é«˜çº§çš„è¯­è¨€æ„é€ ï¼Œå°±åƒç±»ã€æ–¹æ³•å’Œäº‹ä»¶ä¸€æ ·ã€‚ å¯ä»¥ä½¿ç”¨è¯­è¨€å…³é”®å­—å’Œç†Ÿæ‚‰çš„è¿ç®—ç¬¦é’ˆå¯¹å¼ºç±»å‹åŒ–å¯¹è±¡é›†åˆç¼–å†™æŸ¥è¯¢ã€‚ LINQ ç³»åˆ—æŠ€æœ¯æä¾›äº†é’ˆå¯¹å¯¹è±¡ (LINQ to Objects)ã€å…³ç³»æ•°æ®åº“ (LINQ to SQL) å’Œ XML (LINQ to XML) çš„ä¸€è‡´æŸ¥è¯¢ä½“éªŒã€‚

æŸ¥è¯¢ æ˜¯ä¸€ç»„æŒ‡ä»¤ï¼Œæè¿°è¦ä»ç»™å®šæ•°æ®æºï¼ˆæˆ–æºï¼‰æ£€ç´¢çš„æ•°æ®ä»¥åŠè¿”å›çš„æ•°æ®åº”å…·æœ‰çš„å½¢çŠ¶å’Œç»„ç»‡ã€‚ æŸ¥è¯¢ä¸å®ƒç”Ÿæˆçš„ç»“æœä¸åŒã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæºæ•°æ®æŒ‰é€»è¾‘æ–¹å¼ç»„ç»‡ä¸ºç›¸åŒç±»å‹çš„å…ƒç´ çš„åºåˆ—ã€‚ ä¾‹å¦‚ï¼ŒSQL æ•°æ®åº“è¡¨åŒ…å«è¡Œçš„åºåˆ—ã€‚ åœ¨ XML æ–‡ä»¶ä¸­ï¼Œå­˜åœ¨ XML å…ƒç´ çš„â€œåºåˆ—â€ï¼ˆå°½ç®¡è¿™äº›å…ƒç´ åœ¨æ ‘ç»“æ„æŒ‰å±‚æ¬¡ç»“æ„è¿›è¡Œç»„ç»‡ï¼‰ã€‚ å†…å­˜ä¸­é›†åˆåŒ…å«å¯¹è±¡çš„åºåˆ—ã€‚


å¯¹äºç¼–å†™æŸ¥è¯¢çš„å¼€å‘è€…æ¥è¯´ï¼ŒLINQ æœ€æ˜æ˜¾çš„â€œè¯­è¨€é›†æˆâ€éƒ¨åˆ†å°±æ˜¯æŸ¥è¯¢è¡¨è¾¾å¼ã€‚ æŸ¥è¯¢è¡¨è¾¾å¼é‡‡ç”¨å£°æ˜æ€§æŸ¥è¯¢è¯­æ³•ç¼–å†™è€Œæˆã€‚ ä½¿ç”¨æŸ¥è¯¢è¯­æ³•ï¼Œå¯ä»¥ç”¨æœ€å°‘çš„ä»£ç å¯¹æ•°æ®æºæ‰§è¡Œç­›é€‰ã€æ’åºå’Œåˆ†ç»„æ“ä½œã€‚ å¯ä½¿ç”¨ç›¸åŒçš„åŸºæœ¬æŸ¥è¯¢è¡¨è¾¾å¼æ¨¡å¼æ¥æŸ¥è¯¢å’Œè½¬æ¢ SQL æ•°æ®åº“ã€ADO .NET æ•°æ®é›†ã€XML æ–‡æ¡£å’Œæµä»¥åŠ .NET é›†åˆä¸­çš„æ•°æ®ã€‚

åœ¨ C# ä¸­å¯ä¸ºä»¥ä¸‹å¯¹è±¡ç¼–å†™ LINQ æŸ¥è¯¢ï¼šSQL Server æ•°æ®åº“ã€XML æ–‡æ¡£ã€ADO.NET æ•°æ®é›†ä»¥åŠæ”¯æŒ IEnumerable æˆ–æ³›å‹ IEnumerable<T> æ¥å£çš„ä»»ä½•å¯¹è±¡é›†åˆã€‚ æ­¤å¤–ï¼Œç¬¬ä¸‰æ–¹ä¹Ÿä¸ºè®¸å¤š Web æœåŠ¡å’Œå…¶ä»–æ•°æ®åº“å®ç°æä¾›äº† LINQ æ”¯æŒã€‚

foreach å¯ä»¥æšä¸¾çš„æ•°æ®éƒ½å¯ä»¥ä½¿ç”¨ Linq å¤„ç†ï¼Œ IEnumerable or IEnumerable<T>ï¼Œè¿˜æœ‰å­ç±»å¦‚ IQueryable<T> ã€‚ 

æ‰€æœ‰ LINQ æŸ¥è¯¢æ“ä½œéƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªä¸åŒçš„æ“ä½œç»„æˆï¼Œå®ƒä»¬å’Œ IEnumerable or IEnumerable<T> æä¾›çš„æˆå‘˜æ–¹æ³•åŸºæœ¬å¯¹åº”ï¼š

- è·å–æ•°æ®æºï¼Œä½¿ç”¨ from æˆ–è€…ç›´æ¥ selectã€‚
- åˆ›å»ºæŸ¥è¯¢ï¼Œä½¿ç”¨ where/join/group/orderby ç­‰ï¼Œå¹¶ä»¥ select æˆ– group ç»“æŸã€‚
- æ‰§è¡ŒæŸ¥è¯¢ï¼Œä½¿ç”¨ ToArray()/ToList() ç­‰ã€‚


Linq å¯ä»¥ä½¿ç”¨çš„æŸ¥è¯¢å…³é”®å­—åˆ—è¡¨ï¼š

| Clause    | Description |
| :-------- | :---------- |
| from  | æŒ‡å®šæ•°æ®æºï¼Œæˆ–å˜é‡åŒºé—´ |
| where | è¿‡æ»¤æ¡ä»¶ï¼Œä½¿ç”¨é€»è¾‘è¿ç®— AND and OR( && or || ) è¿”å› Boolean çš„è¡¨è¾¾å¼ |
| select    | æŸ¥è¯¢è¢«æ‰§è¡Œæ—¶ï¼Œé€‰æ‹©è¦è¾“å‡ºçš„æ•°æ® |
| group | æ ¹æ® by æŒ‡å®šçš„ Key è¿›è¡Œåˆ†ç»„ |
| into  | ä¸º join, group æˆ–è€… select ä»å¥æä¾›ä¸€ä¸ªæ ‡è¯†ç¬¦å·ä»¥ä¾›å¼•ç”¨æ•°æ® |
| orderby   | å¯ä»¥ä½¿ç”¨ orderby å¯¹åˆ†æ•°æ®è¿›è¡Œæ’åº ascending æˆ–è€… descending æŒ‡å®šå‡æˆ–é™åº|
| join  | æ ¹æ® on æŒ‡å®šçš„æ¡ä»¶å¯¹ä¸¤ä¸ªæ•°æ®æºè¿›è¡Œè”åˆæ“ä½œ |
| let   | æŒ‡å®šå˜é‡åŒºé—´ä»¥å­˜å‚¨æŸ¥è¯¢å­è¡¨è¾¾å¼çš„ç»“æœ |
| in    | Contextual keyword in a join clause. |
| on    | Contextual keyword in a join clause. |
| equals    | Contextual keyword in a join clause. |
| by    | Contextual keyword in a group clause. |
| ascending | Contextual keyword in an orderby clause. |
| descending    | Contextual keyword in an orderby clause. |


ä»¥ä¸‹æ˜¯ Linq éœ€è¦çš„ä¸‰ä¸ªåŸºæœ¬ç±»ç©ºé—´ï¼Œä¸»è¦æ˜¯ System.Linqï¼Œå…¶å®ƒä¸¤ä¸ªæä¾›åŸºæœ¬çš„æ•°æ®ç±»å‹å®šä¹‰ï¼š

    using System;
    using System.Collections;
    using System.Linq;

å¼ºåˆ¶ç«‹å³æ‰§è¡Œï¼ŒCountã€Maxã€Average å’Œ First å°±å±äºæ­¤ç±»æŸ¥è¯¢ã€‚å¯¹ä¸€ç³»åˆ—æºå…ƒç´ æ‰§è¡Œèšåˆå‡½æ•°çš„æŸ¥è¯¢å¿…é¡»é¦–å…ˆå¾ªç¯è®¿é—®è¿™äº›å…ƒç´ ã€‚  ç”±äºæŸ¥è¯¢æœ¬èº«å¿…é¡»ä½¿ç”¨ foreach ä»¥ä¾¿è¿”å›ç»“æœï¼Œå› æ­¤è¿™äº›æŸ¥è¯¢åœ¨æ‰§è¡Œæ—¶ä¸ä½¿ç”¨æ˜¾å¼ foreach è¯­å¥ã€‚ å¦å¤–è¿˜è¦æ³¨æ„ï¼Œè¿™äº›ç±»å‹çš„æŸ¥è¯¢è¿”å›å•ä¸ªå€¼ï¼Œè€Œä¸æ˜¯ IEnumerable é›†åˆã€‚ 

    int[] numbers = {1,2,3,4,5}; // Enumerable.Range(1, 5)
    Console.WriteLine("Average {0}", numbers.Average());

ä¸ºäº†ç†è§£å‘½åç©ºé—´å¼•å…¥ C# æ‰©å±•æ–¹æ³•çš„ä½œç”¨ï¼Œå¯ä»¥å…ˆå°† System.Linq æ³¨è§£ï¼Œç¼–è¯‘å°±ä¼šå‘ç°ï¼Œnumbers æ•°æ®æ ¹æœ¬æ²¡æœ‰ Select æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ˜¯ System.Linq æ‰©å±•æ•°ç»„å¾—æ¥çš„æ–¹æ³•ï¼Œåªæœ‰å¼•å…¥å‘½åç©ºé—´åæ‰å¯ä»¥ä½¿ç”¨ï¼š

    using System;
    using System.Linq;

    class Example
    {
        public static void Main()
        {
            int[] numbers = new int[]{2, 2, 3, 4, 5};
            var a = numbers.Select( i => new string('*', i));
            Console.WriteLine(string.Join(",",a));
        }
    }

ä¸‹é¢çš„æŸ¥è¯¢è¿”å›æºæ•°ç»„ä¸­å¶æ•°çš„è®¡æ•°ï¼š

    var evenNumQuery =
        from num in numbers
        where (num % 2) == 0
        select num;

    int evenNumCount = evenNumQuery.Count();

è¦å¼ºåˆ¶ç«‹å³æ‰§è¡Œä»»ä½•æŸ¥è¯¢å¹¶ç¼“å­˜å…¶ç»“æœï¼Œå¯è°ƒç”¨ ToList æˆ– ToArray æ–¹æ³•ã€‚

    List<int> numQuery2 =
        (from num in numbers
         where (num % 2) == 0
         select num).ToList();

    // or like this:
    // numQuery3 is still an int[]

    var numQuery3 =
        (from num in numbers
         where (num % 2) == 0
         select num).ToArray();

ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†å®Œæ•´çš„æŸ¥è¯¢æ“ä½œã€‚ å®Œæ•´çš„æ“ä½œåŒ…æ‹¬åˆ›å»ºæ•°æ®æºã€å®šä¹‰æŸ¥è¯¢è¡¨è¾¾å¼å’Œåœ¨ foreach è¯­å¥ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚

    // Specify the data source
    // int[] numbers = { 5, 4, 1, 3, 9, 8, 6, 7, 2, 0 };
    int[] scores = new int[] { 97, 92, 81, 60 };

    // Define the query expression.
    IEnumerable<int> scoreQuery =
        from score in scores
        where score > 80
        select score;

    // Execute the query.
    // Output: 97 92 81
    foreach (int i in scoreQuery)
    {
        Console.Write(i + " ");
    }

ç»“åˆäº† Lambda è¡¨è¾¾å¼çš„ Linq å­—ç¬¦ä¸²å¤„ç†ï¼š

    string[] words = { "bot", "apple", "apricot" };
    int minimalLength = words
      .Where(w => w.StartsWith("a"))
      .Min(w => w.Length);
    Console.WriteLine(minimalLength);   // output: 5

    int[] numbers = { 1, 4, 7, 10 };
    int product = numbers.Aggregate(1, (interim, next) => interim * next);
    Console.WriteLine(product);   // output: 280

åˆ†å‰²å­—ç¬¦ä¸²çš„ Linq å¤„ç†æ–¹å¼ï¼š

    Console.WriteLine("Linq data".Select((char i)=>{
        Console.WriteLine(i);
        return i;
    }).ToList());

ä½¿ç”¨ let å…³é”®å­—ä¿å­˜å­æŸ¥è¯¢çš„ä¸´æ—¶æ•°æ®ï¼Œä¾‹å­æŸ¥æ‰¾ä»¥æ— éŸ³å­—æ¯å¼€å¤´çš„å•è¯ï¼Œå…¶ä¸­ `let words` ä¿å­˜äº†åˆ†å‰²å¥½çš„å­—ç¬¦ä¸²ï¼š

    string[] strings =
    {
        "A penny saved is a penny earned.",
        "The early bird catches the worm.",
        "The pen is mightier than the sword."
    };

    // Split the sentence into an array of words
    // and select those whose first letter is a vowel.
    var earlyBirdQuery =
        from sentence in strings
        let words = sentence.Split(' ')
        from word in words
        let w = word.ToLower()
        where (new char[]{'a', 'e', 'i', 'o', 'u'}).Contains(w[0])
        select word;

    // Execute the query.
    foreach (var v in earlyBirdQuery)
    {
        Console.WriteLine("\"{0}\" starts with a vowel", v);
    }

ä¸¤ç§ä¸åŒçš„é£æ ¼ï¼ŒLinq é£æ ¼ï¼Œå’Œ IEnumerable<TSource> æ–¹æ³•è°ƒç”¨é£æ ¼ï¼š

    using System;
    using System.Linq;

    namespace demo
    {
        public class LinqStyle
        {
            public static void Main()
            {
                // Linq Style
                Func<int, bool> IsEven = delegate (int i){ return i%2==0; };
                var q = from num in "Enumerable.Range(1, 5)" where IsEven(num) select (int)num;
                Console.WriteLine("Average {0}", q.Average());

                // IEnumerable<TSource> Method Style
                string assembly = typeof(LinqStyle).Assembly.ToString();
                int count = assembly.Select(
                    (char i)=>{
                        Console.Write("{0} -> ", i);
                        return (int)i;
                    }
                ).Count(
                    (int i)=>{
                        bool filter = i == 'i';
                        if (filter)
                        {
                            Console.WriteLine("Filtered {0} {1}", i, filter);
                        }
                        return filter;
                    }
                );
                Console.WriteLine("Count {0}", count);
            }
        }
    }

### ===âœ’ Linq & Join è”åˆæŸ¥è¯¢

éåŒç­‰è”æ¥é€šè¿‡ä½¿ç”¨å¤šä¸ª from å­å¥å°†æ–°åºåˆ—å•ç‹¬å¼•å…¥æŸ¥è¯¢ï¼Œå¯ä»¥æ‰§è¡ŒéåŒç­‰è”æ¥ã€äº¤å‰è”æ¥å’Œå…¶ä»–è‡ªå®šä¹‰è”æ¥æ“ä½œã€‚

Cross Join äº¤å‰è”æ¥ï¼ŒNon-Equijoin éç­‰å€¼è¿æ¥ç¤ºä¾‹ï¼š

    char[] upperCase = { 'A', 'B', 'C' };
    char[] lowerCase = { 'x', 'y', 'z' };

    // The type of joinQuery1 is IEnumerable<'a>, where 'a
    // indicates an anonymous type with {char upper, char lower}.
    var joinQuery1 =
        from upper in upperCase
        from lower in lowerCase
        select new { upper, lower };

    // The type of joinQuery2 is IEnumerable<'a>, where 'a
    // indicates an anonymous type with {char lower, char upper}.
    var joinQuery2 =
        from lower in lowerCase
        where lower != 'x'
        from upper in upperCase
        select new { lower, upper };

    // Execute the queries.
    Console.WriteLine("Cross join:");
    foreach (var pair in joinQuery1)
    {
        Console.WriteLine("{0} is matched to {1}", pair.upper, pair.lower);
    }

    Console.WriteLine("Filtered non-equijoin:");
    foreach (var pair in joinQuery2)
    {
        Console.WriteLine("{0} is matched to {1}", pair.lower, pair.upper);
    }

    // Keep the console window open in debug mode.
    Console.WriteLine("Press any key to exit.");
    try{
        Console.ReadKey();
    } catch { }

join å­å¥æ‰§è¡Œçš„æ‰€æœ‰è”æ¥éƒ½æ˜¯åŒç­‰è”æ¥ï¼Œå°† 2 ä¸ªæºåºåˆ—ä½œä¸ºè¾“å…¥ã€‚ æ¯ä¸ªåºåˆ—ä¸­çš„å…ƒç´ éƒ½å¿…é¡»æ˜¯å¯ä»¥ä¸å…¶ä»–åºåˆ—ä¸­çš„ç›¸åº”å±æ€§è¿›è¡Œ equals æ¯”è¾ƒçš„å±æ€§ï¼Œæˆ–è€…åŒ…å«ä¸€ä¸ªè¿™æ ·çš„å±æ€§ã€‚join å­å¥æ‰§è¡ŒåŒç­‰è”æ¥ï¼Œæ¢è¨€ä¹‹ï¼Œåªèƒ½åŸºäº 2 ä¸ªé¡¹ä¹‹é—´çš„ç›¸ç­‰å…³ç³»è¿›è¡ŒåŒ¹é…ã€‚ ä¸æ”¯æŒå…¶ä»–ç±»å‹çš„æ¯”è¾ƒï¼Œä¾‹å¦‚å¤§äºæˆ–ä¸ç­‰äºã€‚ ä¸ºäº†è¡¨æ˜æ‰€æœ‰è”æ¥éƒ½æ˜¯åŒç­‰è”æ¥ï¼Œjoin å­å¥ä½¿ç”¨ equals å…³é”®å­—è€Œä¸æ˜¯ == è¿ç®—ç¬¦ã€‚ equals å…³é”®å­—åªèƒ½åœ¨ join å­å¥ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”å…¶ä¸ == è¿ç®—ç¬¦ä¹‹é—´å­˜åœ¨ä¸€ä¸ªé‡è¦å·®åˆ«ã€‚ å¯¹äº equalsï¼Œå·¦é”®ä½¿ç”¨å¤–éƒ¨æºåºåˆ—ï¼Œè€Œå³é”®ä½¿ç”¨å†…éƒ¨æºåºåˆ—ã€‚ å¤–éƒ¨æºä»…åœ¨ equals çš„å·¦ä¾§ä½äºèŒƒå›´å†…ï¼Œè€Œå†…éƒ¨æºåºåˆ—ä»…åœ¨å…¶å³ä¾§ä½äºèŒƒå›´å†…ã€‚

join å­å¥çš„è¾“å‡ºå½¢å¼å–å†³äºæ‰§è¡Œçš„è”æ¥çš„å…·ä½“ç±»å‹ï¼Œä»¥ä¸‹æ˜¯ 3 ç§æœ€å¸¸è§çš„è”æ¥ç±»å‹ï¼š

- Inner join å†…éƒ¨è”æ¥

    ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªç®€å•çš„å†…éƒ¨åŒç­‰è”æ¥ã€‚ æ­¤æŸ¥è¯¢ä» categories/products ä¸¤ä¸ªæ•°æ®æºç”Ÿæˆä¸€ä¸ªäº§å“åç§°/ç±»åˆ«å¯¹å¹³é¢åºåˆ—ã€‚ åŒä¸€ç±»åˆ«å­—ç¬¦ä¸²å°†å‡ºç°åœ¨å¤šä¸ªå…ƒç´ ä¸­ï¼Œå³ categories ä¸­çš„ç±»åˆ«å¯å¯èƒ½å¯¹åº”å¤šè¡¨äº§å“ï¼Œé‚£ä¹ˆè”æ¥åçš„å¹³é¢åºåˆ—ä¸­è¿™äº›äº§å“éƒ½åŒ…å«åˆ†ç±»ä¿¡æ¯ã€‚ å¦‚æœ categories ä¸­çš„æŸä¸ªå…ƒç´ æ²¡æœ‰åŒ¹é…çš„ productsï¼Œåˆ™è¯¥ç±»åˆ«ä¸ä¼šå‡ºç°åœ¨ç»“æœä¸­ã€‚

        var innerJoinQuery =
            from category in categories
            join prod in products on category.ID equals prod.CategoryID
            select new { ProductName = prod.Name, Category = category.Name }; // produces flat sequence

- Group join åˆ†ç»„è”æ¥

    å«æœ‰ into è¡¨è¾¾å¼çš„ join å­å¥ç§°ä¸ºåˆ†ç»„è”æ¥ã€‚

    åˆ†ç»„è”æ¥ä¼šç”Ÿæˆåˆ†å±‚çš„ç»“æœåºåˆ—ï¼Œè¯¥åºåˆ—å°†å·¦ä¾§æºåºåˆ—ä¸­çš„å…ƒç´ ä¸å³ä¾§æºåºåˆ—ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…å…ƒç´ ç›¸å…³è”ã€‚ åˆ†ç»„è”æ¥æ²¡æœ‰ç­‰æ•ˆçš„å…³ç³»æœ¯è¯­ï¼›å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„åºåˆ—ã€‚

        var innerGroupJoinQuery =
            from category in categories
            join prod in products on category.ID equals prod.CategoryID into prodGroup
            select new { CategoryName = category.Name, Products = prodGroup };


- Left outer join å·¦å¤–éƒ¨è¿æ¥

    åœ¨å·¦å¤–éƒ¨è”æ¥ä¸­ï¼Œå°†è¿”å›å·¦ä¾§æºåºåˆ—ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå³ä½¿å³ä¾§åºåˆ—ä¸­æ²¡æœ‰å…¶åŒ¹é…å…ƒç´ ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ è‹¥è¦åœ¨ LINQ ä¸­æ‰§è¡Œå·¦å¤–éƒ¨è”æ¥ï¼Œè¯·ç»“åˆä½¿ç”¨ `DefaultIfEmpty` æ–¹æ³•ä¸åˆ†ç»„è”æ¥ï¼ŒæŒ‡å®šè¦åœ¨æŸä¸ªå·¦ä¾§å…ƒç´ ä¸å…·æœ‰åŒ¹é…å…ƒç´ æ—¶ç”Ÿæˆçš„é»˜è®¤å³ä¾§å…ƒç´ ã€‚ å¯ä»¥ä½¿ç”¨ null ä½œä¸ºä»»ä½•å¼•ç”¨ç±»å‹çš„é»˜è®¤å€¼ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç”¨æˆ·å®šä¹‰çš„é»˜è®¤ç±»å‹ã€‚

    ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†ç”¨æˆ·å®šä¹‰çš„é»˜è®¤ç±»å‹ï¼š

        var leftOuterJoinQuery =
            from category in categories
            join prod in products on category.ID equals prod.CategoryID into prodGroup
            from item in prodGroup.DefaultIfEmpty(new Product { Name = String.Empty, CategoryID = 0 })
            select new { CatName = category.Name, ProdName = item.Name };

`DefaultIfEmpty` çš„ä½¿ç”¨ä¸»è¦æ˜¯ä¸ºäº†é¿å…ç©ºå¼•ç”¨å¼•èµ·ç¨‹åºå¼‚å¸¸ï¼Œå‘æŸ¥è¯¢å¡«å……ä¸€ä¸ªé»˜è®¤çš„æ•°æ®å¯¹è±¡ï¼Œä¿è¯æŸ¥è¯¢ä¸ºç©ºæ—¶è¿”å›è¿™ä¸ªé»˜è®¤æ•°æ®å¯¹è±¡ï¼Œçœ‹ä»¥ä¸‹ä¾‹ç¨‹æ¼”ç¤ºã€‚

    class Pet
    {
        public string Name { get; set; }
        public int Age { get; set; }
    }


    // Create a list of Pet objects.
    List<Pet> pets =
        new List<Pet>{ new Pet { Name="Barley", Age=8 },
                       new Pet { Name="Boots", Age=4 },
                       new Pet { Name="Whiskers", Age=1 } };

    // This query selects only those pets that are 10 or older.
    // In case there are no pets that meet that criteria, call
    // DefaultIfEmpty(). This code passes an (optional) default
    // value to DefaultIfEmpty().
    string[] oldPets =
        pets.AsQueryable()
        .Where(pet => pet.Age >= 10)
        .Select(pet => pet.Name)
        .DefaultIfEmpty("[EMPTY]")
        .ToArray();

    Console.WriteLine("First query: " + oldPets[0]);

    // This query selects only those pets that are 10 or older.
    // This code does not call DefaultIfEmpty().
    string[] oldPets2 =
        pets.AsQueryable()
        .Where(pet => pet.Age >= 10)
        .Select(pet => pet.Name)
        .ToArray();

    try
    {
        Console.WriteLine("Second query: " + oldPets2[0]);
    }
    catch (Exception e)
    {
        Console.WriteLine("Second query: An exception was thrown: " + e.Message);
    }

å„ç§è”åˆæ“ä½œçš„ç¤ºä¾‹ï¼š

    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.Linq;

    class CompoundFrom
    {
        public class Student
        {
            public int ID { get; set; }
            public string LastName { get; set; }
            public List<int> Scores {get; set; }
        }

        public class ContactInfo
        {
            public int ID { get; set; }
            public string Email { get; set; }
            public string Phone {get; set; }
        }

        private static List<Student> students = new List<Student>
        {
            new Student {ID=111, LastName="Omelchenko", Scores= new List<int> {97, 72, 81, 60}},
            new Student {ID=112, LastName="O'Donnell", Scores= new List<int> {75, 84, 91, 39}},
            new Student {ID=113, LastName="Mortensen", Scores= new List<int> {88, 94, 65, 85}},
            new Student {ID=114, LastName="Garcia", Scores= new List<int> {97, 89, 85, 82}},
            new Student {ID=115, LastName="Beebe", Scores= new List<int> {35, 72, 91, 70}}
        };

        private static List<ContactInfo> contacts = new List<ContactInfo>()
        {
            new ContactInfo {ID=111, Email="SvetlanO@Contoso.com", Phone="206-555-0108"},
            new ContactInfo {ID=112, Email="ClaireO@Contoso.com", Phone="206-555-0298"},
            new ContactInfo {ID=113, Email="SvenMort@Contoso.com", Phone="206-555-1130"},
            new ContactInfo {ID=115, Email="BeeHive@Contoso.com", Phone="206-555-0521"},
            new ContactInfo {ID=115, Email="BeeHive@gmail.com", Phone="206-555-0522"}
        };

        static void Main()
        {
            ScoreQuery("Score Query");
            DataSample("Data Sample Query");
            InnerJoin("Inner Join Query");
            GroupJoin("Group Join Query");
            LeftOuterJoin("Left Outer Join Query");
            Group("Group Query");

            // Keep the console window open in debug mode.
            Console.WriteLine("Press any key to exit.");
            try{
                Console.ReadKey();
            } catch {} // InvalidOperationException
        }

        public static void ScoreQuery(string title)
        {
            var scoreQuery = from student in students
                             from score in student.Scores
                                where score > 90
                                select new { Last = student.LastName, score };

            SetTitle(title);
            // Execute the queries.
            foreach (var student in scoreQuery)
            {
                Console.WriteLine("{0} Score: {1}", student.Last, student.score);
            }
            Console.Write(System.Environment.NewLine);
        }

        public static void DataSample(string title)
        {
            var query = from an in students
                        let score = string.Join(", ", an.Scores)
                        select string.Format("{0,8} {1,12} {2}", an.ID, an.LastName, score);

            var query2 = from an in contacts
                        select string.Format("{0,8} {1,24} {2}", an.ID, an.Email, an.Phone);

            SetTitle(title);
            Console.WriteLine("Students Table as left:");
            Console.WriteLine("{0,8} {1,12} {2}", "ID", "Name", "Scores");
            query.Select((string i) => { Console.WriteLine(i); return i;} ).ToList();
            Console.WriteLine("Contacts Table as right:");
            Console.WriteLine("{0,8} {1,24} {2}", "ID", "Email", "Phone");
            query2.Select((string i) => { Console.WriteLine(i); return i;} ).ToList();

            Console.Write(System.Environment.NewLine);

        }

        public static void InnerJoin(string title)
        {
            var innerJoinQuery =
                from student in students
                join item in contacts on student.ID equals item.ID
                select new { ID = student.ID, Name = student.LastName, Email = item.Email, Phone = item.Phone };

            SetTitle(title);
            foreach (var an in innerJoinQuery)
            {
                Console.WriteLine("{0,8} {1,10}: {2,24} {3,16}", an.ID, an.Name, an.Email, an.Phone);
            }
            Console.Write(System.Environment.NewLine);
        }

        public static void GroupJoin(string title)
        {
            var groupJoinQuery =
                from student in students
                join item in contacts on student.ID equals item.ID into items
                
                // Items is an IEnumerable<IGrouping<int, ContactInfo>>
                // select items;

                // produces flat sequence
                // select new { Name = student.LastName, Items = items };

                // with custom
                select new {
                    Name = student.LastName, 
                    // Items = items,
                    Items = from it in items
                            orderby it.Email ascending
                            select it
                };

            SetTitle(title);
            foreach (var an in groupJoinQuery)
            {
                // Console.WriteLine("Group Count: {0}", an.Count());
                // foreach (var item in an)
                // {
                //  Console.WriteLine(" {0}: {1,24} {2,16}", item.ID, item.Email, item.Phone);
                // }

                // var count = an.Items.Count();
                // var email = string.Join(", ", an.Items.Select( i => i.Email ));
                // // var email = count>0? an.Items.First().Email:null;
                // var many = count==1? "has an":count==0?"has no any":"has many";
                // Console.WriteLine("{0,10} {2,10} Email {1}", an.Name, email, many);
                
                Console.WriteLine("Items Count: {0}", an.Items.Count());
                foreach (var item in an.Items)
                {
                    Console.WriteLine("{0,8}: {1,24} {2,16}", item.ID, item.Email, item.Phone);
                }
            }
            Console.Write(System.Environment.NewLine);
        }

        public static void LeftOuterJoin(string title)
        {
            var leftOuterJoinQuery =
                from student in students
                join item in contacts on student.ID equals item.ID into g

                // with DefaultIfEmpty<TSource>(IEnumerable<TSource>)
                // Query variable is an IEnumerable<IGrouping<int, ContactInfo>>
                // select g.DefaultIfEmpty(new ContactInfo { Email = String.Empty,  ID = student.ID });
                // select g.DefaultIfEmpty(); // null as default

                // produces flat sequence
                // Query variable is an IEnumerable<AnonymousType>
                from item in g.DefaultIfEmpty()
                orderby student.LastName ascending // descending
                select new { ID = student.ID, Name = student.LastName, Email = item?.Email, Phone = item?.Phone };

            SetTitle(title);
            foreach (var an in leftOuterJoinQuery)
            {
                // Console.WriteLine("Group Count: {0}", an.Count());
                // foreach (var item in an)
                // {
                //  Console.WriteLine(" Contact for {0}: {1,24} {2,16}", item.ID, item.Email, item.Phone);
                // }

                // display data from flat sequence
                Console.WriteLine("Contact for {0} {1,10}: {2,24} {3,16}", an.ID, an.Name, an.Email, an.Phone);
            }
            Console.Write(System.Environment.NewLine);
        }

        public static void Group(string title)
        {
            // Group students by the first letter of their last name
            // Query variable is an IEnumerable<IGrouping<char, Student>>
            var groupedQuery =
                from student in students
                group student by student.LastName[0] into g
                orderby g.Key ascending // descending
                select g;

            SetTitle(title);
            foreach (IGrouping<char, Student> g in groupedQuery)
            {
                foreach (var student in g)
                {
                    Console.WriteLine("{0,10} group by {1}", student.LastName, g.Key);
                }
            }
            Console.Write(System.Environment.NewLine);
        }

        static void SetTitle(string title)
        {
            Console.BackgroundColor = ConsoleColor.DarkBlue;
            Console.WriteLine(title);
            Console.ResetColor();
        }
    }

è¾“å‡ºï¼š

    Score Query
    Omelchenko Score: 97
    O'Donnell Score: 91
    Mortensen Score: 94
    Garcia Score: 97
    Beebe Score: 91

    Data Sample Query
    Students Table as left:
          ID         Name Scores
     111   Omelchenko 97, 72, 81, 60
     112    O'Donnell 75, 84, 91, 39
     113    Mortensen 88, 94, 65, 85
     114       Garcia 97, 89, 85, 82
     115        Beebe 35, 72, 91, 70
    Contacts Table as right:
          ID                    Email Phone
     111     SvetlanO@Contoso.com 206-555-0108
     112      ClaireO@Contoso.com 206-555-0298
     113     SvenMort@Contoso.com 206-555-1130
     115      BeeHive@Contoso.com 206-555-0521
     115        BeeHive@gmail.com 206-555-0522

    Inner Join Query
         111 Omelchenko:    SvetlanO@Contoso.com     206-555-0108
         112  O'Donnell:     ClaireO@Contoso.com     206-555-0298
         113  Mortensen:    SvenMort@Contoso.com     206-555-1130
         115      Beebe:     BeeHive@Contoso.com     206-555-0521
         115      Beebe:       BeeHive@gmail.com     206-555-0522

    Group Join Query
    Items Count: 1
         111:    SvetlanO@Contoso.com     206-555-0108
    Items Count: 1
         112:     ClaireO@Contoso.com     206-555-0298
    Items Count: 1
         113:    SvenMort@Contoso.com     206-555-1130
    Items Count: 0
    Items Count: 2
         115:     BeeHive@Contoso.com     206-555-0521
         115:       BeeHive@gmail.com     206-555-0522

    Left Outer Join Query
    Contact for 115      Beebe:     BeeHive@Contoso.com     206-555-0521
    Contact for 115      Beebe:       BeeHive@gmail.com     206-555-0522
    Contact for 114     Garcia:                                         
    Contact for 113  Mortensen:    SvenMort@Contoso.com     206-555-1130
    Contact for 112  O'Donnell:     ClaireO@Contoso.com     206-555-0298
    Contact for 111 Omelchenko:    SvetlanO@Contoso.com     206-555-0108

    Group Query
         Beebe group by B
        Garcia group by G
     Mortensen group by M
    Omelchenko group by O
     O'Donnell group by O






# =ğŸš© Concurrency Programming
- ã€ŠC++ Concurrency in Actionã€‹

å¹¶å‘ã€å¹¶è¡Œï¼Œä¸å¼‚æ­¥æ˜¯å®¹æ˜“æ··æ·†çš„æ¦‚å¿µã€‚

å¼‚æ­¥ä¸åŒæ­¥æ˜¯å¯¹ç«‹æ¦‚å¿µï¼Œå¼‚æ­¥è¯´çš„æ˜¯ä¸€äº›æ—¶é—´æ¶ˆè€—åœ¨çš„åœºæ™¯ä¸­ï¼Œè®©éœ€è¦ç­‰å¾…çš„ä»£ç è¿›å…¥æš‚åœçŠ¶æ€ï¼Œç­‰å¾…ä¸­æ–­ä¿¡å·æ¥å”¤é†’ã€‚åŒæ—¶ç»§ç»­æ‰§è¡Œåç»­çš„ä»£ç ï¼Œè€ŒåŒæ­¥åˆ™ä¸ä¼šè¿™æ ·ï¼ŒåŒæ­¥ä¼šä¸€èµ·ç­‰å¾…æ—¶é—´æ¶ˆè€—å¤§çš„ä»»åŠ¡å®Œæˆè¿”å›åæ‰ç»§ç»­æ‰§è¡Œã€‚

å¼‚æ­¥ï¼Œåœ¨å•çº¿ç¨‹ä¸Šå°±å¯ä»¥å®ç°ï¼Œè€Œå¹¶è¡Œåˆ™éœ€è¦å¤šçº¿ç¨‹ï¼Œå³åœ¨å¤šæ ¸èŠ¯ CPU ä¸Šæ‰æœ‰æ•ˆåŠ›ã€‚è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œå†…å­˜æˆ–ç¡¬ä»¶èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹åˆ™æ˜¯æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç¨‹åºæ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚

ä¸€ä¸ªæ¯”å–»ï¼š

- ä½ åƒé¥­åƒåˆ°ä¸€åŠï¼Œç”µè¯æ¥äº†ï¼Œä½ ä¸€ç›´åˆ°åƒå®Œäº†ä»¥åæ‰å»æ¥ï¼Œè¿™å°±è¯´æ˜ä½ ä¸æ”¯æŒå¹¶å‘ä¹Ÿä¸æ”¯æŒå¹¶è¡Œã€‚
- ä½ åƒé¥­åƒåˆ°ä¸€åŠï¼Œç”µè¯æ¥äº†ï¼Œä½ åœäº†ä¸‹æ¥æ¥äº†ç”µè¯ï¼Œæ¥å®Œåç»§ç»­åƒé¥­ï¼Œè¿™è¯´æ˜ä½ æ”¯æŒå¹¶å‘ã€‚
- ä½ åƒé¥­åƒåˆ°ä¸€åŠï¼Œç”µè¯æ¥äº†ï¼Œä½ ä¸€è¾¹æ‰“ç”µè¯ä¸€è¾¹åƒé¥­ï¼Œè¿™è¯´æ˜ä½ æ”¯æŒå¹¶è¡Œã€‚

å¹¶å‘çš„å…³é”®æ˜¯ä½ æœ‰å¤„ç†å¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›ï¼Œä¸ä¸€å®šè¦åŒæ—¶ã€‚å¹¶è¡Œçš„å…³é”®æ˜¯ä½ æœ‰åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›ã€‚æ‰€ä»¥æˆ‘è®¤ä¸ºå®ƒä»¬æœ€å…³é”®çš„ç‚¹å°±æ˜¯ï¼šæ˜¯å¦æ˜¯ã€åŒæ—¶ã€ã€‚

Erlang ä¹‹çˆ¶ Joe Armstrong ç”¨ä¸€å¼  5 å²å°å­©éƒ½èƒ½çœ‹æ‡‚çš„å›¾è§£é‡Šäº†å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«ï¼š

![](https://pic4.zhimg.com/80/v2-674f0d37fca4fac1bd2df28a2b78e633_1440w.jpg?source=1940ef5c)

- å¹¶å‘æ˜¯ä¸¤ä¸ªé˜Ÿåˆ—äº¤æ›¿ä½¿ç”¨ä¸€å°å’–å•¡æœºï¼›
- å¹¶è¡Œæ˜¯ä¸¤ä¸ªé˜Ÿåˆ—åŒæ—¶ä½¿ç”¨ä¸¤å°å’–å•¡æœºï¼›
- å¦‚æœä¸²è¡Œï¼Œä¸€ä¸ªé˜Ÿåˆ—ä½¿ç”¨ä¸€å°å’–å•¡æœºï¼›

åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå‰é¢é‚£ä¸ªäººä¾¿ç§˜äº†å»å•æ‰€å‘†åŠå¤©ï¼Œåé¢çš„äººä¹Ÿåªèƒ½æ­»ç­‰ç€ä»–å›æ¥æ‰èƒ½å»æ¥å’–å•¡ï¼Œç›¸å½“äºåŒæ­¥æ‰§è¡Œã€‚

æœ‰è¯„è®ºé‡Œè¯´ï¼Œå¹¶å‘æ˜¯ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œæ˜¯å¤šä¸ªçº¿ç¨‹ï¼Ÿ

ç­”ï¼šå¹¶å‘å’Œå¹¶è¡Œéƒ½å¯ä»¥æ˜¯å¾ˆå¤šä¸ªçº¿ç¨‹ï¼Œå°±çœ‹è¿™äº›çº¿ç¨‹èƒ½ä¸èƒ½åŒæ—¶è¢«ï¼ˆå¤šä¸ªï¼‰CPU æ‰§è¡Œï¼Œå¦‚æœå¯ä»¥å°±è¯´æ˜æ˜¯å¹¶è¡Œï¼Œè€Œå¹¶å‘æ˜¯å¤šä¸ªçº¿ç¨‹è¢«ï¼ˆä¸€ä¸ªï¼‰CPU è½®æµåˆ‡æ¢ç€æ‰§è¡Œã€‚

å†æ‰“ä¸ªæ¯”æ–¹ï¼Œä½ è¦ç»™ä¸¤ä¸ªå­©å­åŒæ—¶å–‚å¥¶ï¼š

- ç”¨ä¸€ä¸ªå¥¶ç»™ä¸¤ä¸ªå­©å­è½®æµå–‚ï¼Œè¿™å«å¹¶å‘ã€‚
- ç”¨ä¸¤ä¸ªå¥¶åˆ†åˆ«ç»™ä¸¤ä¸ªå­©å­å–‚ï¼Œè¿™å«å¹¶è¡Œã€‚



## ==âš¡ Parallel Programming
- [åŸºäºå¼‚æ­¥ä»»åŠ¡å¹¶è¡Œç¼–ç¨‹](https://docs.microsoft.com/zh-cn/dotnet/standard/parallel-programming/task-based-asynchronous-programming)


## ==âš¡ async & await å¼‚æ­¥ç¼–ç¨‹
- [async & await å¼‚æ­¥ç¼–ç¨‹](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/async/)
- [await è¿ç®—ç¬¦](https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/operators/await)
- [.NET ä¸­çš„å¹¶è¡Œå¤„ç†ã€å¹¶å‘å’Œå¼‚æ­¥ç¼–ç¨‹](https://docs.microsoft.com/zh-cn/dotnet/standard/parallel-processing-and-concurrency)
- https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/async-streams

C# 5.0 å¯¹å¼‚æ­¥ç¼–ç¨‹è¿›è¡Œäº†ä¸€æ¬¡é©å‘½æ€§çš„é‡æ„ï¼Œå¼•å…¥äº† async å’Œ await è¿™ä¸¤ä¸ªå…³é”®å­—ï¼Œä½¿å¾—å¼€å‘äººå‘˜åœ¨ä¸éœ€è¦æ·±åˆ»äº†è§£å¼‚æ­¥ç¼–ç¨‹çš„åº•å±‚åŸç†ï¼Œå°±å¯ä»¥å†™å‡ºååˆ†ä¼˜ç¾è€Œåˆä»£ç é‡æå°‘çš„ä»£ç ã€‚æ­¤æ–¹æ³•åˆ©ç”¨äº† .NET Framework 4.5 åŠæ›´é«˜ç‰ˆæœ¬ã€.NET Core å’Œ Windows è¿è¡Œæ—¶ä¸­çš„å¼‚æ­¥æ”¯æŒã€‚ å¦‚æœä½¿ç”¨å¾—å½“ï¼Œä½ å¯ä»¥å†™å‡ºå…·æœ‰å¹¶è¡ŒåŒ–å¹¶ä¸”æ€§èƒ½è¾ƒé«˜çš„ç¨‹åºï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå¢åŠ äº†å¯¹å¼‚æ­¥ç¼–ç¨‹ç†è§£çš„å¤æ‚åº¦ï¼Œæ¯•ç«Ÿåœ¨C#5.0é‡Œï¼Œä½ å·²ç»çœ‹ä¸åˆ°å¼‚æ­¥ç¼–ç¨‹å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„äº†ï¼Œéœ€è¦èŠ±è´¹é¢å¤–çš„ç»å†å»ç ”ç©¶æ¢ç´¢ã€‚

ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹ï¼Œä½¿å¾—æˆ‘ä»¬é‡Šæ”¾äº†å¯åŠ¨å®ƒçš„çº¿ç¨‹ï¼Œä¹Ÿä½¿å¾—èµ„æºçš„å æœ‰é‡ä¸‹é™ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæœ‰äº›ç‰¹æ®Šçº¿ç¨‹ï¼Œæ¯”å¦‚ UI çº¿ç¨‹ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™åªèƒ½å¯åŠ¨ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰å¿«é€Ÿå“åº”ï¼Œé¡µé¢å°†ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚

æ–°å‹åº”ç”¨å¹¿æ³›ä½¿ç”¨æ–‡ä»¶å’Œç½‘ç»œ I/Oã€‚ é»˜è®¤æƒ…å†µä¸‹ I/O API ä¸€èˆ¬ä¼šé˜»å¡ï¼Œå¯¼è‡´ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒå’Œç¡¬ä»¶åˆ©ç”¨ç‡ï¼Œé™¤éå¸Œæœ›å­¦ä¹ å’Œä½¿ç”¨å¯Œæœ‰æŒ‘æˆ˜çš„æ¨¡å¼ã€‚ åŸºäºä»»åŠ¡çš„å¼‚æ­¥ API å’Œè¯­è¨€çº§å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹æ”¹å˜äº†è¿™ç§æ¨¡å‹ï¼Œåªéœ€äº†è§£å‡ ä¸ªæ–°æ¦‚å¿µå°±å¯é»˜è®¤è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

å¼‚æ­¥ä»£ç å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ç­‰å¾… I/O è¯·æ±‚è¿”å›çš„åŒæ—¶ï¼Œå¯é€šè¿‡ç”Ÿæˆå¤„ç†æ›´å¤šè¯·æ±‚çš„çº¿ç¨‹ï¼Œå¤„ç†æ›´å¤šçš„æœåŠ¡å™¨è¯·æ±‚ã€‚
- ç­‰å¾… I/O è¯·æ±‚çš„åŒæ—¶ç”Ÿæˆ UI äº¤äº’çº¿ç¨‹ï¼Œå¹¶é€šè¿‡å°†é•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œè½¬æ¢åˆ°å…¶ä»– CPU æ ¸å¿ƒï¼Œè®© UI çš„å“åº”é€Ÿåº¦æ›´å¿«ã€‚
- è®¸å¤šè¾ƒæ–°çš„ .NET APIs éƒ½æ˜¯å¼‚æ­¥çš„ã€‚
- åœ¨ .NET ä¸­ç¼–å†™å¼‚æ­¥ä»£ç å¾ˆç®€å•ï¼


ç°å®ä¸­çš„ä¾‹å­ï¼Œæ—©ä¸Šèµ·æ¥æ‰‹ä¸Šè¦åšä¸‰ä»¶äº‹ï¼Œä¾æ¬¡å†²å’–å•¡ï¼Œç…è›‹ï¼Œçƒ¤è‚‰ï¼Œæ¯ä»¶äº‹éƒ½è¦æ¶ˆè€—èµ„æºå ç”¨æ—¶é—´ï¼š

```C#
using System;
using System.Linq;
using System.Threading.Tasks;

using Coffee = System.String;
using Bacon = System.String;
using Egg = System.String;

namespace AsyncBreakfast
{
    class Program
    {
        static void Main(string[] args)
        {
            Coffee cup = PourCoffee();
            Console.WriteLine("coffee is ready");

            Egg eggs = FryEggs(2);
            Console.WriteLine("eggs are ready");

            Bacon bacon = FryBacon(3);
            Console.WriteLine("bacon is ready");
        }

        private static Bacon FryBacon(int slices)
        {
            Console.WriteLine($"putting {slices} slices of bacon in the pan");
            Console.WriteLine("cooking first side of bacon...");
            Task.Delay(3000).Wait();
            for (int slice = 0; slice < slices; slice++)
            {
                Console.WriteLine("flipping a slice of bacon");
            }
            Console.WriteLine("cooking the second side of bacon...");
            Task.Delay(3000).Wait();
            Console.WriteLine("Put bacon on plate");

            return ("Good Bacon");
        }

        private static Egg FryEggs(int howMany)
        {
            Console.WriteLine("Warming the egg pan...");
            Task.Delay(3000).Wait();
            Console.WriteLine($"cracking {howMany} eggs");
            Console.WriteLine("cooking the eggs ...");
            Task.Delay(3000).Wait();
            Console.WriteLine("Put eggs on plate");

            return ("Fine Egg");
        }

        private static Coffee PourCoffee()
        {
            Console.WriteLine("Pouring coffee");
            return ("Smelly coffee");
        }

    }
}
```


æœ‰ç»éªŒçš„ä½ å¯èƒ½ä¼šå…ˆå¼€å§‹åŠ çƒ­å¹³åº•é”…ä»¥å¤‡ç…è›‹ï¼Œæ¥ç€æ‰‹å†åˆ‡è‚‰ã€‚ ä½ å¯å°†é¢åŒ…æ”¾è¿›çƒ¤é¢åŒ…æœºï¼Œç„¶åå†ç…é¸¡è›‹ã€‚åœ¨æ­¤è¿‡ç¨‹çš„æ¯ä¸€æ­¥ï¼Œä½ éƒ½å¯ä»¥å…ˆå¼€å§‹ä¸€é¡¹ä»»åŠ¡ï¼Œå°†æœ¬æ¥ç”¨äºç­‰å¾…çš„æ—¶é—´ï¼Œè½¬ç§»åˆ°å‡†å¤‡å…¶ä»–ä»»åŠ¡ä¸Šã€‚

åšæ—©é¤æ˜¯éå¹¶è¡Œå¼‚æ­¥å·¥ä½œçš„ä¸€ä¸ªå¥½ç¤ºä¾‹ï¼Œå•äººï¼ˆæˆ–å•çº¿ç¨‹ï¼‰å³å¯å¤„ç†æ‰€æœ‰è¿™äº›ä»»åŠ¡ã€‚ ä¸€ä¸ªäººå¯ä»¥ä»¥å¼‚æ­¥æ–¹å¼åšæ—©é¤ï¼Œå³åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡å®Œæˆä¹‹å‰å¼€å§‹è¿›è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ ä¸ç®¡æ˜¯å¦æœ‰äººåœ¨çœ‹ç€ï¼Œåšæ—©é¤çš„è¿‡ç¨‹éƒ½åœ¨è¿›è¡Œã€‚ å¯¹äºå¹¶è¡Œç®—æ³•è€Œè¨€ï¼Œä½ åˆ™éœ€è¦å¤šåå¨å¸ˆï¼ˆæˆ–çº¿ç¨‹ï¼‰ã€‚ ä¸€åå¨å¸ˆç…é¸¡è›‹ï¼Œä¸€åå¨å¸ˆç…åŸ¹æ ¹ï¼Œä¾æ¬¡ç±»æ¨ã€‚ æ¯åå¨å¸ˆå°†ä»…ä¸“æ³¨äºä¸€é¡¹ä»»åŠ¡ã€‚ æ¯åå¨å¸ˆï¼ˆæˆ–çº¿ç¨‹ï¼‰éƒ½åœ¨åŒæ­¥ç­‰å¾…éœ€è¦ç¿»åŠ¨åŸ¹æ ¹æˆ–é¢åŒ…å¼¹å‡ºæ—¶éƒ½å°†å—åˆ°é˜»ã€‚

è®¡ç®—æœºä¸ä¼šæŒ‰äººç±»çš„æ–¹å¼æ¥è§£é‡Šè¿™äº›æŒ‡ä»¤ï¼Œè®¡ç®—æœºå°†é˜»å¡æ¯æ¡è¯­å¥ï¼Œç›´åˆ°å·¥ä½œå®Œæˆï¼Œç„¶åå†ç»§ç»­è¿è¡Œä¸‹ä¸€æ¡è¯­å¥ã€‚ åç»­ä»»åŠ¡ç›´åˆ°æ—©å‰ä»»åŠ¡å®Œæˆåæ‰ä¼šå¯åŠ¨ï¼Œè¿™æ ·åšæ—©é¤èŠ±è´¹çš„æ—¶é—´è¦é•¿å¾—å¤šï¼Œæœ‰äº›é£Ÿç‰©åœ¨ä¸Šæ¡Œä¹‹å‰å°±å·²ç»å‡‰äº†ã€‚

å¦‚æœä½ å¸Œæœ›è®¡ç®—æœºå¼‚æ­¥æ‰§è¡Œä¸Šè¿°æŒ‡ä»¤ï¼Œåˆ™å¿…é¡»ç¼–å†™å¼‚æ­¥ä»£ç ã€‚
è¿™äº›é—®é¢˜å¯¹å³å°†ç¼–å†™çš„ç¨‹åºè€Œè¨€è‡³å…³é‡è¦ã€‚ ç¼–å†™å®¢æˆ·ç«¯ç¨‹åºæ—¶ï¼Œä½ å¸Œæœ› UI èƒ½å¤Ÿå“åº”ç”¨æˆ·è¾“å…¥ã€‚ ä» Web ä¸‹è½½æ•°æ®æ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¸åº”è®©æ‰‹æœºå‡ºç°å¡é¡¿ã€‚ ç¼–å†™æœåŠ¡å™¨ç¨‹åºæ—¶ï¼Œä½ ä¸å¸Œæœ›çº¿ç¨‹å—åˆ°é˜»å¡ï¼Œ è¿™äº›çº¿ç¨‹å¯ä»¥ç”¨äºå¤„ç†å…¶ä»–è¯·æ±‚ã€‚ 

æˆåŠŸçš„ç°ä»£åº”ç”¨ç¨‹åºéœ€è¦å¼‚æ­¥ä»£ç ï¼Œä½¿ç”¨å¼‚æ­¥çš„æ–¹æ¡ˆå°±æ˜¯èŠ‚çœç­‰å¾…æ—¶é—´ã€‚ä¸è¦é˜»å¡ï¼Œè€Œè¦ await æ¥è®¾ç½®å›è°ƒè·³è¿‡è¦ç­‰å¾…çš„äº‹ä»¶ã€‚ åŒæ­¥ä»£ç ï¼Œé¡¾åæ€ä¹‰ï¼Œæ­¤ä»£ç å°†é˜»æ­¢æ‰§è¡Œè¿™æ®µä»£ç çš„çº¿ç¨‹æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œã€‚ åœ¨ä»»ä½•ä»»åŠ¡è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œæ­¤ä»£ç ä¹Ÿä¸ä¼šè¢«ä¸­æ–­ã€‚ å°±å¦‚åŒä½ å°†é¢åŒ…æ”¾è¿›çƒ¤é¢åŒ…æœºåç›¯ç€æ­¤çƒ¤é¢åŒ…æœºä¸€æ ·ã€‚ ä½ ä¼šæ— è§†ä»»ä½•è·Ÿä½ è¯´è¯çš„äººï¼Œç›´åˆ°é¢åŒ…å¼¹å‡ºã€‚

åœ¨å¼‚æ­¥æ–¹æ¡ˆä¸­ï¼Œåº”è¯¥ç«‹å³å¯åŠ¨è‹¥å¹²ç‹¬ç«‹çš„ä»»åŠ¡ã€‚ ç„¶åï¼Œåœ¨æ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œä½ å¯ä»¥ç»§ç»­è¿›è¡Œå·²å‡†å¤‡çš„å…¶ä»–å·¥ä½œã€‚ åœ¨æ—©é¤ç±»æ¯”ä¸­ï¼Œè¿™å°±æ˜¯æ›´å¿«å®Œæˆåšæ—©é¤çš„æ–¹æ³•ã€‚ ä½ ä¹Ÿå‡ ä¹å°†åœ¨åŒä¸€æ—¶é—´å®Œæˆæ‰€æœ‰å·¥ä½œã€‚ ä½ å°†åƒåˆ°ä¸€é¡¿çƒ­æ°”è…¾è…¾çš„æ—©é¤ã€‚

System.Threading.Tasks.Task å’Œç›¸å…³ç±»å‹æ˜¯å¯ä»¥ç”¨äºæ¨æ–­æ­£åœ¨è¿›è¡Œä¸­çš„ä»»åŠ¡çš„ç±»ã€‚ è¿™ä½¿ä½ èƒ½å¤Ÿç¼–å†™æ›´ç±»ä¼¼äºå®é™…åšæ—©é¤æ–¹å¼çš„ä»£ç ã€‚ ä½ å¯ä»¥åŒæ—¶å¼€å§‹ç…é¸¡è›‹ã€åŸ¹æ ¹å’Œçƒ¤é¢åŒ…ã€‚ ç”±äºæ¯ä¸ªä»»åŠ¡éƒ½éœ€è¦æ“ä½œï¼Œæ‰€ä»¥ä½ ä¼šå°†æ³¨æ„åŠ›è½¬ç§»åˆ°é‚£ä¸ªä»»åŠ¡ä¸Šï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ“ä½œï¼Œç„¶åç­‰å¾…å…¶ä»–éœ€è¦ä½ æ³¨æ„çš„äº‹æƒ…ã€‚
å¯åŠ¨ä¸€é¡¹ä»»åŠ¡å¹¶ç­‰å¾…è¡¨ç¤ºè¿è¡Œçš„ Task å¯¹è±¡ã€‚ ä½ å°†é¦–å…ˆ await æ¯é¡¹ä»»åŠ¡ï¼Œç„¶åå†å¤„ç†å®ƒçš„ç»“æœã€‚
è®©æˆ‘ä»¬å¯¹æ—©é¤ä»£ç è¿›è¡Œè¿™äº›æ›´æ”¹ã€‚ 

ç¬¬ä¸€æ­¥æ˜¯å­˜å‚¨ä»»åŠ¡ä»¥ä¾¿åœ¨è¿™äº›ä»»åŠ¡å¯åŠ¨æ—¶è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç­‰å¾…ï¼Œç”¨ Task å»å­˜å‚¨ä¸€ä¸ªå‡½æ•°ã€‚ä¸ºäº†ä¸ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åŠ å…¥å›è°ƒç®¡ç†ï¼Œéœ€è¦æ”¹é€ åŸæœ‰çš„å‡½æ•°ç»“æ„ï¼Œç„¶åå†é€šè¿‡ä»»åŠ¡å¯åŠ¨æ–¹æ³•å¼€å§‹æ‰§è¡Œï¼š

```C#
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

using Coffee = System.String;
using Bacon = System.String;
using Egg = System.String;

namespace AsyncBreakfast
{
    class Program
    {
        static async Task Main(string[] args)
        {
            DateTime s1 = DateTime.Now;

            Task<Egg> eggsTask = FryEggsAsync(2);
            Task<Bacon> baconTask = FryBaconAsync(3);

            // this is synchronal style code
            // Egg egg = await FryEggsAsync(2);
            // Bacon bacon = await FryBaconAsync(3);

            Egg egg =  await eggsTask;
            Console.WriteLine("eggs are ready");

            Bacon bacon =  await baconTask;
            Console.WriteLine("bacon is ready");
            
            Coffee coffee = PourCoffee();
            Console.WriteLine("coffee is ready");

            DateTime s2 = DateTime.Now;
            Console.WriteLine($"Elapsed Time {(s2-s1)}");
        }

        private static async Task<Bacon> FryBaconAsync(int slices)
        {
            Console.WriteLine($"putting {slices} slices of bacon in the pan");
            Console.WriteLine("cooking first side of bacon...");
            await Task.Delay(3000);
            for (int slice = 0; slice < slices; slice++)
            {
                Console.WriteLine("flipping a slice of bacon");
            }
            Console.WriteLine("cooking the second side of bacon...");
            await Task.Delay(3000);
            Console.WriteLine("Put bacon on plate");

            return ("Good Bacon");
        }

        private static async Task<Egg> FryEggsAsync(int howMany)
        {
            Console.WriteLine("Warming the egg pan...");
            await Task.Delay(3000);
            Console.WriteLine($"cracking {howMany} eggs");
            Console.WriteLine("cooking the eggs ...");
            await Task.Delay(3000);
            Console.WriteLine("Put eggs on plate");

            return ("Fine Egg");
        }

        private static Coffee PourCoffee()
        {
            Console.WriteLine("Pouring coffee");
            return ("Smelly coffee");
        }

    }
}
```


æ³¨æ„ï¼Œä¸¤ä¸ªè€—æ—¶çš„ä»»åŠ¡ä¿®æ”¹çš„è¿”å›ç±»å‹ Task<T>ï¼Œè€—æ—¶çš„å…³é”®ç‚¹ä½¿ç”¨äº† awaitï¼Œä½† return è¿”å›çš„è¿˜æ˜¯åŸæ ·çš„ä¸œè¥¿ï¼ŒåŒæ—¶ä½¿ç”¨äº† async ä¿®æ”¹å‡½æ•°ã€‚è¿™æ ·ï¼Œåœ¨ await Task<T> æ—¶ï¼Œå°é—­çš„å›è°ƒå‡½æ•°å°±çŸ¥é“å¦‚æœå°† return çš„è¿”å›å€¼ä¼ é€ç»™æ‰§è¡Œä»»åŠ¡ä¸€æ–¹ã€‚

æ³¨æ„ï¼Œä¸ºäº†æ‰§è¡Œ await Tast<T> ç­‰å¾…å¼‚æ­¥ä»»åŠ¡ï¼Œéœ€è¦å°†å…¥å£å‡½æ•° Main ä¹Ÿä¿®æ”¹ä¸º async ä¿®é¥°çš„å¼‚æ­¥å‡½æ•°ã€‚

ä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿˜æœ‰ Task.WenAll å’Œ Task.WhenAny ä¸¤ç§æ–¹å¼ï¼š

```C#
await Task.WhenAll(eggsTask, baconTask);

List<Task> breakfastTasks = new List<Task>{ eggsTask, baconTask};
while (breakfastTasks.Count>0)
{
    Task finishedTask = await Task.WhenAny(breakfastTasks);
    breakfastTasks.Remove(finishedTask);

    if (finishedTask == eggsTask)
    {
        Console.WriteLine("eggs are ready");
    }
    else if (finishedTask == baconTask)
    {
        Console.WriteLine("bacon is ready");
    }
}
```


ä»¥ä¸‹ç‰¹å¾æ€»ç»“äº†ç¤ºä¾‹æˆä¸ºå¼‚æ­¥æ–¹æ³•çš„åŸå› ï¼š

- æ–¹æ³•ç­¾ååŒ…å« async ä¿®é¥°ç¬¦ã€‚
- æŒ‰ç…§çº¦å®šï¼Œå¼‚æ­¥æ–¹æ³•çš„åç§°ä»¥ Async åç¼€ç»“å°¾ã€‚
- è¿”å›ç±»å‹ä¸ºä¸‹åˆ—ç±»å‹ä¹‹ä¸€ï¼š

    - å¦‚æœä½ çš„æ–¹æ³•æœ‰æ“ä½œæ•°ä¸º TResult ç±»å‹çš„è¿”å›è¯­å¥ï¼Œåˆ™ä¸º Task<TResult>ã€‚
    - å¦‚æœä½ çš„æ–¹æ³•æ²¡æœ‰è¿”å›è¯­å¥æˆ–å…·æœ‰æ²¡æœ‰æ“ä½œæ•°çš„è¿”å›è¯­å¥ï¼Œåˆ™ä¸º Taskã€‚
    - voidï¼šå¦‚æœè¦ç¼–å†™å¼‚æ­¥äº‹ä»¶å¤„ç†ç¨‹åºã€‚
    - åŒ…å« GetAwaiter æ–¹æ³•çš„å…¶ä»–ä»»ä½•ç±»å‹ï¼ˆè‡ª C# 7.0 èµ·ï¼‰ã€‚

- æ–¹æ³•é€šå¸¸åŒ…å«è‡³å°‘ä¸€ä¸ª await è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼æ ‡è®°ä¸€ä¸ªç‚¹ï¼Œåœ¨è¯¥ç‚¹ä¸Šï¼Œç›´åˆ°ç­‰å¾…çš„å¼‚æ­¥æ“ä½œå®Œæˆæ–¹æ³•æ‰èƒ½ç»§ç»­ã€‚ åŒæ—¶ï¼Œå°†æ–¹æ³•æŒ‚èµ·ï¼Œå¹¶ä¸”æ§åˆ¶è¿”å›åˆ°æ–¹æ³•çš„è°ƒç”¨æ–¹ã€‚ æœ¬ä¸»é¢˜çš„ä¸‹ä¸€èŠ‚å°†è§£é‡Šæ‚¬æŒ‚ç‚¹å‘ç”Ÿçš„æƒ…å†µã€‚

Async methods can have the following return types:

- *Task`, for an async method that performs an operation but returns no value.
- *Task`<TResult>, for an async method that returns a value.
- *void`, for an event handler.
- Starting with C# 7.0, any type that has an accessible *GetAwaiter* method. The object returned by the *GetAwaiter* method must implement the System.Runtime.CompilerServices.ICriticalNotifyCompletion interface.
- Starting with C# 8.0, `IAsyncEnumerable<T>`, for an async method that returns an async stream.

å¦ä¸€ä¸ªä¾‹å­ï¼ŒRazor Component ç»„ä»¶æ–‡æ¡£ä¿®æ”¹è€Œæ¥ï¼Œæ¨¡æ‹Ÿå¤©æ°”é¢„æŠ¥æ•°æ®è·å–ï¼ŒEnumerable.Range äº§ç”Ÿçš„æ•°æ®ä½¿ç”¨äº† Linq æ–¹å¼å¤„ç†ï¼š

```C#
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace demo
{
    public class WeatherForecastService
    {
        private static readonly string[] summaries = new[]
        {
            "Freezing", "Bracing", "Chilly", "Cool", "Mild",
            "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
        };
        
        public static async Task Main()
        {
            Task<WeatherForecast[]> forecastTask = WeatherForecastService.GetForecastAsync(DateTime.Now);
            var o = await forecastTask;
            foreach( var i in o )
            {
                Console.WriteLine(i.Summary);
            }
        }
        public static async Task<WeatherForecast[]> GetForecastAsync(DateTime startDate)
        {
            var rng = new Random();

            await Task.Delay(TimeSpan.FromSeconds(5));

            return Enumerable.Range(1, 5).Select(index => new WeatherForecast
            {
                Date = startDate.AddDays(index),
                TemperatureC = rng.Next(-20, 55),
                Summary = summaries[rng.Next(summaries.Length)]
            }).ToArray();
        }
    }

    public class WeatherForecast
    {
        public DateTime Date { get; set; }

        public int TemperatureC { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public string Summary { get; set; }
    }
}
```



å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ä¸»é¢˜æ¦‚è¿°äº† .NET æ”¯æŒçš„ä¸‰ä¸ªå¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼š

- å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ (APM)ï¼ˆæ—§ç‰ˆï¼‰
- åŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¨¡å¼ (EAP)ï¼ˆæ—§ç‰ˆï¼‰
- åŸºäºä»»åŠ¡çš„å¼‚æ­¥æ¨¡å¼ (TAP)ï¼ˆå»ºè®®ç”¨äºæ–°å¼€å‘ï¼‰

ä» .NET Framework 4 å¼€å§‹ï¼Œä»»åŠ¡å¹¶è¡Œåº“ä¸ºå¼‚æ­¥å’Œå¹¶è¡Œç¼–ç¨‹æä¾›äº†ä¸€ç§æ–°æ¨¡å‹ï¼Œ Task Parallel Library (TPL) å’Œ Task-based Asynchronous Pattern (TAP)ã€‚

ä»»åŠ¡å¹¶è¡Œåº“ (TPL) æ˜¯ System.Threading å’Œ System.Threading.Tasks ç©ºé—´ä¸­çš„ä¸€ç»„å…¬å…±ç±»å‹å’Œ APIã€‚ TPL çš„ç›®çš„æ˜¯é€šè¿‡ç®€åŒ–å°†å¹¶è¡Œå’Œå¹¶å‘æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹æ¥æé«˜å¼€å‘äººå‘˜çš„å·¥ä½œæ•ˆç‡ã€‚ TPL åŠ¨æ€ç¼©æ”¾å¹¶å‘çš„ç¨‹åº¦ä»¥æœ€æœ‰æ•ˆåœ°ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨ã€‚ æ­¤å¤–ï¼ŒTPL è¿˜å¤„ç†å·¥ä½œåˆ†åŒºã€ThreadPool ä¸Šçš„çº¿ç¨‹è°ƒåº¦ã€å–æ¶ˆæ”¯æŒã€çŠ¶æ€ç®¡ç†ä»¥åŠå…¶ä»–ä½çº§åˆ«çš„ç»†èŠ‚æ“ä½œã€‚ é€šè¿‡ä½¿ç”¨ TPLï¼Œä½ å¯ä»¥åœ¨å°†ç²¾åŠ›é›†ä¸­äºç¨‹åºè¦å®Œæˆçš„å·¥ä½œï¼ŒåŒæ—¶æœ€å¤§ç¨‹åº¦åœ°æé«˜ä»£ç çš„æ€§èƒ½ã€‚

è‡ª .NET Framework 4 èµ·ï¼Œé¦–é€‰ TPL ç¼–å†™å¤šçº¿ç¨‹ä»£ç å’Œå¹¶è¡Œä»£ç ã€‚ ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ä»£ç éƒ½é€‚åˆå¹¶è¡ŒåŒ–ï¼›ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªå¾ªç¯åœ¨æ¯æ¬¡è¿­ä»£æ—¶åªæ‰§è¡Œå°‘é‡å·¥ä½œï¼Œæˆ–å®ƒåœ¨å¾ˆå¤šæ¬¡è¿­ä»£æ—¶éƒ½ä¸è¿è¡Œï¼Œé‚£ä¹ˆå¹¶è¡ŒåŒ–çš„å¼€é”€å¯èƒ½å¯¼è‡´ä»£ç è¿è¡Œæ›´æ…¢ã€‚ æ­¤å¤–ï¼Œåƒä»»ä½•å¤šçº¿ç¨‹ä»£ç ä¸€æ ·ï¼Œå¹¶è¡ŒåŒ–ä¼šå¢åŠ ç¨‹åºæ‰§è¡Œçš„å¤æ‚æ€§ã€‚ å°½ç®¡ TPL ç®€åŒ–äº†å¤šçº¿ç¨‹æ–¹æ¡ˆï¼Œä½†æˆ‘ä»¬å»ºè®®ä½ å¯¹çº¿ç¨‹å¤„ç†æ¦‚å¿µï¼ˆä¾‹å¦‚ï¼Œé”ã€æ­»é”å’Œäº‰ç”¨æ¡ä»¶ï¼‰è¿›è¡ŒåŸºæœ¬çš„äº†è§£ï¼Œä»¥ä¾¿èƒ½å¤Ÿæœ‰æ•ˆåœ°ä½¿ç”¨ TPLã€‚


await è¿ç®—ç¬¦æš‚åœå¯¹å…¶æ‰€å±çš„ async æ–¹æ³•çš„æ±‚å€¼ï¼Œç›´åˆ°å…¶æ“ä½œæ•°è¡¨ç¤ºçš„å¼‚æ­¥æ“ä½œå®Œæˆã€‚ å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œawait è¿ç®—ç¬¦å°†è¿”å›æ“ä½œçš„ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ å½“ await è¿ç®—ç¬¦åº”ç”¨åˆ°è¡¨ç¤ºå·²å®Œæˆæ“ä½œçš„æ“ä½œæ•°æ—¶ï¼Œå®ƒå°†ç«‹å³è¿”å›æ“ä½œçš„ç»“æœï¼Œè€Œä¸ä¼šæš‚åœå…¶æ‰€å±çš„æ–¹æ³•ã€‚ await è¿ç®—ç¬¦ä¸ä¼šé˜»æ­¢è®¡ç®—å¼‚æ­¥æ–¹æ³•çš„çº¿ç¨‹ã€‚ å½“ await è¿ç®—ç¬¦æš‚åœå…¶æ‰€å±çš„å¼‚æ­¥æ–¹æ³•æ—¶ï¼Œæ§ä»¶å°†è¿”å›åˆ°æ–¹æ³•çš„è°ƒç”¨æ–¹ã€‚
åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒHttpClient.GetByteArrayAsync æ–¹æ³•è¿”å› `Task<byte[]>` å®ä¾‹ï¼Œè¯¥å®ä¾‹è¡¨ç¤ºåœ¨å®Œæˆæ—¶ç”Ÿæˆå­—èŠ‚æ•°ç»„çš„å¼‚æ­¥æ“ä½œã€‚ åœ¨æ“ä½œå®Œæˆä¹‹å‰ï¼Œawait è¿ç®—ç¬¦å°†æš‚åœ DownloadDocsMainPageAsync æ–¹æ³•ã€‚ å½“ DownloadDocsMainPageAsync æš‚åœæ—¶ï¼Œæ§ä»¶å°†è¿”å›åˆ° Main æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ DownloadDocsMainPageAsync çš„è°ƒç”¨æ–¹ã€‚ Main æ–¹æ³•å°†æ‰§è¡Œï¼Œç›´è‡³å®ƒéœ€è¦ DownloadDocsMainPageAsync æ–¹æ³•æ‰§è¡Œçš„å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚ å½“ GetByteArrayAsync è·å–æ‰€æœ‰å­—èŠ‚æ—¶ï¼Œå°†è®¡ç®— DownloadDocsMainPageAsync æ–¹æ³•çš„å…¶ä½™éƒ¨åˆ†ã€‚ ä¹‹åï¼Œå°†è®¡ç®— Main æ–¹æ³•çš„å…¶ä½™éƒ¨åˆ†ã€‚

ä» C# 7.1 å¼€å§‹ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºå…¥å£ç‚¹çš„ Main æ–¹æ³•å¯ä»¥è¿”å› Task æˆ– `Task<int>`ï¼Œä½¿å…¶æˆä¸ºå¼‚æ­¥çš„ï¼Œä»¥ä¾¿åœ¨å…¶ä¸»ä½“ä¸­ä½¿ç”¨ await è¿ç®—ç¬¦ã€‚ åœ¨è¾ƒæ—©çš„ C# ç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†ç¡®ä¿ Main æ–¹æ³•ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œå¯ä»¥æ£€ç´¢ç”±ç›¸åº”çš„å¼‚æ­¥æ–¹æ³•è¿”å›çš„ Task<TResult> å®ä¾‹çš„ Task<TResult>.Result å±æ€§å€¼ã€‚ å¯¹äºä¸ç”Ÿæˆå€¼çš„å¼‚æ­¥æ“ä½œï¼Œå¯ä»¥è°ƒç”¨ Task.Wait æ–¹æ³•ã€‚

ä» C# 8.0 å¼€å§‹ï¼Œå¯ä½¿ç”¨ await foreach è¯­å¥æ¥ä½¿ç”¨å¼‚æ­¥æ•°æ®æµã€‚ 

```C#
using System;
using System.Net.Http;
using System.Threading.Tasks;

public class AwaitOperator
{
    public static async Task Main()
    {
        Task<int> downloading = DownloadDocsMainPageAsync();
        Console.WriteLine($"{nameof(Main)}: Launched downloading.");

        int bytesLoaded = await downloading;
        Console.WriteLine($"{nameof(Main)}: Downloaded {bytesLoaded} bytes.");
    }

    private static async Task<int> DownloadDocsMainPageAsync()
    {
        Console.WriteLine($"{nameof(DownloadDocsMainPageAsync)}: About to start downloading.");

        var client = new HttpClient();
        byte[] content = await client.GetByteArrayAsync("https://docs.microsoft.com/en-us/");

        Console.WriteLine($"{nameof(DownloadDocsMainPageAsync)}: Finished downloading.");
        return content.Length;
    }
}

// Output similar to:
// DownloadDocsMainPageAsync: About to start downloading.
// Main: Launched downloading.
// DownloadDocsMainPageAsync: Finished downloading.
// Main: Downloaded 27700 bytes.
```


ä¸Šä¸€ä¸ªç¤ºä¾‹ä½¿ç”¨å¼‚æ­¥ Main æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä» C# 7.1 å¼€å§‹å¯ç”¨ã€‚


## ==âš¡ Task & CancellationToken
- https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource.cancel

å¼‚æ­¥è¯·æ±‚ä¸­ï¼Œå¯åœ¨åˆ›å»º Task æ—¶ä¼ å…¥ä¸€ä¸ª CancellationToken ä»¤ç‰Œå¯¹è±¡ï¼Œä»¥æ§åˆ¶å¦‚ä½•ç»“æŸè¯·æ±‚ï¼Œå¦‚æœ CancellationToken åœ¨ Task è°ƒåº¦å‰å–æ¶ˆï¼Œé‚£ä¹ˆ Task å°±ä¼šè¢«å–æ¶ˆæ°¸è¿œéƒ½ä¸æ‰§è¡Œã€‚

```C#
using System;
using System.Collections;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;

public class Example
{

    public static void Main()
    {

        // Define the cancellation token.
        CancellationTokenSource source = new CancellationTokenSource();
        CancellationToken token = source.Token;

        Random rnd = new Random();
        Object lockObj = new Object();
        
        List<Task<int[]>> tasks = new List<Task<int[]>>();
        TaskFactory factory = new TaskFactory(token);
        for (int taskCtr = 0; taskCtr <= 10; taskCtr++) 
        {
            int iteration = taskCtr + 1;
            tasks.Add(factory.StartNew( () => {
                int value;
                int[] values = new int[10];
                for (int ctr = 1; ctr <= 10; ctr++) 
                {
                    lock (lockObj) {
                        value = rnd.Next(0,101);
                    }
                    if (value == 0) { 
                        source.Cancel();
                        Console.WriteLine("Cancelling at task {0}", iteration);
                        break;
                    }
                    values[ctr-1] = value; 
                }
                return values;
            }, token));   
        }

        try 
        {
            Task<double> fTask = factory.ContinueWhenAll(tasks.ToArray(), 
                (results) => {
                    Console.WriteLine("Calculating overall mean...");
                    long sum = 0;
                    int n = 0; 
                    foreach (var t in results) {
                        foreach (var r in t.Result) {
                            sum += r;
                            n++;
                        }
                    }
                    return sum/(double) n;
                } , token);
            Console.WriteLine("The mean is {0}.", fTask.Result);
        }
        catch (AggregateException ae) 
        {
            foreach (Exception e in ae.InnerExceptions) {
                if (e is TaskCanceledException)
                    Console.WriteLine("Unable to compute mean: {0}", 
                        ((TaskCanceledException) e).Message);
                else
                    Console.WriteLine("Exception: " + e.GetType().Name);
            }
        }
        finally 
        {
            source.Dispose();
        }
    }
}
```


# =ğŸš© Reflection åå°„
- [C# Reflection](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/reflection)
- [C# Type Class](https://docs.microsoft.com/en-us/dotnet/api/system.type)
- [C# Assembly Class](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly)
- [Assembly manifest](https://docs.microsoft.com/en-us/dotnet/standard/assembly/manifest)
- [.NET ä¸­çš„åå°„](https://docs.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/reflection)
- [åˆ©ç”¨ç‰¹æ€§æ‰©å±•å…ƒæ•°æ®](https://docs.microsoft.com/zh-cn/dotnet/standard/attributes/)
- [System Activator](https://docs.microsoft.com/en-us/dotnet/api/system.activator.createinstance)

System.Reflection å‘½åç©ºé—´ä¸­çš„ç±»ä¸ System.Type ä½¿ä½ èƒ½å¤Ÿè·å–æœ‰å…³åŠ è½½çš„ç¨‹åºé›†å’Œå…¶ä¸­å®šä¹‰çš„ç±»å‹çš„ä¿¡æ¯ï¼Œå¦‚ç±»ã€æ¥å£å’Œå€¼ç±»å‹ï¼ˆå³ç»“æ„å’Œæšä¸¾ï¼‰ã€‚

åå°„æä¾›æè¿°ç¨‹åºé›†ã€æ¨¡å—å’Œç±»å‹çš„å¯¹è±¡ï¼ˆType ç±»å‹ï¼‰ã€‚ å¯ä»¥ä½¿ç”¨åå°„åŠ¨æ€åœ°åˆ›å»ºç±»å‹çš„å®ä¾‹ï¼Œå°†ç±»å‹ç»‘å®šåˆ°ç°æœ‰å¯¹è±¡ï¼Œæˆ–ä»ç°æœ‰å¯¹è±¡ä¸­è·å–ç±»å‹ï¼Œç„¶åè°ƒç”¨å…¶æ–¹æ³•æˆ–è®¿é—®å™¨å­—æ®µå’Œå±æ€§ã€‚ å¦‚æœä»£ç ä¸­ä½¿ç”¨äº†ç‰¹æ€§ï¼Œå¯ä»¥åˆ©ç”¨åå°„æ¥è®¿é—®å®ƒä»¬ã€‚ 

ä¸‹é¢ä¸€ä¸ªç®€å•çš„åå°„ç¤ºä¾‹ï¼Œä½¿ç”¨æ–¹æ³• GetType() ä»¥è·å–å˜é‡ç±»å‹ï¼Œæ‰€æœ‰ Object åŸºç±»çš„ç±»å‹éƒ½ç»§æ‰¿æ­¤æ–¹æ³•ï¼š

è¯·ç¡®ä¿åœ¨ .cs æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¼•ç”¨ï¼š

    using System;
    using System.Reflection;

    // Using GetType to obtain type information:
    int i = 42;
    Type type = i.GetType();
    Console.WriteLine(type); // Output: System.Int32 

ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨åå°„è·å–å·²åŠ è½½çš„ç¨‹åºé›†çš„å®Œæ•´åç§°ã€‚

    // Using Reflection to get information of an Assembly:
    Type type = typeof(int);
    Assembly info = type.Assembly;
    Console.WriteLine(info);

Type è¿™è¡¨ç±»æ˜¯æè¿°ç±»å‹çš„ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»ï¼Œä½†æ˜¯ç”¨é€”ç‰¹æ®Šï¼ŒåŒ…å«ä¸€èˆ¬ç±»å‹å¦‚ class types /interface types /array types /value type /enumeration type ç­‰ç­‰çš„å£°æ˜ï¼Œä¸ºåå°„æœºåˆ¶æä¾›åŸºç¡€æ”¯æŒã€‚é€šè¿‡ Type ç±»å‹å®ä¾‹ï¼Œå¯ä»¥æ ¹æ®å®ƒæä¾›çš„å£°æ˜ä¿¡æ¯å®ç°è¢«æè¿°ç±»å‹çš„å„ç§æ•°æ®æˆ–æ–¹æ³•çš„è®¿é—®ï¼š

    using System;
    using System.Reflection;

    class Example
    {
        static void Main()
        {
            Type t = typeof(String);

            MethodInfo substr = t.GetMethod("Substring", 
                new Type[] { typeof(int), typeof(int) });

            Object result = 
                substr.Invoke("Hello, World!", new Object[] { 7, 5 });
            Console.WriteLine("{0} returned \"{1}\".", substr, result);
        }
    }

åå°„ä¸æ³›å‹ï¼š

    using System;
    using System.Linq;
    using System.Reflection;
    using System.Collections.Generic;
    using System.Security;

    public class MyClass
    {
        class Wraper<T>
        {
            public T target;

            public Wraper(T i)
            {
                target = i;
            }
            public void Log(){
                Console.WriteLine("Log target {0}", target);
            }
        }


        public static void Main()
        {
            // ä½¿ç”¨ Reflection åˆ›å»ºæ³›å‹ç±»çš„å®ä¾‹
            Type elType = typeof(MyClass); // Type.GetType(new MyClass())
            Type genType = typeof(Wraper<>).MakeGenericType(elType);
            object obj = Activator.CreateInstance(genType, new[]{ new MyClass() });

            //è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•
            MethodInfo method = genType.GetMethod("Log",BindingFlags.Instance | BindingFlags.Public);
            method.Invoke(obj, null);
        }
    }


ç¨‹åºé›†åŒ…å«æ¨¡å—ã€æ¨¡å—åŒ…å«ç±»å‹ï¼Œè€Œç±»å‹åŒ…å«æˆå‘˜ã€‚ åå°„æä¾›å°è£…ç¨‹åºé›†ã€æ¨¡å—å’Œç±»å‹çš„å¯¹è±¡ã€‚ å¯ä»¥ä½¿ç”¨åå°„åŠ¨æ€åœ°åˆ›å»ºç±»å‹çš„å®ä¾‹ï¼Œå°†ç±»å‹ç»‘å®šåˆ°ç°æœ‰å¯¹è±¡ï¼Œæˆ–ä»ç°æœ‰å¯¹è±¡ä¸­è·å–ç±»å‹ã€‚ ç„¶åï¼Œå¯ä»¥è°ƒç”¨ç±»å‹çš„æ–¹æ³•æˆ–è®¿é—®å…¶å­—æ®µå’Œå±æ€§ã€‚ åå°„çš„å…¸å‹ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

- `Assembly` ç”¨æ¥å®šä¹‰å’ŒåŠ è½½ç¨‹åºé›†ï¼ŒåŠ è½½ç¨‹åºé›†æ¸…å•ä¸­åˆ—å‡ºçš„æ¨¡å—ï¼Œä»¥åŠåœ¨æ­¤ç¨‹åºé›†ä¸­å®šä½ä¸€ä¸ªç±»å‹å¹¶åˆ›å»ºä¸€ä¸ªå®ƒçš„å®ä¾‹ã€‚åŒ…æ‹¬æ‰“åŒ…åœ¨ç¨‹åºé›†çš„æ•°æ®æˆ–æµèµ„æºçš„è¯»å–ï¼š

    - `GetManifestResourceInfo(String)`
    - `GetManifestResourceNames()`
    - `GetManifestResourceStream(String)`
    - `GetManifestResourceStream(Type, String)`

- `Module` ç”¨æ¥å‘ç°ä¿¡æ¯ï¼Œå¦‚åŒ…å«æ¨¡å—çš„ç¨‹åºé›†å’Œæ¨¡å—ä¸­çš„ç±»ã€‚ è¿˜å¯ä»¥è·å–æ‰€æœ‰å…¨å±€æ–¹æ³•æˆ–æ¨¡å—ä¸Šå®šä¹‰çš„å…¶å®ƒç‰¹å®šçš„éå…¨å±€æ–¹æ³•ã€‚
- `ConstructorInfo` ç”¨æ¥å‘ç°ä¿¡æ¯ï¼Œå¦‚åç§° ConstructorNameã€å‚æ•°ã€è®¿é—®ä¿®é¥°ç¬¦å¦‚ IsPublic æˆ– IsPrivate å’Œæ„é€ å‡½æ•°çš„å®ç°ä¿¡æ¯å¦‚ IsAabstract æˆ– IsVirtualã€‚ ä½¿ç”¨ Type ç±»å‹çš„ GetConstructors æˆ– GetConstructor æ–¹æ³•æ¥è·å–æ„é€ å™¨ä¿¡æ¯ã€‚
- `MethodInfo` ç”¨æ¥å‘ç°æ–¹æ³•ä¿¡æ¯ï¼Œå¦‚åç§°ã€è¿”å›ç±»å‹ã€å‚æ•°ã€è®¿é—®ä¿®é¥°ç¬¦ï¼ˆå¦‚ public æˆ– privateï¼‰å’Œæ–¹æ³•çš„å®ç°è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ abstract æˆ– virtualï¼‰ã€‚ ä½¿ç”¨ Type çš„ GetMethods æˆ– GetMethod æ–¹æ³•æ¥è·å–ç‰¹å®šæ–¹æ³•ä¿¡æ¯ã€‚

- `FieldInfo` ç”¨æ¥å‘ç°ä¿¡æ¯ï¼Œå¦‚åç§°ã€è®¿é—®ä¿®é¥°ç¬¦ï¼ˆå¦‚ public æˆ– privateï¼‰å’Œä¸€ä¸ªå­—æ®µçš„å®ç°è¯¦ç»†ä¿¡æ¯ ï¼ˆå¦‚ staticï¼‰ï¼›å¹¶è·å–æˆ–è®¾ç½®å­—æ®µå€¼ã€‚

- `EventInfo` ç”¨æ¥å‘ç°ä¿¡æ¯ï¼ˆå¦‚åç§°ã€äº‹ä»¶å¤„ç†ç¨‹åºçš„æ•°æ®ç±»å‹ã€è‡ªå®šä¹‰ç‰¹æ€§ã€å£°æ˜ç±»å‹ä»¥åŠäº‹ä»¶çš„åå°„çš„ç±»å‹ï¼‰ï¼Œå¹¶æ·»åŠ æˆ–åˆ é™¤äº‹ä»¶å¤„ç†ç¨‹åºã€‚
- `PropertyInfo` ç”¨æ¥å‘ç°ä¿¡æ¯ï¼ˆå¦‚åç§°ã€æ•°æ®ç±»å‹ã€å£°æ˜ç±»å‹ï¼Œåå°„çš„ç±»å‹å’Œå±æ€§çš„åªè¯»æˆ–å¯å†™çŠ¶æ€ï¼‰ï¼Œå¹¶è·å–æˆ–è®¾ç½®å±æ€§å€¼ã€‚
- `ParameterInfo` ç”¨æ¥å‘ç°å‚æ•°ä¿¡æ¯ï¼Œå¦‚å‚æ•°çš„åç§° Nameã€ ParameterTypeã€å‚æ•°æ˜¯è¾“å…¥å‚æ•° IsIn è¿˜æ˜¯è¾“å‡ºå‚æ•° IsOut ä»¥åŠå‚æ•°åœ¨æ–¹æ³•ç­¾åä¸­çš„ä½ç½® Positionã€‚
- `CustomAttributeData` ç”¨äºåº”ç”¨ç¨‹åºåŸŸçš„ä»…åå°„ä¸Šä¸‹æ–‡ä¸­å·¥ä½œæ—¶å‘ç°æœ‰å…³è‡ªå®šä¹‰ç‰¹æ€§çš„ä¿¡æ¯ã€‚ CustomAttributeData ä½¿ä½ èƒ½å¤Ÿæ£€æŸ¥ç‰¹æ€§ï¼Œè€Œæ— éœ€åˆ›å»ºå®ƒä»¬çš„å®ä¾‹ã€‚

GetFilds è¿™ç±»æ–¹æ³•å¯èƒ½è·å–ä¸åˆ°æƒ³è¦çš„æ•°æ®ï¼ŒRuntimeReflectionExtensions
æä¾›äº†ç›¸åº”çš„è¿è¡Œæ—¶ç‰ˆæœ¬æ‰©å±•æ–¹æ³•ï¼ŒGerRuntimeFields/Method/Properties ç­‰ã€‚

åˆ©ç”¨åå°„æŠ€æœ¯å¯ä»¥è°ƒç”¨å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œå®ä¾‹åŒ–ï¼ŒSystem.Activator æä¾›äº†æ›´ç®€å•çš„é™æ€æ–¹æ³• CreateInstance æˆ– CreateInstanceFrom æ¥åšå®ä¾‹åŒ–ï¼Œæœ‰è®¸å¤šé‡è½½æ–¹æ³•åªå¯ä»¥ä½¿ç”¨ã€‚

    public static System.Runtime.Remoting.ObjectHandle CreateInstanceFrom (string assemblyFile, string typeName, object[] activationAttributes);

å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„æ–¹å¼æœ‰å¤šç§ï¼Œå¸¸è§çš„ç”¨ New å…³é”®å­—å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œç”¨ Activator å®ä¾‹åŒ–ä¸€ä¸ªç±»ä»¥åœ¨æœ¬åœ°æˆ–ä»è¿œç¨‹åˆ›å»ºå¯¹è±¡ï¼Œæ˜¯æ¯”è¾ƒæœ‰æ•ˆç‡çš„ä¸€ç§æ–¹æ³•ã€‚

ç¨‹åºé›† Assembly å¯é‡ç”¨ã€æ— ç‰ˆæœ¬å†²çªå¹¶ä¸”å¯è‡ªæˆ‘æè¿°çš„å…¬å…±è¯­è¨€è¿è¡Œåº“åº”ç”¨ç¨‹åºæ„é€ å—ã€‚è¯¥ç±»å¯ä»¥åŠ è½½ç¨‹åºé›†ã€æµè§ˆç¨‹åºé›†çš„å…ƒæ•°æ®å’Œæ„æˆéƒ¨åˆ†ã€å‘ç°ç¨‹åºé›†ä¸­åŒ…å«çš„ç±»å‹ä»¥åŠåˆ›å»ºè¿™äº›ç±»å‹çš„å®ä¾‹ã€‚åŠ è½½ç¨‹åºé›†çš„æ¨èæ–¹å¼æ˜¯ä½¿ç”¨ Load æ–¹æ³•ã€‚GetType æ–¹æ³•å¯ç”¨äºåœ¨ç¨‹åºé›†ä¸­æœç´¢ç‰¹å®šç±»å‹ã€‚CreateInstance æ–¹æ³•å¯ç”¨äºåœ¨ç¨‹åºé›†ä¸­æœç´¢å’Œåˆ›å»ºç±»å‹çš„å®ä¾‹ã€‚


ç¤ºä¾‹ï¼Œè·å–ä»»æ„å¯¹è±¡çš„æ„é€ å™¨ã€æ–¹æ³•ã€å­—æ®µã€å±æ€§ï¼Œä½†ä¸åŒ…å«æ‰©å±•æ–¹æ³•ï¼Œæˆå‘˜åŒ…æ‹¬äº†æ„é€ å™¨å’Œå±æ€§ï¼Œå±æ€§æˆ–å­—æ®µå¯ä»¥é€šè¿‡ GetValue è·å–å…¶å€¼ï¼š


    using System;
    using System.Linq;
    using System.Reflection;

    class Demo
    {
        static void Main(){
            Reflected(new System.Drawing.Color());
        }
        public static void Reflected(object obj)
        {
            Type it = obj.GetType();
            Console.WriteLine($"# {it.FullName}"); 

            var constructors = it.GetConstructors().OrderBy(c => c.GetParameters().Length).ToList();
            Console.WriteLine($"\n## Constructors Found {constructors.Count()}:"); 
            constructors.Select(e => {
                Console.WriteLine("### {0}", e); 
                return e;
                }).Count();

            var methods = it.GetMethods().OrderBy(c => c.GetParameters().Count()).ToList();
            Console.WriteLine($"\n## Methods Found {methods.Count()}:"); 
            foreach (var mi in methods)
            {
                Console.WriteLine("### {0} {1}", mi.IsPublic?"public":"", mi);
            }

            var props = it.GetProperties().OrderBy(c => c.Name).ToList();
            Console.WriteLine($"\n## Properties Found {props.Count()}:"); 
            foreach (var pi in props)
            {
                // pi.PropertyType
                string RWState =  (pi.CanRead?"Read":"") +(pi.CanWrite?"Write":"");
                Console.WriteLine("### {0} {1} {2}", RWState, pi, pi.GetValue(obj));
            }

            // var members = it.GetMembers().OrderBy(c => c.MemberType).ToList();
            // Console.WriteLine($"\n## Members Found {members.Count()}:"); 
            // foreach (var mi in members)
            // {
            //  Console.WriteLine("### {0} {1}", mi.MemberType, mi);
            // }

            // var fields = it.GetFields().OrderBy(c => c.Name).ToList();
            var fields = it.GetRuntimeFields().OrderBy(c => c.Name).ToList();
            Console.WriteLine($"\n## Runtime Fields Found {fields.Count()}:"); 
            foreach (var fi in fields)
            {
                Console.WriteLine("### {0}{1} {2} {3}", fi.IsStatic?"static":"", fi.IsPublic?"public":"", fi.FieldType.Name, fi);
            }
        }
    }


é¡¹ç›®è®¾ç½®ï¼š

    <Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">
    <!-- <Project Sdk="Microsoft.NET.Sdk"> -->

      <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>net5.0</TargetFramework>
        <UseWindowsForms>true</UseWindowsForms>
      </PropertyGroup>

      <ItemGroup>
        <PackageReference Include="Microsoft.AspNetCore.Http" Version="2.2.2" />
      </ItemGroup>

    </Project>


æ„é€ å‡½æ•°è·å–ä¸å®ä¾‹åŒ–ï¼š

    using System;
    using System.Linq;
    using System.Reflection;
    using System.Security;

    public class MyClass
    {
        public int tick = 0;

        public MyClass(){}
        public MyClass(int i){
            tick = i;
        }

        public static void Main()
        {
            var constructors = typeof(MyClass).GetConstructors().OrderBy(c => c.GetParameters().Length).ToList();
            if (constructors.Count == 0)
            {
                throw new MissingMethodException("No public constructor defined for this object");
            }
            Console.WriteLine($"{typeof(MyClass).Name} Constructors Found:"); 
            constructors.Select(e => {
                Console.WriteLine(" {0}", e); 
                return e;
                }).Count();

            object[] parameters = new object[constructors[0].GetParameters().Length];
            var instance = constructors[0].Invoke(parameters);

            try
            {
                Type myType = typeof(MyClass);

                // types in parameters list
                Type[] types = new Type[1];
                types[0] = typeof(int);

                // Get the constructor that takes an integer as a parameter.
                ConstructorInfo constructorInfoObj = myType.GetConstructor(types);
                if (constructorInfoObj != null)
                {
                    object[] args = new[]{ (object)99 };
                    var obj = constructorInfoObj.Invoke(args);
                    Console.WriteLine("Instance from Constructor(int) {0}", obj);
                }
            }
            catch(Exception e)
            {
                Console.WriteLine("Exception caught.");
                Console.WriteLine("Source: " + e.Source);
                Console.WriteLine("Message: " + e.Message);
            }
        }
    }

## ==âš¡ Reflection & DI - Dependency Injection
- [C# Generics æ³›å‹ç¼–ç¨‹](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/generics/)

Microsoft DependencyInjection ä½œä¸ºä¸€ä¸ªå¼€æºçš„ä¾èµ–æ³¨å…¥å®ç°ï¼Œåœ¨ .Net Core é‡Œè¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œè¿™é‡Œç”¨ä¸€ç™¾è¡Œä»£ç ç»“åˆåå°„æŠ€æœ¯å®ç°ä¸€ä¸ªç®€ç‰ˆ IoC å®¹å™¨ï¼Œå®ç°å¯¹è±¡æœåŠ¡æ³¨å…¥ã€æ„é€ å‡½æ•°å‚æ•°æ³¨å…¥ç­‰ã€‚

å…ˆæ¥çœ‹çœ‹æµ‹è¯•ç”¨çš„ä»£ç ï¼š

    public class DiDemo
    {
        private static void Main(string[] args)
        {
            Services services = Services.GetInstance();

            // register services
            services.Add("Some string...");
            services.Add(new MyService("More string..."));
            services.Add<MyService>();
            services.Add<MyServiceTest>();

            Log(Services.Name);

            var str = services.GetService<string>() as string;
            Log($"Got String: {str}");

            var ms = services.GetService<MyService>() as MyService;
            Log($"Got MyService: {ms.DataSource}");

            var mst = services.GetService<MyServiceTest>() as MyServiceTest;
            mst?.Test(); // if got a service and use it
        }
        public static void Log(string msg)
        {
            string stamp = DateTime.Now.ToString("hh:mm:ss ffff");
            Console.WriteLine("\n{0}:\n\t{1}", stamp, msg);
        }
    }

    public class MyService
    {
        public string DataSource {get; set;}

        // use DI here when constructor call
        public MyService(string data = "Text for testing")
        {
            DataSource = data;
        }
    }

    public class MyServiceTest
    {
        protected MyService _service;

        // Use DI here when constructor call
        public MyServiceTest(MyService service)
        {
            _service = service;
        }

        public void Test()
        {
            Console.WriteLine($"Testing Text from MyService: {_service.DataSource}.");
        }
    }

åˆ†åˆ«å®šä¹‰äº† MyService å’Œ MyServiceTest ä¸¤ç§æœåŠ¡ï¼Œåè€…ç”¨æ¥æµ‹è¯•å‰æä¾›çš„å­—ç¬¦ä¸²æœåŠ¡ï¼Œæµ‹è¯•æ„é€ å‡½æ•°çš„ä¾èµ–æ³¨å…¥ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç±»å‹ï¼Œå¦‚å­—ç¬¦ä¸²ä½œä¸ºæœåŠ¡ã€‚Services æ˜¯ IoC å®¹å™¨ï¼Œæä¾›å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š

- Add(object service)   æ³¨å†ŒæœåŠ¡å®ä¾‹ï¼›
- Add<T>()  é€šè¿‡æ³›å‹å‡½æ•°æ³¨å†ŒæœåŠ¡ç±»å‹ï¼›
- GetService()  è·å–å·²ç»æ³¨å†Œçš„æœåŠ¡ï¼Œä¼˜å…ˆè¿”å›æ³¨å†Œçš„æœåŠ¡å®ä¾‹ï¼Œå…¶æ¬¡è¿”å›å¯ä»¥é€šè¿‡åå°„æ–¹å¼æ„é€ çš„æœåŠ¡å®ä¾‹ï¼›

IoC å®¹å™¨å®ç°è¯­æ³•ä¸Šä½¿ç”¨äº† C# çš„ç‰¹è‰² Linq æŸ¥è¯¢è¯­è¨€ï¼Œè¿˜æœ‰æ³›å‹ï¼š

    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.Linq;

    public class Services
    {
        public static string Name = "IoC Container(IoC - Iversion of Control, DI - Dependency Injection)";
        protected static Services Instance;
        protected static List<object> Singletons;
        protected static List<Type> ServiceTypes;

        public static Services GetInstance()
        {
            if (Instance == null) 
            {
                Instance = new Services(); 
                ServiceTypes = new List<Type>{}; 
                Singletons = new List<object>{};
            }
            return Instance;
        }

        public Services Add(Object it)
        {
            Singletons.Add(it);
            return this;
        }

        public Services Add<T>()
        {
            ServiceTypes.Add(typeof(T));
            return this;
        }

        public object GetService<T>()
        {
            var singleton = GetSingleton(typeof(T));
            if (singleton != null)
            {
                return singleton;
            }

            foreach (var ti in ServiceTypes)
            {
                if (ti == typeof(T))
                {
                    return Build(ti);
                }
            }
            return new MyService("Default IoC Service");
        }

        protected object Build(Type ti)
        {
            // retrive ConstructorInfo[]
            var constructors = ti.GetConstructors().OrderBy(c => c.GetParameters().Length).ToList();
            if (constructors.Count == 0)
            {
                throw new MissingMethodException("No public constructor defined for this object");
            }
            foreach (var ctor in constructors)
            {
                // retrive ParameterInfo[]
                var paras = ctor.GetParameters();
                object[] parameters = new object[paras.Length];
                int idx = 0;
                foreach (var pa in paras)
                {
                    var it = GetSingleton(pa.ParameterType);
                    if (it==null) break;
                    parameters[idx ++] = it;
                }
                if (idx < paras.Length) continue;
                try
                {
                    var instance = ctor.Invoke(parameters);
                    return instance;
                }
                catch (Exception ex)
                {
                    Console.WriteLine("EX:"+ex.ToString());
                }
            }
            return null;
        }

        protected object GetSingleton(Type ti)
        {
            foreach(var it in Singletons)
            {
                if (it.GetType() == ti)
                {
                    return it;
                }
            }
            return null;
        }
    }

è¿›ä¸€æ­¥ä¿®æ”¹ MyServiceTest æŒ‰å¦‚ä¸‹å®ç°å¦å¤–ä¸€ä¸ªæ„é€ å‡½æ•°ï¼ŒåŠ å…¥ info å‚æ•°ï¼Œåœ¨æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œçœ‹ IoC ä¼šæ‰§è¡Œå“ªä¸ªï¼š

    public class MyServiceTest
    {
        protected MyService _service;
        protected string _info = "unchanged";

        public MyServiceTest(MyService service, string info)
        {
            _service = service;
            _info = info;
        }

        // Use DI here when constructor call
        public MyServiceTest(MyService service)
        {
            _service = service;
        }
        
        public void Test()
        {
            Console.WriteLine($"Testing Text from MyService & info: {_service.DataSource} [{_info}].");
        }
    }

è¯•ç€ä¿®æ”¹ IoC å®ç°çš„ Build æ–¹æ³•ï¼Œä¿®æ”¹ Linq æ’åºæ–¹å¼ï¼Œå†è¯•è¯•ï¼š

    OrderBy(c => -c.GetParameters().Length)



## ==âš¡ Metadata å…ƒæ•°æ®ç¼–ç¨‹

å…ƒæ•°æ® Metadata æ˜¯ä¸€ç§ä¿å­˜åœ¨ç¨‹åºæ–‡ä»¶çš„äºŒè¿›åˆ¶ä¿¡æ¯ï¼Œç”¨ä»¥å¯¹å­˜å‚¨åœ¨å…¬å…±è¯­è¨€è¿è¡Œåº“å¯ç§»æ¤å¯æ‰§è¡Œæ–‡ä»¶ PE æ–‡ä»¶æˆ–å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ç¨‹åºè¿›è¡Œæè¿°ã€‚å°†æ‚¨çš„ä»£ç ç¼–è¯‘ä¸º PE æ–‡ä»¶æ—¶ï¼Œä¾¿ä¼šå°†å…ƒæ•°æ®æ’å…¥åˆ°è¯¥æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ä¸­ï¼Œè€Œå°†ä»£ç è½¬æ¢ä¸º Microsoft ä¸­é—´è¯­è¨€ (MSIL) å¹¶å°†å…¶æ’å…¥åˆ°è¯¥æ–‡ä»¶çš„å¦ä¸€éƒ¨åˆ†ä¸­ã€‚å½“æ‰§è¡Œä»£ç æ—¶ï¼Œè¿è¡Œåº“å°†å…ƒæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å¼•ç”¨å®ƒæ¥å‘ç°æœ‰å…³ä»£ç çš„ç±»ã€æˆå‘˜ã€ç»§æ‰¿ç­‰ä¿¡æ¯ã€‚

ä½¿ç”¨å…ƒæ•°æ®ä»¥éç‰¹å®šè¯­è¨€çš„æ–¹å¼æè¿°åœ¨ä»£ç ä¸­å®šä¹‰çš„æ¯ä¸€ç±»å‹å’Œæˆå‘˜ï¼Œå…ƒæ•°æ®å¯ä»¥å­˜å‚¨ä»¥ä¸‹ä¿¡æ¯ï¼š

- ç¨‹åºé›†çš„è¯´æ˜ã€‚
- æ ‡è¯†ï¼ˆåç§°ã€ç‰ˆæœ¬ã€åŒºåŸŸæ€§ã€å…¬é’¥ï¼‰ã€‚ 
- å¯¼å‡ºçš„ç±»å‹ã€‚
- è¯¥ç¨‹åºé›†æ‰€ä¾èµ–çš„å…¶ä»–ç¨‹åºé›†ã€‚
- è¿è¡Œæ‰€éœ€çš„å®‰å…¨æƒé™ã€‚
- ç±»å‹çš„è¯´æ˜ã€‚
- åç§°ã€å¯è§æ€§ã€åŸºç±»å’Œå®ç°çš„æ¥å£ã€‚
- æˆå‘˜ï¼ˆæ–¹æ³•ã€å­—æ®µã€å±æ€§ã€äº‹ä»¶ã€åµŒå¥—çš„ç±»å‹ï¼‰ã€‚
- å±æ€§ã€‚
- ä¿®é¥°ç±»å‹å’Œæˆå‘˜çš„å…¶ä»–è¯´æ˜æ€§å…ƒç´ ã€‚

å…ƒæ•°æ®æ˜¯ç°ä»£ç¼–è¯‘è¯­è¨€çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯¹äºä¸€ç§æ›´ç®€å•çš„ç¼–ç¨‹æ¨¡å‹æ¥è¯´ï¼Œå…ƒæ•°æ®æ˜¯å…³é”®ï¼Œè¯¥æ¨¡å‹ä¸å†éœ€è¦æ¥å£å®šä¹‰è¯­è¨€ (IDL) æ–‡ä»¶ã€å¤´æ–‡ä»¶æˆ–ä»»ä½•å¤–éƒ¨ç»„ä»¶å¼•ç”¨æ–¹æ³•ã€‚å…ƒæ•°æ®å…è®¸ .NET è¯­è¨€è‡ªåŠ¨ä»¥éç‰¹å®šè¯­è¨€çš„æ–¹å¼å¯¹å…¶è‡ªèº«è¿›è¡Œæè¿°ï¼Œè€Œè¿™æ˜¯å¼€å‘äººå‘˜å’Œç”¨æˆ·éƒ½æ— æ³•çœ‹è§çš„ã€‚å¦å¤–ï¼Œé€šè¿‡ä½¿ç”¨å±æ€§ï¼Œå¯ä»¥å¯¹å…ƒæ•°æ®è¿›è¡Œæ‰©å±•ã€‚

å…ƒæ•°æ®çš„åº”ç”¨ç¤ºä¾‹ï¼Œä»¥ä¸‹ä»£ç ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•å£°æ˜ System.ObsoleteAttribute å°†ä»£ç æ ‡è®°ä¸ºå·²è¿‡æ—¶ã€‚ç‰¹æ€§æè¿°çš„ä»£ç è¢«è°ƒç”¨æ—¶ï¼Œæ­¤ç‰¹æ€§ä¼šå¯¼è‡´äº§ç”Ÿç¼–è¯‘å™¨è­¦å‘Šï¼Œæ˜¾ç¤ºä¼ é€’è¿›æ¥çš„å­—ç¬¦ä¸²ã€‚

    public class Example
    {
        // Specify attributes between square brackets in C#.
        // This attribute is applied only to the Add method.
        [Obsolete("Will be removed in next version.")]
        public static int Add(int a, int b)
        {
            return (a + b);
        }
    }

    class Test
    {
        public static void Main()
        {
            // This generates a compile-time warning.
            int i = Example.Add(2, 2);
        }
    }

è¦åœ¨ç¨‹åºé›†çº§åˆ«åº”ç”¨å±æ€§ï¼Œæ¯”å¦‚è®¾ç½®ç¨‹åºé›†æ ‡é¢˜ï¼Œè¯·ä½¿ç”¨ **assembly** å…³é”®å­—ï¼ŒVisual Basic ä¸­ç”¨ Assemblyã€‚ ä¸‹åˆ—ä»£ç æ˜¾ç¤ºåœ¨ç¨‹åºé›†çº§åˆ«åº”ç”¨çš„ AssemblyTitleAttributeã€‚

    using System.Reflection;
    [assembly:AssemblyTitle("My Assembly")]

å¯é€šè¿‡ååˆ—æ–¹æ³•æŸ¥çœ‹ç‰¹æ€§ï¼šä½¿ç”¨ MSIL åæ±‡ç¼–ç¨‹åº (Ildasm.exe)ï¼Œæˆ–åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç¨‹åºæ¥æ£€ç´¢æŸ¥çœ‹ã€‚

è¦è®¾è®¡ä½ è‡ªå·±çš„è‡ªå®šä¹‰ç‰¹æ€§ï¼Œæ— éœ€æŒæ¡è®¸å¤šæ–°çš„æ¦‚å¿µã€‚ å¦‚æœä½ ç†Ÿæ‚‰é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•è®¾è®¡ç±»ï¼Œé‚£ä¹ˆä½ å·²ç»å…·å¤‡å¤§éƒ¨åˆ†æ‰€éœ€çŸ¥è¯†ã€‚ è‡ªå®šä¹‰å±æ€§æœ¬è´¨ä¸Šæ˜¯ç›´æ¥æˆ–é—´æ¥æ´¾ç”Ÿè‡ª System.Attribute çš„ä¼ ç»Ÿç±»ã€‚ ä¸ä¼ ç»Ÿç±»ä¸€æ ·ï¼Œè‡ªå®šä¹‰ç‰¹æ€§åŒ…å«ç”¨äºå­˜å‚¨å’Œæ£€ç´¢æ•°æ®çš„æ–¹æ³•ã€‚

æ­£ç¡®è®¾è®¡è‡ªå®šä¹‰ç‰¹æ€§çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š

- åº”ç”¨ AttributeUsageAttribute
- å£°æ˜ç‰¹æ€§ç±»
- å£°æ˜æ„é€ å‡½æ•°
- å£°æ˜å±æ€§

ä¾‹å¦‚ï¼Œä½ å¯ä»¥æŒ‡å®šå…¶ä»–ç±»æ˜¯å¦å¯ä»¥ç»§æ‰¿ä½ çš„ç‰¹æ€§ï¼Œæˆ–è€…æŒ‡å®šæ­¤ç‰¹æ€§å¯ä»¥åº”ç”¨åˆ°å“ªäº›å…ƒç´ ã€‚ ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº† System.AttributeUsageAttribute çš„ä½¿ç”¨æ–¹å¼ã€‚

    // This defaults to Inherited = true.
    public class MyAttribute : Attribute
    {
        //...
    }

    [AttributeUsage(AttributeTargets.Method, Inherited = false)]
    public class YourAttribute : Attribute
    {
        //...
    }

    public class MyClass
    {
        [MyAttribute]
        [YourAttribute]
        public virtual void MyMethod()
        {
            //...
        }
    }

AttributeUsageAttribute åŒ…å«ä¸‰ä¸ªæˆå‘˜ï¼Œå®ƒä»¬å¯¹åˆ›å»ºè‡ªå®šä¹‰å±æ€§éå¸¸é‡è¦ï¼šAttributeTargetsã€Inherited å’Œ AllowMultipleã€‚

- AttributeTargets æˆå‘˜æŒ‡å®šç‰¹æ€§é€‚ç”¨èŒƒå›´

    ä¸Šè¿°ç¤ºä¾‹ä¸­æŒ‡å®šäº† AttributeTargets.Allï¼Œå®ƒè¡¨ç¤ºæ­¤ç‰¹æ€§å¯åº”ç”¨äºæ‰€æœ‰ç¨‹åºå…ƒç´ ã€‚ æˆ–è€…ï¼Œä½ å¯æŒ‡å®š AttributeTargets.Class å’Œ AttributeTargets.Methodï¼Œå‰è€…è¡¨ç¤ºä½ çš„ç‰¹æ€§ä»…å¯é€‚ç”¨äºä¸€ä¸ªç±»ï¼Œåè€…è¡¨ç¤ºä½ çš„ç‰¹æ€§ä»…å¯åº”ç”¨äºä¸€ç§æ–¹æ³•ã€‚

- Inherited å±æ€§æŒ‡æ˜è¦å¯¹å…¶åº”ç”¨å±æ€§çš„ç±»çš„æ´¾ç”Ÿç±»èƒ½å¦ç»§æ‰¿æ­¤å±æ€§ã€‚

    ä»åŸºç±» MyClass ä¸­ç»§æ‰¿ç±» YourClassã€‚ æ–¹æ³• MyMethod æ˜¾ç¤º MyAttributeï¼Œä½†ä¸æ˜¾ç¤º YourAttributeã€‚

- AllowMultiple å±æ€§æŒ‡æ˜å…ƒç´ èƒ½å¦åŒ…å«å±æ€§çš„å¤šä¸ªå®ä¾‹ã€‚ 

    å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™å…è®¸å¤šä¸ªå®ä¾‹ï¼›å¦‚æœè®¾ç½®ä¸º falseï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™åªå…è®¸ä¸€ä¸ªå®ä¾‹ã€‚å½“åº”ç”¨è¿™äº›ç‰¹æ€§çš„å¤šä¸ªå®ä¾‹æ—¶ï¼Œ MyAttribute ä¼šç”Ÿæˆç¼–è¯‘å™¨é”™è¯¯ã€‚ ä¸‹é¢çš„ä»£ç ç¤ºä¾‹æ˜¾ç¤º YourAttribute çš„æœ‰æ•ˆç”¨æ³•å’Œ MyAttributeçš„æ— æ•ˆç”¨æ³•ã€‚

æ£€ç´¢è‡ªå®šä¹‰å±æ€§ï¼Œé¦–å…ˆï¼Œå£°æ˜è¦æ£€ç´¢çš„å±æ€§å®ä¾‹ã€‚ ç„¶åï¼Œä½¿ç”¨ Attribute.GetCustomAttribute æˆ– Attribute.GetCustomAttributes æ–¹æ³•ï¼Œä»¥è¦æ£€ç´¢çš„å±æ€§çš„å€¼åˆå§‹åŒ–æ–°å±æ€§ã€‚ åœ¨åˆå§‹åŒ–æ–°å±æ€§åï¼Œåªéœ€ä½¿ç”¨å®ƒçš„å±æ€§å³å¯è·å–å€¼ã€‚

    using System;

    public class ExampleAttribute : Attribute
    {
        private string stringVal;

        public ExampleAttribute()
        {
            stringVal = "This is the default string.";
        }

        public string StringValue
        {
            get { return stringVal; }
            set { stringVal = value; }
        }
    }

    [Example(StringValue="This is a string.")]
    class Class1
    {
        public static void Main()
        {
            System.Reflection.MemberInfo info = typeof(Class1);
            foreach (object attrib in info.GetCustomAttributes(true))
            {
                Console.WriteLine(attrib);
            }
        }
    }

ä¾‹äºŒï¼š

    using System;
    using System.Reflection;


    [Developer("Joan Smith", "42", Reviewed = true)]
    class ReflectionApp
    {
        public static void Main()
        {
            // Call function to get and display the attribute.
            GetAttribute(typeof(ReflectionApp));
        }

        public static void GetAttribute(Type t)
        {
            // Get instance of the attribute.
            DeveloperAttribute att =
                (DeveloperAttribute) Attribute.GetCustomAttribute(t, typeof (DeveloperAttribute));

            if (att == null)
            {
                Console.WriteLine("The attribute was not found.");
            }
            else
            {
                // Get the attribute values.
                Console.WriteLine("The Developer Attribute is: {0} {1} {2}.", att.Name, att.Level, att.Reviewed);
            }
        }
    }

    [AttributeUsage(AttributeTargets.All)]
    public class DeveloperAttribute : Attribute
    {
        // Private fields.
        private string name;
        private string level;
        private bool reviewed;

        public DeveloperAttribute(string name, string level)
        {
            this.name = name;
            this.level = level;
            this.reviewed = false;
        }

        // Define read-only Name property.
        public virtual string Name
        {
            get {return name;}
        }

        // Define read-only Level property.
        public virtual string Level
        {
            get {return level;}
        }

        // Define read/write Reviewed property.
        public virtual bool Reviewed
        {
            get {return reviewed;}
            set {reviewed = value;}
        }
    }

åŸºç±»åº“ (BCL) ä¸­çš„æœ‰è®¸å¤šå·¥å…·å’Œæ¡†æ¶éƒ½ä¼šä½¿ç”¨çš„ç‰¹æ€§ã€‚ NUnit å’Œ NUnit æµ‹è¯•è¿è¡Œç¨‹åºéƒ½ä½¿ç”¨ [Test] å’Œ [TestFixture] ä¹‹ç±»çš„ç‰¹æ€§ã€‚ ASP.NET MVC ä½¿ç”¨ [Authorize] ä¹‹ç±»çš„ç‰¹æ€§ï¼Œå¹¶æä¾›å¯å¯†åˆ‡å…³æ³¨ MVC æ“ä½œçš„æ“ä½œç­›é€‰å™¨æ¡†æ¶ã€‚ PostSharp ä½¿ç”¨ç‰¹æ€§è¯­æ³•ï¼Œæ”¯æŒåœ¨ C# ä¸­è¿›è¡Œé¢å‘ç‰¹æ€§çš„ç¼–ç¨‹ã€‚

ä¸‹é¢ä»‹ç»äº†ä¸€äº›å€¼å¾—æ³¨æ„çš„ .NET Core åŸºç±»åº“å†…ç½®ç‰¹æ€§ï¼š

- [Obsolete]ã€‚ æ­¤ç‰¹æ€§å·²åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨è¿‡ï¼Œä½äº System å‘½åç©ºé—´ä¸­ã€‚ å¯ç”¨äºæä¾›å…³äºä¸æ–­å˜åŒ–çš„åŸºæœ¬ä»£ç çš„å£°æ˜æ€§æ–‡æ¡£ã€‚ å¯ä»¥æä¾›å­—ç¬¦ä¸²å½¢å¼çš„æ¶ˆæ¯ï¼Œå¹¶èƒ½ä½¿ç”¨å¦ä¸€å¸ƒå°”å‚æ•°å°†ç¼–è¯‘å™¨è­¦å‘Šå‡çº§ä¸ºç¼–è¯‘å™¨é”™è¯¯ã€‚

- [Conditional]ã€‚ æ­¤ç‰¹æ€§ä½äº System.Diagnostics å‘½åç©ºé—´ä¸­ã€‚ å¯åº”ç”¨äºæ–¹æ³•ï¼ˆæˆ–ç‰¹æ€§ç±»ï¼‰ã€‚ å¿…é¡»å‘æ„é€ å‡½æ•°ä¼ é€’å­—ç¬¦ä¸²ã€‚ å¦‚æœè¯¥å­—ç¬¦ä¸²ä¸ #define æŒ‡ä»¤ä¸åŒ¹é…ï¼Œé‚£ä¹ˆ C# ç¼–è¯‘å™¨å°†åˆ é™¤å¯¹è¯¥æ–¹æ³•ï¼ˆè€Œä¸æ˜¯æ–¹æ³•æœ¬èº«ï¼‰çš„æ‰€æœ‰è°ƒç”¨ã€‚ æ­¤ç‰¹æ€§é€šå¸¸ç”¨äºè°ƒè¯•ï¼ˆè¯Šæ–­ï¼‰ç›®çš„ã€‚

- [CallerMemberName]ã€‚ æ­¤ç‰¹æ€§å¯åº”ç”¨äºå‚æ•°ï¼Œä½äº System.Runtime.CompilerServices å‘½åç©ºé—´ä¸­ã€‚ å¯ç”¨äºæ’å…¥æ­£åœ¨è°ƒç”¨å¦ä¸€æ–¹æ³•çš„æ–¹æ³•çš„åç§°ï¼Œåœ¨ç¼–è¯‘æœŸå®ç°åƒ JavaScript åŠ¨æ€è¯­è¨€çš„ arguments.callerã€‚ æ­¤ç‰¹æ€§é€šå¸¸ç”¨äºåœ¨å„ç§ UI æ¡†æ¶ä¸­å®ç° INotifyPropertyChanged æ—¶æ¸…é™¤â€œç¥å¥‡å­—ç¬¦ä¸²â€ã€‚ 

C# å…³é”®å­— nameof è¡¨è¾¾å¼ä¹Ÿå¯ç”Ÿæˆå˜é‡ã€ç±»å‹æˆ–æˆå‘˜çš„åç§°ä½œä¸ºå­—ç¬¦ä¸²å¸¸é‡ã€‚

[Obsolete] åŠè‡ªå®šä¹‰ç‰¹æ€§ï¼š

    using System;
    using System.Collections;
    using System.Reflection;

    [Obsolete("ThisClass is obsolete. Use ThisClass2 instead.")]
    public class ThisClass { }

    [Gotcha("Fine")]
    public class ThisClass2 { }

    public class GotchaAttribute : Attribute
    {
        public string Info;

        public GotchaAttribute(string str) 
        {
            Info = str;
        }
    }

    class Demo
    {
        public static void Main()
        {
            // var tc = new ThisClass();
            var tc = new ThisClass2();

            TypeInfo typeInfo = typeof(ThisClass2).GetTypeInfo();
            Console.WriteLine("The assembly qualified name is " + typeInfo.AssemblyQualifiedName);

            var attrs = typeInfo.GetCustomAttributes();
            foreach(var attr in attrs)
            {
                string ana = attr.GetType().Name;
                if (ana == "GotchaAttribute")
                {
                    var got = attr as GotchaAttribute;
                    Console.WriteLine($"Gotchar has info {got.Info}");
                }
                else
                {
                    Console.WriteLine($"Attribute on MyClass2: {ana}");
                }
            }

        }
    }

æµè¡Œçš„ MVVM - Model-View-ViewModel ç¼–ç¨‹æ¨¡å¼ä¸­ï¼Œé€šè¿‡å¯¹è±¡å±æ€§æ•°æ®çš„å˜åŠ¨æ¥æ›´æ–° UIï¼Œä½¿ç”¨ [CallerMemberName] ç‰¹æ€§åªå¯ä»¥å¾ˆè½»æ¾å®ç°å±æ€§è„æ•°æ®è§¦å‘çš„å˜åŠ¨äº‹ä»¶ï¼Œç›´æ¥é©±åŠ¨ UI çš„æ›´æ–°äº‹ä»¶æ–¹æ³•ã€‚

    using System;
    using System.ComponentModel;
    using System.Runtime.CompilerServices;

    class Demo
    {
        public static void Main()
        {
            var ui = new MyUIClass();
            ui.PropertyChanged += (sender, eventArg) => {
                Console.WriteLine($"{sender} PropertyChaned, {eventArg.PropertyName}");
            };
            ui.Score = 9;
            ui.Name = "Any";

        }
    }

    public class MyUIClass : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler PropertyChanged;

        public void RaisePropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }

        private int _score;
        public int Score { 
            get { return _score; }
            set 
            {
                if (value != _score)
                {
                    _score = value;
                    RaisePropertyChanged();
                }
            }
        }
        
        private string _name;
        public string Name
        {
            get { return _name;}
            set
            {
                if (value != _name)
                {
                    _name = value;
                    RaisePropertyChanged();
                }
            }
        }
    }

é™¤äº† CallerMemberName è¿˜æœ‰ CallerFilePath CallerLineNumber ï¼Œå®ƒä»¬ç”¨æ¥è·å–è°ƒç”¨æ–¹æ³•åç§°ï¼Œè·¯å¾„ï¼Œè¡Œå·

    using System;
    using System.Runtime.CompilerServices;

    class Program
    {
        static void Main(string[] args)
        {
            Log();
            Console.Read();
        }

        public static void Log(
            [CallerMemberName] string memberName = "",
            [CallerFilePath] string filePath = "",
            [CallerLineNumber] int lineNumber = 0)
        {
            Console.WriteLine("Caller: {0} File:{1} line:{2}", memberName, filePath, lineNumber);
        }
    }


# =ğŸš© Iterators è¿­ä»£å™¨ 
-[Iterators è¿­ä»£å™¨](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/iterators)

è¿­ä»£å™¨ å¯ç”¨äºé€æ­¥è¿­ä»£é›†åˆï¼Œä¾‹å¦‚åˆ—è¡¨å’Œæ•°ç»„ã€‚

è¿­ä»£å™¨æ–¹æ³•æˆ– get è®¿é—®å™¨å¯å¯¹é›†åˆæ‰§è¡Œè‡ªå®šä¹‰è¿­ä»£ã€‚ è¿­ä»£å™¨æ–¹æ³•ä½¿ç”¨ yield return è¯­å¥è¿”å›å…ƒç´ ï¼Œæ¯æ¬¡è¿”å›ä¸€ä¸ªã€‚ åˆ°è¾¾ yield return è¯­å¥æ—¶ï¼Œä¼šè®°ä½å½“å‰åœ¨ä»£ç ä¸­çš„ä½ç½®ã€‚ ä¸‹æ¬¡è°ƒç”¨è¿­ä»£å™¨å‡½æ•°æ—¶ï¼Œå°†ä»è¯¥ä½ç½®é‡æ–°å¼€å§‹æ‰§è¡Œã€‚

é€šè¿‡ foreach è¯­å¥æˆ– LINQ æŸ¥è¯¢ä»å®¢æˆ·ç«¯ä»£ç ä¸­ä½¿ç”¨è¿­ä»£å™¨ã€‚

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œforeach å¾ªç¯çš„é¦–æ¬¡è¿­ä»£å¯¼è‡´ SomeNumbers è¿­ä»£å™¨æ–¹æ³•ç»§ç»­æ‰§è¡Œï¼Œç›´è‡³åˆ°è¾¾ç¬¬ä¸€ä¸ª yield return è¯­å¥ã€‚ æ­¤è¿­ä»£è¿”å›çš„å€¼ä¸º 3ï¼Œå¹¶ä¿ç•™å½“å‰åœ¨è¿­ä»£å™¨æ–¹æ³•ä¸­çš„ä½ç½®ã€‚ åœ¨å¾ªç¯çš„ä¸‹æ¬¡è¿­ä»£ä¸­ï¼Œè¿­ä»£å™¨æ–¹æ³•çš„æ‰§è¡Œå°†ä»å…¶æš‚åœçš„ä½ç½®ç»§ç»­ï¼Œç›´è‡³åˆ°è¾¾ yield return è¯­å¥åæ‰ä¼šåœæ­¢ã€‚ æ­¤è¿­ä»£è¿”å›çš„å€¼ä¸º 5ï¼Œå¹¶å†æ¬¡ä¿ç•™å½“å‰åœ¨è¿­ä»£å™¨æ–¹æ³•ä¸­çš„ä½ç½®ã€‚ åˆ°è¾¾è¿­ä»£å™¨æ–¹æ³•çš„ç»“å°¾æ—¶ï¼Œå¾ªç¯ä¾¿å·²å®Œæˆã€‚

    static void Main()
    {
        foreach (int number in SomeNumbers())
        {
            Console.Write(number.ToString() + " ");
        }
        // Output: 3 5 8
        Console.ReadKey();
    }

    public static System.Collections.IEnumerable SomeNumbers()
    {
        yield return 3;
        yield return 5;
        yield return 8;
    }

è¿­ä»£å™¨æ–¹æ³•æˆ– get è®¿é—®å™¨çš„è¿”å›ç±»å‹å¯ä»¥æ˜¯ IEnumerableã€IEnumerable<T>ã€IEnumerator æˆ– IEnumerator<T>ã€‚
å¯ä»¥ä½¿ç”¨ yield break è¯­å¥æ¥ç»ˆæ­¢è¿­ä»£ã€‚

ä¸‹ä¾‹åŒ…å«ä¸€ä¸ªä½äº for å¾ªç¯å†…çš„ yield return è¯­å¥ã€‚ åœ¨ Main ä¸­ï¼Œforeach è¯­å¥ä½“çš„æ¯æ¬¡è¿­ä»£éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¯¹è¿­ä»£å™¨å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶å°†ç»§ç»­åˆ°ä¸‹ä¸€ä¸ª yield return è¯­å¥ã€‚

    using System;

    class App
    {

        static void Main()
        {
            foreach (int number in EvenSequence(5, 18))
            {
                Console.Write(number.ToString() + " ");
            }
            // Output: 6 8 10 12 14 16 18
            Console.ReadKey();
        }
        
        public static System.Collections.Generic.IEnumerable<int>
            EvenSequence(int firstNumber, int lastNumber)
        {
            // Yield even numbers in the range.
            for (int number = firstNumber; number <= lastNumber; number++)
            {
                if (number % 2 == 0)
                {
                    yield return number;
                }
            }
        }
    }


åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼ŒDaysOfTheWeek ç±»å®ç° IEnumerable æ¥å£ï¼Œæ­¤æ“ä½œéœ€è¦ GetEnumerator æ–¹æ³•ã€‚ ç¼–è¯‘å™¨éšå¼è°ƒç”¨ GetEnumerator æ–¹æ³•ï¼Œæ­¤æ–¹æ³•è¿”å› IEnumeratorã€‚GetEnumerator æ–¹æ³•é€šè¿‡ä½¿ç”¨ yield return è¯­å¥æ¯æ¬¡è¿”å› 1 ä¸ªå­—ç¬¦ä¸²ã€‚

    using System;
    using System.Collections;

    class App
    {
        static void Main()
        {
            DaysOfTheWeek days = new DaysOfTheWeek();

            foreach (string day in days)
            {
                Console.Write(day + " ");
            }
            // Output: Sun Mon Tue Wed Thu Fri Sat
            Console.ReadKey();
        }

        public class DaysOfTheWeek : IEnumerable
        {
            private string[] days = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

            public IEnumerator GetEnumerator()
            {
                for (int index = 0; index < days.Length; index++)
                {
                    // Yield each day of the week.
                    yield return days[index];
                }
            }
        }
    }



# =ğŸš© System.DateTime
https://docs.microsoft.com/zh-cn/dotnet/api/system.datetime
https://docs.microsoft.com/zh-cn/dotnet/api/system.timespan
https://docs.microsoft.com/zh-cn/dotnet/api/system.console.writeline

å‘½åç©ºé—´: System
ç¨‹åºé›†: System.Runtime.dll

è¡¨ç¤ºæ—¶é—´ä¸Šçš„ä¸€åˆ»ï¼Œé€šå¸¸ä»¥æ—¥æœŸå’Œå½“å¤©çš„æ—¶é—´è¡¨ç¤ºã€‚

    public struct DateTime : IComparable, IComparable<DateTime>, IConvertible, IEquatable<DateTime>, IFormattable, System.Runtime.Serialization.ISerializable

ç»§æ‰¿ Object -> ValueType -> DateTime


DateTime å€¼ç±»å‹è¡¨ç¤ºæ—¥æœŸå’Œæ—¶é—´ï¼Œå…¶å€¼èŒƒå›´ä¸º00:00:00 ï¼ˆåˆå¤œï¼‰ï¼Œ0001å¹´1æœˆ1æ—¥è‡³å¹´1æœˆ1æ—¥ä¸‹åˆ11:59:59ï¼Œå¹´12æœˆ31æ—¥ï¼Œ9999å…¬å…ƒ å…¬å…ƒå…¬å†ã€‚
æ—¶é—´å€¼ä»¥100æ¯«å¾®ç§’ä¸ºå•ä½è¿›è¡Œåº¦é‡ã€‚ ç‰¹å®šæ—¥æœŸæ˜¯è‡ªå…¬å…ƒ12:00 å¹´1æœˆ1æ—¥åˆå¤œå¼€å§‹çš„è®¡æ—¶å‘¨æœŸæ•°ã€‚ å…¬å…ƒåœ¨ GregorianCalendar æ—¥å†ä¸­ã€‚ æ•°å­—ä¸åŒ…æ‹¬é—°ç§’å°†æ·»åŠ çš„åˆ»åº¦ã€‚ ä¾‹å¦‚ï¼Œ31241376000000000L çš„æ»´ç­”å€¼è¡¨ç¤ºæ—¥æœŸæ˜ŸæœŸäº”ï¼Œ0100 12:00:00 åˆå¤œã€‚ DateTime å€¼å§‹ç»ˆåœ¨æ˜¾å¼æˆ–é»˜è®¤æ—¥å†çš„ä¸Šä¸‹æ–‡ä¸­è¡¨ç¤ºã€‚
 å¤‡æ³¨

å¦‚æœä½¿ç”¨çš„è®¡æ—¶å‘¨æœŸå€¼è¦è½¬æ¢ä¸ºå…¶ä»–æ—¶é—´é—´éš”ï¼ˆå¦‚åˆ†é’Ÿæˆ–ç§’ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨ TimeSpan.TicksPerDayã€TimeSpan.TicksPerHourã€TimeSpan.TicksPerMinuteã€TimeSpan.TicksPerSecondæˆ– TimeSpan.TicksPerMillisecond å¸¸é‡æ¥æ‰§è¡Œè½¬æ¢ã€‚ ä¾‹å¦‚ï¼Œè‹¥è¦å°†æŒ‡å®šçš„åˆ»åº¦æ•°è¡¨ç¤ºçš„ç§’æ•°æ·»åŠ åˆ° DateTime å€¼çš„ Second éƒ¨åˆ†ï¼Œå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼ dateValue.Second + nTicks/Timespan.TicksPerSecondã€‚

ä¼ è¾“åˆ° COM åº”ç”¨ç¨‹åºçš„ DateTime å€¼ï¼Œç„¶åå°†å…¶ä¼ è¾“å›æ‰˜ç®¡åº”ç”¨ç¨‹åºã€‚ ä½† DateTime å€¼ä»…æŒ‡å®šæ—¶é—´ä¸ä¼šåƒé¢„æœŸçš„é‚£æ ·å¾€è¿”ã€‚

å¦‚æœåªå¾€è¿”æ—¶é—´ï¼ˆå¦‚ä¸‹åˆ3ç‚¹ï¼‰ï¼Œåˆ™æœ€ç»ˆæ—¥æœŸå’Œæ—¶é—´ä¸ºå…¬å…ƒ1899å¹´12æœˆ30æ—¥ åœ¨ä¸‹åˆ3:00ï¼Œè€Œä¸æ˜¯å…¬å…ƒ0001å¹´1æœˆ1æ—¥ ä¸‹åˆ3:00 åœ¨ä»…æŒ‡å®šæ—¶é—´æ—¶ï¼Œ.NET Framework å’Œ COM å°†å‡å®šä¸ºé»˜è®¤æ—¥æœŸã€‚ ä½†æ˜¯ï¼ŒCOM ç³»ç»Ÿå‡å®šåŸºå‡†æ—¥æœŸä¸ºå…¬å…ƒ1899å¹´12æœˆ30æ—¥ï¼Œè€Œ .NET Framework å‡è®¾åŸºå‡†æ—¥æœŸä¸ºå…¬å…ƒ0001å¹´1æœˆ1æ—¥ã€‚

å½“åªå°†æ—¶é—´ä» .NET Framework ä¼ é€’åˆ° COM æ—¶ï¼Œä¼šæ‰§è¡Œç‰¹æ®Šå¤„ç†ï¼Œå°†æ—¶é—´è½¬æ¢ä¸º COM ä½¿ç”¨çš„æ ¼å¼ã€‚ å¦‚æœä»…å°†æ—¶é—´ä» COM ä¼ é€’åˆ° .NET Frameworkï¼Œåˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºè¿™æ ·ä¼šæŸå1899å¹´12æœˆ30æ—¥æˆ–ä¹‹å‰çš„åˆæ³•æ—¥æœŸå’Œæ—¶é—´ã€‚ å¦‚æœæ—¥æœŸä» COM å¼€å§‹å¾€è¿”ï¼Œåˆ™ .NET Framework å’Œ COM å°†ä¿ç•™æ—¥æœŸã€‚


    var date1 = new DateTime(2008, 5, 1, 8, 30, 52);
    Console.WriteLine(date1);
    Console.WriteLine($"{dat1:d} {dat1:D} {dat1:t} {dat1:T}"); // 0001-01-01 0001å¹´1æœˆ1æ—¥ 0:00 0:00:00

    Dim dates As Date() = {#6/14/2014 6:32AM#, #7/10/2014 11:49PM#,
                      #1/10/2015 1:16AM#, #12/20/2014 9:45PM#,
                      #6/2/2014 3:14PM#}

    Console.WriteLine(DateTime.Now); // 2020-05-22 21:02:11
    Console.WriteLine(DateTime.Today); // 2020-05-22 0:00:00
    Console.WriteLine(DateTime.UtcNow); // 2020-05-22 13:02:11

    var dat1 = new DateTime();
    // The following method call displays 1/1/0001 12:00:00 AM.
    Console.WriteLine(dat1.ToString(System.Globalization.CultureInfo.InvariantCulture));
    // The following method call displays True.
    Console.WriteLine(dat1.Equals(DateTime.MinValue));

    var dateString = "5/1/2008 8:30:52 AM";
    DateTime date1 = DateTime.Parse(dateString,
                              System.Globalization.CultureInfo.InvariantCulture);
    var iso8601String = "20080501T08:30:52Z";
    DateTime dateISO8602 = DateTime.ParseExact(iso8601String, "yyyyMMddTHH:mm:ssZ",
                                    System.Globalization.CultureInfo.InvariantCulture);


ToString æ ¼å¼å­—ç¬¦

    using System;

    public class DateToStringExample
    {
       public static void Main()
       {
          DateTime dateValue = new DateTime(2008, 6, 15, 21, 15, 07);
          // Create an array of standard format strings.
          string[] standardFmts = {"d", "D", "f", "F", "g", "G", "m", "o",
                                   "R", "s", "t", "T", "u", "U", "y"};
          // Output date and time using each standard format string.
          foreach (string standardFmt in standardFmts)
             Console.WriteLine("{0}: {1}", standardFmt,
                               dateValue.ToString(standardFmt));
          Console.WriteLine();

          // Create an array of some custom format strings.
          string[] customFmts = {"h:mm:ss.ff t", "d MMM yyyy", "HH:mm:ss.f",
                                 "dd MMM HH:mm:ss", @"\Mon\t\h\: M", "HH:mm:ss.ffffzzz" };
          // Output date and time using each custom format string.
          foreach (string customFmt in customFmts)
             Console.WriteLine("'{0}': {1}", customFmt,
                               dateValue.ToString(customFmt));
       }
    }
    // This example displays the following output to the console:
    //       d: 6/15/2008
    //       D: Sunday, June 15, 2008
    //       f: Sunday, June 15, 2008 9:15 PM
    //       F: Sunday, June 15, 2008 9:15:07 PM
    //       g: 6/15/2008 9:15 PM
    //       G: 6/15/2008 9:15:07 PM
    //       m: June 15
    //       o: 2008-06-15T21:15:07.0000000
    //       R: Sun, 15 Jun 2008 21:15:07 GMT
    //       s: 2008-06-15T21:15:07
    //       t: 9:15 PM
    //       T: 9:15:07 PM
    //       u: 2008-06-15 21:15:07Z
    //       U: Monday, June 16, 2008 4:15:07 AM
    //       y: June, 2008
    //
    //       'h:mm:ss.ff t': 9:15:07.00 P
    //       'd MMM yyyy': 15 Jun 2008
    //       'HH:mm:ss.f': 21:15:07.0
    //       'dd MMM HH:mm:ss': 15 Jun 21:15:07
    //       '\Mon\t\h\: M': Month: 6
    //       'HH:mm:ss.ffffzzz': 21:15:07.0000-07:00


TimeSpan æ—¶é—´è·¨åº¦ï¼ŒWriteLine æ–¹æ³•ä¸­ï¼Œå‚æ•°é€—å·åæŒ‡å®šçš„æ ¼å¼ 32 è¡¨ç¤ºå³å¯¹é½ 32 ä¸ªå­—ç¬¦ç©ºé—´ï¼Œ-32 è¡¨ç¤ºå·¦å¯¹é½ï¼š

    // Define two dates.
    DateTime date1 = new DateTime(2010, 1, 1, 8, 0, 15);
    DateTime date2 = new DateTime(2010, 8, 18, 13, 30, 30);

    // Calculate the interval between the two dates.
    TimeSpan interval = date2 - date1;
    Console.WriteLine("{0} - {1} = {2}", date2, date1, interval.ToString());

    // Display individual properties of the resulting TimeSpan object.
    Console.WriteLine("   {0,32} {1,20}", "Value of Days Component:", interval.Days);
    Console.WriteLine("   {0,32} {1,20}", "Total Number of Days:", interval.TotalDays);
    Console.WriteLine("   {0,32} {1,20}", "Value of Hours Component:", interval.Hours);
    Console.WriteLine("   {0,32} {1,20}", "Total Number of Hours:", interval.TotalHours);
    Console.WriteLine("   {0,32} {1,20}", "Value of Minutes Component:", interval.Minutes);
    Console.WriteLine("   {0,32} {1,20}", "Total Number of Minutes:", interval.TotalMinutes);
    Console.WriteLine("   {0,32} {1,20:N0}", "Value of Seconds Component:", interval.Seconds);
    Console.WriteLine("   {0,32} {1,20:N0}", "Total Number of Seconds:", interval.TotalSeconds);
    Console.WriteLine("   {0,32} {1,20:N0}", "Value of Milliseconds Component:", interval.Milliseconds);
    Console.WriteLine("   {0,32} {1,20:N0}", "Total Number of Milliseconds:", interval.TotalMilliseconds);
    Console.WriteLine("   {0,32} {1,20:N0}", "Ticks:", interval.Ticks);

    // This example displays the following output:
    //       8/18/2010 1:30:30 PM - 1/1/2010 8:00:15 AM = 229.05:30:15
    //         Value of Days Component:                  229
    //            Total Number of Days:   229.22934027777777
    //        Value of Hours Component:                    5
    //           Total Number of Hours:    5501.504166666667
    //      Value of Minutes Component:                   30
    //         Total Number of Minutes:            330090.25
    //      Value of Seconds Component:                   15
    //         Total Number of Seconds:             19805415
    // Value of Milliseconds Component:                    0
    //    Total Number of Milliseconds:          19805415000
    //                           Ticks:      198054150000000


DateTime å±æ€§ï¼š

    Date        è·å–æ­¤å®ä¾‹çš„æ—¥æœŸéƒ¨åˆ†ã€‚
    Day     è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºçš„æ—¥æœŸä¸ºè¯¥æœˆä¸­çš„ç¬¬å‡ å¤©ã€‚
    DayOfWeek   è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºçš„æ—¥æœŸæ˜¯æ˜ŸæœŸå‡ ã€‚
    DayOfYear   è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºçš„æ—¥æœŸæ˜¯è¯¥å¹´ä¸­çš„ç¬¬å‡ å¤©ã€‚
    Hour        è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„å°æ—¶éƒ¨åˆ†ã€‚
    Kind        è·å–ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼æŒ‡ç¤ºç”±æ­¤å®ä¾‹è¡¨ç¤ºçš„æ—¶é—´æ˜¯åŸºäºæœ¬åœ°æ—¶é—´ã€åè°ƒä¸–ç•Œæ—¶ (UTC)ï¼Œè¿˜æ˜¯ä¸¤è€…çš†å¦ã€‚
    Millisecond è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„æ¯«ç§’éƒ¨åˆ†ã€‚
    Minute      è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„åˆ†é’Ÿéƒ¨åˆ†ã€‚
    Month       è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„æœˆä»½éƒ¨åˆ†ã€‚
    Now     è·å–ä¸€ä¸ª DateTime å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è®¾ç½®ä¸ºæ­¤è®¡ç®—æœºä¸Šçš„å½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼Œè¡¨ç¤ºä¸ºæœ¬åœ°æ—¶é—´ã€‚
    Second      è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„ç§’éƒ¨åˆ†ã€‚
    Ticks       è·å–è¡¨ç¤ºæ­¤å®ä¾‹çš„æ—¥æœŸå’Œæ—¶é—´çš„è®¡æ—¶å‘¨æœŸæ•°ã€‚
    TimeOfDay   è·å–æ­¤å®ä¾‹çš„å½“å¤©çš„æ—¶é—´ã€‚
    Today       è·å–å½“å‰æ—¥æœŸã€‚
    UtcNow      è·å–ä¸€ä¸ª DateTime å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è®¾ç½®ä¸ºæ­¤è®¡ç®—æœºä¸Šçš„å½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼Œè¡¨ç¤ºä¸ºåè°ƒé€šç”¨æ—¶é—´ (UTC)ã€‚
    Year        è·å–æ­¤å®ä¾‹æ‰€è¡¨ç¤ºæ—¥æœŸçš„å¹´ä»½éƒ¨åˆ†ã€‚

# =ğŸš© System.Math
https://docs.microsoft.com/zh-cn/dotnet/api/system.math

å‘½åç©ºé—´: System
ç¨‹åºé›†: System.Runtime.Extensions.dll

ä¸ºä¸‰è§’å‡½æ•°ã€å¯¹æ•°å‡½æ•°å’Œå…¶ä»–é€šç”¨æ•°å­¦å‡½æ•°æä¾›å¸¸æ•°å’Œé™æ€æ–¹æ³•ã€‚

    public static class Math

ç»§æ‰¿ Object -> Math

å­—æ®µ

    E   è¡¨ç¤ºè‡ªç„¶å¯¹æ•°çš„åº•ï¼Œå®ƒç”±å¸¸æ•° e æŒ‡å®šã€‚
    PI  è¡¨ç¤ºåœ†çš„å‘¨é•¿ä¸å…¶ç›´å¾„çš„æ¯”å€¼ï¼Œç”±å¸¸æ•° Ï€ æŒ‡å®šã€‚

æ–¹æ³• 

    Abs()   è¿”å›æ•°å­—çš„ç»å¯¹å€¼ã€‚
    Acos(Double)    è¿”å›ä½™å¼¦å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    Acosh(Double)   è¿”å›åŒæ›²ä½™å¼¦å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    Asin(Double)    è¿”å›æ­£å¼¦å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    Asinh(Double)   è¿”å›åŒæ›²æ­£å¼¦å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    Atan(Double)    è¿”å›æ­£åˆ‡å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    Atan2(Double, Double)   è¿”å›æ­£åˆ‡å€¼ä¸ºä¸¤ä¸ªæŒ‡å®šæ•°å­—çš„å•†çš„è§’åº¦ã€‚
    Atanh(Double)   è¿”å›åŒæ›²æ­£åˆ‡å€¼ä¸ºæŒ‡å®šæ•°å­—çš„è§’åº¦ã€‚
    BigMul(Int32, Int32)    ç”Ÿæˆä¸¤ä¸ª 32 ä½æ•°å­—çš„å®Œæ•´ä¹˜ç§¯ã€‚
    BitDecrement(Double)    è¿”å›å°äº x çš„ä¸‹ä¸€ä¸ªæœ€å°å€¼ã€‚
    BitIncrement(Double)    è¿”å›å¤§äº x çš„ä¸‹ä¸€ä¸ªæœ€å¤§å€¼ã€‚
    Cbrt(Double)    è¿”å›æŒ‡å®šæ•°å­—çš„ç«‹æ–¹æ ¹ã€‚
    Ceiling(Decimal)    è¿”å›å¤§äºæˆ–ç­‰äºæŒ‡å®šçš„åè¿›åˆ¶æ•°çš„æœ€å°æ•´æ•°å€¼ã€‚
    Ceiling(Double) è¿”å›å¤§äºæˆ–ç­‰äºæŒ‡å®šçš„åŒç²¾åº¦æµ®ç‚¹æ•°çš„æœ€å°æ•´æ•°å€¼ã€‚
    Clamp() è¿”å›é™åˆ¶åœ¨ value å’Œ min èŒƒå›´å†…ï¼ˆå«é¦–å°¾ï¼‰çš„ maxã€‚
    CopySign(Double, Double)    è¿”å›ä¸€ä¸ªå€¼ï¼Œå®ƒå…·æœ‰ x çš„å¤§å°å’Œ y çš„ç¬¦å·ã€‚
    Cos(Double) è¿”å›æŒ‡å®šè§’åº¦çš„ä½™å¼¦å€¼ã€‚
    Cosh(Double)    è¿”å›æŒ‡å®šè§’åº¦çš„åŒæ›²ä½™å¼¦å€¼ã€‚
    DivRem(Int32, Int32, Int32) è®¡ç®—ä¸¤ä¸ª 32 ä½æœ‰ç¬¦å·æ•´æ•°çš„å•†ï¼Œå¹¶é€šè¿‡è¾“å‡ºå‚æ•°è¿”å›ä½™æ•°ã€‚
    DivRem(Int64, Int64, Int64) è®¡ç®—ä¸¤ä¸ª 64 ä½æœ‰ç¬¦å·æ•´æ•°çš„å•†ï¼Œå¹¶é€šè¿‡è¾“å‡ºå‚æ•°è¿”å›ä½™æ•°ã€‚
    Exp(Double) è¿”å› e çš„æŒ‡å®šæ¬¡å¹‚ã€‚
    Floor(Decimal)  è¿”å›å°äºæˆ–ç­‰äºæŒ‡å®šå°æ•°çš„æœ€å¤§æ•´æ•°å€¼ã€‚
    Floor(Double)   è¿”å›å°äºæˆ–ç­‰äºæŒ‡å®šåŒç²¾åº¦æµ®ç‚¹æ•°çš„æœ€å¤§æ•´æ•°å€¼ã€‚
    FusedMultiplyAdd(Double, Double, Double)    è¿”å› (x * y) + zï¼Œèˆå…¥ä¸ºä¸€ä¸ªä¸‰å…ƒè¿ç®—ã€‚
    IEEERemainder(Double, Double)   è¿”å›ä¸€æŒ‡å®šæ•°å­—è¢«å¦ä¸€æŒ‡å®šæ•°å­—ç›¸é™¤çš„ä½™æ•°ã€‚
    ILogB(Double)   è¿”å›æŒ‡å®šæ•°å­—ä»¥ 2 ä¸ºåº•çš„æ•´æ•°å¯¹æ•°ã€‚
    Log(Double) è¿”å›æŒ‡å®šæ•°å­—çš„è‡ªç„¶å¯¹æ•°ï¼ˆåº•ä¸º eï¼‰ã€‚
    Log(Double, Double) è¿”å›æŒ‡å®šæ•°å­—åœ¨ä½¿ç”¨æŒ‡å®šåº•æ—¶çš„å¯¹æ•°ã€‚
    Log10(Double)   è¿”å›æŒ‡å®šæ•°å­—ä»¥ 10 ä¸ºåº•çš„å¯¹æ•°ã€‚
    Log2(Double)    è¿”å›æŒ‡å®šæ•°å­—ä»¥ 2 ä¸ºåº•çš„å¯¹æ•°ã€‚
    Max()   è¿”å›ä¸¤ä¸ªæ•°ä¸­è¾ƒå¤§çš„ä¸€ä¸ªã€‚
    Max(Decimal, De
    MaxMagnitude(Double, Double)    è¿”å›ä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å­—ä¸­çš„è¾ƒå¤§å€¼ã€‚
    Min()   è¿”å›ä¸¤ä¸ª 8 ä½æ— ç¬¦å·æ•´æ•°ä¸­è¾ƒå°çš„ä¸€ä¸ªã€‚
    MinMagnitude(Double, Double)    è¿”å›ä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å­—ä¸­çš„è¾ƒå°å€¼ã€‚
    Pow(Double, Double) è¿”å›æŒ‡å®šæ•°å­—çš„æŒ‡å®šæ¬¡å¹‚ã€‚
    Round(Decimal)  å°†å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°å€¼ï¼Œå¹¶å°†ä¸­ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„å¶æ•°ã€‚
    Round(Decimal, Int32)   å°†å°æ•°å€¼èˆå…¥åˆ°æŒ‡å®šæ•°é‡çš„å°æ•°ä½ï¼Œå¹¶å°†ä¸­ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„å¶æ•°ã€‚
    Round(Decimal, Int32, MidpointRounding) å°†å°æ•°å€¼èˆå…¥åˆ°æŒ‡å®šæ•°é‡çš„å°æ•°ä½ï¼Œå¹¶ä¸ºä¸­ç‚¹å€¼ä½¿ç”¨æŒ‡å®šçš„èˆå…¥è§„åˆ™ã€‚
    Round(Decimal, MidpointRounding)    å°†å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œå¹¶ä¸ºä¸­ç‚¹å€¼ä½¿ç”¨æŒ‡å®šçš„èˆå…¥è§„åˆ™ã€‚
    Round(Double)   å°†åŒç²¾åº¦æµ®ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°å€¼ï¼Œå¹¶å°†ä¸­ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„å¶æ•°ã€‚
    Round(Double, Int32)    å°†åŒç²¾åº¦æµ®ç‚¹å€¼èˆå…¥åˆ°æŒ‡å®šæ•°é‡çš„å°æ•°ä½ï¼Œå¹¶å°†ä¸­ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„å¶æ•°ã€‚
    Round(Double, Int32, MidpointRounding)  å°†åŒç²¾åº¦æµ®ç‚¹å€¼èˆå…¥åˆ°æŒ‡å®šæ•°é‡çš„å°æ•°ä½ï¼Œå¹¶ä¸ºä¸­ç‚¹å€¼ä½¿ç”¨æŒ‡å®šçš„èˆå…¥è§„åˆ™ã€‚
    Round(Double, MidpointRounding) å°†åŒç²¾åº¦æµ®ç‚¹å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œå¹¶ä¸ºä¸­ç‚¹å€¼ä½¿ç”¨æŒ‡å®šçš„èˆå…¥çº¦å®šã€‚
    ScaleB(Double, Int32)   è¿”å›æœ‰æ•ˆè®¡ç®—çš„ x * 2^nã€‚
    Sign()  è¿”å›è¡¨ç¤ºæ•°å€¼ç¬¦å·çš„æ•´æ•°ã€‚
    Sin(Double) è¿”å›æŒ‡å®šè§’åº¦çš„æ­£å¼¦å€¼ã€‚
    Sinh(Double)    è¿”å›æŒ‡å®šè§’åº¦çš„åŒæ›²æ­£å¼¦å€¼ã€‚
    Sqrt(Double)    è¿”å›æŒ‡å®šæ•°å­—çš„å¹³æ–¹æ ¹ã€‚
    Tan(Double) è¿”å›æŒ‡å®šè§’åº¦çš„æ­£åˆ‡å€¼ã€‚
    Tanh(Double)    è¿”å›æŒ‡å®šè§’åº¦çš„åŒæ›²æ­£åˆ‡å€¼ã€‚
    Truncate(Decimal)   è®¡ç®—ä¸€ä¸ªæ•°å­—çš„æ•´æ•°éƒ¨åˆ†ã€‚
    Truncate(Double)    è®¡ç®—æŒ‡å®šåŒç²¾åº¦æµ®ç‚¹æ•°çš„æ•´æ•°éƒ¨åˆ†ã€‚




