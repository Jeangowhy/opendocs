
# ğŸš© CTF PNG æ–‡ä»¶éšå†™æœ¯
- https://github.com/ReFirmLabs/binwalk
- http://www.libpng.org/pub/png/libpng-manual.txt
- BinWalkå®‰è£…å’Œå‘½ä»¤å‚æ•°è¯¦è§£ https://cloud.tencent.com/developer/article/1515285
- PNG Reference Library: libpng https://libpng.sourceforge.io/index.html
- PNG Specification: File Structure http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html
- CRC Algorithm http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html#CRC-algorithm
- A Painless Guide to CRC Error Detection Algorithms Ross Williams 1993 https://www.zlib.net/crc_v3.txt

éšå†™æ˜¯ä¸€ç§ä¿¡æ¯åŠ å¯†æŠ€æœ¯ï¼Œå¤ç½—é©¬å¤å…¸ä¸»ä¹‰è¯—äººå¥¥ç»´å¾·æå‡ºç”¨æ–°é²œç‰›å¥¶åœ¨ä¿¡ä¸Šä¹¦å†™ï¼Œä¸ä¼šç•™ä¸‹ç—•è¿¹ï¼Œä¹‹åå†æ²¾ä¸Šç…¤çš„ç°çƒ¬ï¼Œä¾¿èƒ½è¯»å–ä¿¡çš„å†…å®¹ã€‚å°†ç§˜å¯†ä¿¡æ¯é€šè¿‡å¯å…¬å¼€çš„è½½ä½“è¿›è¡Œä¼ é€’ï¼Œä¸”ä¸è¢«ç¬¬ä¸‰æ–¹å‘ç°ï¼Œè¿™å°±æ˜¯â€œéšå†™æœ¯â€ Steganographyï¼Œæ¥æºäºç‰¹é‡Œç‰¹ç±³ä¹Œæ–¯çš„ä¸€æœ¬è®²è¿°å¯†ç å­¦ä¸éšå†™æœ¯çš„è‘—ä½œ Steganographiaï¼Œè¯¥ä¹¦åæ¥æºäºå¤å¸Œè…Šè¯æ±‡ stegons å’Œ graphia å³â€œéšç§˜ä¹¦å†™â€ã€‚

éšå†™æœ¯æ˜¯éšè—ä¿¡æ¯çš„ä¸€ç§æŠ€æœ¯ï¼Œå®ƒå’ŒåŠ å¯†çš„åŒºåˆ«å°±åœ¨äºï¼Œå¯¹åŠ å¯†è€Œè¨€ï¼Œç¬¬ä¸‰æ–¹æ˜¯çŸ¥é“æ•°æ®è¢«åŠ å¯†çš„ï¼Œåªæ˜¯ä¸çŸ¥é“åŠ å¯†å‰æ•°æ®æ˜¯ä»€ä¹ˆæ ·ï¼Œéšå†™æœ¯åˆ™ä¾§é‡äºè®©äººæ— æ³•å¯Ÿè§‰æ•°æ®çš„å­˜åœ¨æ€§ã€‚

äººçœ¼å¯¹æ•°å­—å›¾åƒçš„æŸäº›åŒºåŸŸå¹¶ä¸æ•æ„Ÿï¼Œå›¾åƒä¸­è‹¥åªå‘ç”Ÿå¾®å°çš„å˜åŒ–ï¼Œä»…å‡­äººçœ¼å¾ˆéš¾åŒºåˆ†ï¼Œè¿™ç§ç‰¹æ€§è¢«ç§°ä¸ºäººç±»è§†è§‰æœ‰é™æ€§ï¼ŒåµŒå…¥å›¾åƒçš„éšå†™æœ¯æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ã€‚ç»å¤§å¤šæ•°çš„æ–‡æœ¬ã€å›¾åƒã€å¯†æ–‡æˆ–å…¶ä»–ä»»ä½•å½¢å¼çš„åª’ä½“éƒ½å¯ä»¥ç”Ÿæˆæ¯”ç‰¹æµåµŒå…¥åˆ°æ•°å­—å›¾åƒä¸­ã€‚

é€šè¿‡éŸ³é¢‘ä¹Ÿå¯ä»¥å®ç°éšå†™ï¼Œä¸€èˆ¬è—æœ‰æ‘©æ–¯ç”µç ï¼Œå°†ä¿¡æ¯ä¸éŸ³é¢‘æ··åˆåœ¨ä¸€èµ·ã€‚

å¸¸ç”¨å·¥å…·ï¼š

- Winhex äºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¾‘å·¥å…·ï¼›
- Stegsolve 
- Binwalk å¤šé‡è¿›äºŒè¿›æ–‡ä»¶æ‰«æå·¥å…·ï¼›
- dd äºŒè¿›åˆ¶æ–‡ä»¶è¯»å†™å‘½ä»¤ï¼›

ä»¥ PNG æ–‡ä»¶ä¸ºä¾‹ï¼Œç»“åˆ libpng åº“çš„æºä»£ç è§£æï¼Œæºä»£ç æ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ª example.c ç¤ºèŒƒç¨‹åºï¼Œæ¼”ç¤ºäº† PNG æ–‡ä»¶çš„è¯»å†™ã€‚

PNG æ–‡ä»¶å¼€å¤´æ˜¯ä¸€ä¸ª 8 å­—èŠ‚çš„ç­¾åï¼ŒåŒ…å« â€œPNGâ€ å­—ç¬¦æ ‡è®°ï¼š

    png_byte png_signature[8] = {137, 80, 78, 71, 13, 10, 26, 10};

```sh
seg000:0000000000000000                 db 89h
seg000:0000000000000001 aPng            db 'PNG',0Dh,0Ah
seg000:0000000000000006                 db 1Ah
seg000:0000000000000007                 db 0Ah
```

ä¸€èˆ¬è¯»å– PNG å›¾åƒï¼Œå…ˆéœ€è¦é€šè¿‡æ–‡ä»¶ç­¾åç¡®å®šæ˜¯ä¸€ä¸ª PNG æ–‡ä»¶ï¼Œç„¶åï¼Œç´§è·Ÿç€åˆå§‹åŒ– png_struct å’Œ png_info ä¸¤ä¸ªç»“æ„ä½“ï¼Œpng_struct æ˜¯å…³äº PNG æ–‡ä»¶åŠå…¶ç›¸å…³å±æ€§çš„ç»“æ„ï¼Œå¹¶ä¸ç›´æ¥è®¿é—®ï¼Œåªæ˜¯ç”¨äº libpng API å†…éƒ¨çš„ä¿¡æ¯ä¼ é€’ã€‚

éœ€è¦æ³¨æ„ï¼ŒPNG é‡‡ç”¨ MSB First é«˜ä½å…ˆè¡Œ Most Significant Bitï¼Œä¹Ÿç§°ä¸º network byte orderï¼ŒPNG æ–‡ä»¶ä¸­æ‰€æœ‰è¶…è¿‡ 1 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œé«˜ä½å­—èŠ‚æ”¾åœ¨å‰é¢ï¼Œå³ Big Endian å­—èŠ‚åºã€‚ä¸ä¹‹ç›¸å¯¹çš„æ˜¯ä½ä½å…ˆè¡Œ LSB Fristï¼ŒLeast Significant Bitã€‚


åé¢çš„æ•°æ®æŒ‰ç…§ç‰¹å®šç»“æ„ç»„ç»‡ï¼ŒåŒ…å« 3 ä¸ªä»¥ä¸Šçš„æ•°æ®å—ç»„æˆ(Chunk layout)ã€‚å‚è€ƒ PNG æ ¼å¼è§„èŒƒæ–‡æ¡£ç¬¬äºŒç« ï¼ŒData Representation æè¿°äº†æ–‡ä»¶ç»“æ„ã€‚

PNG å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„æ•°æ®å—ï¼Œä¸€ç§æ˜¯ç§°ä¸ºå…³é”®æ•°æ®å—(critical chunk)ï¼Œè¿™æ˜¯æ ‡å‡†çš„æ•°æ®å—ï¼Œå¦ä¸€ç§å«åšè¾…åŠ©æ•°æ®å—(ancillary chunks)ï¼Œè¿™æ˜¯å¯é€‰çš„æ•°æ®å—ã€‚

å…³é”®æ•°æ®å—æœ‰ 4 ç§ï¼Œæ¯ä¸ª PNG æ–‡ä»¶éƒ½å¿…é¡»åŒ…å«å®ƒä»¬ï¼ŒPNG è¯»å†™è½¯ä»¶ä¹Ÿéƒ½å¿…é¡»è¦æ”¯æŒè¿™äº›æ•°æ®å—ã€‚è™½ç„¶ PNG æ–‡ä»¶è§„èŒƒæ²¡æœ‰è¦æ±‚ PNG ç¼–è¯‘ç å™¨å¯¹å¯é€‰æ•°æ®å—è¿›è¡Œç¼–ç å’Œè¯‘ç ï¼Œä½†è§„èŒƒæå€¡æ”¯æŒå¯é€‰æ•°æ®å—ã€‚

å‚è€ƒ PNG æ ¼å¼è§„èŒƒæ–‡æ¡£ç½—åˆ—çš„å—å®šä¹‰ï¼š

- 4.1. Critical chunks
    - IHDR Image header
    - PLTE Palette
    - IDAT Image data
    - IEND Image trailer
- 4.2. Ancillary chunks
    - Transparency information
        - tRNS Transparency
    - Color space information
        - gAMA Image gamma
        - cHRM Primary chromaticities
        - sRGB Standard RGB color space
        - iCCP Embedded ICC profile
    - Textual information
        - tEXt Textual data
        - zTXt Compressed textual data
        - iTXt International textual data
    - Miscellaneous information
        - bKGD Background color
        - pHYs Physical pixel dimensions
        - sBIT Significant bits
        - sPLT Suggested palette
        - hIST Palette histogram
        - tIME Image last-modification time

PNG æ–‡ä»¶æ•°æ®å—çš„ç»“æ„ Chunk layoutï¼š

    |    åç§°    | å­—èŠ‚æ•° |                           è¯´æ˜                           |
    |------------|--------|----------------------------------------------------------|
    | Length     | 4å­—èŠ‚  | Chunk Data çš„é•¿åº¦                                        |
    | Chunk Type | 4å­—èŠ‚  | æ•°æ®å—ç±»å‹ç”± 4 ä¸ª ASCII å­—æ¯æŒ‡å®š                         |
    | Chunk Data | å˜é•¿   | å­˜å‚¨æŒ‰ç…§ Chunk Type æŒ‡å®šçš„æ•°æ®                           |
    | CRC        | 4å­—èŠ‚  | Cyclic Redundancy Check å¾ªç¯å†—ä½™æ ¡éªŒç ç”¨æ¥æ£€æµ‹æ˜¯å¦æœ‰é”™è¯¯ |

æ•°æ®å—çš„åå­—åŒ…å« 4 ä¸ªå­—ç¬¦ï¼Œå¤§å°å†™ä¸åŒå…·æœ‰ä¸åŒæ„ä¹‰ï¼Œå¦‚ BLOB å’Œ bLOb å…·æœ‰ä¸åŒåŠŸèƒ½ï¼Œå¯¹äºä¸€ä¸ª 8-bit çš„å­—ç¬¦ï¼Œbit 5 æ§åˆ¶å¤§å°å†™ï¼Œå¦‚ A 01000001 å’Œ a 01100001ã€‚

é‚£ä¹ˆè¿™å››ä¸ªå­—ç¬¦çš„å¤§å°å†™æ„ä¹‰å¦‚ä¸‹ï¼š

    | Ancillary bit    | bit 5 of first byte  | 0 = critical, 1 = ancillary.                          |
    | Private bit      | bit 5 of second byte | 0 = public, 1 = private.                              |
    | Reserved bit     | bit 5 of third byte  | Must be 0 in files conforming to this version of PNG. |
    | Safe-to-copy bit | bit 5 of fourth byte | 0 = unsafe to copy, 1 = safe to copy.                 |

ä¾‹å¦‚ï¼Œå—ç±»å‹åç§° bLOb å…·æœ‰ä»¥ä¸‹å±æ€§ä½ï¼š

   bLOb  <-- 32 bit chunk type code represented in text form
   ||||
   |||+- Safe-to-copy bit is 1 (lowercase letter; bit 5 is 1)
   ||+-- Reserved bit is 0     (uppercase letter; bit 5 is 0)
   |+--- Private bit is 0      (uppercase letter; bit 5 is 0)
   +---- Ancillary bit is 1    (lowercase letter; bit 5 is 1)

PNG æ ¼å¼å®šä¹‰çš„ 4 ä¸ªå…³é”®æ•°æ®å—ï¼š

- IHDR (header chunk)ï¼šæ–‡ä»¶å¤´æ•°æ®å—åŒ…å« PNG æ–‡ä»¶ä¸­å­˜å‚¨çš„å›¾åƒæ•°æ®çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶è¦ä½œä¸ºç¬¬ä¸€ä¸ªæ•°æ®å—å‡ºç°åœ¨ PNG æ•°æ®æµä¸­ï¼Œå…¨æ–‡ä»¶å”¯ä¸€ã€‚
- PLTE (palette chunk)ï¼šè°ƒè‰²æ¿æ•°æ®å—åŒ…å«ç´¢å¼•å½©è‰²å›¾åƒç›¸å…³çš„å½©è‰²å˜æ¢æ•°æ®ï¼Œè€Œä¸”è¦æ”¾åœ¨å›¾åƒæ•°æ®å—ä¹‹å‰ã€‚
- IDAT (image data chunk)ï¼šå›¾åƒæ•°æ®å—å­˜å‚¨å®é™…çš„æ•°æ®ï¼Œåœ¨æ•°æ®æµä¸­å¯åŒ…å«å¤šä¸ªè¿ç»­é¡ºåºçš„å›¾åƒæ•°æ®å—ã€‚
- IEND (image trailer chunk)ï¼šå›¾åƒç»“æŸæ•°æ®æ ‡è®° PNG æ–‡ä»¶æˆ–è€…æ•°æ®æµå·²ç»ç»“æŸï¼Œå¿…é¡»è¦æ”¾åœ¨æ–‡ä»¶çš„å°¾éƒ¨ã€‚

å‚è€ƒ libpng å¤´æ–‡ä»¶å®šä¹‰ï¼š

```cpp
/* Convenience macros. */
#define CHUNK(a,b,c,d) (((a)<<24)+((b)<<16)+((c)<<8)+(d))
#define CHUNK_IHDR CHUNK(73,72,68,82)
#define CHUNK_PLTE CHUNK(80,76,84,69)
#define CHUNK_IDAT CHUNK(73,68,65,84)
#define CHUNK_IEND CHUNK(73,69,78,68)
#define CHUNK_cHRM CHUNK(99,72,82,77)
#define CHUNK_gAMA CHUNK(103,65,77,65)
#define CHUNK_sBIT CHUNK(115,66,73,84)
#define CHUNK_sRGB CHUNK(115,82,71,66)

#define png_IDAT PNG_U32( 73,  68,  65,  84)
#define png_IEND PNG_U32( 73,  69,  78,  68)
#define png_IHDR PNG_U32( 73,  72,  68,  82)
#define png_PLTE PNG_U32( 80,  76,  84,  69)
```

é™¤äº†è¡¨ç¤ºæ•°æ®å—å¼€å§‹çš„ IHDR å¿…é¡»æ”¾åœ¨æœ€å‰é¢ï¼Œ è¡¨ç¤º PNG æ–‡ä»¶ç»“æŸçš„ IEND æ•°æ®å—æ”¾åœ¨æœ€åé¢ä¹‹å¤–ï¼Œå…¶ä»–æ•°æ®å—çš„å­˜æ”¾é¡ºåºæ²¡æœ‰é™åˆ¶ã€‚

ç´¢å¼•å½©è‰²å›¾åƒ indexed-color imageï¼Œæ˜¯ä¸€ç§èŠ‚çœå­˜å‚¨ç©ºé—´çš„æ ¼å¼ï¼Œå¯¹äºé‚£äº›è‰²å½©æ•°é‡æœ‰é™çš„å›¾åƒï¼Œé€šè¿‡è°ƒè‰²æ¿ä¿å­˜è‰²å½©å€¼ï¼Œè€Œåƒç´ ä¿å­˜ä¸€ä¸ªç´¢å¼•å€¼ï¼Œæ˜¾ç¤ºå›¾åƒæ—¶é€šè¿‡ç´¢å¼•å€¼è·å–åœ¨è°ƒæ¿ä¸­çš„å½©è‰²ã€‚è°ƒæ¿è¡¨é¡¹æ•°ç›®æœ‰ 256 ä¸ªï¼Œæ¯ä¸ªè°ƒæ¿é¡¹ä¿å­˜ä¸€ä¸ª 3 å­—èŠ‚çš„è‰²å½©å€¼ï¼Œå› æ­¤è°ƒè‰²æ¿æ•°æ®å—æœ€å¤§ä¸º 768 å­—èŠ‚ã€‚

çœŸå½©è‰² PNG æ•°æ®æµä¹Ÿå¯ä»¥æœ‰è°ƒè‰²æ¿æ•°æ®å—ï¼Œç›®çš„æ˜¯ä¾¿äºéçœŸå½©è‰²æ˜¾ç¤ºç¨‹åºç”¨å®ƒæ¥é‡åŒ–å›¾åƒæ•°æ®ï¼Œä»è€Œæ˜¾ç¤ºè¯¥å›¾åƒã€‚

PNG å…³é”®æ•°æ®å—ã€è¾…åŠ©æ•°æ®å—å’Œä¸“ç”¨å…¬å…±æ•°æ®å—(special-purpose public chunks)ç»¼åˆï¼š

    | æ•°æ®å—ç¬¦å· |               æ•°æ®å—åç§°               | å¤šæ•°æ®å— | å¯é€‰å¦ |        ä½ç½®é™åˆ¶        |
    |------------|----------------------------------------|----------|--------|------------------------|
    | IHDR       | æ–‡ä»¶å¤´æ•°æ®å—                           | å¦       | å¦     | ç¬¬ä¸€å—                 |
    | PLTE       | è°ƒè‰²æ¿æ•°æ®å—                           | å¦       | æ˜¯     | åœ¨ IDAT ä¹‹å‰           |
    | IDAT       | å›¾åƒæ•°æ®å—                             | æ˜¯       | å¦     | ä¸å…¶ä»– IDAT è¿ç»­         |
    | IEND       | å›¾åƒç»“æŸæ•°æ®                           | å¦       | å¦     | æœ€åä¸€ä¸ªæ•°æ®å—         |
    | cHRM       | primary chromaticities and white point | å¦       | æ˜¯     | åœ¨ PLTE å’Œ IDAT ä¹‹å‰   |
    | gAMA       | å›¾åƒ Î³ æ•°æ®å— image gamma              | å¦       | æ˜¯     | åœ¨ PLTE å’Œ IDAT ä¹‹å‰   |
    | sBIT       | æ ·æœ¬æœ‰æ•ˆä½æ•°æ®å— significant bits      | å¦       | æ˜¯     | åœ¨ PLTE å’Œ IDAT ä¹‹å‰   |
    | bKGD       | èƒŒæ™¯é¢œè‰²æ•°æ®å— background color        | å¦       | æ˜¯     | åœ¨ PLTE ä¹‹å IDAT ä¹‹å‰ |
    | hIST       | å›¾åƒç›´æ–¹å›¾æ•°æ®å— image histogram       | å¦       | æ˜¯     | åœ¨ PLTE ä¹‹å IDAT ä¹‹å‰ |
    | tRNS       | å›¾åƒé€æ˜æ•°æ®å— transparency            | å¦       | æ˜¯     | åœ¨ PLTE ä¹‹å IDAT ä¹‹å‰ |
    | oFFs       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | å¦       | æ˜¯     | åœ¨ IDAT ä¹‹å‰           |
    | pHYs       | physical pixel dimensions              | å¦       | æ˜¯     | åœ¨ IDAT ä¹‹å‰           |
    | sCAL       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | å¦       | æ˜¯     | åœ¨ IDAT ä¹‹å‰           |
    | tIME       | image last-modification time           | å¦       | æ˜¯     | æ— é™åˆ¶                 |
    | tEXt       | æ–‡æœ¬ä¿¡æ¯æ•°æ®å— textual data            | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |
    | zTXt       | å‹ç¼©æ–‡æœ¬æ•°æ®å— compressed textual data | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |
    | fRAc       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |
    | gIFg       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |
    | gIFt       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |
    | gIFx       | ä¸“ç”¨å…¬å…±æ•°æ®å—                         | æ˜¯       | æ˜¯     | æ— é™åˆ¶                 |

tEXt å’Œ zTXt æ•°æ®å—ä¸­çš„æ ‡å‡†å…³é”®å­—ï¼š

- `Title` å›¾åƒåç§°æˆ–è€…æ ‡é¢˜
- `Author` å›¾åƒä½œè€…å
- `Description` å›¾åƒè¯´æ˜
- `Copyright` ç‰ˆæƒå£°æ˜
- `CreationTime` åŸå›¾åˆ›ä½œæ—¶é—´
- `Software` åˆ›ä½œå›¾åƒä½¿ç”¨çš„è½¯ä»¶
- `Disclaimer` å¼ƒæƒ
- `Warning` å›¾åƒå†…å®¹è­¦å‘Š
- `Source` åˆ›ä½œå›¾åƒä½¿ç”¨çš„è®¾å¤‡
- `Comment` å„ç§æ³¨é‡Š

IHDR å—ä½œè€…æœ€é‡è¦çš„æ•°æ®å—ï¼Œæ˜¯ PNG æ–‡ä»¶å¤„ç†çš„ç¬¬ä¸€ä¸ªæ•°æ®å—ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼Œç»“åˆ Chunk layout å®šä¹‰å°±æ˜¯ IHDR åœ¨ PNG æ–‡ä»¶å‡ºç°çš„æ ·å­ï¼š

```cpp
typedef unsigned char      uint8_t;
typedef unsigned int       uint32_t;

typedef struct sIHDR {
    uint32_t Width;             // 4 bytes
    uint32_t Height;            // 4 bytes
    uint8_t  BitDepth;          // 1 byte
    uint8_t  ColorType;         // 1 byte
    uint8_t  CompressionMethod; // 1 byte
    uint8_t  FilterMethod;      // 1 byte
    uint8_t  InterlaceMethod;   // 1 byte
} IHDR;

typedef struct sChunkIHDR {
    uint32_t Length;
    uint32_t ChunkType;
    IHDR ChunkData_IHDR;
    uint32_t CRC;
} ChunkIHDR;
```

Color Type å­—èŠ‚æ ¹æ®æ¯”ç‰¹ä½è®¾ç½®å†³å®š PNG å›¾åƒåƒç´ ä½¿ç”¨ä»€ä¹ˆè‰²å½©ä»¥åŠè‰²å½©æ·±åº¦ï¼š


   | Type | Allowed Bit Depths |                         Interpretation                         |
   |------|--------------------|----------------------------------------------------------------|
   |    0 | 1,2,4,8,16         | Each pixel is a grayscale sample.                              |
   |    2 | 8,16               | Each pixel is an R,G,B triple.                                 |
   |    3 | 1,2,4,8            | Each pixel is a palette index; a PLTE chunk must appear.       |
   |    4 | 8,16               | Each pixel is a grayscale sample, followed by an alpha sample. |
   |    6 | 8,16               | Each pixel is an R,G,B triple, followed by an alpha sample.    |

- bit 0 ç½®ä½è¡¨ç¤ºä½¿ç”¨è°ƒæ¿ï¼›
- bit 1 ç½®ä½è¡¨ç¤ºä½¿ç”¨è‰²å½©å€¼ï¼›
- bit 2 ç½®ä½è¡¨ç¤ºä½¿ç”¨ alpha channelï¼›

å¯¹äºä¸€ä¸ª IHDR æ•°æ®å—ï¼ŒChunkIHDR.Length ä¸º 0DH å³ 13 ä¸ªå­—èŠ‚ï¼Œæ•´ä¸ª ChunkIHDR ä¸º 25 ä¸ªå­—èŠ‚ã€‚

å› ä¸º PNG ä½¿ç”¨ MSB Fristï¼Œä½¿ç”¨ IDA åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶æ—¶éœ€è¦é€‰æ‹© Big Endian ç±»å‹çš„ CPU æ‰èƒ½æ­£ç¡®æ˜¾ç¤ºæ•°æ®ã€‚

ç¤ºèŒƒä½¿ç”¨ PNG éšå†™ MPEG è§†é¢‘ï¼Œä¾‹å­ï¼šæ—¥æœ¬ç»¼è‰ºã€Šã‚ã–ã¨ãã¦ä½•ãŒæ‚ªã„ã®ã€‹ æœ‰ç‚¹å¿ƒæœºåˆå¦‚ä½• https://www.nfmovies.com/video/57933-0-12.html

```rust
00000000:  8950 4e47 0d0a 1a0a 0000 000d 4948 4452 0000 0001 0000 0001  :.PNG........IHDR........
00000018:  0806 0000 001f 15c4 8900 0000 0173 5247 4200 aece 1ce9 0000  :.............sRGB.......
00000030:  0004 6741 4d41 0000 b18f 0bfc 6105 0000 0009 7048 5973 0000  :..gAMA......a.....pHYs..
00000048:  1274 0000 1274 01de 661f 7800 0000 0d49 4441 5418 5763 f8ff  :.t...t..f.x....IDAT.Wc..
00000060:  ffff 7f00 09fb 03fd 0543 45ca 0000 0000 4945 4e44 ae42 6082  :.........CE.....IEND.B`.
00000078:  4740 1110 0042 f025 0001 c100 00ff 01ff 0001 fc80 1448 1201  :G@...B.%.............H..
00000090:  0646 466d 7065 6709 5365 7276 6963 6530 3177 7c43 caff ffff  :.FFmpeg.Service01w|C....
```

ä»æ•°æ®å¯ä»¥çœ‹åˆ°ï¼ŒIHDR å®šä¹‰äº†ä¸€ä¸ª 1x1 åƒç´ çš„å›¾ç‰‡ï¼ŒIEND ç»“æŸæ•°æ®å—åœ¨ 0x77 ä½ç½®ï¼Œåé¢çš„æ˜¯è§†é¢‘æ•°æ®ã€‚ä»è§†é¢‘æ ¼å¼çš„å¤´éƒ¨æ¥çœ‹ï¼Œå¹¶ä¸æ˜¯ mp4 è¿™ç±»å¸¸è§„æ ¼å¼ï¼Œå¯ä»¥çŒœæµ‹æ˜¯æµæ ¼å¼ï¼Œå®ƒç¡®å®æ˜¯å¸¸ç”¨çš„ MPEG2-TS å³ Transport Stream æ ¼å¼ã€‚

å¯ä»¥ä½¿ç”¨ dd å‘½ä»¤è¿›è¡Œ PNG å‰¥ç¦»ï¼š

    for VAR in `ls .`
    do
        echo $VAR
        dd bs=1 skip=119 if=$VAR of=$VAR.ts
    done


## âš¡ CRC - Cyclic Redundancy Check æ ¡éªŒç 
- é«˜ç­‰æ•°å­¦Â·ä¸Šå†Œ: ç¬¬ä¸ƒç‰ˆ åŒæµå¤§å­¦æ•°å­¦ç³» https://book4you.org/book/5589738/691ece
- é«˜ç­‰æ•°å­¦ ç¬¬å…­ç‰ˆ åŒæµå¤§å­¦æ•°å­¦ç³» https://book4you.org/book/4997322/0ec23c
- Contemporary Abstract Algebra Joseph A. Gallian https://book4you.org/book/3374622/f78616
- Advanced Modern Algebra Joseph J. Rotman https://book4you.org/book/439766/a9d5bc
- ã€é«˜ç­‰ä»£æ•°ã€‘ 04 - å¤šé¡¹å¼ç¯ https://www.cnblogs.com/edward-bian/p/12846742.html
- The art of computer programming. Vol.2. Seminumerical algorithms Knuth, Donald E https://book4you.org/book/2715013/77e0d4
- PNG CRC Algorithm http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html#CRC-algorithm
- A Painless Guide to CRC Error Detection Algorithms Ross Williams 1993 https://www.zlib.net/crc_v3.txt

ä¸ºäº†ç¡®ä¿æ•°æ®æ­£ç¡®æ€§ï¼ŒPNG é‡‡ç”¨äº†å¤æ‚åº¦ã€çº é”™ç­‰æ€§èƒ½ä¼˜äºæ ¡éªŒå’Œ CheckSum æˆ–å¥‡å¶æ ¡éªŒ Parity Check ç­‰æ ¡éªŒæ–¹å¼çš„ CRC(cyclic redundancy check) æ ¡éªŒç ã€‚

çºµå‘å†—ä½™æ ¡éªŒï¼ˆLongitudinal Redundancy Checkï¼ŒLRCï¼‰æ˜¯å¯¹å¥‡å¶æ ¡éªŒçš„çºµå‘æ‰©å±•å½¢å¼ï¼Œå…¶åªèƒ½æ£€æµ‹çºµå‘å¥‡æ•°ä¸ªé”™è¯¯ã€‚é€å­—èŠ‚å¥‡å¶æ ¡éªŒè®¡ç®—ï¼Œå°†æ•°æ®å­—çš„æ‰€æœ‰å­—èŠ‚è¿›è¡Œ XORï¼Œåˆ›å»ºä¸€ä¸ªå­—èŠ‚çš„ç»“æœï¼Œä¹Ÿç§°ä¸º XOR æ ¡éªŒå’Œã€‚

æœ€ç®€å•çš„ CheckSum æ˜¯å¯¹æ•°æ®çš„å€¼è¿›è¡Œæ±‚å’Œï¼Œä½†æ˜¯å¯„å­˜å™¨çš„æ¯”ç‰¹å®½åº¦æœ‰é™ï¼Œè¿›ä½è¶…å‡ºçš„å€¼å°±å¿½ç•¥ã€‚

ä¾‹å¦‚ä»¥ä¸‹ä¸€ä¸ªä¿¡æ¯ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œæ•°æ®å‡ºç°é”™è¯¯ï¼Œå°±ä¼šå¯¼è‡´ CheckSum ä¸æ•°æ®ä¸ä¸€è‡´ã€‚å½“ç„¶ï¼Œæ ¡éªŒç åœ¨ä¼ é€’çš„è¿‡ç¨‹å‡ºç°é”™è¯¯ä¹Ÿä¸€æ ·æœ‰é—®é¢˜ï¼š

    Message                    :  6 23  4
    Message with checksum      :  6 23  4 33
    Message after transmission :  6 27  4 33

ä½†æ˜¯æ ¡éªŒå’Œçš„æœ€å¤§é—®é¢˜ç±»ä¼¼äºå¥‡å¶æ ¡éªŒï¼Œå¯¹æ•°æ®çš„æ”¹å˜ä¸å¤Ÿæ•æ„Ÿã€‚

è®¾è®¡å†—ä½™ç çš„åŸåˆ™å°±æ˜¯ï¼šç”¨æœ€å°çš„ä»£ä»·ï¼Œæ£€æµ‹ï¼ˆçº æ­£ï¼‰æœ€å¤šçš„é”™è¯¯ã€‚

è¯„ä»·è¾ƒéªŒæ–¹æ³•çš„æŒ‡æ ‡ï¼š

- WIDTH: å¯„å­˜å™¨çš„å®½åº¦ï¼Œè¦æœ‰è¶³å¤Ÿçš„ bit æ¥å®¹é”™ã€‚
- CHAOS: ä¸€ä¸ªæ±‚å€¼å…¬å¼ï¼Œè¦æœ‰è¶³å¤Ÿçš„éšæœºï¼Œè¾“å…¥æ•°æ®è¦å°½å¯èƒ½å½±å“åˆ°å¯„å­˜å™¨çš„æ‰€æœ‰ bitã€‚

ä»¥ CRC çš„ç®—æ³•ä¸ºä¾‹ï¼ŒXOR æ˜¯ CRC çš„åŸºæœ¬ç®—æ³•ã€‚CRC è®¡ç®—åŸç†å°±æ˜¯å°†è¾“å…¥æ¯”ç‰¹æµå½“ä½œä¸€ä¸ªå·¨å¤§çš„æ•°ï¼Œä½œä¸ºè¢«é™¤æ•°å»é™¤ä¸€ä¸ªå€¼ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ªä½™æ•°ã€‚å°†è¿™ä¸ªä½™æ•°é™„åŠ åœ¨åŸå§‹æ•°æ®æœ«å°¾ï¼Œä½¿å¾—å®ƒå¯ä»¥è¢«æ•´é™¤ï¼Œè¿™æ®µé™„åŠ çš„å†—ä½™ç å°±æ˜¯æ‰€è°“çš„ CRC æ ¡éªŒç ã€‚è¾“å…¥æ¯”ç‰¹æµçœ‹ä½œå¤šé¡¹å¼çš„ç³»æ•°ï¼Œè®¾å®šä¸€ä¸ªå¤šé¡¹å¼ä½œä¸ºé™¤æ•°ã€‚å‘é€æ–¹éœ€è¦åœ¨æ•°æ®æµæœ«å°¾åŠ ä¸Š CRC å†—ä½™ç ï¼Œä½¿å¾—ç»„åˆåçš„æ–°æ•°æ®æµèƒ½å¤Ÿæ•´é™¤ã€‚æ¥æ”¶æ–¹å¯¹æ•°æ®åšé™¤æ³•è®¡ç®—ä½™æ•°ï¼Œå¦‚æœä½™æ•°ä¸ä¸º 0ï¼Œå°±è¯´æ˜æœ‰é”™è¯¯å‘ç”Ÿã€‚

å¦‚ä½•è®¾è®¡å¤šé¡¹å¼ï¼Œå°±æ˜¯é™¤æ•°çš„é€‰æ‹©æ˜¯éå¸¸æœ‰è®²ç©¶çš„ï¼Œå¦‚æœä½ çš„å¤šé¡¹å¼é€‰æ‹©å¾ˆæ„šè ¢ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä½ çš„æ£€æŸ¥èŒƒå›´å¯èƒ½åªåœ¨æœ€åå‡ ä½ã€‚

CRC å…·æœ‰çº¿æ€§çš„æ€§è´¨ï¼Œé€‚åˆç”¨æ¥â€œå¯¹æŠ—è‡ªç„¶â€ï¼Œå³æ’é™¤éšæœºå¹²æ‰°ï¼Œä½†å¹¶ä¸é€‚åˆé˜²å¾¡æ¶æ„çš„äººä¸ºä¿®æ”¹ã€‚æ‰€ä»¥ CRC è¢«ç”¨äºé€šä¿¡ï¼Œè€Œä¸æ˜¯ç½‘ç»œå®‰å…¨é¢†åŸŸã€‚

è¾“å…¥æ•°æ® bit å¤§äºå¯„å­˜å™¨ï¼Œé‚£ä¹ˆéœ€è¦å¯¹ XOR çš„é€»è¾‘è¿ç®—è¿›è¡Œæ‰©å±•ã€‚

ä¾‹å¦‚ï¼Œæ™®é€šçš„é™¤æ³• 1599/173 å¾—åˆ°ä½™æ•°æ˜¯ 2ï¼š

              ...0000010101101 = 00AD =  173 = QUOTIENT
             ____-___-___-___-
    9= 1001 ) 0000011000010111 = 0617 = 1559 = DIVIDEND
    DIVISOR   000001100..,.,,,
                   1001..,.,,,
                   ====..,.,,,
                    0110.,.,,,
                     1001,.,,,
                     ====,.,,,
                       1110,,,
                       1001,,,
                       ====,,,
                        1011,,
                        1001,,
                        ====,,
                          1011
                          1001
                          ====
                          0010 = 02 = 2 = REMAINDER

å°½ç®¡è¾“å…¥æ¶ˆæ¯çš„æ¯ä¸€ä½å¯¹å•†çš„å½±å“å¹¶ä¸æ˜¯é‚£ä¹ˆæ˜¾è‘—ï¼Œä½†åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œ4 ä½çš„ä½™æ•°ä¼šå—åˆ°å¾ˆå¤§çš„å½±å“ï¼Œå¦‚æœå‘æ¶ˆæ¯ä¸­æ·»åŠ æ›´å¤šçš„å­—èŠ‚ï¼Œå³è¢«é™¤æ•°æœ‰ä¸€ç‚¹æ”¹å˜ï¼Œä½™æ•°å¯èƒ½ä¼šå‘ç”Ÿæ ¹æœ¬æ€§çš„å˜åŒ–ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆé™¤æ³•åœ¨åŠ æ³•ä¸èµ·ä½œç”¨çš„åœ°æ–¹èµ·ä½œç”¨ã€‚

CRC ä½¿ç”¨çš„é™¤æ³•ä¸æ™®é€šçš„åè¿›åˆ¶é™¤æ³•ä¸åŒï¼Œå®ƒæ˜¯æ¨¡ 2 é™¤æ³•ï¼Œpolynomial arithmetic mod 2ã€‚åŸºäºæœ‰é™åŸŸ GF(2) çš„å¤šé¡¹å¼ç¯ï¼Œå³é™¤ä»¥ 2 åŒä½™çš„å¤šé¡¹å¼ç¯ã€‚

å¿˜è®°é™¤æ³•æ¶‰åŠçš„æ¦‚å¿µï¼Œç°åœ¨ç”¨å¤šé¡¹å¼çš„è§’åº¦æ¥çœ‹ä¸€ä¸ªæ•°ï¼Œå‡è®¾ï¼Œä¸€ä¸ªæ•° 23 å¯¹åº”äºŒè¿›åˆ¶ 10111ï¼Œå®ƒçš„å¤šé¡¹å¼è¡¨è¾¾å¦‚ä¸‹ï¼š

```sh
# polynomial of 10111
1*x^4 + 0*x^3 + 1*x^2 + 1*x^1 + 1*x^0
# or, more simply:
x^4 + x^2 + x^1 + x^0
```

åˆ©ç”¨è¿™æ ·æŠ½è±¡çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¦å¤„ç†çš„ä¿¡æ¯æ•°æ®å³è¢«é™¤æ•°ï¼Œè¿˜æœ‰é™¤æ•°ã€å•†ã€ä½™æ•°çš„å„ä¸ª bit éƒ½çœ‹å‡ºæ˜¯å¤šé¡¹å¼çš„ç³»æ•°ã€‚

ä»¥ä¸‹æ¼”ç¤ºç”¨å¤šé¡¹å¼è®¡ç®— 1101 ä¸ 1011 ç›¸ä¹˜ï¼š

    (x^3 + x^2 + x^0)(x^3 + x^1 + x^0)
    = (x^6 + x^4 + x^3
     + x^5 + x^3 + x^2
     + x^3 + x^1 + x^0) = x^6 + x^5 + x^4 + 3*x^3 + x^2 + x^1 + x^0

ä¸ºäº†å¾—åˆ°æ­£ç¡®ç­”æ¡ˆï¼Œæ¥ä¸‹æ¥å°±éœ€è¦å‡è®¾ x æ˜¯ 2ï¼Œè¿™æ ·å°±ä¼šåœ¨ `3*x^3` è¿™é‡Œäº§ç”Ÿè¿›ä½ï¼Œå¾—åˆ°ï¼š

    = x^7 + x^3 + x^2 + x^1 + x^0

å› ä¸ºäºŒè¿›åˆ¶ä¸èƒ½è¡¨ç¤ºç³»æ•°ä¸­çš„ 3ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½è¡¨ç¤º 2ï¼Œè¿™ä½¿å…¶å®ƒé¡¹ä¹Ÿå‘ç”Ÿè¿›ä½ã€‚

è¿™åªæ˜¯å¹³å¸¸çš„ç®—æœ¯è¿ç®—ï¼Œé™¤äº†åº•æ•°æ˜¯æŠ½è±¡çš„ï¼Œè¿ç®—è¿˜æ˜¯æ˜¾å¼çš„ã€‚è¿™æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ

å…³é”®æ˜¯ï¼Œå‡è®¾ä¸çŸ¥é“ x æ˜¯ä»€ä¹ˆï¼Œå°±ä¸èƒ½æ‰§è¡Œè¿›ä½ï¼Œé‚£ä¹ˆ `3*x^3` å’Œ `x^4 + x^3` ä¸€æ ·ã€‚

åœ¨çœŸå®çš„å¤šé¡¹å¼è¿ç®—ä¸­ï¼Œç³»æ•°é—´çš„å…³ç³»æ˜¯æœªçŸ¥çš„ï¼Œéœ€è¦å¼ºè°ƒæ¯ä¸ªå¹‚çº§çš„ç³»æ•°ï¼Œ`x^2` å’Œ `x^3` çš„ç³»æ•°æ˜¯å®Œå…¨ä¸åŒçš„ç±»å‹ã€‚

é€šè¿‡æŠŠå„ä¸ªå¹‚çº§çš„ç³»æ•°ç›¸äº’éš”ç¦»å¼€æ¥ï¼Œæ•°å­¦å®¶ä»¬é€šè¿‡æ”¹å˜ç³»æ•°ä½œç”¨ï¼Œæƒ³å‡ºäº†å„ç§å„æ ·çš„çš„å¤šé¡¹å¼è¿ç®—è§„åˆ™ã€‚è¿™äº›è§„åˆ™ä¸­çš„ä¸€ç§ï¼Œä¸ä¸»é¢˜å¾ˆæœ‰å…³ç³»ï¼Œå®ƒå°±æ˜¯å¤šé¡¹å¼ç³»æ•°æ¨¡ 2 é™¤æ³•è¿ç®—ï¼Œå³æ‰€æœ‰çš„ç³»æ•°é€šè¿‡å¯¹ 2 å–æ¨¡è·å¾—ï¼Œæ‰€æœ‰çš„ç³»æ•°é 0 å³ 1ï¼Œä¸è€ƒè™‘è¿›ä½ï¼Œèˆå¼ƒè¿›ä½ã€‚

å¦‚æœæŒ‰é€šå¸¸çš„å¤šé¡¹å¼è¿ç®—è§„åˆ™ï¼Œ`3*x^3` ä¼šåœ¨äºŒè¿›åˆ¶äº§ç”Ÿè¿›ä½ï¼Œè€Œåœ¨ "polynomial
arithmetic mod 2" ç®—æ³•ä¸­ï¼Œå‰é¢çš„è¿ç®—å°†å¾—åˆ°ä»¥ä¸‹ç»“æœï¼Œæ‰€æœ‰ç³»æ•°è¿›è¡Œ Mod 2 è¿ç®—ä¸è€ƒè™‘è¿›ä½ï¼š

    = x^6 + x^5 + x^4 + x^3 + x^2 + x^1 + x^0

å› æ­¤ï¼ŒCRC ä¸­é‡‡ç”¨çš„å¤šé¡¹å¼ç®—æœ¯å°±æ˜¯æ²¡æœ‰è¿›ä½çš„æ¨¡ 2 äºŒè¿›åˆ¶ç®—æœ¯ã€‚è¿™ç§ç®—æ³•è¿›è¡Œæ•°å€¼çš„åŠ å‡ï¼Œå°±æ˜¯ XOR è¿ç®—ã€‚

        10011011        10011011
       +11001010       -11001010
        --------        --------
        01010001        01010001
        --------        --------

å¼•ç”¨é«˜å¾·çº³ The Art of Computer Programming (TAOCP) Volume 2 - 4.6. Polynomial Arithmetic:

>   "The reader should note the similarity between polynomial
>   arithmetic and multiple-precision arithmetic (Section 4.3.1), where
>   the radix b is substituted for x. The chief difference is that the
>   coefficient u_k of x^k in polynomial arithmetic bears little or no
>   relation to its neighboring coefficients x^{k-1} [and x^{k+1}], so
>   the idea of "carrying" from one place to another is absent. In fact
>   polynomial arithmetic modulo b is essentially identical to multiple
>   precision arithmetic with radix b, except that all carries are
>   suppressed."

æœ‰äº†å‰é¢çš„ CRC åŠ å‡è¿ç®—ï¼Œå°±å¯ä»¥è¿›è¡Œ CRC ä¹˜é™¤è¿ç®—ï¼Œä¹˜æ³•ç›¸å½“å¤šæ¬¡åŠ æ³•ï¼Œé™¤æ³•ç›¸å½“äºå¤šæ¬¡å‡æ³•ä¸”å¯èƒ½æœ‰ä¸€ä¸ªä½™æ•°ï¼š

        1101
      x 1011
        ----
        1101
       1101.
      0000..
     1101...
     -------
     1111111  Note: The sum uses CRC addition
     -------

If a number A is a multiple of B then what this means in CRC
arithmetic is that it is possible to construct A from zero by XORing
in various shifts of B. For example, if A was 0111010110 and B was 11,
we could construct A from B as follows:

                  0111010110
                = .......11.
                + ....11....
                + ...11.....
                  .11.......

However, if A is 0111010111, it is not possible to construct it out of
various shifts of B (can you see why? - see later) so it is said to be
not divisible by B in CRC arithmetic.

Thus we see that CRC arithmetic is primarily about XORing particular
values at various shifting offsets.


ä»¥ä¸‹æ¼”ç¤ºä¸€ä¸ª 4-bit å¯„å­˜å™¨å®½åº¦çš„ CRC è¿ç®—ï¼Œå¤šé¡¹å¼æœ‰ 5 é¡¹ï¼Œæœ€é«˜ä½çœç•¥ï¼Œæœ€é«˜æ¬¡æ•°æŒ‡å®šäº†å¯„å­˜å™¨çš„å®½åº¦ã€‚

    Original message                : 1101011011
    Poly                            :      10011
    Message after appending W zeros : 11010110110000
    Message after appending CRC     : 11010110111110

ç°åœ¨ç»™è¾“å…¥æ•°æ®è¡¥ä¸Šåç¼€ 0000 å³å¯„å­˜å™¨å®½åº¦çš„é›¶å€¼ï¼Œå¹¶è¿›è¡Œ CRC é™¤æ³•è¿ç®—æ±‚ä½™æ•°ï¼š

                1100001010 = Quotient (nobody cares about the quotient)
           _______________
    10011 ) 11010110110000 = Augmented message (1101011011 + 0000)
    =Poly   10011,,.,,....
            -----,,.,,....
             10011,.,,....
             10011,.,,....
             -----,.,,....
              000010110...
                  10011...
                  -----...
                   010100.
                    10011.
                    -----.
                      1110 = Remainder = THE CHECKSUM!!!!

ç»“æœå¾—åˆ°çš„å•†æ²¡æœ‰ç”¨é€”ï¼Œä¸¢å¼ƒï¼Œä½™æ•°ä½œä¸º CRC æ ¡éªŒç é™„åŠ äºæ•°æ®åé¢ã€‚

æ¥æ”¶æ–¹æ ¡éªŒæ•°æ®æœ‰ä¸¤ç§é€‰æ‹©ï¼š

- å°†ä¿¡æ¯ä¸æ ¡éªŒç åˆ†ç¦»ï¼Œå¹¶æŒ‰å¯„å­˜å™¨å®½åº¦åç¼€ 0ï¼Œå†è®¡ç®—ä½™æ•°è¿›è¡Œæ¯”å¯¹ï¼›
- ç›´æ¥ CRC é™¤æ³•è¿ç®—ï¼Œç»“æœä¸ºé›¶è¡¨ç¤ºæ•°æ®æ— è¯¯ã€‚

ç»å…¸ CRC ç®—æ³•æ­¥éª¤ï¼š

- é€‰æ‹©ä¸€ä¸ª W å®½åº¦çš„å¤šé¡¹å¼ Gï¼›
- åç¼€ç›¸åº”å®½åº¦çš„ â€œ0" åˆ°æ•°æ®æœ«ç«¯ï¼Œå¾—åˆ° Mï¼›
- ç”¨ M é™¤ä»¥ Gï¼Œä½¿ç”¨ CRC ç®—æ³•ï¼Œæ±‚å¾—ä½™æ•°ä½œä¸ºæ ¡éªŒç é™„åŠ äºæ•°æ®æœ«ç«¯å‘é€ç»™æ¥æ”¶æ–¹ã€‚

ç®€å•çš„ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼Œå°†æ•°æ®å½“ä½œ bit æµå¤„ç†å¯ä»¥é¿å…ä½¿ç”¨é™¤æ³•ï¼Œä»¥é¦–å­—èŠ‚çš„ most significant bit(MSB) å³æœ€é«˜æ¯”ç‰¹ä½å¼€å§‹ï¼š

       Load the register with zero bits.
       Augment the message by appending W zero bits to the end of it.
       While (more message bits)
          Begin
          Shift the register left by one bit, reading the next bit of the
             augmented message into register bit position 0.
          If (a 1 bit popped out of the register during step 3)
             Register = Register XOR Poly.
          End
       The register now contains the remainder.

CRC å®é™…è®¡ç®—é€šå¸¸é‡‡ç”¨é¢„è®¡ç®—è¡¨å®ç°ï¼ŒTable-Driven Implementationsï¼ŒæŸ¥è¡¨å¤§å¤§åŠ å¿«äº†è®¡ç®—é€Ÿåº¦ã€‚CRC é€šå¸¸å¯èƒ½æ˜¯ç”¨ç¡¬ä»¶ç§»ä½å¯„å­˜å™¨å®ç°çš„ï¼Œåœ¨è½¯ä»¶å®ç°ä¸­ï¼Œä¹Ÿå¸¸ä¹ æƒ¯ç”¨å¯„å­˜å™¨è¡¨ç¤ºã€‚

PNG å›¾ç‰‡çš„ CRC ç æ˜¯å¯¹ Chunk Type å’Œ Chunk Data è®¡ç®—å¾—åˆ°çš„ï¼ŒCRC-32 ç®—æ³•å®šä¹‰åœ¨ ISO 3309 å’Œ ITU-T V.42ï¼Œå…¶å€¼æŒ‰ä¸‹é¢çš„å¤šé¡¹å¼è¿›è¡Œè®¡ç®—ï¼š

    x^32 + x^26 + x^23 + x^22 + x^16 + x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x + 1

    0x104C11DB7

32-bit çš„ CRC å¯„å­˜å™¨åˆå§‹åŒ–ä¸ºå…¨ 1ï¼Œç„¶åä»æœ€ä½æœ‰æ•ˆä½åˆ°æœ€é«˜æœ‰æ•ˆä½å¤„ç†æ¯ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚å¤„ç†å®Œæ‰€æœ‰çš„æ•°æ®å­—èŠ‚åï¼ŒCRC å¯„å­˜å™¨å€¼æŒ‰ä½åè½¬ã€‚æ­¤å€¼æŒ‰ MSB First ä¼ è¾“å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚ä¸ºäº†åˆ†æˆå­—èŠ‚å’Œæ’åºï¼ŒCRC çš„æœ€ä½æœ‰æ•ˆä½è¢«å®šä¹‰ä¸º x^31 é¡¹çš„ç³»æ•°ã€‚

ä»¥ CRC-16 ä¸ºä¾‹ï¼Œ CRC-16 ç ç”±ä¸¤ä¸ªå­—èŠ‚æ„æˆï¼Œåœ¨å¼€å§‹æ—¶ CRC å¯„å­˜å™¨çš„æ¯ä¸€ä½éƒ½é¢„ç½®ä¸º 1ï¼Œç„¶åæŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

- æŠŠ CRC å¯„å­˜å™¨ä¸ 8-bit çš„æ•°æ®è¿›è¡Œå¼‚æˆ– XORï¼›
- å¯¹ CRC å¯„å­˜å™¨ä»é«˜åˆ°ä½è¿›è¡Œç§»ä½ï¼Œæœ€é«˜ä½ MSB è¡¥é›¶ï¼›
- è¢«ç§»å‡º CRC å¯„å­˜å™¨çš„æœ€ä½ä½ LSB å¦‚æœä¸º 1ï¼Œåˆ™å°†å¯„å­˜å™¨ä¸é¢„å®šä¹‰çš„å¤šé¡¹å¼è¿›è¡Œå¼‚æˆ–ï¼›
- é‡å¤ç”±é«˜è‡³ä½çš„ç§»ä½æ“ä½œ 8 æ¬¡ï¼Œç¬¬ä¸€ä¸ª 8-bit æ•°æ®å¤„ç†å®Œæ¯•ï¼›
- å†å°† CRC å¯„å­˜å™¨çš„å€¼ä¸ä¸‹ä¸€ä¸ª 8-bit æ•°æ®å¼‚æˆ–ï¼Œå¹¶é‡å¤å‰é¢çš„æ“ä½œï¼Œæ‰€æœ‰çš„æ•°æ®å¤„ç†å®Œæˆåï¼ŒCRC å¯„å­˜å™¨å†…çš„å€¼å³ä¸ºæœ€ç»ˆå€¼ã€‚

CRC-16 ä½¿ç”¨çš„å¤šé¡¹å¼ä¸å¯¹åº”å€¼ï¼š

    x^16 + x^15 + x^2 + 1

    0X18005

```cpp
unsigned short crc16(unsigned short crc, unsigned char *p, int len)
{
    while (len--)
       crc = (crc >> 8) ^ crctab[(crc ^ *p++) & 0xff];
    return crc;
}
```




# ğŸš© CTF å¤ºæ——èµ›
- çœ‹é›ª CTF https://ctf.pediy.com/
- çœ‹é›ª CTF é¢˜åº“ https://ctf.pediy.com/itembank.htm
- çœ‹é›ª CTF 2019 https://ctf.pediy.com/game-details-10.htm
- çœ‹é›ª 2016CrackMe æ”»é˜²å¤§èµ› https://ctf.pediy.com/game-list-1.htm
- XCTF è”èµ› https://www.xctf.org.cn/xctf/2020/
- Information Security with HelmetJS https://www.freecodecamp.org/learn/information-security/#information-security-with-helmetjs

CTF - Capture The Flag æœ¬æ¥æ˜¯è¥¿æ–¹çš„ä¸€ç§ä¼ ç»Ÿè¿åŠ¨ã€‚åœ¨æ¯”èµ›ä¸Šä¸¤å†›ä¼šäº’ç›¸äº‰å¤ºæ——å¸œï¼Œå½“æœ‰ä¸€æ–¹çš„æ——å¸œå·²è¢«æ•Œå†›å¤ºå–ï¼Œå°±ä»£è¡¨äº†é‚£ä¸€æ–¹çš„æˆ˜è´¥ã€‚

ä¿¡æ¯å®‰å…¨é¢†åŸŸçš„ CTF æ˜¯è¯´ï¼Œé€šè¿‡å„ç§æ”»å‡»æ‰‹æ³•ï¼Œè·å–æœåŠ¡å™¨åå¯»æ‰¾æŒ‡å®šçš„å­—æ®µï¼Œæˆ–è€…æ–‡ä»¶ä¸­æŸä¸€ä¸ªå›ºå®šæ ¼å¼çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå«åš flagï¼Œå…¶å½¢å¼ä¸€èˆ¬ä¸º flag{xxxxxxxx}ï¼Œæäº¤åˆ°è£åˆ¤æœºå°±å¯ä»¥å¾—åˆ†ã€‚

çœ‹é›ª CTF æ˜¯åœˆå†…çŸ¥ååº¦æœ€é«˜çš„æŠ€æœ¯ç«æŠ€ä¹‹ä¸€ï¼Œä»åŸ CrackMe æ”»é˜²å¤§èµ›ä¸­å‘å±•è€Œæ¥ï¼Œé‡‡å–çº¿ä¸Š PK çš„æ–¹å¼ï¼Œè§„åˆ™è®¾ç½®ä¸¥æ ¼å‘¨å…¨ï¼Œé¢˜ç›®æ¶µç›– Windowsã€Androidã€iOSã€Pwnã€æ™ºèƒ½è®¾å¤‡ã€Web ç­‰ä¼—å¤šé¢†åŸŸã€‚   

çœ‹é›ª CTF æ¯”èµ›åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- ç¬¬ä¸€é˜¶æ®µæ˜¯é˜²å®ˆç¯‡ï¼Œé˜²å®ˆæ–¹æ ¹æ®æ¯”èµ›è¦æ±‚åˆ¶ä½œé¢˜ç›®ï¼Œæ ¹æ®é¢˜ç›®è¢«ç ´è§£çš„æ—¶é—´æ’åï¼Œè¢«ç ´è§£æ—¶é—´é•¿è€…èƒœå‡ºã€‚
- ç¬¬äºŒé˜¶æ®µä¸ºæ”»å‡»ç¯‡ï¼Œæ”»å‡»ç¬¬ä¸€é˜¶æ®µçš„é¢˜ç›®ï¼Œæ ¹æ®æ”»å‡»æˆåŠŸçš„æ—¶é—´ä¸é¢˜ç›®æ’åï¼Œç ´è§£æ—¶é—´çŸ­ä¸”ç ´è§£é¢˜ç›®æ•°å¤šè€…èƒœã€‚

æ—¢ç»™äº†é˜²å®ˆæ–¹è¶³å¤Ÿçš„æ–½å±•ç©ºé—´ï¼Œä¹Ÿé¿å…è¿‡åº¦æµªè´¹æ”»å‡»æ–¹çš„æ—¶é—´ã€‚ä»æ”»é˜²ä¸¤ä¸ªè§’åº¦çœ‹ï¼Œéƒ½æ˜¯ä¸ªéš¾å¾—çš„ç«æŠ€å’Œå­¦ä¹ æœºä¼šã€‚

è‡ª 2007 å¹´ä»¥æ¥ï¼Œçœ‹é›ªå·²ç»ä¸¾åŠåå¤šä¸ªæ¯”èµ›ï¼Œä¸åŒ…æ‹¬é‡‘å±±ã€è…¾è®¯å®‰å…¨ã€è…¾è®¯ TSRCã€360ã€é˜¿é‡Œã€äº¬ä¸œã€WiFi ä¸‡èƒ½é’¥åŒ™ã€å®‰æ’ç­‰åœ¨å†…çš„å„å¤§å…¬å¸å…±åŒåˆä½œä¸¾åŠèµ›äº‹ã€‚æ¯”èµ›å¸å¼•äº†å›½å†…ä¸€å¤§æ‰¹å®‰å…¨äººå£«çš„å¹¿æ³›å…³æ³¨ï¼Œå†å¹´æ¥ CTF ä¸­äººæ‰è¾ˆå‡ºï¼Œæ±‡èšäº†æ¥è‡ªå›½å†…ä¼—å¤šå®‰å…¨äººæ‰ï¼Œé«˜æ‰‹å¯¹å†³ï¼Œç²¾å½©å¼‚å¸¸ï¼Œæˆä¸ºå®‰å…¨åœˆçš„ä¸€æ¬¡æ¯”èµ›ç››å®´ï¼Œçªå‡ºäº†çœ‹é›ªè®ºå›å¤åˆå‹äººæ‰å¤šçš„ä¼˜åŠ¿ï¼Œæˆä¸ºä¼ä¸šæŒ‘é€‰äººæ‰çš„é‡è¦é€”å¾„ï¼Œåœ¨ç¤¾ä¼šå®‰å…¨äº‹ä¸šå‘å±•ä¸­äº§ç”Ÿäº†å·¨å¤§çš„å½±å“åŠ›ã€‚


## âš¡2021KCTF æ˜¥å­£èµ› Q1
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-170.htm

çœ‹é›ª.æ·±ä¿¡æœ 2021KCTF æ˜¥å­£èµ› ç¬¬äºŒé¢˜ ç­¾åˆ°é¢˜ æ‹œå¸ˆå­¦è‰º


## âš¡2021KCTF æ˜¥å­£èµ› Q2
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-171.htm
- https://ctf.pediy.com/game-season_fight-171.htm
- https://bbs.pediy.com/thread-267477.htm
- https://bbs.pediy.com/thread-267478.htm

çœ‹é›ª.æ·±ä¿¡æœ 2021KCTF æ˜¥å­£èµ› ç¬¬äºŒé¢˜ å—å†¥ç¥åŠŸ


é¢˜ç›®è¯´æ˜ï¼š

æ­¤é¢˜æ˜¯ä¸€é“ Windows é€†å‘é¢˜ï¼Œè‹¥åºåˆ—å·æœ‰å¤šè§£ï¼Œå¹³å°ä¸è®¤å¯æäº¤çš„æ³¨å†Œç ï¼Œè¯·åŠ æ¯”èµ›ä¸“ç”¨QQç¾¤ï¼š8601428ï¼Œè”ç³»ç®¡ç†å‘˜éªŒè¯ã€‚

å…ˆå°† Windows 32-bit ç¨‹åºå®šä½åˆ° main å‡½æ•°, 004B3CC0ã€‚

ä½¿ç”¨ IDA è¿›è¡Œåˆ†æï¼Œç¯å¢ƒï¼ˆIDA Pro 7.5, Python 3.8)ï¼Œèƒ½è‡ªåŠ¨å®šä½åˆ°å…¥å£å‡½æ•°å¾ˆæ–¹ä¾¿ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦åˆ†æä»£ç é€»è¾‘ã€‚

    sub_4AF840((int)&dword_4B8860, "Input your code: ");

æ³¨æ„ï¼ŒIDA Freeware 7.6 å…è´¹ç‰ˆæœ¬ä¸åªæ”¯æŒç¨‹åºçš„ C è¯­è¨€ä¼ªä»£ç ç”Ÿæˆï¼Œç¬¦å·åˆ†æèƒ½åŠ›ä¸åŠ IDA Proï¼Œè¿™æ—¶å¯èƒ½éœ€è¦æ ¹æ®æç¤ºå­—ç¬¦å†…å®¹æ‰€æœ‰çš„å†…å­˜æ¥é—´æ¥å®šä½ã€‚

å¯ä»¥ä½¿ç”¨ OllyDbg 1.1ï¼Œè¿™æ˜¯å…è´¹åˆå¥½ç”¨çš„ 32-bit é€†å‘è°ƒè¯•å·¥å…·ã€‚

æ­¤é¢˜åº”è¯¥å±äºè¿·å®«ç±»çš„é¢˜ç›®ã€‚è¦æ±‚æ˜¯ä»å¼€å§‹å¤„èµ°éé¢„å®šçš„è·¯å¾„ï¼Œä¸”èµ°è¿‡çš„è·¯å¾„ç‚¹ä¸èƒ½é‡å¤èµ°ï¼Œç›¸é‚»ä¸¤æ¬¡çš„ä½ç½®è¡Œå’Œåˆ—çš„å˜åŒ–å‡ä¸èƒ½è¶…è¿‡1æ ¼ã€‚æ¯ä¸ªè¾“å…¥å­—ç¬¦å¯ä»¥èµ°è¿·å®«ä¸¤æ­¥ã€‚æ€è·¯æ˜¯é€šè¿‡æ‰¾åˆ°è¿·å®«è·¯å¾„ï¼Œç„¶ååæ¨è¾“å…¥ï¼Œæœ€åå¾—åˆ° flagã€‚

è¿·å®«æ˜¯ 9 * 10 çš„ï¼Œä½¿ç”¨ VSCode æˆ– Sublime å¸¦æœ‰é«˜äº®çš„ç¼–è¾‘å™¨ï¼Œå¾ˆå®¹æ˜“å¯¹è±¡ 00 å€¼çš„èµ°å‘ï¼š

    53 00 01 00 00 01 00 00 01 01
    01 01 00 00 01 00 00 01 00 00
    00 00 01 00 01 01 01 01 01 00
    00 01 01 00 01 00 00 01 00 00
    00 00 01 00 00 01 00 00 01 01
    01 01 00 01 01 01 00 01 00 01
    00 00 01 01 01 01 00 01 00 01
    00 01 01 00 00 01 00 01 00 01
    00 00 00 01 00 00 01 01 00 00

æ ¹æ®å¥‡ã€å¶è¡Œï¼Œå„è®¾ç½® 6 ç§èµ°å‘ï¼ŒæŒ‰ NEWS æ–¹ä½è¡¨ç¤ºï¼š

     5  0           5  0
      \ |           | /
    4 - O - 1   4 - E - 1
      / |           | \
     3  2           3   2

ä¹Ÿå°±æ˜¯ä»¥ä¸‹çº¦æŸè§„åˆ™ï¼š

- å¶æ•°è¡Œ E ä¸å¯å‘å·¦ä¸ŠåŠå·¦ä¸‹å¯»è·¯ï¼›
- å¥‡æ•°è¡Œ O ä¸å¯å‘å³ä¸ŠåŠå³ä¸‹å¯»è·¯ï¼›

å°†è¿·å®«è·¯å¾„çš„èµ°å‘è½¬æ¢æˆç›¸åº”çš„æ•°å­—ï¼Œå¹¶æŒ‰ä»¥ä¸‹è§„åˆ™å¯¹åº”è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œæ¯è¾“å…¥ä¸€ä¸ªå­—ç¬¦å¯¹åº”è¿·å®«ä¸­èµ°ä¸¤æ­¥ã€‚

    nStep1 = 5 - (nHexIdx + nInputIdx) % 6;
    nStep2 = (nInputIdx + nHexIdx / 6) % 6;


## âš¡2021KCTF æ˜¥å­£èµ› Q3
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-172.htm
- 2021 KCTF-WEB å‡ºé¢˜æ€è·¯ https://bbs.pediy.com/thread-267374.htm
- RuoYi æ–‡æ¡£ https://doc.ruoyi.vip/ruoyi-vue/document/hjbs.html
- [Downloading Apache Maven 3.6.3](http://maven.apache.org/download.cgi)
- Web ç«¯å£å®‰å…¨æµ‹ç»˜å·¥å…· Goby https://gobies.org/


çœ‹é›ª.æ·±ä¿¡æœ 2021KCTF æ˜¥å­£èµ› ç¬¬ä¸‰é¢˜ ç»Ÿä¸€é—¨æ´¾

é¢˜ç›®æè¿°ï¼š

ä¸€é“ Web é¢˜ï¼Œè®¿é—®é“¾æ¥ï¼š http://121.36.145.157/

åˆ©ç”¨æŠ€æœ¯ç»•è¿‡é™åˆ¶ï¼Œç™»é™†åå°è·å¾— flag çš„å€¼ã€‚

æ³¨æ„ï¼šç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶ï¼Œç½‘ç«™æç¤ºâ€œæ­£åœ¨åŠ è½½ç³»ç»Ÿèµ„æºï¼Œè¯·è€å¿ƒç­‰å¾…â€ï¼Œæ—¶é—´æœ‰äº›é•¿ï¼Œä¼°è®¡è¦2-3åˆ†é’Ÿï¼Œç¬¬äºŒæ¬¡å°±æ­£å¸¸äº†ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚

æ‰“å¼€ç•Œé¢å¯çŸ¥æ˜¯é‡‡ç”¨â€œè‹¥ä¾ç®¡ç†ç³»ç»Ÿâ€æ­å»ºçš„ä¸€ä¸ªé»˜è®¤ç½‘ç«™ï¼ŒæŸ¥çœ‹è‹¥ä¾çš„å®˜æ–¹æ–‡æ¡£å¯çŸ¥ï¼š

- å‰ç«¯é‡‡ç”¨ Vueã€Element UIã€‚
- åç«¯é‡‡ç”¨ Spring Bootã€Spring Securityã€Redis & Jwtã€‚
- æƒé™è®¤è¯ä½¿ç”¨ Jwtï¼Œæ”¯æŒå¤šç»ˆç«¯è®¤è¯ç³»ç»Ÿã€‚

è¿™é“é¢˜ç›®éœ€è¦ä¸€å®šçš„ Java é¡¹ç›®ç»éªŒï¼Œéœ€è¦åˆ†æå¼€æºé¡¹ç›®ä»£ç ã€‚

å…‹éš†é¡¹ç›®ä»£ç ï¼š

    git clone https://gitee.com/y_project/RuoYi-Vue.git

ç¯å¢ƒéƒ¨ç½²è¦æ±‚ï¼š

- JDK >= 1.8 (æ¨è1.8ç‰ˆæœ¬)
- Mysql >= 5.7.0 (æ¨è5.7ç‰ˆæœ¬)
- Redis >= 3.0
- Maven >= 3.0
- Node >= 10 (å‰ç«¯å­é¡¹ç›® rouyi-ui ä½¿ç”¨)

é¡¹ç›®ä½¿ç”¨ Maven é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œéœ€è¦å®‰è£…å®ƒå¹¶åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ‰§è¡Œç¼–è¯‘ã€æ‰“åŒ…å‘½ä»¤ï¼š

- **mvn compile** ç¼–è¯‘å‘½ä»¤ç”Ÿæˆ target æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å°±æ˜¯ç¼–è¯‘åçš„å†…å®¹ã€‚
- **mvn clean** æ¸…é™¤å‘½ä»¤ä¸»è¦æ˜¯æ¸…é™¤ç¼–è¯‘åäº§ç”Ÿçš„ target æ–‡ä»¶å¤¹ã€‚
- **mvn package** æ‰“åŒ…å‘½ä»¤ä¼šå°†é¡¹ç›®é»˜è®¤æ‰“æˆ jar åŒ…ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ‰“æˆ war åŒ…ã€‚
- **mvn install** å®‰è£…å‘½ä»¤å¯ä»¥æŠŠé¡¹ç›®æ‰“æˆ jarï¼Œæ”¾åˆ°æœ¬åœ°ä»“åº“ã€‚

ç¼–è¯‘å™¨ä¼šæŒ‰å­é¡¹ç›®ä¾èµ–å…³ç³»é€æ¬¡ç¼–è¯‘å­é¡¹ç›®ï¼Œæœ€åæ‰“åŒ…ç”Ÿæˆ ruoyi-admin.jar åç«¯ç¨‹åºã€‚

æ‰“å¼€é¡¹ç›®åç«¯ ruoyi-admin è¿è¡Œ com.ruoyi.RuoYiApplication.javaï¼Œåç«¯è¿è¡ŒæˆåŠŸå¯ä»¥è®¿é—® http://localhost:8080 ä½†æ˜¯ä¸ä¼šå‡ºç°é™æ€é¡µé¢ï¼Œå¯ä»¥ç»§ç»­å‚è€ƒä¸‹é¢æ­¥éª¤éƒ¨ç½² ruoyi-ui å‰ç«¯ï¼Œç„¶åé€šè¿‡å‰ç«¯åœ°å€æ¥è®¿é—®ã€‚

é¡¹ç›®æä¾›çš„å¯åŠ¨è„šæœ¬ ry.sh æ˜¯ Linux ç¯å¢ƒä¸‹ä½¿ç”¨çš„ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼Œå¿½ç•¥ JVM å‚æ•°é…ç½®ï¼š

    set AppName=ruoyi-admin.jar
    set AppPath=ruoyi-admin/target/ruoyi-admin.jar

    set JVM_OPTS="-Dname=$AppName  -Duser.timezone=Asia/Shanghai -Xms512M -Xmx512M -XX:PermSize=256M -XX:MaxPermSize=512M -XX:+HeapDumpOnOutOfMemoryError -XX:+PrintGCDateStamps  -XX:+PrintGCDetails -XX:NewRatio=1 -XX:SurvivorRatio=30 -XX:+UseParallelGC -XX:+UseParallelOldGC"

    java -jar %JVM_OPTS% %AppPath%

å¯åŠ¨å‰ï¼Œéœ€è¦å®‰è£…å¥½ MySQL æ•°æ®æœåŠ¡åŠ Redis æœåŠ¡ï¼Œåˆ†åˆ«ä½¿ç”¨é»˜è®¤ 3306/6379 ç«¯å£ã€‚

åˆ›å»º MySQL æ•°æ®åº“ `ry-vue` å¹¶å¯¼å…¥æ•°æ®è„šæœ¬ ry_2021xxxx.sqlï¼Œquartz.sqlï¼Œæ³¨æ„æ•°æ®åº“åå­—ä½¿ç”¨äº†è¿å­—ç¬¦ï¼š

    create database `ry-vue`;

è„šæœ¬æ‰§è¡Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ source è¯»å…¥æ–‡ä»¶ï¼Œå¦ä¸€ç§æ˜¯åœ¨å‘½ä»¤è¡Œä¸­ä½¿å¾—ç®¡é“ï¼Œå°†è„šæœ¬ä¸€è¡Œè¡Œå¯¼å…¥æ‰§è¡Œï¼š

    mysql> source path\to\file_name.sql
    mysql> \. path\to\file_name.sql

æ³¨æ„ä¿®æ”¹ ruoyi-admin\target\classes\application-druid.yml é…ç½®æ–‡ä»¶ä¸­çš„ MySQL è´¦æˆ·åŠå¯†ç ï¼Œæ³¨æ„ï¼Œé…ç½®åœ¨ JAR æ‰“åŒ…åä¿®æ”¹å¯èƒ½æ— æ³•ç”Ÿæ•ˆã€‚å› ä¸º Maven æ‰“åŒ…æ—¶ä¼šå°†é…ç½®æ–‡ä»¶ä¸€å¹¶æ‰“åŒ…åˆ° BOOT-INF å†…ï¼Œå¯ä»¥ä½¿ç”¨ WinRAR è¦†ç›–é…ç½®æ–‡ä»¶ã€‚

æˆ–è€…ä½¿ç”¨ jar å‘½ä»¤è§£åŒ…é…ç½®æ–‡ä»¶ï¼Œæ›´æ–°åå†æ‰“åŒ…å›å»ï¼š

    jar -xf ruoyi-admin.jar BOOT-INF\classes\application-druid.yml
    jar -uf ruoyi-admin.jar BOOT-INF\classes\application-druid.yml

å®‰è£… Nginx å¹¶é…ç½®å‰ç«¯é™æ€æ–‡ä»¶å’Œåç«¯ API æœåŠ¡ï¼Œæ ¹æ® ruoyi-ui ç¼–è¯‘è®¾ç½® prod-api æˆ– stage-apiï¼Œå¦å¤–ä¸è¦éšä¾¿è®¾ç½® NGINX ç¯å¢ƒå˜é‡ï¼š

    location / {
        root   /home/ruoyi/projects/ruoyi-ui;
        try_files $uri $uri/ /index.html;
        index  index.html index.htm;
    }
    
    location /prod-api/{
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:8080/;
    }

æˆåŠŸé…ç½®åç«¯å¯ä»¥å°è¯•è®¿é—®ï¼š

    >curl http://localhost:8080
    {"msg":"è¯·æ±‚è®¿é—®ï¼š/ï¼Œè®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº","code":401}

é»˜è®¤æ§åˆ¶å°ç®¡ç†ç”¨æˆ·åå’Œå¯†ç  admin/admin123ï¼Œæœ¬åœ°é…ç½®ç™»å½•æˆåŠŸåå´å‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œå¯¼è‡´ UI ä¸èƒ½è¿›å…¥ç®¡ç†ç•Œé¢ï¼š

    java.lang.NoClassDefFoundError: javax/xml/bind/DatatypeConverter

å¯ä»¥ç™»å½•è¯•ç”¨çš„ç«™ç‚¹ http://vue.ruoyi.vip/login ç ”ç©¶æ¥å£ã€‚

ä»ä½¿ç”¨ä½“éªŒæ¥çœ‹ï¼Œè¿™ä¸ªé¡¹ç›®å¹¶ä¸äººæ€§åŒ–ï¼Œéœ€è¦ç›¸å½“ä¸“ä¸šçš„äººå‘˜è¿›è¡Œé…ç½®æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚Spring Boot æ˜¯ä¸€æ¬¾å¼€ç®±å³ç”¨æ¡†æ¶ï¼Œæä¾›å„ç§é»˜è®¤é…ç½®æ¥ç®€åŒ–é¡¹ç›®é…ç½®ï¼Œä½†æ˜¯åˆ°äº† Rouyi å´å˜å¾—ç›¸å½“å¤æ‚çš„é…ç½®ã€‚

é˜…è¯»éƒ¨ç½²æ–‡æ¡£ï¼Œå‘ç°ç›®æ ‡æ­£å¥½å¼€å¯äº† Redis 6379 ç«¯å£ï¼Œå¹¶ä¸”å¯ä»¥æœªæˆæƒè®¿é—®ã€‚å¤§æ¦‚äº†è§£ä¸€ä¸‹è‹¥ä¾çš„ç™»å½•é€»è¾‘å¯çŸ¥ï¼Œå®ƒçš„ç”¨æˆ·ä¿¡æ¯æ˜¯ç¼“å­˜åœ¨ redis ä¸­çš„ï¼Œå¹¶ä¸”é€šè¿‡ JWT è¿›è¡Œè®¤è¯ã€‚

è‡ªå·±æ­å»ºä¸€ä¸ªç¯å¢ƒç™»å½• admin è´¦å·åé€šè¿‡ Redis å‘½ä»¤ `keys *` å¯æŸ¥è¯¢åˆ°ä¸€ä¸ª login_tokensï¼Œç›®æ ‡ä¸»æœºä¸Šä¹Ÿæœ‰ä¸€ä¸ªï¼š

```sh
$ redis-cli -h 121.36.145.157
121.36.145.157:6379> keys
(error) ERR wrong number of arguments for 'keys' command
121.36.145.157:6379> keys *
1) "login_tokens:3109ec3f-6e84-48f5-bc1f-4f351d236333"
121.36.145.157:6379>
```

è¿™ä¸ª TokenKey åº”è¯¥å…³è”å­˜å‚¨äº†ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå°è¯•ä½¿ç”¨ get æŸ¥è¯¢å…³è”çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œä»¥ä¸‹ç›´æ¥å±•ç¤º JSON æ•°æ®é‡è¦éƒ¨åˆ†ï¼š

```rust
# 121.36.145.157:6379> get "login_tokens:3109ec3f-6e84-48f5-bc1f-4f351d236333"
{

    "password":"$2a$10$TbIq6QkLbP4MrjPaOJ2Y4.UqYYyChFC0HYrC7etAPI9iL1GOJ6ZLG",
    "permissions":Set["*:*:*"],
    "token":"07aaf192-ca8f-4db7-a6a2-ee81dbf07d58",
    "user":{
        "admin":true,
        "password":"$2a$10$TbIq6QkLbP4MrjPaOJ2Y4.UqYYyChFC0HYrC7etAPI9iL1GOJ6ZLG",
        "roles":[
            {
            "admin":true,
            "dataScope":"1",
            "deptCheckStrictly":false,
            "flag":false,
            "menuCheckStrictly":false,
            "params":{
                "@type":"java.util.HashMap"
            },
            "roleId":1,
            "roleKey":"admin",
            "roleName":"\xe8\xb6\x85\xe7\xba\xa7\xe7\xae\xa1\xe7\x90\x86\xe5\x91\x98",
            "roleSort":"1",
            "status":"0"}
        ],
        "sex":"1",
        "status":"0",
        "userId":1,
        "userName":"admin"
    },
    "username":"admin"
}
```

ä»¥ä¸Š JSON æ•°æ®å¯¹åº”äº†ä¸€ä¸ª `LoginUser.java` æ¨¡å‹å¯¹è±¡ã€‚

å¯ä»¥åœ¨ ruoyi-common ä¾èµ–é¡¹ç›®ä¸­æ‰¾åˆ°è¿™ä¸ªå¸¸é‡å®šä¹‰ï¼ŒRedis ä¿å­˜çš„è¿™ä¸ª Key å­—ç¬¦ä¸²å°±æ˜¯ TokenKeyï¼Œå®ƒåŒ…å«ï¼š

- `LOGIN_TOKEN_KEY` å¸¸é‡å®šä¹‰çš„å‰ç¼€ "login_tokens"ï¼›
- åç¼€éƒ¨åˆ†ä¸º UUIDï¼Œå¯¹åº” `LOGIN_USER_KEY`ã€‚

å†æ ¹æ®å¼•ç”¨æ‰¾åˆ° TokenService.java å’Œ SysLoginService.java è¿™ä¸¤ä¸ªä»£ç æ–‡ä»¶ï¼Œå®ƒä»¬è´Ÿè´£ TokenKey çš„è¯»å–å’Œç”Ÿæˆï¼ŒåŒ…æ‹¬ç™»å½•éªŒè¯ã€‚

é€šè¿‡é‡è½½æ–¹æ³• `createToken` ç”Ÿæˆ JWT Tokenï¼Œè€Œ TokenKey åˆ™æ ¹æ® Token ä¿å­˜çš„ UUID ç»„åˆè€Œæˆã€‚

ä»£ç åˆ†æï¼š

ç™»é™†æˆåŠŸåä¼šåœ¨ Redis é‡Œå†™å…¥åŒ…å« UUID çš„ TokenKey -> å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‰´æƒæ—¶æœåŠ¡å™¨éªŒè¯æœºåˆ¶ä» Authorization è·å– Tokenï¼Œè€Œä¸æ˜¯ Admin-Tokenï¼Œå–å‡º JWT Tokenï¼Œç„¶åå–å‡º UUIDï¼Œç„¶åå–å‡ºç”¨æˆ·ä¿¡æ¯ã€‚

ä»ä»£ç å¯ä»¥çœ‹åˆ° `LOGIN_USER_KEY` å³ login_user_key ä¼šæ”¾å…¥ JWT çš„ Payload ä¸­ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å®ƒä¹Ÿæ˜¯ TokenKey çš„åç¼€ã€‚

```java
public LoginUser getLoginUser(HttpServletRequest request)
{
    // è·å–è¯·æ±‚æºå¸¦çš„ä»¤ç‰Œ
    String token = getToken(request);
    if (StringUtils.isNotEmpty(token))
    {
        Claims claims = parseToken(token);
        // è§£æå¯¹åº”çš„æƒé™ä»¥åŠç”¨æˆ·ä¿¡æ¯
        String uuid = (String) claims.get(Constants.LOGIN_USER_KEY);
        String userKey = getTokenKey(uuid);
        LoginUser user = redisCache.getCacheObject(userKey);
        return user;
    }
    return null;
}
```

æ‰€ä»¥åªè¦åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªç¯å¢ƒï¼Œç™»å½•æˆåŠŸåï¼Œå°†æœ¬åœ°çš„ TokenKey é€šè¿‡ç›®æ ‡ä¸»æœºåé—¨å†™å…¥ Redis æ•°æ®åº“ï¼Œç„¶åä¸­åœ¨æµè§ˆå™¨ä¸­é€šè¿‡è„šæœ¬ä¿®æ”¹ Cookieï¼Œå°†æœ¬åœ°çš„ è·å–åˆ°çš„ Admin-Token å†™å…¥ã€‚è¿™æ ·å°±ä¼ªé€ äº†ä¸€ä¸ª admin ç”¨æˆ·å·²ç»ç™»é™†çš„ redis key + æµè§ˆå™¨ cookieã€‚

å»å®˜ç½‘çš„æ¼”ç¤ºç«™é‡Œé¢ç™»å½•ä¸€ä¸‹ï¼Œæå– Admin-token å¹¶ Base64 è§£ç  JWTï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸¤ç»„æ•°æ®ï¼š

    {"alg":"HS512"}
    {"login_user_key":"e8b214c6-997a-4769-a5fe-ec45c863203c"}

æ­¥éª¤ï¼š

- æœ¬åœ°æ­å»ºå¥½ ruoyi-vueï¼Œè¿™ä¸ªèŠ±äº†ä¸å°‘æ—¶é—´
- æœ¬åœ°ç™»é™† admin/admin123 åï¼Œçœ‹åˆ°æœ¬åœ° Redis é‡Œç”Ÿæˆäº† login_tokens:{UUID}
- ç™»é™†æœåŠ¡å™¨çš„ Redisï¼Œå†™å…¥è¯¥ key
- å°†æœ¬åœ°çš„ cookie é€šè¿‡ js å†™å…¥è¿œç¨‹ç™»é™†é¡µé¢
- åˆ·æ–°åæˆåŠŸè¿›å…¥åå°ï¼Œçœ‹åˆ° flag

å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ä½¿ç”¨ JWT ç­¾åéªŒè¯ç®—æ³•ç”Ÿæˆ Tokenï¼Œç»“åˆæºç é»˜è®¤ secret å¯†é’¥è®¡ç®—å¾—åˆ°ä¸€ä¸ª JWT çš„ç­¾åç”¨äºè¿›è¡Œç½‘ç«™è®¿é—®ï¼Œå¦‚æœ application.yml é…ç½®ä½¿ç”¨çš„ secret æ˜¯é»˜è®¤å€¼å°±å¯ä»¥ç»•è¿‡ç™»å½•äº†ã€‚

    # tokené…ç½®
    token:
        # ä»¤ç‰Œè‡ªå®šä¹‰æ ‡è¯†
        header: Authorization
        # ä»¤ç‰Œå¯†é’¥
        secret: abcdefghijklmnopqrstuvwxyz
        # ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
        expireTime: 30

ç”Ÿæˆ Token åï¼Œé€šè¿‡æ§åˆ¶å°æ‰§è¡Œè„šæœ¬ä¿®æ”¹ cookeiï¼Œç„¶åå†å°†é¡µé¢åœ°å€ä¿®æ”¹åˆ°ç™»å½•çš„é¦–é¡µ http://121.36.145.157/indexï¼š

    document.cookie = "Admin-Token=eyJh....";

è·å–é¦–é¡µæ˜¾ç¤ºçš„ `CTF flag:2435_ert3_Wee`ï¼ŒFLAGæäº¤æ ¼å¼ä¸º `flag{***}`ï¼Œå®Œæˆä»»åŠ¡ã€‚å…¶å®å‡ºé¢˜æˆ˜é˜Ÿæœªæ³¨æ„ FLAG åœ¨ Webpack æ‰“åŒ…æ—¶æ²¡æœ‰æ¸…ç†ï¼Œæ‰€ä»¥é€šè¿‡é™æ€è„šæœ¬æ–‡ä»¶ä¹Ÿå¯ä»¥æ‰¾åˆ°ï¼ŒçœŸæ˜¯å¤§æ„äº†ï¼

    http://121.36.145.157/static/js/4.js

å‡ºé¢˜æˆ˜é˜Ÿè¯´æ˜ï¼š

> è¿™é“é¢˜å¹¶éæˆ‘åˆ»æ„åˆ¶é€ ï¼Œè‹¥ä¾ä½œä¸ºä¸€æ¬¾ä½¿ç”¨å¾ˆå¹¿çš„ç®¡ç†ç³»ç»Ÿï¼Œæœ¬èº«çš„è®¤è¯é€»è¾‘å°±æ˜¯è¿™æ ·çš„ï¼Œæˆ‘åªæ˜¯è®© Redis å¤–ç½‘å¯ä»¥è®¿é—®ï¼Œè€Œä¸”è®¾ç½®äº†å¼±å£ä»¤ï¼Œå…¶ä»–æ²¡åšä¿®æ”¹ï¼Œè¿™åœ¨å®æˆ˜ä¸­è¿˜æ˜¯å¯èƒ½é‡åˆ°çš„ï¼Œå…¶å®ä¸åªæ˜¯è‹¥ä¾ï¼Œæ‰€æœ‰ç”¨äº† JWT çš„ç³»ç»Ÿéƒ½å¯èƒ½ç”¨çš„è¿™å¥—é€»è¾‘ï¼Œåœ¨å®æˆ˜ä¸­å¯ä»¥é€šè¿‡è®¾ç½®æ¯”è¾ƒå¼ºçš„ JWT ç§˜é’¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬é¢˜çš„é—®é¢˜æ˜¯åœ¨äºæ²¡æœ‰ä¿®æ”¹ JWT çš„é»˜è®¤ç§˜é’¥ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡è§‚å¯Ÿæ¨ç†çš„æ–¹æ³•è§£å†³äº†è¿™é“é¢˜ï¼Œå®é™…ä¸Šæ˜¯ä¸ä¸¥è°¨çš„ï¼Œä½†æ˜¯å¯¹äºæ¯”èµ›æ—¶é—´æœ‰é™ä¸å¤±ä¸ºæœ€å¥½çš„æ–¹æ³•ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½è‹¥ä¾çš„æºä»£ç çœ‹çœ‹ï¼Œå°±çŸ¥é“æ•´ä¸ªäº‹æƒ…çš„æ¥é¾™å»è„‰äº†ï¼Œè‹¥ä¾è¿™ä¸€å¥—æ¡†æ¶ä½“ç³»ç”¨åˆ°äº†ç›®å‰æ¯”è¾ƒä¸»æµçš„å¼€å‘æ¡†æ¶ï¼Œå€¼å¾—ç ”ç©¶ã€‚

### ğŸ‘‰ JWT Token ç”Ÿæˆå·¥å…·
- Open Source JWTs For Any Java App https://java.jsonwebtoken.io/

æœ€åï¼Œå·¥å…·ä»£ç å±•ç¤ºï¼š

```java
package jwtdemo;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

public class App 
{
    static String LOGIN_USER_KEY = "login_user_key";
    static String secret = "abcdefghijklmnopqrstuvwxyz";

    public static void main( String[] args )
    {
        String uuid = getUUID();
        if(args.length>0) uuid = args[0];
        System.out.println( "UUID: " + uuid );

        System.out.println( "Hello JWT! " + args[0] );
        String token = genToken(uuid);
        System.out.println("login_tokens:" + uuid);
        System.out.println("Authorization: Bearer " + token);
        System.out.println("document.cookie = \"Admin-Token=" + token+"\"");
        String subject = parseToken(token);
        System.out.println("Claims: " + subject);
    }

    public static String genToken(String uuid)
    {
        Map<String, Object> claims = new HashMap<>();
        claims.put(LOGIN_USER_KEY, uuid);

        String token = Jwts.builder()
                .setClaims(claims)
                .signWith(SignatureAlgorithm.HS512, secret).compact();
        return token;
    }

    public static String parseToken(String token)
    {
        Claims claims = Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
        // String subject = claims.getSubject();
        String uuid = (String) claims.get(LOGIN_USER_KEY);
        return uuid;
    }

    public static String getUUID(){
        UUID uuid = UUID.randomUUID();
        return uuid.toString();
        // return Long.toHexString();
    }
}
```

ä½¿ç”¨ Maven åˆ›å»ºæ¨¡æ¿å·¥ç¨‹ maven-archetype-quickstartï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä»æç¤ºåˆ—è¡¨ä¸­é€‰æ‹©ï¼š

    mvn archetype:generate

é€‰å¥½åŸå‹ Maven è¿˜ä¼šè¯¢é—®é¡¹ç›®ç»†èŠ‚ï¼ŒæŒ‰è¦æ±‚è¾“å…¥é¡¹ç›®ç»†èŠ‚ã€‚

- groupId æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„å‘½åç©ºé—´ï¼Œè¿™é‡ŒæŒ‡å®šä¸º jwtdemoï¼›
- artifactId é¡¹ç›®åæŒ‡å®šä¸º demoï¼Œä¼šåˆ›å»ºç›¸åº”çš„å­ç›®å½•ï¼›

å®Œæˆåï¼Œç¼–è¯‘è¿è¡Œï¼Œå‚æ•°ä¼ å…¥åå° Redis æ•°æ®åº“ä¸­å·²ç»è®¾ç½®çš„ UUIDï¼š

    mvn compile && mvn exec:java -Dexec.mainClass="jwtdemo.App" -Dexec.args="3845adb5-7e7c-47b6-9b8b-4b4063441f2f A B C"

ä½¿ç”¨æ¸…å•æ–‡ä»¶ MANIFEST.MFï¼ŒæŒ‡å®šä¸»æ¸…å•å±æ€§ä»¥æ–¹ä¾¿è¿è¡Œ jar åŒ…ï¼Œä¸€å¹¶é…ç½® maven-jar-plugin æ’ä»¶ï¼š

    Manifest-Version: 1.0
    Archiver-Version: Plexus Archiver
    Built-By: OCEAN
    Created-By: Apache Maven 3.6.3
    Build-Jdk: 1.8.0_191
    Main-Class: jwtdemo.App

é…ç½®æ–‡ä»¶ pom.xml å‚è€ƒï¼š

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>jwtdemo</groupId>
  <artifactId>demo</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>jar</packaging>

  <name>demo</name>
  <url>http://maven.apache.org</url>

  <properties>
    <java.version>1.8</java.version>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <jwt.version>0.9.1</jwt.version>
  </properties>

  <dependencies>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
        <version>${jwt.version}</version>
    </dependency>

    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>3.8.1</version>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
      <plugins>
          <plugin>
              <groupId>org.apache.maven.plugins</groupId>
              <artifactId>maven-compiler-plugin</artifactId>
              <version>3.1</version>
              <configuration>
                  <source>${java.version}</source>
                  <target>${java.version}</target>
                  <encoding>${project.build.sourceEncoding}</encoding>
              </configuration>
          </plugin>

          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <configuration>
              <archive>
                <manifestFile>src/main/resources/META-INF/MANIFEST.MF</manifestFile>
              </archive>
            </configuration>
          </plugin>

      </plugins>
  </build>

</project>
```


### ğŸ‘‰ JWT è®¤è¯æœºåˆ¶
- Introduction to JSON Web Tokens https://jwt.io/introduction
- JSON Web Tokens Debugger https://jwt.io/#debugger-io
- è¯·ç«‹åˆ»åœæ­¢ä½¿ç”¨ JWT è¿›è¡Œä¼šè¯ç®¡ç† https://zhuanlan.zhihu.com/p/372104412
- PASETO - Platform-Agnostic SEcurtiy TOkens https://paseto.io/
- Protocol Versions https://github.com/paragonie/paseto/tree/master/docs/01-Protocol-Versions
- NTLM: How does this protocol work? https://www.ionos.com/digitalguide/server/know-how/ntlm-nt-lan-manager
- Microsoft Kerberos https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos

JSON Web Token(JWT) æ˜¯ä¸€ä¸ªéå¸¸è½»å·§çš„è§„èŒƒï¼Œæ˜¯ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´ä¼ é€’å£°æ˜è€Œæ‰§è¡Œçš„ä¸€ç§åŸºäº JSON çš„å¼€æ”¾æ ‡å‡† (RFC 7519)ã€‚

JWT æ ‡å‡†åªæ˜¯è®¾è®¡äº†ä¸€ä¸ªé˜²ç¯¡æ”¹ä»¤ç‰Œï¼Œå¹¶éæ˜¯ä¸ºä¼šè¯ç®¡ç†è€Œè®¾è®¡ï¼Œå±äºä¸€ç§ JOSE - Javascript Object Signing and Encryption æŠ€æœ¯ã€‚

è¯¥ Token è¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWT çš„å£°æ˜ä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œä¹Ÿå¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„å…¶å®ƒä¸šåŠ¡é€»è¾‘æ‰€å¿…é¡»çš„å£°æ˜ä¿¡æ¯ï¼Œè¯¥ Token ä¹Ÿå¯ç›´æ¥è¢«ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯è¢«åŠ å¯†ã€‚

HTTP åè®®æœ¬èº«æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œè€Œè¿™å°±æ„å‘³ç€å¦‚æœç”¨æˆ·å‘æˆ‘ä»¬çš„åº”ç”¨æä¾›äº†ç”¨æˆ·åå’Œå¯†ç æ¥è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œç”¨æˆ·è¿˜è¦å†ä¸€æ¬¡è¿›è¡Œç”¨æˆ·è®¤è¯æ‰è¡Œã€‚HTTP åè®®å¹¶ä¸èƒ½å‘Šè¯‰ä½ æ˜¯å“ªä¸ªç”¨æˆ·å‘å‡ºçš„è¯·æ±‚ï¼Œæ‰€ä»¥ä¸ºäº†è®©åº”ç”¨è¯†åˆ«ç”¨æˆ·ï¼Œåªèƒ½åœ¨æœåŠ¡å™¨å­˜å‚¨ä¸€ä»½ç”¨æˆ·ç™»å½•çš„ä¿¡æ¯ï¼Œè¿™ä»½ç™»å½•ä¿¡æ¯ä¼šåœ¨å“åº”æ—¶ä¼ é€’ç»™æµè§ˆå™¨ï¼Œå‘Šè¯‰å…¶ä¿å­˜ä¸º cookieï¼Œä»¥ä¾¿ä¸‹æ¬¡è¯·æ±‚æ—¶å‘é€ç»™æœåŠ¡ç«¯ï¼Œåº”ç”¨å°±èƒ½é€šè¿‡ cookie ä¸æœåŠ¡å™¨å¯¹åº”çš„è®°å½•è¯†åˆ«ç”¨æˆ·ã€‚

åŸºäº Session çš„ä¼ ç»Ÿè®¤è¯é—®é¢˜ï¼š

- æœåŠ¡ç«¯è¦è®°å½•æ‰€æœ‰ç™»å½•çš„ç”¨æˆ·ï¼ŒSession é€šå¸¸ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¼šå¢åŠ æœåŠ¡å™¨å†…å­˜å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¤§é‡ç”¨æˆ·çš„æƒ…å†µã€‚
- æ‰©å±•æ€§å·®ï¼Œä¸é€‚åˆåˆ†å¸ƒç³»ç»Ÿï¼ŒæœåŠ¡ç«¯è®¤è¯ç”¨æˆ·åï¼Œåšå¥½è®°å½•ï¼Œå¦‚æœè®°å½•åœ¨å†…å­˜ï¼Œç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚è¿˜å¿…é¡»è¦è¯·æ±‚åœ¨è¿™å°æœåŠ¡å™¨ä¸Šæ‰èƒ½æ‹¿åˆ°æˆæƒçš„èµ„æºã€‚
- å®¹æ˜“å— CSRF æ”»å‡»ï¼Œå› ä¸ºæ˜¯åŸºäº cookie æ¥è¿›è¡Œç”¨æˆ·è¯†åˆ«çš„ï¼Œå¦‚æœè¢«æˆªè·ï¼Œç”¨æˆ·å°±ä¼šå¾ˆå®¹æ˜“å—åˆ°è·¨ç«™è¯·æ±‚ä¼ªé€ çš„æ”»å‡»ã€‚

è€ŒåŸºäº Token çš„é‰´æƒæœºåˆ¶ç±»ä¼¼äº HTTP åè®®ä¹Ÿæ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒä¸éœ€è¦åœ¨æœåŠ¡ç«¯å»ä¿ç•™ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯æˆ–è€…ä¼šè¯ä¿¡æ¯ã€‚è¿™å°±æ„å‘³ç€åŸºäº Token è®¤è¯æœºåˆ¶çš„åº”ç”¨ä¸éœ€è¦å»è€ƒè™‘ç”¨æˆ·åœ¨å“ªä¸€å°æœåŠ¡å™¨ç™»å½•äº†ï¼Œè¿™å°±ä¸ºåº”ç”¨çš„æ‰©å±•æä¾›äº†ä¾¿åˆ©ã€‚

JWT ä¸ Session æœ€å¤§å·®åˆ«åœ¨äºï¼Œå®ƒä»¬éƒ½æ˜¯å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶è€Œï¼ŒSession æ˜¯åœ¨æœåŠ¡å™¨ç«¯çš„ä¿å­˜æ•°æ®ï¼Œè€Œ JWT æ˜¯åœ¨å®¢æˆ·ç«¯ä¿å­˜æ•°æ®ã€‚å³ Session çš„çŠ¶æ€æ•°æ®æ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯åªæœ‰ SessionIDï¼Œè€Œ Token çš„çŠ¶æ€å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨åªéœ€è¦æ ¡éªŒ Token æ˜¯å¦åˆæ³•ã€‚

JWT ä¸ OAuth çš„åŒºåˆ«ï¼š

- OAuth2 æ˜¯ä¸€ç§æˆæƒæ¡†æ¶ï¼ŒJWT æ˜¯ä¸€ç§è®¤è¯åè®®ï¼Œæ— è®ºä½¿ç”¨å“ªç§æ–¹å¼åˆ‡è®°ç”¨ HTTPS æ¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚
- OAuth2 ç”¨åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•çš„æƒ…å†µï¼Œè€Œ JWT æ˜¯ç”¨åœ¨å‰åç«¯åˆ†ç¦», éœ€è¦ç®€å•çš„å¯¹åå° API è¿›è¡Œä¿æŠ¤æ—¶ä½¿ç”¨ã€‚


JWT åŸºæœ¬æµç¨‹ï¼š

- ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åå¯†ç æ¥è¯·æ±‚æœåŠ¡å™¨
- æœåŠ¡å™¨éªŒè¯ç”¨æˆ·çš„ä¿¡æ¯
- æœåŠ¡å™¨é€šè¿‡éªŒè¯åç»™ç”¨æˆ·ä¸€ä¸ª Token 
- å®¢æˆ·ç«¯å­˜å‚¨ Tokenï¼Œå¹¶åœ¨æ¯æ¬¡è¯·æ±‚æ—¶é™„å¸¦
- æœåŠ¡ç«¯éªŒè¯ Token å€¼ï¼Œå¹¶è¿”å›æ•°æ®

è¿™ä¸ª Token å¿…é¡»è¦åœ¨æ¯æ¬¡è¯·æ±‚æ—¶ä¼ é€’ç»™æœåŠ¡ç«¯ï¼Œå®ƒåº”è¯¥ä¿å­˜åœ¨è¯·æ±‚å¤´é‡Œï¼Œå¦å¤–ï¼ŒæœåŠ¡ç«¯è¦æ”¯æŒ CORS(è·¨æ¥æºèµ„æºå…±äº«)ç­–ç•¥ï¼Œä¸€èˆ¬å¯ä»¥åœ¨æœåŠ¡ç«¯è®¾ç½® Access-Control-Allow-Origin: * ã€‚

åœ¨è®¤è¯çš„æ—¶å€™ï¼Œå½“ç”¨æˆ·ç”¨ä»–ä»¬çš„å‡­è¯æˆåŠŸç™»å½•ä»¥åï¼Œä¸€ä¸ª JSON Web Token å°†ä¼šè¢«è¿”å›ï¼Œç”¨æˆ·ç”¨æ­¤å‡­è¯è®¿é—®æˆæƒçš„èµ„æºï¼Œä½ å¿…é¡»éå¸¸å°å¿ƒä»¥é˜²æ­¢å‡ºç°å®‰å…¨é—®é¢˜ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä½ ä¿å­˜ä»¤ç‰Œçš„æ—¶å€™ä¸åº”è¯¥è¶…è¿‡ä½ æ‰€éœ€è¦å®ƒçš„æ—¶é—´ã€‚

æ— è®ºä½•æ—¶ç”¨æˆ·æƒ³è¦è®¿é—®å—ä¿æŠ¤çš„è·¯ç”±æˆ–è€…èµ„æºçš„æ—¶å€™ï¼Œç”¨æˆ·ä»£ç†ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨ï¼‰éƒ½åº”è¯¥å¸¦ä¸Š JWTã€‚

å…¸å‹çš„ï¼Œé€šå¸¸æ”¾åœ¨ Authorization è¯·æ±‚å¤´ä¸­ï¼Œç”¨ Bearer schemaï¼Œçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

    Authorization: Bearer YOUR_TOKEN

æœåŠ¡å™¨ä¸Šçš„å—ä¿æŠ¤çš„è·¯ç”±å°†ä¼šæ£€æŸ¥ Authorization æºå¸¦çš„ JWT æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆï¼Œåˆ™ç”¨æˆ·å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºã€‚å¦‚æœ JWT åŒ…å«è¶³å¤Ÿå¤šçš„å¿…éœ€çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‡å°‘å¯¹æŸäº›æ“ä½œçš„æ•°æ®åº“æŸ¥è¯¢çš„éœ€è¦ï¼Œå°½ç®¡å¯èƒ½å¹¶ä¸æ€»æ˜¯å¦‚æ­¤ã€‚

å¦‚æœ Token æ˜¯åœ¨æˆæƒå¤´ï¼ˆAuthorization headerï¼‰ä¸­å‘é€çš„ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰è·¨æºèµ„æºå…±äº«(CORS)é—®é¢˜ï¼Œå› ä¸ºå®ƒä¸ä½¿ç”¨ cookieã€‚

JSON Web Token ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå®ƒä»¬æ˜¯åœ†ç‚¹(.)è¿æ¥çš„ Base64 ç¼–ç çš„å†…å®¹ï¼š

    Header.Payload.Signature
    xxxxxx.yyyyyyy.zzzzzzzzzzzz

JWT çš„ç­¾åä½¿ç”¨ HMAC æˆ–åŸºäºå…¬é’¥å¯†é’¥å¯¹çš„ç®—æ³• RSAã€ECDSAã€‚

å…¸å‹çš„ Header æ˜¯ä¸€ä¸ª JSONï¼ŒåŒ…å« Token çš„ç±»å‹å’Œç®—æ³•ï¼Œç»è¿‡ Base64 ç¼–ç å°±å¾—åˆ° JWT çš„ Header éƒ¨åˆ†ï¼š

    {
        'alg': "HS256",
        'typ': "JWT"
    }

ç¬¬äºŒéƒ¨åˆ†æ˜¯ Payloadï¼Œä¹Ÿæ˜¯ JSON æ•°æ®ï¼ŒåŒ…å«å£°æ˜ï¼ˆè¦æ±‚ï¼‰ï¼Œæ˜¯å…³äºå®ä½“(é€šå¸¸æ˜¯ç”¨æˆ·)å’Œå…¶ä»–æ•°æ®çš„å£°æ˜ï¼Œæœ‰ä¸‰ç§ç±»å‹ï¼š

- Registered claims è¿™é‡Œæœ‰ä¸€ç»„é¢„å®šä¹‰çš„å£°æ˜ï¼Œå®ƒä»¬ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œä½†æ˜¯æ¨èã€‚æ¯”å¦‚ï¼šiss (issuer), exp (expiration time), sub (subject), aud (audience)ç­‰ã€‚
- Public claims å¯ä»¥éšæ„å®šä¹‰ã€‚
- Private claims ç”¨äºåœ¨åŒæ„ä½¿ç”¨å®ƒä»¬çš„å„æ–¹ä¹‹é—´å…±äº«ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸æ˜¯æ³¨å†Œçš„æˆ–å…¬å¼€çš„å£°æ˜ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª Payload ä¾‹å­ï¼š

    {
      "sub": "1234567890",
      "name": "John Doe",
      "admin": true
    }

æœ€åæ˜¯ç­¾åéƒ¨åˆ†ï¼Œè¿™ä¹Ÿæ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œé€šè¿‡ä¸å¯é€†è½¬çš„åŠ å¯†ç®—æ³•ä» Header å’Œ Playload ç”Ÿæˆç­¾åï¼Œä»¥ä¿è¯æ•°æ®ä¸ä¼šè¢«çº‚æ”¹ã€‚å¹¶ä¸”ï¼Œå¯¹äºä½¿ç”¨ç§é’¥ç­¾åçš„ Tokenï¼Œå®ƒè¿˜å¯ä»¥éªŒè¯ JWT çš„å‘é€æ–¹æ˜¯å¦ä¸ºå®ƒæ‰€ç§°çš„å‘é€æ–¹ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ HMAC ç®—æ³•çš„ç­¾åè¿‡ç¨‹ï¼Œsecret æ˜¯åŠ å¯†ä½¿ç”¨çš„å¯†é’¥ï¼š

    HMACSHA256(
      base64UrlEncode(header) + "." +
      base64UrlEncode(payload),
      secret)

ç„¶åï¼Œå°†ä¸‰è€…çš„ Base64 ç¼–ç å†…å®¹ä½¿ç”¨ç‚¹å·æ‹¼æ¥å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ JWTï¼Œå¯ä»¥ä½¿ç”¨ jwt.io Debugger æ¥ä½“éªŒã€‚

JWT çš„ç¼ºç‚¹ï¼š

- ä¼šè¯æ•°æ®å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œä¸”åœ¨æ¯æ¬¡è¯·æ±‚ä¸­æºå¸¦ï¼Œå¢åŠ æ³„éœ²é£é™©ï¼›
- æ¯æ¬¡è¯·æ±‚éœ€ä¼ é€’æ›´å¤šæ•°æ®ï¼Œå¢åŠ æµé‡å¼€é”€ï¼›
- æœåŠ¡ç«¯ä¸æ–¹ä¾¿åŠé”€ä¼šè¯ï¼Œå®ç°å„ç§ä¼šè¯ç­–ç•¥ç®¡ç†ï¼›

è¿˜æœ‰ä¸€ç‚¹ï¼ŒToken å…·æœ‰æ—¶æ•ˆï¼Œåœ¨ä¸€æ®µæ—¶é—´ä»¥åä¼šè¿‡æœŸï¼Œè¿™ä¸ªæ—¶å€™ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬ä¿æŒå®‰å…¨ï¼Œä½†ä¹Ÿå¸¦æ¥ Token åˆ·æ–°ç»­æœŸé—®é¢˜ã€‚è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå« Token æ’¤é”€ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ ¹æ®ç›¸åŒçš„æˆæƒè®¸å¯ä½¿ç‰¹å®šçš„ç”šè‡³æ˜¯ä¸€ç»„ Token æ— æ•ˆã€‚

JWT æ”¯æŒå°†ç®—æ³•è®¾å®šä¸ºâ€œNoneâ€ï¼Œå¦‚æœä½ ä½¿ç”¨ JWT åº“æ—¶æœªè®¾ç½®å…³é—­è¯¥åŠŸèƒ½ï¼Œé‚£ä¹ˆä»»ä½• Token éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚å…·ä½“åšæ³•æ˜¯å°† JWT ç¬¬ä¸€éƒ¨åˆ† header ä¸­ alg å­—æ®µè®¾ç½®ä¸º None ï¼Œå†å°†ç¬¬ä¸‰éƒ¨åˆ† signature è®¾ç½®ä¸ºç©ºï¼Œå³ä¸æ·»åŠ  signature å­—æ®µï¼Œ æ­¤ Token å¯é¡ºåˆ©é€šè¿‡éªŒè¯ã€‚

å°±ä¸ªå»ºè®®æ˜¯ä½¿ç”¨æ›´æ–°çš„ PASETO æ›¿ä»£ JWTã€‚


## âš¡2021KCTF æ˜¥å­£èµ› Q4
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-173.htm
- 2021 KCTF æ­¦æ±‰ç§‘é” CR38 æœŸ CrackMe https://bbs.pediy.com/thread-267320.htm

çœ‹é›ª.æ·±ä¿¡æœ2021KCTFæ˜¥å­£èµ› ç¬¬å››é¢˜ è‹±é›„æ•‘ç¾

æ­¤é¢˜æ˜¯ä¸€é“ Windows é€†å‘é¢˜ï¼Œè‹¥åºåˆ—å·æœ‰å¤šè§£ï¼Œå¹³å°ä¸è®¤å¯æäº¤çš„æ³¨å†Œç ï¼Œè¯·åŠ æ¯”èµ›ä¸“ç”¨QQç¾¤ï¼š8601428ï¼Œè”ç³»ç®¡ç†å‘˜éªŒè¯ã€‚

æœ¬é¢˜å®ç°è¯´æ˜
æœ¬é¢˜ä¸­è¾“å…¥çš„keyæ˜¯9X9æ•°ç‹¬æ¸¸æˆï¼ˆæ•°ç‹¬.pngï¼‰çš„å”¯ä¸€è§£ï¼Œæ­¤keyä¼šè¿›è¡Œmd5åŠ å¯†ï¼Œå¾—åˆ°çš„hashå€¼ä¼šè§£å¯†ä¸€æ®µshellcodeã€‚é”™è¯¯çš„keyåˆ™æ— æ³•è·å¾—shellcodeã€‚

è¯¦ç»†è¯´æ˜
9x9çš„æ•°ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ªå…¨å±€çš„äºŒç»´æ•°ç»„ä¸­ï¼Œç ´è§£è€…è¾“å…¥ä¸€ä¸²å¯†é’¥ã€‚ç„¶åæ ¹æ®è¿™ä¸ªå¯†é’¥è½¬æ¢ä¸ºåœ¨è¿™ä¸ªæ•°ç‹¬ä¸­åº”è¯¥å¡«å†™çš„æ•°å­—ï¼Œåˆ¤æ–­å…¶è¡Œæ˜¯å¦åˆæ³•ã€åˆ—æ˜¯å¦åˆæ³•ä»¥åŠç²—çº¿å®«æ˜¯å¦åˆæ³•ã€‚å¦‚æœåˆæ³•åˆ™è®¡ç®—å…¶md5ï¼Œç„¶åaesè§£å¯†shellcodeã€‚è§£å¯†æ­£ç¡®çš„è¯åˆ™ä¼šæ­£å¸¸æ‰§è¡Œshellcodeï¼Œä»è€Œå¼¹å‡ºinput correctçš„æ¶ˆæ¯æ¡†ï¼Œå¦åˆ™å°±æ²¡æœ‰è¿™ä¸ªæ¶ˆæ¯æ¡†ï¼Œè‡ªåŠ¨é€€å‡ºç¨‹åºäº†ã€‚

æ­£ç¡®çš„key

    :u$YBPf2pa]Dt4#QM^H4ic'j0`w2y{d-Zzo2%/n_s@+2<UW)e4AR;F.4=-qEkvC2

ç¿»ç¿»æ•°æ®çœ‹åˆ°è¿™ä¸ªï¼š

.data:004187C0     dd      0, 4, 0, 7, 0, 0, 0, 0, 0
.data:004187E4     dd      9, 2, 0, 0, 0, 0, 6, 0, 7
.data:00418808     dd      8, 3, 0, 0, 0, 5, 4, 0, 0
.data:0041882C     dd      0, 1, 0, 0, 0, 3, 0, 0, 0
.data:00418850     dd      0, 0, 0, 2, 0, 1, 0, 0, 0
.data:00418874     dd      0, 0, 0, 5, 0, 0, 0, 4, 0
.data:00418898     dd      0, 0, 4, 9, 0, 0, 0, 7, 1
.data:004188BC     dd      3, 0, 5, 0, 0, 0, 0, 9, 4
.data:004188E0     dd      0, 0, 0, 0, 0, 8, 0, 6, 0

```c
int b[9][9] = {
    {5,6,1,9,2,3,8,0,0},
    {1,8,3,4,5,0,0,0,0},
    {7,6,2,1,9,0,0,0,0},
    {7,8,4,6,9,2,5,0,0},
    {4,5,3,9,7,8,6,0,0},
    {6,9,2,8,7,1,3,0,0},
    {2,8,5,6,3,0,0,0,0},
    {6,1,7,2,8,0,0,0,0},
    {1,7,9,3,4,5,2,0,0},
};
 
void s04()
{
    int i,j;
    char *t = "$BPV:ubfYp}]DtN>aT^MGmJQ#*Hr`O'wjic0!hdy{oZz-@n+?&%s_/g<e[W)XUxRFSLRA;.l=CEkvK-(q";
 
    for (j=0;j<9;j++)
    {
        for (i=0;i<9;i++)
        {
            if (b[j][i])
            {
                printf("%c", t[j*9 + b[j][i]-1]);
            }
            else
            {
                printf("%d\n",9-i);
                break;
            }
        }
    }
}
```




## âš¡2021KCTF æ˜¥å­£èµ› Q5
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-174.htm
- 2021 KCTF æ˜¥å­£èµ› é˜²å®ˆç¯‡ https://bbs.pediy.com/thread-266222.htm
- 2021 KCTF ç¬¬äº”é¢˜ åå±±è®ºå‰‘ https://bbs.pediy.com/thread-266937.htm

ç¬¬äº”é¢˜ åå±±è®ºå‰‘

æ­¤é¢˜æ˜¯ä¸€é“ Android é€†å‘é¢˜ï¼Œä½¿ç”¨è§„åˆ™å‚è€ƒé˜²å®ˆç¯‡ 5.2.2 æ–¹æ¡ˆäºŒï¼Œé˜²å®ˆæ–¹å‘å¸ƒ CrackMe åº”å‘å¤§ä¼—å…¬å¼€ä¸€ç»„ç”¨æˆ·åå’Œåºåˆ—å·ï¼Œå³ â€œName/Serialâ€ ï¼Œå…¶ä¸­å…¬å¼€çš„è¿™ä¸ªç”¨æˆ·åï¼Œå¿…é¡»æ˜¯è¯¥ CrackMe æ–‡ä»¶çš„ hash å€¼ä¸”ç®—æ³•æŒ‡å®šä¸º SHA256ï¼Œç”¨æˆ·åä¸º hash ç»“æœçš„å‰ 64-bit çš„ 16 è¿›åˆ¶å¤§å†™æ–‡å­—ã€‚

å¦‚æœ CrackMe ä¸æ­¢ä¸€ä¸ªæ–‡ä»¶çš„è¯ï¼Œè®¡ç®— hash æ—¶åº”åŒ…å« CrackMe çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆç¬¬ä¸‰æ–¹å…±äº«åº“é™¤å¤–ï¼‰ã€‚

```sh
# å…¬å¼€çš„ä¸€ç»„åºåˆ—å·ï¼š
name:ed8b9244350d3644
serial:7C9815255BFE832D3F93140B
```

åˆ¤èƒœæ¡ä»¶ï¼šè‹¥æ”»å‡»æ–¹æ‰¾å‡ºç‰¹å®šç”¨æˆ·åï¼ˆâ€œKCTFâ€ï¼Œä¸å«å¼•å·ï¼‰ çš„åºåˆ—å·ï¼Œå°†è®¤å®šæ”»å‡»æ–¹è·èƒœã€‚

å…ˆä½¿ç”¨ md5sum å’Œ sha256sum è®¡ç®—ä¸€ä¸‹æ–‡ä»¶æ‘˜è¦ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶ SHA256 çš„å‰ 64-bit ä¸€è‡´ï¼š

```sh
$ md5sum KCTF-2.sign.apk
7010e85266f2f59d20075d2ac9fb2d80  KCTF-2.sign.apk
$ sha256sum KCTF-2.sign.apk
ed8b9244350d3644f014d27e18dbda65d90f6581658d06cb4773de87f2d9d738  KCTF-2.sign.apk
```

ä½¿ç”¨ adx-gui-1.2.0.exe ç›´æ¥æŸ¥çœ‹ APK ä¸­çš„ Java ä»£ç ï¼Œå…¶ä¸­å…³é”®ç‚¹æ˜¯æŒ‰é”®ç‚¹å‡»äº‹ä»¶ï¼š

```java
public native String stringFromJNI(String str, String str2);

public void Btn1_Click(View view) {
    String str;
    String input = this.text.getText().toString();
    String input2 = this.text2.getText().toString();
    if (input == null || input.isEmpty()) {
        str = "nameä¸ºç©º";
    } else if (input2 == null || input2.isEmpty()) {
        str = "serialä¸ºç©º";
    } else {
        System.loadLibrary("hello-jni");
        str = stringFromJNI(input, input2);
    }
    AlertDialog.Builder builder = new AlertDialog.Builder(mContext);
    builder.setTitle("");
    builder.setMessage(str);
    builder.show();
}
```

é€šè¿‡ loadLibrary åŠ è½½ APK ä¸­çš„åº“æ–‡ä»¶ \lib\armeabi\libhello-jni.soï¼Œåº“æ–‡ä»¶å¯¼å‡ºä¸€ä¸ª stringFromJNI å‡½æ•°ï¼Œè¿™æ˜¯ä¸‹ä¸€æ­¥è¦è¿›è¡Œè·Ÿè¸ªçš„ä»£ç ã€‚

å…³é”®ä¿¡æ¯åŒ…æ‹¬å‡½æ•°ç­¾åï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼ŒæŒ‡å‘å­—ç¬¦ä¸²â€œæ­å–œæˆåŠŸâ€ï¼Œä¼ å…¥ä¸¤ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆã€‚

IDA åŠ è½½åŠ¨æ€åº“ï¼Œä½†æ˜¯ Exports çª—å£ä¸­æ‰¾ä¸åˆ°ç›¸åº”çš„å¯¼å‡ºæ–¹æ³•ï¼Œé€šè¿‡å¿«æ·é”® Ctrl+F ä¹Ÿæ‰¾ä¸åˆ° JNI_OnLoad å…¥å£å‡½æ•°ã€‚

ä½¿ç”¨ IDA çš„ android_server è°ƒè¯• APK æ—¶é»˜è®¤ä½¿ç”¨ç«¯å£æ˜¯ 23946ï¼Œå¯èƒ½æœ‰åè°ƒè¯•ä»£ç ä¼šæ£€æµ‹æ­¤ç«¯å£æ˜¯å¦å ç”¨ï¼Œæ‰€ä»¥ä¿é™©èµ·è§ä¸å¦¨ä½¿ç”¨åˆ«çš„ç«¯å£ã€‚

å¯ä»¥ä½¿ç”¨ ./android_server -p12345 æŒ‡å®šç«¯å£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ IDA æ‰“è¡¥ä¸ç›´æ¥é€†å‘ä¿®æ”¹é»˜è®¤ç«¯å£ã€‚æ‰“å¼€ IDA è½½å…¥ android_serverï¼Œè¿›å…¥ main å‡½æ•°ï¼ŒæŒ‰ F5 æŸ¥çœ‹ä¼ªä»£ç ï¼Œå®šä½åˆ° 23946ï¼ˆ0x5dbaï¼‰ä½ç½®ï¼Œç›´æ¥ä¿®æ”¹å³å¯ã€‚ å¯ä»¥æŠŠ 5D BA æ”¹ä¸º 39 30ï¼Œå³ 12345 ç«¯å£ã€‚

ç„¶åå°†è°ƒè¯•æœåŠ¡ç¨‹åºä¼ é€åˆ° Android ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ç”¨ /data ç›®å½•ï¼š

    $ adb push C:\IDA_Pro_7.6\dbgsrv\android_server64 /data
    $ adb shell chmod +rwx /data/android_server64

    $ adb shell /data/android_server -p23946
    IDA Android 32-bit remote debug server(ST) v7.5.26. Hex-Rays (c) 2004-2020
    Listening on 0.0.0.0:23946...

Apktool å¯ä»¥ç”¨æ¥ è§£å‹ APKï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ unzip è§£å‹å¯èƒ½å¾—åˆ°ä¸€äº›ä¸å¯é˜…è¯»çš„æ–‡ä»¶ï¼Œå¦‚ AndroidManifest.xml æ˜¯äºŒè¿›åˆ¶ç¼–ç çš„æ ¼å¼ã€‚

    apktool_2.5.0.jar d KCTF-2.sign.apk

ä» AndroidManifest.xml æ–‡ä»¶å¯ä»¥æŸ¥è¯¢åˆ°ç¨‹åºçš„ Activity å…¥å£ç±»åï¼Œç„¶åå®‰è£…éœ€è¦è°ƒè¯•çš„ APK å¹¶æ‰§è¡Œç­‰ç­‰å¾…è°ƒè¯•ï¼š

    $ adb install \ctf\q5\KCTF-2.sign.apk
    $ adb shell am start -D -n com.example.hellojni/.HelloJni
    Starting: Intent { cmp=com.example.hellojni/.HelloJni }

ä½¿ç”¨ -D å‚æ•°ç›®çš„æ˜¯è°ƒè¯•ç¨‹åºçš„å¯åŠ¨è¿‡ç¨‹ï¼Œæ­¤æ—¶ Android è®¾å¤‡ä¸Šä¼šç»™å‡ºæç¤ºï¼šâ€œWaiting For Debuggerâ€ï¼Œè¡¨ç¤ºæ­£åœ¨ç­‰å¾…è°ƒè¯•å™¨çš„é“¾æ¥ã€‚

ä¹Ÿå¯ä»¥è®© APP æ­£å¸¸å¯åŠ¨ï¼Œç„¶å IDA ä¾ç„¶å¯ä»¥ attach åˆ°å·²ç»è¿è¡Œçš„è¿›ç¨‹ä¸Šï¼Œä½†æ˜¯è¿™æ ·æ— æ³•è°ƒè¯•åˆ° APP å¯åŠ¨é˜¶æ®µçš„é€»è¾‘ã€‚

æ³¨æ„ï¼Œç›´æ¥ä¼ é€’åˆ° /sdcard å°†å¯¼è‡´ä¸èƒ½ä¿®æ”¹å¯æ‰§è¡Œæƒé™ï¼Œä¼ é€åˆ° /bin ç›®å½•å¯èƒ½é‡åˆ° Read-only é—®é¢˜ã€‚

è¿æ¥ android_server è°ƒè¯•æœåŠ¡åå‘ç°åªæœ‰ä¸€ä¸ªå¯ç–‘çš„ç¬¦å·ï¼Œä½†æŒ‡ä»¤æ ¼å¼å®Œå…¨ä¸å¯¹ï¼Œé‡å¤çš„ MOVS R0, R0ï¼Œä¹Ÿæ— æ³•æ–­ç‚¹è¿è¡Œï¼š

```java
text:000010E4 Java_com_example_hellojni_HelloJni_stringFromJNI
.text:000010E4                                         ; DATA XREF: LOAD:000001B8â†‘o
.text:000010E4                                         ; .got:Java_com_example_hellojni_HelloJni_stringFromJNI_ptrâ†“o
.text:000010E4 ; __unwind {
.text:000010E4                 PUSH            {LR}
.text:000010E6                 BL              sub_5000
.text:000010EA                 MOVS            R0, R0
.text:000010EC                 MOVS            R0, R0
...
```

è¿™ç§æƒ…å†µè¶…å‡ºç°æœ‰è®¤çŸ¥ï¼Œæ„Ÿè§‰æ˜¯èŠ±æŒ‡ä»¤å¯¼è‡´ IDA åæ±‡ç¼–å¤±è´¥ï¼Œæ²¡æœ‰æ­£ç¡®è§£æ ARM å’Œ Thumb æŒ‡ä»¤ä»£ç ã€‚

ä¸‹ä¸€æ­¥å®‰æ’å°±æ˜¯èµ¶ç´§è¡¥è¯¾ï¼Œé˜…è¯» IDA Pro æƒå¨æ•™ç¨‹ï¼Œå…ˆè¿‡ä¸€éï¼Œç­‰å…¶å®ƒäººå…¬å¸ƒ writeup æ€»ç»“ç»éªŒå†è¯´ã€‚

    æŸ¥çœ‹æ¨¡å—åŠ è½½åŸºåœ°å€cat /proc/7009/maps |grep hello

    éœ€è¦æ‰“å¼€Dalvik Debug Monitor(DDMS)ï¼Œä¸è¿‡éš¾å¾—è¿™ä¹ˆæœ‰å¿ƒã€‚
    DDMS è¦æ‰“å¼€,appçš„debuggableè¦ä¸ºtrue,å®åœ¨ä¸è¡Œçš„è¯éƒ½å…³æ‰å†é‡æ–°å¼€å§‹

    æˆ‘æœ‰æ‰“å¼€DDMSï¼Œæ­£å¸¸é™„åŠ äº†ï¼Œä½†æ˜¯è²Œä¼¼æ²¡æ³•è°ƒè¯•ï¼Œä¸çŸ¥é“å“ªé‡Œå‡ºäº†é—®é¢˜ã€‚
    è¿˜æœ‰ï¼Œæˆ‘jdbè¿æ¥çš„ç«¯å£é‚£é‡Œï¼Œå› ä¸ºæˆ‘è°ƒè¯•çš„æ˜¯å®‰å“æ¨¡æ‹Ÿå™¨ï¼Œç«¯å£é8600/8700ï¼Œæ‰€ä»¥æˆ‘æŠŠè¿™é‡Œçš„ç«¯å£æ”¹æˆäº†å®‰å“æ¨¡æ‹Ÿå™¨é€šä¿¡ç«¯å£ï¼ˆ64XXXï¼‰ï¼Œè¿™åº”è¯¥æ²¡é—®é¢˜å§ï¼Ÿ


    BLæ˜¯ IDA é…ç½®çš„é—®é¢˜ï¼Œåˆšå¼€å§‹æˆ‘ä¹Ÿç–‘æƒ‘äº†å¾ˆä¹…ï¼Œarmçš„æ ‡å‡†ä¸€ç›´åœ¨æ¼”è¿›ï¼ˆä¾‹å¦‚ v5ã€v7ï¼‰ï¼Œè¿™ä¸ª so åœ¨å£°æ˜æ—¶ä½¿ç”¨çš„æ˜¯ v5ï¼ˆä½¿ç”¨ readelf -Aï¼‰ï¼Œä½†è¿™ä¸ªæœºå™¨ç ç–‘ä¼¼æ˜¯ v7 æ‰æœ‰çš„ï¼Œå¯¼è‡´ IDA è¯†åˆ«é”™è¯¯ï¼ˆä¹Ÿå¯èƒ½æ˜¯ IDA æœ¬èº«é»˜è®¤å°±æ˜¯è¿™ä¸ªé”™è¯¯çš„é…ç½®ï¼‰ã€‚

    æ­£ç¡®çš„ IDA é…ç½®æ–¹å¼ï¼š IDA options -> Processor specific analysis options -> Edit ARM architecture options -> ARMv5T -> Thumb-2 

å‡ºé¢˜æ€è·¯ï¼š

å…¶ä¸­è§„åˆ™ 2 çš„ä¸¤ç»„åºåˆ—å·å¦‚ä¸‹ï¼š

    name:ed8b9244350d3644
    serial:7C9815255BFE832D3F93140B

    name:KCTF
    serial:17726331DA0fE737149c8202
 
è®¾è®¡æ€è·¯ï¼š
1.å¯¹è¾“å…¥nameå­—ç¬¦ä¸²é€šè¿‡SHA1ç®—æ³•(ç¨å¾®æ”¹åŠ¨)è®¡ç®—å¾—åˆ°24å­—èŠ‚çš„hashå€¼
2.hashå€¼åšæ˜æ–‡å’ŒJava_com_example_hellojni_HelloJni_stringFromJNIåœ°å€åšå¯†é’¥Kå‚ä¸rc4è¿ç®—(ç¨ä½œä¿®æ”¹)ï¼Œå…¶ä¸­hashå‰12å­—èŠ‚ä¸å¯†é’¥æµæŒ‰ä½åšå¼‚æˆ–å¹¶ä¸hashå12å­—èŠ‚æŒ‰ä½ç›¸åŠ å¾—åˆ°æ–°çš„12å­—èŠ‚ä¸²å€¼
3.å°†æ–°å¾—åˆ°çš„åå…­è¿›åˆ¶12å­—èŠ‚ä¸²è½¬æ¢ä¸ºASCIIç å½¢å¼å³ä¸º24å­—èŠ‚çš„serialå€¼

ä¿æŠ¤æ–¹æ³•:
é€šè¿‡æ±‡ç¼–å®ç°äº†ä¸€å¥—æ¨¡æ‹Ÿadd/sub/eor/push/popç­‰æŒ‡ä»¤çš„å‡½æ•°å—ï¼Œå¯¹soçš„å‡½æ•°æŒ‡ä»¤æµåšåˆ†æï¼Œéœ€è¦ä¿æŠ¤çš„æŒ‡ä»¤åšæŒ‡ä»¤è·³è½¬æ›¿æ¢åç”Ÿæˆä½ç½®æ— å…³çš„shellcodeï¼Œå¹¶patchåˆ°soçš„æœ«å°¾ç”Ÿæˆæ–°soæ–‡ä»¶ï¼ŒåŸå‡½æ•°çš„å¤´éƒ¨æ›¿æ¢æˆè·³è½¬æŒ‡ä»¤è·³è½¬åˆ°patchä½ç½®æ‰§è¡Œï¼Œè¢«ä¿æŠ¤åçš„add/sub...ç­‰æŒ‡ä»¤ï¼Œä¼šä»¥è·³è½¬æŒ‡ä»¤çš„å½¢å¼è·³åˆ°å¯¹åº”çš„æ¨¡æ‹Ÿå‡½æ•°æ‰§è¡Œã€‚

 
è§£é¢˜æ€è·¯ï¼š
ç”±äºdemoç¼–è¯‘åé€šè¿‡ï¼Œå¯¹ä»£ç æ®µçš„æŒ‡ä»¤åšäº†å˜å½¢ä¿æŠ¤ï¼Œé€šè¿‡ç›¸åŒåŠŸèƒ½çš„å‡½æ•°å®ç°æŒ‡ä»¤æ›¿ä»£è¿è¡Œï¼Œæ‰€ä»¥åç¼–è¯‘æ—¶ï¼Œä¸å®¹æ˜“çœ‹å‡ºç®—æ³•é€»è¾‘ï¼Œéœ€è¦å¯¹æ¨¡æ‹Ÿä»£ç æ ‡è¯†å‡ºç›¸åº”çš„æŒ‡ä»¤æ¥åˆ†æé€»è¾‘ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨ä¸éœ€è¦æ ‡è®°çš„æƒ…å†µï¼Œåªéœ€è¦æ‰¾åˆ°å…³é”®åšå¼‚æˆ–ä¹‹å¤„å³å¯ï¼šé¦–å…ˆåœ¨æ–‡ä»¶åç§»0x6448ä¸‹æ–­ç‚¹ï¼Œåœ¨0x76A8å°±å¯ä»¥è·Ÿè¸ªå‡ºserialçš„ç»“æœã€‚

å…³äºä½œè€…
ç›®å‰å°±èŒäºæ¢†æ¢†å®‰å…¨ï¼Œä»äº‹å¤šå¹´äºŒè¿›åˆ¶ä¿æŠ¤å·¥ä½œæ–¹é¢çš„ç ”ç©¶ï¼ŒæœŸé—´ä¹Ÿè´Ÿè´£ç§»åŠ¨appåˆè§„æ£€æŸ¥,appè½¯ä»¶å®‰å…¨æµ‹è¯„åŠå›ºä»¶å®‰å…¨æµ‹è¯„ç­‰å·¥ä½œã€‚


## âš¡2021KCTF æ˜¥å­£èµ› Q6
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-175.htm

çœ‹é›ª.æ·±ä¿¡æœ 2021KCTF æ˜¥å­£èµ› ç¬¬å…­é¢˜ å¯»å›å®å‰‘

æ­¤é¢˜æ˜¯ä¸€é“ Windows é€†å‘é¢˜


## âš¡2021KCTF æ˜¥å­£èµ› Q7
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-176.htm

ç¬¬ä¸ƒé¢˜ åƒé‡Œå¯»æ ¹


## âš¡2021KCTF æ˜¥å­£èµ› Q8
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-177.htm

ç¬¬å…«é¢˜ ä¼—å›äº²ç¦»


## âš¡2021KCTF æ˜¥å­£èµ› Q9
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-178.htm

ç¬¬ä¹é¢˜ å¹³å®šæˆ˜ä¹±


## âš¡2021KCTF æ˜¥å­£èµ› Qa
- çœ‹é›ª.æ·±ä¿¡æœ KCTF 2021 æ˜¥å­£èµ›! https://ctf.pediy.com/game-season_fight-179.htm

ç¬¬åé¢˜ ä¸€ç»Ÿæ±Ÿæ¹–
