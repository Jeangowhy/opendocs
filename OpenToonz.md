# Eyeball 演示项目
- https://zhuanlan.zhihu.com/p/361903734

声明：图片来源于网络，KenHub Anatomy 解剖学课程网站及维基百科，版权属于相关网站及相关作者。
网址：https://www.kenhub.com/en/library/anatomy/structure-of-the-eyeball

要点：

- 光的直接传播，平行光经过凸透镜会聚集，曲度越大焦距越短，晶状体就是一个软的凸透镜。
- 眼球的简单结构的顶视图，从上往下看右眼的横切图。
- 睫状肌收缩时，睫状肌的位置上移，悬韧带松弛，晶状体受到的牵拉力减少，曲度增加，就是变厚，适应看近处物体。
- 悬韧带如果失去拉力，不能让晶状体变薄，远处物体就不能对焦到视网膜，这就是近视。
- 相反，悬韧带不能放松，总是将晶状体拉得很薄，那么就只能看到远处的物体，这就是远视。

为了描述人体中的结构，沿着剖切面切开后以显示器官的结构和位置关系，解剖学采用四个解剖平面术语：

- *正切面* Frontal Plane —— 将标本正面和背面分开的垂直切口。也称为冠状面 Coronal Plane。 - *横切面* Transverse Plane —— 将试样顶部和底部分开的水平切口。也称为横截面。 - *中矢面* Midsagittal Plane —— 垂直切割试样的准确中心线，将左半部分与右半部分分开。 - *副矢状面* Parasagittal Plane —— 偏离中心的垂直切口，将试样的左侧和右侧分开成不相等的部分。不管是左侧还是右侧更大，只要它们不相等。
眼球的球壳由三个不同的层组成，它们构成眼球的圆形轮廓。

从表层到深层（外层到内层），它们包括：

- 眼球的最外层：纤维层（包括巩膜和角膜），*巩膜*是包围眼球的后六分之五的白色不透明层，*角膜*是透明层，与巩膜前方相连，占据眼球的前六分之一。
- 眼球的中间层：血管色素层（包括脉络膜、睫状体、虹膜），也称为葡萄膜。它由彼此连续的三个部分组成，从后到前分别是*脉络膜*、*睫状体*和*虹膜*。
- 神经层，即视网膜，这是眼球的最内层。视网膜本身被分成两层，外部色素层和内部神经感觉层。


巩膜是眼球壁的最外一层，由致密的胶原和弹力纤维构成，其结构坚韧，不透明，质地坚硬呈磁白色。血管很少，前面与角膜，后面与视神经硬膜鞘相连。巩膜表面被眼球筋膜和结膜覆盖。

眼球的内部包含两个光学折射结构，称为*晶状体*和*玻璃体*。玻璃体和晶状体与角膜和房水一起属于眼球的*屈光介质*。折射结构的作用是使落在眼睛上的光的方向弯曲并将其聚焦到*视网膜*上。

在眼睛的横截面上，我们可以识别出充满房水的眼球的两个腔，即前房和后房。前房位于角膜和虹膜之间，后房是在虹膜和晶状体之间的狭缝状腔。

血管色素层，也称为葡萄膜，由彼此连续的前后三层组成。从后到前，分别是脉络膜、睫状体和虹膜。虹膜向前开口的区域称为瞳孔。

睫状肌分为三种：

- ①子午方向，就是与视网膜近似平行，向地球的子午线一样的方向。
- ②环形纤维，与瞳孔括约肌类似走形。
- ③两者之间的斜向纤维。

当睫状肌收缩时，子午方向的纤维向前（即向角膜）收缩，环形纤维向内收缩（想象瞳孔括约肌收缩带来的缩瞳效果）。睫状体与晶状体更加靠近，之间的间隙变小，悬韧带显然松弛。

每个孩子天生都是远视眼，正常在 3 岁以前的孩子都应具有 300 度的远视储备，由于生长发育的原因，眼球较小，眼轴并未达到成人水平，眼睛的前后轴较短，眼睛所看到的景物是聚焦到视网膜的后方。类似远视眼的情况，不过孩子的这种远视是生理性的，随着孩子不断的生长发育和眼球成熟，会逐渐成为正视眼。

眼球的透明部分，包括角膜、晶状体，玻璃体可以使进入眼内的光线折射、聚焦，晶状体的厚度和弯曲度可由睫状肌的活动而改变，适当的调节使进入光线恰好聚焦在视网膜上，成为一个清晰的倒像，这一点人眼与照相机确有相似之处。

用照相机拍摄远近不同距离物体时，必须相应改变镜头与底版之间的距离，使光线恰好聚焦在底版上，照片才能清晰。人的眼球内屈光间质的距离则不能随意改变，人是通过改变晶状体屈折力相应增减来看清不同距离物体的，也就是通过眼的调节功能来完成。

当物体位于 2 倍焦距之外时，经过凸透镜的成像是倒立缩小的实像，像的位置在 1、2 倍焦距之间。照相机通过调节镜头焦距，使像精确地成在底片位置，就能得到清晰的照片。

# Moon Jeelyfish 海月水母
- Moon Jellyfish - Aurelia aurita (Linnaeus, 1758) https://www.biolib.cz/en/taxon/id43631/
- https://vitalcute.com/wp-content/uploads/Moon-Jellyfish-Pictures-6.jpg

kingdom Animalia - animals »  phylum Cnidaria - anemones, corals and jellyfish »  class Scyphozoa »  order Semaeostomeae »  family Ulmaridae »  genus Aurelia

Scientific synonyms
Aurelia coerulea von Lendenfeld, 1884
Other names
= Common Jellyfish
= Moon jelly
= Saucer jelly

海月水母，Aurelia aurita (Linnaeus, 1758)，是羊须水母科海月水母属下的一种水母。海月水母属物种的水母体单从外观根本不能分辨，必须要以基因来作出分析。海月水母的水母体是透明的，一般阔25－49厘米，有4条明显的马蹄状生殖腺。它们会用触手来捕捉猎物，如水母体、浮游生物及软体动物。但触手的活动有限，它们也只是会随波逐流。生活在大西洋、太平洋、印度洋。

海月水母的水母体有呈伞状的膜及连于底部的触手。它们胃部下有四个鲜明的环形生殖腺。食物会进入到其垂管，而辐水管则帮助扩散食物。它们有一层中胶层，胃循环腔内有胃皮及表皮。神经网络负责控制肌肉及觅食反应。水母体的直径可以阔达40厘米。 海月水母没有鳃、肺或气管等呼吸部分。由于它们细小，故是透过扩散水中的氧气来呼吸。在胃循环腔内，它们会排出低充氧水，并以纤毛作用将高充氧水拉入，从而增加细胞的氧气扩散。它们的表面积与体积的高比例亦帮助它们吸入更多氧及养份。它们亦缺乏排泄系统及循环系统。 水母体可以是雄性或雌性。浮浪幼体有细小的纤毛细胞，可以浮游一日之久，接着会在适当的底层定居，并会转变成为水螅体，水螅体透过横裂会分裂成细小的蝶状幼体，长大后就会成为水母体。由最初的浮浪幼体到蝶状幼体，其体型会由1毫米增长至约1厘米，及后会成长至几厘米直径的水母体。


# OpenToonz 二维动画制作
---------------------
[OpenToonz Home](https://github.com/opentoonz/opentoonz)
[OpenToonz User Manual](https://opentoonz.readthedocs.io/en/latest/index.html)
[What’s New in OpenToonz](https://opentoonz.readthedocs.io/en/latest/whats_new.html)
[「迪士尼九大元老」 Walt Disney's Nine Old Men](https://www.zhihu.com/question/20710662)
- https://opentoonz.readthedocs.io/en/latest/managing_projects.html
- https://opentoonz.readthedocs.io/en/latest/setting_up_a_scene.html
- https://opentoonz.readthedocs.io/ja/latest/using_ffmpeg_with_opentoonz.html
- https://opentoonz.readthedocs.io/en/latest/using_the_version_control.html
- https://opentoonz.readthedocs.io/en/latest/using_the_toonz_farm.html
- https://www.toonzpremium.com/

OpenToonz 是基于意大利动画制作公司 Digital Video 旗下 TOONZ 专业动画软件的开源产品，曾被日本吉卜力工作室 Studio Ghibli 采用的动画制作工具。2016 年 3 月 19 日，Toonz 发出开源版的 OpenToonz，在 Github 公开其源码。此动画软件项目免费开源版由 Dwango 公司发起，基于吉卜力定制软件 Toonz 开发，支持跨平台使用。最新的收费版本为 Toonz Premium 7.4。

- 支持 64 位 Windows 系统或 OS X 10.9+。
- 不少于 4G 内存和 1280×1024 分辨率。

OpenToonz 虽然是免费软件，但它极为专业。节点结构的控制流程使其在特效和合成上也有不错表现。而且作为开源软件，它允许代码修改、插件开发和包括商用在内的无偿使用。软件界面基于 Qt 5.5.0 开发。

官网提供最新版 OpenToonz 1.4.0 下载，同时提供了纸质原图扫描处理辅助工具 GTS。还有云彩生成工具 KumoWorks，会根据给出的环境生成云层，只需要绘制云层轮廓 silhouette 就可以生成各种云层：

- Altostratus/Flat 高层云/扁平云
- Cumulonimbus 积雨云
- Cumulus/Fluffy 积云/羽积云
- Fractus 断层云
- Volcanic Smoke 火山烟雾

使用 KumoWorks 生成云层，只需要打开程序，在 Draw 模式下绘制云层轮廓线，然后按回车或点击 Preview 即会根据各种参数生成云层。多个云层可以在左下角的 Could Layers 中添加。

新版本提供了辅助图层 Assistants Level，给辅助图层添加 Assistant 工具可以进行 Ellipse/Line/Vanishing Point 透视线辅助。

不过这个软件也有大部分开源软件共有的弊病就是稳定性差，经常崩溃，可以设置自动保存或经常手动保存。

OpenToonz 集成 SVN 作为文件版本管理工具，还支持渲染农场。支持 ToonzScript 脚本编程，这是一种 ECMAScript 兼容脚本，和浏览器使用的脚本类似，可以用来做程序化的动画，或者文件处理之类。

创建项目时可以设置场景基本属性，如播放帧率、画面分辨率，使用的单位制等，创建项目后通过 Xsheet → Scene Settings… 修改。

要切换项目，执行 File → Project Management → Project Settings… 选择 Project 列表中的项目。

Project Default Folders

- *+inputs* 扫描输入的文件，如 TIF 文件。 - *+drawings* 经过 OpenToonz 清理的绘图，可以是导入的 TLV、PLI 文件，或者是直接 OpenToonz 内绘画的。 - *+scenes* 场景文件目录，保存 TNZ 文件。 - *+extras* 其它文件，保存导入的非 OpenToonz levels 或者图像、音频文件。 - *+outputs* 用于保存渲染输出的目录。 - *+palettes* 工程调板配置目录，保存供整个项目使用的 Raster Drawing Palette。
可以定制专属目录，并使用相关别名。只需要在 OpenToonz stuff\profiles 配置目录下设置 *project_folders.txt* 文本文件，也可以通过此文件来修改默认的目录配置，每个目录占一行。

创建项目时，可以勾选使用附加 *$scenepath* 这个变量到 *+drawing* 这些目录。即保存绘图文件时，会添加上以场景名称为目录名的子目录。即按场景进行文件管理，对于大项目，文件数量较多的情况可以使用。

OpenToonz 本身没有视频导出功能，只能渲染图像帧，但是可以整合 FFMPEG 来合成图片序列和音频，生成 mp4 或 webm、gif。

另外，官方网站上提供了 Sample Data 示范教程数据包。


## Working Flow 工作流程
- https://opentoonz.readthedocs.io/en/latest/production_workflow.html

2D 动画制作的可以按传统流程或无纸化流程进行，基本流程步骤如下：

- 策划
	- 故事、脚本、编剧 Story & Script
	- 概念设计 Concept & Graphic Design
	- 分镜故事板 StoryBoard
	- 初步分镜动画 Animatic StoryBoard
- 素材
	- 手绘原稿 Hand-Drawn Animation Levels
	- 扫描入电脑 Scanning
	- 无纸化手绘 Paperless Drawing
- 动画绘制
	- 帧动画绘制 Animation
	- 素材图层化管理 Layout
- 上色
	- 配置调板设置色彩模型 Palettes & Styles
	- 上色 Ink & Painting
- 合成 Compositing
	- Xsheet/Timeline
	- Camera
	- Stage Schematic
	- FX Schematic
	- Function Editor
- 渲染生成
	- 渲染任务中心 Render Farm
	- 图片序列生成 Frames Render(TIF, PNG, TGA, JPG...)
	- 影片生成 QuickTime、 MP4、 WebM
	- 或 GIF、 Spritesheet


在传统 2D 动画制作过程中，原画师手稿需要扫描入软件处理，扫描的图像文件需要经过清理，图形中心的对齐，图像的裁剪缩放，线条清理，转换成 Toonz 光栅图层文件 TLV，手稿使用的颜色转化到调板的样式保存到 TPL 调板文件，可以通过 Color Model 加载。通过适当的 Cleanup Settings，通过菜单 Scan & Cleanup - Preview Cleanup 检查设置正确结果，再选中 Xsheet 中需要清理的手稿图层，执行菜单的 Cleanup 进行清理。

OpenToonz 很完整地支持了整个工作流，功能强大，2D 动画制作工业化程度极高，支持：

- 支持矢量和栅格层级，矢量图 Vector、OpenToonz 专用光栅、 和标准光栅 Raster 图层
- 实现反关节 Inverse Kinematics 的简易关节 Skeleton 与塑形工具 Plastic
- 动画函数/曲线编辑器 Function/Curve Edidtor
- 舞台与特效规划 FX/Stage Schematic
- 摄影表 Xsheet 与时间轴 Timeline
- 调板 Palettes 与样式 Styles
- 多帧颜色填充 Fill & Frame Range
- 洋葱皮 Onion Skinning
- 追踪工具 Tracker
- 后期特效 Effects

动画制作故事永远是核心要素，动画场景和角色表现是表达故事的手段，而绘画或美术修养则是基本内涵。

原画是指动画创作中一个场景动作之起始与终点的画面，以线稿呈现。阴影与分色的层次线也在此步骤时画进去。原画师，也称为 Key-Animator 或 Illustrator，主要是根据故事情节设计相应的动画关键动作，在电脑设计中也称关键帧 Keyframe，原画创作是决定动画片动作质量好坏最重要的一道工序。有些动画工场还又大量的第二原画，他们协助第一原画处理原画稿，将潦草的线稿经过清理形成整洁的稿件。当然，有一些动画片种里不存在原画的概念，如沙土动画，黏土动画，剪纸动画 Cutout Animation 等定格动画 Stop Motion Animation 都不存在原画的概念。

美国迪斯尼公司为典型，在他们的片子中，原、动画的质量水准差距不大，张数较多，原画的概念较弱，一套动作是一气呵成，原画不很分明。而日本动画制作原、动画的水平差距较大，同时因为日本动画通常以叙事为主，讲究情节，不追求动作画面的流畅性，更为重视动作的结果，所以原画的概念就较强。



## User Interface 用户界面
- https://opentoonz.readthedocs.io/en/latest/managing_projects.html
- https://opentoonz.readthedocs.io/en/latest/interface_overview.html
- https://opentoonz.readthedocs.io/en/latest/working_in_xsheet.html
- https://opentoonz.readthedocs.io/en/latest/creating_movements.html#working-in-a-3d-environment
- https://opentoonz.readthedocs.io/en/latest/drawing_animation_levels.html
- https://opentoonz.readthedocs.io/en/latest/editing_animation_levels.html
- 口型动画制作教程 Papagayo https://www.bilibili.com/video/BV1ri4y1K7v2

安装 OpenToonz 通过语言选项可以设置中文界面，在偏好菜单中修改 File > Preferences... > Interface。

OpenToonz 1.3/1.4 版本，可以设置触屏手势和 Windows Ink 支持，在 Preferences - Touch/Tablet Settings 设置。在触屏支持上 OpenToonz 1.2 还欠缺，不能支持 Surface Book 上触控的压感。长时间的系统运行可能导致 OpenToonz 的压感不能正常工作，在勾选工具选项 Pressure 时会导致压感失效。

打开 OpenToonz 主界面，在菜单栏右侧，提供预置的适用不同动画工序的界面布局：

- Basics 基本绘图面板布局；
- Cleanup 草稿清理工序使用的布局；
- Drawing 绘图布局；
- Timeline 时间线布局；
- Animation 动画布局；
- Platte 调板管理布局；
- Xsheet 摄影表布局；
- Browser 文件浏览器布局；
- Farm 渲染农场；

也可以通过 Windows 菜单来设置要显示的面板，Windows - Workshop 菜单可以恢复默认视图布局，也可以锁定面板。

主要界面面板：

- Viewer 主要的绘图及预览区；
- Cleanup Settings 手稿清理属性设置；
- File Browser 文件资源浏览器，用来加载文件系统的资源，比如库目录下的粒子图形、纹理等；
- Scene Cast 场记，查看场景加载的各种资源；
- Level Strip 绘画序列；
- Level Palette 调板，管理当前 Level 图纸使用的画笔样式；
- Style Editor 样式编辑器；
- Color Model 查看当前 Level 的颜色模型信息；
- Schematic 节点规划，提供节点编辑功能，主要有 Stage Schematic、 FX Schematic；
- Function Editor 动画效果功能编辑区，编辑场景内容所有动画效果，可以进行曲线编辑；
- Xsheet & Timeline 摄影表编排场景动画，两者可以互相切换；
- Tasks 场景渲染任务队列，批量动画场景渲染；
- Batch Servers 渲染处理服务器；

OpenToonz 以工程加场景的方式组织动画项目，工程设置了各种专用目录来保存特定的资源，如 drawings 目录存放绘图文件，palettes 目录保存调板文件，scenes 保存场景文件等等。场景中的摄像机可以用来做动画，通过 Xsheet → Scene/Camera Setting 可以设置动画场景的帧率及输出文件的分辨率。虽然可以给场景添加多个摄像机，但同时只有一个工作，当前这个工作的相机可以在 FX Schematic 后期特效规划面板中的 Output 节点指定。类似的 Output 节点也可以添加多个，但是等价一个有效输出节点，渲染输出的文件的分辨率由选定的摄像机决定。

图纸 *Level* 是最基本的绘画对象，这里可以看作一张图纸，多张图纸可以用一个文件进行保存，对应文件的多个图层。使用层级条面板 *Level Strip* 进行管理，各个图层或序列可以在 Xsheet 中的 Cell 指定显示出来。通过弹出菜单 Level Settings 可以看到 Level 名称和保存位置及文件名，还有分辨率等信息。

打开 OpenToonz 界面后，首先 *Viewer* 面板是最明显的，它作为主要的绘图及动画预览区。使用 P 或 L 快捷键来播放动画，在面板右上角，提供了三个按钮对应三各镜头模式：

- Camera Stand View 固定视图，方块带圆圈的图标，回放场景时，工作区域静止不动，而所有其他元素（包括摄影机）都相对于当前位置移动。
- 3D View 三维视图模式，图标是三个层叠的平面，用于激活或禁用构成场景的元素的 3D 视图。
- Camera View 标准镜头模式，摄像机图标按钮，用于保持表示摄影机的框静止，同时所有其他元素相对于摄像机置移动。当有摄像车或旋转时，它可以帮助您更好地理解快照。

在视图模式按钮右边，有一个暂停符号的按钮，它用来冻结当前的画面，在播放动画时就会固定不变。

在 3D View 视图模式下，可以使用工具栏中的工具：

- Animate Tool 来改变对象的位置，按住 Ctrl 调整 Z 轴位置；
- Rotate Tool 工具来旋转视图；
- Hand Tool 移动 3D View；

摄影表 *Xsheet* 与时间轴 *Timeline* 等价，只是显示方式的差别，前者竖直方向为时间轴，后者水平方向为时间轴。

Xsheet 以列为图层以行为帧 Frame，每层的一个单元格 Cell 即对应显示一个 Level 图纸，双击 Cell 即可以指定要显示的 Level 名称和图纸序列。Xsheet 可以保存为 HTML 网页文件以共享浏览。工程的 Scene 文件打开后，其内容就可以通过 Xsheet 访问或修改。

可以使用右键菜单 Fill In Empty Cells 来填充当空白帧，会自动延续前面的帧内容。或者，选择多个帧，可以包含空白帧，然后使用右键菜单 Edit Cell Number -> Auto Fill Cell Number... 进行序列填充，在使用 Sub-Xsheet 组件图层时非常有用。

摄影表面板中，每一列都对应一个轨道，可以是音频轨道、位图轨道、矢量图轨道，每个轨道竖直往下就是时间线，轨道顶部提供：

- *Name* 轨道名称，列如默认名称格式带列序号或图层序号，如 Col5； - *Lock* 轨道名称下方色块左侧，有锁头图标，切换轨道的锁定状态； - *Camera Stand View* 轨道名称下方色块右侧，固定机位模式切换，允许您在使用当前帧光标拖动音频时包括或不包括列/层内容； - *Render Toggle* 对于音频轨道，轨道名称下方可以切换是否在播放时渲染音轨内容； - *Loudspeaker* 扬声器图标，用于音频轨道播放声音，竖直滚动条，用于音频轨道音量调整，要创建音轨 Soundtrack，只需要导入音频文件即可； - *Additional* 额外设置，图标为一个向下的三角形；
在缩略图下方显示当前轨道连接的父节点，通常是 Table，也可以是 PegBar 或其它轨道，显示为 Col 加轨道号，可以通过 Stage Schematic 查看节点的连接关系。

在右侧 Frame 序号的右边，有一个红、绿色半圆组成的圆形，它是洋葱皮工具 Onning Skin，用来设置显示前后多少帧的内容作为影子参考。

OpenToonz 有多种轨道类型：

- Note Level 注解轨道；
- Mesh Level 网格轨道，使用 Plastic 塑形工具创建；
- Soundtrack 音频轨道，需要通过导入音频，或者使用录音面板来创建；
- Raster Level 光栅位图格式，可以使用 Browser 面板导入 MP4 视频帧图像；
- Vector Level 标准矢量格式；
- Toonz Raster Level 专属格式，可以在单个文件存在多个 Level；
- Scan Level 通过 OpenToonz GTS 扫描输入的格式；

在现有轨道头部，通过右键菜单 Insert Before/After 可以插入新的轨道，然后在后面的 Frame 格子上通过右键菜单插入或加载内容，New/Load Level，或者直接创建空白帧 Create Blank Drawing。

每个格子对应轨道中的一个 Frame 的内容，在选中状态下，下侧会有一个 Step 控制按钮，用来增减帧的时间跨度。

但是，每个帧的内容移动这个 UI 设计比较死板，隐藏在 Cell 左侧边缘。也可以通过 Cut/Paste 来进行格子间的移动，同样，轨道的前后移动也可以通过 Cut/Pasete 操作实现。

摄影表还可以插入及编辑音轨 Soundtrack，通过 Alt-A 打开录音面板，或在指定 Cell 右键菜单 Load Level 加载音频文件。注意，Cell 左侧边缘有一块色块，通过它可以移动 Cell，结合控制键 Shift 变换移动/Ctrl 选区复制移动/ Alt 剪切移动。 

在 XSheet 选中 Cell 的下方有一个 Fill Handle 色块，如果是 Timeline 则在上 Cell 部，拖动它可以快速填充，按下 Ctrl 可以编辑 Cell 的开头。如果选择的 Cell 是有序的，则填充是会保持顺序。


拖动 Level Strip 中的图层内容可以直接给格子设置图像，或者双击格子，然后输入 Level Strip 名称，区分大小写，然后用空格隔开再输入 Level 序号，或者直接输入序号。

多个轨道上的 Raster Level 或 Toonz Raster Level 内容可以进行合并：

- 遵循框架编号顺序；这意味着在第 1 帧处显示的所有图形将合并到已选择的第一列/图层的第 1 帧处的图形。
- 如果两个不同的图形在不同的帧处关联到选择的第一列/图层中显示的同一图形，则仅应用第一个图形。
- 与选择的第一列/图层中显示的任何图形不对应的图形将被忽略。
- 如果任何列/层中暴露了多个 Level，则无法合并。

按住 Shift 或 Ctrl 选择多条轨道，或者在头部拖动鼠标。

在 Animation 界面布局下，Xsheet 面板右侧通常就是 Level Strip 面板，选中轨道的某个 Frame 后就会显示当前对应的 Level Strip 包含的内容，可以通过右键复制其中一个 Level 然后粘贴到 Frame 格子中，或者执行 Expose in Xsheet 添加到新轨道上。如果，要往 Level Strip 添加新的 Level，只需要在空白区点击，然后直接在绘图面板绘画即可。

使用 File Browser 可以加载各种 Level 图层文件，然后在 Xsheet 空白层的 Cell 中双击，键入 Level 名称即可将图层显示出来。也可以在 Cell 中指定还没创建的资源文件，然后在 Level Strip 中通过右键菜单 Add Frame 添加绘图层。通过 Scene Cast 场记可以查看那些图层资源有问题，或者清除没使用的图层资源。

选中的图层可以坍塌成嵌套摄影表 Sub-Xsheet，Xsheet - Collapse，这个功能很好简化和降低的 Xsheet 的图层数量，对重复播放的多个图层内容也可做成 Sub-Xsheet，场景 Scene 也可以作为 Sub-Xsheet 导入。嵌套摄影表可以再次打开编辑，或重新暴露到主摄影表，也可以保存到场景文件。进入 Sub-Xsheet 编辑时，如果需要同时看到场景其它图层，可以打开 Edit in Place 模式。


定格动画 Stop Animation Motion 也是一种常见的动画形式，OpenToonz 在 Window 菜单下提供了 Stop Motion Control 面板，用来做定格拍摄。

面板中的 Contols 选项卡设置：

- Camera 指定用于拍摄的摄像机，笔记本通常会自带摄像头；
- File 指定存储文件及格式，如果指定文件名已经占用，会在右侧出现红色 WARNING 信息提示；
- Frame 指定保存在文件中的帧号，根据是否已经有内容，会在右侧用绿色文字信息提示 ADD/OVERRIDE 等状态； 


使用 Tasks 渲染场景时会出现全黑帧输出，是命令中指定的 CPU 线程参数导致的。

	tcomposer.exe "tga_paint.tnz" -o "tga_paint.tif" -range 1 12 -step 1 -shrink 1 -multimedia 0 -nthreads all -maxtilesize none

只需要将 -nthreads all 参数指定 CPU 核心数即可以解决，通过 FX Schematic - Output 节点设置，Dedicated CPUs 设置为 Half/Single 试试。或者直接手动执行命令，指定 CPU 线程数量。

## Lip Sync 嘴型同步
- Rhubarb Lip Sync https://github.com/DanielSWolf/rhubarb-lip-sync/releases
- Blender Rhubarb Lip Sync https://github.com/scaredyfish/blender-rhubarb-lipsync
- Rhubarb Lipsync for Blender https://www.bilibili.com/video/BV1sN411d7DJ
- 百度在线语音合成服务 https://ai.baidu.com/ai-doc/SPEECH/Qk38y8lrl

音轨的声波图可以用来做嘴型同步 Lip Synching 时的参考，比如在一个 Level Strip 中准备好 10 张嘴型图画，对应各发音嘴型，通过 Skeleton 工具在对应声波处动态地更换要显示的嘴型图像。

还可以使用 export-toonz.lua 脚本从 Magpie 软件导出嘴型同步文件 .TLS files (Toonz Lip Sync)。然后执行 File → Import Toonz Lip Sync File.... 导入。

也可以使用免费的 Papagayo-NG 来做嘴型同步，这些工具回检测音频文件以匹配台词，音频数据可以检测到出相应的元音等关键信息。

得到 Lip Sync Data 文件后，通过菜单 Xsheet -> Apply Lip Sync Data to Column 应用到图层轨道。

默认状态下，按英语发音将相似发音的字母分为以下十组，对应图形可以使用左右箭头按钮进行切换：

- A I    对应 Level 0001
- E      对应 Level 0002
- O      对应 Level 0003
- U      对应 Level 0004
- F V    对应 Level 0005
- L      对应 Level 0006
- M B P  对应 Level 0007
- W Q    对应 Level 0008
- C D G K N R S Th Y Z  对应 Level 0009
- Rest 	 其它对应 Level 0010

汉娜·巴贝拉（Hanna-Barbera）总结了动画人物说话的六种嘴型，已经成为 2D 动画嘴型的制作标准，被迪士尼和华纳兄弟等影视公司在多部影视作品采用。

Rhubarb Lip Sync 是根据六种基本嘴型开发的命令行工具，除了六个基本嘴型，它还可以使用后面 3 个扩展嘴型：

- Ⓐ 闭合嘴型，P B M 字母的发音，几乎和 Ⓧ 嘴型一样，除了嘴唇之间极小的压力。
- Ⓑ 嘴巴微微张开，牙齿紧咬，用于 K S T 等大多数辅音。它也用于一些元音，如 bee 中的 EE 音。
- Ⓒ 张开嘴，用于元音，如 Man 的 EH 和 Bat 的 AE。它也用于一些辅音，取决于上下文，如补间动画 ⒶⒸⒹ 和 ⒷⒸⒹ。
- Ⓓ 张大嘴，用于 father 这样的 AA 元音，A I 字母。
- Ⓔ 略圆嘴型，用于元音，如 off 中的 AO 和 bird 中的 ER 元音，常用补间动画 ⒸⒺⒻ 和 ⒹⒺⒻ。
- Ⓕ 皱起嘴唇，Puckered lips 用于 you 中的 UW 或者 way 中的 W 元音。
- Ⓖ 下嘴唇触碰上齿，F V 发音，属于扩展嘴型。
- Ⓗ 长音 L 对应的嘴型，舌头卷起在上齿后面。嘴巴至少应该像 Ⓒ 一样张开, 但还没有到 Ⓓ 的强度。
- Ⓧ 空闲非说话状态时的闭合嘴型，几乎和 Ⓐ 一样，只是嘴唇是放松状态的。

嘴型同步数据文件内容如下，每一行包含帧号和对应的嘴型标记。

以下是字母命名和 Preston Blair 嘴型命名的对应嘴型数据文件内容：

	MohoSwitch1         MohoSwitch1
	1 X                 1 rest
	22 B                22 etc
	46 E                46 O
	50 B                50 etc
	58 C                58 E
	60 B                60 etc
	61 C                61 E
	63 B                63 etc
	77 F                77 U
	80 B                80 etc
	88 E                88 O
	95 C                95 E

两套嘴型标记名称的对应关系，OpenToonz 使用 Preston Blair 嘴型命名，以下排序和 Apply Lip Sync Data 面板的排序一致：

| Preston Blair name | Alphabetic name |
|--------------------|-----------------|
| AI                 | D               |
| E                  | C               |
| O                  | E               |
| U                  | F               |
| FV                 | G               |
| L                  | H               |
| MBP                | A               |
| etc                | B               |
| rest               | X               |


Rhubarb Lip Sync 工作的步骤如下：

- 输入一段语音
- Lip Sync 识别这段语音
- 使用六个基本嘴形和最多三个扩展嘴形与语音匹配
- 输出一个指定格式的文件，dat/tsv/json/xml

Rhubarb Lip Sync 提供了两个语音识别系统：

- PocketSphinx：只能识别英语，准确率更高。
- Phonetic ：能识别所有语言，依据人声和音节判断嘴型，但准确率不如前者。

Rhubarb Lip Sync 工具支持以下软件：

- Adobe After Effects
- Moho and OpenToonz
- Spine by Esoteric Software
- Vegas Pro by Magix
- Visionaire Studio

Rhubarb Lip Sync 命令行工具可以指定参数为 OpenToonz 生成嘴型同步数据文件：

- *-f dat* 或 *--exportFormat dat* 生成 Moho 或 OpenToonz 都可用的数据文件，还支持 tsv、xml、json 等格式。 - *--datFrameRate*  指定 dat 格式的帧率，默认为 24fps，不同的帧率会影响嘴型标记出现的帧位。 - *--datUsePrestonBlair* 控制嘴型标记名称。 - *--extendedShapes GHX* 指定使用 G H X 扩展嘴型，指定空字符串表示不使用扩展嘴型。 - *-r*, *--recognizer* 指定识别算法，默认 pocketSphinx 为英语，其它语言指定为 phonetic。 - *-o*, --output 指定输出数据文件，默认是直接输出到控制台。
OpenToonz 自带的录音工具使用 8000Hz 采样录音，而 Rhubarb 使用不少于 16KHz 的采样，所以需要更好的录音软件。

```sh
> rhubarb.exe -f dat Hanna-Barbera-lip-style.wav
Generating lip sync data for Hanna-Barbera-lip-style.wav.
Progress: [#-------------------]   6%
[Fatal] Application terminating with error: Error processing file Hanna-Barbera-lip-style.wav.
Error performing speech recognition via PocketSphinx tools.
Upsampling not supported. Input sample rate must not be below 16000Hz.
Progress (cont'd): [#-------------------]   6%
```

Rhubarb 支持处理 WAVE (.wav) 和 Ogg Vorbis (.ogg) 音频格式。可以使用 Windows 自带的录音机，它可以录制 m4a 格式，再使用 FFMPEG 工具转换为 16KHz 的 Wav 格式：

```sh
ffmpeg -i Hanna-Barbera-lip-style.m4a -ar 16000 Hanna-Barbera-lip-style.wav
```

在执行 Apply Lip Sync Data to Column 时，又出问题了，加载位于 +extras 目录下的数据文件时提示 Unable to Open the file，很尴尬！

处理办法：将嘴型数据移出 +extras 目录，放到更上级的目录再加载，这种 Bug 真的很让学习者尴尬！


使用百度语音合成生成音频文件：

	http://tts.baidu.com/text2audio?lan=zh&ie=UTF-8&spd=5&text=abandon

直接引用该接口，在 text 后面加自定义文字的 UTF-8 编码，可以用 JavaScirpt 脚本 encodeURI() 进行编码处理。

参数解释：

- lan：固定值 zh。语言选择，目前只有中英文混合模式，填写固定值 zh
- ie:编码方式
- spd：语速，取值0-9，默认为 5 中语速
- text：合成的文本，使用 UTF-8 编码。小于 512 个中文字或者英文数字。（文本在百度服务器内转换为GBK后，长度必须小于1024字节）

新版本百度语音合成：

	http://tsn.baidu.com/text2audio?tex=*****bd&lan=zh&cuid=&ctp=1&tok=

参数解释，前五个参数是必填的：

- tex：合成的文本，使用UTF-8编码。小于512个中文字或者英文数字。（文本在百度服务器内转换为GBK后，长度必须小于1024字节）
- tok：开放平台获取到的开发者access_token
- cuid：用户唯一标识，用来区分用户，计算UV值。建议填写能区分用户的机器 MAC 地址或 IMEI 码，长度为60字符以内
- ctp：客户端类型选择，web端填写固定值1
- lan：固定值zh。语言选择,目前只有中英文混合模式，填写固定值zh
- spd：语速，取值0-9，默认为5中语速
- pit：音调，取值0-9，默认为5中语调
- vol：音量，取值0-15，默认为5中音量
- per：发音人选择, 0为普通女声，1为普通男生，3为情感合成-度逍遥，4为情感合成-度丫丫，默认为普通女声



## Layer & Drawing 图层与绘图
- https://opentoonz.readthedocs.io/ja/latest/drawing_animation_levels.html
- https://opentoonz.readthedocs.io/ja/latest/painting_animation_levels.html
- https://opentoonz.readthedocs.io/ja/latest/managing_palettes_and_styles.html

OpenToonz 三种层级类型特点：

- 矢量层级 Vector，保存在 *PLI* 文件，标准矢量图层，支持自动过度帧 In Between 生成；
- 专用光栅层级 Toonz Raster，保存在 *TLV* 文件，类似矢量图层可以绘制矢量图形，可以填充；
- 标准光栅层级 Raster，默认保存在 *TIF* 文件，但提供更多的纹理效果，OpenToonz 1.4 版本支持填充。

所有 Toonz 图形都由线条（由扫描或矢量图形的笔划确定）和由闭合线定义的区域组成。光栅和矢量线可以部分或全部绘制或擦除，区域可以用样式填充，也可以保持空白，并具有完全的透明度。

Toonz Raster 就是一种兼有矢量图和位图的格式，Toonz Raster 通过绘制位图线来定义，可以和标准 Vector 矢量图互相转化，通过菜单 Level -> Convert... -> Convert to Vectors 或者 Vectors to Toonz Raster。当前只支持两种转换模式：

- Centerline 中心线模式，将绘画的笔迹转换为相应的矢量线条。转换后就可以使用矢量工具，如收缩（Pinch）或 Control Point Editor 进行弯曲，或者使用 Pump 工具更改厚度等等。
- Outline 轮廓线模式，生成两条向量笔迹来包裹 Toonz Raster 的线条。

尝试执行 Convert to Vectors 转换时出错了，并且，选择标准矢量图后，Vectors to Toonz Raster 菜单也是灰色不可用。后面，尝试几次后又正常了，就像 OpenToonz 经常 Crash 一样尴尬！

	The current selection is invalid

Toonz Raster 可以使用调板中效果最好的 Raster 纹理样式绘制线条和填充区域，具有在创建时定义的指定大小和分辨率。而标准的 Vector 矢量图层则只可使用调板中的 Color、Textue、Vector 等标准矢量纹理。

可以配置默认绘画时自动创建的图层类型为 *TLV*，配置 File -> Preferences... -> Drawing -> Default Level Type 设置为 Toonz Raster Level。


根据当前选择的工具，不同的图层类型的视图会有不同的表现。

OpenToonz 1.4 版本使用填充工具时，在 Xsheet 操作可能导致卡死崩溃。

在矢量图 Vector 上作画，选择 Level 列表中的多个帧后即可以看到缩略图的右边缘显示 INBETWEEN 按钮，点击它即可生成补间，在弹出框中选择插值方式 Interpolation：

- Linear 线性，生成的动画效果平稳；
- Ease In 缓入，生成的动画入场较慢；
- Ease Out 缓出，生成的动画出场较慢；

在 Basics、 Drawing、 Timeline、 Animation 等界面布局都有 Level 面板可以进行操作。


工具栏中只有常有的基础绘画工具：

- Brush 画笔，主要的绘画工具，可以结合调板的设置绘制不同的效果；
- Geometric 矢量绘图工具，绘制线条 Line/ 曲线 Arc/ 圆 Circle/ 椭圆 Ellipse/ 矩形 Retangle/ 多边形 Polygon 等；
- Fill 填充矢量或 Toonz 光栅图层内容；
- Paint Brush 专用光栅层级画笔；
- Eraser 橡皮，可以擦除各种图层的内容；
- Tape 拼接矢量笔画或封闭间隙；
- Finger 手指涂抹光栅图层内容；

Brush 画笔选项面板：

- Size Min/Max 调整笔触大小；
- Accuracy 调整精度，越大采样数据越多；
- Smooth 矢量图层画线的平滑度；
- Hardness 光栅图层 Toonz Raster 或 Raster 硬度/抗锯齿；
- Opacity Min/Max 光栅图层 Raster 设置笔触不透明度；
- Break 在 Toonz Vector 图层设置自动拆开笔画以简化图形；
- Draw Order 设置 Toonz Raster 图层绘图产生的新图案放置，顶层 Over All，或底层 Under All，或调板顺序 Palette Order；
- Pencil 铅笔模式设置 Toonz Raster 图层无抗锯齿特性；
- Pressure 压感支持；
- Range 自动生成补间动画 In-Between，打开后画笔画出红色线，继续在其它帧绘画就会自动生成中间画，通过用来生成关键帧间的补间动态；
- Snap 设置 Toonz Vector 图层的笔触吸附力；
- Preset 选项预置配置；
- Cap 矢量线条的结束位置的样式；
- Join 设置 Toonz Vector 图层矢量线条转折位的连接样式，尖角 Miter/ 圆角 Round/ 倒角 Bevel；
- Miter 矢量线条转折尖角的最大长度；


不同的工具需要正确设置调板或样式，比如不能设置调板中的 Raster 纹理来绘画矢量图层，已绘制的矢量图层中，将笔触样式修改为光栅纹理也会导致内容不能正确显示。与矢量绘图同，在标准光栅层上绘图像素化的，画笔的样式色彩修改不会影响已绘制的图案。

调板 Palettes 管理舞台各种对象所使用的样式 Styles，比如矢量图层中可以使用不同的样式画线条，画完后再通过 Style Editor 修改样式依然可以修改线条的图案，可以重复修改这就是矢量绘图的一大好处。因此，给样式命名是一个很好的习惯。

对于 Vector 和 Toonz Raster 图层，调板的样式可以制作动画，在时间轴定义的关键帧 Key，然后在调板选中样式修改更新，并在面板工具条中激活钥匙按钮，两边的方向按钮表示当前选中样式是否有前后关联帧。

调板默认提供 Color_0 样式，它用来清除其它样式的线条、填充图案，样式左下角显示 A 表示激活 Autopaint for Lines，快捷键 Shift-A。

除了当前工程使用的调板，另外还提供了内置的调板，可以通过工作室调板面板 Studio Palettes 查看。

样式编辑器提供固色 Color、 纹理 Texture、 矢量图案 Vector、 光栅画笔风格 Raster 等设置。

- Colors 固色，单一颜色，用来画线条或填充，用 RGB Picker 工具可以拾取；
- Textures 纹理，在 Vector 和 Toonz Raster 图层使用，在标准光栅图层可以使用矢量工具绘图；
- Vector 矢量图案
	- Generated Styles 数学函数生成样式，可以后续修改 Color；
	- Trail Styles 装饰线，不可用在喷涂区，只用在矢量图层；
	- Vector Brush Styles 矢量笔触样式，不可用在喷涂区，只用在矢量图层；
- Raster Brushes 提供各种位图绘画光栅纹理，Toonz Raster 有限适用；
- Settings 提供当前样式的设置；

矢量图案则时一种矢量形状定义，它们用在矢量工具时会按图案形状给边线填充指定颜色，所以矢量图绘制时固定下来的是矢量形状，样式可以后续修改样式既可以更新。在矢量绘画过程中，每种工具都涉及到矢量形状部分和颜色喷涂部分，注意区别。

使用画笔 Brush 在矢量图层绘图时，绘制的就是一个笔触形状，然后填充样式指定的颜色或纹理。笔触绘制的形状还可使用填充工具进行填色。在标准光栅层绘图时，笔触的形状可以根据软件算法配置千变万化，矢量绘图工具依然可以使用，但会光栅化而不是以矢量图案保存。所以，绘图工具的两大功能就是绘制形状和填充色彩。

给一个样式设置纹理、矢量图案后，可以在 Vector 或 Raster 栏左上角的 Plain Color 来复原固色样式。对于矢量图层，画笔光栅是没有效果的，不会在绘图区显示内容。对于光栅图层，给演示设置纹理或矢量图案是无效果的，相当于设置了一个固色。

OpenToonz 使用的画笔光栅纹理是 MyPaint 开源绘图工具移植过来的，与其保持兼容。

纹理 Texture 就是一个位图小方块，其中纹理可以看作一种形状，在绘制矢量图按时会填充到线条上。纹理 Texture 既包含颜色信息，又包含纹理，所以不能给指定纹理的样式更换颜色，但可以通过其它纹理来实现颜色的修改。

新建样式可以通过样式编辑器自定义纹理样式：

- 新建样式；
- 右键打开样式编辑器 Style Editor；
- 选择任意一个 Texture 纹理；
- 在 Setting 栏中加载外部的 24 位色 BMP 纹理图片；

或者直接将位图纹理文件放到 library/textures 目录下，下次起动 OpenToonz 时就自动加载。

设置好工具样式后，大多数样式还可以回来设置一个底色，比如设置好炭精光栅 Charcoal，还可以再挑选 Color 底色进行绘图。选择多个样式后，使用 Palette Gizmo 可以对样式进行批量的修改。


项目中有大量的帧，使用填充工具用来上色时，可以勾选帧范围 Frame Range，在第一帧和最后一帧的对应位置分别点一下做标记填充，中间的帧相同区域内的颜色都被自动填充，注意十字号标记是用来对标填充区的。

另外填充选项 Selective 配合 Retangle/Freehand 填充类型对可以框选中的区域进行填充。而 Onion Skin 填充选项，结合 Normal 填充类型，在点击填充时，会从洋葱皮显示的图层获取颜色，并填充当前点击的区域。

在一些局部被拆分的图层上色，如交谈的人物图形通常会将运动的口型部分分离到新图层，在填充时需要先合并图层 Xsheet - Merge TLV Level，更好的做法时使用适配线 Xsheet - Apply Match Lines，适配线可以删除。

有时，将手绘动画级别拆分为几个 Level 再重新组装。例如，可以使用与角色动画完全匹配的阴影线，然后使用与角色线不同的颜色应用阴影线，以便更轻松地绘制阴影线。在其他一些情况下，可能需要将两个或多个动画 Level 合并，或在动画的所有图形上自动添加相同的图形。

在这两种情况下，都可以使用 Match Lines 匹配线功能来完成任务，因为它允许您合并在两列/层中公开的标高，如果需要，还可以删除合并的匹配线。

匹配线只能应用于 Toonz Raster (TLV)。在 Xsheet 合并两列时，右侧的列图形被视为应用于左侧图形的匹配线（在时间轴中，合并两个图层时，顶部的图层图形被视为应用于底部图形的匹配线）。


可以为标准矢量绘画图层创建补间动画 *In-Between*，操作步骤：

- 选择要进行补间插值的矢量图层，注意是 Vector Level 不是 Toonz Raster Level；
- 在 Level Strip 面板上选择要插值的帧范围，需要预备好帧空间，使用菜单 Edit → Insert 或右键菜单 Add Frames... 插入空白帧。
- 选择要插值的帧后，在 Level Strip 面板右侧会显示 In-between 标签工具。
- 点击其中一个 INBETWEEN 标签工具，然后选择一个插件方式即可。

插值方式：

- Linear 线性插值，产生的值是线性增减的。
- Ease In 缓入，插值时在动画开始部分的值变化量较小，产生先慢后快的效果。
- Ease Out 缓出，和上面的 Ease In 相反，是先慢后快。
- Ease In / Ease Out 同时缓入缓出，开始和结束阶段慢，中间快。

使用 Shift & Trace 功能可以帮助创建补间动画，事实上，它插入中间图或分解图时使用上一个和下一个关键点图形作为参照。参考图形可以临时移动和旋转，以适合要绘制补间图形的位置。也可以自动设置参考图形的位置，创建和编辑动作路径。

使用 Shift & Trace 特性创建补间动画：

- 绘制第一个关键帧；
- 绘制第二个关键帧；
- 选择要创建补间动画图形的帧；
- 打开 View → Shift and Trace 并且执行 Edit Shift 以编辑参考图形的位置；
- 按住 Ctrl 使用画笔绘制出参数点之间的动作线；
- 创建 inbetween 补间动画图形。

编辑参考图形时，已经启用洋葱皮功能，可以在 Xsheet 最左侧看到当前帧上下都有一个方框，前红后绿对应视图中显示的 Previous Drawing / Following Drawing 参考图形。


[OpenToonz周边教程#1：合并图层和引用适配线](https://www.bilibili.com/video/BV1NW411i7Mg)
[OpenToonz周边教程#3：高级上色技巧](https://www.bilibili.com/video/BV1ZW411Y7X3)
[OpenToonz Toolbar](https://opentoonz.readthedocs.io/en/latest/interface_overview.html#toolbar)


快捷操作提示：

- 绘画过程中，按住快捷键不放，使用工具后再松开可以自动返回上一个工具。
- ~ 反引号快捷键可以放大当前绘图面板。
- Q/W 	快捷键切换 Level 的图纸。
- Ctrl-Alt 移动移动光标可以调整画笔的大小，或者 U、I 和 H、J 调整画笔的 Min/Max 值。
- 绘图区画布上右键菜单可以启用洋葱皮功能 Activate Onion Skin。
- 点击在摄影表左侧的红/绿半球竖直位置出现的黄色圆形激活所在帧的洋葱皮。
- 在绘制中间帧是可以使用 View -> Shift and Trace 移动和跟踪提供的参考绘画。
- 画布大小修改，通过菜单设置 Level → Canvas Size...


## Animation 动画
- https://opentoonz.readthedocs.io/en/latest/creating_movements.html
- https://opentoonz.readthedocs.io/en/latest/creating_cutout_animation.html
- https://opentoonz.readthedocs.io/en/latest/create_animations_using_plastic_tool.html
- https://opentoonz.readthedocs.io/ja/latest/applying_special_fx.html
- https://opentoonz.readthedocs.io/ja/latest/using_the_particles_effect.html

以下是 5 个主要的动画工具：

- *Animate Tool* 基本动画工具，对图层所有帧进行位移 Position/旋转 Rotation/缩放 Scale/切变 Shear 等动画属性； - *Skeleton* 基于骨架工具制作剪影动画 Cutout Animation，如中国的传统皮影，不必绘制所有动画姿势； - *Plastic* 塑性工具给角色图形添加蒙皮网格，结合骨架就像捏橡皮人，也类似 3D 动画的蒙皮； - *Hook* 钩子工具用来给图层定义中心点，各图层的 Hook 点独立不会相互影响。 - *Tracker* 追踪工具用来在图层上追踪框定的区域，结果也是一个 Hook 中心点；
动画是以关键帧的方式记录的，按快捷键 Z 在当前的动画帧位置设置关键帧。在 Xsheet 面板中，会显示钥匙图标，表示一个关键帧，点击选中它可以移动位置，也可以删除。在 Function Editor 面板中，可以通过面板上的工具切换为 Curve Editor，在曲线编辑器中可以操作关键帧。 

绘制好基本的动画图像后，利用 Fx Schematic 按排特效，这也是非常有用的动画工具，特效工具可以对图像进行后期处理，也可以添加程序化的效果，例如改变图层的位置、色彩，添加粒子效果等等。特效提供的属性可以结合关键帧，通过记录特效的属性变化产生动画效果。 

### Animate Tool

基本的动画工具 Animate Tool 可以进行图形的移位、旋转、缩放等基本的属性驱动的动画。

可以改变图像在渲染时堆栈的顺序，指定的 SO - Stacking Order 值越大，表示图像越在上层，可以覆盖下层的图像。除非设置了 Z 轴坐标，它就是一个深度值，值越大越远离镜头，相当于设置越小的 SO 值。

图层堆叠顺序默认按其在 Xsheet 或 Timeline 中的放置先后位置决定，Xsheet 表方向是从左到右，而时间轴方向是从下到上，使左侧/底部的内容位于右侧/顶部的内容的后面。

这意味着，如果一个动画元素必须移动到另一个动画元素的后面，然后移动到另一个动画元素的前面，那么它必须在包含第二个动画元素的列之前和之后的两个不同列中曝光。

点击工具栏的 Animate Tool 后，在顶部的工具选项提供了以下设置：

- *Object* 指定要操作的对象，列表包含所有 columns, cameras and pegbars，还有 table 即场景中表示桌面的一个对象。 - *Mode* 指定要设置动画的属性模式，可以选择对 Position, Rotation, Scale, Shear, Center 等属性进行动画操作。 - *Position* 通过指定位置产生动画，包含 X/Y/Z 三个坐标。还有 SO 值，即指定 column/layer 的渲染优先级，大值会覆盖小值的图层内容。 - *Rotation* 指定按 Z 轴旋转的角度。 - *Scale*, *Global* 缩放，分别有水平和竖直方向上的缩放 H: horizontal & V: vertical。 还有保持体积的绽放模式，指定 *Maintain* 为 Mass 模式并按住 Ctrl 操作，还有保持比例模式 A/R。 - *Shear* 切向变换，即沿着边线方向变换。 - *Center* 中心点坐标的设置，此属性不是动画属性，只能影响图像的变换。 - *Lock buttons* 锁头图标表示锁定相应的属性，避免在视图中变换图像时改动。 - *Global Key* 全局关键帧，激活后，以交互方式为其任何变换设置关键点时，就会为对象所有变换属性设置关键点。例如，如果更改对象的位置，从而为其定义关键帧，也将自动为旋转、缩放和剪切变换定义关键帧。如果特性的值直接在工具栏中输入，而不是以交互方式输入，则此选项将不起任何作用。
在使用 All 动画工具模式时，还有一个 Pick 选项，用来选择动画工具作用的对象：

- None 默认方式，根据当前在 Stage Schematic 中的 Pegbar 或 Column 节点决定要操作的对象。
- Pegbar 对图层的父级 Pegbar 节点进行操作。
- Column 对图像图层对象操作；

Pegbar 定位尺是专门用来给图层做定义的对象，可以通过 Stage Schematic 给图层设置父级 Pegbar 节点。

在视图中，默认提供 Camera 和 Table 对象，即摄像机镜头和绘画的桌面对象，它们也可以进行动画设置。

所有 Pegbars 和桌面上的图层，它们的默认 Z 轴坐标为默认摄像机的水平视场，计量值表示摄像机镜头视角的大小，即相当于镜头角度。值为 0 就和摄像机镜头同一个深度位置，增加场值，相机将远离桌子；减小它，它移动得更近，负值表示位于 Table 的后面。

所有变换属性都可以制作补间动画 in-between，它会在两个关键帧之间进行属性插值。

### Skeleton Tool

骨架工具 *Skeleton* 用来制作 Cutout 动画，要求连接不同图层上的角色部件，如皮影人物角色的头部、四肢、躯干都是单独的一块皮料，通过骨架关联组成一个角色图案并通过修改骨骼产生动画。

骨架有任意多根骨骼组成，骨骼的头部为圆形、尾部为方块，还有一个字母 *B* 表示它是 Bone，每根骨骼控制图层上的一个 Level。

有三种模式，使用骨架工具，通常要先设置骨架再进行姿势调整模式：

- Build Skeleton 骨架设置模式；
- Animate 动画模式，姿势调整模式；
- Inverse Kinematics 反向运动学动画，姿势调整模式；

设置骨架时，最好在 Skeleton 工作界面布局下操作，并且使用 Sub-Xsheet 进行管理。为了简洁显示当前图层的骨骼，勾选 Skeleton 工具的 Show Only Active Skeleton 选项。点击图层内容时，会自动切换到相应图层并显示当前的骨骼头部为一个高亮的圆点。

Sub-Xsheet 功能上还不够好用，比如，不能指定 Sub-Xsheet 的循环播放，如果需要在顶层的 Xsheet 上播放需要循环的动画时就不够方便。

首先，准备好角色的图案并在 Xsheet 不同的轨道上显示，选择骨架工具后，再选择图层，进入 Build Skeleton 模式设置骨架：

- 视图区显示的橘黄圆圈表示骨骼中枢位置，应该放到角色图案的关节位置。
- 另一端的方块用来连接父级骨骼，即其它图层上的骨骼。
- 拖动骨骼的方块图标就会显示其它可连接状态的图层，并显示一个青色圆点，拖到相应的点连接到其它图层的内容上。
- 松开鼠标连接到其它图层的骨骼然后，就会在骨骼中间显示方块，再拖动可以重新连接，或通过它来断开连接。

通过骨架将各个独立图层连接在一起组成完整的角色图案，再给骨架设置动画，这就是剪影动画的制作，避免了花时间逐帧绘制动画。

尴尬的情况是在 OpenToonz 出现，管现在用的是最新的 OpenToonz 1.5，但是使用骨架工具时，骨骼的方块控制点突然消失了！重启软件再试，注意不是重启系统。

或者，更好的方法是使用 Stage Schematic 节点规划面板来调整图层的父子关系。

在设置骨架后，各个层层就通过骨骼关联了父子级别关系。然后可以进入骨骼动画姿态模式，通过移动、旋转、缩放等，结合关键帧制作动画。

骨骼的中枢点可以移动调整，图层的位移也可以通过拖动十字星图标调整。因为骨骼的关联，父级的 位移/旋转/缩放 会作用到子级，子级的调整不影响父级。Global Key 选项打开后，任何调整都会产生包含 位移/旋转/缩放 信息的关键帧。

Skeleton 虽然是要求连接不同的图层，角色各个部分的图案是可以在同一个 Level Strip 序列中绘画。并且，可以 Level 指定一个名字，比如 Arm/Hand 这样的提示性名称，而不是序号，这样在骨架工具的动画模式 Skeleton -> Animate 中枢点附近出现的剪影标记就有提示功能。例如 `Character 1` 表示的是当前关键帧显示的是 Level Strip 中第一张图纸，点击剪影标记依次更改其它图纸。

骨架的反向运动学动画 IK - Inverse Kinematics 以骨骼的末端来引导动画，比如拖动一条铁链的末端会影响其它环节的跟随运动。前面未加 IK 的 Skeleton Animate 其实可以看作一种正向关节 FK - Forward Kinematics。

在反关节模式下中枢控制点会变成大圆盘，在圆盘周边任意位置可以拖动骨骼绑定的图层内容，而方块表示固定锚点，锚点骨骼会处于固定状态，其它骨骼绑定的图层可以任意调整，并且在调整过程中保持图层的连接关系。注意控制圆盘的大小变化，大圆盘表示父节点设置锚点，子骨骼用来做姿势调整，小圆盘表示子骨骼设置锚点，父骨骼做姿势调整。


### Plastic Tool

塑性工具 *Plastic* 可以给角色图形添加蒙皮网格，并结合骨架控制图像的变形。

- 通过 Create Mesh 按钮创建蒙皮用的网格，会创建新的 Mesh Level 轨道，后续的操作都是对 Mesh Level 的操作；
- 然后选择 Build Skeleton 模式创建骨架，注意光标变成一个紫色方格，点击一下设置 Root 即第一个根据节点；
- 再点击设置下一个点，两个点就形成一个骨骼，或者在两点之间点击插入。
- 要从任意的点引出骨骼，只需要先点击它，再点击下一个点；

在设置骨架时，每个关键点都可以禁用 Allow Stretching 将点设置不允许伸展，对应的方格会显示为黄色。

在设置网格动画时，可以设置以下选项：

- 使用 Keep Distance，这样在变形时就会保持顶点的距离。
- 设置 SO - Stacking Order，用来模拟肢体的遮盖，靠近镜头的部分设置更大的 SO 值。
- 另外，通常需要打开 Global Key，这样就可以在创建关键帧时，记录整个骨架的顶点。

使用右键菜单 Show SO 可以将 SO 值的影响范围显示出来，越亮表示越在顶层，会覆盖暗的范围，如果发生重叠，这种效果是通过图像的混合算法实现的。

创建设置蒙皮网格时，设置适当小的边长 Mesh Edges Length 提高精确度，太小也不利于调整，网格边距 Mesh Margin 以封闭好角色图案为准。

一般来说，设置好骨骼链后就可以进入动画模式 Mode - Animate 进行动画编辑，移动骨骼中枢点即可以编辑角色动画。但是为了更好的效果，还是需要进入 Edit Mesh 修正网格，再进入 Paint Rigid 模式绘制刚体。

动画网格的某些部分，即使在整个元素的整体变换之后，也要保持其形状，以模拟更刚性的结构或其一部分。要实现这种效果，可以直接在网格上绘制刚度值。选择刚体 *Rigid* 方式绘制时，标记为红色的网格顶点，表示在骨骼进行动画变形时尽量不改变所覆盖的图形。而默认的软体 *Flex* 绿色标记的网格顶点表示在动画变形时会延展或压缩其覆盖的图形。 

<!-- 与骨架工具 Skeleton 不同，塑形工具的骨架只在蒙皮网格层定义，第一个方块设置的点为 Root 表示角色图形中的稳定中心，如人体的胸部或髋部，然后点击 膝盖 - 脚跟 - 脚掌 定义一条完整的骨骼链。定义其它的骨骼链如 Root - 手肘 - 手腕 - 手掌，需要先点击 Root 表示选中起点，其它骨骼链类似操作。
 -->

可以为 *Plastic* 生成的 Mesh Level 设置多套骨架，可以在不同的帧同时激活使用。得到网格后和骨架后，就可以进入 Print Rigid 模式，即将骨骼绑定到要控制的网格。通过绘制权重，来将网格关联到具体的骨骼上。

可以在 Build Skeleton 模式下复制骨架，只需要先选中 Root 顶点，使用右键菜单复制，然后又选择其它 Mesh Level 的帧，再粘贴以创建同样的骨架。


为塑形的图层设置动画，这里有点容易让人困惑的因素。因为使用 Plastic 工具生成网格后，其实就新建了一个 Mesh Level 图层轨道，后续的操作就是修改网格层来让原图层变形，原图层此时也叫做 Mesh-deformed Level 或者 Plastic modified level。并且网格图层是作为原图层的父级连接的，通过 Stage Schematic 面板可以查看或修改图层节点连接关系。

设置塑料元素的动画的操作步骤：

- 在 Xsheet/Timeline 面板中选择要设置动画的网格图层轨道，并选择要设置动画的第一帧。
- 选择 Plastic 工具并使用 Animate 模式，以设置动画，这样，就可以在视图中看到网格和对应的骨架。
- 选择骨架的顶点并将其移动到所需位置，按 Z 键设置相关键帧，或将所需值写入工具选项栏的对应字段中。
- 移动到需要设置动画的下一个关键帧，并修改顶点位置以定义新姿势。
- 重复以上步骤，直到完成动画设置，其间，对于定义了多套骨架的网格图层，可以选择要使用的骨架。


要为整个骨架设置全局静止位置关键点，请执行以下操作：

- 第一次绘制骨架时，还将创建此结构的静止位置。此姿势将自动存储，您可以在所有顶点上调用它。
- 选择一个顶点并单击鼠标右键。
- 从打开的关联菜单中，选择“设置全局Rest关键点”。
- 将使用顶点的静止值为所有顶点创建当前帧处的新关键帧

为了创建有趣又复杂的动画，将标准图层或者其它网格变形图层连接到网格变形图层，以创建层次结构的动画是节省时间的方式，子节点图层自动继承了父节点的变换。

塑形工具生成的网格对图层变形使用的是其网格骨架中定义的顶点而不是钩点，Mesh Level 图层在 Stage Schematic 面板对应的节点输出的数字端口中，Root 顶点对应号码为 1，其它顶点按序号递增。

例如，将一个 Mesh 图层节点的 1 号输出端口连接到另一个 Mesh 图层的 1 号输入端口，表示将这两个网格图层中的 Root 顶点对齐。

钩子工具不适用于被塑料网格变形的图层，因此，为了精确定位，需要使用网格层中定义的骨架顶点，在链接的源和目标上使用作为参考点。

网格变形也适用于 Sub-Xsheet，可以将它当作一个标准的图层来看待，为其创建网格时会将内部的所有图层内容拼合处理。

如果在创建网格后，将隐藏的子图层设置为可见，则它们的行为将略有不同：它们将通过网格变换变形，但它们将仅在网格边界内的渲染中显示。即，网格充当遮罩，用于确定渲染图像中可见的内容，即使新显示的图层已放置到具有自己的网格和骨架的 Sub-Xsheet。


为网格图层设置骨架时，会记录骨架顶点的 Rest Position，即骨架顶点的默认位置。

进入塑形工具的 Animate 模式后，不能对 Root 的位置进行移动，只能使用工具栏的 Animate Tool 工具对图层进行移动。但是，可以在调整骨架姿态时，使用右键菜单将顶点归位到默认位置：

- Set Rest Key 将当前选中的顶点归位。
- Set Global Rest Key 将当前骨架所有顶点归位。

在 OpenToonz 的 Function Editor 面板中，还可以使用脚本化的数学表达式来控制塑形网格中的顶点。


### Hooks Tool

钩子 *Hooks* 工具用来在动画 Level 中定义参考点，最多可以设置 20 个，这些参考点可以在 Stage Schematic 中使用，用途如下：

- 用来移动连接到指定序号的钩子上的节点对象，将子节点连接到一个父节点数字端口，指定的数字就是钩子号码；
- 用来当作 Level 图像的中心点参考，可以产生不同的偏移。比如，一个用来定位脚掌的钩子，以避免出现 moon-walking 太空漫步效果。

例如，给 Xsheet 第一个图层轨道设置一个钩子，然后添加一个 Shaders -> Fireball 特效，并连接到这个图层节点上，就会在钩子指定的位置出现火球。第一个钩子对应节点输出端口为 1，在 FX Schematic 右正解打开高级端口模式，然后拖动端口右侧的上下箭头调整端口号码，连接好后通过右键菜单 *Reset Center* 重置特效节点的中心。

例如，挂钩用作跟踪点，将另一个对象（柱/层或摄影机）链接到动画级别的特定特征。假设角色携带灯光，使用挂钩跟踪灯光位置，添加径向渐变特效，并将特效节点链接到该位置（在动画的每个帧中放置在灯光上）以创建辉光。

挂钩也可以从一个图形特征拆分并传递到另一个图形特征，从而自动创建偏移位置。例如，跟随角色脚部的钩子可以从一只脚传递到另一只脚，以使角色连续向前移动。

设置钩子时，按下 Shift 约束移动方向为水平或竖直，按下 Alt 拖动可以拆分钩子，原先的钩子图标也一分为二，将双圆环图标放置在当前帧的参数位置，将十字图标放置到下一帧的参数位置。

设置钩子时，可以在图层轨道的任一帧放置，其它帧也会出现同样的钩子。激活 Snap 选项，可以将当前挂钩精确附着到视图中其他图层轨道中定义的挂钩位置，从而精确放置当前图层轨道的挂钩。

如果当前图层是 Toonz Vector 矢量图，挂钩还可以附着到任何闭合矢量形状的中心，例如，矩形、圆形或使用磁带工具闭合的单个矢量形状。此选项可能非常有用，尤其是在为剪影动画定义挂钩时。


注意，有些特效可能会创建新的图层轨道，会出现在 Stage Schematic 编排面板中使用，可以进行层级关系设置。特效属性的设置就需要在 FX Schematic 编排面板中操作。

如灯光特效分组下的 Fireball、Light Spot 都会添加图层轨道，而 Glow 辉光特效就不会。如果没有给 Glow 特效设置 Source 光源，那么在 Xsheet/Timeline 所有 Light 节点下层的内容都会有辉光效果。


钩子的信息对应每个 Level 存储，使用 XML 格式，比如名为 mouse 的 Level 对应钩子信息文件 mouse_hooks.xml。 

有时，基本模型可能无法生成所需的结果，因为骨架中轴心点的位置是固定的，无法跟随模型截面的更改，而角色的分拆的剪影截面本身就是 Level 图形。

例如，假设您有一个角色，其躯干是由几个躯干弯曲图形组成的：随着躯干动画的运动，链接到躯干的肢体将不会跟随躯干的移动，因为躯干不进行移动或旋转变换。

使用 Hook 可以逐个图形指定轴心点的放置位置，即使在动作过程中使用不同的 Level 图形，模型也将保持其一致性。

例如，通过在躯干和四肢的图形上（它们必须连接的地方）放置挂钩，并使用挂钩而不是中心来定义链接，即使躯干弯曲，四肢也将跟随躯干。

骨架工具（Skeleton）允许您将钩子设置为节的轴心点，并将其链接到视图中可见的另一节的特定钩子。



### Tracker Tool

使用 Tracker 追踪工具时，多定义几个参考点提高正确性，也可以手动对各帧识别位置进行调整。框选区域后得到一个带字母编组信息，再次点击这个区域后表示选这个编组，然后框选其它区域就会给同一个编组下添加参考区，这些参考区分组字母相同。

为了多个图形定义追踪区：

- 选择第一个图形，并使用 Tracker 工具定义一个追踪区；
- 选择参与跟踪的帧区间，可以在 Xsheet/Timeline 或 Level Strip 面板中选择。
- 执行菜单 Level → Tracking... 并设置追踪选项后执行追踪。

Level - Tracking 设置追踪参数：

- Threshold 框选区域差别阈值，值越小表示参考区的匹配需要约精确；
- Sensitivity 灵敏度，值越大检测后面的图像时更新越积极；
- Variable Region Size 检测时假定参考区大小可变；
- Include Background 将背景加入检测的参考，通常用在绿幕纯色背景，green/blue；


## FX/Stage Schematic
- https://opentoonz.readthedocs.io/en/latest/creating_movements.html
- https://opentoonz.readthedocs.io/en/latest/applying_special_fx.html
- https://opentoonz.readthedocs.io/en/latest/using_the_particles_effect.html

节点编排视图提供两种模式：

- Stage Schematic 场景节点规划；
- FX Schematic 特效节点编排；

场景规划 Stage Schematic 用来编排动画，图中的每个块和 Xsheet 的图层是对应的，可用于动画的父子绑定或者特效添加。另外还有 *Table* 和 *Camera* 两个基本节点，还可以添加任意的 *Pegbar* 来汇集其它任意的输入图层或对象，这四种动画对象可以在绘图区的右键菜单选择并编辑动画效果，使用动画工具 Animate 也可以编辑它们。

场景中包括一个多功能的照相机, 可在二维空间获得具有景深效果。附加定位钉(Pegs)，可以为定位钉定义精确的 Z 轴坐标值, 以习惯的任何方式设置画面的中心。A、B、C 定位钉条(Pegbars)可任意缩放， 旋转以及链接来达到令你意想不到的照相机自由变换效果，并且比传统工具更具有创作的自由度。

父级的动画效果会影响子级的对象，通过 *Pegbar* 接入的图层会受到 *Pegbar* 的动画调整影响。要调整 *Pegbar* 的坐标，先选取工具栏上的 Animation 工具，并在顶部工具设置中的对象列表选择 Peg 对象，再在视图中调整其位置。

节点的端口有三种：

- 在左侧的*蓝色*端口用来联接上级节点；
- 在右侧的*红色*端口用来连接子级节点；
- 在下侧的*绿色*端口用于连接一个 Motion Path，这样节点对应的内容可以沿曲线运动；

端口会保持默认的连接，可以用新的端口连接来替换旧的连接，或者鼠标点击选中连线再删除。

下侧绿色端点表示运动路径输入，创建 *Motion Path* 来实现按曲线路径的动画。保持 Motion Path 节点在选中状态下，在使用画笔即 Brush Tool 在矢量图层上在绘图窗画出运动路线即可。运动路径曲线回显示为红色虚线，线上还有一些小数字表示控制点 *Control Points*，可以使用 Pinch Tool 进行调整。

也可以使用 Selection 工具选中矢量线条复制再粘贴到 *Motion Path* 上。可以将运动路径保存到 MPATH 文件中，以重复使用。

在绿色端口的侧边有两个方块，用来指定运动类型：

- 正方形/菱形图标这个是 Autorotate Alone Motion Path，显示菱形表示运动对象会根据路径转动方向，使用 Animate 动画工具调整对象运动位置查看效果。
- 另一个是激活 Link Motion Path to Control Points，表示使用 Motion Path 曲线上的按控制点作为对象的关键帧来动画。


在右下角，点击 Switch Output Port Display Mode 打开输出端口显示模式后，端口以字母或数字方式显示，通过端口的上下箭头可以拖动调整，端口的符号意义如下：

- B 连接端口表示对象的几何中心；
- A 表示左边偏移 8 inches；
- C、D、E... 表示右偏移 8、16、24 inches 等等；
- 1、2、3... 表示使用 Hook 钩子工具定义的对应号码的中心点；


以制作闹钟的动画为例，时针、分针、秒针的动画部分用基本的旋转和帧重复就可以实现，闹钟主体是静态的，独立使用图层。按快捷键 Z 给指针设置关键帧，再在后面的帧设置关键帧并使用动画工具修改指针的旋转即可。

使用 Tracker 追踪点时，需要在被追踪对象中接入要跟随运动的对象。比如小狗图层中设置追踪尾巴的参考点，另一个图层有一个苍耳需要粘到尾巴的参考点上，那么就要将苍耳图层连接到小狗图层的输入端，并设置输入端为对应的数字编码。


通过右下角的转按钮切到特效规划 FX Schematic，节点类似，操作也类似，比如给其中的图层节点添加模糊特性，添加粒子效果等。

FX Schematic 模式下，默认节点有 XSheet 和 Output，前者用来汇集其它图层的连线，再连接到输出节点。可以使用多个 Output 节点，用来限制某些效果的输出，但是同时只能有一个处于激活状态。

选中图层节点，在右键菜单选择 Insert/Add FX 即可以添加特效，如 Blur 模糊特效，在绘图区的右上角的眼睛图标打开预览模式查看效果。

注意，有些特效可能会创建新的图层轨道，会出现在 Stage Schematic 编排面板中使用，可以进行层级关系设置。特效属性的设置就需要在 FX Schematic 编排面板中操作。

特效节点右上角的眼睛图标可以用来启用/禁用特效，只要图层节点连线可到达 Output 节点，那会输出相应图层的内容。


OpenToonz 已经实现 Particles Effect 粒子特效，要做些准备工作：

- 准备好粒子图形的动画图层，接入到特效节点的 Texture 输入端；
- 另外可以使用控制层 Control Image，接入特效节点的 Control 输入端，这些图层的图像的属性，主要是像素的亮度、透明度，被用来控制粒子特效的某些属性。 

粒子设置面板包含几个选项卡：

- Source 粒子图形来源选项卡，涉及粒子定义，如位置、大小、控制图层 Control Image，它们决定了粒子如何产生。
- Birth Parameters 生成参数，涉及粒子生成时的参数，如初始速度、生存周期，这些参数决定粒子程序系统如何管理粒子。
- Environment 粒子环境参数，包含 Gravity、Friction、Wind、Scattering 物理参数，决定粒子在不同环境参数下的表现效果。
- Animation 粒子动画参数，包含 Rotation、Opacity、Size Increase 等设置。
- Colors 粒子颜色参数，包含 Birth Color、Fade-in Color、Fade-out Color 等设置。

任何图层轨道的内容都可以用作粒子图形，粒子动画引用其动画内容，粒子生命周期中会使用图层的图形和变换。要若要将图层内容用作粒子，就需要在节点编排面板中，将节点链接到粒子效果节点的 Texture 纹理端口。一旦链接到纹理输入端口，新的纹理端口就可用，可以使用多个粒子纹理图层。

要将图层轨道作为 Control Image 使用，只需要在 FX Schematic 中将其对应的节点连接到粒子节点的 Control 端口上，控制端口带有一个序号作为后缀，随着连接的控制图层增加而增加。在粒子属性面板中，所有可以使用 *Control Image* 的属性都可以指定已经连接的控制图像，只需要在粒子特效面板中填入相应的图像端口数值，0 表示没有 Control Image。

比如，Source 选项卡中的 Source 属性控制粒子运动方向，即粒子出现的位置由控制图像决定，那么在 Source -> Control Image 填入 2 即表示用 Control2 端口接入的动画图层来控制 Source 属性。

可以使用工具栏的 Animate Tool 对粒子进行动画调整，比如设置中心位置，移动并设置关键帧。


粒子特效属性参考：

- Source 设置粒子源
	- Source 粒子产生区域大小位置设置，Threshold 指定控制图层的透明度阈值，不透明区作为粒子产生区，勾选 Multiple Generators 可以在多个区域产生粒子，动画使图层位置移动，粒子产生的区域也会随之而动。Control Image 填入 0 表示不使用控制图层，这时通过 Width/Height 指定粒子产生的区域，也可以拖动绘图区中的蓝色虚线框，注意光标会提示 FX 并且虚线框会变绿；
	- Particle Generation 粒子生成设置，如开始帧位，生成速率等；
	- Particle Animation 设置粒子源图层比粒子特效动画短的处理方式
		- Hold Frame 从粒子来源图层随机选取图像并保持到粒子动画结束；
		- Random Frame 每帧都从粒子来源图层随机选取图像；
		- Column 从来源图层循环显示；
		- Column - Random Start 从来源图层循环显示，随机选取开头；
		- Column Swing - Random Start 从来源图层来回循环显示，随机选取开头；
- Birth Params 粒子生成属性
	- Speed 初始速度与方向，控制图层的像素亮度控制，越亮越块，可以使用渐变方向控制角度；
	- Size/Mass/Orientation 初始大小/质量/朝向，控制图层的像素亮度控制大小或朝向，越亮越大；
	- Trail 末端尾痕属性；
	- Lifetime 粒子生存期，控制图层的像素亮度控制，越亮越久；
	- Top Layer 定义粒子生成时的图层覆盖关系
		- Younger 新的粒子在顶层；
		- Older 旧的粒子在顶层；
		- Smaller 小的粒子在顶层；
		- Bigger 大的粒子在顶层；
		- Random 随机；
- Environment 环境属性
	- Gravity 重力属性，角度 0 表示向下，增大表示顺时针方向改变，控制图层的亮色区可以引导运动方向；
	- Fraction 阻力属性，控制图层的亮色区表示使用设置的阻力；
	- Wind 风力大小与角度；
	- Scattering 散列属性，控制图层的越亮粒子越散；
- Animation 粒子动画属性
	- Rotation 粒子旋转
	- Opacity 不透明度
	- Size Increase 大小增长的百分比；
- Colors 设置粒子图形色彩
	- Birth Color 生成时的颜色，可以从控制图层对应粒子生成位置的像素获取；
	- Fade-in Color 粒子入场时的颜色；
	- Fade-out Color 粒子消隐时的颜色；

所有特效分类列表：

- Background: `Checkerboard`, `Color Card`, `Kaleido`, `Tile`.
- Blur: `Blur`, `Directional Blur`, `Local Blur`, `Motion Blur`, `Radial Blur`, `Spin Blur`.
- Distort: `Free Distort`, `Linear Wave`, `Perlin Noise`, `Random Wave`, `Ripple`, `Warp`.
- Gradients: `Diamond Gradient`, `Four Points Gradient`, `Linear Gradient`, `Multi Linear Gradient`, `Multi Radial Gradient`, `Radial Gradient`, `Spiral`, `Square Gradient`.
- Image: djust, `Adjust Levels`, `Brightness &amp; Contrast`, `Channel Mixer`, `Curves`, `Despeckle`, `Gamma`, `HSV Scale`, `Invert`, `Multitone`, `RGBA Cut`, `RGB Fade`, `RGBA Scale`, `Sharpen`.
- Layer: lending, `Add`, `Color Burn`, `Color Dodge`, `Cross Dissolve`, `Darken`, `Lighten`, `Local Transparency`, `Multiply`, `Over`, `Premultiply`, `Screen`, `Subtract`, `Transparency`.
- Light: `Backlit`, `Body Highlight`, `Cast Shadow`, `Glow`, `Light Spot`, `Raylit`, `Color Raylit`, `Target Spot`.
- Matte: `Erode/Dilate`, `HSV Key`, `Matte In`, `Matte Out`, `RGB Key`, `Visible Matte In`.
- Noise: `Dissolve`, `Noise`, `Salt &amp; Pepper Noise`.
- Render: `Clouds`, `Particles`, `Text Iwa`.
- Stylize: `Color Emboss`, `Emboss`, `Mosaic`, `Posterize`, `Solarize`.
- Toonz: evel, `Art Contour`, `Calligraphic Line`, `Color Blending`, `External Palette`, `Outline`, `Palette Filter`, `Pinned Texture`, `Texture`.
- Shaders: `Caustic`, `Fireball`, `Glitter`, `Star Sky`, `Sun Flare`, `Wavy`, `GPU Radial Blur`, `GPU Spin Blur`.


## Function/Curve Editor 
- https://opentoonz.readthedocs.io/en/latest/editing_curves_and_numerical_columns.html

与动画关系比较紧密的界面除了前面讲到的 Xsheet / Timeline / Stage Schematic / FX Schematic，还有一个与数学函数曲线及脚本有关的 Function Editor，在界面右下角的目录树中有对应 Xsheet 的图层对象，每个图层提供多个动画属性：

- 缩放 Scale、 Scale H/V 水平/垂直方向缩放；
- 位移 N/S 南北方向，E/W 东西方向，Z 轴方向；
- posPath 
- SO 设置图层堆栈顺序 Stacking Order；
- 旋转 Rotation；
- 切变 Shear H/V；

对应塑性动画 Plastic Animation 还可以在 Function Editor 列表中找到网格图层的骨架属性 Plastic Skeleton，里面记录了各个骨架中枢点 Root、Vertex_1、Vertex_2... 等，提供 Angle、Distance、SO 属性，表达式可以这样写：

	vertex(2, "Shoulder_right").angle
	vertex(2, "Shoulder_right").angle*-1

格式规范：

	vertex(column_number, "vertex_name").parameter


给图层某个属性设置表达式，首先要在列表中选择图层的属性，在 From/To 填入需要设置表达式的帧号，点击 Apply 生成关键帧，然后在插值方法列表 Interpolation 中选择表达式方式 Expression，然后编写函数表达式替换文本框中的 0 值。

Function Editor 面板的工具条中，靠右侧有一个按钮可以打开曲线编辑器 Curve Editor，可以更直观修改表达式的数值。


表达是可包含基本的四则运算、逻辑运算、布尔运算，常用的数学函数如 sin、abs、ceiling、round、sign 等，还有常量 pi 等，以下这些预定义函数也有效：

- `cycle(period)`	Cycles the transition of the period previous frames.
- `pulse(pos)`, `pulse(pos,length)`	Generates a pulse ranging from 0.0 to 1.0 set at position pos , with a different breadth depending on the length of the pulse itself.
- `bump(pos)`, `bump(pos,length)`	Generates a bump ranging from 0.0 to 1.0 set at position pos , with a different breadth depending on the length of the bump itself.
- `random`	Generates random sequences between 0.0 and 1.0.
- `random(max)`	Generates a random number between 0.0 and max .
- `random(min,max)`	Generates a random number between min and max .
- `random_s(seed)`	Works like random, but allows the user to specify the seed to modify the value of the random function.
- `random_s(seed,max)`	Like above, with max as the maximum value of the transition.
- `random_s(seed,min,max)`	Like above, with min and max as the minimum and maximum values of the transition.
- `saw(length) , saw(length,height)`	Generates a periodic sawtooth shaped curve according to the length and height values; if height is not expressed it is assumed to be equal to length .
- `sawtooth(length) , sawtooth(length,height)`	Generates a periodic sawtooth shaped curve according to the length and height values; if height is not expressed it is assumed to be equal to length .
- `wave(length)`	The same as sin(f*2*pi/length) .


表达式涉及的对象：

- `cam<n>` , `camera<n>`	Refer to the camera n .
- `col<n>`	Refers to the column n .
- `peg<n>` , `pegbar<n>`	Refer to the pegbar n .
- `tab` , `table`	Refer to the table.

涉及的变换属性：

- ns , ew	Refer to the vertical and horizontal position.
- path , pos	Refer to the position along the motion path.
- rot	Refers to the rotation.
- scale , scaleh , scalev	Refer to the global, horizontal and vertical scaling.
- shearh , shearv	Refer to the horizontal and vertical shear.
- z	Refers to the position along the z axis.

特效属性的访问语法：

	fx.name.parameter or fx.name.parameter(delta)


例如给一个图层的 rotation 属性设置以下表达式，可以跟随图层 2 对象：

	atan2(col2.ns - col1.ns, col2.ew - col1.ew)



参考:
- [Creating Movements](https://opentoonz.readthedocs.io/en/latest/creating_movements.html)
- [Creating Cutout Animation](https://opentoonz.readthedocs.io/en/latest/creating_cutout_animation.html#creating-cutout-animation)
- [Using Plastic Tool](https://opentoonz.readthedocs.io/en/latest/create_animations_using_plastic_tool.html)
- [Function Editor](https://opentoonz.readthedocs.io/en/latest/editing_curves_and_numerical_columns.html#)
- [J-Hee Opentoonz 塑性与骨架](https://www.bilibili.com/video/BV1Gt411B7of?p=10)
- [Applying Effects](https://opentoonz.readthedocs.io/en/latest/applying_special_fx.html)



## ToonzScript 脚本控制
[ECMAScript 标准脚本语言](http://doc.qt.io/qt-5/ecmascript.html)
[ToonzScript](https://opentoonz.readthedocs.io/en/latest/toonzscript.html)
[ToonzScript manual](http://www.toonz.com/htm/support/scripts/ToonzScript.pdf)

ToonzScript 脚本语言是基于 QtScript 实现的 ECMAScript 规范标准脚本语言，使用 JS 作为扩展名。通过使用脚本，可以执行一系列的命令，创建或修改场景、图片内容，符合 ECMAScript 规范的代码都可以执行，比如解析一段 JSON 数据：

	JSON.parse('{"A":1}').A;

执行脚本文件 File  →  Run Script... 或使用控制台执行 File  →  Open Script Console...。


常用命令：

	print("result=",12*3);
	run("test.js")
	run("C:\\Users\\Username\\Tests\\another_test.js")
	view(new Level("C:\\OpenToonz stuff\\sandbox\\drawings\\A.pli"))
	view(new Image("C:\\OpenToonz stuff\\sandbox\\drawings\\A.tif"))

运行脚本文件不指定绝对路径时，使用相当对目录是库文件夹下的 scripts 子目录。

OpenToonz Raster 转 Vector 示例代码：

	// Convert to Vector (Centerline method)
	// http://www.toonz.com/htm/support/Scripts/script1.htm

	//Define the Input and Output folders

	dir1 = "C:\\OpenToonz stuff\\sandbox\\drawings\\";
	dir2 = "C:\\OpenToonz stuff\\sandbox\\SCRIPT IMAGES OUT\\";

	//Set the parameters of the Centerline Vector Conversion

	v = new CenterlineVectorizer();
	v.threshold = 8;
	v.accuracy = 10;
	v.despeckling = 5;
	v.maxThickness = 1000;
	v.thicknessCalibration = 100;
	v.preservePaintedAreas = false;
	v.addBorder = true;

	a = new Level().load(dir1+"A.tlv");
	print("loaded\n",a);

	//Convert to vector the a level and save it as vectorized.pli

	c = v.vectorize(a).save(dir2 + "vectorized.pli");

	print("Converted to vector");

	// Open a Flipbook window and view the saved level

	view(c);


对象参考：

- FilePath

	contains the path of an object.

	Constructor:

		new FilePath(path)

	Methods:

		path2 = path.withExtension(e)
		path2 = path.withName(name)
		path2 = path.withParentDirectory(d)
		path2 = path.concat(f) - where f can be a FilePath or a string
		files = path.files() - if path is a folder then this method returns the files inside the folder.

	Attributes:

		path.extension - read and write attribute
		path.name - read and write attribute
		path.parentDirectory - read and write attribute
		path.lastModified - read only attribute
		path.exists - read only attribute
		path.isDirectory - read only attribute

- Image

	contains an image, supported types are: tlv, pli or fullcolor.

	Constructor:

		new Image() or new Image(filename)

	Methods:

		img.save(filename) - the file extension has to be compatible with the kind of used level
		img.load(filename)

	Attributes:

		img.width - has value 0 if the image is a pli
		img.height - has value 0 if the image is a pli
		img.dpi - has value 0 if the image is a pli
		img.type - accepted values ("Empty", "Raster", "ToonzRaster", "Vector")

- Level

	contains a level, the supported types are: tlv, pli or fullcolor.

	Constructor:

		new Level() or new Level(filename)

	Methods:

		level.load(filename)
		level.save(filename) - the file extension has to be compatible with the kind of usedlevel
		level.getFrameIds() - lists the names of all the frames
		level.getFrame(frameId) - retrive the image of the specified frame
		level.getFrameByIndex(index) - gets the frame specified by the index value (first value of index is 0)
		level.setFrame(frameId, image) - sets a frame (if the level is not empty its content and the type of image has to be compatible)

	Attributes:

		level.name - is a read and write attribute
		level.path - is a read and write attribute
		level.frameCount - is a read only value
		level.type ("Empty", "Raster", "ToonzRaster", "Vector") - is a read only value

- Scene

	contains a Toonz scene.

	Constructor:

		new Scene() or new Scene(filename)
	
	Methods:

		scene.load(filename)

		If the path is relative, scenes of the current project are used.

		scene.save(filename)
		scene.setCel(row, col, cell) , scene.setCell(row, col, level, frameId)
		
		scene.insertColumn(col)
		scene.deleteColumn(col)
		scene.getLevels() - returns an arrray that contains all the levels belonging to the scene
		scene.getLevel(name) - returns the level basing on its name. If a level using the name specified does not exists the value undefined is returned.
		level = scene.newLevel(type, name) - Adds a layer to the scene. Type can be "Raster", "ToonzRaster" or "Vector". Name must not be already ‘used in the scene.
		level = scene.loadLevel(name, path) - Load a level (mode "links") in the scene. The path must exist and be an absolute path.The name must not have been already used for another level of the scene.

		cell = scene.getCell(row, col) - returns a JavaScript object with level and fid attributes

		cell is the kind of object returned by getCell() .

		The following syntax is allowed scene.setCell(1, 0, scene.getCell(0,0))
		To delete a cell: scene.setCell(row, col, undefined)
		cell is a standard JavaScript object that includes the attributes:level and fid , the following use is allowed: scene.setCell(row, col, {level:a, fid:1})
		level can be a Level or a level name. The level has to be already in the scene.
		fid supports numeric values or string values as “2” or “2a”.

	Attributes:

		scene.frameCount - is a read only value
		scene.columnCount - is a read only value


- Transform

	represents a geometric tansformation (composed by rotation, translation and scale). Used by ImageBuilder.

	Constructor:

		new Transform()

	Methods:

		transform.translate(dx, dy)
		transform.rotate(degrees)
		transform.scale(s)
		transform.scale(sx, sy)

- ImageBuilder

	allows to modify an image (rotate, scale, crop), or to make an over between two or more images.

	Constructor:

		new ImageBuilder() or new ImageBuilder(xres, yres)

	Methods:

		builder.add(img)
		builder.add(img, transform)
		Note

		The component of translation of the transform means expressed in pixels for Raster and Toonz Raster levels, and in Camera Stand units for Vector levels.

		builder.fill(color)

	Attributes:

		builder.image - returns the actual result.


- OutlineVectorizer

	vectorize raster images using an outline algorithm.

	Constructor:

		new OutlineVectorizer()

	Methods:

		v.vectorize(level or image) - returns the new vectorized level (or image), supports as input: Raster or Toonz Raster images and levels.

	Attributes:

		v.accuracy
		v.despeckling
		v.preservePaintedAreas
		v.cornerAdherence
		v.cornerAngle
		v.cornerCurveRadius
		v.maxColors
		v.transparentColor
		v.toneThreshold

- CenterlineVectorizer

	vectorize raster images using a centerline algorithm.

	Constructor:

		new CenterlineVectorizer()
	
	Methods:

		v.vectorize(level or image) - returns the new vectorized level (or image), supports as input: Raster or Toonz Raster images and levels.
	
	Attributes:

		v.threshold
		v.accuracy
		v.despeckling
		v.maxThickness
		v.thicknessCalibration
		v.preservePaintedAreas
		v.addBorder

- Rasterizer

	converts vector images into Raster or ToonzRaster images.

	Constructor:

		new Rasterizer()

	Methods:

		out = r.rasterize(vimg) - converts to raster an image or a level

	Attributes:

		r.colorMapped - if its value is set to True the generated image is of ToonzRaster type
		r.xres
		r.yres
		r.dpi

- Renderer

	renders a whole scene or part of a scene, creating levels or images.

	Constructor:

		new Renderer()

	Methods:

		level = c.renderScene(scene)
		image = c.renderFrame(scene, frameIndex) frameIndex starts from 0

	Attributes:

		r.columns (list of indices of columns to render. e.g. r.columns = [0,3])
		r.frames (list of indices of frames to render. e.g. r.frames = [0,1,2,3])


## Keyboard Shortcuts 快捷键参考
- https://opentoonz.readthedocs.io/en/latest/keyboard_shortcuts.html

*注意，按住快捷键不放，使用工具后再松开可以自动返回上一个工具。*

### Tools Shortcuts

- Animate		A	 	 
- Selection		S	 	 
- Brush			B	 	 
- Geometric		G	 	 
- Type			Y	 	 
- Fill			F	 	 
- Eraser		E	 	 
- Tape			T	 	 
- Style Picker	K	 	 
- RGB Picker	R	 	 
- Control Point Editor	C	 	 
- Pinch			M	 	 
- Skeleton		V	 	 
- Hook			O	 	 
- Plastic		X	 	 
- Zoom			Shift	+	Space
- Rotate		Ctrl/⌘ Cmd	+	Space
- Hand			Space	 	 


### Tool Modifiers Shortcuts

- Brush Size - Decrease max	U
- Brush Size - Increase max	I
- Brush Size - Decrease min	H
- Brush Size - Increase min	J
- Rectangular/Normal type	F5
- Frame Range	F6
- Selective	F7
- Segment	F8

### Visualization Shortcuts 	 

Actual Pixel Size	N	 	 
Fit to Window	Alt/⌥ Option	+	9
Reset View	Alt/⌥ Option	+	0
Zoom in	+	 	 
Zoom out	-	 	 
Onion Skin Toggle	/	 	 
Maximize Panel	`	 	 
Full Screen Mode	Alt/⌥ Option	+	F
Main Window Full Screen Mode	Ctrl/⌘ Cmd	+	`


### Playback Controls Shortcuts

Play	P	 	 
Loop	L	 	 
Previous Drawing	,	 	 
Next Drawing	.	 	 
Previous Frame	Shift	+	,
Next Frame	Shift	+	.
Previous Keyframe	Ctrl/⌘ Cmd	+	,
Next Keyframe	Ctrl/⌘ Cmd	+	.

### File Menu Shortcuts

New Scene	Ctrl/⌘ Cmd	+	N	 	 
Load Scene…	Ctrl/⌘ Cmd	+	L	 	 
Save All	Ctrl/⌘ Cmd	+	S	 	 
Save Scene	Ctrl/⌘ Cmd	+	Shift	+	S
Preferences…	Ctrl/⌘ Cmd	+	U	 	 
Quit	Ctrl/⌘ Cmd	+	Q	 	 

### Edit Menu Shortcuts

- Undo		Ctrl/⌘ Cmd	+	Z	 	 
- Redo		Ctrl/⌘ Cmd	+	Y	 	 
- Cut		Ctrl/⌘ Cmd	+	X	 	 
- Copy		Ctrl/⌘ Cmd	+	C	 	 
- Delete	Del	 	 	 	 
- Insert	Ins	 	 	 	 
- Group		Ctrl/⌘ Cmd	+	G	 	 
- Ungroup	Ctrl/⌘ Cmd	+	Shift	+	G
- Select All		Ctrl/⌘ Cmd	+	A	 	 
- Bring to Front	Ctrl/⌘ Cmd	+	]	 	 
- Bring Forward		]	 	 	 	 
- Send Backward		[	 	 	 	 
- Send to Back		Ctrl/⌘ Cmd	+	[	 	 
- Paste Insert		Ctrl/⌘ Cmd	+	V	 	 
- Insert Above/After	Shift	+	Ins	 	 
- Paste Insert Above/After	Ctrl/⌘ Cmd	+	Shift	+	V

### Level Menu Shortcuts

New Level…	Alt/⌥ Option	+	N

### Xsheet Menu Shortcuts

- Set Key	Z	 	 
- New FX…	Ctrl/⌘ Cmd	+	F
- Edit FX…	Ctrl/⌘ Cmd	+	K
- Apply Lip Sync Data to Column	Alt/⌥ Option	+	L

### Cell Menu Shortcuts

- Drawing Substitution Backward	Q
- Drawing Substitution Forward	W
- Similar Drawing Substitution Backward	Alt+Q
- Similar Drawing Substitution Forward	Alt+W

### Play Menu Shortcuts

- Play	P	 	 
- Loop	L	 	 
- First Frame	Alt/⌥ Option	+	,
- Last Frame	Alt/⌥ Option	+	.
- Previous Frame	Shift	+	,
- Next Frame	Shift	+	.
- Previous Keyframe	Ctrl/⌘ Cmd	+	,
- Next Keyframe	Ctrl/⌘ Cmd	+	.
- Previous Drawing	,	 	 
- Next Drawing	.	 	 

### Render Menu Shortcuts

- Preview	Ctrl/⌘ Cmd	+	R	 	 
- Output Settings…	Ctrl/⌘ Cmd	+	O	 	 
- Render	Ctrl/⌘ Cmd	+	Shift	+	R
- Fast Render to MP4	Alt/⌥ Option	+	R	 	 

### Windows Menu Shortcuts

- History	Ctrl/⌘ Cmd	+	H
- Record Audio	Alt/⌥ Option	+	A
- Startup Popup…	Alt/⌥ Option	+	S
- Maximize Panel	反引号	 	 
- Main Window Full Screen Mode	Ctrl/⌘ Cmd	+	反引号

